# =============================================================================
# .github/workflows/code-review.yml
#   - PRæ™‚ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ”¯æ´ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#   - è‡ªå‹•çš„ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
# =============================================================================
name: Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’æ­£ã—ãè¨ˆç®—

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-review-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Run code quality checks
        run: |
          echo "## ğŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Flake8 ãƒã‚§ãƒƒã‚¯
          echo "### ğŸ” Flake8 Results" >> $GITHUB_STEP_SUMMARY
          if flake8 crypto_bot tests --exit-zero --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' > flake8_results.txt; then
            if [ -s flake8_results.txt ]; then
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat flake8_results.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No flake8 issues found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Flake8 check failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check test coverage
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’å–å¾—
          pytest tests/unit --cov=crypto_bot --cov-report=term-missing --cov-report=json --cov-fail-under=70 || echo "Coverage check completed"
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
          echo "### ğŸ“ˆ Test Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(f'{data[\"totals\"][\"percent_covered\"]:.1f}%')")
            echo "**Overall Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ70%æœªæº€ã®å ´åˆã¯è­¦å‘Š
            COVERAGE_NUM=$(python -c "import json; data=json.load(open('coverage.json')); print(data['totals']['percent_covered'])")
            if (( $(echo "$COVERAGE_NUM < 70" | bc -l) )); then
              echo "âš ï¸ **Warning:** Coverage is below 70% threshold" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Coverage meets 70% threshold" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage report not generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit security scan
        run: |
          echo "### ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Bandit ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
          if bandit -r crypto_bot -f json -o bandit_results.json --exit-zero; then
            # çµæœã‚’è§£æã—ã¦ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
            python -c "
import json
import sys

try:
    with open('bandit_results.json', 'r') as f:
        data = json.load(f)
    
    high_issues = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']
    medium_issues = [r for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM']
    low_issues = [r for r in data.get('results', []) if r.get('issue_severity') == 'LOW']
    
    print(f'**High:** {len(high_issues)} issues')
    print(f'**Medium:** {len(medium_issues)} issues') 
    print(f'**Low:** {len(low_issues)} issues')
    
    if high_issues:
        print('\\n**High Severity Issues:**')
        for issue in high_issues[:5]:  # æœ€åˆã®5ä»¶ã®ã¿è¡¨ç¤º
            print(f'- {issue[\"filename\"]}:{issue[\"line_number\"]} {issue[\"issue_text\"]}')
            
    if len(high_issues) == 0 and len(medium_issues) == 0:
        print('\\nâœ… No critical security issues found')
except Exception as e:
    print(f'âŒ Failed to parse bandit results: {e}')
" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Bandit scan failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check for known vulnerabilities
        run: |
          echo "### ğŸ›¡ï¸ Dependency Vulnerability Check" >> $GITHUB_STEP_SUMMARY
          if safety check --json > safety_results.json 2>/dev/null || true; then
            python -c "
import json
import sys

try:
    with open('safety_results.json', 'r') as f:
        data = json.load(f)
    
    vulnerabilities = data.get('vulnerabilities', [])
    if vulnerabilities:
        print(f'âš ï¸ Found {len(vulnerabilities)} known vulnerabilities:')
        for vuln in vulnerabilities[:5]:  # æœ€åˆã®5ä»¶ã®ã¿è¡¨ç¤º
            print(f'- {vuln[\"package_name\"]} {vuln[\"installed_version\"]}: {vuln[\"vulnerability_id\"]}')
    else:
        print('âœ… No known vulnerabilities found in dependencies')
except Exception as e:
    print('âœ… No known vulnerabilities found in dependencies')
" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No known vulnerabilities found in dependencies" >> $GITHUB_STEP_SUMMARY
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install analysis tools
        run: |
          python -m pip install --upgrade pip
          pip install radon

      - name: Analyze code complexity
        run: |
          echo "### ğŸ“Š Code Complexity Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Cyclomatic Complexity
          echo "**Cyclomatic Complexity (files with complexity > 10):**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon cc crypto_bot -s -n B >> $GITHUB_STEP_SUMMARY || echo "No high complexity files found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Maintainability Index
          echo "**Maintainability Index (files with MI < 20):**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon mi crypto_bot -s -n B >> $GITHUB_STEP_SUMMARY || echo "All files have good maintainability" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          # PRã®ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # å¤‰æ›´è¡Œæ•°ã‚’è¨ˆç®—
          ADDED_LINES=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum += $1} END {print sum}')
          DELETED_LINES=$(git diff --numstat $BASE_SHA..$HEAD_SHA | awk '{sum += $2} END {print sum}')
          CHANGED_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | wc -l)
          
          echo "### ğŸ“ Pull Request Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Files:** $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "**Added Lines:** $ADDED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "**Deleted Lines:** $DELETED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "**Total Changes:** $((ADDED_LINES + DELETED_LINES))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ã‚µã‚¤ã‚ºã«åŸºã¥ãæ¨å¥¨äº‹é …
          TOTAL_CHANGES=$((ADDED_LINES + DELETED_LINES))
          if [ $TOTAL_CHANGES -gt 1000 ]; then
            echo "ğŸ”´ **Large PR Warning:** This PR contains $TOTAL_CHANGES changed lines. Consider breaking it into smaller PRs." >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_CHANGES -gt 500 ]; then
            echo "ğŸŸ¡ **Medium PR:** This PR contains $TOTAL_CHANGES changed lines. Review carefully." >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸŸ¢ **Good PR Size:** This PR contains $TOTAL_CHANGES changed lines." >> $GITHUB_STEP_SUMMARY
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check documentation updates
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # å¤‰æ›´ã•ã‚ŒãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_PY_FILES=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '\.py$' | grep -v test_ | head -10)
          
          echo "### ğŸ“š Documentation Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # README.mdã‚„CLAUDE.mdãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E "(README\.md|CLAUDE\.md)" > /dev/null; then
            echo "âœ… Documentation files updated" >> $GITHUB_STEP_SUMMARY
          else
            if [ -n "$CHANGED_PY_FILES" ]; then
              echo "âš ï¸ **Consider updating documentation:** Python files were modified but no documentation updates detected" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Modified Python files:**" >> $GITHUB_STEP_SUMMARY
              for file in $CHANGED_PY_FILES; do
                echo "- $file" >> $GITHUB_STEP_SUMMARY
              done
            else
              echo "â„¹ï¸ No Python files modified, documentation update not required" >> $GITHUB_STEP_SUMMARY
            fi
          fi