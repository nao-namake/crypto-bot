# ha/ - é«˜å¯ç”¨æ€§ãƒ»çŠ¶æ…‹ç®¡ç†

## ğŸ“‹ æ¦‚è¦

**High Availability & State Management**  
æœ¬ãƒ•ã‚©ãƒ«ãƒ€ã¯ crypto-bot ã®é«˜å¯ç”¨æ€§æ©Ÿèƒ½ã‚’æä¾›ã—ã€ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç’°å¢ƒã§ã®çŠ¶æ…‹åŒæœŸã€ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡ºã€ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’æ‹…å½“ã—ã¾ã™ã€‚

## ğŸ¯ ä¸»è¦æ©Ÿèƒ½

### **çŠ¶æ…‹ç®¡ç†**
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®æ°¸ç¶šåŒ–
- åˆ†æ•£ç’°å¢ƒã§ã®çŠ¶æ…‹åŒæœŸ
- ä¸€è²«æ€§ä¿è¨¼
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

### **ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡º**
- åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã®ãƒªãƒ¼ãƒ€ãƒ¼æ±ºå®š
- è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
- ã‚¹ãƒ—ãƒªãƒƒãƒˆãƒ–ãƒ¬ã‚¤ãƒ³é˜²æ­¢
- ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆç›£è¦–

### **ã‚¯ãƒ©ã‚¦ãƒ‰çµ±åˆ**
- Google Cloud Firestoreçµ±åˆ
- Cloud Storageæ´»ç”¨
- ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ
- ç½å®³å¾©æ—§æ©Ÿèƒ½

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
ha/
â”œâ”€â”€ __init__.py       # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆæœŸåŒ–
â””â”€â”€ state_manager.py  # çŠ¶æ…‹ç®¡ç†å®Ÿè£…
```

## ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²

### **state_manager.py**
- `StateManager`ã‚¯ãƒ©ã‚¹ - çŠ¶æ…‹ç®¡ç†æœ¬ä½“
- Google Cloudçµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
- ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡ºãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
- çŠ¶æ…‹åŒæœŸãƒ»ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
- ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆæ©Ÿèƒ½

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### **åŸºæœ¬çš„ãªçŠ¶æ…‹ç®¡ç†**
```python
from crypto_bot.ha.state_manager import StateManager

# çŠ¶æ…‹ç®¡ç†åˆæœŸåŒ–
state_manager = StateManager(
    project_id="crypto-bot-prod",
    instance_id="instance-1",
    region="asia-northeast1"
)

# çŠ¶æ…‹ä¿å­˜
state_manager.save_state({
    "last_processed_timestamp": datetime.now(),
    "active_positions": positions,
    "model_version": "v1.2.3"
})

# çŠ¶æ…‹å–å¾—
current_state = state_manager.get_state()
```

### **ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡º**
```python
# ãƒªãƒ¼ãƒ€ãƒ¼ç¢ºèª
if state_manager.is_leader():
    # ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦ã®å‡¦ç†å®Ÿè¡Œ
    execute_leader_tasks()
else:
    # ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã¨ã—ã¦ã®å‡¦ç†
    sync_from_leader()

# ãƒªãƒ¼ãƒ€ãƒ¼ç›£è¦–
state_manager.watch_leader(
    on_become_leader=handle_promotion,
    on_lose_leadership=handle_demotion
)
```

### **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†**
```python
# è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼è¨­å®š
state_manager.configure_failover(
    health_check_interval=30,  # 30ç§’ã”ã¨ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    failover_timeout=60,       # 60ç§’ã§ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
    recovery_callback=recover_state
)

# æ‰‹å‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
state_manager.trigger_failover(target_instance="instance-2")
```

## âš ï¸ èª²é¡Œãƒ»æ”¹å–„ç‚¹

### **ãƒ•ã‚¡ã‚¤ãƒ«æ•°ä¸è¶³**
- HAæ©Ÿèƒ½ã«å¯¾ã—ã¦å®Ÿè£…ãŒå°‘ãªã„
- ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªHAæ©Ÿèƒ½ãŒå¿…è¦
- åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½ã®æ‹¡å……

### **ã‚¯ãƒ©ã‚¦ãƒ‰ä¾å­˜**
- Google Cloudå›ºæœ‰ã®å®Ÿè£…
- ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œä¸è¶³
- ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹å¯¾å¿œ

### **æ©Ÿèƒ½åˆ¶é™**
- åˆ†æ•£ãƒ­ãƒƒã‚¯æœªå®Ÿè£…
- åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸è¶³
- ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°æœªå¯¾å¿œ

### **ç›£è¦–ãƒ»å¯è¦³æ¸¬æ€§**
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ä¸è¶³
- åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°æœªå®Ÿè£…
- ãƒ­ã‚°é›†ç´„æ©Ÿèƒ½ä¸è¶³

## ğŸ“ ä»Šå¾Œã®å±•é–‹

1. **HAæ©Ÿèƒ½æ‹¡å……**
   ```
   ha/
   â”œâ”€â”€ state/           # çŠ¶æ…‹ç®¡ç†
   â”‚   â”œâ”€â”€ manager.py
   â”‚   â”œâ”€â”€ sync.py      # åŒæœŸæ©Ÿèƒ½
   â”‚   â””â”€â”€ storage.py   # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŠ½è±¡åŒ–
   â”œâ”€â”€ consensus/       # åˆæ„å½¢æˆ
   â”‚   â”œâ”€â”€ raft.py      # Raftã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
   â”‚   â””â”€â”€ leader.py    # ãƒªãƒ¼ãƒ€ãƒ¼é¸å‡º
   â”œâ”€â”€ failover/        # ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
   â”‚   â”œâ”€â”€ detector.py  # éšœå®³æ¤œå‡º
   â”‚   â””â”€â”€ handler.py   # å¾©æ—§å‡¦ç†
   â””â”€â”€ replication/     # ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
       â”œâ”€â”€ master.py
       â””â”€â”€ slave.py
   ```

2. **åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ å¼·åŒ–**
   - åˆ†æ•£ãƒ­ãƒƒã‚¯å®Ÿè£…
   - åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°
   - CQRSå®Ÿè£…

3. **ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œ**
   - AWS DynamoDBçµ±åˆ
   - Azure Cosmos DBå¯¾å¿œ
   - Redis/etcdçµ±åˆ
   - æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼

4. **å¯è¦³æ¸¬æ€§å‘ä¸Š**
   - åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ï¼ˆOpenTelemetryï¼‰
   - ãƒ¡ãƒˆãƒªã‚¯ã‚¹é›†ç´„ï¼ˆPrometheusï¼‰
   - ãƒ­ã‚°é›†ç´„ï¼ˆELK Stackï¼‰
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±åˆ