# ç·Šæ€¥åœæ­¢ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# iPhoneã®GitHubã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Ÿè¡Œå¯èƒ½

name: ğŸš¨ Emergency Stop

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'stop'
        type: choice
        options:
          - stop     # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯0%ï¼ˆå³æ™‚åœæ­¢ãƒ»å¾©æ—§ç°¡å˜ï¼‰
          - resume   # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯100%ï¼ˆå¾©æ—§ï¼‰
          - status   # çŠ¶æ…‹ç¢ºèªã®ã¿

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  SERVICE_NAME: crypto-bot-service-prod

jobs:
  emergency-action:
    name: Emergency Action
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/11445303925/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deployer@my-crypto-bot-project.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš¨ ç·Šæ€¥åœæ­¢ï¼ˆãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯0%ï¼‰
        if: github.event.inputs.action == 'stop'
        run: |
          echo "ğŸš¨ ç·Šæ€¥åœæ­¢å®Ÿè¡Œä¸­..."
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --to-revisions=LATEST=0
          echo "âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯0%ã«è¨­å®šå®Œäº† - Botåœæ­¢çŠ¶æ…‹"

      - name: âœ… å¾©æ—§ï¼ˆãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯100%ï¼‰
        if: github.event.inputs.action == 'resume'
        run: |
          echo "âœ… å¾©æ—§å®Ÿè¡Œä¸­..."
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --to-revisions=LATEST=100
          echo "âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯100%ã«è¨­å®šå®Œäº† - Botç¨¼åƒçŠ¶æ…‹"

      - name: ğŸ“Š çŠ¶æ…‹ç¢ºèª
        run: |
          echo "ğŸ“Š === ç¾åœ¨ã®ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ ==="
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format="table(status.conditions[0].status,status.traffic[0].percent,status.url)"

          echo ""
          echo "ğŸ“Š === æœ€æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ ==="
          gcloud run revisions list \
            --service=${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --limit=3 \
            --format="table(metadata.name,status.conditions[0].status)"
