# Walk-Forward Validation ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Phase 60.3: éå­¦ç¿’æ¤œå‡ºãƒ»çœŸã®MLäºˆæ¸¬åŠ›è©•ä¾¡
#
# å®Ÿè¡Œæ–¹æ³•:
#   GitHub â†’ Actions â†’ Walk-Forward Validation â†’ Run workflow

name: Walk-Forward Validation

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç¢ºèªã®ã¿ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  PYTHON_VERSION: '3.13'
  # é•·æ™‚é–“å®Ÿè¡Œã®ãŸã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é•·ã‚ã«è¨­å®š
  WF_TIMEOUT_MINUTES: 360  # 6æ™‚é–“

jobs:
  walk-forward:
    name: Walk-Forward Validation
    runs-on: ubuntu-latest
    timeout-minutes: 420  # å…¨ä½“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 7æ™‚é–“

    permissions:
      contents: write  # Git commitã¨pushã«å¿…è¦

    steps:
      # ========================================
      # Step 1: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆGitæ“ä½œç”¨ï¼‰

      # ========================================
      # Step 2: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ========================================
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # ========================================
      # Step 3: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ========================================
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      # ========================================
      # Step 4: å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†
      # ========================================
      - name: Collect historical data
        run: |
          echo "ğŸ“¥ å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹..."

          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p src/backtest/data/historical
          mkdir -p models/walk_forward
          mkdir -p docs/æ¤œè¨¼è¨˜éŒ²/walk_forward

          # Walk-Forwardç”¨ã®æœŸé–“ã§ãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆ2025-07-01 ~ 2025-12-31ï¼‰
          echo "ğŸ“… Walk-ForwardæœŸé–“: 2025-07-01 ~ 2025-12-31"
          python3 src/backtest/scripts/collect_historical_csv.py \
            --start-date "2025-07-01" \
            --end-date "2025-12-31"

          # ãƒ‡ãƒ¼ã‚¿åé›†ç¢ºèª
          if [ -f "src/backtest/data/historical/BTC_JPY_15m.csv" ]; then
            CSV_LINES=$(wc -l < src/backtest/data/historical/BTC_JPY_15m.csv)
            echo "âœ… 15åˆ†è¶³ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†: ${CSV_LINES}è¡Œ"
          else
            echo "âŒ 15åˆ†è¶³ãƒ‡ãƒ¼ã‚¿åé›†å¤±æ•—"
            exit 1
          fi

          if [ -f "src/backtest/data/historical/BTC_JPY_4h.csv" ]; then
            CSV_LINES=$(wc -l < src/backtest/data/historical/BTC_JPY_4h.csv)
            echo "âœ… 4æ™‚é–“è¶³ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†: ${CSV_LINES}è¡Œ"
          else
            echo "âŒ 4æ™‚é–“è¶³ãƒ‡ãƒ¼ã‚¿åé›†å¤±æ•—"
            exit 1
          fi

          echo "âœ… å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†"

      # ========================================
      # Step 5: ç’°å¢ƒæº–å‚™
      # ========================================
      - name: Setup environment
        run: |
          echo "ğŸ”§ ç’°å¢ƒæº–å‚™é–‹å§‹..."

          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p logs cache src/backtest/logs

          # ãƒ¢ãƒ‡ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          echo '{"version": "walk_forward", "features": 55, "created": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > models/production/model_metadata.json

          # ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          if [ -f "models/production/ensemble_full.pkl" ]; then
            echo "âœ… ensemble_full.pklç¢ºèªæ¸ˆã¿"
          else
            echo "âš ï¸ ensemble_full.pklæœªç¢ºèªï¼ˆWalk-Forwardã§ç”Ÿæˆã•ã‚Œã¾ã™ï¼‰"
          fi

          echo "âœ… ç’°å¢ƒæº–å‚™å®Œäº†"

      # ========================================
      # Step 6: Walk-Forward Validation å®Ÿè¡Œ
      # ========================================
      - name: Run Walk-Forward Validation
        run: |
          echo "ğŸš€ Walk-Forward Validation é–‹å§‹..."
          echo "å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M:%S')"

          # PYTHONPATHè¨­å®š
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"

          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³åˆ¤å®š
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ğŸ“‹ ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰"
            timeout $((WF_TIMEOUT_MINUTES * 60)) python3 scripts/backtest/walk_forward_validation.py --dry-run --verbose 2>&1 | tee walk_forward_run.log
          else
            echo "ğŸ”„ æœ¬å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
            timeout $((WF_TIMEOUT_MINUTES * 60)) python3 scripts/backtest/walk_forward_validation.py --verbose 2>&1 | tee walk_forward_run.log
          fi

          WF_EXIT_CODE=${PIPESTATUS[0]}

          if [ $WF_EXIT_CODE -eq 0 ]; then
            echo "âœ… Walk-Forward Validation å®Œäº†"
          elif [ $WF_EXIT_CODE -eq 124 ]; then
            echo "â±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ${WF_TIMEOUT_MINUTES}åˆ†è¶…éï¼‰"
            exit 1
          else
            echo "âŒ å®Ÿè¡Œå¤±æ•—ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $WF_EXIT_CODEï¼‰"
            exit 1
          fi

      # ========================================
      # Step 7: çµæœç¢ºèª
      # ========================================
      - name: Check results
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ğŸ“Š çµæœç¢ºèª..."

          # çµæœãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          LATEST_JSON=$(ls -t docs/æ¤œè¨¼è¨˜éŒ²/walk_forward/walk_forward_*.json 2>/dev/null | head -1)
          if [ -n "$LATEST_JSON" ]; then
            echo "âœ… JSONãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç¢ºèª: $LATEST_JSON"
            echo "LATEST_JSON=$LATEST_JSON" >> $GITHUB_ENV

            # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            echo ""
            echo "=== çµæœã‚µãƒãƒªãƒ¼ ==="
            python3 -c "
import json
with open('$LATEST_JSON', 'r') as f:
    data = json.load(f)
    metrics = data.get('aggregate_metrics', {})
    stability = data.get('stability_assessment', {})
    print(f\"å¹³å‡PF: {metrics.get('mean_pf', 0):.2f} (Â±{metrics.get('std_pf', 0):.3f})\")
    print(f\"ç·æç›Š: Â¥{metrics.get('total_pnl', 0):,.0f}\")
    print(f\"å®‰å®šæ€§: {stability.get('stability_level', 'N/A')}\")
    print(f\"éå­¦ç¿’ãƒªã‚¹ã‚¯: {stability.get('overfitting_risk', 'N/A')}\")
"
          else
            echo "âš ï¸ JSONãƒ¬ãƒãƒ¼ãƒˆæœªç”Ÿæˆ"
          fi

          LATEST_MD=$(ls -t docs/æ¤œè¨¼è¨˜éŒ²/walk_forward/walk_forward_*.md 2>/dev/null | head -1)
          if [ -n "$LATEST_MD" ]; then
            echo "âœ… Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç¢ºèª: $LATEST_MD"
            echo "LATEST_MD=$LATEST_MD" >> $GITHUB_ENV
          fi

      # ========================================
      # Step 8: Artifactä¿å­˜
      # ========================================
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: walk-forward-results
          path: |
            docs/æ¤œè¨¼è¨˜éŒ²/walk_forward/
            walk_forward_run.log
            models/walk_forward/
          retention-days: 90

      # ========================================
      # Step 9: Gitè¨­å®š
      # ========================================
      - name: Configure Git
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "âš™ï¸ Gitè¨­å®š..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      # ========================================
      # Step 10: ãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆ
      # ========================================
      - name: Commit results
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ğŸ“¤ ãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆ..."

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          git status --short

          # Walk-Forwardãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "docs/æ¤œè¨¼è¨˜éŒ²/walk_forward/"

          # ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if git diff --staged --quiet; then
            echo "â„¹ï¸ ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ãªã—"
          else
            REPORT_DATE=$(TZ=Asia/Tokyo date '+%Y/%m/%d')
            COMMIT_MSG="docs: Walk-Forward Validation ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ  ${REPORT_DATE}"
            git commit -m "${COMMIT_MSG}"
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
          fi

      # ========================================
      # Step 11: ãƒ—ãƒƒã‚·ãƒ¥
      # ========================================
      - name: Push to repository
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ğŸš€ ãƒ—ãƒƒã‚·ãƒ¥..."

          # ãƒªãƒ¢ãƒ¼ãƒˆå¤‰æ›´å–å¾—
          git fetch origin main
          git rebase origin/main || {
            echo "âš ï¸ rebaseç«¶åˆ - è‡ªå‹•è§£æ±ºè©¦è¡Œ"
            git rebase --abort
            git pull --rebase origin main
          }

          # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin main; then
              echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆè©¦è¡Œ $RETRY_COUNT/$MAX_RETRIESï¼‰"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                git pull --rebase origin main
              fi
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆ${MAX_RETRIES}å›ãƒªãƒˆãƒ©ã‚¤å¾Œï¼‰"
            exit 1
          fi

      # ========================================
      # Step 12: å®Ÿè¡Œã‚µãƒãƒªãƒ¼
      # ========================================
      - name: Execution summary
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š Walk-Forward Validation ã‚µãƒãƒªãƒ¼"
          echo "========================================"
          echo "ãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.dry_run == 'true' && 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³' || 'æœ¬å®Ÿè¡Œ' }}"
          echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ job.status }}"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… å®Œäº†"
            if [ -n "$LATEST_MD" ]; then
              echo "ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆ: $LATEST_MD"
            fi
          else
            echo "âŒ å¤±æ•—"
            echo "ğŸ” ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi

          echo "========================================"
          echo "å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M:%S')"
          echo "========================================"

# ========================================
# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
# ========================================
# backtest.yml ã¨åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦åŒæ™‚å®Ÿè¡Œã‚’é˜²æ­¢
# ï¼ˆthresholds.yaml / models/ / logs/ ã®ç«¶åˆå›é¿ï¼‰
concurrency:
  group: weekly-backtest
  cancel-in-progress: false
