# MLãƒ¢ãƒ‡ãƒ«è‡ªå‹•å†å­¦ç¿’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - Phase 53.1
name: ML Model Training

on:
  workflow_dispatch:
    inputs:
      n_trials:
        description: 'Optunaè©¦è¡Œå›æ•°'
        required: true
        default: '50'
        type: choice
        options:
          - '30'
          - '50'
          - '100'
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆãƒ¢ãƒ‡ãƒ«ä¿å­˜ãªã—ï¼‰'
        required: false
        default: false
        type: boolean

  schedule:
    - cron: '0 9 * * 0'

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  MIN_FEATURE_COUNT: 50

jobs:
  train:
    name: ML Model Training
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup directories
        run: |
          mkdir -p models/{production,training,archive} logs cache src/backtest/data/historical
          git config --global user.name "GitHub Actions ML Training"
          git config --global user.email "actions@github.com"

      - name: Collect training data
        run: |
          echo "ğŸ“Š 180æ—¥åˆ†ãƒ‡ãƒ¼ã‚¿åé›†"
          python3 src/backtest/scripts/collect_historical_csv.py --days 180 --symbol BTC/JPY
          ls -lh src/backtest/data/historical/

      - name: Train ML model
        id: training
        run: |
          N_TRIALS=${{ github.event.inputs.n_trials || '50' }}
          echo "ğŸ¯ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’é–‹å§‹ï¼ˆ${N_TRIALS}è©¦è¡Œï¼‰"

          python3 scripts/ml/create_ml_models.py \
            --n-classes 3 \
            --threshold 0.005 \
            --optimize \
            --n-trials "$N_TRIALS" \
            --verbose

          echo "training_success=true" >> $GITHUB_OUTPUT

      - name: Validate model
        if: github.event.inputs.dry_run != 'true' && steps.training.outputs.training_success == 'true'
        run: |
          echo "ğŸ” ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼"

          if [ ! -f "models/production/ensemble_full.pkl" ]; then
            echo "âŒ ensemble_full.pklä¸å­˜åœ¨"
            exit 1
          fi

          FEATURE_COUNT=$(python3 -c "
          import json
          m = json.load(open('models/production/production_model_metadata.json'))
          print(len(m.get('feature_names', [])))
          ")

          if [ "$FEATURE_COUNT" -lt "$MIN_FEATURE_COUNT" ]; then
            echo "âŒ ç‰¹å¾´é‡ä¸è¶³: $FEATURE_COUNT < $MIN_FEATURE_COUNT"
            exit 1
          fi

          echo "âœ… æ¤œè¨¼å®Œäº†: ${FEATURE_COUNT}ç‰¹å¾´é‡"

      - name: Commit and push
        if: github.event.inputs.dry_run != 'true' && steps.training.outputs.training_success == 'true'
        run: |
          if git diff --quiet models/; then
            echo "ğŸ“‹ å¤‰æ›´ãªã—"
            exit 0
          fi

          git add models/production/ models/training/
          git commit -m "feat: MLãƒ¢ãƒ‡ãƒ«è‡ªå‹•æ›´æ–°ï¼ˆé€±æ¬¡å†å­¦ç¿’ï¼‰"
          git push origin main

      - name: Trigger deployment
        if: github.event.inputs.dry_run != 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: model-updated

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š === ã‚µãƒãƒªãƒ¼ ==="
          echo "å®Ÿè¡Œ: ${{ github.event_name }}"
          echo "è©¦è¡Œ: ${{ github.event.inputs.n_trials || '50' }}"
          echo "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ${{ github.event.inputs.dry_run || 'false' }}"
          echo "æˆåŠŸ: ${{ steps.training.outputs.training_success || 'unknown' }}"
