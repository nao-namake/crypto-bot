name: ML Model Training

on:
  workflow_dispatch:
    inputs:
      training_days:
        description: 'å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æœŸé–“ï¼ˆæ—¥æ•°ï¼‰'
        required: true
        default: '180'
        type: choice
        options:
          - '180'
          - '365'
          - '90'
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 18 * * 0'

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  SERVICE_NAME: crypto-bot-service-prod

jobs:
  model-training:
    name: ML Model Training & Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pre-training Environment Setup
        run: |
          echo "ğŸš€ Phase 19ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹"
          mkdir -p models/{production,training,archive} logs cache
          git config --global user.name "GitHub Actions ML Training"
          git config --global user.email "actions@github.com"
          echo "âœ… ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

      - name: Execute ML Model Training
        run: |
          TRAINING_DAYS=${{ github.event.inputs.training_days || '180' }}
          DRY_RUN=${{ github.event.inputs.dry_run || 'false' }}
          
          echo "ğŸ¯ Phase 19ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Ÿè¡Œé–‹å§‹"
          echo "ğŸ“Š å­¦ç¿’æœŸé–“: ${TRAINING_DAYS}æ—¥"
          
          if [ "$DRY_RUN" = "true" ]; then
            python3 scripts/ml/create_ml_models.py --verbose --dry-run --days "$TRAINING_DAYS"
          else
            python3 scripts/ml/create_ml_models.py --verbose --days "$TRAINING_DAYS"
          fi

      - name: Model Validation
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ” ãƒ¢ãƒ‡ãƒ«å“è³ªæ¤œè¨¼é–‹å§‹"
          
          if [ ! -f "models/production/production_ensemble.pkl" ] || [ ! -f "models/production/production_model_metadata.json" ]; then
            echo "âŒ ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨"
            exit 1
          fi
          
          FEATURE_COUNT=$(python3 -c "import json; print(len(json.load(open('models/production/production_model_metadata.json'))['feature_names']))")
          
          if [ "$FEATURE_COUNT" != "12" ]; then
            echo "âŒ ç‰¹å¾´é‡æ•°ä¸æ­£: $FEATURE_COUNT != 12"
            exit 1
          fi
          
          echo "âœ… ãƒ¢ãƒ‡ãƒ«å“è³ªæ¤œè¨¼å®Œäº†: 12ç‰¹å¾´é‡ç¢ºèª"

      - name: Commit New Models
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ“ Phase 19è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ãƒ¢ãƒ‡ãƒ«ã‚³ãƒŸãƒƒãƒˆ"
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“‹ ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
          else
            MODEL_VERSION=$(python3 -c "import json; print(json.load(open('models/production/production_model_metadata.json')).get('phase', 'Phase 19'))" 2>/dev/null || echo "Phase 19")
            
            git add models/production/ models/training/
            if ls models/archive/*.pkl 1> /dev/null 2>&1; then
              git add models/archive/
            fi
            
            git commit -m "feat: ${MODEL_VERSION}ãƒ¢ãƒ‡ãƒ«è‡ªå‹•æ›´æ–°ãƒ»å®šæœŸå­¦ç¿’å®Ÿè¡Œ" \
              -m "" \
              -m "- 12ç‰¹å¾´é‡çµ±ä¸€ãƒ¢ãƒ‡ãƒ«å†å­¦ç¿’å®Œäº†" \
              -m "- è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Ÿè¡Œ" \
              -m "- Gitæƒ…å ±è¿½è·¡ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°" \
              -m "- å­¦ç¿’æœŸé–“: ${{ github.event.inputs.training_days || '180' }}æ—¥" \
              -m "" \
              -m "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" \
              -m "" \
              -m "Co-Authored-By: Claude <noreply@anthropic.com>"
            
            echo "âœ… ãƒ¢ãƒ‡ãƒ«è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
          fi

      - name: Push Updated Models
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸš€ æ›´æ–°ãƒ¢ãƒ‡ãƒ«ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒƒã‚·ãƒ¥"
          git push origin main
          echo "âœ… ãƒ¢ãƒ‡ãƒ«æ›´æ–°ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

      - name: Trigger Production Deployment
        if: github.event.inputs.dry_run != 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: model-updated

      - name: Training Summary Report
        if: always()
        run: |
          echo "ğŸ“Š === Phase 19ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã‚µãƒãƒªãƒ¼ ==="
          echo "å®Ÿè¡Œæ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "å®Ÿè¡Œã‚¿ã‚¤ãƒ—: ${{ github.event_name }}"
          echo "å­¦ç¿’æœŸé–“: ${{ github.event.inputs.training_days || '180' }}æ—¥"
          echo "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ${{ github.event.inputs.dry_run || 'false' }}"
          
          if [ -f "models/production/production_model_metadata.json" ]; then
            echo ""
            echo "ğŸ¯ æ–°ãƒ¢ãƒ‡ãƒ«è©³ç´°:"
            echo "Phase: $(python3 -c "import json; print(json.load(open('models/production/production_model_metadata.json'))['phase'])" 2>/dev/null || echo "Phase 19")"
            echo "ç‰¹å¾´é‡æ•°: $(python3 -c "import json; print(len(json.load(open('models/production/production_model_metadata.json'))['feature_names']))" 2>/dev/null || echo "12")"
          fi
          
          echo ""
          echo "ğŸ“ˆ Phase 19å“è³ªä¿è¨¼: 12ç‰¹å¾´é‡çµ±ä¸€ãƒ»ç‰¹å¾´é‡å®šç¾©ä¸€å…ƒåŒ–å¯¾å¿œ"
          echo "âœ… ãƒ¢ãƒ‡ãƒ«å®šæœŸå­¦ç¿’${{ job.status == 'success' && 'å®Œäº†' || 'å¤±æ•—' }}"

      - name: Training Failure Alert
        if: failure()
        run: |
          echo "ğŸš¨ è­¦å‘Š: ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸš¨ æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ãŒç¶™ç¶šä½¿ç”¨ã•ã‚Œã¾ã™"
          echo "ğŸš¨ æ‰‹å‹•ç¢ºèªãƒ»ä¿®æ­£ãŒå¿…è¦ã§ã™"
