# MLãƒ¢ãƒ‡ãƒ«è‡ªå‹•å†å­¦ç¿’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# é€±æ¬¡è‡ªå‹•å®Ÿè¡Œï¼ˆæ—¥æ›œ18:00 JSTï¼‰ãƒ»Phase 49å®Œäº†ï¼ˆ55ç‰¹å¾´é‡ãƒ»3ã‚¯ãƒ©ã‚¹åˆ†é¡ï¼‰

name: ML Model Training

on:
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
  workflow_dispatch:
    inputs:
      n_trials:
        description: 'Optunaæœ€é©åŒ–è©¦è¡Œå›æ•°'
        required: true
        default: '50'
        type: choice
        options:
          - '50'   # æ¨å¥¨ï¼ˆç´„4åˆ†ãƒ»ã‚³ã‚¹ãƒ‘æœ€è‰¯ï¼‰
          - '100'  # é«˜ç²¾åº¦ï¼ˆç´„8åˆ†ãƒ»+1-3%æ”¹å–„ï¼‰
          - '30'   # é«˜é€Ÿãƒ†ã‚¹ãƒˆç”¨
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œï¼ˆãƒ¢ãƒ‡ãƒ«ä¿å­˜ãªã—ï¼‰'
        required: false
        default: false
        type: boolean

  # é€±æ¬¡è‡ªå‹•å®Ÿè¡Œï¼ˆæ—¥æ›œ18:00 JST = æ—¥æ›œ09:00 UTCï¼‰
  schedule:
    - cron: '0 9 * * 0'  # UTC 09:00 = JST 18:00ï¼ˆæ—¥æ›œæ—¥ï¼‰

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  SERVICE_NAME: crypto-bot-service-prod

jobs:
  model-training:
    name: ML Model Training & Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30  # MLå­¦ç¿’ç´„4-8åˆ†+Î±ï¼ˆ60åˆ†â†’30åˆ†ã«çŸ­ç¸®ï¼‰

    # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          echo "ğŸ”§ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
          python --version
          pip --version

          python -m pip install --upgrade pip
          pip install -r requirements.txt

          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      - name: Pre-training Environment Setup
        run: |
          echo "ğŸš€ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"

          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p models/{production,training,archive,optuna} logs cache

          # Gitè¨­å®šï¼ˆã‚³ãƒŸãƒƒãƒˆç”¨ï¼‰
          git config --global user.name "GitHub Actions ML Training"
          git config --global user.email "actions@github.com"

          echo "âœ… ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

      - name: Execute ML Model Training
        id: training
        run: |
          N_TRIALS=${{ github.event.inputs.n_trials || '50' }}
          DRY_RUN=${{ github.event.inputs.dry_run || 'false' }}

          echo "ğŸ¯ MLãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Ÿè¡Œé–‹å§‹"
          echo "ğŸ“Š Optunaè©¦è¡Œå›æ•°: ${N_TRIALS}"
          echo "ğŸ“Š 3ã‚¯ãƒ©ã‚¹åˆ†é¡ï¼ˆSELL/HOLD/BUYï¼‰ãƒ»55ç‰¹å¾´é‡ï¼ˆ50åŸºæœ¬+5æˆ¦ç•¥ä¿¡å·ï¼‰"
          echo "ğŸ“Š é–¾å€¤: Â±0.5%ãƒ»Optunaãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–"

          # çµ±åˆé‹ç”¨ã‚¬ã‚¤ãƒ‰æº–æ‹ ã®æ¨™æº–ã‚³ãƒãƒ³ãƒ‰ä½¿ç”¨
          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ§ª ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒ‡ãƒ«ä¿å­˜ãªã—ï¼‰"
            python3 scripts/ml/create_ml_models.py \
              --n-classes 3 \
              --threshold 0.005 \
              --optimize \
              --n-trials "$N_TRIALS" \
              --verbose \
              2>&1 | tee /tmp/training.log
          else
            echo "ğŸš€ æœ¬ç•ªå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰"
            python3 scripts/ml/create_ml_models.py \
              --n-classes 3 \
              --threshold 0.005 \
              --optimize \
              --n-trials "$N_TRIALS" \
              --verbose \
              2>&1 | tee /tmp/training.log
          fi

          # å­¦ç¿’æˆåŠŸç¢ºèª
          if [ $? -eq 0 ]; then
            echo "training_success=true" >> $GITHUB_OUTPUT
            echo "âœ… ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Œäº†"
          else
            echo "training_success=false" >> $GITHUB_OUTPUT
            echo "âŒ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å¤±æ•—"
            exit 1
          fi

      - name: Model Validation
        if: github.event.inputs.dry_run != 'true' && steps.training.outputs.training_success == 'true'
        run: |
          echo "ğŸ” ãƒ¢ãƒ‡ãƒ«å“è³ªæ¤œè¨¼é–‹å§‹"

          # 1. ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "models/production/production_ensemble.pkl" ]; then
            echo "âŒ ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨: production_ensemble.pkl"
            exit 1
          fi

          if [ ! -f "models/production/production_model_metadata.json" ]; then
            echo "âŒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨: production_model_metadata.json"
            exit 1
          fi

          echo "âœ… ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèªå®Œäº†"

          # 2. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
          MODEL_TYPE=$(python3 -c "
          import json
          import sys
          try:
              metadata = json.load(open('models/production/production_model_metadata.json'))
              print(metadata.get('model_type', 'unknown'))
          except Exception as e:
              print(f'error: {e}', file=sys.stderr)
              sys.exit(1)
          ")

          if [ "$MODEL_TYPE" != "ProductionEnsemble" ]; then
            echo "âŒ ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ä¸æ­£: $MODEL_TYPE != ProductionEnsemble"
            exit 1
          fi

          echo "âœ… ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—æ¤œè¨¼å®Œäº†: ProductionEnsemble"

          # 3. ç‰¹å¾´é‡æ¤œè¨¼ï¼ˆæŸ”è»Ÿãªæ¤œè¨¼ãƒ»å°†æ¥ã®ç‰¹å¾´é‡æ•°å¤‰æ›´ã«å¯¾å¿œï¼‰
          FEATURE_COUNT=$(python3 -c "
          import json
          import sys
          try:
              metadata = json.load(open('models/production/production_model_metadata.json'))
              feature_names = metadata.get('feature_names', [])
              print(len(feature_names))
          except Exception as e:
              print(f'error: {e}', file=sys.stderr)
              sys.exit(1)
          ")

          # ç‰¹å¾´é‡æ•°ãŒå¦¥å½“ãªç¯„å›²ã‹ç¢ºèªï¼ˆæœ€å°å€¤ãƒã‚§ãƒƒã‚¯ã®ã¿ãƒ»å°†æ¥ã®æ‹¡å¼µã«å¯¾å¿œï¼‰
          if [ "$FEATURE_COUNT" -lt "50" ]; then
            echo "âŒ ç‰¹å¾´é‡æ•°ä¸è¶³: $FEATURE_COUNT < 50ï¼ˆæœ€å°50ç‰¹å¾´é‡å¿…è¦ï¼‰"
            exit 1
          fi

          echo "âœ… ç‰¹å¾´é‡æ¤œè¨¼å®Œäº†: ${FEATURE_COUNT}ç‰¹å¾´é‡ï¼ˆPhase 49ç¾åœ¨: 55ç‰¹å¾´é‡ï¼‰"

          # 4. ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
          MODEL_SIZE=$(du -h models/production/production_ensemble.pkl | awk '{print $1}')
          echo "ğŸ“Š ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º: ${MODEL_SIZE}"

          echo "âœ… ãƒ¢ãƒ‡ãƒ«å“è³ªæ¤œè¨¼å®Œäº†"

      - name: Commit New Models
        if: github.event.inputs.dry_run != 'true' && steps.training.outputs.training_success == 'true'
        id: commit
        run: |
          echo "ğŸ“ ãƒ¢ãƒ‡ãƒ«è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ã‚³ãƒŸãƒƒãƒˆ"

          # å¤‰æ›´ç¢ºèª
          if git diff --quiet models/ && git diff --staged --quiet models/; then
            echo "ğŸ“‹ ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—"
            echo "commit_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ãƒ¢ãƒ‡ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
          MODEL_VERSION=$(python3 -c "
          import json
          try:
              metadata = json.load(open('models/production/production_model_metadata.json'))
              created_at = metadata.get('created_at', 'unknown')
              print(f'ML_{created_at[:10]}')
          except:
              print('ML_auto')
          " 2>/dev/null || echo "ML_auto")

          # Gitã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add models/production/ models/training/ models/optuna/

          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å­˜åœ¨æ™‚è¿½åŠ 
          if ls models/archive/*.pkl 1> /dev/null 2>&1; then
            git add models/archive/
          fi

          # ã‚³ãƒŸãƒƒãƒˆä½œæˆ
          git commit -m "feat: ${MODEL_VERSION} ãƒ¢ãƒ‡ãƒ«è‡ªå‹•æ›´æ–°ï¼ˆé€±æ¬¡å†å­¦ç¿’ï¼‰" \
            -m "" \
            -m "- 55ç‰¹å¾´é‡Strategy-Aware MLå†å­¦ç¿’å®Œäº†" \
            -m "- 3ã‚¯ãƒ©ã‚¹åˆ†é¡ï¼ˆSELL/HOLD/BUYï¼‰ãƒ»é–¾å€¤Â±0.5%" \
            -m "- Optunaæœ€é©åŒ–ï¼ˆ${{ github.event.inputs.n_trials || '50' }}è©¦è¡Œï¼‰" \
            -m "- ProductionEnsembleã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ï¼ˆLightGBM/XGBoost/RandomForestï¼‰" \
            -m "- è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Ÿè¡Œ" \
            -m "" \
            -m "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
            -m "" \
            -m "Co-Authored-By: Claude <noreply@anthropic.com>"

          echo "commit_created=true" >> $GITHUB_OUTPUT
          echo "âœ… ãƒ¢ãƒ‡ãƒ«è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆå®Œäº†"

      - name: Push Updated Models
        if: github.event.inputs.dry_run != 'true' && steps.commit.outputs.commit_created == 'true'
        run: |
          echo "ğŸš€ æ›´æ–°ãƒ¢ãƒ‡ãƒ«ãƒ—ãƒƒã‚·ãƒ¥"

          # ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… ãƒ¢ãƒ‡ãƒ«æ›´æ–°ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
              exit 0
            else
              echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆè©¦è¡Œ $i/3ï¼‰"
              sleep 5
            fi
          done

          echo "âŒ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆ3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰"
          exit 1

      - name: Trigger Production Deployment
        if: github.event.inputs.dry_run != 'true' && steps.commit.outputs.commit_created == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: model-updated

      - name: Training Summary Report
        if: always()
        run: |
          echo "ğŸ“Š === MLãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã‚µãƒãƒªãƒ¼ ==="
          echo "å®Ÿè¡Œæ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "å®Ÿè¡Œã‚¿ã‚¤ãƒ—: ${{ github.event_name }}"
          echo "Optunaè©¦è¡Œå›æ•°: ${{ github.event.inputs.n_trials || '50' }}"
          echo "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ${{ github.event.inputs.dry_run || 'false' }}"
          echo "å­¦ç¿’æˆåŠŸ: ${{ steps.training.outputs.training_success || 'unknown' }}"
          echo "ã‚³ãƒŸãƒƒãƒˆä½œæˆ: ${{ steps.commit.outputs.commit_created || 'false' }}"

          if [ -f "models/production/production_model_metadata.json" ]; then
            echo ""
            echo "ğŸ¯ æ–°ãƒ¢ãƒ‡ãƒ«è©³ç´°:"
            python3 -c "
import json
try:
    metadata = json.load(open('models/production/production_model_metadata.json'))
    print(f'  ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—: {metadata.get(\"model_type\", \"unknown\")}')
    print(f'  ç‰¹å¾´é‡æ•°: {len(metadata.get(\"feature_names\", []))}')
    print(f'  ä½œæˆæ—¥æ™‚: {metadata.get(\"created_at\", \"unknown\")}')
    print(f'  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {metadata.get(\"status\", \"unknown\")}')

    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    perf = metadata.get('performance_metrics', {})
    if perf:
        print(f'  F1ã‚¹ã‚³ã‚¢ï¼ˆLightGBMï¼‰: {perf.get(\"lightgbm\", {}).get(\"test_f1\", \"N/A\")}')
        print(f'  F1ã‚¹ã‚³ã‚¢ï¼ˆXGBoostï¼‰: {perf.get(\"xgboost\", {}).get(\"test_f1\", \"N/A\")}')
        print(f'  F1ã‚¹ã‚³ã‚¢ï¼ˆRandomForestï¼‰: {perf.get(\"random_forest\", {}).get(\"test_f1\", \"N/A\")}')
except Exception as e:
    print(f'  ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {e}')
            "
          fi

          echo ""
          echo "ğŸ“ˆ Phase 49å®Œäº†: 55ç‰¹å¾´é‡Strategy-Aware MLãƒ»3ã‚¯ãƒ©ã‚¹åˆ†é¡ãƒ»Optunaæœ€é©åŒ–"
          echo "âœ… ãƒ¢ãƒ‡ãƒ«å®šæœŸå­¦ç¿’: ${{ job.status == 'success' && 'å®Œäº†' || 'å¤±æ•—' }}"

      - name: Training Failure Alert
        if: failure()
        run: |
          echo "ğŸš¨ ========================================="
          echo "ğŸš¨ è­¦å‘Š: ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸš¨ æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ãŒç¶™ç¶šä½¿ç”¨ã•ã‚Œã¾ã™"
          echo "ğŸš¨ æ‰‹å‹•ç¢ºèªãƒ»ä¿®æ­£ãŒå¿…è¦ã§ã™"
          echo "ğŸš¨ ========================================="

          # å­¦ç¿’ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          if [ -f "/tmp/training.log" ]; then
            echo ""
            echo "ğŸ“‹ å­¦ç¿’ãƒ­ã‚°ï¼ˆæœ€å¾Œã®50è¡Œï¼‰:"
            tail -50 /tmp/training.log
          fi

# æ³¨æ„äº‹é …:
# 1. é€±æ¬¡è‡ªå‹•å®Ÿè¡Œ: æ¯é€±æ—¥æ›œ18:00 JSTï¼ˆUTC 09:00ï¼‰
# 2. æ‰‹å‹•å®Ÿè¡Œæ¨å¥¨: n_trialsèª¿æ•´å¯èƒ½ï¼ˆ50æ¨å¥¨ãƒ»100é«˜ç²¾åº¦ãƒ»30ãƒ†ã‚¹ãƒˆç”¨ï¼‰
# 3. ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰: ãƒ¢ãƒ‡ãƒ«ä¿å­˜ãªã—ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
# 4. Phase 49å®Œäº†: 55ç‰¹å¾´é‡ï¼ˆ50åŸºæœ¬+5æˆ¦ç•¥ä¿¡å·ï¼‰ãƒ»3ã‚¯ãƒ©ã‚¹åˆ†é¡ãƒ»Optunaæœ€é©åŒ–
# 5. å®Ÿè¡Œæ™‚é–“: ç´„4-8åˆ†ï¼ˆ50-100 trialsï¼‰ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ30åˆ†
