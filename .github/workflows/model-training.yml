# MLãƒ¢ãƒ‡ãƒ«è‡ªå‹•å†å­¦ç¿’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# é€±æ¬¡è‡ªå‹•å®Ÿè¡Œï¼ˆæ—¥æ›œ18:00 JSTï¼‰ãƒ»Phase 52.2æ•´ç†
# - ãƒ‡ãƒ¼ã‚¿åé›†ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ï¼ˆ180æ—¥åˆ†ï¼‰
# - MIN_FEATURE_COUNTç’°å¢ƒå¤‰æ•°è¿½åŠ 
# - Python 3.13ç¶­æŒï¼ˆPhase 52.1ãƒ™ãƒ¼ã‚¹ï¼‰
# - pushãƒˆãƒªã‚¬ãƒ¼ç„¡åŠ¹åŒ–ï¼ˆPhase 53.9ï¼‰

name: ML Model Training

on:
  # pushãƒˆãƒªã‚¬ãƒ¼ç„¡åŠ¹åŒ–ï¼ˆã‚³ãƒŸãƒƒãƒˆæ™‚ã®èª¤å®Ÿè¡Œé˜²æ­¢ï¼‰
  push:
    branches-ignore:
      - '**'

  # æ‰‹å‹•å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
  workflow_dispatch:
    inputs:
      n_trials:
        description: 'Optunaæœ€é©åŒ–è©¦è¡Œå›æ•°'
        required: true
        default: '50'
        type: choice
        options:
          - '30'   # é«˜é€Ÿãƒ†ã‚¹ãƒˆç”¨
          - '50'   # æ¨å¥¨ï¼ˆç´„4åˆ†ãƒ»ã‚³ã‚¹ãƒ‘æœ€è‰¯ï¼‰
          - '100'  # é«˜ç²¾åº¦ï¼ˆç´„8åˆ†ãƒ»+1-3%æ”¹å–„ï¼‰
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œï¼ˆãƒ¢ãƒ‡ãƒ«ä¿å­˜ãªã—ï¼‰'
        required: false
        default: false
        type: boolean

  # é€±æ¬¡è‡ªå‹•å®Ÿè¡Œï¼ˆæ—¥æ›œ18:00 JST = æ—¥æ›œ09:00 UTCï¼‰
  schedule:
    - cron: '0 9 * * 0'

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  SERVICE_NAME: crypto-bot-service-prod
  MIN_FEATURE_COUNT: 50

jobs:
  model-training:
    name: ML Model Training & Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup directories
        run: |
          mkdir -p models/{production,training,archive} logs cache src/backtest/data/historical
          git config --global user.name "GitHub Actions ML Training"
          git config --global user.email "actions@github.com"

      - name: Collect training data
        run: |
          echo "ğŸ“Š 180æ—¥åˆ†ãƒ‡ãƒ¼ã‚¿åé›†"
          python3 src/backtest/scripts/collect_historical_csv.py --days 180 --symbol BTC/JPY
          ls -lh src/backtest/data/historical/

      - name: Execute ML Model Training
        id: training
        run: |
          N_TRIALS=${{ github.event.inputs.n_trials || '50' }}
          DRY_RUN=${{ github.event.inputs.dry_run || 'false' }}

          echo "ğŸ¯ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’é–‹å§‹ï¼ˆ${N_TRIALS}è©¦è¡Œï¼‰"
          echo "ğŸ“Š 3ã‚¯ãƒ©ã‚¹åˆ†é¡ï¼ˆSELL/HOLD/BUYï¼‰ãƒ»55ç‰¹å¾´é‡"

          if [ "$DRY_RUN" = "true" ]; then
            echo "ğŸ§ª ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰"
          fi

          python3 scripts/ml/create_ml_models.py \
            --n-classes 3 \
            --threshold 0.005 \
            --optimize \
            --n-trials "$N_TRIALS" \
            --verbose

          if [ $? -eq 0 ]; then
            echo "training_success=true" >> $GITHUB_OUTPUT
            echo "âœ… ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Œäº†"
          else
            echo "training_success=false" >> $GITHUB_OUTPUT
            echo "âŒ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å¤±æ•—"
            exit 1
          fi

      - name: Model Validation
        if: github.event.inputs.dry_run != 'true' && steps.training.outputs.training_success == 'true'
        run: |
          echo "ğŸ” ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼"

          # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          if [ ! -f "models/production/ensemble_full.pkl" ]; then
            echo "âŒ ensemble_full.pklä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f "models/production/ensemble_basic.pkl" ]; then
            echo "âŒ ensemble_basic.pklä¸å­˜åœ¨"
            exit 1
          fi

          # ç‰¹å¾´é‡æ¤œè¨¼
          FEATURE_COUNT=$(python3 -c "
          import json
          m = json.load(open('models/production/production_model_metadata.json'))
          print(len(m.get('feature_names', [])))
          ")

          if [ "$FEATURE_COUNT" -lt "${{ env.MIN_FEATURE_COUNT }}" ]; then
            echo "âŒ ç‰¹å¾´é‡ä¸è¶³: $FEATURE_COUNT < ${{ env.MIN_FEATURE_COUNT }}"
            exit 1
          fi

          echo "âœ… æ¤œè¨¼å®Œäº†: ${FEATURE_COUNT}ç‰¹å¾´é‡"

      - name: Commit and Push
        if: github.event.inputs.dry_run != 'true' && steps.training.outputs.training_success == 'true'
        id: commit
        run: |
          if git diff --quiet models/ && git diff --staged --quiet models/; then
            echo "ğŸ“‹ ãƒ¢ãƒ‡ãƒ«å¤‰æ›´ãªã—"
            echo "commit_created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          git add models/production/ models/training/

          git commit -m "feat: MLãƒ¢ãƒ‡ãƒ«è‡ªå‹•æ›´æ–°ï¼ˆé€±æ¬¡å†å­¦ç¿’ï¼‰" \
            -m "" \
            -m "- 55ç‰¹å¾´é‡Strategy-Aware MLå†å­¦ç¿’" \
            -m "- 3ã‚¯ãƒ©ã‚¹åˆ†é¡ï¼ˆSELL/HOLD/BUYï¼‰ãƒ»é–¾å€¤Â±0.5%" \
            -m "- Optunaæœ€é©åŒ–ï¼ˆ${{ github.event.inputs.n_trials || '50' }}è©¦è¡Œï¼‰" \
            -m "" \
            -m "ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
            -m "" \
            -m "Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin main
          echo "commit_created=true" >> $GITHUB_OUTPUT
          echo "âœ… ãƒ¢ãƒ‡ãƒ«æ›´æ–°ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

      - name: Trigger Production Deployment
        if: github.event.inputs.dry_run != 'true' && steps.commit.outputs.commit_created == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: model-updated

      - name: Training Summary
        if: always()
        run: |
          echo "ğŸ“Š === ã‚µãƒãƒªãƒ¼ ==="
          echo "å®Ÿè¡Œ: ${{ github.event_name }}"
          echo "è©¦è¡Œ: ${{ github.event.inputs.n_trials || '50' }}"
          echo "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ${{ github.event.inputs.dry_run || 'false' }}"
          echo "æˆåŠŸ: ${{ steps.training.outputs.training_success || 'unknown' }}"

          if [ -f "models/production/production_model_metadata.json" ]; then
            echo ""
            echo "ğŸ¯ ãƒ¢ãƒ‡ãƒ«è©³ç´°:"
            python3 -c "
import json
try:
    m = json.load(open('models/production/production_model_metadata.json'))
    print(f'  ç‰¹å¾´é‡æ•°: {len(m.get(\"feature_names\", []))}')
    print(f'  ä½œæˆæ—¥æ™‚: {m.get(\"created_at\", \"unknown\")}')
except Exception as e:
    print(f'  èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {e}')
            "
          fi

      - name: Training Failure Alert
        if: failure()
        run: |
          echo "ğŸš¨ è­¦å‘Š: ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å¤±æ•—"
          echo "ğŸš¨ æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ãŒç¶™ç¶šä½¿ç”¨ã•ã‚Œã¾ã™"

# æ³¨æ„äº‹é …:
# 1. é€±æ¬¡è‡ªå‹•å®Ÿè¡Œ: æ¯é€±æ—¥æ›œ18:00 JSTï¼ˆUTC 09:00ï¼‰
# 2. æ‰‹å‹•å®Ÿè¡Œæ¨å¥¨: n_trialsèª¿æ•´å¯èƒ½ï¼ˆ50æ¨å¥¨ãƒ»100é«˜ç²¾åº¦ãƒ»30ãƒ†ã‚¹ãƒˆç”¨ï¼‰
# 3. ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰: ãƒ¢ãƒ‡ãƒ«ä¿å­˜ãªã—ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
# 4. Phase 52.2æ•´ç†: ãƒ‡ãƒ¼ã‚¿åé›†ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ãƒ»MIN_FEATURE_COUNTç’°å¢ƒå¤‰æ•°
# 5. å®Ÿè¡Œæ™‚é–“: ç´„4-8åˆ†ï¼ˆ50-100 trialsï¼‰ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ30åˆ†
