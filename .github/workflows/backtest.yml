# ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - Phase 52.1æ”¹ä¿®ç‰ˆ
# ç›®çš„: å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†â†’ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œâ†’Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

name: Backtest Automation

on:
  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ï¼ˆé€±æ¬¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä¸€æ—¦ç„¡åŠ¹åŒ–ï¼‰
  workflow_dispatch:
    inputs:
      phase_name:
        description: 'Phaseåï¼ˆãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åç”¨ï¼‰'
        required: false
        default: '52.1'
      backtest_days:
        description: 'ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæ—¥æ•°'
        required: false
        default: '180'
        type: choice
        options:
          - '30'
          - '60'
          - '90'
          - '180'
          - '365'

env:
  PYTHON_VERSION: '3.13'
  BACKTEST_TIMEOUT_MINUTES: 300  # 5æ™‚é–“ï¼ˆå±¥æ­´åé›†+ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼‰

jobs:
  backtest:
    name: Backtest Execution
    env:
      HISTORICAL_DATA_DAYS: ${{ github.event.inputs.backtest_days || '180' }}
    runs-on: ubuntu-latest
    timeout-minutes: 360  # å…¨ä½“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 6æ™‚é–“

    permissions:
      contents: write  # Git commitã¨pushã«å¿…è¦

    steps:
      # ========================================
      # Step 1: ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆGitæ“ä½œç”¨ï¼‰

      # ========================================
      # Step 2: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ========================================
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      # ========================================
      # Step 3: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ========================================
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

      # ========================================
      # Step 4: å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†
      # ========================================
      - name: Collect historical data
        run: |
          echo "ğŸ“¥ å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹..."

          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p src/backtest/data/historical

          # å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆ${HISTORICAL_DATA_DAYS}æ—¥åˆ†ï¼‰
          python3 src/backtest/scripts/collect_historical_csv.py --days ${{ env.HISTORICAL_DATA_DAYS }}

          # ãƒ‡ãƒ¼ã‚¿åé›†ç¢ºèªï¼ˆå¤§æ–‡å­—ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
          if [ -f "src/backtest/data/historical/BTC_JPY_15m.csv" ]; then
            CSV_LINES=$(wc -l < src/backtest/data/historical/BTC_JPY_15m.csv)
            echo "âœ… 15åˆ†è¶³ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†: ${CSV_LINES}è¡Œ"
          else
            echo "âŒ 15åˆ†è¶³ãƒ‡ãƒ¼ã‚¿åé›†å¤±æ•—"
            exit 1
          fi

          if [ -f "src/backtest/data/historical/BTC_JPY_4h.csv" ]; then
            CSV_LINES=$(wc -l < src/backtest/data/historical/BTC_JPY_4h.csv)
            echo "âœ… 4æ™‚é–“è¶³ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†: ${CSV_LINES}è¡Œ"
          else
            echo "âŒ 4æ™‚é–“è¶³ãƒ‡ãƒ¼ã‚¿åé›†å¤±æ•—"
            exit 1
          fi

          echo "âœ… å±¥æ­´ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†"

      # ========================================
      # Step 5: ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
      # ========================================
      - name: Setup backtest environment
        run: |
          echo "ğŸ”§ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™é–‹å§‹..."

          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p logs cache src/backtest/logs docs/æ¤œè¨¼è¨˜éŒ²

          # ãƒ¢ãƒ‡ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          echo '{"version": "backtest", "features": 55, "created": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > models/production/model_metadata.json

          # ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          if [ -f "models/production/ensemble_full.pkl" ]; then
            echo "âœ… ensemble_full.pklç¢ºèªæ¸ˆã¿"
          else
            echo "âŒ ensemble_full.pklæœªç¢ºèª"
            exit 1
          fi

          if [ -f "models/production/ensemble_basic.pkl" ]; then
            echo "âœ… ensemble_basic.pklç¢ºèªæ¸ˆã¿"
          else
            echo "âš ï¸ ensemble_basic.pklæœªç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸å¯ï¼‰"
          fi

          echo "âœ… ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†"

      # ========================================
      # Step 6: ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      # ========================================
      - name: Run backtest
        run: |
          echo "ğŸš€ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
          echo "å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M:%S')"
          echo "å®Ÿè¡Œæ™‚åˆ»ï¼ˆUTCï¼‰: $(date -u '+%Y/%m/%d %H:%M:%S')"
          echo "ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæ—¥æ•°: ${{ env.HISTORICAL_DATA_DAYS }}æ—¥"

          # PYTHONPATHè¨­å®š
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"

          # ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–: timeoutã‚³ãƒãƒ³ãƒ‰ä½¿ç”¨ï¼‰
          timeout $((BACKTEST_TIMEOUT_MINUTES * 60)) python3 main.py --mode backtest 2>&1 | tee backtest_run.log

          BACKTEST_EXIT_CODE=${PIPESTATUS[0]}

          if [ $BACKTEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒæˆåŠŸ"
          elif [ $BACKTEST_EXIT_CODE -eq 124 ]; then
            echo "â±ï¸ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ${BACKTEST_TIMEOUT_MINUTES}åˆ†è¶…éï¼‰"
            exit 1
          else
            echo "âŒ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¤±æ•—ï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $BACKTEST_EXIT_CODEï¼‰"
            exit 1
          fi

          # æœ€æ–°ã®JSONãƒ¬ãƒãƒ¼ãƒˆç¢ºèª
          LATEST_JSON=$(ls -t src/backtest/logs/backtest_*.json 2>/dev/null | head -1)
          if [ -n "$LATEST_JSON" ]; then
            echo "âœ… JSONãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç¢ºèª: $LATEST_JSON"
            echo "LATEST_JSON=$LATEST_JSON" >> $GITHUB_ENV
          else
            echo "âŒ JSONãƒ¬ãƒãƒ¼ãƒˆæœªç”Ÿæˆ"
            exit 1
          fi

      # ========================================
      # Step 7: Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      # ========================================
      - name: Generate Markdown report
        run: |
          echo "ğŸ“ Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹..."

          # Phaseåå–å¾—ï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã¯å…¥åŠ›å€¤ã€å®šæœŸå®Ÿè¡Œæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
          PHASE_NAME="${{ github.event.inputs.phase_name || '52.1' }}"
          echo "Phaseå: $PHASE_NAME"

          # PYTHONPATHè¨­å®š
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"

          # Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          python3 scripts/backtest/generate_markdown_report.py \
            "$LATEST_JSON" \
            --phase "$PHASE_NAME" \
            --output-dir "docs/æ¤œè¨¼è¨˜éŒ²"

          # ç”Ÿæˆã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          LATEST_MARKDOWN=$(ls -t docs/æ¤œè¨¼è¨˜éŒ²/Phase_*.md 2>/dev/null | head -1)
          if [ -n "$LATEST_MARKDOWN" ]; then
            echo "âœ… Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç¢ºèª: $LATEST_MARKDOWN"
            echo "LATEST_MARKDOWN=$LATEST_MARKDOWN" >> $GITHUB_ENV
          else
            echo "âŒ Markdownãƒ¬ãƒãƒ¼ãƒˆæœªç”Ÿæˆ"
            exit 1
          fi

      # ========================================
      # Step 8: Gitè¨­å®š
      # ========================================
      - name: Configure Git
        run: |
          echo "âš™ï¸ Gitè¨­å®šé–‹å§‹..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          echo "âœ… Gitè¨­å®šå®Œäº†"

      # ========================================
      # Step 9: Markdownãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆ
      # ========================================
      - name: Commit Markdown report
        run: |
          echo "ğŸ“¤ Markdownãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒŸãƒƒãƒˆé–‹å§‹..."

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          git status --short

          # Markdownãƒ¬ãƒãƒ¼ãƒˆã®ã¿ã‚³ãƒŸãƒƒãƒˆï¼ˆJSONã¯é™¤å¤–ï¼‰
          git add "docs/æ¤œè¨¼è¨˜éŒ²/Phase_*.md"

          # ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if git diff --staged --quiet; then
            echo "â„¹ï¸ ã‚³ãƒŸãƒƒãƒˆå¯¾è±¡ãªã—ï¼ˆå¤‰æ›´ãªã—ï¼‰"
          else
            REPORT_DATE=$(TZ=Asia/Tokyo date '+%Y/%m/%d')
            COMMIT_MSG="docs: é€±æ¬¡ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ  ${REPORT_DATE}"
            COMMIT_BODY="é€±æ¬¡è‡ªå‹•ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ (Phase 52.1) | å®Ÿè¡Œæ—¥æ™‚: ${REPORT_DATE} | ãƒ¬ãƒãƒ¼ãƒˆ: ${LATEST_MARKDOWN} | è‡ªå‹•ç”Ÿæˆ: GitHub Actions"

            git commit -m "${COMMIT_MSG}" -m "${COMMIT_BODY}"
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆå®Œäº†"
          fi

      # ========================================
      # Step 10: ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥
      # ========================================
      - name: Push to repository
        run: |
          echo "ğŸš€ ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥é–‹å§‹..."

          # ãƒªãƒ¢ãƒ¼ãƒˆã®å¤‰æ›´ã‚’å–å¾—ã—ã¦rebaseï¼ˆé•·æ™‚é–“å®Ÿè¡Œä¸­ã®ç«¶åˆå¯¾ç­–ï¼‰
          echo "ğŸ“¥ ãƒªãƒ¢ãƒ¼ãƒˆå¤‰æ›´ã‚’å–å¾—ä¸­..."
          git fetch origin main
          git rebase origin/main || {
            echo "âš ï¸ rebaseç«¶åˆç™ºç”Ÿ - è‡ªå‹•è§£æ±ºã‚’è©¦è¡Œ"
            git rebase --abort
            git pull --rebase origin main
          }

          # ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin main; then
              echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆè©¦è¡Œ $RETRY_COUNT/$MAX_RETRIESï¼‰"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ“¥ å†åº¦ãƒªãƒ¢ãƒ¼ãƒˆå¤‰æ›´ã‚’å–å¾—..."
                git pull --rebase origin main
              fi
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ï¼ˆ${MAX_RETRIES}å›ãƒªãƒˆãƒ©ã‚¤å¾Œï¼‰"
            exit 1
          fi

          echo "ğŸ“ Markdownãƒ¬ãƒãƒ¼ãƒˆãŒãƒªãƒã‚¸ãƒˆãƒªã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ: ${LATEST_MARKDOWN}"
          echo "ğŸ”„ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ 'git pull' ã‚’å®Ÿè¡Œã—ã¦åŒæœŸã—ã¦ãã ã•ã„"

      # ========================================
      # Step 11: å®Ÿè¡Œã‚µãƒãƒªãƒ¼
      # ========================================
      - name: Execution summary
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼"
          echo "========================================"
          echo "Phase: ${{ github.event.inputs.phase_name || '52.1' }}"
          echo "æœŸé–“: ${{ env.HISTORICAL_DATA_DAYS }}æ—¥é–“"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æˆåŠŸ"
            echo "ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆ: ${LATEST_MARKDOWN}"
            echo "ğŸ“¤ Git: ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
            echo "ğŸ”„ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: git pull ã§åŒæœŸã—ã¦ãã ã•ã„"
          else
            echo "âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¤±æ•—"
            echo "ğŸ” ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi

          echo "========================================"
          echo "å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M:%S')"
          echo "========================================"

# ========================================
# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
# ========================================
concurrency:
  group: weekly-backtest
  cancel-in-progress: false  # å®Ÿè¡Œä¸­ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã¯ä¸­æ–­ã—ãªã„
