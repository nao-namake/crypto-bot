# Phase 13: çµ±åˆå“è³ªä¿è¨¼CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# 306ãƒ†ã‚¹ãƒˆå®Ÿè£…ãƒ»Phase 13çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Œæˆãƒ»ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  REPOSITORY: crypto-bot-repo
  SERVICE_NAME: crypto-bot-service-prod  # å®Ÿéš›ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹åã«åˆã‚ã›ã‚‹

jobs:
  # ========================================
  # 1. å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆPhase 12çµ±åˆå“è³ªä¿è¨¼ä½“åˆ¶ï¼‰
  # ========================================
  quality-check:
    name: Quality Check & Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Phase 12å“è³ªãƒã‚§ãƒƒã‚¯ç”¨ãƒ„ãƒ¼ãƒ«
          pip install pytest flake8 black isort pytest-cov

      - name: Create models directory for tests
        run: |
          mkdir -p models/production
          # ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ¢ãƒ‡ãƒ«ä½œæˆ
          echo '{"version": "ci-test", "features": 12, "created": "2025-08-17"}' > models/production/model_metadata.json
          touch models/production/production_ensemble.pkl

      - name: Phase 13çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” Phase 13çµ±åˆå“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          echo "306ãƒ†ã‚¹ãƒˆãƒ»çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œãƒ»ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰çµ±åˆ"
          
          # Phase 13æ”¹å–„: æ®µéšçš„å“è³ªãƒã‚§ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ï¼‰
          echo "ğŸ“‹ æ®µéš1: çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          if bash scripts/testing/checks.sh; then
            echo "âœ… çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯æˆåŠŸ"
          else
            echo "âš ï¸ çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•— - è©³ç´°è¨ºæ–­é–‹å§‹"
            
            # æ®µéš2: é‡è¦ãƒ†ã‚¹ãƒˆå€‹åˆ¥å®Ÿè¡Œï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼run_production_tests.shæ”¹è‰¯ï¼‰
            echo "ğŸ“‹ æ®µéš2: é‡è¦ãƒ†ã‚¹ãƒˆå€‹åˆ¥å®Ÿè¡Œ"
            TEST_ERRORS=0
            
            echo "ğŸ§ª æˆ¦ç•¥å±¤ãƒ†ã‚¹ãƒˆ..."
            python -m pytest tests/unit/strategies/ -v --tb=short --maxfail=3 || ((TEST_ERRORS++))
            
            echo "ğŸ¤– MLå±¤ãƒ†ã‚¹ãƒˆ..."
            python -m pytest tests/unit/ml/ -v --tb=short --maxfail=3 || ((TEST_ERRORS++))
            
            echo "ğŸ’¼ å–å¼•å±¤ãƒ†ã‚¹ãƒˆ..."
            python -m pytest tests/unit/trading/ -v --tb=short --maxfail=3 || ((TEST_ERRORS++))
            
            echo "ğŸ“Š ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå±¤ãƒ†ã‚¹ãƒˆ..."
            python -m pytest tests/unit/backtest/ -v --tb=short --maxfail=3 || ((TEST_ERRORS++))
            
            # æ®µéš3: ã‚³ãƒ¼ãƒ‰å“è³ªè©³ç´°è¨ºæ–­ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼validate_all.shæ”¹è‰¯ï¼‰
            echo "ğŸ“‹ æ®µéš3: ã‚³ãƒ¼ãƒ‰å“è³ªè©³ç´°è¨ºæ–­"
            
            echo "ğŸ” flake8å“è³ªãƒã‚§ãƒƒã‚¯..."
            flake8_errors=$(flake8 src/ --count --statistics 2>&1 | tail -1 | grep -o '^[0-9]*' || echo "0")
            echo "flake8ã‚¨ãƒ©ãƒ¼æ•°: $flake8_errors"
            
            echo "ğŸ“ ã‚³ãƒ¼ãƒ‰æ•´å½¢ãƒã‚§ãƒƒã‚¯..."
            if ! black --check src/ --quiet; then
              echo "âš ï¸ ã‚³ãƒ¼ãƒ‰æ•´å½¢ãŒå¿…è¦"
            else
              echo "âœ… ã‚³ãƒ¼ãƒ‰æ•´å½¢OK"
            fi
            
            echo "ğŸ“¦ ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºãƒã‚§ãƒƒã‚¯..."
            if ! isort --check-only src/ --quiet; then
              echo "âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºä¿®æ­£ãŒå¿…è¦"
            else
              echo "âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºOK"
            fi
            
            # çµæœåˆ¤å®šï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ç‰ˆï¼‰
            if [ $TEST_ERRORS -eq 0 ]; then
              echo "âœ… é‡è¦ãƒ†ã‚¹ãƒˆã¯å…¨ã¦æˆåŠŸ - CIç¶™ç¶šå¯èƒ½"
              if [ "$flake8_errors" -lt 50 ]; then
                echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªã‚‚è¨±å®¹ç¯„å›²å†…"
                exit 0
              else
                echo "âš ï¸ ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„æ¨å¥¨ã ãŒCIç¶™ç¶š"
                exit 0
              fi
            else
              echo "âŒ $TEST_ERRORS å€‹ã®ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã§å¤±æ•— - CIåœæ­¢"
              exit 1
            fi
          fi

      - name: Test critical components
        run: |
          echo "ğŸ§ª é‡è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          
          # Phase 12ã®é‡è¦ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆé«˜é€ŸåŒ–ï¼‰
          python -m pytest tests/unit/trading/test_executor.py -v --tb=short
          python -m pytest tests/unit/strategies/implementations/test_atr_based.py -v --tb=short
          python -m pytest tests/unit/ml/test_ensemble_model.py -v --tb=short
          
          echo "âœ… é‡è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: Validate system integration
        run: |
          echo "ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ çµ±åˆç¢ºèª"
          
          # Phase 13çµ±åˆç¢ºèªï¼ˆçµ±åˆç®¡ç†CLIæ´»ç”¨ï¼‰
          python scripts/management/dev_check.py phase-check || echo "âš ï¸ Phaseç¢ºèªã§å•é¡Œæ¤œå‡º"
          python scripts/management/dev_check.py data-check || echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿å±¤ç¢ºèªã§å•é¡Œæ¤œå‡º"
          
          # ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
          python -c "
          try:
              from src.core.orchestrator import create_trading_orchestrator
              from src.trading.executor import OrderExecutor, ExecutionMode
              from src.ml.production.ensemble import ProductionEnsemble
              print('âœ… Phase 13é‡è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ')
          except Exception as e:
              print(f'âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
          "

  # ========================================
  # 2. GCPç’°å¢ƒæ¤œè¨¼ï¼ˆPhase 13æ–°æ©Ÿèƒ½ï¼‰
  # ========================================
  gcp-environment-check:
    name: GCP Environment Verification
    needs: quality-check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # mainãƒ–ãƒ©ãƒ³ãƒãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿å®Ÿè¡Œï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å‰æ¤œè¨¼ï¼‰
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/11445303925/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deployer@my-crypto-bot-project.iam.gserviceaccount.com
          access_token_lifetime: 1800s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run GCP Environment Pre-Check
        run: |
          echo "ğŸ” Phase 13: GCPç’°å¢ƒäº‹å‰æ¤œè¨¼é–‹å§‹"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«GCPç’°å¢ƒã®æº–å‚™çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™"
          
          # æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          chmod +x scripts/deployment/verify_gcp_setup.sh
          
          # ãƒ¬ã‚¬ã‚·ãƒ¼æ–¹å¼ï¼šèªè¨¼ç¢ºèªå¼·åŒ–ç‰ˆï¼ˆæ¨©é™åæ˜ ãƒ©ã‚°å¯¾å¿œï¼‰
          echo "ğŸ” ãƒ¬ã‚¬ã‚·ãƒ¼æ–¹å¼ï¼šè»½é‡GCPæ¤œè¨¼å®Ÿè¡Œ"
          
          # 1. èªè¨¼çŠ¶æ…‹è©³ç´°ç¢ºèªï¼ˆService Accountå½è£…ç¢ºèªï¼‰
          echo "ğŸ” èªè¨¼çŠ¶æ…‹ç¢ºèª..."
          ACTIVE_ACCOUNT=$(gcloud auth list --filter=status:ACTIVE --format="value(account)" | head -n1)
          if [ -n "$ACTIVE_ACCOUNT" ]; then
            echo "âœ… gcloudèªè¨¼ç¢ºèª: $ACTIVE_ACCOUNT"
            # Service Accountå½è£…ç¢ºèª
            if [[ "$ACTIVE_ACCOUNT" == *"github-deployer@my-crypto-bot-project.iam.gserviceaccount.com"* ]]; then
              echo "âœ… Service Accountå½è£…æˆåŠŸ: github-deployer"
            else
              echo "âš ï¸ Service Accountå½è£…æœªç¢ºèª: $ACTIVE_ACCOUNT"
              echo "ãƒ‡ãƒãƒƒã‚°: Workload Identity Poolã‹ã‚‰ Service Account ã¸ã®å½è£…ç¢ºèªä¸­..."
            fi
          else
            echo "âŒ gcloudèªè¨¼å¤±æ•—"
            exit 1
          fi
          
          # 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šç¢ºå®ŸåŒ–
          echo "ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šç¢ºå®ŸåŒ–..."
          if gcloud config set project ${{ env.PROJECT_ID }}; then
            # è¨­å®šç¢ºèª
            CURRENT_PROJECT=$(gcloud config get-value project 2>/dev/null)
            if [ "$CURRENT_PROJECT" = "${{ env.PROJECT_ID }}" ]; then
              echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šç¢ºèª: ${{ env.PROJECT_ID }}"
            else
              echo "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šä¸ä¸€è‡´: expected=${{ env.PROJECT_ID }}, actual=$CURRENT_PROJECT"
              exit 1
            fi
          else
            echo "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šå¤±æ•—: ${{ env.PROJECT_ID }}"
            exit 1
          fi
          
          # 3. æ¨©é™åæ˜ å¾…æ©Ÿï¼ˆèªè¨¼ãƒ©ã‚°å¯¾å¿œï¼‰
          echo "â³ æ¨©é™åæ˜ å¾…æ©Ÿï¼ˆ3ç§’ï¼‰..."
          sleep 3
          
          echo "âœ… GCPç’°å¢ƒåŸºæœ¬ç¢ºèªå®Œäº† - ãƒªã‚½ãƒ¼ã‚¹ç¢ºèªã¸ç§»è¡Œ"

      - name: Verify Critical GCP Resources
        run: |
          echo "ğŸ—ï¸ é‡è¦ãªGCPãƒªã‚½ãƒ¼ã‚¹ç¢ºèª - å¿…é ˆãƒªã‚½ãƒ¼ã‚¹ç¢ºèªå¼·åŒ–ï¼ˆæ¨©é™åæ˜ ãƒ©ã‚°å¯¾å¿œç‰ˆï¼‰"
          
          # èªè¨¼çŠ¶æ…‹å†ç¢ºèª
          echo "ğŸ” èªè¨¼çŠ¶æ…‹å†ç¢ºèª..."
          CURRENT_PROJECT=$(gcloud config get-value project 2>/dev/null)
          if [ "$CURRENT_PROJECT" != "${{ env.PROJECT_ID }}" ]; then
            echo "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šç•°å¸¸: $CURRENT_PROJECT"
            exit 1
          fi
          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šæ­£å¸¸: $CURRENT_PROJECT"
          
          # Artifact Registryç¢ºèªï¼ˆå¿…é ˆãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
          echo "ğŸ“¦ Artifact Registryç¢ºèª..."
          if gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
              --location=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} 2>/tmp/artifact_error.log; then
            echo "âœ… Artifact Registryæº–å‚™å®Œäº†"
          else
            echo "âŒ Artifact Registryç¢ºèªå¤±æ•—"
            echo "ã‚¨ãƒ©ãƒ¼è©³ç´°:"
            cat /tmp/artifact_error.log
            echo ""
            echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            echo "- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${{ env.PROJECT_ID }}"
            echo "- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ${{ env.REGION }}"
            echo "- ãƒªãƒã‚¸ãƒˆãƒª: ${{ env.REPOSITORY }}"
            echo "- èªè¨¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: $(gcloud auth list --filter=status:ACTIVE --format='value(account)' | head -n1)"
            exit 1
          fi
          
          # Secret Managerç¢ºèªï¼ˆå¿…é ˆãƒ»è©³ç´°ã‚¨ãƒ©ãƒ¼ï¼‰
          echo "ğŸ” Secret Managerç¢ºèª..."
          required_secrets=("bitbank-api-key" "bitbank-api-secret")
          missing_secrets=()
          
          for secret in "${required_secrets[@]}"; do
            if gcloud secrets describe "$secret" --project=${{ env.PROJECT_ID }} 2>/tmp/secret_error_${secret}.log; then
              echo "âœ… Secretè¨­å®šæ¸ˆã¿: $secret"
            else
              echo "âŒ Secretæœªè¨­å®š: $secret"
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°:"
              cat /tmp/secret_error_${secret}.log
              missing_secrets+=("$secret")
            fi
          done
          
          if [ ${#missing_secrets[@]} -eq 0 ]; then
            echo "âœ… å¿…é ˆSecret Managerè¨­å®šå®Œäº†"
          else
            echo "âŒ å¿…é ˆSecretæœªè¨­å®š - ãƒ‡ãƒ—ãƒ­ã‚¤ä¸å¯"
            echo "æœªè¨­å®šSecret: ${missing_secrets[*]}"
            exit 1
          fi
          
          echo "ğŸ¯ å…¨å¿…é ˆãƒªã‚½ãƒ¼ã‚¹ç¢ºèªå®Œäº† - ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œæº–å‚™å®Œäº†"

  # ========================================
  # 3. Docker Build & GCP Deployï¼ˆæœ¬ç•ªç”¨ï¼‰
  # ========================================
  build-deploy:
    name: Build & Deploy to GCP
    needs: [quality-check, gcp-environment-check]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # mainãƒ–ãƒ©ãƒ³ãƒãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create required directories for Docker
        run: |
          # Dockerç”¨ã®å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p models/production logs cache
          echo '{"version": "production", "features": 12, "created": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > models/production/model_metadata.json
          
          # æœ¬ç•ªç”¨ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªï¼ˆå¿…é ˆï¼‰
          if [ ! -f "models/production/production_ensemble.pkl" ]; then
            echo "âŒ æœ¬ç•ªç”¨ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ—ãƒ­ã‚¤ä¸å¯"
            echo "Phase 13ã®MLãƒ¢ãƒ‡ãƒ«ä½œæˆãŒå¿…è¦ã§ã™"
            echo "å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: python scripts/ml/create_ml_models.py"
            exit 1
          else
            echo "âœ… æœ¬ç•ªç”¨ãƒ¢ãƒ‡ãƒ«ç¢ºèªæ¸ˆã¿: models/production/production_ensemble.pkl"
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/11445303925/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deployer@my-crypto-bot-project.iam.gserviceaccount.com
          access_token_lifetime: 3600s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Verify Artifact Registry repository exists
        run: |
          # ãƒ¬ãƒã‚¸ãƒˆãƒªå­˜åœ¨ç¢ºèªï¼ˆå¿…é ˆï¼‰
          echo "ğŸ” Artifact Registryãƒ¬ãƒã‚¸ãƒˆãƒªå­˜åœ¨ç¢ºèª..."
          if gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
              --location=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
            echo "âœ… Artifact Registryãƒ¬ãƒã‚¸ãƒˆãƒªç¢ºèªæ¸ˆã¿"
          else
            echo "âŒ Artifact Registryãƒ¬ãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ—ãƒ­ã‚¤ä¸å¯"
            echo "å¿…è¦ãªä½œæˆã‚³ãƒãƒ³ãƒ‰ï¼š"
            echo "gcloud artifacts repositories create ${{ env.REPOSITORY }} --repository-format=docker --location=${{ env.REGION }} --project=${{ env.PROJECT_ID }}"
            exit 1
          fi

      - name: Build and Push Docker Image
        run: |
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°è¨­å®š
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot"
          COMMIT_SHA="${{ github.sha }}"
          
          echo "ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰é–‹å§‹: ${IMAGE_TAG}:${COMMIT_SHA}"
          
          # Dockerãƒ“ãƒ«ãƒ‰ï¼ˆPhase 7æœ€é©åŒ–ç‰ˆä½¿ç”¨ï¼‰
          docker build -t "${IMAGE_TAG}:${COMMIT_SHA}" -t "${IMAGE_TAG}:latest" .
          
          # ãƒ—ãƒƒã‚·ãƒ¥
          docker push "${IMAGE_TAG}:${COMMIT_SHA}"
          docker push "${IMAGE_TAG}:latest"
          
          echo "âœ… Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

      - name: æ®µéšçš„Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ç‰ˆï¼‰
        run: |
          IMAGE_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot:${{ github.sha }}"
          
          echo "ğŸš€ Phase 13æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹: ${IMAGE_TAG}"
          echo "çµ±åˆå“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒ»306ãƒ†ã‚¹ãƒˆãƒ»ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œç‰ˆ"
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ãƒ»æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
          DEPLOY_MODE="${{ secrets.DEPLOY_MODE || 'live' }}"
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰: $DEPLOY_MODE"
          
          # æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼deploy_production.shæ”¹è‰¯ï¼‰
          case "$DEPLOY_MODE" in
            "paper")
              SERVICE_SUFFIX=""
              MEMORY="1Gi"
              CPU="1"
              MIN_INSTANCES="0"
              MAX_INSTANCES="1"
              TIMEOUT="1800"
              echo "ğŸ“‹ ãƒšãƒ¼ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®‰å…¨ãƒ¢ãƒ¼ãƒ‰ï¼‰"
              ;;
            "stage-10")
              SERVICE_SUFFIX="-stage10"
              MEMORY="1Gi"
              CPU="1"
              MIN_INSTANCES="1"
              MAX_INSTANCES="1"
              TIMEOUT="1800"
              echo "ğŸ“‹ æ®µéš1ï¼š10%æŠ•å…¥ãƒ¢ãƒ¼ãƒ‰"
              ;;
            "stage-50")
              SERVICE_SUFFIX="-stage50"
              MEMORY="1.5Gi"
              CPU="1"
              MIN_INSTANCES="1"
              MAX_INSTANCES="1"
              TIMEOUT="2400"
              echo "ğŸ“‹ æ®µéš2ï¼š50%æŠ•å…¥ãƒ¢ãƒ¼ãƒ‰"
              ;;
            "live")
              SERVICE_SUFFIX="-prod"
              MEMORY="1Gi"
              CPU="1"
              MIN_INSTANCES="1"
              MAX_INSTANCES="2"
              TIMEOUT="3600"
              echo "ğŸ“‹ æ®µéš3ï¼š100%æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼ˆå–å¼•ç¶™ç¶šæ€§é‡è¦–ï¼‰"
              ;;
            *)
              SERVICE_SUFFIX="-prod"
              MEMORY="1Gi"
              CPU="1"
              MIN_INSTANCES="1"
              MAX_INSTANCES="2"
              TIMEOUT="3600"
              echo "ğŸ“‹ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼ˆliveï¼‰"
              DEPLOY_MODE="live"
              ;;
          esac
          
          FULL_SERVICE_NAME="${{ env.SERVICE_NAME }}${SERVICE_SUFFIX}"
          echo "ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒ¼ãƒ“ã‚¹å: $FULL_SERVICE_NAME"
          
          # Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆPhase 13æ®µéšçš„å¯¾å¿œãƒ»--no-trafficå•é¡Œä¿®æ­£ï¼‰
          echo "ğŸ” ã‚µãƒ¼ãƒ“ã‚¹å­˜åœ¨ç¢ºèª: $FULL_SERVICE_NAME"
          if gcloud run services describe "$FULL_SERVICE_NAME" --region=${{ env.REGION }} >/dev/null 2>&1; then
            echo "âœ… æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆ--no-trafficä½¿ç”¨å¯èƒ½ï¼‰"
            TRAFFIC_FLAG="--no-traffic"
          else
            echo "ğŸ†• æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆï¼ˆ--no-trafficä¸å¯ï¼‰"
            TRAFFIC_FLAG=""
          fi
          
          gcloud run deploy "$FULL_SERVICE_NAME" \
            --image="${IMAGE_TAG}" \
            --region=${{ env.REGION }} \
            --platform=managed \
            --memory="$MEMORY" \
            --cpu="$CPU" \
            --min-instances="$MIN_INSTANCES" \
            --max-instances="$MAX_INSTANCES" \
            --concurrency=1 \
            --timeout="$TIMEOUT" \
            --allow-unauthenticated \
            --set-env-vars="MODE=$DEPLOY_MODE,LOG_LEVEL=INFO,PYTHONPATH=/app,DEPLOY_STAGE=$DEPLOY_MODE" \
            --set-secrets="BITBANK_API_KEY=bitbank-api-key:latest,BITBANK_API_SECRET=bitbank-api-secret:latest,DISCORD_WEBHOOK_URL=discord-webhook-url:latest" \
            --port=8080 \
            --revision-suffix="phase13-$(date +%m%d-%H%M)" \
            $TRAFFIC_FLAG
          
          # æ®µéšçš„ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯é…åˆ†ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ï¼‰
          if [ "$DEPLOY_MODE" != "paper" ]; then
            echo "ğŸ“Š æ®µéšçš„ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯é…åˆ†å®Ÿè¡Œ"
            
            # æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã«æ®µéšçš„ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œ
            case "$DEPLOY_MODE" in
              "stage-10")
                echo "ğŸ”„ 10%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œ"
                gcloud run services update-traffic "$FULL_SERVICE_NAME" \
                  --to-revisions=LATEST=10 \
                  --region=${{ env.REGION }} || echo "âš ï¸ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œå¤±æ•—"
                ;;
              "stage-50")
                echo "ğŸ”„ 50%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œ"
                gcloud run services update-traffic "$FULL_SERVICE_NAME" \
                  --to-revisions=LATEST=50 \
                  --region=${{ env.REGION }} || echo "âš ï¸ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œå¤±æ•—"
                ;;
              "live")
                echo "ğŸ”„ 100%ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œ"
                gcloud run services update-traffic "$FULL_SERVICE_NAME" \
                  --to-latest \
                  --region=${{ env.REGION }} || echo "âš ï¸ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç§»è¡Œå¤±æ•—"
                ;;
            esac
          else
            echo "ğŸ“‹ ãƒšãƒ¼ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼šãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯é…åˆ†ãªã—"
            # ãƒšãƒ¼ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰ã¯100%æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³
            gcloud run services update-traffic "$FULL_SERVICE_NAME" \
              --to-latest \
              --region=${{ env.REGION }}
          fi
          
          echo "âœ… Phase 12æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

      - name: Verify Deployment Health Check
        run: |
          echo "ğŸ¥ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          
          # ã‚µãƒ¼ãƒ“ã‚¹URLå–å¾—
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          
          echo "ğŸ“ ã‚µãƒ¼ãƒ“ã‚¹URL: ${SERVICE_URL}"
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç¶™æ‰¿ï¼‰
          for i in {1..5}; do
            echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è©¦è¡Œ $i/5"
            
            if curl -f -s "${SERVICE_URL}/health" --connect-timeout 10 --max-time 30; then
              echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼"
              
              # åŸºæœ¬å‹•ä½œç¢ºèª
              if curl -f -s "${SERVICE_URL}/" --connect-timeout 10 --max-time 30; then
                echo "âœ… åŸºæœ¬å‹•ä½œç¢ºèªæˆåŠŸï¼"
                echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ­£å¸¸ç¨¼åƒä¸­"
                exit 0
              else
                echo "âš ï¸ åŸºæœ¬å‹•ä½œç¢ºèªå¤±æ•—ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯æˆåŠŸï¼‰"
              fi
            else
              echo "â³ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ã€30ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤..."
              sleep 30
            fi
          done
          
          echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æœ€çµ‚å¤±æ•— - ãƒ‡ãƒ—ãƒ­ã‚¤ã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
          exit 1

      - name: Post-deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Phase 12ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼"
            echo "ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹: ${{ env.SERVICE_NAME }}"
            echo "ğŸ·ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸: ${{ github.sha }}"
            echo "ğŸŒ ãƒ¢ãƒ¼ãƒ‰: ${{ secrets.DEPLOY_MODE || 'paper' }}"
            echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸: 68.13% (316ãƒ†ã‚¹ãƒˆ)"
          else
            echo "âŒ Phase 12ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—"
            echo "ğŸ” ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi

# ========================================
# è¨­å®š
# ========================================

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã®æ•´åˆæ€§ç¢ºä¿ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true