# GCPãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# å¤ã„ãƒªã‚½ãƒ¼ã‚¹è‡ªå‹•å‰Šé™¤ãƒ»ã‚³ã‚¹ãƒˆ30%å‰Šæ¸›ãƒ»é‹ç”¨æœ€é©åŒ–ï¼ˆPhase 51.5-Eå®Œäº†ãƒ»Phase 52.4å“è³ªæ”¹å–„ï¼‰

name: GCP Resource Cleanup

on:
  # pushå®Ÿè¡Œé˜²æ­¢ï¼ˆGitHubå†…éƒ¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
  push:
    paths-ignore:
      - '**'  # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç„¡è¦–ï¼ˆpushæ™‚ã¯å®Ÿè¡Œã—ãªã„ï¼‰

  # æ‰‹å‹•å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
  workflow_dispatch:
    inputs:
      cleanup_level:
        description: 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«'
        required: true
        default: 'safe'
        type: choice
        options:
        - safe      # å®‰å…¨: å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ»ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®ã¿
        - moderate  # ä¸­ç¨‹åº¦: Safe + ãƒ“ãƒ«ãƒ‰å±¥æ­´ãƒ»ãƒ­ã‚°30æ—¥ä»¥ä¸Š
        - aggressive # ç©æ¥µçš„: å¤§é‡å‰Šé™¤ï¼ˆè¦æ³¨æ„ï¼‰

  # æœˆæ¬¡è‡ªå‹•å®Ÿè¡Œï¼ˆç¬¬1æ—¥æ›œæ—¥ JST 2:00 AMï¼‰
  schedule:
    - cron: '0 17 * * 0'  # UTC 17:00 = JST 02:00ï¼ˆæ—¥æ›œæ—¥ï¼‰

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  REPOSITORY: crypto-bot-repo
  WORKFLOW_TIMEOUT: 20
  IMAGE_RETENTION_COUNT: 5
  REVISION_RETENTION_COUNT: 3
  IMAGE_LIST_LIMIT: 100
  BUILD_RETENTION_DAYS: 30
  BUILD_DELETE_LIMIT: 50

jobs:
  cleanup-gcp-resources:
    name: GCP Resource Cleanup
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(env.WORKFLOW_TIMEOUT) }}
    
    # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿å®Ÿè¡Œï¼ˆå®‰å…¨æ€§ç¢ºä¿ï¼‰
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/11445303925/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deployer@my-crypto-bot-project.iam.gserviceaccount.com
          access_token_lifetime: 1800s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ§¹ Safe Cleanup - Artifact Registryå¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤
        run: |
          echo "ğŸ³ Artifact Registryå¤ã„Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
          
          # ç¾åœ¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§å–å¾—ï¼ˆæœ€æ–°${IMAGE_RETENTION_COUNT}å€‹ã‚’ä¿æŒï¼‰
          IMAGES=$(gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot \
            --sort-by=~CREATE_TIME \
            --format="value(version)" \
            --limit=${{ env.IMAGE_LIST_LIMIT }})

          # å‰Šé™¤å¯¾è±¡ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç‰¹å®šï¼ˆæœ€æ–°${IMAGE_RETENTION_COUNT}å€‹ä»¥å¤–ï¼‰
          DELETE_IMAGES=$(echo "$IMAGES" | tail -n +$((${{ env.IMAGE_RETENTION_COUNT }} + 1)))
          
          if [ -n "$DELETE_IMAGES" ]; then
            echo "ğŸ—‘ï¸ å‰Šé™¤å¯¾è±¡ã‚¤ãƒ¡ãƒ¼ã‚¸æ•°: $(echo "$DELETE_IMAGES" | wc -l)"
            
            for IMAGE_VERSION in $DELETE_IMAGES; do
              if [[ "$IMAGE_VERSION" != *"latest"* ]]; then
                echo "å‰Šé™¤ä¸­: crypto-bot:$IMAGE_VERSION"
                gcloud artifacts docker images delete \
                  ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot:$IMAGE_VERSION \
                  --quiet --delete-tags || echo "âš ï¸ å‰Šé™¤å¤±æ•—: $IMAGE_VERSION"
              fi
            done
            
            echo "âœ… å¤ã„Dockerã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤å®Œäº†"
          else
            echo "ğŸ“‹ å‰Šé™¤å¯¾è±¡ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã—ï¼ˆæœ€æ–°${{ env.IMAGE_RETENTION_COUNT }}å€‹ã®ã¿å­˜åœ¨ï¼‰"
          fi

      - name: ğŸ§¹ Safe Cleanup - å¤ã„Cloud Runãƒªãƒ“ã‚¸ãƒ§ãƒ³å‰Šé™¤
        if: github.event.inputs.cleanup_level == 'moderate' || github.event.inputs.cleanup_level == 'aggressive' || github.event_name == 'schedule'
        run: |
          echo "â˜ï¸ Cloud Runå¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
          
          # ç¾åœ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§
          SERVICES=$(gcloud run services list --region=${{ env.REGION }} --format="value(metadata.name)")
          
          for SERVICE in $SERVICES; do
            if [[ "$SERVICE" == *"crypto-bot-service"* ]]; then
              echo "ğŸ” ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª: $SERVICE"
              
              # å¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³å–å¾—ï¼ˆæœ€æ–°${REVISION_RETENTION_COUNT}å€‹ä»¥å¤–ï¼‰
              OLD_REVISIONS=$(gcloud run revisions list \
                --service="$SERVICE" \
                --region=${{ env.REGION }} \
                --format="value(metadata.name)" \
                --sort-by=~metadata.creationTimestamp \
                | tail -n +$((${{ env.REVISION_RETENTION_COUNT }} + 1)))
              
              if [ -n "$OLD_REVISIONS" ]; then
                echo "ğŸ—‘ï¸ å¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³å‰Šé™¤é–‹å§‹"
                for REVISION in $OLD_REVISIONS; do
                  echo "å‰Šé™¤ä¸­: $REVISION"
                  gcloud run revisions delete "$REVISION" \
                    --region=${{ env.REGION }} \
                    --quiet || echo "âš ï¸ å‰Šé™¤å¤±æ•—: $REVISION"
                done
              else
                echo "ğŸ“‹ å‰Šé™¤å¯¾è±¡ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãªã—"
              fi
            fi
          done

      - name: ğŸ§¹ Moderate Cleanup - Cloud Buildå±¥æ­´ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: github.event.inputs.cleanup_level == 'moderate' || github.event.inputs.cleanup_level == 'aggressive'
        run: |
          echo "ğŸ—ï¸ Cloud Buildå±¥æ­´ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
          
          # ${BUILD_RETENTION_DAYS}æ—¥ä»¥ä¸Šå¤ã„ãƒ“ãƒ«ãƒ‰ã‚’å–å¾—
          OLD_BUILDS=$(gcloud builds list \
            --filter="createTime<-P${{ env.BUILD_RETENTION_DAYS }}D" \
            --format="value(id)" \
            --limit=${{ env.BUILD_DELETE_LIMIT }})

          if [ -n "$OLD_BUILDS" ]; then
            echo "ğŸ—‘ï¸ ${{ env.BUILD_RETENTION_DAYS }}æ—¥ä»¥ä¸Šå¤ã„ãƒ“ãƒ«ãƒ‰å‰Šé™¤"
            for BUILD_ID in $OLD_BUILDS; do
              echo "å‰Šé™¤ä¸­: Build $BUILD_ID"
              gcloud builds delete "$BUILD_ID" --quiet || echo "âš ï¸ å‰Šé™¤å¤±æ•—: $BUILD_ID"
            done
          else
            echo "ğŸ“‹ å‰Šé™¤å¯¾è±¡ãƒ“ãƒ«ãƒ‰ãªã—"
          fi

      - name: ğŸ“Š ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
        if: always()
        run: |
          echo "ğŸ“Š === GCPãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚µãƒãƒªãƒ¼ ==="
          echo "å®Ÿè¡Œæ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«: ${{ github.event.inputs.cleanup_level || 'scheduled-safe' }}"

          echo ""
          echo "ğŸ³ ç¾åœ¨ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸æ•°:"
          gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot \
            --format="table(version,createTime)" \
            --limit=10 || echo "âš ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§å–å¾—å¤±æ•—"

          echo ""
          echo "â˜ï¸ ç¾åœ¨ã®Cloud Runã‚µãƒ¼ãƒ“ã‚¹:"
          gcloud run services list --region=${{ env.REGION }} \
            --format="table(metadata.name,status.url,status.conditions[0].lastTransitionTime)" \
            || echo "âš ï¸ ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§å–å¾—å¤±æ•—"

          echo ""
          echo "âœ… GCPãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

      - name: ğŸš¨ Aggressive Cleanupè­¦å‘Š
        if: github.event.inputs.cleanup_level == 'aggressive'
        run: |
          echo "âš ï¸ ========================================="
          echo "âš ï¸ è­¦å‘Š: Aggressiveã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"
          echo "âš ï¸ å¤§é‡ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          echo "âš ï¸ æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          echo "âš ï¸ ========================================="

# æ³¨æ„äº‹é …:
# 1. ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ‰‹å‹•å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™
# 2. aggressive ãƒ¬ãƒ™ãƒ«ã¯æ…é‡ã«ä½¿ç”¨ã—ã¦ãã ã•ã„
# 3. æœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
# 4. å®šæœŸå®Ÿè¡Œã¯æœˆ1å›ã®å®‰å…¨ãªå‰Šé™¤ã®ã¿ã§ã™ï¼ˆæ¯æœˆç¬¬1æ—¥æ›œæ—¥ JST 2:00 AMï¼‰
# 5. Phase 51.5-Eå®Œäº†ãƒ»Phase 52.4å“è³ªæ”¹å–„ç’°å¢ƒã§ã®å®Ÿè¡Œã‚’å‰æ