# GCPリソースクリーンアップワークフロー
# 古いリソース自動削除・コスト30%削減・運用最適化（Phase 53.1改善）
# - Dockerイメージ: SHA256ベース削除・--delete-tagsオプション追加
# - Cloud Runリビジョン: 最新3個保持
# - スケジュール: 毎月第1日曜日 JST 2:00 AM

name: GCP Resource Cleanup

on:
  # 手動実行のみ（安全性確保）
  workflow_dispatch:
    inputs:
      cleanup_level:
        description: 'クリーンアップレベル'
        required: true
        default: 'safe'
        type: choice
        options:
        - safe      # 安全: 古いイメージ・リビジョンのみ
        - moderate  # 中程度: Safe + ビルド履歴・ログ30日以上
        - aggressive # 積極的: 大量削除（要注意）

  # 月次自動実行（第1日曜日 JST 2:00 AM）
  schedule:
    - cron: '0 17 1-7 * 0'  # UTC 17:00 = JST 02:00（月の第1日曜日のみ）

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  REPOSITORY: crypto-bot-repo
  IMAGE_RETENTION_COUNT: 5
  REVISION_RETENTION_COUNT: 3
  IMAGE_LIST_LIMIT: 100
  BUILD_RETENTION_DAYS: 30
  BUILD_DELETE_LIMIT: 50

jobs:
  cleanup-gcp-resources:
    name: GCP Resource Cleanup
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # mainブランチのみ実行（安全性確保）
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/11445303925/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-deployer@my-crypto-bot-project.iam.gserviceaccount.com
          access_token_lifetime: 1800s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: 🧹 Safe Cleanup - Artifact Registry古いDockerイメージ削除
        run: |
          echo "🐳 Artifact Registry古いDockerイメージクリーンアップ"
          echo "保持数: 最新${{ env.IMAGE_RETENTION_COUNT }}個"

          # SHA256ダイジェストベースでイメージ一覧取得（最新順）
          DIGESTS=$(gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot \
            --sort-by=~CREATE_TIME \
            --format="value(digest)" \
            --limit=${{ env.IMAGE_LIST_LIMIT }} 2>/dev/null || echo "")

          if [ -z "$DIGESTS" ]; then
            echo "📋 イメージなし、スキップ"
            exit 0
          fi

          TOTAL_COUNT=$(echo "$DIGESTS" | wc -l | tr -d ' ')
          echo "📊 現在のイメージ総数: $TOTAL_COUNT"

          # 削除対象イメージを特定（最新N個以外）
          DELETE_DIGESTS=$(echo "$DIGESTS" | tail -n +$((${{ env.IMAGE_RETENTION_COUNT }} + 1)))

          if [ -n "$DELETE_DIGESTS" ]; then
            DELETE_COUNT=$(echo "$DELETE_DIGESTS" | wc -l | tr -d ' ')
            echo "🗑️ 削除対象イメージ数: $DELETE_COUNT"

            for DIGEST in $DELETE_DIGESTS; do
              echo "削除中: $DIGEST"
              gcloud artifacts docker images delete \
                "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot@$DIGEST" \
                --delete-tags --quiet || echo "⚠️ 削除失敗: $DIGEST"
            done

            echo "✅ 古いDockerイメージ削除完了（$DELETE_COUNT個）"
          else
            echo "📋 削除対象イメージなし（最新${{ env.IMAGE_RETENTION_COUNT }}個のみ存在）"
          fi

      - name: 🧹 Safe Cleanup - 古いCloud Runリビジョン削除
        if: github.event.inputs.cleanup_level == 'moderate' || github.event.inputs.cleanup_level == 'aggressive' || github.event_name == 'schedule'
        run: |
          echo "☁️ Cloud Run古いリビジョンクリーンアップ"

          # 現在のサービス一覧
          SERVICES=$(gcloud run services list --region=${{ env.REGION }} --format="value(metadata.name)" 2>/dev/null || echo "")

          if [ -z "$SERVICES" ]; then
            echo "📋 サービスなし、スキップ"
            exit 0
          fi

          for SERVICE in $SERVICES; do
            if [[ "$SERVICE" == *"crypto-bot-service"* ]]; then
              echo "🔍 サービス確認: $SERVICE"

              # 古いリビジョン取得（最新3個以外）
              OLD_REVISIONS=$(gcloud run revisions list \
                --service="$SERVICE" \
                --region=${{ env.REGION }} \
                --format="value(metadata.name)" \
                --sort-by=~metadata.creationTimestamp 2>/dev/null \
                | tail -n +$((${{ env.REVISION_RETENTION_COUNT }} + 1)) || echo "")

              if [ -n "$OLD_REVISIONS" ]; then
                echo "🗑️ 古いリビジョン削除開始"
                for REVISION in $OLD_REVISIONS; do
                  echo "削除中: $REVISION"
                  gcloud run revisions delete "$REVISION" \
                    --region=${{ env.REGION }} \
                    --quiet || echo "⚠️ 削除失敗: $REVISION"
                done
              else
                echo "📋 削除対象リビジョンなし"
              fi
            fi
          done

      - name: 🧹 Moderate Cleanup - Cloud Build履歴クリーンアップ
        if: github.event.inputs.cleanup_level == 'moderate' || github.event.inputs.cleanup_level == 'aggressive'
        run: |
          echo "🏗️ Cloud Build履歴クリーンアップ"

          # 30日以上古いビルドを取得
          OLD_BUILDS=$(gcloud builds list \
            --filter="createTime<-P${{ env.BUILD_RETENTION_DAYS }}D" \
            --format="value(id)" \
            --limit=${{ env.BUILD_DELETE_LIMIT }} 2>/dev/null || echo "")

          if [ -n "$OLD_BUILDS" ]; then
            echo "🗑️ ${{ env.BUILD_RETENTION_DAYS }}日以上古いビルド削除"
            for BUILD_ID in $OLD_BUILDS; do
              echo "削除中: Build $BUILD_ID"
              gcloud builds delete "$BUILD_ID" --quiet || echo "⚠️ 削除失敗: $BUILD_ID"
            done
          else
            echo "📋 削除対象ビルドなし"
          fi

      - name: 📊 クリーンアップサマリー生成
        if: always()
        run: |
          echo "📊 === GCPリソースクリーンアップサマリー ==="
          echo "実行時間: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "クリーンアップレベル: ${{ github.event.inputs.cleanup_level || 'scheduled-safe' }}"

          echo ""
          echo "🐳 現在のDockerイメージ数:"
          gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/crypto-bot \
            --format="table(version,createTime)" \
            --limit=10 2>/dev/null || echo "⚠️ イメージ一覧取得失敗"

          echo ""
          echo "☁️ 現在のCloud Runサービス:"
          gcloud run services list --region=${{ env.REGION }} \
            --format="table(metadata.name,status.url)" 2>/dev/null \
            || echo "⚠️ サービス一覧取得失敗"

          echo ""
          echo "✅ GCPリソースクリーンアップ完了"

      - name: 🚨 Aggressive Cleanup警告
        if: github.event.inputs.cleanup_level == 'aggressive'
        run: |
          echo "⚠️ ========================================="
          echo "⚠️ 警告: Aggressiveクリーンアップが実行されました"
          echo "⚠️ 大量のリソースが削除された可能性があります"
          echo "⚠️ 本番環境への影響を確認してください"
          echo "⚠️ ========================================="

# 注意事項:
# 1. このワークフローは手動実行またはスケジュール実行のみ
# 2. pushイベントでは起動しません（安全性確保）
# 3. aggressive レベルは慎重に使用してください
# 4. 定期実行は月1回の安全な削除のみです（毎月第1日曜日 JST 2:00 AM）
# 5. Phase 53.1改善: SHA256ダイジェストベース削除・--delete-tags追加
