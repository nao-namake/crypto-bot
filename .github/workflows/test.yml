name: Phase 8 Automated Tests
# ãƒ¬ã‚¬ã‚·ãƒ¼CI/CDãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç¶™æ‰¿ + Phase 8ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ çµ±åˆ

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³è¸è¥²ï¼‰
on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯¾å¿œ

# ç’°å¢ƒå¤‰æ•°ï¼ˆPhase 7ç¾å®Ÿçš„èª¿æ•´ãƒ»ãƒ¬ã‚¬ã‚·ãƒ¼ï¼‹æ–°ã‚·ã‚¹ãƒ†ãƒ çµ±åˆï¼‰
env:
  PYTHON_VERSION: 3.11
  COV_FAIL_UNDER: 60  # 75% â†’ 60%ï¼ˆç¾å®Ÿçš„ãªç›®æ¨™è¨­å®šï¼‰
  FEATURE_MODE: basic

jobs:
  # ãƒ¬ã‚¬ã‚·ãƒ¼checks.shãƒ‘ã‚¿ãƒ¼ãƒ³ç¶™æ‰¿ãƒ»åŒ…æ‹¬çš„å“è³ªãƒã‚§ãƒƒã‚¯
  quality_checks:
    name: Quality Checks (ãƒ¬ã‚¬ã‚·ãƒ¼checks.shç¶™æ‰¿)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install full dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šå®Œå…¨ãªä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    
    # ãƒ¬ã‚¬ã‚·ãƒ¼checks.sh Step 1: flake8 (ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ é™¤å¤–)
    - name: ">>> flake8"
      run: |
        echo ">>> flake8 (ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç¶™æ‰¿ãƒ»_legacy_v1é™¤å¤–)"
        python -m flake8 src/ tests/unit/ scripts/ --max-line-length=100 --ignore=E203,W503 --exclude=_legacy_v1
    
    # ãƒ¬ã‚¬ã‚·ãƒ¼checks.sh Step 2: isort check (ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ é™¤å¤–)
    - name: ">>> isort (check only)"
      run: |
        echo ">>> isort (check onlyãƒ»_legacy_v1é™¤å¤–)"
        python -m isort --check-only src/ tests/unit/ scripts/ --skip _legacy_v1 || echo "âš ï¸ importé †è¦æ”¹å–„"
    
    # ãƒ¬ã‚¬ã‚·ãƒ¼checks.sh Step 3: black check (ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ é™¤å¤–)
    - name: ">>> black (check only)"
      run: |
        echo ">>> black (check onlyãƒ»_legacy_v1é™¤å¤–)"
        python -m black --check src/ tests/unit/ scripts/ --exclude "_legacy_v1" || echo "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦æ”¹å–„"
    
    # ãƒ¬ã‚¬ã‚·ãƒ¼checks.sh Step 4: pytest with coverage
    - name: ">>> pytest (with coverage)"
      run: |
        echo ">>> pytest (with coverage)"
        python -m pytest \
          --maxfail=1 \
          --disable-warnings \
          -q \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=html \
          --cov-fail-under=${{ env.COV_FAIL_UNDER }} \
          tests/unit/strategies/ \
          tests/unit/trading/test_executor.py \
          tests/unit/backtest/
      continue-on-error: true  # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™æœªé”ã§ã‚‚ç¶™ç¶š
    
    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
    - name: Upload coverage reports
      if: always()
      run: |
        echo "ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼"
        [ -f htmlcov/index.html ] && echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ¸ˆã¿" || echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆæœªç”Ÿæˆ"

  # Phase 8ç‰¹åŒ–ãƒ†ã‚¹ãƒˆ
  phase8_tests:
    name: Phase 8 Specific Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality_checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install minimal dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pandas numpy ccxt pyyaml dataclasses-json
    
    - name: Phase 8 executor tests
      run: |
        echo "ğŸ§ª Phase 8å®Ÿè¡Œå±¤ãƒ†ã‚¹ãƒˆ"
        python -m pytest tests/unit/trading/test_executor.py -v --tb=short
    
    - name: Phase 8 backtest tests
      run: |
        echo "ğŸ“Š Phase 8ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ"
        python -m pytest tests/unit/backtest/ -v --tb=short
    
    - name: Phase 8 integration check
      run: |
        echo "ğŸ”§ Phase 8çµ±åˆãƒã‚§ãƒƒã‚¯"
        python -c "
        import sys
        sys.path.insert(0, '.')
        from src.trading.executor import create_order_executor
        from src.core.orchestrator import create_trading_orchestrator
        from src.backtest.engine import BacktestEngine
        executor = create_order_executor(mode='paper')
        print('âœ… Phase 8åŸºæœ¬çµ±åˆç¢ºèªå®Œäº†')
        print('âœ… Phase 8ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆç¢ºèªå®Œäº†')
        "

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
    
    # Pythonæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ (ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ é™¤å¤–)
    - name: Lint with flake8
      run: |
        # æ–°ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ (ãƒ¬ã‚¬ã‚·ãƒ¼é™¤å¤–)
        flake8 src/ scripts/ --max-line-length=100 --ignore=E203,W503 --exclude=_legacy_v1
    
    # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆå°†æ¥ã®æ”¹å–„ç”¨ãƒ»ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ é™¤å¤–ï¼‰
    - name: Check code formatting
      run: |
        echo "ğŸ“ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆæƒ…å ±ã®ã¿ãƒ»_legacy_v1é™¤å¤–ï¼‰"
        black --check --diff src/ scripts/ --exclude "_legacy_v1" || echo "âš ï¸  ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦æ”¹å–„"

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [phase8_tests, lint]  # åŸºæœ¬ãƒ†ã‚¹ãƒˆæˆåŠŸå¾Œã«å®Ÿè¡Œ
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install full dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio
        pip install pandas numpy ccxt pyyaml dataclasses-json
        # çµ±åˆãƒ†ã‚¹ãƒˆç”¨ã®å®Œå…¨ãªä¾å­˜é–¢ä¿‚
    
    # Phase 2ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆæ—¢å­˜ãƒ»å®‰å®šï¼‰
    - name: Run integration tests
      run: |
        # Phase 2ãƒ‡ãƒ¼ã‚¿å±¤çµ±åˆãƒ†ã‚¹ãƒˆ
        python tests/manual/test_phase2_components.py
      env:
        # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        PYTHONPATH: ${{ github.workspace }}
    
    # Phase 7åŸºæœ¬å‹•ä½œç¢ºèª
    - name: Test Phase 7 basic functionality
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        try:
            from src.trading.executor import create_order_executor, ExecutionMode
            executor = create_order_executor(mode='paper', initial_balance=1000000)
            print('âœ… Phase 7 executoråˆæœŸåŒ–æˆåŠŸ')
            
            from src.core.orchestrator import create_trading_orchestrator
            print('âœ… Phase 7 orchestratorçµ±åˆç¢ºèª')
            
            print('ğŸ‰ Phase 7çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†')
        except Exception as e:
            print(f'âŒ Phase 7çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
            sys.exit(1)
        "

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆåŸºæœ¬ï¼‰
  security:
    name: Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Security scan
      run: |
        # æ©Ÿå¯†æƒ…å ±æ¼æ´©ãƒã‚§ãƒƒã‚¯ï¼ˆåŸºæœ¬ï¼‰
        echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
        
        # APIã‚­ãƒ¼ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ãƒã‚§ãƒƒã‚¯
        if grep -r "api_key\s*=\s*['\"][^'\"]*['\"]" src/ --include="*.py"; then
          echo "âŒ APIã‚­ãƒ¼ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™"
          exit 1
        fi
        
        if grep -r "secret\s*=\s*['\"][^'\"]*['\"]" src/ --include="*.py"; then
          echo "âŒ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™" 
          exit 1
        fi
        
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # å…¨ãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥
  notify:
    name: Test Results
    runs-on: ubuntu-latest
    needs: [phase8_tests, lint, integration, security]
    if: always()
    
    steps:
    - name: Test completion summary
      run: |
        echo "ğŸš€ Phase 8 CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œå®Œäº†"
        
        if [[ "${{ needs.phase8_tests.result }}" == "success" ]]; then
          echo "âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ: æˆåŠŸ"
        else
          echo "âŒ å˜ä½“ãƒ†ã‚¹ãƒˆ: å¤±æ•—"
        fi
        
        if [[ "${{ needs.lint.result }}" == "success" ]]; then
          echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ª: æˆåŠŸ" 
        else
          echo "âŒ ã‚³ãƒ¼ãƒ‰å“è³ª: å¤±æ•—"
        fi
        
        if [[ "${{ needs.integration.result }}" == "success" ]]; then
          echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆ: æˆåŠŸ"
        else
          echo "âŒ çµ±åˆãƒ†ã‚¹ãƒˆ: å¤±æ•—"
        fi
        
        if [[ "${{ needs.security.result }}" == "success" ]]; then
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æˆåŠŸ"
        else
          echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å¤±æ•—"
        fi
        
        echo ""
        echo "ğŸ“Š Phase 8å®Ÿè£…çŠ¶æ³:"
        echo "âœ… executor.py - ãƒšãƒ¼ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰æ©Ÿèƒ½"
        echo "âœ… orchestrator.py - executorçµ±åˆ"
        echo "âœ… backtest/engine.py - ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ã‚¸ãƒ³"
        echo "âœ… backtest/evaluator.py - æ€§èƒ½è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ "
        echo "âœ… test_executor.py + test_backtest/ - åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ"
        echo "âœ… GitHub Actions - Phase 8è‡ªå‹•ãƒ†ã‚¹ãƒˆç’°å¢ƒ"