# Phase 12: 24æ™‚é–“ç›£è¦–ãƒ»ç¶™ç¶šçš„ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# 
# ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã®è‰¯ã„éƒ¨åˆ†ã‚’ç¶™æ‰¿ãƒ»æ”¹è‰¯
# signal_monitor.pyãƒ»ops_monitor.pyãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•ç›£è¦–
# 
# æ©Ÿèƒ½:
# - 24æ™‚é–“ç¶™ç¶šç›£è¦–
# - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¿½è·¡
# - ç•°å¸¸æ¤œçŸ¥ãƒ»è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆ
# - å–å¼•æˆæœåˆ†æ

name: 24æ™‚é–“ç›£è¦–ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

on:
  schedule:
    # 15åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆ24æ™‚é–“ç›£è¦–ï¼‰
    - cron: '*/15 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:
    inputs:
      monitoring_duration:
        description: 'ç›£è¦–ç¶™ç¶šæ™‚é–“ï¼ˆåˆ†ï¼‰'
        required: false
        default: '60'
        type: string
      check_type:
        description: 'ç›£è¦–ã‚¿ã‚¤ãƒ—'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - health-only
          - performance-only
          - trading-only

env:
  PROJECT_ID: my-crypto-bot-project
  REGION: asia-northeast1
  SERVICE_NAME: crypto-bot-service

jobs:
  # ========================================
  # 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  # ========================================
  health-check:
    name: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    outputs:
      service-status: ${{ steps.health.outputs.status }}
      response-time: ${{ steps.health.outputs.response_time }}
      error-count: ${{ steps.health.outputs.error_count }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install monitoring dependencies
        run: |
          pip install requests pandas numpy aiohttp

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          access_token_lifetime: 600s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        id: health
        run: |
          echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–‹å§‹"
          
          # Cloud Runã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç¢ºèª
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)' 2>/dev/null || echo "")
          
          if [ -z "$SERVICE_URL" ]; then
            echo "âŒ Cloud Runã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "status=DOWN" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ğŸ“ ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
          
          # ãƒ˜ãƒ«ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ç‰ˆï¼‰
          start_time=$(date +%s%3N)
          
          if curl -f -s --max-time 10 "$SERVICE_URL/health" > /tmp/health_response.json; then
            end_time=$(date +%s%3N)
            response_time=$((end_time - start_time))
            
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
            echo "status=UP" >> $GITHUB_OUTPUT
            echo "response_time=${response_time}ms" >> $GITHUB_OUTPUT
            
            # ãƒ˜ãƒ«ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°ç¢ºèª
            if [ -f "/tmp/health_response.json" ]; then
              echo "ğŸ“Š ãƒ˜ãƒ«ã‚¹è©³ç´°:"
              cat /tmp/health_response.json | jq '.' 2>/dev/null || cat /tmp/health_response.json
            fi
            
          else
            echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
            echo "status=DOWN" >> $GITHUB_OUTPUT
            echo "response_time=timeout" >> $GITHUB_OUTPUT
          fi

      - name: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åˆ†æï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼error_analyzer.pyæ”¹è‰¯ç‰ˆï¼‰
        run: |
          echo "ğŸ” ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åˆ†æé–‹å§‹"
          
          # éå»15åˆ†ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å–å¾—
          gcloud logging read \
            "resource.type=\"cloud_run_revision\" AND \
             resource.labels.service_name=\"${{ env.SERVICE_NAME }}\" AND \
             severity >= ERROR AND \
             timestamp >= \"$(date -u -d '15 minutes ago' +%Y-%m-%dT%H:%M:%SZ)\"" \
            --limit=50 \
            --format="json" > /tmp/error_logs.json
          
          error_count=$(cat /tmp/error_logs.json | jq '. | length')
          echo "error_count=$error_count" >> $GITHUB_OUTPUT
          
          if [ "$error_count" -gt 0 ]; then
            echo "âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ¤œå‡º: $error_count ä»¶"
            echo "ğŸ“‹ æœ€æ–°ã‚¨ãƒ©ãƒ¼:"
            cat /tmp/error_logs.json | jq -r '.[0:3][] | .textPayload // .jsonPayload.message // "No message"' | head -10
          else
            echo "âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—"
          fi

  # ========================================
  # 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  # ========================================
  performance-monitoring:
    name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.service-status == 'UP'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç›£è¦–ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼æ”¹è‰¯ç‰ˆï¼‰
        run: |
          echo "ğŸ“Š ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç›£è¦–é–‹å§‹"
          
          # CPUãƒ»ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡å–å¾—ï¼ˆéå»15åˆ†ï¼‰
          gcloud monitoring metrics list \
            --filter="metric.type:run.googleapis.com/container/cpu/utilizations" \
            --format="value(displayName)" | head -5
          
          # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
          echo "ğŸ’¾ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–"
          gcloud logging read \
            "resource.type=\"cloud_run_revision\" AND \
             resource.labels.service_name=\"${{ env.SERVICE_NAME }}\" AND \
             jsonPayload.message~\"Memory\" AND \
             timestamp >= \"$(date -u -d '15 minutes ago' +%Y-%m-%dT%H:%M:%SZ)\"" \
            --limit=10 || echo "ãƒ¡ãƒ¢ãƒªæƒ…å ±å–å¾—ä¸å¯"

      - name: APIå¿œç­”æ™‚é–“ç›£è¦–
        run: |
          echo "â±ï¸ APIå¿œç­”æ™‚é–“ç›£è¦–"
          
          # ã‚µãƒ¼ãƒ“ã‚¹URLå–å¾—
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          
          # è¤‡æ•°å›ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
          total_time=0
          success_count=0
          
          for i in {1..5}; do
            echo "æ¸¬å®š $i/5..."
            start_time=$(date +%s%3N)
            
            if curl -f -s --max-time 5 "$SERVICE_URL/health" > /dev/null; then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              echo "  å¿œç­”æ™‚é–“: ${response_time}ms"
              total_time=$((total_time + response_time))
              success_count=$((success_count + 1))
            else
              echo "  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ã‚¨ãƒ©ãƒ¼"
            fi
            
            sleep 2
          done
          
          if [ $success_count -gt 0 ]; then
            avg_time=$((total_time / success_count))
            echo "ğŸ“ˆ å¹³å‡å¿œç­”æ™‚é–“: ${avg_time}ms (æˆåŠŸç‡: $success_count/5)"
            
            # é–¾å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆ3ç§’ = 3000msï¼‰
            if [ $avg_time -gt 3000 ]; then
              echo "âš ï¸ å¿œç­”æ™‚é–“ãŒé–¾å€¤è¶…é: ${avg_time}ms > 3000ms"
            else
              echo "âœ… å¿œç­”æ™‚é–“æ­£å¸¸"
            fi
          else
            echo "âŒ å…¨æ¸¬å®šå¤±æ•—"
          fi

  # ========================================
  # 3. å–å¼•ç›£è¦–ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼signal_monitor.pyæ”¹è‰¯ç‰ˆï¼‰
  # ========================================
  trading-monitoring:
    name: å–å¼•ãƒ»ã‚·ã‚°ãƒŠãƒ«ç›£è¦–
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.service-status == 'UP'
    
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: å–å¼•æ´»å‹•ç›£è¦–
        run: |
          echo "ğŸ’¼ å–å¼•æ´»å‹•ç›£è¦–é–‹å§‹"
          
          # å–å¼•ãƒ­ã‚°å–å¾—ï¼ˆéå»1æ™‚é–“ï¼‰
          gcloud logging read \
            "resource.type=\"cloud_run_revision\" AND \
             resource.labels.service_name=\"${{ env.SERVICE_NAME }}\" AND \
             (jsonPayload.message~\"æ³¨æ–‡\" OR jsonPayload.message~\"å–å¼•\" OR jsonPayload.message~\"SIGNAL\") AND \
             timestamp >= \"$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)\"" \
            --limit=20 \
            --format="json" > /tmp/trading_logs.json
          
          trade_count=$(cat /tmp/trading_logs.json | jq '. | length')
          echo "ğŸ“Š å–å¼•é–¢é€£ãƒ­ã‚°æ•°: $trade_count ä»¶"
          
          if [ "$trade_count" -gt 0 ]; then
            echo "ğŸ“‹ æœ€æ–°å–å¼•æ´»å‹•:"
            cat /tmp/trading_logs.json | jq -r '.[0:5][] | "\(.timestamp): \(.textPayload // .jsonPayload.message // "No message")"' | head -10
          else
            echo "âš ï¸ å–å¼•æ´»å‹•ãªã—ï¼ˆ1æ™‚é–“ä»¥å†…ï¼‰"
          fi

      - name: ã‚·ã‚°ãƒŠãƒ«ç”ŸæˆçŠ¶æ³ç¢ºèª
        run: |
          echo "ğŸ“¡ ã‚·ã‚°ãƒŠãƒ«ç”ŸæˆçŠ¶æ³ç¢ºèª"
          
          # ã‚·ã‚°ãƒŠãƒ«é–¢é€£ãƒ­ã‚°å–å¾—
          gcloud logging read \
            "resource.type=\"cloud_run_revision\" AND \
             resource.labels.service_name=\"${{ env.SERVICE_NAME }}\" AND \
             (jsonPayload.message~\"SIGNAL\" OR jsonPayload.message~\"BUY\" OR jsonPayload.message~\"SELL\" OR jsonPayload.message~\"HOLD\") AND \
             timestamp >= \"$(date -u -d '30 minutes ago' +%Y-%m-%dT%H:%M:%SZ)\"" \
            --limit=10 \
            --format="json" > /tmp/signal_logs.json
          
          signal_count=$(cat /tmp/signal_logs.json | jq '. | length')
          echo "ğŸ“Š ã‚·ã‚°ãƒŠãƒ«æ•°: $signal_count ä»¶ï¼ˆ30åˆ†ä»¥å†…ï¼‰"
          
          if [ "$signal_count" -eq 0 ]; then
            echo "âš ï¸ ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆåœæ­¢ã®å¯èƒ½æ€§"
          else
            echo "âœ… ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆæ­£å¸¸"
            echo "ğŸ“‹ æœ€æ–°ã‚·ã‚°ãƒŠãƒ«:"
            cat /tmp/signal_logs.json | jq -r '.[0:3][] | "\(.timestamp): \(.textPayload // .jsonPayload.message // "No message")"'
          fi

  # ========================================
  # 4. ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»é€šçŸ¥
  # ========================================
  monitoring-report:
    name: ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆãƒ»é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, trading-monitoring]
    if: always()
    
    steps:
      - name: ç›£è¦–çµæœã‚µãƒãƒªãƒ¼ç”Ÿæˆ
        run: |
          echo "ğŸ“‹ 24æ™‚é–“ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
          echo "=================================================="
          echo "å®Ÿè¡Œæ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================================="
          echo ""
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ
          echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹:"
          echo "  çŠ¶æ…‹: ${{ needs.health-check.outputs.service-status || 'UNKNOWN' }}"
          echo "  å¿œç­”æ™‚é–“: ${{ needs.health-check.outputs.response-time || 'N/A' }}"
          echo "  ã‚¨ãƒ©ãƒ¼æ•°: ${{ needs.health-check.outputs.error-count || 'N/A' }}"
          echo ""
          
          # å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          overall_status="OK"
          
          if [ "${{ needs.health-check.outputs.service-status }}" != "UP" ]; then
            overall_status="CRITICAL"
            echo "âŒ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«: ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢"
          elif [ "${{ needs.health-check.outputs.error-count }}" -gt 5 ]; then
            overall_status="WARNING"
            echo "âš ï¸ è­¦å‘Š: ã‚¨ãƒ©ãƒ¼å¤šç™º"
          elif [ "${{ needs.health-check.result }}" != "success" ]; then
            overall_status="WARNING"
            echo "âš ï¸ è­¦å‘Š: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç•°å¸¸"
          else
            echo "âœ… ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸"
          fi
          
          echo ""
          echo "ğŸ“Š ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $overall_status"
          echo "=================================================="
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          case "$overall_status" in
            "CRITICAL")
              echo "ğŸš¨ ç·Šæ€¥å¯¾å¿œãŒå¿…è¦:"
              echo "  1. ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª: gcloud run services describe ${{ env.SERVICE_NAME }}"
              echo "  2. ãƒ­ã‚°ç¢ºèª: gcloud logging read"
              echo "  3. å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ"
              ;;
            "WARNING")
              echo "âš ï¸ æ³¨æ„ãŒå¿…è¦:"
              echo "  1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è©³ç´°ç¢ºèª"
              echo "  2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ç¢ºèª"
              echo "  3. æ¬¡å›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ä¿®æ­£æ¤œè¨"
              ;;
            "OK")
              echo "âœ… æ­£å¸¸ç¨¼åƒä¸­ - ç¶™ç¶šç›£è¦–"
              ;;
          esac

      - name: Discordé€šçŸ¥ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«æ™‚ã®ã¿ï¼‰
        if: needs.health-check.outputs.service-status != 'UP'
        run: |
          echo "ğŸ“¢ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«çŠ¶æ³ã®Discordé€šçŸ¥"
          echo "ï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯ã€Secret Managerã‹ã‚‰Webhook URLã‚’å–å¾—ã—ã¦Discordé€šçŸ¥ï¼‰"
          echo "ğŸš¨ Phase 12ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆ"
          echo "çŠ¶æ…‹: ${{ needs.health-check.outputs.service-status }}"
          echo "æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"

# ========================================
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š
# ========================================

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼ˆç›£è¦–ã®é‡è¤‡å®Ÿè¡Œé˜²æ­¢ï¼‰
concurrency:
  group: monitoring-${{ github.ref }}
  cancel-in-progress: false  # ç›£è¦–ã¯ç¶™ç¶šå®Ÿè¡Œ

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
defaults:
  run:
    timeout-minutes: 10