# infra/ - Terraform Infrastructure Configuration

## ğŸ—ï¸ æ¦‚è¦

**ğŸŠ Phase 19å®Œå…¨é”æˆ: å€‹äººé–‹ç™ºå‘ã‘å®‰å®šåŒ–ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†**  
crypto-bot ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’Terraformã§ç®¡ç†ã—ã¾ã™ã€‚**CI/CDç¶™ç¶šå¤±æ•—å•é¡Œã‚’æ ¹æœ¬è§£æ±º**ã—ã€å€‹äººé–‹ç™ºã«æœ€é©åŒ–ã—ãŸç¢ºå®Ÿã§å …ç‰¢ãªæ§‹æˆã§ã€é–‹ç™ºç’°å¢ƒï¼ˆPaper Modeï¼‰ã¨æœ¬ç•ªç’°å¢ƒï¼ˆLive Tradingï¼‰ã®2ç’°å¢ƒã‚’å®‰å®šç®¡ç†ã—ã¾ã™ã€‚

## ğŸ¯ è¨­è¨ˆæ–¹é‡ï¼ˆPhase 19å®‰å®šåŒ–ï¼‰

### **ç¢ºå®Ÿæ€§ã¨ã‚·ãƒ³ãƒ—ãƒ«ã•ã®ä¸¡ç«‹**
- **2ç’°å¢ƒã®ã¿**: devï¼ˆPaper Modeï¼‰ã¨prodï¼ˆLive Tradingï¼‰
- **Static Environment Variables**: dynamicæ§‹æ–‡æ’é™¤ã€ç¢ºå®Ÿæ€§é‡è¦–
- **Provider Versionæ•´åˆ**: CIç’°å¢ƒã¨ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼ã®å®Œå…¨ä¸€è‡´
- **ä½ã‚³ã‚¹ãƒˆé‹ç”¨**: å€‹äººé–‹ç™ºã«é©ã—ãŸãƒªã‚½ãƒ¼ã‚¹è¨­å®šï¼ˆæœˆé¡2,200å††ï¼‰

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
infra/
â”œâ”€â”€ envs/
â”‚   â”œâ”€â”€ dev/    # é–‹ç™ºç’°å¢ƒï¼ˆPaper Modeï¼‰
â”‚   â”‚   â”œâ”€â”€ main.tf          # ç’°å¢ƒè¨­å®š
â”‚   â”‚   â”œâ”€â”€ variables.tf     # å¤‰æ•°å®šç¾©
â”‚   â”‚   â”œâ”€â”€ backend.tf       # TerraformçŠ¶æ…‹ç®¡ç†
â”‚   â”‚   â””â”€â”€ terraform.tfvars # ç’°å¢ƒå›ºæœ‰ã®å€¤
â”‚   â”‚
â”‚   â””â”€â”€ prod/   # æœ¬ç•ªç’°å¢ƒï¼ˆLive Tradingï¼‰
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â”œâ”€â”€ backend.tf
â”‚       â””â”€â”€ terraform.tfvars
â”‚
â””â”€â”€ modules/
    â”œâ”€â”€ crypto_bot_app/     # Cloud Runã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    â”œâ”€â”€ monitoring/         # åŸºæœ¬çš„ãªç›£è¦–è¨­å®š
    â”œâ”€â”€ project_services/   # GCP APIæœ‰åŠ¹åŒ–
    â””â”€â”€ workload_identity/  # GitHub Actionsèªè¨¼
```

## ğŸš€ ç’°å¢ƒåˆ¥è¨­å®š

### **devç’°å¢ƒï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰**
- **ç”¨é€”**: é–‹ç™ºã€ãƒ†ã‚¹ãƒˆã€Paper Modeã§ã®å‹•ä½œç¢ºèª
- **ãƒªã‚½ãƒ¼ã‚¹**: CPU 500mã€Memory 1Giï¼ˆPhase 19é©æ­£ã‚µã‚¤ã‚ºèª¿æ•´ï¼‰
- **APIã‚­ãƒ¼**: static env varsï¼ˆç©ºæ–‡å­—åˆ—ã§ã‚‚å®‰å®šå‹•ä½œï¼‰
- **ã‚³ã‚¹ãƒˆ**: ç´„400å††/æœˆ

### **prodç’°å¢ƒï¼ˆæœ¬ç•ªç¨¼åƒç”¨ï¼‰**
- **ç”¨é€”**: Bitbankå®Ÿå£åº§ã§ã®è‡ªå‹•å–å¼•
- **ãƒªã‚½ãƒ¼ã‚¹**: CPU 1000mã€Memory 2Giï¼ˆ97ç‰¹å¾´é‡æœ€é©åŒ–æ¸ˆã¿ï¼‰
- **APIã‚­ãƒ¼**: Bitbank API - static env varsæ¡ç”¨ã§ç¢ºå®Ÿè¨­å®š
- **ã‚³ã‚¹ãƒˆ**: ç´„1,800å††/æœˆ

## âš™ï¸ ä½¿ç”¨æ–¹æ³•

### **åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

1. **GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™**
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç¢ºèª
gcloud config get-value project

# å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–ï¼ˆTerraformãŒè‡ªå‹•ã§è¡Œã†ãŒã€å¿µã®ãŸã‚ï¼‰
gcloud services enable run.googleapis.com
gcloud services enable artifactregistry.googleapis.com
```

2. **TerraformåˆæœŸåŒ–**
```bash
# ç’°å¢ƒã‚’é¸æŠï¼ˆdev or prodï¼‰
cd infra/envs/dev/  # ã¾ãŸã¯ prod/

# åˆæœŸåŒ–
terraform init
```

### **ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †**

#### **é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
```bash
cd infra/envs/dev/
terraform plan
terraform apply
```

#### **æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
```bash
cd infra/envs/prod/
terraform plan
terraform apply
```

### **ğŸŠ Phase 19å¯¾å¿œ: ç’°å¢ƒå¤‰æ•°è¨­å®š**

#### **é–‹ç™ºç’°å¢ƒï¼ˆdev/terraform.tfvarsï¼‰**
```hcl
project_id             = "my-crypto-bot-project"
region                 = "asia-northeast1"
artifact_registry_repo = "crypto-bot-repo"
service_name           = "crypto-bot-dev"
image_name             = "crypto-bot"
mode                   = "paper"
alert_email            = "your-email@example.com"
github_repo            = "your-github-username/crypto-bot"
project_number         = "123456789"
deployer_sa            = "github-deployer@my-crypto-bot-project.iam.gserviceaccount.com"
# Phase 19: static env vars - ç©ºæ–‡å­—åˆ—ã§ã‚‚å®‰å®šå‹•ä½œ
bitbank_api_key        = ""
bitbank_api_secret     = ""
```

#### **æœ¬ç•ªç’°å¢ƒï¼ˆprod/terraform.tfvarsï¼‰**
```hcl
project_id     = "my-crypto-bot-project"
region         = "asia-northeast1"
service_name   = "crypto-bot-service-prod"
mode           = "live"
# Phase 19: static env vars - GitHub Secretsã‹ã‚‰ç¢ºå®Ÿè¨­å®š
# bitbank_api_key/bitbank_api_secret ã¯CI/CDã§è‡ªå‹•æ³¨å…¥
```

## ğŸ”’ Phase 19ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

### **ğŸŠ Static Environment Variablesæ¡ç”¨**
- **å‹•çš„æ§‹æ–‡æ’é™¤**: è¤‡é›‘ãªdynamic for_eachâ†’ã‚·ãƒ³ãƒ—ãƒ«static env vars
- **Provider Versionéä¾å­˜**: Google Provider v5.x/v6.xå•ã‚ãšå®‰å®šå‹•ä½œ
- **ç¢ºå®Ÿæ€§é‡è¦–**: ç©ºæ–‡å­—åˆ—ã§ã‚‚æ­£å¸¸å‹•ä½œã€ã‚¨ãƒ©ãƒ¼è¦å› é™¤å»

### **APIã‚­ãƒ¼ç®¡ç†**
- **é–‹ç™ºç’°å¢ƒ**: APIã‚­ãƒ¼ä¸è¦ï¼ˆPaper Modeï¼‰
- **æœ¬ç•ªç’°å¢ƒ**: GitHub Secretsã§ç®¡ç†
- **ãƒ­ãƒ¼ã‚«ãƒ«**: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ï¼ˆ.gitignoreå¿…é ˆï¼‰

### **èªè¨¼**
- **Workload Identity Federation**: ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ã‚¹ã§GCPã«ã‚¢ã‚¯ã‚»ã‚¹
- **æœ€å°æ¨©é™ã®åŸå‰‡**: å¿…è¦æœ€å°é™ã®IAMæ¨©é™ã®ã¿ä»˜ä¸

## ğŸ“Š ã‚³ã‚¹ãƒˆæœ€é©åŒ–

### **æœˆé¡ã‚³ã‚¹ãƒˆç›®å®‰**
| ç’°å¢ƒ | CPU | Memory | æ¨å®šã‚³ã‚¹ãƒˆ |
|------|-----|--------|-----------|
| dev  | 250m | 512Mi | ~200å††/æœˆ  |
| prod | 1000m | 2Gi  | ~2,000å††/æœˆ |
| **åˆè¨ˆ** | - | - | **~2,200å††/æœˆ** |

### **ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãƒ’ãƒ³ãƒˆ**
1. é–‹ç™ºæ™‚ä»¥å¤–ã¯devç’°å¢ƒã‚’åœæ­¢
2. åˆæœŸã¯æœ€å°ãƒªã‚½ãƒ¼ã‚¹ã§é‹ç”¨ã—ã€å¿…è¦ã«å¿œã˜ã¦å¢—å¼·
3. Cloud Runã®è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’æ´»ç”¨

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•**

#### **Terraform applyå¤±æ•—**
```bash
# çŠ¶æ…‹ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
terraform refresh

# ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã®ã¿å†ä½œæˆ
terraform apply -target=module.app
```

#### **Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼**
```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
gcloud run services list --region=asia-northeast1

# ãƒ­ã‚°ç¢ºèª
gcloud logging read "resource.type=cloud_run_revision" --limit=10
```

#### **APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰**
- GitHub Secretsã«`BITBANK_API_KEY`ã¨`BITBANK_API_SECRET`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã“ã‚Œã‚‰ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ãå‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## ğŸ“ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### **ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
```bash
# ç’°å¢ƒå…¨ä½“ã‚’å‰Šé™¤ï¼ˆæ³¨æ„ï¼ï¼‰
terraform destroy

# ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã®ã¿å‰Šé™¤
terraform destroy -target=module.monitoring
```

### **çŠ¶æ…‹ç®¡ç†**
```bash
# ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
terraform state list

# çŠ¶æ…‹ã®è©³ç´°è¡¨ç¤º
terraform state show module.app.google_cloud_run_service.service
```

## ğŸ”„ CI/CDçµ±åˆ

GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•çš„ã«ï¼š
1. ã‚³ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
3. Artifact Registryã¸ã®ãƒ—ãƒƒã‚·ãƒ¥
4. Terraformã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤

mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§æœ¬ç•ªç’°å¢ƒã€developãƒ–ãƒ©ãƒ³ãƒã§é–‹ç™ºç’°å¢ƒã¸è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

## ğŸ“Œ æ³¨æ„äº‹é …

- **å€‹äººé–‹ç™ºç”¨ã®è¨­å®š**: é«˜å¯ç”¨æ€§ã‚„ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“
- **æ®µéšçš„ãªè³‡é‡‘æŠ•å…¥**: ã¾ãš1ä¸‡å††ã§å°‘é¡é‹ç”¨ã€å®‰å®šå¾Œã«50ä¸‡å††ã¾ã§å¢—é¡
- **ç›£è¦–ã®é‡è¦æ€§**: ç‰¹ã«æœ¬ç•ªç’°å¢ƒã§ã¯å®šæœŸçš„ã«ãƒ­ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèª

## ğŸ¯ å€‹äººé–‹ç™ºæœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ

### **å®Ÿè£…ã•ã‚ŒãŸæœ€é©åŒ–**
1. **ç’°å¢ƒã‚’2ã¤ã«å‰Šæ¸›**: paperç’°å¢ƒã‚’å‰Šé™¤ã—ã€dev/prodã®ã¿ã«
2. **ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã‚’å¤‰æ•°åŒ–**: ç’°å¢ƒã”ã¨ã«CPU/ãƒ¡ãƒ¢ãƒªã‚’æœ€é©åŒ–
3. **devç’°å¢ƒã‚’è¶…è»½é‡åŒ–**: CPU 250mã€Memory 512Miï¼ˆç´„200å††/æœˆï¼‰
4. **ä¸è¦ãªå¤–éƒ¨APIå‰Šé™¤**: Phase 3ã§å‰Šé™¤æ¸ˆã¿ã®APIã‚­ãƒ¼å‚ç…§ã‚’å®Œå…¨é™¤å»
5. **HAç’°å¢ƒã®å‰Šé™¤**: å€‹äººé–‹ç™ºã«ä¸è¦ãªé«˜å¯ç”¨æ€§è¨­å®šã‚’é™¤å»

### **ä»Šå¾Œã®ç°¡ç´ åŒ–å€™è£œ**
- devç’°å¢ƒã‚‚ä¸è¦ãªå ´åˆã¯ã€prodç’°å¢ƒã®ã¿ã®å˜ä¸€ç’°å¢ƒæ§‹æˆã‚‚å¯èƒ½
- ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ã•ã‚‰ã«ç°¡ç´ åŒ–å¯èƒ½

---

**æœ€çµ‚æ›´æ–°: 2025å¹´8æœˆ9æ—¥**  
å®Œå…¨å€‹äººé–‹ç™ºç”¨ã«æœ€é©åŒ–ã—ãŸã‚·ãƒ³ãƒ—ãƒ«ã§ä½ã‚³ã‚¹ãƒˆãªã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã§ã™ã€‚