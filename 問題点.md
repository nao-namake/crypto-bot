# 暗号資産Bot システム 問題点・改善点リスト

---

## 【設計・実装上の問題点・改善点】

### 1. 型安全性・型ヒントの徹底
- 一部の関数やクラスで型ヒント（例: `def func(x, y):`）が未記載、または`dict`や`Any`型の多用により、
  どの型が入出力されるかが不明瞭な箇所が散見されます。
- **リスク例:** 型不整合によるバグ、IDE補完やリファクタ時の事故、将来の保守コスト増大。
- **推奨:** すべての関数・クラス・メソッドに型ヒントを明記し、`Any`や`dict`の乱用を避ける。

### 2. 例外処理の粒度・一貫性
- 例外処理で`except Exception:`のような広範囲catchが多く、
  どの例外がどこで発生し、どのようにリカバリされるかが不明瞭な箇所があります。
- Discord通知やログ出力はあるものの、例外の再送出やログレベル（warning/error/critical）の使い分けが曖昧。
- **リスク例:** 予期せぬ例外の握りつぶし、障害原因の特定困難、運用時の見逃し。
- **推奨:** 例外クラスを細分化し、catch範囲を限定。ログレベルも一貫性を持たせる。

### 3. 設定値の分散・ハードコーディング
- 取引戦略やリスク管理等の閾値・パラメータ（例: ATR倍率、リスク閾値、API遅延閾値など）が
  コード内に直接記載されている箇所が複数存在。
- **リスク例:** パラメータ変更時の修正漏れ、環境ごとの挙動不一致、運用時の柔軟性低下。
- **推奨:** すべての閾値・パラメータはYAML等のconfigファイルで一元管理し、コードからは参照のみとする。

### 4. データ型の一貫性
- DataFrame/dict/Any型の相互変換が多く、関数間で受け渡すデータ型が統一されていない箇所がある。
- **リスク例:** 型不整合による実行時エラー、データ変換ミス、テスト困難化。
- **推奨:** 入出力インターフェースの型を明確化し、変換箇所を最小限に抑える。

### 5. モジュール間依存の明示性
- src配下のモジュール間で依存関係が複雑化しつつあり、循環importや密結合のリスクがある。
- **リスク例:** モジュール単体テスト困難、リファクタ時の副作用、依存解決の難化。
- **推奨:** 依存関係図の作成、循環importの解消、インターフェース設計による疎結合化。

---

## 【CI/CD・テスト・運用上の問題点・改善点】

### 6. テストカバレッジの向上
- 現状カバレッジは58.88%であり、特に例外系・異常系・境界値・エラー通知系のテストが未カバーな部分がある。
- **リスク例:** 想定外の入力や障害時のバグ検知漏れ、本番障害の未然防止困難。
- **推奨:** 例外系・異常系・境界値・通知系のテストを追加し、カバレッジ70%以上を目指す。

### 7. テストの粒度・自動化
- 単体テストは充実しているが、統合テスト・E2Eテスト（本番想定の一連フローや外部API障害時のシナリオ）がやや不足。
- **リスク例:** 実運用時の障害検知遅れ、外部API障害時の挙動未検証。
- **推奨:** E2Eテストや障害シナリオテストを追加し、CIで自動実行。

### 8. CI/CDパイプラインの堅牢性
- GCPリソース・Secret Manager・Artifact Registry等の前提リソースが未設定の場合、CI/CDが途中で失敗するリスクがある。
- **リスク例:** 新規環境構築時のデプロイ失敗、CI/CDの属人化。
- **推奨:** 事前チェックやリソース自動作成スクリプトの整備、CI/CDの失敗時に明確なエラー通知。

### 9. モデル・設定ファイルのバージョン管理
- MLモデルや設定ファイルのバージョン管理・更新履歴が明示的でない。
- **リスク例:** モデルのロールバック困難、設定ミス時の原因特定困難。
- **推奨:** モデル・設定ファイルにバージョン付与、更新履歴を管理（例: ファイル名やメタデータにバージョン・日付を明記）。

---

## 【セキュリティ・運用上の問題点・改善点】

### 10. 機密情報管理
- .envやSecret Managerの運用はされているが、ローカル環境での.env漏洩や、
  Secretのローテーション・アクセス権限の最小化が徹底されていない可能性がある。
- **リスク例:** APIキー等の漏洩による資産流出、第三者による不正アクセス。
- **推奨:** .envのgit管理除外、Secretの定期ローテーション、GCP IAM等でアクセス権限の最小化。

### 11. ログ・監視体制
- Discord通知・3階層アラートはあるが、長期的なログ保管やBigQuery等への集約、
  異常検知の自動化（例: 取引異常・API障害の自動検知）が弱い。
- **リスク例:** 障害発生時の原因追跡困難、長期的な運用分析・改善の遅れ。
- **推奨:** ログの長期保管、BigQuery等への集約、異常検知の自動化・可視化。

---

## 【ドキュメント・保守性の問題点・改善点】

### 12. ドキュメントの最新化・一貫性
- READMEや各種ドキュメントは充実しているが、実装と乖離する箇所や古い記述が一部残存。
  例: 新機能追加時にREADMEや運用手順書が未更新。
- **リスク例:** 新規開発者・運用者の混乱、手順ミス。
- **推奨:** 実装変更時のドキュメント即時更新、Sphinx等の自動生成ツール活用。

### 13. 開発・運用手順の明確化
- CI/CDやGCP運用手順は記載されているが、障害発生時の復旧手順やFAQ、トラブルシューティング集がやや不足。
- **リスク例:** 障害時の対応遅延、属人化。
- **推奨:** 障害時の復旧手順・FAQ・トラブルシューティング集を整備し、運用ドキュメントに明記。

---

## 【運用・保守・拡張性・パフォーマンス等の追加問題点】

### 14. CI/CD運用属人化・運用負荷
- CI/CDやGCP運用手順は整備されているが、運用担当者が限定されている場合、属人化リスクが残る。
- **リスク例:** 担当者不在時の障害対応遅延、ノウハウ継承困難。
- **推奨:** 運用手順の動画化・自動化、複数人での運用訓練、運用FAQの整備。

### 15. GCPコスト最適化・リソース管理
- Cloud Run/Artifact Registry/Storage等のリソースが増加した場合、コストが想定以上に膨らむリスク。
- **リスク例:** 古いDockerイメージや不要リソースの放置によるコスト増。
- **推奨:** 定期的なリソースクリーンアップ（docs/指示書/GCPクリーンアップ指示.md参照）、コスト監視アラートの導入。

### 16. 障害発生時の即時復旧体制
- 障害発生時の即時復旧手順は記載されているが、実際の訓練やロールバック手順の自動化がやや不足。
- **リスク例:** 本番障害時の復旧遅延、ロールバック手順の属人化。
- **推奨:** ロールバック自動化スクリプトの整備、障害訓練の定期実施。

### 17. 拡張性・将来の機能追加への備え
- 現状の設計は十分だが、将来的な戦略追加・新API対応・新規MLモデル追加時の拡張性検証が必要。
- **リスク例:** 新機能追加時の既存機能への影響、設計の硬直化。
- **推奨:** インターフェース設計の見直し、プラグイン方式の検討、将来の拡張計画の明文化。

### 18. パフォーマンス・スケーラビリティ
- 現状のパフォーマンスは十分だが、取引量増加やAPIレート制限強化時のスケーラビリティ検証が不足。
- **リスク例:** 高負荷時の遅延・タイムアウト、API制限超過による取引失敗。
- **推奨:** 負荷テスト・ストレステストの定期実施、APIレート制限監視・自動リトライ強化。

### 19. テストデータ・本番データの分離
- テスト用データと本番データの分離が明示的でない箇所がある。
- **リスク例:** テストデータが本番環境に混入、逆に本番データがテストで消失。
- **推奨:** テスト・本番で明確にデータパス・DB・ストレージを分離し、CI/CDで自動切替。

### 20. ドキュメントの多言語対応・ユーザビリティ
- ドキュメントは日本語中心で充実しているが、英語等多言語対応や図解・動画による説明が不足。
- **リスク例:** 外部協力者・将来のグローバル展開時の障壁。
- **推奨:** 主要README・運用手順の英語化、図解・動画マニュアルの追加。

---

（※ _legacy_v1/ 配下は調査対象外）
