# 暗号通貨自動取引Bot - システム診断と改善戦略の相談

## 1. システム概要

### プロジェクトの目的
BTC/JPYの自動取引を行うAIシステムの構築・運用。機械学習による価格予測と自動取引実行を統合。

### 技術スタック
- **言語**: Python 3.11
- **ML**: LightGBM + XGBoost + RandomForest（アンサンブル学習）
- **インフラ**: GCP Cloud Run + GitHub Actions CI/CD
- **取引所**: Bitbank API
- **アーキテクチャ**: モジュラー設計（Phase 16で10,644行削減・最適化済み）

### システム規模
- **コードベース**: 約50,000行（最適化後）
- **テスト**: 579個のテスト
- **カバレッジ**: 32.30%
- **月間コスト**: 約2,200円

## 2. 現在直面している問題（2025年8月10日）

### 🔴 クリティカル：エントリーシグナル生成の完全失敗

#### 問題1: UnboundLocalError
```python
# crypto_bot/cli/live.py
# 446行目でエラー
logger.info(f"⏰ {init_prefix} Timestamp: {pd.Timestamp.now()}")
# エラー: cannot access local variable 'pd' where it is not associated with a value

# 原因: 567行目と575行目に重複した局所的import
import pandas as pd  # 567行目（条件分岐内）
import pandas as pd  # 575行目（別の条件分岐内）
```

#### 問題2: AttributeError
```python
# エラーログ
'dict' object has no attribute 'logic_signal'

# 原因: EntryExitクラスに辞書型が渡されている
# 期待: Strategyオブジェクト
# 実際: dict型
```

#### 問題3: 設定値の不整合
```yaml
# config/production/production.yml
confidence_threshold: 0.35  # 設定値

# 実行時ログ
confidence_threshold: 0.7   # 実際に使用されている値
```

#### 問題4: アンサンブルモデル未使用
```
Strategy does not use ensemble models
# 3モデル統合のTradingEnsembleClassifierが機能していない
# フォールバック戦略に依存している状態
```

## 3. これまでの試行錯誤の経緯

### Phase 1-19+の開発履歴（6ヶ月間）
1. **Phase 1-10**: 基本システム構築、97特徴量システム確立
2. **Phase 11-15**: AI統合、品質保証体制確立
3. **Phase 16**: 大規模リファクタリング（10,644行削減）
4. **Phase 17-18**: エントリーシグナル問題対応（部分的解決）
5. **Phase 19+**: CI/CD修正、インフラ最適化

### 繰り返されるパターン
```
デプロイ → エラー発見 → 局所的修正 → 再デプロイ → 新たなエラー発見
```

このサイクルが延々と続いており、根本的な問題が解決されていない状況。

## 4. システムの複雑性の要因

### アーキテクチャの複雑さ
```
crypto_bot/
├── cli/           # 9ファイル（コマンドライン）
├── ml/            # 16ファイル（機械学習）
├── strategy/      # 18ファイル（取引戦略）
├── execution/     # 15ファイル（取引実行）
├── data/          # 分割システム（fetcher.py → 3ファイル）
└── utils/         # 11ファイル（ユーティリティ）
```

### 設定の複雑さ
- 34個の設定ファイル
- 環境変数と設定ファイルの混在
- デフォルト値の散在
- 継承関係の不明確さ

### 依存関係の複雑さ
- モジュール間の密結合
- 初期化順序の依存性
- 型の不整合（dict vs オブジェクト）

## 5. 具体的な質問とアドバイス依頼

### Q1: アーキテクチャの根本的見直しは必要か？
現在のモジュラー設計は理想的に見えるが、実際には複雑性が増している。もっとシンプルな構造にすべきか？

### Q2: エラーハンドリングの戦略
現在は局所的なtry-catchで対処しているが、より体系的なエラーハンドリング戦略が必要か？

### Q3: 設定管理の一元化
34個の設定ファイルは多すぎるか？どのように統合・簡素化すべきか？

### Q4: テスト戦略の見直し
カバレッジ32%で579個のテストがあるが、エラーを事前に検出できていない。テスト戦略を根本的に見直すべきか？

### Q5: 段階的アプローチ vs 全面的書き直し
- **段階的修正**: 現在のコードベースを少しずつ改善
- **全面的書き直し**: コア機能のみで再構築

どちらのアプローチが推奨されるか？

## 6. 理想的な最終状態

### 求める品質
- エラー率 < 0.01%
- デプロイ成功率 > 99%
- 設定変更の即座反映
- 予測可能な動作

### 運用の理想
- 週1回のメンテナンスで安定稼働
- 新機能追加が既存機能を壊さない
- ログから問題を即座に特定可能
- ロールバック可能な設計

## 7. リソースと制約

### 利用可能なリソース
- 開発者: 1名
- 予算: 月額5,000円以内
- 時間: 週10-20時間

### 制約条件
- 本番稼働中（停止時間は最小限に）
- Bitbank APIの仕様は変更不可
- GCP Cloud Runの使用は継続

## 8. 具体的なアドバイスをお願いしたい点

1. **短期的修正**（1週間以内）
   - 4つのクリティカルエラーの最も効率的な修正方法
   - エラーの再発防止策

2. **中期的改善**（1ヶ月以内）
   - アーキテクチャの簡素化方針
   - 設定管理の統合方法
   - テスト戦略の改善

3. **長期的方向性**（3ヶ月）
   - 技術的負債の解消計画
   - 保守性向上のためのリファクタリング指針
   - スケーラビリティの確保

## 9. GPT-5からの初回アドバイスへの反応

### 既に受けたアドバイスの要点
1. **ローカル検証環境の構築**（ペーパートレード）
2. **本番環境との差異最小化**（Docker/同一設定）
3. **詳細なログ設計**（構造化ログ、CSV出力）
4. **定期テストスクリプト**（1時間毎の検証）
5. **通知連携**（Slack/Discord）

### このアドバイスに対する現状
- **良い点**: 方向性は理解できる。ローカル検証の重要性も認識。
- **課題**: そもそも本番でエラーが出続けている状態で、ローカル検証環境を整備しても根本解決にならない懸念。

## 10. より具体的な相談事項

### A. 短期的な緊急対応について

現在4つのクリティカルエラーがあります：
1. pandas importのスコープ問題（単純だが影響大）
2. dict vs Strategyオブジェクトの型不整合
3. confidence_threshold値の不整合（0.35 vs 0.7）
4. アンサンブルモデルが読み込まれない

**質問**: これらを個別に修正していくべきか、それとも問題の根本原因（初期化フローの設計不良）を先に解決すべきか？

### B. アーキテクチャの簡素化について

現在の構造：
- 9個のCLIコマンドファイル
- 34個の設定ファイル
- 複雑な継承・依存関係

**質問**: 「シンプル・イズ・ベスト」の原則に立ち返り、コア機能（データ取得→予測→取引）だけの最小構成に作り直すべきか？

### C. ローカル検証環境の優先順位

GPT-5のアドバイス通り、ペーパートレード環境を先に整備すべきか、それとも本番のエラーを先に解決すべきか？

**質問**: 「壊れた本番」vs「理想的なローカル環境」のどちらを優先すべきか？

### D. 段階的移行戦略

**提案している2つのアプローチ**:

#### アプローチ1: 並行開発
```
現行システム（バグ含む）を維持
    ↓
新システム（最小構成）を並行開発
    ↓
ローカルで十分検証
    ↓
切り替え
```

#### アプローチ2: 段階的改善
```
現行システムのエラー修正
    ↓
不要な機能を削除
    ↓
構造を簡素化
    ↓
最終的に理想形へ
```

**質問**: どちらのアプローチが現実的か？

## 11. 成功の定義

### 最低限の成功（1週間）
- エラーなしで24時間稼働
- エントリーシグナルが正常に生成される
- 実際の取引が実行される

### 理想的な成功（1ヶ月）
- ローカル検証環境完備
- 本番デプロイ前にエラーを検出可能
- シグナル生成の予測可能性

## 12. 最終的な質問

**「技術的負債が蓄積し、エラー修正の度に新たなエラーが生まれる状況です。限られたリソース（開発者1名、週10-20時間）で、どのような戦略を取るべきでしょうか？」**

具体的には：
1. **現行システムの救済** vs **新システムの構築**
2. **完璧主義** vs **動くものを優先**
3. **ローカル検証環境** vs **本番エラー修正**

の優先順位について、実践的なアドバイスをお願いします。