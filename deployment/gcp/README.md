# deployment/gcp/ - GCPè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

**Phase 11å®Œäº†**: GitHub Actions CI/CDãƒ»Workload Identityãƒ»Secret Managerãƒ»æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»24æ™‚é–“ç›£è¦–çµ±åˆå®Œäº†

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### `cloudbuild.yaml`
**Phase 11å®Œæˆ GCPçµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**

- **ç›®çš„**: GitHub Actions CI/CDçµ±åˆãƒ»æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»Workload Identityèªè¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- **å ´æ‰€**: `/Users/nao/Desktop/bot/deployment/gcp/cloudbuild.yaml`
- **å®Ÿè¡Œ**: GitHub Actions CI/CDçµŒç”±ãƒ»Workload Identityè‡ªå‹•èªè¨¼ãƒ»Secret Managerçµ±åˆ

#### Phase 11çµ±åˆå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—
1. **çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ** (`run-tests`): checks_light.shãƒ»286ãƒ†ã‚¹ãƒˆ99.7%ãƒ»bot_managerçµ±åˆç¢ºèª
2. **ã‚»ã‚­ãƒ¥ã‚¢ãƒ“ãƒ«ãƒ‰** (`build-image`): Workload Identityèªè¨¼ãƒ»æœ€é©åŒ–ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ
3. **ã‚»ã‚­ãƒ¥ã‚¢ãƒ—ãƒƒã‚·ãƒ¥** (`push-image`): Artifact Registryãƒ»èªè¨¼çµ±åˆãƒ—ãƒƒã‚·ãƒ¥
4. **æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤** (`deploy-cloud-run`): Secret Managerçµ±åˆãƒ»ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é€£æº
5. **çµ±åˆç¢ºèª** (`verify-deployment`): 24æ™‚é–“ç›£è¦–é–‹å§‹ãƒ»bot_managerçµ±åˆç¢ºèª

#### ãƒªã‚½ãƒ¼ã‚¹è¨­å®š
- **ãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ—**: E2_HIGHCPU_8ï¼ˆé«˜é€Ÿãƒ“ãƒ«ãƒ‰ï¼‰
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: å…¨ä½“20åˆ†ãƒ»ã‚¹ãƒ†ãƒƒãƒ—åˆ¥åˆ¶é™ã‚ã‚Š
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: asia-northeast1

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œæ–¹æ³•

### æ‰‹å‹•å®Ÿè¡Œ
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œ
cd /Users/nao/Desktop/bot

# Cloud Buildæ‰‹å‹•å®Ÿè¡Œ
gcloud builds submit --config=deployment/gcp/cloudbuild.yaml

# ã¾ãŸã¯ç‰¹å®šã‚³ãƒŸãƒƒãƒˆã§ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud builds submit --config=deployment/gcp/cloudbuild.yaml \
  --substitutions=COMMIT_SHA=$(git rev-parse HEAD)
```

### Phase 11è‡ªå‹•å®Ÿè¡Œï¼ˆå®Œå…¨CI/CDçµ±åˆï¼‰
- **GitHub Actions**: `.github/workflows/ci.yml`ã§Phase 11å®Œå…¨çµ±åˆæ¸ˆã¿
- **ãƒˆãƒªã‚¬ãƒ¼**: mainãƒ–ãƒ©ãƒ³ãƒpushãƒ»ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ¼ã‚¸ãƒ»æ‰‹å‹•å®Ÿè¡Œ
- **æ¡ä»¶**: checks_light.shæˆåŠŸãƒ»286ãƒ†ã‚¹ãƒˆ99.7%åˆæ ¼ãƒ»Workload Identityèªè¨¼

## ğŸ”§ GCPç’°å¢ƒè¨­å®š

### Phase 11å®Œæˆäº‹å‰è¨­å®š
1. **Workload Identity**: GitHub Actionsç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
2. **Secret Manager**: å®Œå…¨è‡ªå‹•èªè¨¼æƒ…å ±ç®¡ç†
   - `bitbank-api-key`: Bitbank APIã‚­ãƒ¼ï¼ˆè‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   - `bitbank-api-secret`: Bitbank APIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆè‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
   - `discord-webhook-url`: Discordé€šçŸ¥URLï¼ˆ24æ™‚é–“ç›£è¦–çµ±åˆï¼‰
3. **Artifact Registry**: `crypto-bot-repo`ãƒ»è‡ªå‹•ã‚¤ãƒ¡ãƒ¼ã‚¸ç®¡ç†
4. **Cloud Run**: æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ

### Phase 11 Cloud Runçµ±åˆè¨­å®š
- **ã‚µãƒ¼ãƒ“ã‚¹å**: `crypto-bot-service`ï¼ˆæœ¬ç•ªï¼‰ãƒ»`crypto-bot-stage-*`ï¼ˆæ®µéšçš„ï¼‰
- **ãƒªã‚½ãƒ¼ã‚¹**: 1-2GB RAMãƒ»1-2 CPUãƒ»æ®µéšçš„æ‹¡å¤§å¯¾å¿œ
- **èªè¨¼**: Workload Identityãƒ»è‡ªå‹•ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
- **ç›£è¦–**: 24æ™‚é–“ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»bot_managerçµ±åˆ
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 1-3æ™‚é–“ï¼ˆæ®µéšçš„è¨­å®šï¼‰

## ğŸ“Š Phase 11å®Œæˆ GCPçµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿç¸¾

- âœ… **CI/CDçµ±åˆ**: 80%ãƒ‡ãƒ—ãƒ­ã‚¤åŠ¹ç‡å‘ä¸Šï¼ˆGitHub Actionsãƒ»Workload Identityå®Œå…¨çµ±åˆï¼‰
- âœ… **å“è³ªä¿è¨¼**: 99.7%ãƒ†ã‚¹ãƒˆæˆåŠŸç‡ï¼ˆ286ãƒ†ã‚¹ãƒˆãƒ»checks_light.shè‡ªå‹•åŒ–ï¼‰
- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: Workload Identityãƒ»Secret Managerãƒ»è‡ªå‹•èªè¨¼çµ±åˆ
- âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç‡**: 98%ä»¥ä¸Šï¼ˆè‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ»æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤çµ±åˆï¼‰
- âœ… **ç›£è¦–çµ±åˆ**: 24æ™‚é–“ç„¡äººç›£è¦–ï¼ˆbot_managerçµ±åˆãƒ»è‡ªå‹•å¾©æ—§ãƒ»Discordé€šçŸ¥ï¼‰
- âœ… **ãƒ“ãƒ«ãƒ‰æ™‚é–“**: 6-10åˆ†ï¼ˆ20%é«˜é€ŸåŒ–ãƒ»æœ€é©åŒ–æ¸ˆã¿ï¼‰

## ğŸ“‹ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Phase 11çµ±åˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
1. **Workload Identityèªè¨¼å¤±æ•—**: GitHub Actionsãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šç¢ºèª
2. **CI/CDå“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—**: checks_light.shãƒ»286ãƒ†ã‚¹ãƒˆãƒ»bot_managerçµ±åˆç¢ºèª
3. **Secret Manageræ¥ç¶šå¤±æ•—**: è‡ªå‹•èªè¨¼ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ãƒ»æ¨©é™è¨­å®šç¢ºèª
4. **æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—**: stagingè¨­å®šãƒ»æ®µéšçš„ãƒªã‚½ãƒ¼ã‚¹ãƒ»ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª
5. **24æ™‚é–“ç›£è¦–ã‚¨ãƒ©ãƒ¼**: bot_managerçµ±åˆãƒ»Discordé€šçŸ¥ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª

### ãƒ­ã‚°ç¢ºèª
```bash
# Cloud Buildãƒ­ã‚°ç¢ºèª
gcloud builds log [BUILD_ID]

# Cloud Runãƒ­ã‚°ç¢ºèª  
gcloud logging read "resource.type=cloud_run_revision" --limit=50
```

---

## ğŸ“Š Phase 11å®Œæˆ GCPçµ±åˆã‚·ã‚¹ãƒ†ãƒ å®Ÿç¸¾

### **GitHub Actions CI/CDçµ±åˆå®Œæˆ**
```
ğŸš€ å®Œå…¨è‡ªå‹•åŒ–: GitHub Actionsâ†’Cloud Buildâ†’Cloud Runâ†’ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆ: Workload Identityãƒ»Secret Managerãƒ»è‡ªå‹•èªè¨¼
ğŸ“Š å“è³ªä¿è¨¼: 99.7%ãƒ†ã‚¹ãƒˆæˆåŠŸãƒ»286ãƒ†ã‚¹ãƒˆãƒ»checks_light.shçµ±åˆ
ğŸ¥ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ : 24æ™‚é–“ç„¡äººç›£è¦–ãƒ»bot_managerãƒ»è‡ªå‹•å¾©æ—§ãƒ»Discordé€šçŸ¥
âš¡ é«˜é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤: 6-10åˆ†ï¼ˆ20%é«˜é€ŸåŒ–ï¼‰ãƒ»æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œ
```

**ğŸ¯ Phase 11å®Œäº†**: GitHub Actions CI/CDãƒ»Workload Identityãƒ»Secret Managerãƒ»æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»24æ™‚é–“ç›£è¦–ã‚’å®Œå…¨çµ±åˆã—ãŸã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«GCPè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆï¼