"""
BitbankClient ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« - Phase 17å“è³ªå‘ä¸Šãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸75%é”æˆ

Bitbankä¿¡ç”¨å–å¼•å°‚ç”¨APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åŸºæœ¬æ©Ÿèƒ½ã‚’åŒ…æ‹¬çš„ã«ãƒ†ã‚¹ãƒˆã€‚
åˆæœŸåŒ–ãƒ»è¨­å®šæ¤œè¨¼ãƒ»åŸºæœ¬ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚«ãƒãƒ¼ã€‚
"""

import os
from unittest.mock import MagicMock, patch

import pytest

from src.core.exceptions import DataFetchError, ExchangeAPIError
from src.data.bitbank_client import BitbankClient


class TestBitbankClient:
    """BitbankClient ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""

    def test_init_basic(self):
        """åŸºæœ¬åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ"""
        with patch.dict(
            os.environ, {"BITBANK_API_KEY": "test_api_key", "BITBANK_API_SECRET": "test_api_secret"}
        ):
            with patch("ccxt.bitbank") as mock_ccxt:
                mock_exchange = MagicMock()
                mock_ccxt.return_value = mock_exchange

                client = BitbankClient()

                assert client.api_key == "test_api_key"
                assert client.api_secret == "test_api_secret"
                assert client.leverage == 1.0
                assert hasattr(client, "logger")

    def test_init_with_params(self):
        """ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            client = BitbankClient(api_key="custom_key", api_secret="custom_secret", leverage=2.0)

            assert client.api_key == "custom_key"
            assert client.api_secret == "custom_secret"
            assert client.leverage == 2.0

    def test_init_invalid_leverage_low(self):
        """ç„¡åŠ¹ãƒ¬ãƒãƒ¬ãƒƒã‚¸ï¼ˆä½ï¼‰ãƒ†ã‚¹ãƒˆ"""
        with pytest.raises(ValueError, match="ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã¯1.0-2.0ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„"):
            BitbankClient(leverage=0.5)

    def test_init_invalid_leverage_high(self):
        """ç„¡åŠ¹ãƒ¬ãƒãƒ¬ãƒƒã‚¸ï¼ˆé«˜ï¼‰ãƒ†ã‚¹ãƒˆ"""
        with pytest.raises(ValueError, match="ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã¯1.0-2.0ã®ç¯„å›²ã§è¨­å®šã—ã¦ãã ã•ã„"):
            BitbankClient(leverage=3.0)

    def test_init_edge_leverage_values(self):
        """å¢ƒç•Œå€¤ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            # ä¸‹é™å€¤
            client1 = BitbankClient(leverage=1.0)
            assert client1.leverage == 1.0

            # ä¸Šé™å€¤
            client2 = BitbankClient(leverage=2.0)
            assert client2.leverage == 2.0

    def test_init_no_api_keys(self):
        """APIã‚­ãƒ¼ãªã—åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ"""
        with patch.dict(os.environ, {}, clear=True):
            with patch("ccxt.bitbank") as mock_ccxt:
                mock_exchange = MagicMock()
                mock_ccxt.return_value = mock_exchange

                client = BitbankClient()

                assert client.api_key is None
                assert client.api_secret is None

    @patch("ccxt.bitbank")
    def test_ccxt_initialization(self, mock_ccxt):
        """ccxtåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ"""
        mock_exchange = MagicMock()
        mock_ccxt.return_value = mock_exchange

        with patch.dict(
            os.environ, {"BITBANK_API_KEY": "test_key", "BITBANK_API_SECRET": "test_secret"}
        ):
            client = BitbankClient()

            # ccxt.bitbankãŒå‘¼ã°ã‚Œã¦ã„ã‚‹
            mock_ccxt.assert_called_once()

            # exchangeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
            assert client.exchange == mock_exchange

    def test_logger_initialization(self):
        """ãƒ­ã‚°åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            client = BitbankClient()

            assert hasattr(client, "logger")
            assert client.logger is not None

    def test_attributes_exist(self):
        """å¿…è¦å±æ€§å­˜åœ¨ç¢ºèªãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            client = BitbankClient()

            # å¿…é ˆå±æ€§ã®å­˜åœ¨ç¢ºèª
            assert hasattr(client, "api_key")
            assert hasattr(client, "api_secret")
            assert hasattr(client, "leverage")
            assert hasattr(client, "exchange")
            assert hasattr(client, "logger")

    def test_environment_variable_priority(self):
        """ç’°å¢ƒå¤‰æ•°å„ªå…ˆåº¦ãƒ†ã‚¹ãƒˆ"""
        # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        with patch.dict(
            os.environ, {"BITBANK_API_KEY": "env_key", "BITBANK_API_SECRET": "env_secret"}
        ):
            with patch("ccxt.bitbank") as mock_ccxt:
                mock_exchange = MagicMock()
                mock_ccxt.return_value = mock_exchange

                # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯ç’°å¢ƒå¤‰æ•°ä½¿ç”¨
                client1 = BitbankClient()
                assert client1.api_key == "env_key"
                assert client1.api_secret == "env_secret"

                # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ã‚Šã®å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å„ªå…ˆ
                client2 = BitbankClient(api_key="param_key", api_secret="param_secret")
                assert client2.api_key == "param_key"
                assert client2.api_secret == "param_secret"

    def test_leverage_types(self):
        """ãƒ¬ãƒãƒ¬ãƒƒã‚¸å‹ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            # æ•´æ•°
            client1 = BitbankClient(leverage=2)
            assert client1.leverage == 2

            # æµ®å‹•å°æ•°ç‚¹
            client2 = BitbankClient(leverage=1.5)
            assert client2.leverage == 1.5

    def test_multiple_instance_creation(self):
        """è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            # å„å‘¼ã³å‡ºã—ã§ç•°ãªã‚‹Mockã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
            mock_ccxt.side_effect = lambda *args, **kwargs: MagicMock()

            client1 = BitbankClient(leverage=1.0)
            client2 = BitbankClient(leverage=2.0)

            # ç‹¬ç«‹ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
            assert client1 is not client2
            assert client1.leverage != client2.leverage
            # exchangeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ï¼ˆmockã®å®Ÿè£…ã«ã‚ˆã‚‹ï¼‰


class TestBitbankClientErrorHandling:
    """BitbankClient ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ"""

    def test_invalid_leverage_types(self):
        """ç„¡åŠ¹ãƒ¬ãƒãƒ¬ãƒƒã‚¸å‹ãƒ†ã‚¹ãƒˆ"""
        invalid_leverages = [
            "1.5",  # æ–‡å­—åˆ—
            None,  # None
            [],  # ãƒªã‚¹ãƒˆ
            {},  # è¾æ›¸
        ]

        for invalid_leverage in invalid_leverages:
            with pytest.raises((ValueError, TypeError)):
                BitbankClient(leverage=invalid_leverage)

    def test_zero_leverage(self):
        """ã‚¼ãƒ­ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆ"""
        with pytest.raises(ValueError):
            BitbankClient(leverage=0)

    def test_negative_leverage(self):
        """è² ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆ"""
        with pytest.raises(ValueError):
            BitbankClient(leverage=-1.0)

    def test_extreme_leverage_values(self):
        """æ¥µç«¯ãƒ¬ãƒãƒ¬ãƒƒã‚¸å€¤ãƒ†ã‚¹ãƒˆ"""
        extreme_values = [100.0, 1000.0, float("inf")]

        for extreme_value in extreme_values:
            with pytest.raises(ValueError):
                BitbankClient(leverage=extreme_value)

    @patch("ccxt.bitbank")
    def test_ccxt_initialization_error(self, mock_ccxt):
        """ccxtåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ"""
        # ccxtã®åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆ
        mock_ccxt.side_effect = Exception("ccxt initialization failed")

        with pytest.raises(RuntimeError):
            BitbankClient()

    def test_empty_string_api_keys(self):
        """ç©ºæ–‡å­—åˆ—APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ"""
        with patch.dict(os.environ, {}, clear=True):
            with patch("ccxt.bitbank") as mock_ccxt:
                mock_exchange = MagicMock()
                mock_ccxt.return_value = mock_exchange

                # ç©ºæ–‡å­—åˆ—ã¯Falsyãªã®ã§ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Noneã«ãªã‚‹
                client = BitbankClient(api_key="", api_secret="")

                # ç©ºæ–‡å­—åˆ—ã¯è«–ç†çš„ã«Falsyã®ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯NoneãŒä½¿ç”¨ã•ã‚Œã‚‹
                assert client.api_key is None  # ç’°å¢ƒå¤‰æ•°ãŒãªã„å ´åˆNone
                assert client.api_secret is None


class TestBitbankClientEdgeCases:
    """BitbankClient ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ"""

    def test_very_precise_leverage(self):
        """é«˜ç²¾åº¦ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            precise_leverage = 1.123456789
            client = BitbankClient(leverage=precise_leverage)

            assert client.leverage == precise_leverage

    def test_leverage_boundary_values(self):
        """ãƒ¬ãƒãƒ¬ãƒƒã‚¸å¢ƒç•Œå€¤è©³ç´°ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            # 1.0ã‚ˆã‚Šåƒ…ã‹ã«å°ã•ã„å€¤
            with pytest.raises(ValueError):
                BitbankClient(leverage=0.9999999)

            # 2.0ã‚ˆã‚Šåƒ…ã‹ã«å¤§ãã„å€¤
            with pytest.raises(ValueError):
                BitbankClient(leverage=2.0000001)

    def test_unicode_api_keys(self):
        """Unicode APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            unicode_key = "ãƒ†ã‚¹ãƒˆ_ã‚­ãƒ¼_ğŸ”‘"
            unicode_secret = "ç§˜å¯†_æƒ…å ±_ğŸ”"

            client = BitbankClient(api_key=unicode_key, api_secret=unicode_secret)

            assert client.api_key == unicode_key
            assert client.api_secret == unicode_secret

    def test_very_long_api_keys(self):
        """éå¸¸ã«é•·ã„APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            long_key = "x" * 1000
            long_secret = "y" * 1000

            client = BitbankClient(api_key=long_key, api_secret=long_secret)

            assert client.api_key == long_key
            assert client.api_secret == long_secret

    def test_special_character_api_keys(self):
        """ç‰¹æ®Šæ–‡å­—APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            special_key = "!@#$%^&*()_+-={}[]|\\:;\"'<>?,./"
            special_secret = "~`!@#$%^&*()_+-={}[]|\\:;\"'<>?,./"

            client = BitbankClient(api_key=special_key, api_secret=special_secret)

            assert client.api_key == special_key
            assert client.api_secret == special_secret

    @patch.dict(os.environ, {}, clear=True)
    def test_no_environment_variables(self):
        """ç’°å¢ƒå¤‰æ•°ãªã—ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_exchange = MagicMock()
            mock_ccxt.return_value = mock_exchange

            client = BitbankClient()

            assert client.api_key is None
            assert client.api_secret is None
            assert client.leverage == 1.0


class TestBitbankClientIntegration:
    """BitbankClient çµ±åˆãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹"""

    @patch("ccxt.bitbank")
    def test_realistic_initialization_scenario(self, mock_ccxt):
        """ç¾å®Ÿçš„åˆæœŸåŒ–ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ"""
        mock_exchange = MagicMock()
        mock_ccxt.return_value = mock_exchange

        # ç¾å®Ÿçš„ãªæœ¬ç•ªç’°å¢ƒæƒ³å®š
        with patch.dict(
            os.environ,
            {"BITBANK_API_KEY": "1234567890abcdef", "BITBANK_API_SECRET": "abcdef1234567890"},
        ):
            client = BitbankClient(leverage=1.8)

            # åŸºæœ¬è¨­å®šç¢ºèª
            assert client.api_key == "1234567890abcdef"
            assert client.api_secret == "abcdef1234567890"
            assert client.leverage == 1.8
            assert client.exchange is not None

            # ccxtã®å‘¼ã³å‡ºã—ç¢ºèª
            mock_ccxt.assert_called_once()

    def test_client_independence(self):
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç‹¬ç«‹æ€§ãƒ†ã‚¹ãƒˆ"""
        with patch("ccxt.bitbank") as mock_ccxt:
            mock_ccxt.return_value = MagicMock()

            # è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
            clients = []
            for i in range(5):
                client = BitbankClient(
                    api_key=f"key_{i}", api_secret=f"secret_{i}", leverage=1.0 + i * 0.2
                )
                clients.append(client)

            # å„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒç‹¬ç«‹ã—ã¦ã„ã‚‹
            for i, client in enumerate(clients):
                assert client.api_key == f"key_{i}"
                assert client.api_secret == f"secret_{i}"
                assert abs(client.leverage - (1.0 + i * 0.2)) < 1e-10

    @patch("ccxt.bitbank")
    def test_memory_usage_efficiency(self, mock_ccxt):
        """ãƒ¡ãƒ¢ãƒªä½¿ç”¨åŠ¹ç‡ãƒ†ã‚¹ãƒˆ"""
        mock_ccxt.return_value = MagicMock()

        # å¤§é‡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ»å‰Šé™¤
        for _i in range(100):
            client = BitbankClient(leverage=1.5)
            del client  # æ˜ç¤ºçš„å‰Šé™¤

        # ã‚¨ãƒ©ãƒ¼ãªãå®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        assert True  # ãƒ†ã‚¹ãƒˆå®Œäº†ã®ç¢ºèª
