今後のTODOまとめ

1. 特徴量選定と機能強化

システムで現在97個ある特徴量は多く冗長な可能性が高いため、統計的・機械学習的手法で絞り込む必要があります。研究では130以上の指標から相関・重要度分析で上位20前後に減らしても性能を維持できると報告されています ￼。まず、ランダムフォレストや相互情報量（MI）を用いて特徴量重要度を評価し、モメンタム（RSI、RCI、MACD等）、ボラティリティ（ATR、ボリンジャーバンド幅等）、トレンド（移動平均など）系を重視して主要な数十個程度に削減します ￼。同時に、特徴量間の相関を調べて冗長指標を削除し、将来的に追加・削減しやすいようデータパイプラインを整理します。
	•	相互情報量やランダムフォレスト重要度で特徴量をランク付けし、20～30個程度に絞り込む（Momentum/Volatility系を優先） ￼。
	•	既存戦略に基づき、マルチタイムフレーム指標（4h, 1h, 15m）のみ必要なものを残す。時間特徴量（時刻・曜日）も検討。
	•	ファンダメンタル／市場センチメント系指標を追加検討：例えばマクロ経済指標やSNSのセンチメント指数、オンチェーン指標（アクティブアドレス数、NVT比率など）を特徴量として設計する ￼ ￼。ただし、外部APIに頼らず取得可能な手段（履歴データなど）に限定する。
	•	異常検知系指標：価格や取引量のZスコアを算出し、異常値フラグとする特徴量を追加する。研究ではZスコア異常検知で「異常/正常」を分類し重要な市場イベントを捉える有効性が示されている ￼。
	•	既存指標の見直し：Zigzagは「もちぽよアラート」専用なので必須ではなく、必要ならもっと単純なピーク検出手法に置き換える。フィボナッチ、EMA、ボリンジャー、MACD、RSIなど基礎的なテクニカルは維持検討。

2. コードリファクタリングとエラーハンドリング

現状コードベースは断片的になっており、重複・冗長部分の整理が急務です。ファイル構造やクラス設計を見直し、重複importの削除やデータ型の整合性を図ります（例：辞書型ではなくStrategyオブジェクトを使用）。設定値も34個と多いため、環境ごとに必要な最小限にまとめ、環境変数とYAMLファイルの役割を明確化します。
	•	モジュール整理：未使用・重複コードを削除し、モジュール依存関係を単純化する。例えば、cli/live.pyのローカルimport重複によるUnboundLocalErrorを修正し、モジュールロードの順序を明確化。
	•	エラーハンドリング強化：try/exceptを乱用するのではなく、特定例外のキャッチとカスタム例外クラスで細かく管理する ￼。全体をフォールバックする大枠の例外処理も実装し、異常時はクラッシュさせずに安全にログ出力する。
	•	ログの整備：Pythonのloggingモジュールを用いて例外発生時にスタックトレースと共にログを残し、Cloud Logging/Stackdriverと連携させる ￼。ユーザーへの通知はDiscordを活用済みのため、ログはバックエンドで集約し、必要に応じてDiscordアラートも追加。
	•	後処理の保証：必ず実行するクリーンアップ（接続解放・ファイルクローズ等）はfinallyで保証する ￼。
	•	設定管理の整理：複数のYAMLや環境変数を統合し、設定値の整合性を確保（例：confidence_thresholdの不整合を解消）。dataclassや統一フォーマットを利用して、設定の見通しを良くする。
	•	テスト拡充：既存テスト579件（カバレッジ約30%）では不具合検知に限界がある。特にシグナル生成周りや設定ロジックに対するユニットテスト・統合テストを追加し、自動検出力を高める。CI前チェック（data-check、full-check等）を引き続き活用する。

3. GCP/CI環境の安定化

Cloud Run上でのデプロイ失敗や再起動を防ぐため、インフラ設定とデプロイ手順を最適化します。コンテナ起動最適化として、起動時ロードするファイルを最小限にし、重いモデルは必要時に遅延ロードする ￼。WSGIサーバ（例：Gunicorn）はワーカー数やスレッド数を適切に設定し（例：--workers 1 --threads 8）、負荷に合わせて調整する ￼。
	•	リソース設定：メモリは十分（例：2GB以上）割り当て、同時実行数(concurrency)=1、最小インスタンス数(min_instances)=1に設定してコールドスタートとSIGTERM問題を回避する ￼。必要に応じて最大インスタンス数も制限し、スケールアウトによる予期せぬ挙動を防ぐ。
	•	認証付きスケジューラ：Cloud SchedulerやPub/Subで定期実行する場合は、IDトークン付きの認証付きリクエストを設定し、Cloud Run Invoker権限を持つサービスアカウントを使用する ￼。これにより外部からの呼び出しを安全に実施できる。
	•	監視ログ強化：Cloud RunのログをCloud Logging/Monitoringで収集し、エラーや異常発生時に即通知する。operational_status_checker.pyによる多段階チェックは有効なため、継続使用しながら、ログレベルや通知条件を適切にチューニングする。
	•	セキュリティ・IAM：Terraform設定でサービスアカウントやIAM権限を見直し、最小権限の原則を徹底する（すでにDiscord監視や通知周りは整備済み ￼）。認証情報や秘密鍵はSecret Managerで管理し、コードには含めない。
	•	デプロイ前チェック：CI/CDパイプラインにはすでにci_tools/checks.shやfull-checkが組み込まれているので、忘れず自動実行してからデプロイする。必要なら、コンテナ起動時にカスタムのヘルスチェックやReadiness Probeを追加して、リビジョンが健全に立ち上がっていることを確認する。

4. 戦略強化と勝率向上

明確化したい戦略を実装しつつ、勝率・収益性を高める指標を追加します。目標取引回数（100–200/月）やGCP費用超過分利益という要件を踏まえ、エントリー／イグジットルールを見直します。マルチタイムフレームでは上位足（4h→1h→15m）のトレンド判断を明示し、「もちぽよアラート」やフィボナッチ逆張りルールと適切に組み合わせます。
	•	アンサンブル戦略確認：三モデル（LGBM・XGBoost・RF）を用いたアンサンブルが正しく予測に使われているか検証し、落ちている場合は修正する。現在はフォールバック戦略に依存している可能性があるため、早急にTradingEnsembleClassifierを動作させる。
	•	閾値・リスク管理：confidence阈値0.25でのトレードを継続しつつ、テスト環境で他の閾値も検討する。リスク管理はKelly基準・ATR損切りが既に導入済みなので、ポジションサイズや最大ドローダウン管理ルールが適切か確認する。
	•	ファンダメンタル要素：投機的要素が強い暗号資産でも、市場センチメント指標（Fear & Greed Index）や資金調達率（Funding Rate）、出来高動向などを追加検討。外部API不使用の制約を考慮し、過去データを学習用に取り込むか、取引所APIで取得可能な指標（Bitbankのオープンインタレスト等）を用いる。例えば、市場の急騰/急落前にはセンチメント指数が極端になることがある ￼。
	•	異常検知シグナル：急激な値動きや出来高の急増を捉えるシグナルを実装する。Zスコア異常検知で「異常=1」を付与するなどし、モデルが通常のパターンと例外的変動を区別できるようにする ￼。これにより、本質的に大きなイベントを検知して戦略に反映できる。
	•	バックテスト＆検証強化：追加した指標や戦略を厳密にバックテストして月間取引回数や取引ごとの損益を評価し、実際の勝率・ROI向上に寄与するか検証する。過去データでのウォークフォワード検証を徹底し、過学習にならないよう留意する。

以上の項目を段階的に実装・検証し、コードを清潔に保ちつつBotの安定稼働と取引成績の向上を目指します ￼ ￼ ￼ ￼ ￼ ￼。