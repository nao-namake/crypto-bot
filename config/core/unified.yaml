# ========================================
# 統一設定ファイル (unified.yaml)
# ========================================
#
# 目的: 基本設定の統一管理・動的閾値はthresholds.yamlで管理
#
# 重要: 1つの設定ファイルで全環境をサポート
#       モード制御: コマンドライン引数 > 環境変数MODE > YAML内mode
#       動的閾値: thresholds.yamlで管理（get_threshold使用）
#
# 使用方法:
#   開発: python main.py --config config/core/unified.yaml --mode paper
#   本番: python main.py --config config/core/unified.yaml --mode live
#   環境変数: MODE=live python main.py --config config/core/unified.yaml
#
# ========================================

# 動作モード（デフォルト: ペーパートレード・安全性優先）
mode: paper  # paper/live/backtest（環境変数・CLIで上書き可能）

# ========================================
# モード別初期残高設定（一元管理）
# ========================================
# Phase 52.5: 使用箇所追加
# 使用箇所:
#   - src/core/orchestration/orchestrator.py (Lines 518-575)
#   - src/trading/execution/executor.py (Lines 89-91)
#   - src/trading/risk/manager.py (Lines 454, 464)
#   - src/trading/position/limits.py (Lines 236, 246)
#   - src/core/services/trading_cycle_manager.py (Lines 521-523)
mode_balances:
  paper:
    initial_balance: 10000.0      # ペーパートレード（1万円）
    description: "実験・検証用"
  live:
    initial_balance: 10000.0      # ライブトレード（1万円・本番運用）
    description: "本番運用・API取得ベース"
  backtest:
    initial_balance: 100000.0     # バックテスト（10万円）
    description: "過去データ検証用"

# 取引所設定（bitbank信用取引専用）
exchange:
  name: bitbank
  symbol: BTC/JPY
  leverage: 1.0
  rate_limit_ms: 1000           # API レート制限（ミリ秒）
  timeout_ms: 30000             # APIタイムアウト（30秒）
  retries: 3                    # 最大リトライ回数
  ssl_verify: true
  api_version: v1

# ========================================
# 機械学習設定（統一設定管理体系最適化）
# ========================================
# 注意: 信頼度閾値はthresholds.yamlで管理
# Phase 52.4: 2段階Graceful Degradation・ensemble重み統合
#
# 使用箇所:
#   - ensemble_weights: src/core/config/config_classes.py (Line 38)
#   - fallback_enabled: src/core/orchestration/ml_fallback.py
#   - models: src/ml/model_manager.py
ml:
  ensemble_enabled: true
  # アンサンブルモデル重み設定（Phase 52.4整理完了）
  ensemble_weights:
    lightgbm: 0.5      # LightGBM 50%（メインモデル）
    xgboost: 0.3       # XGBoost 30%（補完モデル）
    random_forest: 0.2 # RandomForest 20%（安定化モデル）
  models:
  - lgbm
  - xgb
  - rf
  # model_path: Phase 52.4削除済み（ml_loaderが動的にensemble_full/basic.pklを選択）
  model_update_check: true
  fallback_enabled: true
  prediction:
    lookback_periods: 100
    retrain_frequency: weekly

# ========================================
# データ取得設定（マルチタイムフレーム統一）
# ========================================
data:
  timeframes:
  - 15m  # メインタイムフレーム（エントリー判断用）
  - 4h   # 補助タイムフレーム（トレンド判断用）
  since_hours: 96
  limit: 100
  cache_enabled: true
  cache:
    enabled: true
    ttl_minutes: 5
    max_size: 1000
    disk_cache: true
    retention_days: 90

# ========================================
# 特徴量設定（Phase 52.5: 設定ファイル重複排除）
# ========================================
# 55特徴量（49基本+6戦略シグナル）
# - 49基本特徴量: テクニカル指標・ラグ・交差項・時間的特徴量
# - 6戦略シグナル特徴量: ATRBased・DonchianChannel・ADXTrendStrength・BBReversal・StochasticReversal・MACDEMACrossover
#
# Phase 52.5重複削除:
#   特徴量定義は config/core/feature_order.json が単一真実源
#   FeatureManagerが自動的にJSONファイルから特徴量リストを読み込み
#   このファイルでの重複定義は不要（保守性向上・同期問題解消）
# ========================================
# features設定は feature_order.json から自動ロード
# 詳細: config/core/feature_order.json:feature_categories

# ========================================
# 戦略設定（6戦略統合・Phase 52.4整理完了）
# ========================================
# Phase 52.4: 戦略設定はconfig/strategies.yamlで一元管理
# Phase 51.5-B動的戦略管理基盤により、strategies.yamlが唯一の戦略定義ソース
#
# 設定参照: config/strategies.yaml

# ========================================
# リスク管理設定（Kelly基準・個人開発最適化）
# ========================================
# 注意: Kelly基準詳細設定・リスク閾値はthresholds.yamlで管理
risk:
  risk_per_trade: 0.01
  max_drawdown: 0.2
  stop_loss_atr_multiplier: 1.2
  # Phase 52.5: consecutive_loss_limit削除（drawdown_manager.consecutive_loss_limitに統一）
  take_profit_ratio: 2.0
  daily_loss_limit: 0.05
  weekly_loss_limit: 0.1
  emergency_stop_enabled: true
  drawdown_manager:
    max_drawdown_ratio: 0.2
    consecutive_loss_limit: 8  # Phase 52.4: 5→8（連続損失許容を増加・取引機会拡大）
    cooldown_hours: 6          # 24→6（停止時間を大幅短縮・月100-200回対応）
    # 初期残高設定は mode_balances セクションから取得
    fallback_balance: 11000.0  # フォールバック残高（円）- API失敗時判別用
    persistence:
      # Phase 52.4: モード別状態分離対応（{mode}はpaper/live/backtestに置換）
      local_path_template: "src/core/state/{mode}/drawdown_state.json"  # モード別ローカルパステンプレート
      gcs_path_template: "drawdown/{mode}/state.json"                   # モード別GCSパステンプレート
      backup_prefix: "backup/"                                          # バックアップディレクトリプレフィックス
      gcs_bucket: "crypto-bot-state"                                    # Cloud Storageバケット名
  anomaly_detector:
    lookback_period: 20
    spread_warning_threshold: 0.003
    spread_critical_threshold: 0.005
    api_latency_warning: 1.0
    api_latency_critical: 3.0

# ========================================
# 注文実行設定
# ========================================
# 注意: ポジション管理設定（TP/SL等）はthresholds.yamlで管理
#

execution:
  mode: paper
  order:
    default_type: limit
    slippage_tolerance: 0.001
    max_retry: 3
    retry_delay: 1.0
  latency:
    target_ms: 1000
    warning_ms: 500
    critical_ms: 2000

# ========================================
# 本番運用設定（MODE=live時有効）
# ========================================
production:
  min_order_size: 0.0001  # Bitbank最小取引単位（0.0001 BTC = 約1,700円）
  max_order_size: 0.0005  # 1万円運用に適合（約8,500円相当、安全な上限設定）
  trade_interval: 300     # 5分間隔実行（月700-900円コスト最適化）
  margin_trading: true
  force_margin_mode: true

# ========================================
# ログ設定（環境別対応）
# ========================================
# Phase 52.4: logging設定完全外部化
logging:
  level: INFO
  file_enabled: true
  discord_enabled: true
  retention_days: 7
  file:
    enabled: true
    path: logs/production
    rotation: daily
    retention_days: 30
    max_size_mb: 100
  discord:
    enabled: true
    webhook_url: ${DISCORD_WEBHOOK_URL}
    levels:
      critical: true
      warning: true
      info: false

# ========================================
# 監視・ヘルスチェック
# ========================================
monitoring:
  health_check:
    enabled: true
    interval_seconds: 30
    timeout_seconds: 5
    manual_execution: true
  performance:
    enabled: true
    metrics_interval: 300

# ========================================
# GCP Cloud Run最適化
# ========================================
cloud_run:
  memory: 1Gi
  cpu: 1
  min_instances: 1
  max_instances: 2
  concurrency: 1
  timeout_seconds: 3600

# ========================================
# セキュリティ設定
# ========================================
security:
  secret_management: gcp_secret_manager
  workload_identity: true

# ========================================
# 取引制約・制限事項（個人開発）
# ========================================
trading_constraints:
  exchange: bitbank
  trading_type: margin
  leverage_max: 2.0
  leverage_actual: 1.0
  currency_pair: BTC/JPY
  default_order_type: limit  # 指値注文（手数料最適化: Maker -0.02%）
  initial_capital: 10000
  target_capital: 500000
  # features_count: 55  # Phase 52.5: feature_order.jsonが単一真実源（total_features: 55）
  timeframes:
  - 15m  # メインタイムフレーム（エントリー判断用）
  - 4h   # 補助タイムフレーム（トレンド判断用）

# ========================================
# MLモデルファイル参照（Phase 52.5追加）
# ========================================
# 単一真実源: config/core/feature_order.json:feature_levels
#
# 使用箇所:
#   - src/core/orchestration/ml_loader.py (load_ensemble_model)
#   - src/ml/model_manager.py
#   - src/ml/ensemble.py (ProductionEnsemble)
ml_models:
  full_features_model: "ensemble_full.pkl"    # 55特徴量（49基本+6戦略シグナル）
  basic_features_model: "ensemble_basic.pkl"  # 49特徴量（戦略シグナルなし・フォールバック）
  model_directory: "models/production"        # 本番モデル保存ディレクトリ
  note: "2段階Graceful Degradation: full→basic→DummyModel"

# ========================================
# レポート設定
# ========================================
reporting:
  error_dir: logs/reports/errors
  max_report_size_mb: 10
  retention_days: 30
  max_files_per_type: 100
  json_enabled: true
  markdown_enabled: true
  timestamp_format: '%Y%m%d_%H%M%S'

# ========================================
# Discord通知設定
# ========================================
# Phase 52.4: 週間レポート中心・リアルタイム通知最小化
discord:
  # 基本設定
  max_retries: 3
  timeout_seconds: 10
  max_message_length: 2000
  startup_grace_period: 30      # 起動後30秒は通知抑制
  min_interval: 2               # 最小間隔（後方互換）

  # Embed色設定
  embed_color:
    success: 65280              # 緑
    warning: 16776960           # 黄
    error: 16711680             # 赤
    info: 39423                 # 青

  # バッチ処理設定
  batch_notifications: true
  batch_interval_minutes: 60    # 1時間毎バッチ集約
  daily_summary_hour: 18        # JST 18:00日次サマリー

  # レート制限
  rate_limit:
    min_interval_seconds: 5     # 最小間隔5秒
    max_per_hour: 12            # 最大12通知/時
    burst_limit: 3              # バースト制限3通知

  # 通知レベル
  notification_levels:
    critical: immediate         # 即時通知（残高異常等）
    warning: batch              # バッチ集約（1時間毎）
    info: daily                 # 日次サマリーのみ

# ========================================
# レポート生成設定（Phase 52.4追加）
# ========================================
# 週間レポート生成システム設定
reporting:
  # 週間レポート設定
  weekly_report_days: 7                           # レポート期間（日数）
  temp_chart_path: "/tmp/weekly_pnl_curve.png"   # 一時チャートファイルパス
  chart_dpi: 150                                  # チャート解像度
  chart_figsize: [12, 8]                          # チャートサイズ [幅, 高さ]

  # ドローダウン計算用初期残高（Phase 52.3バグ修正対応）
  # 注: 実運用では mode_balances の該当モード値を使用推奨
  initial_balance: 10000                          # デフォルト初期残高（ペーパー/ライブ）

# ========================================
# バックテスト設定（Phase 52.4-B追加）
# ========================================
backtest:
  # データ設定
  data:
    default_symbol: "BTC/JPY"                     # デフォルト取引ペア
    default_timeframes: ["4h", "15m"]             # デフォルト時間軸
    data_directory: "src/backtest/data/historical" # データディレクトリ
    csv_read_timeout: 30.0                        # CSV読み込みタイムアウト（秒）
    cache_enabled: true                           # キャッシュ有効化
