# ========================================
# 統一設定ファイル (unified.yaml) - Phase 22最適化完了
# ========================================
# 
# Phase 22システム最適化・設定一元化・v16.4.0
# 作成日: 2025年9月7日 | 最終更新: Phase 22完了
# 目的: 基本設定の統一管理・動的閾値はthresholds.yamlで管理
#
# 重要: 1つの設定ファイルで全環境をサポート
#       モード制御: コマンドライン引数 > 環境変数MODE > YAML内mode
#       動的閾値: thresholds.yamlで管理（get_threshold使用）
#
# 使用方法:
#   開発: python main.py --config config/core/unified.yaml --mode paper
#   本番: python main.py --config config/core/unified.yaml --mode live
#   環境変数: MODE=live python main.py --config config/core/unified.yaml
#
# ========================================

# 動作モード（デフォルト: ペーパートレード・安全性優先）
mode: paper  # paper/live/backtest（環境変数・CLIで上書き可能）

# 取引所設定（bitbank信用取引専用）
exchange:
  name: bitbank
  symbol: BTC/JPY
  leverage: 1.0
  rate_limit_ms: 35000
  timeout_ms: 120000
  retries: 5
  ssl_verify: true
  api_version: v1

# ========================================
# 機械学習設定（Phase 22最適化）
# ========================================
ml:
  confidence_threshold: 0.35
  ensemble_enabled: true
  model_list:
  - lgbm
  - xgb
  - rf
  model_weights:
  - 0.5
  - 0.3
  - 0.2
  model_path: /app/models/production/production_ensemble.pkl
  model_update_check: true
  fallback_enabled: true
  max_retries: 3
  model_files:
    lightgbm: lightgbm_model.pkl
    xgboost: xgboost_model.pkl
    random_forest: random_forest_model.pkl
  prediction:
    lookback_periods: 100
    retrain_frequency: weekly

# ========================================
# データ取得設定（マルチタイムフレーム統一）
# ========================================
data:
  timeframes:
  - 4h
  - 15m
  since_hours: 96
  limit: 100
  cache_enabled: true
  cache:
    enabled: true
    ttl_minutes: 5
    max_size: 1000
    disk_cache: true
    retention_days: 90

# ========================================
# 特徴量設定（15特徴量統一システム）
# ========================================
features:
  mode: optimized
  basic:
  - close
  - volume
  momentum:
  - rsi_14
  - macd
  volatility:
  - atr_14
  - bb_position
  trend:
  - ema_20
  - ema_50
  volume:
  - volume_ratio
  breakout:
  - donchian_high_20
  - donchian_low_20
  - channel_position
  regime:
  - adx_14
  - plus_di_14
  - minus_di_14

# ========================================
# 戦略設定（5戦略統合）
# ========================================
strategies:
  enabled:
  - atr_based
  - mochipoy_alert
  - multi_timeframe
  - donchian_channel
  - adx_trend
  weights:
    atr_based: 0.25
    mochipoy_alert: 0.25
    multi_timeframe: 0.2
    donchian_channel: 0.15
    adx_trend: 0.15
  consensus:
    required_agreement: 0.4
    confidence_threshold: 0.3

# ========================================
# リスク管理設定（Kelly基準・個人開発最適化）
# ========================================
risk:
  kelly_criterion:
    max_position_ratio: 0.03
    safety_factor: 0.7
    min_trades_for_kelly: 20
  risk_per_trade: 0.01
  kelly_max_fraction: 0.03
  max_drawdown: 0.2
  stop_loss_atr_multiplier: 1.2
  consecutive_loss_limit: 5
  take_profit_ratio: 2.0
  daily_loss_limit: 0.05
  weekly_loss_limit: 0.1
  emergency_stop_enabled: true
  drawdown_manager:
    max_drawdown_ratio: 0.2
    consecutive_loss_limit: 5
    cooldown_hours: 24
  anomaly_detector:
    lookback_period: 20
    spread_warning_threshold: 0.003
    spread_critical_threshold: 0.005
    api_latency_warning: 1.0
    api_latency_critical: 3.0
  risk_thresholds:
    min_ml_confidence: 0.15
    risk_threshold_deny: 0.95
    risk_threshold_conditional: 0.7

# ========================================
# 注文実行設定
# ========================================
execution:
  mode: paper
  order:
    default_type: limit
    slippage_tolerance: 0.001
    max_retry: 3
    retry_delay: 1.0
  latency:
    target_ms: 1000
    warning_ms: 500
    critical_ms: 2000

# ========================================
# 本番運用設定（MODE=live時有効）
# ========================================
production:
  min_order_size: 0.0001
  max_order_size: 0.001
  trade_interval: 180
  margin_trading: true
  force_margin_mode: true

# ========================================
# ログ設定（環境別対応）
# ========================================
logging:
  level: INFO
  file_enabled: true
  discord_enabled: true
  retention_days: 7
  file:
    enabled: true
    path: logs/production
    rotation: daily
    retention_days: 30
    max_size_mb: 100
  discord:
    enabled: true
    webhook_url: ${DISCORD_WEBHOOK_URL}
    levels:
      critical: true
      warning: true
      info: false

# ========================================
# 監視・ヘルスチェック
# ========================================
monitoring:
  health_check:
    enabled: true
    interval_seconds: 30
    timeout_seconds: 5
    manual_execution: true
  performance:
    enabled: true
    metrics_interval: 300

# ========================================
# GCP Cloud Run最適化
# ========================================
cloud_run:
  memory: 1Gi
  cpu: 1
  min_instances: 1
  max_instances: 2
  concurrency: 1
  timeout_seconds: 3600

# ========================================
# セキュリティ設定
# ========================================
security:
  secret_management: gcp_secret_manager
  workload_identity: true

# ========================================
# 取引制約・制限事項（個人開発）
# ========================================
trading_constraints:
  exchange: bitbank
  trading_type: margin
  leverage_max: 2.0
  leverage_actual: 1.0
  currency_pair: BTC/JPY
  initial_capital: 10000
  target_capital: 500000
  features_count: 15
  timeframes:
  - 4h
  - 15m

# ========================================
# アンサンブル設定（重み配分）
# ========================================
ensemble:
  weights:
    lightgbm: 0.4
    xgboost: 0.4
    random_forest: 0.2

# ========================================
# レポート設定
# ========================================
reporting:
  error_dir: logs/reports/errors
  max_report_size_mb: 10
  retention_days: 30
  max_files_per_type: 100
  json_enabled: true
  markdown_enabled: true
  timestamp_format: '%Y%m%d_%H%M%S'

# ========================================
# Discord通知設定
# ========================================
discord:
  max_retries: 3
  timeout_seconds: 10
  rate_limit_delay: 1.0
  max_message_length: 2000
  embed_color:
    success: 65280
    warning: 16776960
    error: 16711680
    info: 39423
  notification_levels:
    critical: true
    warning: true
    info: false
