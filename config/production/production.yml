# 151特徴量本番環境設定（マルチタイムフレーム×アンサンブル学習）
# 外部データ統合・品質監視・手数料最適化・2段階アンサンブル完全版

data:
  exchange: bitbank
  symbol: BTC/JPY
  timeframe: 1h  # ベースタイムフレーム（マルチタイムフレーム変換用）
  api_key: ${BITBANK_API_KEY}
  api_secret: ${BITBANK_API_SECRET}
  ccxt_options:
    enableRateLimit: true
    rateLimit: 2000  # Bitbank実測値（2000ms）に最適化

  # Bitbank API最適化設定（ページネーション復活版：500件確実取得）
  # BitbankClient修正により生データ返し・ページネーション完全復活
  limit: 500   # 目標取得件数（500件）
  paginate: true
  per_page: 100  # BitbankAPI上限活用（50→100に最適化）
  since_hours: 72  # データ品質向上（48→72に拡大・品質スコア改善）
  weekend_data: true  # 土日データ取得対応
  fetch_retries: 5   # データ取得リトライ増加
  adaptive_rate_limit: true  # 動的レート制限有効化
  
  # 土日ギャップ対応設定（動的since_hours拡張・品質向上対応）
  weekend_extension_hours: 72  # 月曜日追加時間（48→72に拡大）
  early_week_extension_hours: 36  # 火曜午前追加時間（24→36に拡大）
  
  # ページネーション最適化パラメータ（復活対応）
  max_consecutive_empty: 2  # 連続空バッチ許容数（3→2に効率化）
  max_consecutive_no_new: 3  # 連続新レコードなし許容数（5→3に効率化）
  exponential_backoff: true  # 指数バックオフ有効化
  min_delay_ms: 1500  # 最小遅延（2000→1500に高速化）
  max_delay_ms: 8000   # 最大遅延（10000→8000に高速化）
  
  # マルチタイムフレーム対応データ設定
  multi_timeframe_data:
    base_timeframe: "1h"  # データ取得ベース
    target_timeframes:    # 変換対象タイムフレーム
      15m:
        method: "interpolation"  # 1h→15m 補間
        min_points: 50
      1h:
        method: "direct"         # 直接使用
        min_points: 100
      4h:
        method: "aggregation"    # 1h→4h 集約
        min_points: 25

strategy:
  type: multi_timeframe_ensemble
  name: multi_timeframe_ensemble
  params:
    model_path: /app/models/production/model.pkl  # 固定パス統一
    threshold: 0.05
    # 戦略が期待するMLセクション全体を追加
    ml:
      feat_period: 14
      lags: [1,2,3,4,5]
      rolling_window: 20
      horizon: 5
      target_type: classification
      model_type: lgbm
      ensemble:
        enabled: true
        method: trading_stacking
        confidence_threshold: 0.65
        risk_adjustment: true
        models: ["lgbm", "xgb", "rf"]  # LightGBM, XGBoost, RandomForest
        model_weights: [0.5, 0.3, 0.2]  # 性能ベース重み
      # 実装済み特徴量のみ（WARNING解消・安定動作重視）
      extra_features:
        # 基本テクニカル特徴量（実装済み）
        - rsi_14
        - rsi_7
        - rsi_21
        - macd
        - sma_10
        - sma_20
        - sma_50
        - sma_100
        - sma_200
        - ema_10
        - ema_12
        - ema_26
        - ema_50
        - ema_100
        - bb_upper
        - bb_lower
        - bb_percent
        - bb_width
        - atr_7
        - atr_14
        - atr_21
        - volume_sma
        - volume_zscore_14
        - volume_zscore_50
        - momentum_14
        - trend_strength
        # Phase 3.2A: 高度テクニカル指標（実装済み）
        - stoch        # ストキャスティクス
        - willr_14     # Williams %R
        - adx          # ADX
        - cmf_20       # チャイキンマネーフロー
        - fisher       # フィッシャートランスフォーム
        # 外部データ特徴量（実装済み・動作確認済み）
        - vix          # VIX恐怖指数（Yahoo Finance）
        - dxy          # ドル指数・金利（Yahoo Finance）
        - fear_greed   # Fear&Greed指数（Alternative.me）
        - funding      # Funding Rate・OI（Binance）
        # 時間・シグナル特徴量（実装済み）
        - day_of_week
        - hour_of_day
        - price_change_1h
        - price_change_4h
        - price_change_24h
        - volume_change_1h
        - volume_change_24h
        - volatility_1h
        - volatility_24h
      # 外部データ設定
      external_data:
        enabled: true
        cache_enabled: true
        fallback_enabled: true

# マルチタイムフレーム設定
multi_timeframe:
  timeframes: ["15m", "1h", "4h"]
  weights: [0.3, 0.5, 0.2]  # 15分足30%, 1時間足50%, 4時間足20%
  data_sync_enabled: true
  missing_data_tolerance: 0.1  # 10%まで欠損許容
  timeframe_consensus_threshold: 0.6  # 60%以上の合意で信号発生
  data_quality_threshold: 0.6  # 60%以上の品質で使用（90%→60%に緩和）

# 本番リスク設定
risk:
  risk_per_trade: 0.005
  stop_atr_mult: 1.2
  kelly_criterion:
    enabled: true
    max_fraction: 0.05

  # ATR期間を調整（データ不足に対応）
  atr_period: 7  # 軽量版と同じ期間に統一

live:
  mode: live
  trade_interval: 60
  min_order_size: 0.0001
  max_order_size: 0.0005
  starting_balance: 10000.0  # 実際の残高取得失敗時のフォールバック
  margin_trading:
    enabled: true
    leverage: 1.0
    position_type: "both"
    force_margin_mode: true  # margin_mode=true強制適用
    verify_margin_status: true  # margin状態確認強制
  
  # Bitbank固有設定
  bitbank_settings:
    min_btc_amount: 0.0001
    max_retries: 3
    retry_delay: 5

# 151特徴量フル版ML設定（マルチタイムフレーム対応）
ml:
  feat_period: 14
  lags: [1,2,3,4,5]
  rolling_window: 20
  horizon: 5
  target_type: classification
  model_type: lgbm
  
  # アンサンブル学習設定
  ensemble:
    enabled: true
    method: trading_stacking
    confidence_threshold: 0.65
    risk_adjustment: true
    models: ["lgbm", "xgb", "rf"]  # LightGBM, XGBoost, RandomForest
    model_weights: [0.5, 0.3, 0.2]  # 性能ベース重み
    
  # 実装済み特徴量のみ（WARNING解消・安定動作重視）
  extra_features:
    # 基本テクニカル特徴量（実装済み）
    - rsi_14
    - rsi_7
    - rsi_21
    - macd
    - sma_10
    - sma_20
    - sma_50
    - sma_100
    - sma_200
    - ema_10
    - ema_12
    - ema_26
    - ema_50
    - ema_100
    - bb_upper
    - bb_lower
    - bb_percent
    - bb_width
    - atr_7
    - atr_14
    - atr_21
    - volume_sma
    - volume_zscore_14
    - volume_zscore_50
    - momentum_14
    - trend_strength
    
    # Phase 3.2A: 高度テクニカル指標（実装済み）
    - stoch        # ストキャスティクス
    - willr_14     # Williams %R
    - adx          # ADX
    - cmf_20       # チャイキンマネーフロー
    - fisher       # フィッシャートランスフォーム
    
    # 外部データ特徴量（実装済み・動作確認済み）
    - vix          # VIX恐怖指数（Yahoo Finance）
    - dxy          # ドル指数・金利（Yahoo Finance）
    - fear_greed   # Fear&Greed指数（Alternative.me）
    - funding      # Funding Rate・OI（Binance）
    
    # 時間・シグナル特徴量（実装済み）
    - day_of_week
    - hour_of_day
    - price_change_1h
    - price_change_4h
    - price_change_24h
    - volume_change_1h
    - volume_change_24h
    - volatility_1h
    - volatility_24h
    
    
  # 外部データ設定
  external_data:
    enabled: true
    cache_enabled: true
    fallback_enabled: true
    
    vix:
      enabled: true
      symbol: "^VIX"
      timeframe: "1d"
      fallback_level: 20.0
      sources: ["yahoo", "alpha_vantage"]  # データソース優先順位
      quality_threshold: 0.7
      cache_hours: 24
      
    macro:
      enabled: true
      symbols:
        dxy: "DX-Y.NYB"
        us10y: "^TNX"
        us2y: "^IRX"
      fallback_values:
        dxy: 103.0
        us10y: 4.5
        us2y: 4.8
      sources: ["yahoo"]  # Yahoo Finance統一
      quality_threshold: 0.8
      cache_hours: 6
        
    fear_greed:
      enabled: true
      api_url: "https://api.alternative.me/fng/"
      fallback_index: 50
      sources: ["alternative_me", "cnn_backup"]  # プライマリと バックアップ
      quality_threshold: 0.5  # Fear&Greedは品質変動大
      cache_hours: 1
      
    funding:
      enabled: true
      symbol: "BTC/USDT"
      exchanges: ["binance"]  # トレンド判定・市況分析用
      fallback_rate: 0.0001
      oi_enabled: true  # Open Interest有効化
      sources: ["binance", "bybit"]  # 取引所優先順位
      quality_threshold: 0.6
      cache_hours: 0.5  # 30分キャッシュ

# 外部データリトライ設定
external_data_retry:
  max_retries: 3
  retry_delay: 2
  exponential_backoff: true
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    recovery_timeout: 300

# 品質監視設定
quality_monitoring:
  enabled: true
  default_threshold: 0.3       # 30%ルール
  emergency_stop_threshold: 0.5 # 50%で緊急停止
  
# バックテスト設定（ライブトレードでの初期設定用）
backtest:
  starting_balance: 10000.0
  slippage_rate: 0.001

# ログ設定
logging:
  level: INFO
  file: /app/logs/bitbank_production.log
  rotation: daily
  retention: 7

# Bitbank手数料最適化設定
bitbank:
  fee_optimization:
    enabled: true
    maker_fee: -0.0002  # -0.02%
    taker_fee: 0.0012   # 0.12%
    prefer_maker: true
    min_profit_after_fees: 0.002  # 0.2%
    
  order_management:
    max_open_orders: 30  # 30件/ペア制限
    rate_limit:
      get_requests: 10   # 10回/秒
      post_requests: 6   # 6回/秒
    queue_enabled: true
    
  day_trading:
    enabled: true
    interest_rate: 0.0004  # 0.04%/日
    auto_close_before_rollover: true
    rollover_time: "00:00:00"