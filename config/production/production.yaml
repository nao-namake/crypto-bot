# ========================================
# 本番運用設定ファイル (production.yaml)
# ========================================
# 
# Phase 13完成版: ライブモード本番運用最適化設定
# 作成日: 2025年8月22日
# 目的: 実取引環境での安全・確実・効率的な運用
#
# 重要: 本設定ファイルはライブモード専用です
#       ペーパートレードには base.yaml を使用してください
#
# ========================================
# 基本設定（本番運用）
# ========================================

# 本番モード（実取引）
mode: live  # 🚨 本番モード: 実際の資金での取引

# 取引所設定（本番用）
exchange:
  name: bitbank
  symbol: "BTC/JPY"
  
  # API制限（本番用厳格設定）
  rate_limit_ms: 35000      # 35秒間隔（本番安全マージン）
  timeout_ms: 120000        # 2分タイムアウト（本番安全性）
  retries: 5                # リトライ回数増加（本番信頼性）
  
  # 本番用セキュリティ強化
  ssl_verify: true          # SSL証明書検証必須
  api_version: "v1"         # APIバージョン固定

# ========================================
# 機械学習設定（本番最適化）
# ========================================
ml:
  # 本番用信頼度閾値（保守的）
  confidence_threshold: 0.40  # 40%（本番では保守的な判定）
  
  # アンサンブルモデル設定
  ensemble_enabled: true
  models: ["lgbm", "xgb", "rf"]
  model_weights: [0.5, 0.3, 0.2]  # LightGBM重視（実績ベース）
  
  # 本番用モデル管理
  model_path: "/app/models/production/production_ensemble.pkl"
  model_update_check: true     # モデル更新チェック有効
  fallback_enabled: true       # フォールバック機能有効

# ========================================
# リスク管理設定（本番用厳格管理）
# ========================================
risk:
  # 基本リスク設定（保守的）
  risk_per_trade: 0.008        # 0.8%（本番は保守的）
  kelly_max_fraction: 0.025    # Kelly基準最大2.5%
  max_drawdown: 0.15           # 最大ドローダウン15%（厳格）
  consecutive_loss_limit: 4     # 連続損失3回で一時停止
  
  # ストップロス設定
  stop_loss_atr_multiplier: 1.0  # ATRの1.0倍（厳格）
  take_profit_ratio: 2.0         # リスクリワード比1:2
  
  # 本番用追加保護機能
  daily_loss_limit: 0.05         # 日次損失限度5%
  weekly_loss_limit: 0.10        # 週次損失限度10%
  emergency_stop_enabled: true   # 緊急停止機能有効

# ========================================
# データ取得設定（本番用）
# ========================================
data:
  # タイムフレーム（レガシー実証済み）
  timeframes: ["15m", "1h", "4h"]
  since_hours: 96       # 4日分（Bitbank安定範囲）
  limit: 100           # 確実な取得数
  
  # キャッシュ設定
  cache:
    enabled: true
    ttl_minutes: 5      # 5分間キャッシュ
    max_size: 1000      # 最大1000エントリ
    disk_cache: true
    retention_days: 90  # 90日保存

# 特徴量設定（Phase 3最適化版）
features:
  mode: "optimized"  # 12個厳選特徴量
  
  # 基本特徴量
  basic:
    - "close"
    - "volume" 
    - "returns_1"
  
  # テクニカル指標
  technical:
    - "rsi_14"
    - "macd"
    - "atr_14"
    - "bb_position"
    - "ema_20"
    - "ema_50"
  
  # 異常検知
  anomaly:
    - "zscore"
    - "volume_ratio"
    - "market_stress"

# 戦略設定（Phase 4統合版）
strategies:
  enabled:
    - "atr_based"
    - "mochipoy_alert"
    - "multi_timeframe"
    - "fibonacci_retracement"
  
  # 戦略重み（実績ベース）
  weights:
    atr_based: 0.3
    mochipoy_alert: 0.3
    multi_timeframe: 0.25
    fibonacci_retracement: 0.15
  
  # 統合判定
  consensus:
    required_agreement: 0.6  # 60%以上の合意で実行
    confidence_threshold: 0.4

# 機械学習設定（Phase 8バックテスト最適化）
ml:
  ensemble_enabled: true      # アンサンブル有効
  confidence_threshold: 0.5   # Phase 8最適化（0.25→0.5・適切な精度確保）
  
  # アンサンブル設定（レガシー実績ベース）
  models:
    - "lgbm"     # 実績のある3モデル
    - "xgb"
    - "rf"
  
  model_weights:  # 最適化済み重み
    - 0.5         # LightGBM
    - 0.3         # XGBoost
    - 0.2         # RandomForest
  
  # 予測設定
  prediction:
    lookback_periods: 100
    retrain_frequency: "weekly"

# リスク管理設定（Phase 6完全版・レガシー実証値活用）
risk:
  # Kelly基準ポジションサイジング（Phase 8バックテスト最適化）
  kelly_criterion:
    max_position_ratio: 0.05    # 最大5%（Phase 8最適化・過度な保守性解消）
    safety_factor: 0.7          # Kelly値の70%使用
    min_trades_for_kelly: 20
  
  # Phase 8バックテスト最適化設定
  risk_per_trade: 0.01        # 1取引あたり1%（安全・維持）
  kelly_max_fraction: 0.05    # Kelly基準最大5%（Phase 8最適化: 0.03→0.05）
  max_drawdown: 0.20          # 最大ドローダウン20%
  stop_loss_atr_multiplier: 1.2  # 1.2×ATR損切り（レガシー実証値）
  consecutive_loss_limit: 5   # 連続5損失で24時間停止
  
  # ドローダウン管理
  drawdown_manager:
    max_drawdown_ratio: 0.20    # 20%上限
    consecutive_loss_limit: 5   # 連続5損失で停止
    cooldown_hours: 24          # 24時間クールダウン
  
  # 異常検知（Phase 6）
  anomaly_detector:
    spread_warning_threshold: 0.003   # 0.3%
    spread_critical_threshold: 0.005  # 0.5%
    api_latency_warning: 1.0         # 1秒
    api_latency_critical: 3.0        # 3秒
  
  # 統合判定閾値（Phase 8バックテスト最適化）
  risk_thresholds:
    min_ml_confidence: 0.5         # 最小ML信頼度50%（Phase 8最適化: 0.25→0.5）
    risk_threshold_deny: 0.8       # 80%以上でDENY
    risk_threshold_conditional: 0.6 # 60%以上で条件付き

# 注文実行設定（Phase 7）
execution:
  mode: "live"  # 本番は実取引
  
  # 注文設定（レガシー実証済み値）
  order:
    default_type: "limit"  # 指値注文優先
    slippage_tolerance: 0.001  # 0.1%スリッページ許容
    max_retry: 3
    retry_delay: 1.0  # 1秒間隔
  
  # レイテンシー目標（Phase 7）
  latency:
    target_ms: 1000    # 1秒以内
    warning_ms: 500    # 500ms警告
    critical_ms: 2000  # 2秒クリティカル

# 本番専用設定（Phase 7収益性最適化・レガシー参考値採用）
production:
  min_order_size: 0.0001     # 最小注文サイズ
  max_order_size: 0.001      # 最大注文サイズ（0.0005→0.001・収益性向上）
  trade_interval: 60         # 取引間隔（秒）
  margin_trading: true       # 信用取引有効
  force_margin_mode: true    # 信用取引強制

# ログ設定（レガシー最適化継承）
logging:
  level: "INFO"              # 本番情報レベル
  file_enabled: true         # ファイル記録必須
  discord_enabled: true      # Discord監視必須
  retention_days: 30         # 本番は長期保持
  
  # ファイルログ
  file:
    enabled: true
    path: "logs/production"
    rotation: "daily"
    retention_days: 30
    max_size_mb: 100
  
  # Discord通知
  discord:
    enabled: true
    webhook_url: "${DISCORD_WEBHOOK_URL}"
    
    # 通知レベル設定
    levels:
      critical: true   # 取引停止、重大エラー
      warning: true    # API遅延、異常値
      info: false      # 通常取引（本番では無効化）

# 監視・ヘルスチェック
monitoring:
  # ヘルスチェック
  health_check:
    enabled: true
    interval_seconds: 30
    timeout_seconds: 5
    
  # パフォーマンス監視
  performance:
    enabled: true
    metrics_interval: 300  # 5分間隔

# GCP Cloud Run最適化
cloud_run:
  # リソース設定
  memory: "2Gi"
  cpu: 1
  
  # スケーリング
  min_instances: 1     # 本番は常時稼働
  max_instances: 1     # 単一インスタンス
  concurrency: 1       # 取引整合性確保
  
  # タイムアウト
  timeout_seconds: 3600  # 1時間