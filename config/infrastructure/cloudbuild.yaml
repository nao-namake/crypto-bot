# Phase 16-Bå®Œäº†: GCP Cloud Buildå®Œæˆè¨­å®š
# 620ãƒ†ã‚¹ãƒˆãƒ»50%+ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»å‹å®‰å…¨æ€§æ”¹å–„ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆå¼·åŒ–å¯¾å¿œ
#
# ğŸ”§ 2025-09-07 ä¿®æ­£: å®Ÿç’°å¢ƒæ•´åˆæ€§å¯¾å¿œ
# - å­˜åœ¨ã—ãªã„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæŒ‡å®šå‰Šé™¤ï¼ˆcrypto-bot-workload-identity@...ï¼‰
# - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCompute Engine SAä½¿ç”¨ï¼ˆå®Ÿç’°å¢ƒã§é©åˆ‡ãªæ¨©é™è¨­å®šæ¸ˆã¿ï¼‰
# - CI/CD ãƒ‡ãƒ—ãƒ­ã‚¤å•é¡Œè§£æ±ºå¯¾å¿œ

steps:
  # 1. Phase 12çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå®Œå…¨å“è³ªä¿è¨¼ï¼‰
  - name: 'python:3.13-slim'
    id: 'run-phase12-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§ª Phase 16-Bçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ï¼ˆ620ãƒ†ã‚¹ãƒˆãƒ»50%+ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»å‹å®‰å…¨æ€§æ”¹å–„ï¼‰"
        
        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€å°é™ãƒ»é«˜é€ŸåŒ–ï¼‰
        pip install --upgrade pip
        pip install pytest pytest-asyncio pandas numpy ccxt pyyaml dataclasses-json
        
        # Phase 16-Bå“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        echo "ğŸ“‹ çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        if bash scripts/testing/checks.sh; then
          echo "âœ… 620ãƒ†ã‚¹ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯æˆåŠŸ"
        else
          echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•— - ãƒ“ãƒ«ãƒ‰åœæ­¢"
          exit 1
        fi
        
        # Phase 16-Bé‡è¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå‹å®‰å…¨æ€§ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆå¼·åŒ–ï¼‰
        python -m pytest tests/unit/ -v --tb=short --maxfail=5
        python -m pytest tests/integration/ -v --tb=short --maxfail=3
        
        echo "âœ… Phase 16-Bçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆ620ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰"
    timeout: '600s'  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ620ãƒ†ã‚¹ãƒˆå¯¾å¿œï¼‰

  # 2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:$COMMIT_SHA'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:latest'
      - '.'
    timeout: '600s'  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

  # 3. ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Artifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '--all-tags'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot'
    timeout: '300s'

  # 4. Phase 16-Bçµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå‹å®‰å…¨æ€§æ”¹å–„ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆå¼·åŒ–å¯¾å¿œï¼‰
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run-phase12'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'crypto-bot-service-prod'
      - '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:$COMMIT_SHA'
      - '--region=asia-northeast1'
      - '--platform=managed'
      - '--port=8080'
      - '--memory=1Gi'        # Phase 16-Bæœ€é©åŒ–
      - '--cpu=1'
      - '--min-instances=1'   # æœ¬ç•ªå®‰å®šæ€§ç¢ºä¿
      - '--max-instances=2'   # è² è·åˆ†æ•£å¯¾å¿œ
      - '--concurrency=1'     # å–å¼•æ•´åˆæ€§ç¢ºä¿
      - '--timeout=3600'      # 1æ™‚é–“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      - '--allow-unauthenticated'
      - '--set-env-vars=MODE=paper,LOG_LEVEL=INFO,PYTHONPATH=/app,FEATURE_MODE=optimized'
      - '--set-secrets=BITBANK_API_KEY=bitbank-api-key:latest,BITBANK_API_SECRET=bitbank-api-secret:latest,DISCORD_WEBHOOK_URL=discord-webhook-url:latest'
      # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæŒ‡å®šå‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCompute Engine SAã‚’ä½¿ç”¨ï¼‰
      # å®Ÿéš›ã®ç’°å¢ƒ: 11445303925-compute@developer.gserviceaccount.com ãŒé©åˆ‡ãªæ¨©é™ã‚’ä¿æœ‰
    timeout: '300s'

  # 5. Phase 16-Bçµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»å‹å®‰å…¨æ€§ç›£è¦–é–‹å§‹
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-phase12-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Phase 16-Bçµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»å‹å®‰å…¨æ€§ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
        
        # ã‚µãƒ¼ãƒ“ã‚¹URLã‚’å–å¾—
        SERVICE_URL=$(gcloud run services describe crypto-bot-service-prod \
          --region=asia-northeast1 \
          --format='value(status.url)')
        
        echo "ğŸ“ Phase 16-Bã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
        
        # Phase 16-Bçµ±åˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§6å›ãƒªãƒˆãƒ©ã‚¤ãƒ»å‹å®‰å…¨æ€§ç¢ºèªï¼‰
        for i in {1..6}; do
          if curl -f "$SERVICE_URL/health" --connect-timeout 15 --max-time 30; then
            echo "âœ… Phase 16-Bãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç¢ºèªå®Œäº†"
            echo "ğŸ¥ å‹å®‰å…¨æ€§ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­..."
            echo "âœ… 620ãƒ†ã‚¹ãƒˆ: çµ±åˆæ¸ˆã¿"
            echo "ğŸ“Š 50%+ã‚«ãƒãƒ¬ãƒƒã‚¸: é”æˆæ¸ˆã¿"
            echo "ğŸ”’ Workload Identity: èªè¨¼æ¸ˆã¿"
            echo "ğŸ“¡ Discordé€šçŸ¥: çµ±åˆæ¸ˆã¿"
            exit 0
          else
            echo "â³ Phase 16-Bãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å†è©¦è¡Œ ($i/6) - å‹å®‰å…¨æ€§ç›£è¦–æº–å‚™ä¸­..."
            sleep 15
          fi
        done
        
        echo "âŒ Phase 16-Bãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªå¤±æ•— - æ‰‹å‹•ç¢ºèªãŒå¿…è¦"
        exit 1
    timeout: '300s'  # 5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆPhase 16-Bçµ±åˆå¯¾å¿œï¼‰

# Phase 16-Bãƒ“ãƒ«ãƒ‰è¨­å®šï¼ˆ620ãƒ†ã‚¹ãƒˆå¯¾å¿œãƒ»é«˜é€ŸåŒ–ï¼‰
options:
  # Phase 16-Bé«˜é€Ÿãƒ“ãƒ«ãƒ‰ï¼ˆå‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯çµ±åˆï¼‰
  machineType: 'E2_HIGHCPU_8'
  substitution_option: 'ALLOW_LOOSE'
  
  # Phase 16-Bçµ±åˆãƒ­ã‚°è¨­å®š
  logging: 'CLOUD_LOGGING_ONLY'
  
  # Workload Identityçµ±åˆ
  env:
    - 'CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/workspace/gha-creds-*.json'

# Phase 16-Bç½®æ›å¤‰æ•°ï¼ˆçµ±åˆè¨­å®šï¼‰
substitutions:
  # GCPè¨­å®š
  _REGION: 'asia-northeast1'
  _SERVICE_NAME: 'crypto-bot-service-prod'
  _REPO_NAME: 'crypto-bot-repo'
  
  # Phase 16-Bã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  _MODE: 'paper'                    # paper/liveï¼ˆ2æ®µéšãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
  _MEMORY: '1Gi'                    # Phase 16-Bæœ€é©åŒ–
  _CPU: '1'
  _FEATURE_MODE: 'optimized'        # 12å€‹å³é¸ç‰¹å¾´é‡ã‚·ã‚¹ãƒ†ãƒ 

# Phase 16-Bã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
timeout: '1800s'  # å…¨ä½“ã§30åˆ†ä»¥å†…å®Œäº†ï¼ˆ620ãƒ†ã‚¹ãƒˆå¯¾å¿œï¼‰