# Phase 22å®Œäº†: GCP Cloud Buildæœ€é©åŒ–è¨­å®š
# 625ãƒ†ã‚¹ãƒˆãƒ»58.64%ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»15ç‰¹å¾´é‡çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ ãƒ»è¨­å®šæœ€é©åŒ–å®Œäº†å¯¾å¿œ
#
# ğŸš€ 2025-09-14 Phase 22è¨­å®šæœ€é©åŒ–å®Œäº†:
# - unified.yamlãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º72.7%å‰Šæ¸›ãƒ»thresholds.yaml60.9%å‰Šæ¸›
# - 26ã‚­ãƒ¼é‡è¤‡å•é¡Œè§£æ±ºãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤å¼·åˆ¶å•é¡Œå®Œå…¨è§£æ±º
# - 625ãƒ†ã‚¹ãƒˆ100%æˆåŠŸãƒ»ã‚·ã‚¹ãƒ†ãƒ çœŸä¾¡ç™ºæ®ãƒ»æœ€é©åŒ–è¨­å®šæ´»ç”¨
# 
# ğŸ”§ 2025-09-07 å®Ÿç’°å¢ƒæ•´åˆæ€§å¯¾å¿œ:
# - å­˜åœ¨ã—ãªã„ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæŒ‡å®šå‰Šé™¤ï¼ˆcrypto-bot-workload-identity@...ï¼‰
# - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCompute Engine SAä½¿ç”¨ï¼ˆå®Ÿç’°å¢ƒã§é©åˆ‡ãªæ¨©é™è¨­å®šæ¸ˆã¿ï¼‰
# - CI/CD ãƒ‡ãƒ—ãƒ­ã‚¤å•é¡Œè§£æ±ºå¯¾å¿œ

steps:
  # 1. Phase 22çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆè¨­å®šæœ€é©åŒ–å®Œäº†ãƒ»å®Œå…¨å“è³ªä¿è¨¼ï¼‰
  - name: 'python:3.13-slim'
    id: 'run-phase22-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§ª Phase 22çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ï¼ˆ625ãƒ†ã‚¹ãƒˆãƒ»58.64%ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»15ç‰¹å¾´é‡çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ ï¼‰"
        
        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€å°é™ãƒ»é«˜é€ŸåŒ–ï¼‰
        pip install --upgrade pip
        pip install pytest pytest-asyncio pandas numpy ccxt pyyaml dataclasses-json
        
        # Phase 22å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        echo "ğŸ“‹ çµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆè¨­å®šæœ€é©åŒ–å®Œäº†ç‰ˆï¼‰"
        if bash scripts/testing/checks.sh; then
          echo "âœ… 625ãƒ†ã‚¹ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯æˆåŠŸãƒ»è¨­å®šæœ€é©åŒ–å‹•ä½œç¢ºèªå®Œäº†"
        else
          echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•— - ãƒ“ãƒ«ãƒ‰åœæ­¢"
          exit 1
        fi
        
        # Phase 22é‡è¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆè¨­å®šæœ€é©åŒ–ãƒ»15ç‰¹å¾´é‡çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ ï¼‰
        python -m pytest tests/unit/ -v --tb=short --maxfail=5
        python -m pytest tests/integration/ -v --tb=short --maxfail=3
        
        echo "âœ… Phase 22çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆ625ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»26ã‚­ãƒ¼é‡è¤‡å•é¡Œè§£æ±ºç¢ºèªï¼‰"
    timeout: '600s'  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ625ãƒ†ã‚¹ãƒˆå¯¾å¿œï¼‰

  # 2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:$COMMIT_SHA'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:latest'
      - '.'
    timeout: '600s'  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

  # 3. ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Artifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '--all-tags'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot'
    timeout: '300s'

  # 4. Phase 22çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè¨­å®šæœ€é©åŒ–å®Œäº†ãƒ»15ç‰¹å¾´é‡çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œï¼‰
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run-phase22'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'crypto-bot-service-prod'
      - '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:$COMMIT_SHA'
      - '--region=asia-northeast1'
      - '--platform=managed'
      - '--port=8080'
      - '--memory=1Gi'        # Phase 22æœ€é©åŒ–ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è»½é‡åŒ–å¯¾å¿œ
      - '--cpu=1'
      - '--min-instances=1'   # æœ¬ç•ªå®‰å®šæ€§ç¢ºä¿
      - '--max-instances=2'   # è² è·åˆ†æ•£å¯¾å¿œ
      - '--concurrency=1'     # å–å¼•æ•´åˆæ€§ç¢ºä¿
      - '--timeout=3600'      # 1æ™‚é–“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      - '--allow-unauthenticated'
      - '--set-env-vars=MODE=paper,LOG_LEVEL=INFO,PYTHONPATH=/app,FEATURE_MODE=optimized'
      - '--set-secrets=BITBANK_API_KEY=bitbank-api-key:latest,BITBANK_API_SECRET=bitbank-api-secret:latest,DISCORD_WEBHOOK_URL=discord-webhook-url:latest'
      # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæŒ‡å®šå‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCompute Engine SAã‚’ä½¿ç”¨ï¼‰
      # å®Ÿéš›ã®ç’°å¢ƒ: 11445303925-compute@developer.gserviceaccount.com ãŒé©åˆ‡ãªæ¨©é™ã‚’ä¿æœ‰
    timeout: '300s'

  # 5. Phase 22çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»è¨­å®šæœ€é©åŒ–ç›£è¦–é–‹å§‹
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-phase22-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Phase 22çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»è¨­å®šæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–é–‹å§‹"
        
        # ã‚µãƒ¼ãƒ“ã‚¹URLã‚’å–å¾—
        SERVICE_URL=$(gcloud run services describe crypto-bot-service-prod \
          --region=asia-northeast1 \
          --format='value(status.url)')
        
        echo "ğŸ“ Phase 22ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
        
        # Phase 22çµ±åˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§6å›ãƒªãƒˆãƒ©ã‚¤ãƒ»è¨­å®šæœ€é©åŒ–ç¢ºèªï¼‰
        for i in {1..6}; do
          if curl -f "$SERVICE_URL/health" --connect-timeout 15 --max-time 30; then
            echo "âœ… Phase 22ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç¢ºèªå®Œäº†"
            echo "ğŸ¥ è¨­å®šæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–èµ·å‹•ä¸­..."
            echo "âœ… 625ãƒ†ã‚¹ãƒˆ: 100%æˆåŠŸãƒ»çµ±åˆæ¸ˆã¿"
            echo "ğŸ“Š 58.64%ã‚«ãƒãƒ¬ãƒƒã‚¸: é”æˆæ¸ˆã¿"
            echo "ğŸ”§ è¨­å®šæœ€é©åŒ–: å®Œäº†ãƒ»26ã‚­ãƒ¼é‡è¤‡è§£æ±ºæ¸ˆã¿"
            echo "ğŸ”’ Workload Identity: èªè¨¼æ¸ˆã¿"
            echo "ğŸ“¡ Discordé€šçŸ¥: çµ±åˆæ¸ˆã¿"
            exit 0
          else
            echo "â³ Phase 22ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å†è©¦è¡Œ ($i/6) - è¨­å®šæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­..."
            sleep 15
          fi
        done
        
        echo "âŒ Phase 22ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªå¤±æ•— - æ‰‹å‹•ç¢ºèªãŒå¿…è¦"
        exit 1
    timeout: '300s'  # 5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆPhase 22çµ±åˆå¯¾å¿œï¼‰

# Phase 22ãƒ“ãƒ«ãƒ‰è¨­å®šï¼ˆ625ãƒ†ã‚¹ãƒˆå¯¾å¿œãƒ»è¨­å®šæœ€é©åŒ–å®Œäº†ï¼‰
options:
  # Phase 22é«˜é€Ÿãƒ“ãƒ«ãƒ‰ï¼ˆè¨­å®šæœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ çµ±åˆï¼‰
  machineType: 'E2_HIGHCPU_8'
  substitution_option: 'ALLOW_LOOSE'
  
  # Phase 22çµ±åˆãƒ­ã‚°è¨­å®š
  logging: 'CLOUD_LOGGING_ONLY'
  
  # Workload Identityçµ±åˆ
  env:
    - 'CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/workspace/gha-creds-*.json'

# Phase 22ç½®æ›å¤‰æ•°ï¼ˆè¨­å®šæœ€é©åŒ–çµ±åˆï¼‰
substitutions:
  # GCPè¨­å®š
  _REGION: 'asia-northeast1'
  _SERVICE_NAME: 'crypto-bot-service-prod'
  _REPO_NAME: 'crypto-bot-repo'
  
  # Phase 22ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  _MODE: 'paper'                    # paper/liveï¼ˆ2æ®µéšãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
  _MEMORY: '1Gi'                    # Phase 22æœ€é©åŒ–ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è»½é‡åŒ–å¯¾å¿œ
  _CPU: '1'
  _FEATURE_MODE: 'optimized'        # 15ç‰¹å¾´é‡çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ 

# Phase 22ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
timeout: '1800s'  # å…¨ä½“ã§30åˆ†ä»¥å†…å®Œäº†ï¼ˆ625ãƒ†ã‚¹ãƒˆå¯¾å¿œï¼‰