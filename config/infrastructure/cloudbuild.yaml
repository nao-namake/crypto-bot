# Phase 12: GCP Cloud Buildå®Œæˆè¨­å®š
# GitHub Actions CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æœ€é©åŒ–ãƒ»Workload Identityãƒ»Secret Managerãƒ»æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»æ‰‹å‹•å®Ÿè¡Œç›£è¦–çµ±åˆ

steps:
  # 1. Phase 12çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå®Œå…¨å“è³ªä¿è¨¼ï¼‰
  - name: 'python:3.11-slim'
    id: 'run-phase12-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§ª Phase 12çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ï¼ˆ316ãƒ†ã‚¹ãƒˆãƒ»68.13%ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ»dev_checkçµ±åˆï¼‰"
        
        # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ€å°é™ãƒ»é«˜é€ŸåŒ–ï¼‰
        pip install --upgrade pip
        pip install pytest pytest-asyncio pandas numpy ccxt pyyaml dataclasses-json
        
        # Phase 12çµ±åˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        echo "ğŸ“‹ å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
        if python scripts/management/dev_check.py validate --mode light; then
          echo "âœ… dev_checkçµ±åˆå“è³ªãƒã‚§ãƒƒã‚¯æˆåŠŸ"
        else
          echo "âš ï¸ å“è³ªãƒã‚§ãƒƒã‚¯è­¦å‘Š - é‡è¦ãƒ†ã‚¹ãƒˆç¶™ç¶šå®Ÿè¡Œ"
        fi
        
        # Phase 12é‡è¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆã‚·ã‚¹ãƒ†ãƒ ï¼‰
        python -m pytest tests/unit/strategies/ -v --tb=short --maxfail=3
        python -m pytest tests/unit/ml/ -v --tb=short --maxfail=3
        python -m pytest tests/unit/trading/ -v --tb=short --maxfail=3
        
        echo "âœ… Phase 12çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†"
    timeout: '480s'  # 8åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆPhase 12å¯¾å¿œï¼‰

  # 2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:$COMMIT_SHA'
      - '-t'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:latest'
      - '.'
    timeout: '600s'  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

  # 3. ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Artifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '--all-tags'
      - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot'
    timeout: '300s'

  # 4. Phase 12çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSecret Managerãƒ»Workload Identityçµ±åˆï¼‰
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-cloud-run-phase12'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'crypto-bot-service'
      - '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/crypto-bot-repo/crypto-bot:$COMMIT_SHA'
      - '--region=asia-northeast1'
      - '--platform=managed'
      - '--port=8080'
      - '--memory=2Gi'        # Phase 12æœ€é©åŒ–
      - '--cpu=1'
      - '--min-instances=1'   # Phase 12é«˜å¯ç”¨æ€§
      - '--max-instances=2'   # Phase 12æ®µéšçš„æ‹¡å¼µå¯¾å¿œ
      - '--concurrency=1'     # å–å¼•æ•´åˆæ€§ç¢ºä¿
      - '--timeout=3600'      # 1æ™‚é–“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      - '--allow-unauthenticated'
      - '--set-env-vars=MODE=paper,LOG_LEVEL=INFO,PYTHONPATH=/app,FEATURE_MODE=full,MONITORING_ENABLED=true,DEV_CHECK_INTEGRATION=true'
      - '--set-secrets=BITBANK_API_KEY=bitbank-api-key:latest,BITBANK_API_SECRET=bitbank-api-secret:latest,DISCORD_WEBHOOK_URL=discord-webhook-url:latest'
      - '--service-account=crypto-bot-workload-identity@$PROJECT_ID.iam.gserviceaccount.com'
    timeout: '300s'

  # 5. Phase 12çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»æ‰‹å‹•å®Ÿè¡Œç›£è¦–é–‹å§‹
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'verify-phase12-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Phase 12çµ±åˆãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
        
        # ã‚µãƒ¼ãƒ“ã‚¹URLã‚’å–å¾—
        SERVICE_URL=$(gcloud run services describe crypto-bot-service \
          --region=asia-northeast1 \
          --format='value(status.url)')
        
        echo "ğŸ“ Phase 12ã‚µãƒ¼ãƒ“ã‚¹URL: $SERVICE_URL"
        
        # Phase 12çµ±åˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§6å›ãƒªãƒˆãƒ©ã‚¤ãƒ»Workload Identityå¯¾å¿œï¼‰
        for i in {1..6}; do
          if curl -f "$SERVICE_URL/health" --connect-timeout 15 --max-time 30; then
            echo "âœ… Phase 12ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç¢ºèªå®Œäº†"
            echo "ğŸ¥ æ‰‹å‹•å®Ÿè¡Œç›£è¦–ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­..."
            echo "ğŸ¤– dev_checkçµ±åˆ: æœ‰åŠ¹"
            echo "ğŸ”’ Workload Identity: èªè¨¼æ¸ˆã¿"
            echo "ğŸ“¡ Discordé€šçŸ¥: çµ±åˆæ¸ˆã¿"
            exit 0
          else
            echo "â³ Phase 12ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å†è©¦è¡Œ ($i/6) - Workload Identityèªè¨¼ä¸­..."
            sleep 15
          fi
        done
        
        echo "âŒ Phase 12ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªå¤±æ•— - æ‰‹å‹•ç¢ºèªãŒå¿…è¦"
        exit 1
    timeout: '300s'  # 5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆPhase 12çµ±åˆå¯¾å¿œï¼‰

# Phase 12ãƒ“ãƒ«ãƒ‰è¨­å®šï¼ˆæœ€é©åŒ–ãƒ»é«˜é€ŸåŒ–ï¼‰
options:
  # Phase 12é«˜é€Ÿãƒ“ãƒ«ãƒ‰ï¼ˆ20%é«˜é€ŸåŒ–ï¼‰
  machineType: 'E2_HIGHCPU_8'
  substitution_option: 'ALLOW_LOOSE'
  
  # Phase 12çµ±åˆãƒ­ã‚°è¨­å®š
  logging: 'CLOUD_LOGGING_ONLY'
  
  # Workload Identityçµ±åˆ
  env:
    - 'CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=/workspace/gha-creds-*.json'

# Phase 12ç½®æ›å¤‰æ•°ï¼ˆçµ±åˆè¨­å®šï¼‰
substitutions:
  # GCPè¨­å®š
  _REGION: 'asia-northeast1'
  _SERVICE_NAME: 'crypto-bot-service'
  _REPO_NAME: 'crypto-bot-repo'
  
  # Phase 12ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  _MODE: 'paper'                    # paper/liveï¼ˆæ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾å¿œï¼‰
  _MEMORY: '2Gi'                    # Phase 12æœ€é©åŒ–
  _CPU: '1'
  _FEATURE_MODE: 'full'             # 12ç‰¹å¾´é‡ã‚·ã‚¹ãƒ†ãƒ 
  _MONITORING_ENABLED: 'true'       # æ‰‹å‹•å®Ÿè¡Œç›£è¦–
  _DEV_CHECK_INTEGRATION: 'true'    # dev_checkçµ±åˆ

# Phase 12ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
timeout: '1500s'  # å…¨ä½“ã§25åˆ†ä»¥å†…å®Œäº†ï¼ˆPhase 12çµ±åˆå¯¾å¿œï¼‰