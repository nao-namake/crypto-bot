# Phase 59: 戦略改善・信頼度修正期

**期間**: 2026年1月13日
**目的**: Phase 58.6バックテスト分析に基づく戦略最適化

---

## 概要

Phase 58.5/58.6のTP/SL変更後のバックテスト分析により、戦略とML信頼度設定を最適化。
BBReversal改修と信頼度逆転問題の修正を実施。

---

## 分析結果（Phase 58.6バックテスト）

### 全体パフォーマンス

| 指標 | Phase 58.4 | Phase 58.6 | 改善率 |
|------|-----------|-----------|--------|
| 総損益 | ¥+23,073 | ¥+35,105 | +52% |
| PF | 1.18 | 1.38 | +17% |
| 勝率 | 44.7% | 50.9% | +6.2pt |
| 取引数 | 501件 | 589件 | +18% |

### 戦略別パフォーマンス（Phase 58.6）

| 戦略 | 取引数 | 勝率 | 損益 | 状態 |
|------|--------|------|------|------|
| ATRBased | 320 | 54.1% | +¥29,192 | 最優秀 |
| DonchianChannel | 110 | 49.1% | +¥6,711 | 黒字化 |
| StochasticDivergence | 98 | 47.0% | +¥1,533 | 安定 |
| MACDEMACrossover | 47 | 46.8% | -¥1,000 | 微損 |
| BBReversal | 14 | 50.0% | -¥1,331 | 要改修 |

### TP/SL変更の効果

| 戦略 | 変更前勝率 | 変更後勝率 | 変更前損益 | 変更後損益 |
|------|-----------|-----------|-----------|-----------|
| BBReversal | 8.3% | 50.0% | ¥-5,451 | ¥-1,331 |
| DonchianChannel | 42.0% | 49.1% | ¥-3,560 | ¥+6,711 |
| ATRBased | 47.0% | 54.1% | ¥+13,000 | ¥+29,192 |

---

## Phase 59.1: BBReversal normal_range無効化

### 背景

BBReversalのレジーム別パフォーマンス分析：

| レジーム | 取引数 | 勝率 | 損益 | 判断 |
|---------|--------|------|------|------|
| tight_range | 12件 | 58.3% | +¥379 | 維持 |
| normal_range | 2件 | 0% | -¥1,710 | 無効化 |

**根本原因**: normal_rangeで2件中2件がSL発動（100%敗北）

### 実装内容

```yaml
# config/core/thresholds.yaml
dynamic_strategy_selection:
  regime_strategy_mapping:
    normal_range:
      ATRBased: 0.50            # 0.40→0.50（主力強化）
      BBReversal: 0.0           # 0.25→0.0（無効化）
      StochasticReversal: 0.30  # 0.25→0.30
      DonchianChannel: 0.20     # 0.10→0.20（黒字化）
```

### 期待効果

- BBReversal損益改善: +¥1,710
- BBReversal損益: ¥-1,331 → ¥+379

---

## Phase 59.2: 信頼度逆転問題修正

### 背景

| 信頼度帯 | 取引数 | 勝率 |
|---------|--------|------|
| 低（<50%） | 136件 | 51.5% |
| 高（≥65%） | 44件 | 45.5% |

**問題**: 高信頼度帯の勝率が低信頼度帯より低い逆転現象

### 原因分析

```yaml
# 変更前の設定
ml_integration:
  disagreement_penalty: 0.96   # 弱すぎる（4%減）
  agreement_bonus: 1.18        # 強すぎる（18%増）
```

高信頼度時にMLを過信してポジションサイズ増加 → 負け時の損失拡大

### 実装内容

```yaml
# config/core/thresholds.yaml
regime_ml_integration:
  tight_range:
    high_confidence_threshold: 0.70   # 0.60→0.70
    agreement_bonus: 1.10             # 1.18→1.10
    disagreement_penalty: 0.80        # 0.96→0.80

  normal_range:
    high_confidence_threshold: 0.65   # 0.55→0.65
    agreement_bonus: 1.10             # 1.22→1.10
    disagreement_penalty: 0.80        # 0.96→0.80
```

### 期待効果

- 高信頼度帯の勝率改善（45.5% → 50%+）
- PF改善: 1.38 → 1.42+

---

## Phase 59.3: DonchianChannel（対応不要）

### 旧計画との差異

| 項目 | 旧計画（Phase 58.4時点） | 新分析（Phase 58.6） |
|------|------------------------|---------------------|
| 勝率 | 42.0% | 49.1% |
| 損益 | ¥-3,560 | ¥+6,711 |
| 判断 | 無効化予定 | **維持** |

**結論**: TP/SL変更により黒字化。無効化計画を撤回。

---

## 修正ファイル一覧

| ファイル | 修正内容 |
|---------|---------|
| `config/core/thresholds.yaml` | BBReversal normal_range無効化 |
| `config/core/thresholds.yaml` | 信頼度penalty/bonus調整 |
| `tests/unit/services/test_dynamic_strategy_selector.py` | テスト期待値更新 |
| `docs/開発計画/ToDo.md` | Phase 59計画反映 |

---

## テスト結果

| 項目 | 結果 |
|------|------|
| pytest | 1,195件全て通過 |
| flake8 | PASS |
| black | PASS |
| isort | PASS |
| カバレッジ | 62.17% |

---

## バックテスト結果

**実行**: GitHub Actions（run ID: 20954469350）
**完了**: 2026年1月14日

### 全体パフォーマンス

| 指標 | Phase 58.6 | Phase 59 | 改善 |
|------|-----------|----------|------|
| 総損益 | ¥+35,105 | **¥+35,955** | **+¥850 (+2.4%)** |
| PF | 1.38 | **1.39** | **+0.01** |
| 勝率 | 50.9% | 50.9% | ±0% |
| 最大DD | - | 1.55% | - |

### 戦略別パフォーマンス

| 戦略 | 取引数 | 勝率 | 損益 |
|------|--------|------|------|
| ATRBased | 321件 | 54.2% | ¥+30,381 |
| DonchianChannel | 110件 | 49.1% | ¥+6,711 |
| StochasticReversal | 71件 | 42.3% | ¥+179 |
| ADXTrendStrength | 75件 | 48.0% | ¥+15 |
| BBReversal | 14件 | 50.0% | ¥-1,330 |

### 信頼度逆転問題（未解決）

| 指標 | Phase 58.6 | Phase 59 |
|------|-----------|----------|
| 高信頼度勝率（≥65%） | 45.5% | 45.5% |
| 低信頼度勝率（<50%） | 51.5% | 51.6% |

**結論**: Phase 59.2のpenalty/bonus調整では信頼度逆転問題は解消しなかった

---

## 撤回・変更した計画

| 旧計画 | 新方針 | 理由 |
|--------|--------|------|
| DonchianChannel無効化 | 維持 | TP/SL変更で黒字化（+¥6,711） |
| BBReversal完全無効化 | normal_range限定無効化 | tight_rangeで機能（58.3%勝率） |

---

## 教訓

### TP/SL設定の重要性

Phase 58.5/58.6のTP/SL変更（0.8%/0.6% → 0.4%/0.3%）により：
- BBReversal勝率: 8.3% → 50.0%
- DonchianChannel: 赤字 → 黒字（+¥10,271改善）
- 全体PF: 1.18 → 1.38

**結論**: 戦略無効化の前にTP/SL最適化を検討すべき

### レジーム別分析の価値

BBReversalの全体パフォーマンス（50%勝率、¥-1,331）だけでは判断を誤る。
レジーム別分析により：
- tight_range: 58.3%勝率、+¥379（有効）
- normal_range: 0%勝率、-¥1,710（無効化対象）

**結論**: 戦略はレジーム別に評価・最適化すべき

---

**最終更新**: 2026年1月14日
**ステータス**: Phase 59完了・バックテスト検証済み
