# Phase 60: 実効レバレッジ最適化期

**期間**: 2026年1月19日〜
**目的**: 実効レバレッジ引き上げによる収益最大化

---

## 概要

Phase 59完了時点で過去最高のパフォーマンス（PF 1.60、年利22.9%相当）を達成。
しかし実効レバレッジが0.15倍と非常に保守的であり、DD許容10%に対して余裕がありすぎる状態。
レバレッジを段階的に引き上げ、リスク・リターンの最適化を図る。

---

## 現状分析（Phase 59完了時点）

### 実績データ（1週間・ライブ運用）

| 項目 | 値 |
|------|-----|
| 証拠金 | 約33万円 |
| 平均ポジション価値 | ¥48,765 |
| **実効レバレッジ** | **0.15倍**（非常に保守的） |
| エントリー数 | 30回/週 |

### バックテスト結果（183日間）

| 指標 | 値 |
|------|-----|
| 総損益 | ¥+54,526 |
| PF | 1.60 |
| 勝率 | 53.2% |
| 最大DD | 1.49% |
| 年利換算 | 22.9% |

### 課題

- **DD 1.49%** は目標上限10%の**15%**しか使っていない
- リスク許容度に対して非常に保守的
- 年利22.9%は良好だが、リスク対比で改善余地あり

---

## Phase 60.1: 実効レバレッジ0.5倍移行

**実施日**: 2026年1月19日
**コミット**: `0fddf670`

### 目標

| 項目 | 変更前 | 変更後 | 倍率 |
|------|--------|--------|------|
| 実効レバレッジ | 0.15倍 | 0.5倍 | 3.3倍 |
| 期待DD | 1.5% | 5% | 3.3倍 |
| 期待年利 | 23% | 75% | 3.3倍 |

### 発見事項

**`unified.yaml`の`leverage: 1.0`は設定ファイルにあるだけで、コード内で参照されていない**

実際のポジションサイズは`thresholds.yaml`の複数パラメータで制御されている。

### 修正内容（14箇所）

すべて`config/core/thresholds.yaml`内：

| # | パラメータ | 変更前 | 変更後 |
|---|-----------|--------|--------|
| 1 | `production.max_order_size` | 0.05 | 0.15 |
| 2 | `kelly_criterion.max_position_ratio` | 0.35 | 1.00 |
| 3 | `initial_position_size` | 0.005 | 0.015 |
| 4 | `position_sizing.max_position_ratio` | 0.35 | 1.00 |
| 5 | `risk.max_capital_usage` | 0.5 | 1.5 |
| 6 | `max_position_ratio_per_trade.low_confidence` | 0.25 | 0.80 |
| 7 | `max_position_ratio_per_trade.medium_confidence` | 0.35 | 1.00 |
| 8 | `max_position_ratio_per_trade.high_confidence` | 0.50 | 1.50 |
| 9 | `dynamic_position_sizing.low_confidence.min_ratio` | 0.10 | 0.30 |
| 10 | `dynamic_position_sizing.low_confidence.max_ratio` | 0.20 | 0.60 |
| 11 | `dynamic_position_sizing.medium_confidence.min_ratio` | 0.15 | 0.45 |
| 12 | `dynamic_position_sizing.medium_confidence.max_ratio` | 0.25 | 0.75 |
| 13 | `dynamic_position_sizing.high_confidence.min_ratio` | 0.20 | 0.60 |
| 14 | `dynamic_position_sizing.high_confidence.max_ratio` | 0.35 | 1.05 |

### 追加対応

1. **テスト修正**: `test_capital_usage_limits`を`max_capital_usage: 1.5`に対応
2. **ドキュメント追加**: `config/core/README.md`にレバレッジ変更ガイドを追加
   - 14箇所の修正箇所一覧表
   - スケーリング計算式
   - 0.15倍/0.5倍/1.0倍の値対応表

### 期待効果（シミュレーション）

| 指標 | 0.15倍（現在） | 0.5倍（目標） |
|------|---------------|--------------|
| 期待リターン | ¥+54,526 | **¥+180,000** |
| 最大DD | 1.49% | **約5%** |
| 年利換算 | 22.9% | **約75%** |
| 1回あたり損失 | ¥200前後 | **¥660前後** |
| 1回あたり利益 | ¥300前後 | **¥1,000前後** |

### 検証基準

| 指標 | 許容範囲 | NG条件 |
|------|---------|--------|
| 最大DD | 7%以下 | 7%超過 |
| PF | 1.40以上 | 1.40未満 |
| 総損益 | ¥+120,000以上 | ¥+120,000未満 |

### バックテスト結果

**ステータス**: ⏳ 実行中（GitHub Actions）
**URL**: https://github.com/nao-namake/crypto-bot/actions/runs/21118646342

<!-- バックテスト完了後に結果を記入 -->

---

## Phase 60.2: 稼働率計算修正 ✅完了

**実施日**: 2026年1月19日

### 背景

ライブモード分析で稼働率73.8%と表示されていたが、実際はシステム正常稼働中。
原因は稼働率計算の期待値が実態と乖離していた。

### 原因分析

| 項目 | 設定値 | 実測値 |
|------|--------|--------|
| 待機時間 | 300秒（5分） | 300秒 |
| 処理時間 | - | 約120秒（2分） |
| **実際の間隔** | 5分想定 | **7分** |

`live_trading_runner.py`で処理完了**後**に5分待機するため、実際の間隔は「処理時間+待機時間」になっていた。

### 実施内容

`scripts/live/standard_analysis.py`の稼働率計算を修正：

```python
# 修正前
expected_runs = self.period_hours * 12  # 1時間に12回（5分間隔）

# 修正後
runs_per_hour = 60 / 7  # 約8.57回/時間（7分間隔）
expected_runs = int(self.period_hours * runs_per_hour)
```

### 結果

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| 期待実行回数(48h) | 576回 | 411回 |
| 実際実行回数 | 425回 | 426回 |
| **稼働率** | **73.8%** | **100.0%** |

### 補足

15分足ベースの取引では5分と7分の差は実質影響なし。
コードの修正（処理開始からの経過時間でスリープ）は見送り、計算側で対応。

---

## Phase 60.3: Walk-Forward検証実装 ✅完了

**実施日**: 2026年1月19日
**コミット**: `08359753`, `15863e15`, `c4baef41`

### 背景

現在のバックテストは訓練データとテストデータが100%重複（2025/7-12月）しており、ML予測部分の信頼性が低い。Walk-Forward検証を実装し、過学習を排除した信頼できるバックテスト結果を得る。

### 実装内容

| ファイル | 内容 |
|---------|------|
| `scripts/backtest/walk_forward_validation.py` | メイン検証スクリプト |
| `scripts/backtest/wf_config.yaml` | 設定ファイル |
| `.github/workflows/walk_forward.yml` | GitHub Actionsワークフロー |
| `docs/検証記録/walk_forward/` | 結果出力ディレクトリ |

### ウィンドウ構成

データ期間: 2025-07-01 〜 2025-12-31（183日）
設定: Train 60日、Test 30日、Step 30日

| Window | Train期間 | Test期間 |
|--------|----------|----------|
| 1 | 7/1 - 8/30 | 8/31 - 9/29 |
| 2 | 7/31 - 9/29 | 9/30 - 10/29 |
| 3 | 8/30 - 10/29 | 10/30 - 11/28 |
| 4 | 9/29 - 11/28 | 11/29 - 12/28 |

### 処理フロー

```
1. 設定読み込み・データロード
2. ウィンドウ生成（4ウィンドウ）
3. 各ウィンドウで順次実行:
   ├─ 訓練データ抽出
   ├─ MLモデル訓練（NewSystemMLModelCreator使用）
   ├─ テスト期間でバックテスト実行
   └─ 結果収集
4. 全ウィンドウ結果集計
5. レポート生成（JSON + Markdown）
```

### 検証基準

| 指標 | 良好 | 注意 | 危険 |
|------|------|------|------|
| PF標準偏差 | < 0.2 | 0.2-0.4 | > 0.4 |
| 全Window PF | 全て > 1.0 | 1つ < 1.0 | 複数 < 1.0 |
| WF vs Full差 | < 10% | 10-20% | > 20% |

### 使用方法

```bash
# GitHub Actionsから実行
# Actions → Walk-Forward Validation → Run workflow

# ドライラン（ウィンドウ確認のみ）
python scripts/backtest/walk_forward_validation.py --dry-run
```

### 実行結果

**ステータス**: ✅ 完了
**URL**: https://github.com/nao-namake/crypto-bot/actions/runs/21119429243

GitHub ActionsでWalk-Forward検証ワークフローを正常実行できる環境を整備完了。

---

## Phase 60.4: ML重み削減・戦略重視設定 ✅完了

**実施日**: 2026年1月20日

### 背景

バックテスト詳細分析結果（2026/01/18 CI結果）:

| 指標 | 値 | 評価 |
|------|-----|------|
| 総取引数 | 347件 | 少ない（目標400+） |
| 勝率 | 55.6% | 良好 |
| 総損益 | ¥+86,660 | 良好 |
| PF | 1.58 | 良好 |

### 根本問題: ML・戦略一致率 51.9%

| 状態 | 取引数 | 勝率 | 平均損益 |
|------|--------|------|----------|
| **一致時** | 180件 | **66.1%** | +¥496 |
| **不一致時** | 167件 | **42.5%** | -¥16 |

MLがまだ未熟で、戦略の方が信頼性が高い状態。一致率51.9%は低い（目標70%+）。

### 修正内容（方向性A: ML重み削減）

**ファイル**: `config/core/thresholds.yaml`

#### Step 1: ML閾値ロールバック

| 設定 | 変更前 | 変更後 |
|------|--------|--------|
| tight_range.min_ml_confidence | 0.25 | **0.33** |
| tight_range.high_confidence_threshold | 0.60 | **0.70** |
| normal_range.min_ml_confidence | 0.22 | **0.30** |
| normal_range.high_confidence_threshold | 0.55 | **0.65** |

**理由**: 信頼度0.25はランダム以下（3クラス=33%）

#### Step 2: ML重み削減・戦略重視

| 設定 | 変更前 | 変更後 |
|------|--------|--------|
| tight_range.ml_weight | 0.25 | **0.15** |
| tight_range.strategy_weight | 0.75 | **0.85** |
| normal_range.ml_weight | 0.30 | **0.20** |
| normal_range.strategy_weight | 0.70 | **0.80** |

**理由**: ML・戦略一致率51.9%、不一致時勝率42.5%なのでML依存を減らす

#### Step 3: 一致ボーナス強化・不一致ペナルティ強化

| 設定 | 変更前 | 変更後 |
|------|--------|--------|
| tight_range.agreement_bonus | 1.10 | **1.25** |
| tight_range.disagreement_penalty | 0.80 | **0.70** |
| normal_range.agreement_bonus | 1.10 | **1.25** |
| normal_range.disagreement_penalty | 0.80 | **0.70** |

**理由**: 一致時勝率66.1%を活かし、不一致時（勝率42.5%）の取引を抑制

### 期待効果

| 指標 | 変更前 | 期待 |
|------|--------|------|
| ML・戦略一致率 | 51.9% | 60%+ |
| 一致時取引 | 180件 | 220件+ |
| 不一致時取引 | 167件 | 100件以下 |
| 勝率 | 55.6% | 58%+ |
| 総損益 | ¥+86,660 | ¥+95,000+ |

### 検証方法

```bash
# バックテスト実行後に確認
python3 scripts/backtest/standard_analysis.py --from-ci

# 確認項目:
# - ML・戦略一致率: 60%以上
# - 勝率: 55%以上維持
# - PF: 1.5以上維持
# - 総損益: ¥+90,000以上
```

---

## Phase 60.5: MLモデル差別化による性能向上 ✅完了

**実施日**: 2026年1月20日

### 背景

3つのMLモデル（LightGBM, XGBoost, RandomForest）が同一シード値（42）で学習されており、アンサンブルの多様性が不足している問題を発見。

### 問題点

| 問題 | 現状 | 影響 |
|------|------|------|
| **同一シード値** | 全モデル `random_state=42` | 多様性なし |
| **特徴量サンプリングなし** | LightGBM/XGBoostで未設定 | 同じ特徴量セットで学習 |
| **固定重み** | LGB:0.4, XGB:0.4, RF:0.2 | 性能に基づかない |
| **検証不足** | モデル間多様性検証なし | 問題検出不可 |

### 実装内容

#### 1. モデル差別化（シード・特徴量サンプリング）

**config/core/thresholds.yaml**:

| モデル | パラメータ | 変更前 | 変更後 |
|--------|-----------|--------|--------|
| LightGBM | `random_state` | 42 | **42**（維持） |
| LightGBM | `feature_fraction` | 0.9 | **0.7** |
| XGBoost | `random_state` | 42 | **123** |
| XGBoost | `colsample_bytree` | 0.8 | **0.7** |
| RandomForest | `random_state` | 42 | **456** |
| RandomForest | `max_features` | - | **sqrt** |

#### 2. モデル多様性検証機能

**scripts/testing/validate_ml_models.py**:
- `validate_model_diversity()`: 新規メソッド追加
- `--check diversity` オプション追加

検証項目:
1. モデル間予測一致率（Agreement Rate）
2. 予測確率の相関係数
3. モデル別予測分布
4. シード値確認

#### 3. 性能ベース動的重み計算

**scripts/ml/create_ml_models.py**:
- `_calculate_optimal_weights()`: F1スコアに基づく重み計算
- `_create_ensemble()`: 動的重み設定対応

重み計算ロジック:
```python
# 各モデルのF1スコアを正規化して重みを計算
# 最小重み0.1以上を保証
# 合計1.0に正規化
```

### 修正ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `config/core/thresholds.yaml` | モデル別シード値・特徴量サンプリング設定追加 |
| `scripts/ml/create_ml_models.py` | `_initialize_models()`差別化、動的重み計算追加 |
| `src/ml/models.py` | 各モデルクラスのシード取得ロジック変更 |
| `scripts/testing/validate_ml_models.py` | `validate_model_diversity()`追加 |
| `tests/unit/ml/models/test_rf_model.py` | デフォルトシード期待値更新 |
| `tests/unit/ml/models/test_xgb_model.py` | デフォルトシード期待値更新 |

### 検証方法

```bash
# モデル再訓練
python scripts/ml/create_ml_models.py --n-trials 20

# 多様性検証
python scripts/testing/validate_ml_models.py --check diversity

# バックテスト
python3 main.py --mode backtest
python3 scripts/backtest/standard_analysis.py --from-ci
```

### 期待効果

| 指標 | 現状（推定） | 目標 |
|------|-------------|------|
| 3モデル全一致率 | 75-85% | **55-65%** |
| モデル間確率相関 | 0.90+ | **0.70-0.85** |
| アンサンブルF1 | 0.41 | **0.45+** |
| ML・戦略一致率 | 51.9% | **60%+** |

### 検証基準

| 指標 | 良好 | 警告 |
|------|------|------|
| 3モデル全一致率 | < 70% | >= 70% |
| モデル間確率相関 | < 0.95 | >= 0.95 |
| シード値 | 全て異なる | 同一値あり |

### ステータス

**実装**: ✅ 完了
**品質チェック**: ✅ 全件パス（1,256テスト）
**モデル再訓練**: ✅ 完了（60.5-C参照）
**多様性検証**: ✅ 完了

---

## Phase 60.5-B: create_ml_models.py整理・軽量化 ✅完了

**実施日**: 2026年1月20日

### 背景

Phase 59.10でStacking無効化が決定されたが、`scripts/ml/create_ml_models.py`には約400行のStacking関連コードが残存していた。保守性向上のため削除。

### 削除内容

| 項目 | 行数 | 理由 |
|------|------|------|
| `_generate_oof_predictions()` | 77行 | Stacking専用 |
| `_clone_model()` | 26行 | Stacking専用 |
| `_add_enhanced_meta_features()` | 89行 | Stacking専用 |
| `_train_meta_learner()` | 137行 | Stacking専用 |
| `_train_stacking_ensemble()` | 70行 | Stacking専用 |
| `_generate_sample_data()` | 36行 | **未使用**（呼び出し箇所なし） |
| `StackingEnsemble` import | 1行 | 未使用 |
| `--stacking` 引数 | 6行 | 未使用 |
| 未使用インポート | 2行 | `DataRequest`, `TimeFrame` |

### 結果

| 項目 | 変更前 | 変更後 | 削減 |
|------|--------|--------|------|
| ファイル行数 | 2,149行 | **1,659行** | **490行（23%削減）** |

### 追加作業

- 旧Stackingモデルファイル削除
  - `models/production/stacking_ensemble.pkl`
  - `models/production/meta_learner.pkl`

---

## Phase 60.5-C: 本番モデル再学習・性能評価 ✅完了

**実施日**: 2026年1月20日

### 本番モデル学習

```bash
python scripts/ml/create_ml_models.py --optimize --n-trials 50 --days 180 --verbose
```

**学習時間**: 約42分
**学習データ**: 15,393サンプル（180日分）

### 学習結果

#### Full モデル（55特徴量）

| モデル | Test F1 | CV F1 | 動的重み |
|--------|---------|-------|---------|
| LightGBM | 0.459 | 0.411±0.025 | 33.0% |
| XGBoost | 0.463 | 0.412±0.025 | 33.3% |
| RandomForest | 0.467 | 0.406±0.020 | **33.7%** |

#### Basic モデル（49特徴量）

| モデル | Test F1 | CV F1 | 動的重み |
|--------|---------|-------|---------|
| LightGBM | 0.453 | 0.414±0.020 | 33.3% |
| XGBoost | 0.454 | 0.409±0.023 | 33.3% |
| RandomForest | 0.454 | 0.416±0.026 | 33.4% |

### モデル検証結果（validate_ml_models.py）

| 項目 | 結果 |
|------|------|
| 特徴量整合性 | ✅ 55特徴量一致 |
| 3クラス分類 | ✅ BUY/HOLD/SELL |
| クラスバランス | ✅ SELL 23%, HOLD 45%, BUY 32% |
| 信頼度平均 | 41% |
| 信頼度最大 | **51%** |
| 高信頼度(>60%) | **0%** |

### 性能の正直な評価

#### F1=0.46の意味

| 基準 | F1値 |
|------|------|
| ランダム（3クラス） | 0.33 |
| **現在のモデル** | **0.46** |
| 理想的 | 0.60+ |

**評価**: ランダムよりマシだが、「優秀」とは言えない

#### 高信頼度予測0%の問題

モデルは**どの予測にも確信を持てていない**状態。
信頼度最大51%は、MLが「たぶんBUYかな...でもHOLDかも」という曖昧な予測ばかり。

### 15分足取引における評価

#### 時間軸による予測難易度

| 時間軸 | 予測難易度 | 現実的なF1 |
|--------|-----------|-----------|
| 1分足 | ほぼ不可能 | 0.33-0.35 |
| 5分足 | 極めて困難 | 0.34-0.38 |
| **15分足** | **困難** | **0.38-0.45** |
| 1時間足 | やや困難 | 0.42-0.50 |
| 4時間足 | 中程度 | 0.45-0.55 |

**結論**: 15分足でF1=0.46は**実は良い方**

#### なぜ15分足は難しいのか

```
15分足で予測可能なパターン
      ↓
高頻度取引業者がミリ秒で検出
      ↓
即座に裁定される
      ↓
残っているのは「予測不能なノイズ」のみ
```

### 現在の戦略・MLバランスの評価

#### レジーム別設定（Phase 60.4）

| レジーム | ML重み | 戦略重み | 評価 |
|---------|--------|---------|------|
| tight_range | 15% | 85% | ✅ 適切 |
| normal_range | 20% | 80% | ✅ 適切 |
| trending | 35% | 65% | ✅ 適切 |
| high_volatility | 10% | 90% | ✅ 適切 |

#### MLの役割

```
現在の設計:
  アクション（buy/sell/hold）→ 戦略が決定
  MLの役割 → 信頼度の調整（フィルター）

これは15分足Botとして合理的な設計
```

### 結論: 落とし所としての妥当性

| 観点 | 評価 |
|------|------|
| ML単体の性能 | 「可もなく不可もなく」 |
| 15分足での位置づけ | 理論的限界に近い |
| 戦略とのバランス | 合理的（戦略主導+MLフィルター） |
| 改善余地 | ROI低い（費用対効果悪い） |

**最終評価**:
```
15分足取引において、F1=0.46は
「これ以上は本質的に難しい」領域

現在のシステム設計（戦略主導+MLフィルター）は
15分足の特性を考慮した合理的な落とし所
```

### 推奨アクション

| 優先度 | アクション |
|--------|-----------|
| **高** | 現状維持 + 週次再学習 |
| **中** | 戦略との一致率モニタリング |
| **低** | MLの役割を「拒否権」に限定する検討 |
| **不要** | F1=0.55を目指す最適化 |

---

## 学習事項

### レバレッジ設定の実態

1. `unified.yaml`の`leverage`設定は**未使用**
2. 実効レバレッジは複数パラメータの組み合わせで決まる
3. 変更時は14箇所を一括修正する必要がある

### レバレッジ変更時のチェックリスト

1. `thresholds.yaml`の14箇所を修正
2. `test_capital_usage_limits`テストを更新
3. バックテストで事前検証（DD 7%以下を確認）
4. 本番デプロイ後は1週間のモニタリング推奨

---

## 関連ドキュメント

- [config/core/README.md](../../config/core/README.md) - レバレッジ変更ガイド
- [Phase_59.md](Phase_59.md) - 前Phase（Stacking無効化・PE採用）
- [SUMMARY.md](SUMMARY.md) - 全Phase総括

---

## Phase 60.6: MLモデル Phase 60.4 復元 ⚠️部分成功

**実施日**: 2026年1月22日
**コミット**: `089b9668`

### 背景

Phase 60.5でMLモデルを改修したところ、バックテスト性能が大幅に低下。
A/Bテストの結果、Phase 60.4設定が最適と判明したため復元を実施。

| 指標 | Phase 60.4 | Phase 60.5 | 差分 |
|------|-----------|-----------|------|
| 総損益 | ¥86,639 | ¥68,538 | -¥18,101 (-21%) |
| PF | 1.58 | 1.51 | -0.07 |

### Phase 60.5での変更点（復元対象）

| 項目 | Phase 60.4 | Phase 60.5 |
|------|-----------|-----------|
| lgbm.feature_fraction | 0.9 | 0.7 |
| xgb.random_state | 42 | 123 |
| xgb.colsample_bytree | 0.8 | 0.7 |
| rf.random_state | 42 | 456 |
| モデル重み | 固定 40/40/20 | 動的計算 |

### 実装内容

#### 1. thresholds.yaml 復元

```yaml
models:
  lgbm:
    random_state: 42
    feature_fraction: 0.9      # 0.7→0.9
  xgb:
    random_state: 42           # 123→42
    colsample_bytree: 0.8      # 0.7→0.8
  rf:
    random_state: 42           # 456→42
```

#### 2. create_ml_models.py 固定重み化

```python
# 動的重み計算を固定重みに変更
fixed_weights = {
    "lightgbm": 0.4,
    "xgboost": 0.4,
    "random_forest": 0.2,
}
```

### モデル性能比較

| モデル | 指標 | Phase 60.4 Archive | Phase 60.6 Current |
|--------|------|-------------------|-------------------|
| LightGBM | F1 | 0.452 | 0.451 |
| XGBoost | F1 | 0.439 | **0.457** (+0.018) |
| RandomForest | F1 | 0.461 | 0.460 |

### バックテスト結果

| 指標 | Phase 60.4 | Phase 60.5 | Phase 60.6 | 評価 |
|------|-----------|-----------|-----------|------|
| 総損益 | ¥86,639 | ¥68,538 | **¥74,813** | △ 改善も未達 |
| PF | 1.58 | 1.51 | **1.46** | △ 低下 |
| 勝率 | - | - | 55.1% | - |
| 取引数 | 347 | - | 336 | - |

### 考察

1. **Phase 60.5より改善**: +¥6,275（+9%）
2. **Phase 60.4に未達**: -¥11,826（-14%）
3. **原因推定**:
   - Optuna再最適化によるハイパーパラメータ変動
   - データ期間の微妙な違い
   - モデルの確率的変動

### 維持した変更（Phase 60.5から継承）

- Stacking削除（モデルサイズ82%削減効果を維持）
- 設定ファイル駆動型設計
- コード削減（490行削減済み）

### ステータス

- **設定復元**: ✅ 完了
- **モデル再学習**: ✅ 完了
- **バックテスト**: ✅ 完了
- **目標達成**: ⚠️ 部分達成（Phase 60.5より改善、60.4未達）

---

**最終更新**: 2026年1月22日 - Phase 60.6 MLモデル復元（部分成功）
