# ğŸš¨ AIè‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ ç·Šæ€¥å¯¾å¿œãƒãƒ‹ãƒ¥ã‚¢ãƒ«

**æœ€çµ‚æ›´æ–°**: 2025å¹´9æœˆ23æ—¥ - Claude Codeå®Ÿè¡Œå¯¾å¿œãƒ»macOSå®Œå…¨å¯¾å¿œ

## âš ï¸ é‡è¦: ã¾ãšREADME.mdã‚’èª­ã‚“ã§ãã ã•ã„

**ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€å¿…ãš [README.md](./README.md) ã‚’å…ˆã«èª­ã‚“ã§å…¨ä½“ã®æ§‹æˆãƒ»å®Ÿè¡Œé †åºãƒ»æ¨å¥¨ãƒ•ãƒ­ãƒ¼ã‚’ç†è§£ã—ã¦ãã ã•ã„ã€‚**

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€AIè‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸéš›ã®ç·Šæ€¥å¯¾å¿œæ‰‹é †ã‚’ã¾ã¨ã‚ãŸãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã™ã€‚å•é¡Œã®ç¨®é¡åˆ¥ã«å³åº§å®Ÿè¡Œå¯èƒ½ãªä¿®æ­£ã‚³ãƒãƒ³ãƒ‰ã¨æ‰‹é †ã‚’æä¾›ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã®è¿…é€Ÿãªå¾©æ—§ã‚’æ”¯æ´ã—ã¾ã™ã€‚

## ğŸ¯ å¯¾å¿œå¯èƒ½ãªå•é¡Œ

- ğŸ’€ **Secret Manageræ¨©é™å•é¡Œ**: APIèªè¨¼å¤±æ•—ãƒ»æ¨©é™æ¬ å¦‚
- ğŸ” **Silent Failure**: ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆã•ã‚Œã‚‹ã‚‚æ³¨æ–‡å®Ÿè¡Œåœæ­¢
- ğŸ”¥ **Containerå•é¡Œ**: exit(1)é »ç™ºãƒ»async/await ã‚¨ãƒ©ãƒ¼
- ğŸ“¨ **Discordé€šçŸ¥åœæ­¢**: Webhook Tokenç„¡åŠ¹ãƒ»é€šçŸ¥å¤±æ•—
- ğŸ¤– **MLäºˆæ¸¬åœæ­¢**: ProductionEnsembleãƒ»ãƒ¢ãƒ‡ãƒ«å•é¡Œ
- âš¡ **ã‚·ã‚¹ãƒ†ãƒ å¿œç­”åœæ­¢**: ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢ãƒ»ãƒªã‚½ãƒ¼ã‚¹ä¸è¶³

## ğŸ“‚ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **[01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.md](./01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.md)** - åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ï¼ˆäº‹å‰ãƒã‚§ãƒƒã‚¯ï¼‰
- **[02_Botæ©Ÿèƒ½è¨ºæ–­.md](./02_Botæ©Ÿèƒ½è¨ºæ–­.md)** - Botæ©Ÿèƒ½è¨ºæ–­ï¼ˆè©³ç´°åˆ†æï¼‰

## âš ï¸ ä½¿ç”¨æ–¹æ³•

1. **è¨ºæ–­ãƒ•ã‚¡ã‚¤ãƒ«ã§å•é¡Œç‰¹å®š**: 01/02ã§å•é¡Œã‚’ç‰¹å®šã—ã¦ã‹ã‚‰ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ä½¿ç”¨
2. **å•é¡Œåˆ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³**: è©²å½“ã™ã‚‹å•é¡Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
3. **æ®µéšçš„å®Ÿè¡Œ**: è»½å¾®ãªå¯¾å¿œã‹ã‚‰é †ç•ªã«å®Ÿè¡Œ
4. **åŠ¹æœç¢ºèª**: ä¿®æ­£å¾Œã¯å¿…ãšè¨ºæ–­ãƒ•ã‚¡ã‚¤ãƒ«ã§åŠ¹æœç¢ºèª

---

## ğŸš¨ ç·Šæ€¥å¯¾å¿œã‚³ãƒãƒ³ãƒ‰é›†

### ğŸ’€ Secret Manageræ¨©é™ä¿®æ­£ï¼ˆç·Šæ€¥æ™‚å³åº§å®Ÿè¡Œï¼‰

**å•é¡Œ**: APIèªè¨¼å¤±æ•—ãƒ»Secret Manageræ¨©é™æ¬ å¦‚

```bash
echo "ğŸš¨ Secret Manageræ¨©é™ä¿®æ­£ï¼ˆç·Šæ€¥æ™‚å³åº§å®Ÿè¡Œï¼‰"

# 1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª
SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)")
echo "å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: $SERVICE_ACCOUNT"

# 2. æ¨©é™ä»˜ä¸ï¼ˆ3ã¤ã®Secretå…¨ã¦ï¼‰
echo "æ¨©é™ä»˜ä¸å®Ÿè¡Œä¸­..."
gcloud secrets add-iam-policy-binding bitbank-api-key \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

gcloud secrets add-iam-policy-binding bitbank-api-secret \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

gcloud secrets add-iam-policy-binding discord-webhook-url \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

# 3. æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨©é™é©ç”¨ãƒ»macOSå¯¾å¿œï¼‰
FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
echo "æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨©é™é©ç”¨ï¼‰..."
gcloud run services update crypto-bot-service-prod \
  --region=asia-northeast1 \
  --set-env-vars="PERMISSION_FIX_TIMESTAMP=$FIX_TIMESTAMP"

echo "âœ… Secret Manageræ¨©é™ä¿®æ­£å®Œäº†"
echo "10åˆ†å¾Œã« 01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.md ã§åŠ¹æœç¢ºèªæ¨å¥¨"
```

### ğŸ” Silent Failureç·Šæ€¥ä¿®æ­£ï¼ˆmacOSå¯¾å¿œï¼‰

**å•é¡Œ**: ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆã•ã‚Œã‚‹ã‚‚æ³¨æ–‡å®Ÿè¡Œå®Œå…¨åœæ­¢

```bash
echo "ğŸ” Silent Failureç·Šæ€¥ä¿®æ­£ï¼ˆmacOSå¯¾å¿œï¼‰"

# 1. Silent FailureçŠ¶æ³ç¢ºèª
echo "ç¾åœ¨ã®Silent FailureçŠ¶æ³ç¢ºèª..."
SIGNALS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"çµ±åˆã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆ\"" --limit=30 --format="value(textPayload)" | grep -c . || echo "0")
ORDERS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"æ³¨æ–‡å®Ÿè¡Œ\" OR textPayload:\"create_order\")" --limit=30 --format="value(textPayload)" | grep -c . || echo "0")

echo "ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆ: $SIGNALSä»¶"
echo "æ³¨æ–‡å®Ÿè¡Œ: $ORDERSä»¶"

if [ $SIGNALS -gt 0 ] && [ $ORDERS -eq 0 ]; then
    echo "âŒ å®Œå…¨Silent Failureæ¤œå‡º - ç·Šæ€¥ä¿®æ­£é–‹å§‹"

    # 2. ExecutionService async/awaitå•é¡Œã®å¯èƒ½æ€§ç¢ºèª
    ASYNC_WARNINGS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"RuntimeWarning\" AND textPayload:\"never awaited\"" --limit=20 --format="value(textPayload)" | grep -c . || echo "0")

    if [ $ASYNC_WARNINGS -gt 0 ]; then
        echo "âŒ async/awaitå•é¡Œæ¤œå‡º - ã‚·ã‚¹ãƒ†ãƒ å†èµ·å‹•å¿…è¦"

        # å¼·åˆ¶å†èµ·å‹•ï¼ˆasync/awaitå•é¡Œè§£æ±ºã®ãŸã‚ï¼‰
        ASYNC_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --set-env-vars="ASYNC_FIX_RESTART_TIMESTAMP=$ASYNC_FIX_TIMESTAMP"

        echo "âœ… async/awaitå•é¡Œå¯¾å¿œå®Œäº†"
    else
        echo "âš ï¸ async/awaitå•é¡Œãªã— - ä»–è¦å› èª¿æŸ»å¿…è¦"
    fi

    # 3. Secret Manageræ¨©é™å†ç¢ºèªãƒ»ä¿®æ­£
    echo "Secret Manageræ¨©é™å†ç¢ºèª..."
    SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)")

    # æ¨©é™å†ä»˜ä¸ï¼ˆç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ï¼‰
    for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
        gcloud secrets add-iam-policy-binding $secret \
          --member="serviceAccount:$SERVICE_ACCOUNT" \
          --role="roles/secretmanager.secretAccessor" 2>/dev/null || true
    done

    echo "âœ… Secret Manageræ¨©é™ç¢ºèªå®Œäº†"

elif [ $SIGNALS -eq 0 ]; then
    echo "âš ï¸ ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆãªã— - ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œè¦ç¢ºèª"

    # ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬æ©Ÿèƒ½å†èµ·å‹•
    SIGNAL_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --set-env-vars="SIGNAL_FIX_RESTART_TIMESTAMP=$SIGNAL_FIX_TIMESTAMP"

    echo "âœ… ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬æ©Ÿèƒ½å†èµ·å‹•å®Œäº†"

else
    # macOSå¯¾å¿œ: æˆåŠŸç‡è¨ˆç®—
    SUCCESS_RATE=$(python3 -c "print(f'{($ORDERS / $SIGNALS) * 100:.1f}')" 2>/dev/null || echo "0.0")
    echo "âœ… éƒ¨åˆ†çš„å®Ÿè¡Œä¸­ (æˆåŠŸç‡: ${SUCCESS_RATE}%)"
    echo "ç·Šæ€¥å¯¾å¿œä¸è¦ - ç›£è¦–ç¶™ç¶š"
fi

echo "30åˆ†å¾Œã« 02_Botæ©Ÿèƒ½è¨ºæ–­.md ã§åŠ¹æœç¢ºèªå¿…é ˆ"
```

### ğŸ”¥ Containerå•é¡Œç·Šæ€¥å¯¾å¿œï¼ˆmacOSå¯¾å¿œï¼‰

**å•é¡Œ**: Container exit(1)é »ç™ºãƒ»RuntimeWarningãƒ»ãƒ¡ãƒ¢ãƒªä¸è¶³

```bash
echo "ğŸ”¥ Containerå•é¡Œç·Šæ€¥å¯¾å¿œï¼ˆmacOSå¯¾å¿œï¼‰"

# 1. ç¾åœ¨ã®Containerå•é¡Œãƒ¬ãƒ™ãƒ«ç¢ºèª
echo "Containerå•é¡Œãƒ¬ãƒ™ãƒ«ç¢ºèª..."
CONTAINER_EXITS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"Container called exit(1)\"" --limit=25 --format="value(textPayload)" | grep -c . || echo "0")
RUNTIME_WARNINGS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"RuntimeWarning\"" --limit=25 --format="value(textPayload)" | grep -c . || echo "0")

echo "Container exit(1): $CONTAINER_EXITSå›"
echo "RuntimeWarning: $RUNTIME_WARNINGSå›"

# macOSå¯¾å¿œ: å•é¡Œãƒ¬ãƒ™ãƒ«åˆ¤å®š
PROBLEM_LEVEL=$(python3 -c "
exit_score = min($CONTAINER_EXITS / 5, 3)
warning_score = min($RUNTIME_WARNINGS / 3, 3)
total = exit_score + warning_score
if total >= 3:
    print('HIGH')
elif total >= 1.5:
    print('MEDIUM')
else:
    print('LOW')
")

echo "å•é¡Œãƒ¬ãƒ™ãƒ«: $PROBLEM_LEVEL"

case $PROBLEM_LEVEL in
    "HIGH")
        echo "âŒ é«˜ãƒ¬ãƒ™ãƒ«å•é¡Œ - ç·Šæ€¥å¯¾å¿œå®Ÿè¡Œ"

        # ãƒ¡ãƒ¢ãƒªåˆ¶é™å¢—åŠ 
        echo "ãƒ¡ãƒ¢ãƒªåˆ¶é™å¢—åŠ : 1Gi â†’ 2Gi"
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --memory=2Gi

        # CPUåˆ¶é™å¢—åŠ 
        echo "CPUåˆ¶é™å¢—åŠ : 1000m â†’ 2000m"
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --cpu=2

        # å¼·åˆ¶å†èµ·å‹•
        RESTART_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
        echo "å¼·åˆ¶å†èµ·å‹•å®Ÿè¡Œ..."
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --set-env-vars="EMERGENCY_RESTART_TIMESTAMP=$RESTART_TIMESTAMP"

        echo "âœ… ç·Šæ€¥å¯¾å¿œå®Œäº†"
        ;;

    "MEDIUM")
        echo "âš ï¸ ä¸­ãƒ¬ãƒ™ãƒ«å•é¡Œ - äºˆé˜²çš„å¯¾å¿œå®Ÿè¡Œ"

        # ãƒ¡ãƒ¢ãƒªåˆ¶é™ã®ã¿å¢—åŠ 
        echo "ãƒ¡ãƒ¢ãƒªåˆ¶é™å¢—åŠ : 1Gi â†’ 1.5Gi"
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --memory=1536Mi

        echo "âœ… äºˆé˜²çš„å¯¾å¿œå®Œäº†"
        ;;

    "LOW")
        echo "âœ… ä½ãƒ¬ãƒ™ãƒ«å•é¡Œ - ç›£è¦–ç¶™ç¶š"
        echo "ç¾æ™‚ç‚¹ã§ç·Šæ€¥å¯¾å¿œä¸è¦"
        ;;
esac

echo "20åˆ†å¾Œã« 01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.md ã§åŠ¹æœç¢ºèªæ¨å¥¨"
```

### ğŸ“¨ Discord Webhookä¿®å¾©ï¼ˆç·Šæ€¥æ™‚å³åº§å®Ÿè¡Œï¼‰

**å•é¡Œ**: Discordé€šçŸ¥åœæ­¢ãƒ»Webhook Tokenç„¡åŠ¹

```bash
echo "ğŸ“¨ Discord Webhookä¿®å¾©ï¼ˆç·Šæ€¥æ™‚å³åº§å®Ÿè¡Œï¼‰"

# 1. ç¾åœ¨ã®WebhookçŠ¶æ…‹ç¢ºèª
echo "ç¾åœ¨ã®Webhookç¢ºèª..."
DISCORD_ERRORS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"code: 50027\" OR textPayload:\"Invalid Webhook Token\")" --limit=10 --format="value(textPayload)" | grep -c . || echo "0")
echo "Discord Webhookã‚¨ãƒ©ãƒ¼æ•°: $DISCORD_ERRORSå›"

if [ $DISCORD_ERRORS -gt 0 ]; then
    echo "âŒ Discord Webhookç„¡åŠ¹åŒ–æ¤œå‡º - ä¿®å¾©é–‹å§‹"

    # 2. æ–°ã—ã„Webhook URLå…¥åŠ›å¾…ã¡
    echo ""
    echo "ğŸ”§ æ–°ã—ã„Discord Webhook URLè¨­å®š:"
    echo "1. Discordã‚µãƒ¼ãƒãƒ¼è¨­å®š â†’ é€£æºã‚µãƒ¼ãƒ“ã‚¹ â†’ ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯"
    echo "2. æ—¢å­˜Crypto-Botå‰Šé™¤ â†’ æ–°è¦ä½œæˆ"
    echo "3. Webhook URLã‚’ã‚³ãƒ”ãƒ¼"
    echo ""
    read -p "æ–°ã—ã„Discord Webhook URL: " NEW_WEBHOOK_URL

    if [ -n "$NEW_WEBHOOK_URL" ]; then
        # 3. Secret Manageræ›´æ–°
        echo "Secret Manageræ›´æ–°ä¸­..."
        echo "$NEW_WEBHOOK_URL" | gcloud secrets versions add discord-webhook-url --data-file=-

        # 4. æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆWebhooké©ç”¨ãƒ»macOSå¯¾å¿œï¼‰
        WEBHOOK_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
        echo "æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆWebhooké©ç”¨ï¼‰..."
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --set-env-vars="WEBHOOK_FIX_TIMESTAMP=$WEBHOOK_FIX_TIMESTAMP"

        echo "âœ… Discord Webhookä¿®å¾©å®Œäº†"
        echo "15åˆ†å¾Œã«Discordé€šçŸ¥æˆåŠŸç¢ºèªæ¨å¥¨"
    else
        echo "âŒ Webhook URLæœªå…¥åŠ› - ä¿®å¾©ä¸­æ–­"
    fi
else
    echo "âœ… Discord Webhookæ­£å¸¸ - ä¿®å¾©ä¸è¦"
fi
```

### ğŸ¤– MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ å¼·åˆ¶å†èµ·å‹•

**å•é¡Œ**: ProductionEnsembleåœæ­¢ãƒ»MLäºˆæ¸¬æœªå®Ÿè¡Œ

```bash
echo "ğŸ¤– MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ å¼·åˆ¶å†èµ·å‹•"

# 1. MLäºˆæ¸¬åœæ­¢çŠ¶æ³ç¢ºèª
echo "MLäºˆæ¸¬çŠ¶æ³ç¢ºèª..."
ML_COUNT=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"ProductionEnsemble\" OR textPayload:\"MLäºˆæ¸¬\")" --limit=20 --format="value(textPayload)" | grep -c . || echo "0")
echo "MLäºˆæ¸¬å®Ÿè¡Œ: $ML_COUNTå›ï¼ˆæœ€è¿‘ï¼‰"

if [ $ML_COUNT -eq 0 ]; then
    echo "âŒ MLäºˆæ¸¬å®Œå…¨åœæ­¢ - å¼·åˆ¶å†èµ·å‹•å®Ÿè¡Œ"

    # 2. MLãƒ¢ãƒ‡ãƒ«å†ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚·ã‚¹ãƒ†ãƒ å†èµ·å‹•
    ML_RESTART_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
    echo "MLã‚·ã‚¹ãƒ†ãƒ å¼·åˆ¶å†èµ·å‹•..."
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --set-env-vars="ML_RESTART_TIMESTAMP=$ML_RESTART_TIMESTAMP"

    # 3. ãƒ¡ãƒ¢ãƒªåˆ¶é™ç¢ºèªãƒ»å¿…è¦ã«å¿œã˜ã¦å¢—åŠ 
    echo "ãƒ¡ãƒ¢ãƒªåˆ¶é™ç¢ºèªãƒ»MLãƒ¢ãƒ‡ãƒ«ç”¨å¢—åŠ ..."
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --memory=2Gi

    echo "âœ… MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ å†èµ·å‹•å®Œäº†"
    echo "25åˆ†å¾Œã« 02_Botæ©Ÿèƒ½è¨ºæ–­.md ã§MLäºˆæ¸¬å¾©æ—§ç¢ºèªå¿…é ˆ"
else
    echo "âœ… MLäºˆæ¸¬å‹•ä½œä¸­ - å†èµ·å‹•ä¸è¦ ($ML_COUNTå›ç¢ºèª)"
fi
```

### âš¡ ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å†èµ·å‹•ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰

**å•é¡Œ**: è¤‡æ•°ã‚·ã‚¹ãƒ†ãƒ åœæ­¢ãƒ»åŸå› ä¸æ˜ã®ç·åˆçš„å•é¡Œ

```bash
echo "âš¡ ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å†èµ·å‹•ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰"

# 1. å†èµ·å‹•å‰çŠ¶æ³è¨˜éŒ²
echo "å†èµ·å‹•å‰ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³è¨˜éŒ²..."
echo "ç¾åœ¨æ™‚åˆ»: $(python3 -c "import datetime; print(datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9))).strftime('%Y-%m-%d %H:%M:%S JST'))")"

# ç¾åœ¨ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç¢ºèª
CURRENT_REVISION=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(status.latestReadyRevisionName)")
echo "ç¾åœ¨ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³: $CURRENT_REVISION"

# 2. ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å†èµ·å‹•å®Ÿè¡Œ
FULL_RESTART_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
echo "ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å†èµ·å‹•å®Ÿè¡Œ..."

# ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™æœ€é©åŒ– + å¼·åˆ¶å†èµ·å‹•
gcloud run services update crypto-bot-service-prod \
  --region=asia-northeast1 \
  --memory=2Gi \
  --cpu=2 \
  --set-env-vars="FULL_SYSTEM_RESTART_TIMESTAMP=$FULL_RESTART_TIMESTAMP"

echo "âœ… ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å†èµ·å‹•å®Œäº†"
echo ""
echo "ğŸ“‹ å†èµ·å‹•å¾Œç¢ºèªæ‰‹é †:"
echo "1. 5åˆ†å¾…æ©Ÿ"
echo "2. 01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.md å®Ÿè¡Œ"
echo "3. 02_Botæ©Ÿèƒ½è¨ºæ–­.md å®Ÿè¡Œ"
echo "4. å…¨é …ç›®æ­£å¸¸åŒ–ç¢ºèª"
echo ""
echo "âš ï¸ æ³¨æ„: 30åˆ†çµŒéã—ã¦ã‚‚å•é¡Œè§£æ±ºã—ãªã„å ´åˆã¯ã€æ‰‹å‹•èª¿æŸ»ãŒå¿…è¦ã§ã™"
```

---

## ğŸ“‹ å•é¡Œåˆ¥ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ğŸ’€ å³åº§å¯¾å¿œå¿…é ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã‚’å¿…ãšç¢ºèªï¼š

- [ ] **Secret Manageræ¨©é™**: 3ã¤å…¨ã¦æ­£å¸¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] **Silent Failureè§£æ¶ˆ**: ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆâ†’æ³¨æ–‡å®Ÿè¡ŒæˆåŠŸç‡20%ä»¥ä¸Š
- [ ] **Discordç›£è¦–å¾©æ—§**: code: 50027ã‚¨ãƒ©ãƒ¼è§£æ¶ˆãƒ»é€šçŸ¥é€ä¿¡æˆåŠŸ
- [ ] **Containerå®‰å®šåŒ–**: exit(1)é »åº¦5å›/æ™‚é–“æœªæº€ãƒ»RuntimeWarningè§£æ¶ˆ

### ğŸŸ  è¦æ³¨æ„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

äºˆé˜²çš„å¯¾å¿œå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªï¼š

- [ ] **MLäºˆæ¸¬æ­£å¸¸åŒ–**: ProductionEnsembleå®Ÿè¡Œãƒ»äºˆæ¸¬å€¤æ­£å¸¸
- [ ] **APIæ¥ç¶šå®‰å®šåŒ–**: 10,000å††æ­£å¸¸å–å¾—ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨åœæ­¢
- [ ] **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: 90%æœªæº€ç¶­æŒãƒ»OOMã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
- [ ] **æˆ¦ç•¥ã‚·ã‚¹ãƒ†ãƒ **: 5æˆ¦ç•¥å…¨ã¦å®Ÿè¡Œãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤20%æœªæº€

### ğŸŸ¡ ç›£è¦–ç¶™ç¶šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ç¶™ç¶šç›£è¦–é …ç›®ï¼š

- [ ] **ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒ**: å–å¼•ã‚µã‚¤ã‚¯ãƒ«ç¶™ç¶šãƒ»æœ€æ–°ãƒ­ã‚°10åˆ†ä»¥å†…
- [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: å‡¦ç†æ™‚é–“æ­£å¸¸ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ãªã—
- [ ] **ãƒ‡ãƒ¼ã‚¿å“è³ª**: 4hè¶³ãƒ»15mè¶³æ­£å¸¸å–å¾—ãƒ»ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
- [ ] **ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡**: CPUãƒ»ãƒ¡ãƒ¢ãƒªãƒ»ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡æ­£å¸¸ç¯„å›²

---

## ğŸ”„ ä¿®å¾©åŠ¹æœç¢ºèªæ‰‹é †

### 1. å³åº§ç¢ºèªï¼ˆä¿®å¾©å¾Œ5åˆ†ï¼‰

```bash
# åŸºæœ¬çš„ãªã‚·ã‚¹ãƒ†ãƒ å¿œç­”ç¢ºèª
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(status.conditions[0].status)"

# æœ€æ–°ãƒ­ã‚°ç¢ºèª
gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\"" --limit=5 --format="value(timestamp.date(tz='Asia/Tokyo'),textPayload)"
```

### 2. ä¸­æœŸç¢ºèªï¼ˆä¿®å¾©å¾Œ15åˆ†ï¼‰

```bash
# 01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.md å®Ÿè¡Œ
bash /Users/nao/Desktop/bot/docs/æŒ‡ç¤ºæ›¸/ç¨¼åƒãƒã‚§ãƒƒã‚¯/01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.sh

# åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸åŒ–ç¢ºèª
```

### 3. å®Œå…¨ç¢ºèªï¼ˆä¿®å¾©å¾Œ30åˆ†ï¼‰

```bash
# 02_Botæ©Ÿèƒ½è¨ºæ–­.md å®Ÿè¡Œ
bash /Users/nao/Desktop/bot/docs/æŒ‡ç¤ºæ›¸/ç¨¼åƒãƒã‚§ãƒƒã‚¯/02_Botæ©Ÿèƒ½è¨ºæ–­.sh

# Botæ©Ÿèƒ½å®Œå…¨å¾©æ—§ç¢ºèª
```

---

## ğŸ’¡ äºˆé˜²çš„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### é€±æ¬¡å®Ÿè¡Œæ¨å¥¨

```bash
# 1. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ç¢ºèª
gcloud monitoring metrics list --filter="metric.type:compute"

# 2. Secret Manageræ¨©é™å®šæœŸç¢ºèª
for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
    gcloud secrets get-iam-policy $secret
done

# 3. ä¸è¦ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
gcloud logging sinks list

# 4. Discord Webhookæ¥ç¶šãƒ†ã‚¹ãƒˆ
curl -X POST -H "Content-Type: application/json" \
  -d '{"content": "å®šæœŸæ¥ç¶šãƒ†ã‚¹ãƒˆ"}' \
  $(gcloud secrets versions access latest --secret="discord-webhook-url")
```

### æœˆæ¬¡å®Ÿè¡Œæ¨å¥¨

```bash
# 1. Cloud Runãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
gcloud run revisions list --service=crypto-bot-service-prod --region=asia-northeast1 --format="value(metadata.name)" | tail -n +6 | xargs -I {} gcloud run revisions delete {} --region=asia-northeast1 --quiet

# 2. Secret Managerå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‰Šé™¤
for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
    gcloud secrets versions list $secret --format="value(name)" | tail -n +3 | xargs -I {} gcloud secrets versions destroy {} --secret=$secret --quiet
done

# 3. ãƒ­ã‚°ä¿æŒæœŸé–“ç¢ºèªãƒ»èª¿æ•´
gcloud logging buckets list

# 4. å…¨ä½“ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
bash /Users/nao/Desktop/bot/docs/æŒ‡ç¤ºæ›¸/ç¨¼åƒãƒã‚§ãƒƒã‚¯/01_ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒè¨ºæ–­.sh
bash /Users/nao/Desktop/bot/docs/æŒ‡ç¤ºæ›¸/ç¨¼åƒãƒã‚§ãƒƒã‚¯/02_Botæ©Ÿèƒ½è¨ºæ–­.sh
```

---

## ğŸš¨ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸºæº–

### å³åº§ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ‰‹å‹•èª¿æŸ»å¿…è¦ï¼‰

ä»¥ä¸‹ã®å ´åˆã¯ç·Šæ€¥å¯¾å¿œã§ã¯è§£æ±ºã§ãã¾ã›ã‚“ï¼š

- [ ] **Secret Manageræ¨©é™ä¿®æ­£å¾Œã‚‚èªè¨¼å¤±æ•—ç¶™ç¶š**
- [ ] **ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å†èµ·å‹•å¾Œã‚‚Containerå•é¡Œç¶™ç¶š**
- [ ] **MLäºˆæ¸¬å†èµ·å‹•å¾Œã‚‚ProductionEnsembleå®Œå…¨åœæ­¢**
- [ ] **3å›é€£ç¶šã®ç·Šæ€¥å¯¾å¿œå®Ÿè¡Œã§ã‚‚å•é¡Œè§£æ±ºã›ãš**

### æ‰‹å‹•èª¿æŸ»æ¨å¥¨é …ç›®

- **GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šç¢ºèª**: IAMãƒ»APIæœ‰åŠ¹åŒ–ãƒ»èª²é‡‘çŠ¶æ³
- **bitbank APIä»•æ§˜å¤‰æ›´**: API endpointãƒ»èªè¨¼æ–¹å¼ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- **ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§**: models/production/ãƒ•ã‚¡ã‚¤ãƒ«ç ´æãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ**: Cloud Runâ†’å¤–éƒ¨APIæ¥ç¶šãƒ»DNSè§£æ±º
- **ã‚³ãƒ¼ãƒ‰å¤‰æ›´å½±éŸ¿**: æœ€æ–°ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã®äºˆæœŸã—ãªã„å‰¯ä½œç”¨

---

**ğŸ¯ é‡è¦**: ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ç·Šæ€¥æ™‚ã®è¿…é€Ÿãªå¯¾å¿œã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚æ ¹æœ¬åŸå› ã®ç‰¹å®šã«ã¯ 01/02 è¨ºæ–­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ä½µç”¨ã—ã¦ãã ã•ã„ã€‚