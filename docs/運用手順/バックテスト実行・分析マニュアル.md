# バックテスト・ペーパートレード実行・分析マニュアル

**AI自動取引システム** のバックテスト・ペーパートレード機能の詳細な使用方法、結果分析、運用手順について説明します。

## 🎯 システム概要

### **統合実行環境 (Phase 21)**

**共通基盤**: 本番・ペーパートレード・バックテストが同一ロジックで動作
- **統合システム**: `TradingCycleManager` による完全同一処理
- **15特徴量**: 7カテゴリ統一管理・`feature_order.json` 準拠
- **5戦略統合**: ATR・もちぽよ・MultiTimeframe・DonchianChannel・ADXTrend
- **ML予測**: 3モデルアンサンブル（LightGBM 50%・XGBoost 30%・RandomForest 20%）
- **動的信頼度**: 市場適応型0.25-0.6信頼度計算

### **実行モード比較**

| 機能 | バックテスト | ペーパートレード | ライブトレード |
|------|-------------|----------------|---------------|
| **データ源** | 固定CSV | Bitbank API | Bitbank API |
| **取引実行** | 仮想（無制限） | 仮想（リアルタイム） | 実際の取引 |
| **実行時間** | 高速（数分） | リアルタイム | リアルタイム |
| **用途** | 戦略検証・最適化 | 本番前検証 | 実運用 |
| **リスク** | なし | なし | 実資金 |

## 🚀 バックテスト実行

### **1. 基本実行**

```bash
# 即座に実行可能（既存CSVデータ使用）
python main.py --mode backtest

# レポート確認
ls -t src/backtest/logs/backtest_*.json | head -1 | xargs cat | jq '.performance_stats'
```

### **2. カスタム期間実行**

```bash
# 3ヶ月データで実行
python src/backtest/scripts/collect_historical_csv.py --days 90
python main.py --mode backtest

# 6ヶ月データで実行  
python src/backtest/scripts/collect_historical_csv.py --days 180
python main.py --mode backtest
```

### **3. 期間統一実行（推奨）**

```bash
# 4時間足と15分足の期間を自動統一
python src/backtest/scripts/collect_historical_csv.py --match-4h --timeframes 15m
python main.py --mode backtest
```

### **4. データ確認**

```bash
# CSVデータ状況確認
python -c "
import pandas as pd
df_4h = pd.read_csv('src/backtest/data/historical/BTC_JPY_4h.csv')
df_15m = pd.read_csv('src/backtest/data/historical/BTC_JPY_15m.csv')
print(f'4時間足: {len(df_4h)}件 ({df_4h[\"datetime\"].iloc[0]} - {df_4h[\"datetime\"].iloc[-1]})')
print(f'15分足: {len(df_15m)}件 ({df_15m[\"datetime\"].iloc[0]} - {df_15m[\"datetime\"].iloc[-1]})')
"
```

## 📊 ペーパートレード実行

### **1. 基本実行**

```bash
# ペーパートレード開始（リアルタイム）
python main.py --mode paper

# ログ確認（別ターミナル）
tail -f logs/crypto_bot.log | grep -E "(BUY|SELL|HOLD)"
```

### **2. 設定確認実行**

```bash
# Discord通知確認
python -c "
import os
print('Discord設定:')
print('DISCORD_WEBHOOK_URL:', 'あり' if os.getenv('DISCORD_WEBHOOK_URL') else 'なし')
print('運用モード:', os.getenv('TRADING_MODE', 'development'))
"

# 資金・設定確認
python main.py --mode paper --dry-run
```

### **3. 期間限定実行**

```bash
# 1時間のテスト実行
timeout 3600 python main.py --mode paper
echo "1時間ペーパートレード完了"

# 1日のテスト実行
nohup python main.py --mode paper > logs/paper_trading_$(date +%Y%m%d).log 2>&1 &
```

### **4. パフォーマンス監視**

```bash
# リアルタイム取引監視
watch -n 30 "tail -10 logs/crypto_bot.log | grep -E 'Final decision|Balance'"

# Discord通知確認
python -c "
import asyncio, sys; sys.path.insert(0, '.')
from src.monitoring.discord_notifier import DiscordNotifier

async def test_notification():
    notifier = DiscordNotifier()
    await notifier.send_info_notification('📊 ペーパートレード監視テスト', 'システム正常動作中')

asyncio.run(test_notification())
"
```

## 📂 結果の保存場所・構成

### **バックテスト結果**

```
src/backtest/logs/
├── backtest_20250912_061234.json     # 実行統計・JSON形式
├── progress_20250912_061234.json     # 進捗情報
├── error_20250912_061234.json        # エラーログ（発生時）
└── [タイムスタンプ別複数ファイル]
```

### **ペーパートレード結果**

```
logs/
├── crypto_bot.log                     # 統合ログ（全モード共通）
├── paper_trading_reports/             # ペーパートレード専用レポート
│   ├── daily_summary_YYYYMMDD.json   # 日次サマリー
│   ├── trades_YYYYMMDD.csv           # 取引履歴
│   └── performance_YYYYMMDD.json     # パフォーマンス統計
└── discord_notifications.log         # Discord通知ログ
```

### **共通ファイル形式**

**1. JSON統計レポート**
```json
{
  "execution_stats": {
    "mode": "backtest",
    "period": "2025-03-15 - 2025-09-11",
    "total_cycles": 1080,
    "buy_signals": 45,
    "sell_signals": 42,
    "hold_decisions": 993,
    "processing_time_avg": 0.08
  },
  "strategy_performance": {
    "atr_based": {"signals": 15, "confidence_avg": 0.67},
    "multi_timeframe": {"signals": 12, "confidence_avg": 0.72}
  },
  "ml_performance": {
    "predictions": 1080,
    "buy_probability_avg": 0.34,
    "sell_probability_avg": 0.31,
    "hold_probability_avg": 0.35
  }
}
```

**2. 取引CSV（共通形式）**
```csv
timestamp,action,price,confidence,strategy_votes,ml_prediction,risk_assessment
2025-09-12T06:00:00,BUY,16904200,0.75,"atr_based:0.8,multi_timeframe:0.7",0.68,ACCEPTABLE
2025-09-12T10:00:00,HOLD,16920000,0.45,"mixed_signals",0.52,LOW_CONFIDENCE
```

## 📊 分析手法・ツール

### **1. 統合パフォーマンス分析**

```python
import json
import pandas as pd
from pathlib import Path
from datetime import datetime

def analyze_trading_performance(mode='backtest'):
    """バックテスト・ペーパートレード結果の統合分析"""
    
    if mode == 'backtest':
        report_dir = Path('src/backtest/logs')
        pattern = 'backtest_*.json'
    else:
        report_dir = Path('logs/paper_trading_reports')
        pattern = 'performance_*.json'
    
    # 最新レポート取得
    reports = sorted(report_dir.glob(pattern))
    if not reports:
        print(f"{mode}レポートが見つかりません")
        return
    
    latest = reports[-1]
    with open(latest, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    print(f"📊 {mode.upper()}パフォーマンス分析")
    print(f"レポート: {latest.name}")
    
    if 'execution_stats' in data:
        stats = data['execution_stats']
        print(f"実行期間: {stats.get('period', 'N/A')}")
        print(f"処理サイクル数: {stats.get('total_cycles', 0):,}")
        print(f"BUYシグナル: {stats.get('buy_signals', 0)}")
        print(f"SELLシグナル: {stats.get('sell_signals', 0)}")
        print(f"HOLDシグナル: {stats.get('hold_decisions', 0)}")
        print(f"平均処理時間: {stats.get('processing_time_avg', 0):.3f}秒")
    
    # 戦略別分析
    if 'strategy_performance' in data:
        print("\n🎯 戦略別パフォーマンス")
        for strategy, metrics in data['strategy_performance'].items():
            signals = metrics.get('signals', 0)
            confidence = metrics.get('confidence_avg', 0)
            print(f"{strategy}: {signals}シグナル, 平均信頼度{confidence:.2f}")

# 使用例
analyze_trading_performance('backtest')
analyze_trading_performance('paper')
```

### **2. 比較分析（バックテスト vs ペーパートレード）**

```python
def compare_backtest_vs_paper():
    """バックテストとペーパートレードの比較分析"""
    
    # データ取得
    def load_latest_results(mode):
        if mode == 'backtest':
            files = sorted(Path('src/backtest/logs').glob('backtest_*.json'))
        else:
            files = sorted(Path('logs/paper_trading_reports').glob('performance_*.json'))
        
        if files:
            with open(files[-1], 'r', encoding='utf-8') as f:
                return json.load(f)
        return None
    
    backtest_data = load_latest_results('backtest')
    paper_data = load_latest_results('paper')
    
    if not backtest_data or not paper_data:
        print("比較用データが不足しています")
        return
    
    print("📊 バックテスト vs ペーパートレード比較")
    print("=" * 50)
    
    # 実行統計比較
    bt_stats = backtest_data.get('execution_stats', {})
    pt_stats = paper_data.get('execution_stats', {})
    
    metrics = ['total_cycles', 'buy_signals', 'sell_signals', 'processing_time_avg']
    
    for metric in metrics:
        bt_value = bt_stats.get(metric, 0)
        pt_value = pt_stats.get(metric, 0)
        print(f"{metric}:")
        print(f"  バックテスト: {bt_value}")
        print(f"  ペーパートレード: {pt_value}")
        
        if isinstance(bt_value, (int, float)) and isinstance(pt_value, (int, float)) and bt_value > 0:
            diff_pct = ((pt_value - bt_value) / bt_value) * 100
            print(f"  差異: {diff_pct:+.1f}%")
        print()

compare_backtest_vs_paper()
```

### **3. 時系列パフォーマンス分析**

```python
import matplotlib.pyplot as plt
import seaborn as sns

def plot_performance_timeline():
    """時系列パフォーマンス可視化"""
    
    # ペーパートレードログ分析
    log_file = 'logs/crypto_bot.log'
    if not Path(log_file).exists():
        print("ログファイルが見つかりません")
        return
    
    # ログからBUY/SELL/HOLD決定を抽出
    decisions = []
    prices = []
    timestamps = []
    
    with open(log_file, 'r', encoding='utf-8') as f:
        for line in f:
            if 'Final decision:' in line:
                # ログ解析ロジック（実装は省略）
                pass
    
    # 可視化
    plt.figure(figsize=(15, 10))
    
    # サブプロット1: 価格チャート
    plt.subplot(2, 1, 1)
    plt.plot(timestamps, prices, label='BTC価格', linewidth=1)
    plt.title('価格推移と取引決定')
    plt.ylabel('価格（円）')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # サブプロット2: 決定分布
    plt.subplot(2, 1, 2)
    decision_counts = pd.Series(decisions).value_counts()
    plt.bar(decision_counts.index, decision_counts.values, 
            color=['green', 'red', 'blue'])
    plt.title('取引決定分布')
    plt.ylabel('回数')
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()

plot_performance_timeline()
```

## 🔧 設定カスタマイズ

### **統合設定ファイル (config/core/unified.yaml)**

```yaml
# バックテスト・ペーパートレード共通設定
trading:
  initial_balance: 500000      # 初期資金（50万円）
  max_order_size: 0.002        # 最大注文サイズ
  risk_per_trade: 0.01         # 1取引リスク（1%）

# リスク管理
risk_management:
  kelly_max_fraction: 0.03     # Kelly基準最大（3%）
  max_drawdown: 0.20           # 最大ドローダウン（20%）
  consecutive_loss_limit: 5    # 連続損失限界

# 戦略統合
strategies:
  weights:
    atr_based: 0.25           # ATR戦略重み
    mochipoy_alert: 0.20      # もちぽよ戦略重み
    multi_timeframe: 0.25     # マルチタイムフレーム重み
    donchian_channel: 0.15    # ドンチャンチャネル重み
    adx_trend: 0.15           # ADXトレンド重み

# データ設定
data:
  timeframes: ['4h', '15m']    # 使用時間軸
  lookback_periods:
    fast: 20                   # 短期期間
    slow: 50                   # 長期期間
```

### **モード別カスタム設定**

**バックテスト専用設定**
```yaml
# config/backtest/custom.yaml
backtest:
  fast_mode: true             # 高速実行モード
  skip_ml_prediction: false   # ML予測スキップ（false=実行）
  detailed_logging: true      # 詳細ログ有効

data:
  csv_cache: true            # CSVキャッシュ有効
  validation: true           # データ整合性チェック
```

**ペーパートレード専用設定**
```yaml
# config/paper/custom.yaml  
paper_trading:
  real_time_mode: true       # リアルタイム実行
  api_timeout: 30            # API タイムアウト（秒）
  notification_level: 'INFO' # Discord通知レベル

monitoring:
  heartbeat_interval: 300    # 生存確認間隔（5分）
  error_notification: true   # エラー時通知有効
```

## 🔍 トラブルシューティング

### **バックテスト関連**

**1. CSVデータエラー**
```bash
# データ整合性チェック
python -c "
from src.backtest.data.csv_data_loader import get_csv_loader
loader = get_csv_loader()
result_4h = loader.validate_data_integrity('BTC/JPY', '4h')
result_15m = loader.validate_data_integrity('BTC/JPY', '15m')
print('4h整合性:', result_4h)
print('15m整合性:', result_15m)
"

# データ再収集
python src/backtest/scripts/collect_historical_csv.py --match-4h
```

**2. メモリ不足**
```bash
# データサイズ確認
du -h src/backtest/data/historical/

# キャッシュクリア
python -c "
from src.backtest.data.csv_data_loader import get_csv_loader
get_csv_loader().clear_cache()
print('キャッシュクリア完了')
"
```

### **ペーパートレード関連**

**1. API接続エラー**
```bash
# Bitbank API接続テスト
python -c "
import asyncio, sys; sys.path.insert(0, '.')
from src.data.bitbank_client import BitbankClient

async def test_api():
    client = BitbankClient()
    ticker = await client.fetch_ticker('BTC/JPY')
    print(f'現在価格: {ticker[\"last\"]:,}円')
    print('API接続: OK')

asyncio.run(test_api())
"
```

**2. Discord通知エラー**
```bash
# Discord設定確認
python -c "
import os, asyncio, sys; sys.path.insert(0, '.')
from src.monitoring.discord_notifier import DiscordNotifier

webhook = os.getenv('DISCORD_WEBHOOK_URL')
print('Discord Webhook:', 'あり' if webhook else 'なし')

if webhook:
    async def test_discord():
        notifier = DiscordNotifier()
        await notifier.send_info_notification('🔧 テスト通知', 'Discord接続確認')
    asyncio.run(test_discord())
"
```

**3. プロセス管理**
```bash
# ペーパートレード プロセス確認
ps aux | grep "main.py --mode paper"

# 安全停止
pkill -f "main.py --mode paper"

# バックグラウンド実行確認
jobs -l | grep python
```

## 📊 継続的改善・監視

### **定期実行スケジュール**

```bash
# crontab 設定例
# 毎日午前6時: バックテスト実行
0 6 * * * cd /path/to/bot && python main.py --mode backtest

# 週次: データ更新・長期バックテスト
0 0 * * 0 cd /path/to/bot && python src/backtest/scripts/collect_historical_csv.py --days 180 && python main.py --mode backtest

# ペーパートレード: 24時間監視（再起動付き）
*/30 * * * * pgrep -f "main.py --mode paper" || (cd /path/to/bot && nohup python main.py --mode paper &)
```

### **監視指標・アラート**

```python
def monitoring_dashboard():
    """統合監視ダッシュボード"""
    
    print("🖥️  AI自動取引システム監視ダッシュボード")
    print("=" * 60)
    
    # バックテスト最新結果
    bt_files = sorted(Path('src/backtest/logs').glob('backtest_*.json'))
    if bt_files:
        with open(bt_files[-1]) as f:
            bt_data = json.load(f)
        
        bt_stats = bt_data.get('execution_stats', {})
        print(f"📊 バックテスト最新結果 ({bt_files[-1].name})")
        print(f"  期間: {bt_stats.get('period', 'N/A')}")
        print(f"  BUY/SELL比率: {bt_stats.get('buy_signals', 0)}/{bt_stats.get('sell_signals', 0)}")
    
    # ペーパートレード状況
    paper_files = sorted(Path('logs/paper_trading_reports').glob('performance_*.json'))
    if paper_files:
        print(f"\n💹 ペーパートレード最新状況 ({paper_files[-1].name})")
        # 詳細分析ロジック
    
    # システムヘルス
    print(f"\n🏥 システムヘルス")
    print(f"  CSVデータ: {Path('src/backtest/data/historical/BTC_JPY_4h.csv').exists()}")
    print(f"  MLモデル: {Path('models/production/production_ensemble.pkl').exists()}")
    print(f"  Discord設定: {'DISCORD_WEBHOOK_URL' in os.environ}")

# 毎日実行
monitoring_dashboard()
```

### **パフォーマンス改善指標**

**重要指標（目標値）**
1. **処理速度**: 平均0.1秒以内/サイクル
2. **シグナル精度**: BUY/SELL信頼度0.6以上
3. **戦略バランス**: 5戦略の信頼度分散0.2以内
4. **ML予測精度**: 3クラス予測精度50%以上
5. **システム稼働率**: 99%以上（ペーパートレード）

## 📚 関連ドキュメント

- **[バックテストシステム](../../src/backtest/README.md)**: Phase 21対応・CSV処理・固定ファイル名
- **[戦略システム](../../src/strategies/README.md)**: 5戦略統合・動的信頼度計算
- **[取引システム](../../src/trading/README.md)**: リスク管理・Kelly基準・異常検知
- **[ML システム](../../src/ml/README.md)**: 3モデルアンサンブル・週次自動学習
- **[開発ガイド](../../CLAUDE.md)**: システム全体・625テスト・CI/CD

---

**統合実行システム**: バックテスト（戦略検証）・ペーパートレード（本番前検証）・ライブトレード（実運用）が完全同一ロジックで動作。15特徴量・5戦略・動的信頼度・ML予測による包括的取引判断システム 🚀