# 統合運用ガイド

## 📋 このファイルの目的

**対象読者**:
- **AI（Claude Code等）**: 自律的にデプロイ・検証を実行
- **開発者**: 手動実行時のリファレンス
- **運用担当者**: 日常監視・緊急対応のガイド

**使用場面**:
- **デプロイ前準備**: ML学習・Phase 40最適化・品質確認
- **ローカル検証**: ペーパートレード・バックテスト実行
- **本番デプロイ**: CI/CD実行・環境構築
- **日常運用**: 監視・メンテナンス・緊急対応

**ガイドの特徴**:
- ✅ **明確な手順**: 各ステップで実行コマンド・期待結果を明示
- ✅ **最新状態反映**: Phase 40完了（79パラメータ最適化）・1,097テスト・70.56%カバレッジ
- ✅ **AI可読性**: コマンド・出力例・確認項目を構造化
- ✅ **実測値記載**: 実行時間・モデルサイズ等の実際の値を記載

---

# 第1部: デプロイ前準備

## 🚀 デプロイ前チェックリスト（必須実行順序）

### Step 1: ML学習実行（新機能開発後・定期再学習時必須）

#### 🎯 **標準ML学習コマンド**（Phase 40完了後・推奨）

```bash
# ========================================
# 標準ML学習（約4分・50 trials）
# ========================================
python3 scripts/ml/create_ml_models.py \
  --n-classes 3 \
  --threshold 0.005 \
  --optimize \
  --n-trials 50 \
  --verbose

# 実行時間: 約4分（50 trials）
# 学習データ: 180日分・1,032サンプル・50特徴量（Phase 40.6拡張完了）
# モデル: LightGBM・XGBoost・RandomForest アンサンブル
# 分類: 3クラス（SELL/HOLD/BUY）・閾値±0.5%
# 最適化: Optuna TPESampler・TimeSeriesSplit n_splits=5

# ========================================
# 高精度版（100 trials・推奨しない）
# ========================================
# python3 scripts/ml/create_ml_models.py \
#   --n-classes 3 \
#   --threshold 0.005 \
#   --optimize \
#   --n-trials 100 \
#   --verbose
#
# 実行時間: 約8分（100 trials）
# 効果: +1-3%改善のみ（50 trials比）・コスパ悪い
```

#### 📊 **オプション一覧**（標準コマンドで全て有効）

| オプション | 説明 | 標準で有効 |
|-----------|------|----------|
| `--n-classes 3` | 3クラス分類（SELL/HOLD/BUY） | ✅ 推奨 |
| `--threshold 0.005` | 閾値±0.5%（ノイズ削減） | ✅ 推奨 |
| `--optimize` | Optunaハイパーパラメータ最適化 | ✅ 推奨 |
| `--n-trials 50` | 最適化試行回数50（コスパ最良） | ✅ 推奨 |
| `--verbose` | 詳細ログ出力 | ✅ 推奨 |
| `--use-smote` | SMOTE（2クラス専用・非推奨） | ❌ 使用しない |
| `--feature-engineering` | Feature Engineering（Phase 40.6未実装） | ⏳ 将来実装 |

**補足**:
- Phase 39（実データ学習）: デフォルトで有効
- Phase 40（79パラメータ最適化）: 完了済み・thresholds.yaml反映済み
- 定期再学習: 週次（日曜18:00 JST）自動実行
- 手動再学習タイミング: 新機能追加後・市況急変時

#### 🔍 **モデル学習完了後の確認**

```bash
# 1. モデルファイル保存確認
ls -lh models/production/production_ensemble.pkl
# 期待: 8.6M（8,607,520 bytes）

# 2. メタデータ確認
cat models/production/production_model_metadata.json | python3 -m json.tool
# 期待出力:
# {
#   "created_at": "2025-10-14T20:14:00.978257",
#   "model_type": "ProductionEnsemble",
#   "phase": "Phase 39.5",
#   "status": "production_ready",
#   "model_weights": {
#     "lightgbm": 0.4,
#     "xgboost": 0.4,
#     "random_forest": 0.2
#   }
# }

# 3. パフォーマンスメトリクス確認
cat models/production/production_model_metadata.json | jq '.performance_metrics'
# 期待: F1スコア 0.46-0.61 範囲（3クラス分類として良好）

# 4. 旧モデル自動バックアップ確認
ls -lt models/archive/ | head -3
# 期待: production_ensemble_YYYYMMDD_HHMMSS.pkl存在

# 5. Optuna最適化結果確認
cat models/optuna/phase39_5_results.json | python3 -m json.tool
# 期待: best_score 0.48-0.57 範囲
```

#### ✅ **期待される学習結果**（実測値）

```bash
# ログ出力例（標準コマンド実行時・約4分）:
# 🚀 Phase 39.1: ML実データ学習システム開始
# ✅ 実データ読み込み完了: 1,032サンプル (180日分)
# 📊 3クラス分布: SELL 15.4%, HOLD 65.9%, BUY 18.7%
# 📊 Train/Val/Test split: 722/155/155 (70%/15%/15%)
# 🔬 Optuna最適化開始（50試行・約3分）
#
# lightgbm:
#   Test F1: 0.466, CV F1: 0.427±0.074
#   Best params: learning_rate=0.170, max_depth=12, n_estimators=186
#
# xgboost:
#   Test F1: 0.611, CV F1: 0.525±0.081
#   Best params: learning_rate=0.016, max_depth=5, n_estimators=71
#
# random_forest:
#   Test F1: 0.614, CV F1: 0.522±0.076
#   Best params: n_estimators=279, max_depth=14, min_samples_split=3
#
# ✅ アンサンブルモデル保存完了: models/production/production_ensemble.pkl (8.6M)
# ✅ メタデータ保存: production_model_metadata.json
# 🎉 ML学習完了 - 実取引準備完了
#
# 実行時間: 約4分（50 trials）
# F1スコア: 0.56-0.59（Phase 40.6: 50特徴量対応・3クラス分類として良好）
```

### Step 2: Optuna最適化実行（デプロイ前推奨・13-19時間）

#### 🎯 **Optuna最適化概要**

**目的**: 79パラメータ自動最適化（リスク管理・戦略・ML統合・MLハイパーパラメータ）

**最適化内容**:
- リスク管理パラメータ（12パラメータ・50 trials・1時間）
- 戦略パラメータ（30パラメータ・300 trials・3時間）
- ML統合パラメータ（7パラメータ・150 trials・2時間）
- MLハイパーパラメータ（30パラメータ・250 trials・3時間）
- 統合デプロイ（即座）

**期待効果**: +50-70%の収益向上

**実行推奨タイミング**:
- ✅ **デプロイ前**: ML学習後・品質チェック前
- ✅ **定期再最適化**: 四半期（3ヶ月）ごと
- ✅ **市況急変時**: 取引パフォーマンス悪化時
- ✅ **大幅な戦略変更後**: 新戦略追加・既存戦略大幅変更時

**注意**:
- ⏰ 実行時間: 13-19時間（夜間・週末推奨）
- 💾 自動バックアップ: thresholds.yaml自動バックアップ
- 🔄 中断・再開可能: チェックポイント機能利用

#### ⚙️ **実行コマンド**（一括実行推奨）

```bash
# ========================================
# 一括実行（推奨・13-19時間）
# ========================================
python3 scripts/optimization/run_phase40_optimization.py --all

# 実行内容:
#   - リスク管理パラメータ最適化（12パラメータ・1時間）
#   - 戦略パラメータ最適化（30パラメータ・3時間）
#   - ML統合パラメータ最適化（7パラメータ・2時間）
#   - MLハイパーパラメータ最適化（30パラメータ・3時間）
#   - 統合デプロイ（即座）
# 合計: 79パラメータ最適化・13-19時間

# ========================================
# 対話式メニュー実行（段階的実行）
# ========================================
python3 scripts/optimization/run_phase40_optimization.py

# メニュー選択:
#   [1] 全Phase一括実行（13-19時間）
#   [2-6] 個別Phase実行
#   [7] チェックポイントから再開
#   [0] 終了

# ========================================
# DRY RUNモード（事前確認）
# ========================================
python3 scripts/optimization/run_phase40_optimization.py --all --dry-run

# 確認後、実際に適用:
python3 scripts/optimization/run_phase40_optimization.py --all
```

#### 🔍 **最適化完了後の確認**

```bash
# 1. 最適化結果ファイル確認
ls -lh config/optuna_results/
# 期待: 4つのJSONファイル（risk_management, strategy_parameters, ml_integration, ml_hyperparameters）

# 2. thresholds.yaml更新確認
git diff config/core/thresholds.yaml
# 期待: 79パラメータの変更

# 3. バックアップ確認
ls -lt config/core/backups/ | head -1
# 期待: thresholds_backup_YYYYMMDD_HHMMSS.yaml存在

# 4. 最適化結果確認
cat config/optuna_results/phase40_1_risk_management.json | jq '.best_value'
# 期待: 0.8以上（シャープレシオ）
```

#### ⚠️ **実行時の注意**

- ⏰ **実行時間**: 13-19時間（夜間・週末推奨）
- 💾 **自動バックアップ**: thresholds.yaml自動バックアップ
- 🔄 **中断・再開可能**: チェックポイント機能利用
- 📋 **詳細ドキュメント**: `scripts/optimization/README_PHASE40.md`

---

### Step 3: 品質チェック実行（必須・約80秒）

```bash
# 統一品質チェック実行
bash scripts/testing/checks.sh

# 期待結果:
# ✅ 1,097テスト100%成功
# ✅ 70.56%カバレッジ達成
# ✅ flake8・black・isort通過
# ✅ MLモデル整合性確認
```

**役割**: ML学習・Optuna最適化後のシステム全体の健全性確認

---

### Step 4: ペーパーテスト実行（安全性確認・5-10分）

```bash
# ペーパートレード起動
bash scripts/management/run_safe.sh local paper

# 確認項目（5-10分実行）:
# ✅ 50特徴量生成成功（Phase 40.6完了）
# ✅ 5戦略統合動作
# ✅ ML予測機能
# ✅ リスク管理システム
# ✅ Discord通知機能

# 停止
bash scripts/management/run_safe.sh stop
```

**役割**: 本番デプロイ前の実動作確認・各コンポーネント正常性確認

---

### Step 5: バックテスト実行（戦略検証・45分）

```bash
# バックテスト実行
bash scripts/management/run_backtest.sh

# 確認項目:
# ✅ 過去180日データで戦略パフォーマンス検証
# ✅ リスク・リターン分析
# ✅ ドローダウン評価（20%以内）
# ✅ 取引頻度・勝率確認

# 結果確認
ls -t logs/backtest_reports/ | head -1 | xargs cat
```

**役割**: 最適化後のパラメータが過去データで期待通りの性能を出すか検証

---

### Step 6: 最終品質確認（デプロイ直前・約80秒）

```bash
# デプロイ前最終確認
bash scripts/testing/checks.sh

# 期待結果:
# ✅ 1,097テスト100%維持
# ✅ 70.56%カバレッジ維持
# ✅ MLモデル準備完了
```

**役割**: デプロイ直前の最終チェック・全システムの健全性確認

---

### Step 7: コミット・プッシュ・デプロイ実行

```bash
# 変更内容確認・コミット
git add -A
git commit -m "feat: ML学習・Optuna最適化・品質保証完了

🤖 Generated with [Claude Code](https://claude.ai/code)
Co-Authored-By: Claude <noreply@anthropic.com>"

# GitHub プッシュ（CI/CD自動実行）
git push origin main

# デプロイ状況確認
gh run list --limit 5
gh run view --log

# 期待結果:
# ✅ CI/CDパイプライン成功
# ✅ 1,097テスト自動実行通過
# ✅ Cloud Run自動デプロイ成功
```

**役割**: GitHub CI/CD経由で本番環境へ自動デプロイ・品質ゲート適用

---

# 第2部: ペーパーテスト詳細手順

## ペーパートレード完全検証フロー

**目的**: 本番デプロイ前の実動作確認・各コンポーネント正常性検証

```bash
# 1. 品質事前確認
bash scripts/testing/checks.sh

# 2. ペーパートレード起動
bash scripts/management/run_safe.sh local paper

# 3. 検証項目チェック（5-10分実行）
# ✅ MLモデル初期化: ProductionEnsemble読み込み成功（50特徴量対応）
# ✅ 50特徴量生成: 基本15（ATR・EMA・RSI・MACD・BB・Donchian・ADX等） + ラグ10 + 移動統計12 + 交互作用6 + 時間7
# ✅ 5戦略実行: ATR・MochiPoy・MultiTimeframe・Donchian・ADX統合判定
# ✅ ML予測: アンサンブル予測実行（信頼度60%閾値）
# ✅ リスク管理: Kelly基準・ドローダウン制限・ポジションサイジング
# ✅ 取引機能: BUY/SELL/HOLD判定・TP/SL自動配置
# ✅ Discord通知: 3階層通知（Critical/Warning/Info）
# ✅ 統一設定: unified.yaml・thresholds.yaml設定適用

# 4. ログ確認（期待出力）
# [INFO] 🤖 MLモデル初期化成功: ProductionEnsemble (8.6M・50特徴量対応)
# [INFO] 📊 Phase 40.6: 50特徴量完全生成成功
# [INFO] 🎯 5戦略統合判定: 信頼度XX%・シグナル=HOLD/BUY/SELL
# [INFO] 💰 ペーパーモード残高: 10,000円 → XX,XXX円

# 5. 停止
bash scripts/management/run_safe.sh stop
```

---

# 第3部: バックテスト詳細手順

## バックテスト実行

**目的**: 最適化後のパラメータが過去データで期待通りの性能を出すか検証

### 標準実行フロー（推奨）

```bash
# 統合実行スクリプト（45分）
bash scripts/management/run_backtest.sh

# オプション:
#   --days 180      バックテスト期間（デフォルト: 180日）
#   --collect       データ収集のみ
#   --skip-collect  データ収集スキップ
```

### データ収集（初回のみ）

```bash
# 過去180日データ収集
python src/backtest/scripts/collect_historical_csv.py --days 180

# 期待結果:
# ✅ 4時間足: 1,080件
# ✅ 15分足: 17,271件
# ✅ CSV保存: src/backtest/data/historical/
```

### 実行確認項目

```bash
# バックテスト実行
bash scripts/management/run_backtest.sh

# 確認項目:
# ✅ 過去データ読み込み: 1,080件（4h）、17,271件（15m）
# ✅ 特徴量バッチ化: 無限倍高速化済み
# ✅ ML予測バッチ化: 3,000倍高速化済み
# ✅ 5戦略統合・ML予測・リスク管理適用
# ✅ パフォーマンス計算: 収益率・勝率・ドローダウン

# 結果確認（実行後）
tail -100 /tmp/backtest_optimized.log
grep "BUY\|SELL" /tmp/backtest_optimized.log | tail -20

# 評価基準:
# ✅ 実行時間: 45分以内
# ✅ 年間収益率: 10%以上（目標）
# ✅ 最大ドローダウン: 20%以内
# ✅ 勝率: 55%以上（期待）
# ✅ 取引回数: 月100-200回
```

---

# 第4部: 環境構築・初期セットアップ

## システム要件

- **Python**: 3.13
- **Node.js**: 18+（GitHub CLI用）
- **Docker**: 20.10+
- **Git**: 2.30+

## 権限要件

- **GCP**: Editor/Owner権限
- **GitHub**: Admin権限
- **Bitbank API**: 信用取引対応APIキー
- **Discord**: Webhook URL設定権限

## 初回セットアップ

```bash
# リポジトリクローン
git clone <repository-url>
cd crypto-bot

# 依存関係インストール
pip install -r requirements.txt

# 環境確認
python3 --version  # 3.13.x
gcloud --version
docker --version
gh --version
```

## GCP環境構築

```bash
# 自動環境構築（推奨）
bash scripts/deployment/setup_gcp_environment.sh --full

# 設定内容:
# - GCP Project ID設定
# - API有効化（Cloud Run・Artifact Registry・Secret Manager）
# - サービスアカウント作成・権限付与
# - Workload Identity設定（GitHub Actions用）
# - Secret Manager設定（Bitbank API・Discord Webhook）

# 環境検証
bash scripts/deployment/verify_gcp_setup.sh --full
```

---

# 第5部: ローカル開発環境

## 実行クイックリファレンス

### ペーパートレード実行

```bash
# 起動
bash scripts/management/run_safe.sh local paper

# 状況確認
bash scripts/management/run_safe.sh status

# 停止
bash scripts/management/run_safe.sh stop

# 強制停止（Discord通知が止まらない場合）
bash scripts/management/bot_manager.sh stop
```

### バックテスト実行

```bash
# 起動
bash scripts/management/run_safe.sh local backtest

# 結果確認
ls -t logs/backtest_reports/ | head -1 | xargs cat
```

### 品質チェック

```bash
# 統一品質チェック（約80秒）
bash scripts/testing/checks.sh

# 期待: 1,097テスト100%・70.56%カバレッジ
```

## モード別実行

```bash
# ペーパーモード（推奨）
bash scripts/management/run_safe.sh local paper

# ライブモード（本番取引）
bash scripts/management/run_safe.sh local live

# バックテストモード
bash scripts/management/run_safe.sh local backtest
```

## 初期残高設定変更

`config/core/unified.yaml`の`mode_balances`セクションを編集

```yaml
mode_balances:
  paper:
    initial_balance: 100000.0    # 10,000 → 100,000
  live:
    initial_balance: 100000.0
  backtest:
    initial_balance: 100000.0
```

**変更後**:
1. 品質チェック実行: `bash scripts/testing/checks.sh`
2. ペーパーテストで動作確認
3. 停止

## 戦略パラメータ変更

`config/core/thresholds.yaml`の`dynamic_confidence.strategies.*`セクションを編集

**注意事項**:
- 元値の±20%程度の変更に留める
- 品質チェック必須
- ペーパーテストで確認後、本番適用

---

# 第6部: デプロイメント

## CI/CDパイプライン

```bash
# ローカル品質チェック
bash scripts/testing/checks.sh

# コード変更プッシュ（CI/CD自動実行）
git add -A
git commit -m "feat: ML学習・Optuna最適化完了"
git push origin main

# デプロイ状況確認
gh run list --limit 5
gh run view --log
```

## デプロイモード制御

```bash
# ペーパーモード（推奨）
gh secret set DEPLOY_MODE --body "paper"

# 本番モード
gh secret set DEPLOY_MODE --body "live"
```

---

# 第7部: 日常運用・監視

## 日常確認（毎日推奨）

```bash
# 品質チェック
bash scripts/testing/checks.sh

# 本番環境確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1

# 最新ログ確認
gcloud logging read "resource.type=cloud_run_revision" --limit=10

# エラーログ確認
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=10
```

## Discord監視

- **Critical**: システム停止・緊急対応必要
- **Warning**: 残高不足・API異常等
- **Info**: 通常取引・システム状態

---

# 第8部: 緊急時対応

## Critical対応（5分以内）

**症状**: システム完全停止・データ損失

```bash
# ロールバック
gh workflow run ci.yml --ref <安定版コミット>
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100 \
  --region=asia-northeast1

# 緊急停止（最終手段）
gcloud run services update crypto-bot-service-prod \
  --min-instances=0 \
  --region=asia-northeast1
```

## 主なトラブルシューティング

### Discord通知が止まらない

```bash
# 強制停止
bash scripts/management/bot_manager.sh stop

# 停止確認
bash scripts/management/run_safe.sh status
```

### プロセス重複エラー

```bash
# 完全停止後、再実行
bash scripts/management/bot_manager.sh stop
bash scripts/management/run_safe.sh local paper
```

### ドローダウン状態リセット

```bash
# 状態ファイル削除
rm -f src/core/state/drawdown_state.json

# 再起動
bash scripts/management/run_safe.sh local paper
```

## 診断コマンド

```bash
# 品質診断
bash scripts/testing/checks.sh

# 環境診断
bash scripts/deployment/verify_gcp_setup.sh --full

# プロセス診断
bash scripts/management/run_safe.sh status
```

---

# 付録: 主要スクリプトリファレンス

## スクリプト一覧

```
scripts/
├── management/
│   ├── run_safe.sh           # 安全実行（プロセス管理）
│   ├── bot_manager.sh        # 強制停止（Discord問題解決）
│   └── run_backtest.sh       # バックテスト実行
├── ml/
│   └── create_ml_models.py   # ML学習
├── optimization/
│   └── run_phase40_optimization.py  # Optuna最適化
├── testing/
│   └── checks.sh             # 品質チェック
└── deployment/
    ├── setup_gcp_environment.sh     # GCP環境構築
    └── verify_gcp_setup.sh          # GCP環境検証
```

## 主要コマンド

### プロセス管理

```bash
# 起動
bash scripts/management/run_safe.sh local paper

# 停止
bash scripts/management/run_safe.sh stop

# 強制停止（Discord通知問題対応）
bash scripts/management/bot_manager.sh stop
```

### 品質チェック

```bash
# 統一品質チェック（1,097テスト・70.56%カバレッジ）
bash scripts/testing/checks.sh
```

### ML学習・最適化

```bash
# ML学習（約4分・50 trials）
python3 scripts/ml/create_ml_models.py --n-classes 3 --threshold 0.005 --optimize --n-trials 50 --verbose

# Optuna最適化（13-19時間・79パラメータ）
python3 scripts/optimization/run_phase40_optimization.py --all
```

---

**最終更新**: 2025年10月15日 - Phase 40完了後リファクタリング・機能中心の説明に更新
