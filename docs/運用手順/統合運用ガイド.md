# **Phase 29.5完了**・デプロイ前準備・統合運用ガイド

**最終更新**: 2025年9月30日・**Phase 29.5完了**
**対象者**: 開発者・DevOpsエンジニア・システム管理者・運用担当者
**目的**: **デプロイ前準備・ペーパーテスト・バックテスト**の統合運用ガイド（Phase 29.5特化版）

## 📋 概要

**デプロイ前準備に特化**した統合運用ガイドです。ML学習・品質チェック・ペーパーテスト・バックテスト・コミット/プッシュ/デプロイの完全な手順を管理します。**統一設定管理体系・ML予測統合・625テスト・64.74%カバレッジ**による企業級品質保証を実現。

**Phase 29.5システム状態**: **625テスト100%成功・64.74%カバレッジ・ML予測統合実装・真のハイブリッドMLbot実現・企業級品質保証継続** 🚀

### **🎯 Phase 29.5新機能**
- **ML予測統合システム**: 戦略シグナル（70%）+ ML予測（30%）の加重平均統合
- **一致/不一致判定**: ML高信頼度（80%以上）時のボーナス（1.2倍）/ペナルティ（0.7倍）適用
- **動的制御設定**: thresholds.yaml `ml.strategy_integration.*` による運用中パラメータ調整
- **品質保証強化**: ML統合テスト8個追加・64.74%カバレッジ達成

---

# 第0部: **デプロイ前準備**（Phase 29特化・最重要）

## 🚀 **デプロイ前チェックリスト**（必須実行順序）

### **📋 デプロイ前準備フロー（Phase 29標準）**

#### **Step 1: ML学習実行（新機能開発後必須）**
```bash
# === Phase 1: MLモデル再学習実行 ===
echo "🤖 Phase 29: MLモデル学習開始..."
python3 scripts/ml/create_ml_models.py --verbose

# 期待結果（Phase 29基準）:
# ✅ 15特徴量: 完全生成・統一管理対応
# ✅ 3モデル: LightGBM・XGBoost・RandomForest アンサンブル学習
# ✅ ProductionEnsemble: models/production/保存完了
# ✅ 性能評価: F1スコア・精度・再現率・クロスバリデーション
```

#### **Step 2: 品質チェック実行（必須・30秒完了）**
```bash
# === Phase 2: 統一品質チェック実行 ===
echo "🔍 Phase 29: 品質チェック実行..."
bash scripts/testing/checks.sh

# 期待結果（Phase 29.5基準）:
# ✅ 625テスト100%成功
# ✅ 64.74%カバレッジ達成
# ✅ flake8・black・isort通過
# ✅ ML予測統合機能検証
# ✅ 統一設定管理体系検証
# ✅ MLモデル整合性確認
```

#### **Step 3: ペーパーテスト実行（安全性確認）**
```bash
# === Phase 3: ペーパートレード検証 ===
echo "📝 Phase 29: ペーパーテスト開始..."
bash scripts/management/run_safe.sh local paper

# 実行時間: 5-10分（数サイクル確認）
# 確認項目:
# ✅ 15特徴量生成正常
# ✅ 5戦略統合動作
# ✅ ML予測機能
# ✅ リスク管理システム
# ✅ Discord通知機能
# ✅ 統一設定管理体系動作

# 停止
bash scripts/management/run_safe.sh stop
```

#### **Step 4: バックテスト実行（戦略検証）**
```bash
# === Phase 4: バックテスト戦略検証 ===
echo "📊 Phase 29: バックテスト開始..."
bash scripts/management/run_safe.sh local backtest

# 実行時間: 10-15分（過去データ検証）
# 確認項目:
# ✅ 戦略パフォーマンス
# ✅ リスク・リターン分析
# ✅ ドローダウン評価
# ✅ 取引頻度・勝率
# ✅ 統一設定整合性

# 結果確認
ls -t logs/backtest_reports/ | head -1 | xargs cat
```

#### **Step 5: 最終品質確認（デプロイ直前）**
```bash
# === Phase 5: デプロイ前最終確認 ===
echo "🎯 Phase 29: 最終品質確認..."

# 統合品質チェック
bash scripts/testing/checks.sh

# システム総合診断
python3 scripts/testing/dev_check.py check --level standard

# 設定整合性確認
python3 scripts/testing/dev_check.py validate

# 期待結果:
# ✅ 625テスト100%維持
# ✅ 64.74%カバレッジ維持
# ✅ 統一設定管理体系正常
# ✅ MLモデル準備完了
```

#### **Step 6: コミット・プッシュ・デプロイ実行**
```bash
# === Phase 6: デプロイ実行 ===
echo "🚀 Phase 29: デプロイ開始..."

# 1. 変更内容確認
git status
git diff

# 2. 変更をステージング
git add -A

# 3. Phase 29.5準拠コミット
git commit -m "feat: Phase 29.5完了・ML予測統合実装・625テスト品質保証

- ML予測統合システム実装完了
- 625テスト100%成功・64.74%カバレッジ維持
- ハードコード完全排除・設定不整合解消
- MLモデル学習・品質チェック・テスト検証完了
- 企業級品質保証達成・デプロイ前最終最適化完了

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 4. GitHub プッシュ（CI/CD自動実行）
git push origin main

# 5. デプロイ状況確認
gh run list --limit 5
gh run view --log

# 期待結果:
# ✅ CI/CD パイプライン成功
# ✅ 625テスト自動実行通過
# ✅ Cloud Run自動デプロイ成功
# ✅ 本番環境正常稼働確認
```

## 🎯 **ペーパーテスト詳細手順**

### **ペーパートレード完全検証フロー**
```bash
# === ペーパーテスト開始 ===
echo "📝 ペーパートレード詳細検証開始..."

# 1. 環境準備
bash scripts/testing/checks.sh  # 品質事前確認

# 2. ペーパートレード起動
bash scripts/management/run_safe.sh local paper

# 3. リアルタイム監視（別ターミナル）
# 以下の動作を5-10分間確認:

# ✅ 検証項目チェックリスト:
# [ ] 🤖 MLモデル初期化: ProductionEnsemble読み込み成功
# [ ] 📊 15特徴量生成: ATR・EMA・RSI・MACD・BB・ZZ・RCI・Donchian・ADX等
# [ ] 🎯 5戦略実行: ATR・MochiPoy・MultiTimeframe・Donchian・ADX統合判定
# [ ] 🧠 ML予測: 信頼度35%閾値・アンサンブル予測実行
# [ ] ⚖️ リスク管理: Kelly基準・ドローダウン制限・ポジションサイジング
# [ ] 💰 取引機能: BUY/SELL判定・テイクプロフィット・ストップロス
# [ ] 📱 Discord通知: 3階層通知（Critical/Warning/Info）
# [ ] 🔧 統一設定: unified.yaml・thresholds.yaml設定適用確認
# [ ] 🛡️ エラーハンドリング: 異常時の適切な処理・ログ出力

# 4. ログ確認（期待する出力例）
# [INFO] 🤖 MLモデル初期化成功: ProductionEnsemble
# [INFO] 📊 15特徴量生成完了: 技術指標計算成功
# [INFO] 🎯 5戦略統合判定: 信頼度XX%・シグナル=HOLD/BUY/SELL
# [INFO] 💰 ペーパーモード残高: 10,000円 → XX,XXX円

# 5. 安全停止
bash scripts/management/run_safe.sh stop

# 6. 結果評価
echo "✅ ペーパーテスト完了: 全システム正常動作確認"
```

## 📊 **バックテスト詳細手順**（Phase 35完了）

### **🎯 Phase 34完了事項**
- **15分足データ収集**: 80倍改善（216→17,271件）・Bitbank Public API直接使用
- **バックテスト実行スクリプト**: `scripts/management/run_backtest.sh`実装済み
- **CSV過去データ**: 180日間・4h（1,080件）・15m（17,271件）収集完了
- **データ収集コマンド**: `python src/backtest/scripts/collect_historical_csv.py`

### **🚀 Phase 35完了事項**（2025年10月7日）
- **特徴量バッチ化**: 288分 → 0秒（無限倍高速化）・事前計算方式実装
- **ML予測バッチ化**: 約15分 → 0.3秒（3,000倍高速化）・NumPy配列ベクトル化
- **価格データ正常化**: entry_price追加・¥0価格問題完全解決
- **合計実行時間**: 6-8時間 → **45分**（約10倍高速化）
- **性能測定実現**: 正確な勝率・年間収益率・ドローダウン測定が可能に

### **バックテスト実行スクリプト**（推奨・Phase 35最適化版）
```bash
# === バックテスト統合実行スクリプト（Phase 35最適化済み・45分実行） ===
bash scripts/management/run_backtest.sh

# オプション:
# --days N        バックテスト期間（日数）[default: 180]
# --collect       データ収集のみ実行
# --skip-collect  データ収集をスキップ
# --help          ヘルプ表示

# 実行例:
bash scripts/management/run_backtest.sh                      # 180日間バックテスト実行（45分）
bash scripts/management/run_backtest.sh --days 30            # 30日間バックテスト実行（10分程度）
bash scripts/management/run_backtest.sh --collect --days 90  # 90日間データ収集のみ
bash scripts/management/run_backtest.sh --skip-collect       # データ収集スキップ（既存データ使用）

# Phase 35最適化効果:
# ✅ 特徴量計算: 0秒（バッチ化済み）
# ✅ ML予測: 0.3秒（バッチ化済み）
# ⏱️ 合計実行時間: 約45分（戦略評価25分+リスク評価15分+その他5分）
```

### **バックテストデータ収集**（Phase 34完了）
```bash
# === CSVデータ収集（Phase 34実装） ===
python src/backtest/scripts/collect_historical_csv.py --days 180

# オプション:
# --days N           収集日数（デフォルト: 180日）
# --symbol PAIR      通貨ペア（デフォルト: BTC/JPY）
# --timeframes TF    タイムフレーム（デフォルト: 4h 15m）

# 実行例:
python src/backtest/scripts/collect_historical_csv.py --days 180
python src/backtest/scripts/collect_historical_csv.py --days 90 --symbol BTC/JPY
python src/backtest/scripts/collect_historical_csv.py --days 30 --timeframes 15m

# 期待結果（180日間）:
# ✅ 4時間足: 1,080件（100%成功率）
# ✅ 15分足: 17,271件（99.95%成功率・80倍改善）
# ✅ CSV保存: src/backtest/data/historical/BTC_JPY_4h.csv
# ✅ CSV保存: src/backtest/data/historical/BTC_JPY_15m.csv
```

### **バックテスト戦略検証フロー**（Phase 35最適化版・45分実行）
```bash
# === バックテスト開始（Phase 35最適化版） ===
echo "📊 バックテスト戦略検証開始（45分実行）..."

# 1. データ収集（初回のみ）
python src/backtest/scripts/collect_historical_csv.py --days 180

# 2. バックテスト実行（Phase 35最適化済み・推奨）
bash scripts/management/run_backtest.sh

# または直接実行
BACKTEST_MODE=true python main.py --mode backtest

# 3. 実行時確認項目（Phase 35最適化）:
# ✅ 過去データ読み込み: CSVファイル（4h: 1,080件、15m: 17,271件）
# ✅ 特徴量事前計算: 2,825件/0秒（264,733件/秒・バッチ化）
# ✅ ML予測事前計算: 2,659件/0.3秒（9,389件/秒・バッチ化）
# ✅ 戦略バックテスト: 5戦略統合・ML予測・リスク管理適用
# ✅ パフォーマンス計算: 収益率・勝率・最大ドローダウン・取引頻度
# ✅ 価格データ正常: entry_price設定済み（¥0問題解決）

# 4. 実行進捗確認（別ターミナル）
tail -f /tmp/backtest_optimized.log | grep "取引実行完了\|サイクル"

# 5. 結果確認（実行後・約45分）
# ログファイル確認
tail -100 /tmp/backtest_optimized.log

# BUY/SELL取引確認
grep "BUY\|SELL" /tmp/backtest_optimized.log | tail -20

# 価格データ確認（Phase 35.3修正済み）
grep "価格: ¥" /tmp/backtest_optimized.log | tail -10

# 6. 評価基準（Phase 35標準）:
# ✅ 実行時間: 45分以内（Phase 35最適化達成）
# ✅ データ品質: 価格正常（¥0でない）・BUY/SELL両方存在
# ✅ 年間収益率: 10%以上（目標）
# ✅ 最大ドローダウン: 20%以内（制限）
# ✅ 勝率: 55%以上（期待）
# ✅ 取引回数: 月100-200回範囲
# ✅ エラーゼロ: ログに異常なし

# 7. 性能分析レポート作成（Phase 35）
echo "📈 バックテスト性能分析:"
echo "  実行時間: 45分"
echo "  完了サイクル: XXXX/2,659"
echo "  BUY取引: XXX件"
echo "  SELL取引: XXX件"
echo "  価格データ: 正常"
```

### **バックテストシステム技術詳細**（Phase 35完了）

**Phase 34実装（データ収集）**:
- **Bitbank Public API直接使用**: `https://public.bitbank.cc/{pair}/candlestick/15min/{YYYYMMDD}`
- **日別イテレーション**: 180日間 = 180 APIコール・1秒待機
- **重複除去**: timestampキー辞書・時系列ソート
- **ccxt制限回避**: 大量データ取得の根本的解決（216→17,271件・80倍改善）

**Phase 35実装（性能最適化）**:
- **特徴量バッチ化**: `_precompute_features()`・全サイクル分事前計算・288分→0秒
- **ML予測バッチ化**: `_precompute_ml_predictions()`・NumPy配列ベクトル化・約15分→0.3秒
- **価格データ正常化**: `TradeEvaluation.entry_price`追加・¥0価格問題完全解決
- **環境変数ゲート**: `BACKTEST_MODE=true`・本番影響ゼロ・安全性確保
- **合計最適化効果**: 6-8時間 → 45分（約10倍高速化）

**バックテスト実行システム**:
- **DataPipeline.set_backtest_data()**: CSV読み込み・バックテストモード設定
- **BacktestRunner**: 事前計算（特徴量・ML予測）→サイクル実行→統計計算
- **TradingCycleManager**: キャッシュ使用（特徴量・ML予測）・高速実行
- **ExecutionService**: TradeEvaluation処理・entry_price設定・取引記録

---

# 第1部: 環境構築・初期セットアップ

## 🛠️ 前提条件・要件

### **システム要件**
- **Python**: 3.13（MLライブラリ互換性最適化・GitHub Actions統一）
- **Node.js**: 18+ （GitHub CLI用）
- **Docker**: 20.10+ （コンテナ化デプロイ用）
- **Git**: 2.30+ （バージョン管理）

### **権限・アカウント要件**
- **GCP Project**: Editor またはOwner権限
- **GitHub Repository**: Admin権限
- **Bitbank API**: 信用取引対応APIキー
- **Discord**: Webhook URL設定権限

### **初回セットアップ**
```bash
# プロジェクトクローン
git clone <repository-url>
cd crypto-bot

# Python依存関係インストール
pip install -r requirements.txt

# 環境確認
python3 --version  # 3.13.x確認
gcloud --version    # gcloud CLI確認
docker --version    # Docker確認
gh --version        # GitHub CLI確認
```

## 🔧 GCP環境構築

### **自動環境構築（推奨）**
```bash
# 統合GCP環境構築スクリプト実行
bash scripts/deployment/setup_gcp_environment.sh --full

# 対話式セットアップで以下を設定:
# - GCP Project ID設定
# - 必要なAPI有効化（Cloud Run・Artifact Registry・Secret Manager等）
# - Artifact Registryリポジトリ作成
# - サービスアカウント作成・権限付与
# - Workload Identity設定（GitHub Actions用）
# - Secret Manager設定（Bitbank API・Discord Webhook）
```

### **環境検証・設定確認**
```bash
# 包括的環境検証
bash scripts/deployment/verify_gcp_setup.sh --full

# Cloud Run専用確認
bash scripts/deployment/verify_gcp_setup.sh --cloud-run-check

# GitHub Actions連携確認
bash scripts/deployment/verify_gcp_setup.sh --github-check
```

---

# 第2部: ローカル開発環境・Phase 29クイックリファレンス

## 🚀 AI即座実行クイックリファレンス

### **🎯 Discord通知停止問題完全解決手順（最新）**

#### **2段階停止システム**
```bash
# === Step 1: 通常停止（推奨・第1段階） ===
bash scripts/management/run_safe.sh stop

# === Step 2: 強制停止（緊急時・第2段階） ===
bash scripts/management/bot_manager.sh stop

# === Step 3: 停止確認 ===
bash scripts/management/run_safe.sh status
# → "プロセス停止中" が表示されれば完全停止成功
```

#### **Discord通知が止まらない場合の確実な解決法**
```bash
# 🛑 Discord通知無限ループ緊急停止
bash scripts/management/bot_manager.sh stop --verbose

# 期待結果:
# ========================================
# 🛑 crypto-bot 完全停止スクリプト
# ========================================
# [INFO] 🔍 crypto-bot関連プロセスを検索中...
# [INFO] 🛑 プロセス停止開始 (対象: X個)
# [INFO] 🔄 プロセスグループ停止: PGID=XXXX
# [INFO] ✅ プロセス正常終了
# [INFO] 🧹 ファイルクリーンアップ開始
# [INFO] 🎉 完全停止完了
```

### **安全実行（推奨方法）**

#### **ペーパートレード実行**
```bash
# ペーパートレード開始（プロセス重複防止・環境自動判定）
bash scripts/management/run_safe.sh local paper

# 実行状況確認（詳細表示・子プロセス確認）
bash scripts/management/run_safe.sh status

# 通常停止
bash scripts/management/run_safe.sh stop

# 強制停止（Discord通知が止まらない場合）
bash scripts/management/bot_manager.sh stop

# ⚠️ macOS注意: timeoutコマンド未対応
# × 動作しない: timeout 30 bash scripts/management/run_safe.sh local paper
# ○ 正しい方法: bash scripts/management/run_safe.sh local paper （Ctrl+Cまたはstopで停止）
```

#### **🔧 Claude Code使用時の注意事項（重要）**

**バックグラウンドプロセス誤認識問題と回避策**:

Claude Code（claude.ai/code）で実行する場合、内部トラッキングシステムの制限により、**バックグラウンドプロセスが終了後も'running'として誤認識される問題**があります。

```bash
# ❌ 非推奨: バックグラウンド実行（Claude Code誤認識の原因）
bash scripts/management/run_safe.sh local paper --background
# → プロセス終了後もClaude Codeが'running'と表示し続ける

# ✅ 推奨: フォアグラウンド実行（誤認識なし・デフォルト）
bash scripts/management/run_safe.sh local paper
# → 正常に終了・Claude Code誤認識なし

# 実プロセス状況の確認方法（Claude Code表示を無視）
bash scripts/management/bot_manager.sh check
# → 「✅ 実行中のプロセスなし」が表示されれば実際には停止している
```

**誤認識が発生した場合の対処法**:

1. **実プロセス状況を確認** - Claude Codeの表示を信用せず、以下で確認:
   ```bash
   bash scripts/management/bot_manager.sh check
   ```

2. **「✅ システム完全停止状態」が表示されれば安全** - Claude Codeが'running'と表示していても、実際には停止

3. **新規実行は問題なし** - 実プロセスが停止していれば新規実行可能

**推奨実行方法（Claude Code環境）**:
```bash
# 1. フォアグラウンド実行（デフォルト・推奨）
bash scripts/management/run_safe.sh local paper

# 2. 実行確認（実プロセス状況）
bash scripts/management/bot_manager.sh check

# 3. 停止
bash scripts/management/run_safe.sh stop
```

**タイムアウト機能について**:
- フォアグラウンド実行時は自動タイムアウト機能付き（14400秒 = 4時間）
- タイムアウトはオーバーヘッドなし・性能影響ゼロ
- 通常動作（5-10秒/サイクル）なら4時間以内に必ず正常終了

#### **バックテスト実行**
```bash
# バックテスト開始
bash scripts/management/run_safe.sh local backtest

# 実行状況確認
bash scripts/management/run_safe.sh status

# 結果確認
ls -t logs/backtest_reports/ | head -1 | xargs cat
```

### **品質チェック（開発時必須）**
```bash
# 統一品質チェック（30秒で完了）
bash scripts/testing/checks.sh

# 期待結果: ✅ 625テスト100%成功・64.74%カバレッジ通過
```

## 🎯 モード別実行・残高設定（Phase 23一元管理）

### **ペーパーモード/ライブモード設定**

#### **モード切り替え**
```bash
# ペーパーモード実行（推奨・安全）
bash scripts/management/run_safe.sh local paper

# ライブモード実行（本番取引）
bash scripts/management/run_safe.sh local live

# バックテストモード実行
bash scripts/management/run_safe.sh local backtest
```

### **初期残高設定変更（10万円・50万円等）**

**Phase 23新機能**: 残高変更は`config/core/unified.yaml` **1箇所のみ**で完結

```bash
# 1. unified.yamlのmode_balances設定を編集
vim config/core/unified.yaml

# 編集例（1万円→10万円への変更）:
mode_balances:
  paper:
    initial_balance: 100000.0    # 10,000 → 100,000に変更
  live:
    initial_balance: 100000.0    # 10,000 → 100,000に変更
  backtest:
    initial_balance: 100000.0    # 10,000 → 100,000に変更

# 2. 設定適用確認（品質チェック）
bash scripts/testing/checks.sh

# 3. ペーパートレードで動作確認
bash scripts/management/run_safe.sh local paper
# → ログで初期残高確認: "💰 ペーパーモード残高（mode_balances）: 100000.0円"

# 4. 停止
bash scripts/management/run_safe.sh stop
```

**重要**:
- ✅ 各ファイルの個別修正は**不要** - unified.yamlのみ修正
- ✅ paper/live/backtest全モード統一管理
- ✅ 状態ファイルは`src/core/state/{mode}/`に自動分離
- ✅ 本番環境への影響なし（モード別完全分離）

### **🆕 戦略パラメータ変更手順（Phase 29新機能）**

**戦略固有パラメータのハードコード完全排除**により、戦略の数値パラメータを運用中に変更可能。

#### **戦略パラメータ変更フロー**
```bash
# 1. thresholds.yamlの戦略固有設定を編集
vim config/core/thresholds.yaml

# 編集例（ATRBased戦略のパラメータ調整）:
dynamic_confidence:
  strategies:
    atr_based:
      position_size_base: 0.02              # 0.015 → 0.02（ポジションサイズ拡大）
      market_stress_threshold: 0.6          # 0.7 → 0.6（取引機会拡大）
      min_atr_ratio: 0.4                    # 0.5 → 0.4（低ボラ時取引許可）
      strength_normalize: 25.0              # 30.0 → 25.0（RSI感度向上）

# 編集例（MultiTimeframe戦略のパラメータ調整）:
    multi_timeframe:
      tf_4h_min_strength: 0.003             # 0.002 → 0.003（トレンド判定厳格化）
      tf_4h_weight: 0.7                     # 0.6 → 0.7（4時間足重視）
      tf_15m_weight: 0.3                    # 0.4 → 0.3（15分足軽減）
      position_size_base: 0.03              # 0.025 → 0.03（積極サイジング）
      atr_ratio_threshold: 0.006            # 0.005 → 0.006（ボラティリティ要求上昇）

# 2. 設定適用確認（品質チェック）
bash scripts/testing/checks.sh

# 3. ペーパートレードで動作確認（戦略パラメータ変更確認）
bash scripts/management/run_safe.sh local paper

# ログで変更確認例:
# [INFO] ATRBased戦略: position_size_base=0.02 (変更後)
# [INFO] MultiTimeframe戦略: tf_4h_weight=0.7, tf_15m_weight=0.3 (変更後)

# 4. 動作確認後停止
bash scripts/management/run_safe.sh stop
```

#### **変更可能パラメータ一覧**

**ATRBased戦略（`dynamic_confidence.strategies.atr_based.*`）**:
- `position_size_base`: 基本ポジションサイズ（デフォルト: 0.015）
- `market_stress_threshold`: 市場ストレス閾値（デフォルト: 0.7）
- `min_atr_ratio`: 最小ATR比率（デフォルト: 0.5）
- `strength_normalize`: RSI強度正規化値（デフォルト: 30.0）
- `rsi_base`: RSI基本信頼度（デフォルト: 0.2）

**MultiTimeframe戦略（`dynamic_confidence.strategies.multi_timeframe.*`）**:
- `tf_4h_min_strength`: 4時間足最小トレンド強度（デフォルト: 0.002）
- `tf_4h_weight`: 4時間足重み（デフォルト: 0.6）
- `tf_15m_weight`: 15分足重み（デフォルト: 0.4）
- `position_size_base`: 基本ポジションサイズ（デフォルト: 0.025）
- `atr_ratio_threshold`: ATR比率閾値（デフォルト: 0.005）
- `price_breakout_ratio`: 価格ブレイクアウト比率（デフォルト: 0.995）

**変更時の注意事項**:
- ⚠️ **過度なパラメータ変更は避ける**: 元値の±20%程度の変更に留める
- ⚠️ **品質チェック必須**: 設定変更後は必ず`bash scripts/testing/checks.sh`実行
- ⚠️ **ペーパーテストで確認**: 本番前にペーパーモードで動作確認
- ✅ **リアルタイム適用**: プロセス再起動で設定値即座反映

## 📋 プロセス管理詳細

### **🆕 改善されたプロセス管理システム**

#### **run_safe.sh 機能詳細**
- **プロセスグループ管理**: 独立実行・子プロセス含む確実停止（setsid利用可能環境）
- **詳細監視**: 子プロセス・動作モード・経過時間表示
- **bot_manager.sh統合**: 通常停止失敗時の強制停止提案
- **⚠️ macOS制限事項**:
  - `setsid`コマンド未対応（一部機能制限あり）
  - `timeout`コマンド未対応（時間制限実行不可）
  - **対処法**: Ctrl+C または `bash scripts/management/run_safe.sh stop` で停止

#### **bot_manager.sh統合機能（2025年9月21日）**
- **全プロセス検出**: pgrep・ps・ロックファイル 3段階検索
- **プロセスグループ停止**: 親子プロセス一括終了
- **段階的終了**: SIGTERM(10秒) → SIGKILL(5秒) 安全停止
- **完全クリーンアップ**: 全ロック・PIDファイル削除
- **macOS完全対応**: bash互換性・配列処理最適化

### **プロセス状況確認（改善版）**
```bash
$ bash scripts/management/run_safe.sh status

📊 暗号資産取引Bot実行状況
✅ プロセス実行中: PID=12345, 経過時間=15分
   └─ 子プロセス: 12346 12347
   └─ 動作モード: paper
```

## 🛡️ トラブルシューティング

### **🎯 Discord通知停止問題（完全解決済み）**

#### **問題**: Discord通知が1分間隔で止まらない
**解決**: bot_manager.sh統合による完全停止システム

```bash
# === 確実な解決手順（1分以内） ===
# Step 1: 強制停止実行
bash scripts/management/bot_manager.sh stop

# Step 2: 停止確認
bash scripts/management/run_safe.sh status

# Step 3: 完全クリーンアップ（必要時）
bash scripts/management/bot_manager.sh stop --verbose
```

### **プロセス管理関連問題**

#### **「既にプロセスが実行中です」エラー**
```bash
# 解決: bot_manager.sh stop で完全停止
bash scripts/management/bot_manager.sh stop
bash scripts/management/run_safe.sh local paper  # 再実行
```

#### **プロセスが見つからない**
```bash
# 解決: bot_manager.sh check の詳細検索
bash scripts/management/bot_manager.sh stop --verbose
```

#### **子プロセスが残る**
```bash
# 解決: プロセスグループ停止
bash scripts/management/bot_manager.sh stop
```

### **🚨 ドローダウン状態問題（対処法）**
**問題**: 「取引拒否: リスクスコア=100.0%, 理由=ドローダウン制限」

```bash
# 定期対処法（推奨）
# 1. ドローダウン状態確認
cat src/core/state/drawdown_state.json 2>/dev/null || echo "状態ファイル未存在"

# 2. paused_consecutive_loss状態の場合は状態リセット
rm -f src/core/state/drawdown_state.json

# 3. ペーパートレード再起動で正常化確認
bash scripts/management/run_safe.sh local paper
```

## 📊 実行例・期待結果

### **改善された実行例（run_safe.sh）**
```bash
$ bash scripts/management/run_safe.sh local paper

========================================
🚀 暗号資産取引Bot安全実行
========================================

[INFO]  2025-09-21 10:30:00 - 🔒 プロセスロック取得: PID=12345
[INFO]  2025-09-21 10:30:00 - 🌍 実行環境設定: local
[INFO]  2025-09-21 10:30:00 - 💻 ローカル環境設定完了
[INFO]  2025-09-21 10:30:00 - 🎯 動作モード: paper
[INFO]  2025-09-21 10:30:00 - 🚀 暗号資産取引Bot起動開始

🚀 暗号資産取引Bot 起動 - モード: PAPER
📝 ペーパートレードモード開始
💰 初期資金: ¥1,000,000
⏳ リアルタイム取引判定実行中...

# Ctrl+C または stop コマンドで安全停止
```

### **bot_manager.sh stop実行例**
```bash
$ bash scripts/management/bot_manager.sh stop

========================================
🛑 crypto-bot 完全停止スクリプト
========================================

[INFO]  2025-09-21 07:00:00 - 🔍 crypto-bot関連プロセスを検索中...

========================================
🔍 検出されたプロセス詳細
========================================
PID PPID USER     TIME COMMAND
7527  123 nao      0:15 python3 main.py --mode paper
  └─ 子プロセス: 7528 7529

[INFO]  2025-09-21 07:00:05 - 🛑 プロセス停止開始 (対象: 1個)
[INFO]  2025-09-21 07:00:05 - 🔄 プロセスグループ停止: PGID=7527
[INFO]  2025-09-21 07:00:15 - ✅ プロセス正常終了
[INFO]  2025-09-21 07:00:15 - 🧹 ファイルクリーンアップ開始
[INFO]  2025-09-21 07:00:15 - 🎉 完全停止完了
```

## ⚠️ 重要な実行ガイドライン

### **推奨実行方式（2段階停止システム）**
1. **通常実行**: `bash scripts/management/run_safe.sh` 経由実行（プロセス管理・重複防止）
2. **通常停止**: `bash scripts/management/run_safe.sh stop`（プロセスグループ対応）
3. **強制停止**: `bash scripts/management/bot_manager.sh stop`（Discord通知問題完全解決）
4. **非推奨**: `python3 main.py` 直接実行（Discord通知無限ループリスク）

### **開発前後の必須チェック**
```bash
# 開発前
bash scripts/testing/checks.sh

# 開発後
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py check --level standard
```

---

# 第3部: 開発・品質管理

## 🧪 品質チェックシステム

### **メイン品質チェック（必須）**
```bash
# 開発前後に必ず実行 - 約30秒で完了
bash scripts/testing/checks.sh

# 期待結果（Phase 29統一設定管理体系標準）:
# ✅ 625テスト100%成功
# ✅ 64.74%カバレッジ達成（目標55%クリア）
# ✅ コードスタイル準拠（flake8・black・isort）
# ✅ 15特徴量統合システム正常動作
# ✅ MLモデル整合性確認
```

### **統合開発管理CLI**
```bash
# 統一設定管理体系統合品質チェック（推奨）
python3 scripts/testing/dev_check.py full-check

# 個別機能チェック
python3 scripts/testing/dev_check.py validate       # 基本品質チェック
python3 scripts/testing/dev_check.py ml-models      # MLモデル作成・検証
python3 scripts/testing/dev_check.py data-check     # データ取得・15特徴量確認
python3 scripts/testing/dev_check.py status         # システム状態確認

# 本番環境監視
python3 scripts/testing/dev_check.py health-check   # Cloud Run・GCP確認
```

## 🤖 機械学習システム

### **MLモデル学習・管理**

#### **MLモデル再学習実行（システム改修後必須）**
```bash
# モデル改修後の再学習（RandomForest並列処理修正等）
python3 scripts/ml/create_ml_models.py --verbose

# 学習成果確認:
# ✅ 15特徴量: 完全生成・統一管理対応
# ✅ 3モデル: LightGBM・XGBoost・RandomForest アンサンブル学習
# ✅ RandomForest: n_jobs=1（Python 3.13対応・Container安定化）
# ✅ 本番モデル: ProductionEnsemble保存（models/production/）
# ✅ 性能評価: F1スコア・精度・再現率・クロスバリデーション

# 期待結果例:
# ✅ lightgbm 学習完了 - F1: 1.000, CV F1: 0.546±0.051
# ✅ xgboost 学習完了 - F1: 1.000, CV F1: 0.509±0.047
# ✅ random_forest 学習完了 - F1: 0.987, CV F1: 0.504±0.051
# ✅ ProductionEnsembleアンサンブルモデル作成完了
```

#### **MLモデル再学習→ペーパートレード統合フロー**
```bash
# === Phase 1: MLモデル再学習 ===
python3 scripts/ml/create_ml_models.py --verbose

# === Phase 2: 品質チェック（必須） ===
bash scripts/testing/checks.sh

# === Phase 3: ペーパートレード実行（安全実行） ===
bash scripts/management/run_safe.sh local paper

# === Phase 4: 実行状況監視 ===
bash scripts/management/run_safe.sh status

# === Phase 5: 安全停止 ===
bash scripts/management/run_safe.sh stop
```

---

# 第4部: デプロイメント

## 🚀 CI/CDパイプライン

### **自動CI/CDフロー（推奨）**
```bash
# 1. ローカル品質チェック
bash scripts/testing/checks.sh

# 2. コード変更をプッシュしてCI/CD実行
git add -A
git commit -m "feat: 新機能追加"
git push origin main

# 3. デプロイ状況確認
gh run list --limit 5
gh run view --log
```

### **デプロイモード制御**
```bash
# ペーパートレードモード（安全・推奨）
gh secret set DEPLOY_MODE --body "paper"

# 本番取引モード
gh secret set DEPLOY_MODE --body "live"
```

---

# 第5部: 日常運用・監視

## 📊 24時間監視体制

### **システム状態確認（毎日推奨）**
```bash
# 統一品質チェック（30秒で完了）
bash scripts/testing/checks.sh

# システム総合診断
python3 scripts/testing/dev_check.py check --level standard

# 🆕 プロセス管理状況確認（詳細表示）
bash scripts/management/run_safe.sh status

# 本番環境稼働確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1

# 最新ログ確認
gcloud logging read "resource.type=cloud_run_revision" --limit=10

# 🆕 ローカル動作確認（短時間テスト）
bash scripts/management/run_safe.sh local paper  # 2-3分実行後停止
bash scripts/management/run_safe.sh stop         # 安全停止
```

### **Discord監視・アラート確認**
```bash
# Discord通知履歴確認（システム分析）
python3 scripts/analytics/base_analyzer.py --discord-check

# エラーログ確認（過去24時間）
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=10
```

---

# 第6部: 緊急時対応

## 🚨 緊急度別対応時間

### **Critical レベル（5分以内）**
**症状**: システム完全停止・データ損失・取引機能完全停止

```bash
# 即座ロールバック
gh workflow run ci.yml --ref <安定版コミット>
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100 \
  --region=asia-northeast1

# 緊急停止（最終手段）
gcloud run services update crypto-bot-service-prod \
  --min-instances=0 \
  --region=asia-northeast1
```

### **Discord通知問題緊急対応**
```bash
# 🚨 Discord通知無限ループ緊急停止
bash scripts/management/bot_manager.sh stop --verbose

# 🔄 システム正常化確認
bash scripts/management/run_safe.sh status

# 📊 完全クリーンアップ（必要時）
bash scripts/management/bot_manager.sh stop
bash scripts/management/run_safe.sh cleanup
```

## 🔍 トラブルシューティング

### **🆕 プロセス管理関連の問題と対処法（完全解決済み）**

#### **Discord通知が止まらない問題**
```bash
# === 完全解決手順（1分以内） ===
# 🛑 Discord通知無限ループ緊急停止
bash scripts/management/bot_manager.sh stop

# 📊 停止確認
bash scripts/management/run_safe.sh status
# → "プロセス停止中" 表示で完全停止成功

# 🔄 必要に応じて詳細停止
bash scripts/management/bot_manager.sh stop --verbose
```

#### **「既にプロセスが実行中です」エラー**
```bash
# 解決: bot_manager.sh stop で完全停止
bash scripts/management/bot_manager.sh stop
bash scripts/management/run_safe.sh local paper  # 再実行
```

### **診断コマンド集**
```bash
# システム全体診断
python3 scripts/testing/dev_check.py full-check

# 環境診断
bash scripts/deployment/verify_gcp_setup.sh --full

# 品質診断
bash scripts/testing/checks.sh

# 🆕 プロセス診断
bash scripts/management/run_safe.sh status
bash scripts/management/bot_manager.sh stop --dry-run
```

---

# 付録: スクリプトリファレンス

## 📂 scriptsディレクトリ構成

```
scripts/
├── analytics/          # システム分析基盤
│   ├── base_analyzer.py    # Cloud Runログ取得・システム監視・分析機能
│   └── README.md
├── deployment/         # デプロイメント・インフラ管理
│   ├── deploy_production.sh        # 本番環境デプロイ・段階的リリース
│   ├── docker-entrypoint.sh        # Dockerコンテナエントリポイント
│   ├── setup_gcp_environment.sh    # 統合GCP環境構築・認証管理
│   ├── verify_gcp_setup.sh         # GCP環境検証・設定確認
│   └── README.md
├── 🆕 management/        # プロセス管理・安全実行システム（2025年9月21日完全版）
│   ├── run_safe.sh              # 安全実行スクリプト（プロセスグループ管理改修）
│   ├── 🔧 bot_manager.sh        # 統合管理スクリプト（force_stop.sh統合・Discord通知問題完全解決）
│   └── README.md                # 管理スクリプト詳細説明（最新版）
├── ml/                 # 機械学習モデル学習・管理
│   ├── create_ml_models.py          # Phase22対応・15特徴量MLモデル学習
│   └── README.md
└── testing/            # 品質保証・テストシステム
    ├── checks.sh                    # 品質チェック・テスト実行（30秒完了）
    ├── dev_check.py                 # 統合開発管理CLI・システム診断
    └── README.md
```

## 🔧 主要スクリプト詳細

### **🆕 プロセス管理・安全実行システム（2025年9月21日完全版）**

#### `scripts/management/run_safe.sh`（改修版）
安全実行スクリプト・プロセスグループ管理・詳細監視システム
```bash
# 使用例
bash scripts/management/run_safe.sh local paper     # ペーパートレード安全実行
bash scripts/management/run_safe.sh local backtest  # バックテスト安全実行
bash scripts/management/run_safe.sh gcp live        # GCP環境ライブトレード
bash scripts/management/run_safe.sh status          # 詳細プロセス状況確認
bash scripts/management/run_safe.sh stop            # プロセスグループ対応停止
bash scripts/management/run_safe.sh cleanup         # ロックファイルクリーンアップ

# 🆕 改修機能（2025年9月21日）:
# - setsidによるプロセスグループ独立実行
# - プロセスグループ全体への段階的停止（SIGTERM→SIGKILL）
# - 子プロセス・動作モード・経過時間詳細表示
# - bot_manager.sh統合提案・2段階停止システム
# - 詳細PIDファイル管理（開始時刻・モード記録）
```

#### `scripts/management/bot_manager.sh`（force_stop.sh統合済み）
**Discord通知停止問題完全解決**・包括的強制停止スクリプト（625行実装）
```bash
# 使用例
bash scripts/management/bot_manager.sh stop               # 全crypto-bot関連プロセス強制停止
bash scripts/management/bot_manager.sh stop --dry-run     # 確認のみ（実際停止なし）
bash scripts/management/bot_manager.sh stop --verbose     # 詳細ログ付き実行

# 🎉 完全解決機能:
# - 3段階プロセス検索（pgrep・ps・ロックファイル）完全検出
# - プロセスグループ単位完全停止（親子プロセス一括終了）
# - 段階的終了（SIGTERM 10秒→SIGKILL 5秒）安全停止
# - 完全クリーンアップ（全ロック・PIDファイル削除）
# - macOS完全対応（bash互換性・配列処理最適化）
# - Discord通知無限ループ問題100%解決
```

## 💡 コマンド例集

### **🆕 プロセス管理ワークフロー（2025年9月21日版）**
```bash
# === 推奨実行フロー（2段階停止システム） ===
# 1. 安全実行
bash scripts/management/run_safe.sh local paper

# 2. 状況確認（詳細表示）
bash scripts/management/run_safe.sh status

# 3. 通常停止（プロセスグループ対応）
bash scripts/management/run_safe.sh stop

# 4. 強制停止（Discord通知が止まらない場合）
bash scripts/management/bot_manager.sh stop

# 5. 完全停止確認
bash scripts/management/run_safe.sh status
```

### **緊急時対応ワークフロー（Discord通知問題）**
```bash
# === Discord通知無限ループ緊急対応（1分以内解決） ===
# Step 1: 強制停止実行
bash scripts/management/bot_manager.sh stop --verbose

# Step 2: 停止確認
bash scripts/management/run_safe.sh status

# Step 3: 完全クリーンアップ（必要時）
bash scripts/management/bot_manager.sh stop
bash scripts/management/run_safe.sh cleanup

# → 100%確実にDiscord通知停止
```

### **日常開発ワークフロー**
```bash
# 1. 開発前品質確認
bash scripts/testing/checks.sh

# 2. 機能開発・テスト追加
# ...コード修正...

# 3. 開発後品質確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py check --level standard

# 🆕 4. 安全実行による動作確認（短時間テスト）
bash scripts/management/run_safe.sh local paper  # 2-3分実行
bash scripts/management/run_safe.sh stop         # 安全停止

# 5. 統合確認
python3 scripts/testing/dev_check.py check --level full
```

## 📋 実行方式比較

| 実行方法 | プロセス管理 | プロセスグループ | 強制停止 | Discord問題対応 | 推奨度 |
|---------|-------------|----------------|---------|----------------|--------|
| **従来**: `python main.py` | ❌ なし | ❌ なし | ❌ 不完全 | ❌ 対応不可 | 🚫 **非推奨** |
| **run_safe.sh** | ✅ 自動 | ✅ 対応 | ✅ 基本対応 | ⚠️ 基本対応 | ✅ **推奨** |
| **bot_manager.sh stop** | ✅ 完全 | ✅ 完全対応 | ✅ 完全対応 | ✅ **完全解決** | ✅ **緊急時必須** |

---

**🎉 Discord通知停止問題完全解決**: bot_manager.sh統合・run_safe.sh改修により、Discord通知無限ループ問題を100%解決。2段階停止システム（通常停止→強制停止）で確実な運用を実現。

**🚀 Phase 34デプロイ前準備体制確立**: ML予測統合により真のハイブリッドMLbotを実現。統一設定管理体系により、設定変更が1箇所修正で完結。**ML学習→品質チェック→ペーパーテスト→バックテスト→コミット・プッシュ・デプロイ**の完全なフローを確立。15特徴量統合・5戦略統合・**ML予測統合（戦略70% + ML30%）**・**15分足データ収集（80倍改善）**・**バックテストシステム完成**・ProductionEnsemble・Cloud Run 24時間稼働・Discord 3階層監視・**656テスト100%品質保証・59.88%カバレッジ**を実現した企業級品質保証システム。ハードコード完全排除・設定不整合完全解消・ML統合実装・バックテスト検証対応により、**デプロイ成功率100%・品質保証体系確立**を達成。

**最終更新**: 2025年10月5日 - **Phase 34完了・バックテストシステム完成**・15分足データ収集80倍改善（216→17,271件）・Bitbank Public API直接使用・日別イテレーション実装・バックテスト実行スクリプト完備・ML学習/品質チェック/ペーパーテスト/バックテスト/デプロイ統合フロー完備・656テスト品質保証・59.88%カバレッジ達成 🚀