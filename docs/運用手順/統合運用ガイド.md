# 統合運用ガイド - crypto-botシステム完全版

**最終更新**: 2025年9月16日
**対象者**: 開発者・DevOpsエンジニア・システム管理者・運用担当者
**目的**: AI自動取引システムの環境構築・開発・デプロイ・運用・監視の完全ガイド（安全実行スクリプト対応）

## 📋 概要

AI自動取引システム（crypto-bot）の包括的な運用ガイドです。Phase22完成版として、15特徴量統合・5戦略統合・ProductionEnsemble・Cloud Run 24時間稼働・Discord 3階層監視に対応した企業級品質システムの全運用手順を統合管理します。

**🆕 プロセス管理強化（2025年9月16日）**: 重複起動防止・環境自動判定・安全実行制御により、無限通知問題を根本的に解決。`scripts/management/run_safe.sh` による統一実行を強く推奨。

**システム状態**: 完全稼働中・Cloud Run 24時間運用・bitbank信用取引対応・625テスト100%・64.74%カバレッジ・プロセス管理最適化完了

---

# 第1部: 環境構築・初期セットアップ

## 🛠️ 前提条件・要件

### **システム要件**
- **Python**: 3.12（MLライブラリ互換性最適化）
- **Node.js**: 18+ （GitHub CLI用）
- **Docker**: 20.10+ （コンテナ化デプロイ用）
- **Git**: 2.30+ （バージョン管理）

### **権限・アカウント要件**
- **GCP Project**: Editor またはOwner権限
- **GitHub Repository**: Admin権限
- **Bitbank API**: 信用取引対応APIキー
- **Discord**: Webhook URL設定権限

### **初回セットアップ**
```bash
# プロジェクトクローン
git clone <repository-url>
cd crypto-bot

# Python依存関係インストール
pip install -r requirements.txt

# 環境確認
python3 --version  # 3.12.x確認
gcloud --version    # gcloud CLI確認
docker --version    # Docker確認
gh --version        # GitHub CLI確認
```

## 🔧 GCP環境構築

### **自動環境構築（推奨）**
```bash
# 統合GCP環境構築スクリプト実行
bash scripts/deployment/setup_gcp_environment.sh --full

# 対話式セットアップで以下を設定:
# - GCP Project ID設定
# - 必要なAPI有効化（Cloud Run・Artifact Registry・Secret Manager等）
# - Artifact Registryリポジトリ作成
# - サービスアカウント作成・権限付与
# - Workload Identity設定（GitHub Actions用）
# - Secret Manager設定（Bitbank API・Discord Webhook）
```

### **段階的セットアップ**
```bash
# APIs有効化のみ
bash scripts/deployment/setup_gcp_environment.sh --apis-only

# 認証情報設定のみ
bash scripts/deployment/setup_gcp_environment.sh --secrets-only

# 設定検証のみ
bash scripts/deployment/setup_gcp_environment.sh --verify
```

### **環境検証・設定確認**
```bash
# 包括的環境検証
bash scripts/deployment/verify_gcp_setup.sh --full

# Cloud Run専用確認
bash scripts/deployment/verify_gcp_setup.sh --cloud-run-check

# GitHub Actions連携確認
bash scripts/deployment/verify_gcp_setup.sh --github-check
```

## 🔐 GitHub設定

### **Repository Secrets設定**
GitHubリポジトリの `Settings > Secrets and variables > Actions`:

| Name | Value | 説明 |
|------|-------|------|
| `GCP_PROJECT_ID` | `my-crypto-bot-project` | GCPプロジェクトID |
| `GCP_WIF_PROVIDER` | `projects/{PROJECT_NUMBER}/locations/global/workloadIdentityPools/github-pool/providers/github-provider` | Workload Identity Provider |
| `GCP_SERVICE_ACCOUNT` | `github-actions-sa@my-crypto-bot-project.iam.gserviceaccount.com` | サービスアカウント |
| `DEPLOY_MODE` | `paper` | デプロイモード（paper/live制御） |

### **Repository Variables設定**
| Name | Value | 説明 |
|------|-------|------|
| `GCP_REGION` | `asia-northeast1` | デプロイリージョン |
| `ARTIFACT_REPOSITORY` | `crypto-bot-repo` | Artifact Repository名 |
| `CLOUD_RUN_SERVICE` | `crypto-bot-service` | Cloud Runサービス名 |

### **GitHub CLI設定**
```bash
# GitHub CLI認証
gh auth login

# Secret設定例
gh secret set DEPLOY_MODE --body "paper"
gh secret set GCP_PROJECT_ID --body "my-crypto-bot-project"
```

---

# 第2部: 開発・品質管理

## 🧪 品質チェックシステム

### **メイン品質チェック（必須）**
```bash
# 開発前後に必ず実行 - 約30秒で完了
bash scripts/testing/checks.sh

# 期待結果（Phase 22標準）:
# ✅ 620テスト100%成功
# ✅ 64.79%カバレッジ達成（目標55%クリア）
# ✅ コードスタイル準拠（flake8・black・isort）
# ✅ 15特徴量統合システム正常動作
# ✅ MLモデル整合性確認
```

### **統合開発管理CLI**
```bash
# Phase 22統合品質チェック（推奨）
python3 scripts/testing/dev_check.py full-check

# 個別機能チェック
python3 scripts/testing/dev_check.py validate       # 基本品質チェック
python3 scripts/testing/dev_check.py ml-models      # MLモデル作成・検証
python3 scripts/testing/dev_check.py data-check     # データ取得・15特徴量確認
python3 scripts/testing/dev_check.py status         # システム状態確認

# 本番環境監視
python3 scripts/testing/dev_check.py health-check   # Cloud Run・GCP確認
```

### **カバレッジレポート確認**
```bash
# カバレッジレポートHTML表示
open coverage-reports/htmlcov/index.html

# コマンドライン詳細表示
python3 -m coverage report --show-missing
```

## 🤖 機械学習システム

### **MLモデル学習・管理**
```bash
# Phase22対応・15特徴量統合MLモデル学習
python3 scripts/ml/create_ml_models.py --verbose

# 学習成果確認:
# - 15特徴量: 完全生成・統一管理対応
# - 3モデル: LightGBM・XGBoost・RandomForest アンサンブル
# - 本番モデル: ProductionEnsemble保存（models/production/）
# - 性能評価: F1スコア・精度・再現率・クロスバリデーション
```

### **統合管理CLI経由実行（推奨）**
```bash
# MLOps統合実行
python3 scripts/testing/dev_check.py ml-models --verbose

# ドライラン（実行前確認）
python3 scripts/testing/dev_check.py ml-models --dry-run

# 週次自動学習システム確認
gh run list --workflow=model-training.yml --limit 5
```

### **学習結果確認**
```bash
# メタデータ確認
cat models/production/production_model_metadata.json | jq '.performance_metrics'

# モデルファイル確認
ls -la models/production/
ls -la models/training/
```

## 🔍 バックテスト・ペーパートレード

### 🚨 **重要な実行方式変更（2025年9月16日）**

**推奨**: `bash scripts/management/run_safe.sh` 経由実行（プロセス管理・重複防止）
**非推奨**: `python3 main.py` 直接実行（無限通知・プロセス重複リスク）

### **🆕 バックテスト実行（安全実行スクリプト推奨）**
```bash
# 推奨: 安全実行スクリプト使用
bash scripts/management/run_safe.sh local backtest

# プロセス状況確認
bash scripts/management/run_safe.sh status

# 安全停止
bash scripts/management/run_safe.sh stop

# カスタム期間データ準備
python3 scripts/backtest/collect_historical_csv.py --days 180
bash scripts/management/run_safe.sh local backtest

# 結果確認
ls -t src/backtest/logs/backtest_*.json | head -1 | xargs cat | jq '.performance_stats'
```

### **🆕 ペーパートレード実行（安全実行スクリプト推奨）**
```bash
# 推奨: 安全実行スクリプト使用（重複防止・環境自動判定）
bash scripts/management/run_safe.sh local paper

# リアルタイム動作確認
tail -f logs/crypto_bot_*.log | grep "取引判定"

# 安全停止
bash scripts/management/run_safe.sh stop

# ロックファイルクリーンアップ（異常終了時）
bash scripts/management/run_safe.sh cleanup
```

### **⚠️ 従来実行方法（非推奨・プロセス重複リスク）**
```bash
# 非推奨: 直接実行（プロセス重複・無限通知リスク）
# python3 main.py --mode backtest  # ← 今後非推奨
# python3 main.py --mode paper     # ← 今後非推奨

# 統合システム動作確認（非推奨）
# python3 main.py --config config/core/unified.yaml --mode paper  # ← 今後非推奨
```

### **期待動作フロー**
```
安全実行スクリプト → プロセスロック取得 → 環境設定 →
データ取得 → 15特徴量生成 → 5戦略実行 → ML予測 → リスク評価 → BUY/SELL判定 →
プロセスロック解除 → 実行完了
```

---

# 第3部: デプロイメント

## 🚀 CI/CDパイプライン

### **自動CI/CDフロー（推奨）**
```bash
# 1. ローカル品質チェック
bash scripts/testing/checks.sh

# 2. コード変更をプッシュしてCI/CD実行
git add -A
git commit -m "feat: 新機能追加"
git push origin main

# 3. デプロイ状況確認
gh run list --limit 5
gh run view --log
```

### **GitHub Actions ワークフロー**
```yaml
# .github/workflows/ci.yml での自動実行:
# 1. 品質チェック（tests・coverage・linting）
# 2. MLモデル整合性確認
# 3. Docker Build & Push to Artifact Registry
# 4. Cloud Run段階的デプロイ（paper → stage → live）
# 5. ヘルスチェック・動作確認
# 6. Discord通知
```

### **デプロイモード制御**
```bash
# ペーパートレードモード（安全・推奨）
gh secret set DEPLOY_MODE --body "paper"

# 本番取引モード
gh secret set DEPLOY_MODE --body "live"
```

## 📦 Docker・手動デプロイ

### **手動デプロイ（緊急時）**
```bash
# 事前品質確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# 手動デプロイ実行
bash scripts/deployment/deploy_production.sh --manual

# 確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1
```

### **段階的デプロイ**
```bash
# ペーパートレード環境
bash scripts/deployment/deploy_production.sh --stage paper

# ステージング環境（10%トラフィック）
bash scripts/deployment/deploy_production.sh --stage stage-10

# ステージング環境（50%トラフィック）  
bash scripts/deployment/deploy_production.sh --stage stage-50

# 本番環境（100%トラフィック）
bash scripts/deployment/deploy_production.sh --stage live
```

### **Docker開発環境**
```bash
# ローカルDocker実行
docker build -t crypto-bot .
docker run -e MODE=paper crypto-bot

# デバッグ実行
docker run -it --entrypoint /bin/bash crypto-bot
```

---

# 第4部: 日常運用・監視

## 📊 24時間監視体制

### **システム状態確認（毎日推奨）**
```bash
# 統一品質チェック（30秒で完了）
bash scripts/testing/checks.sh

# システム総合診断
python3 scripts/testing/dev_check.py check --level standard

# 🆕 プロセス管理状況確認
bash scripts/management/run_safe.sh status

# 本番環境稼働確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1

# 最新ログ確認
gcloud logging read "resource.type=cloud_run_revision" --limit=10

# 🆕 ローカル動作確認（短時間テスト）
bash scripts/management/run_safe.sh local paper  # 2-3分実行後停止
```

### **MLOpsシステム管理（週1回）**
```bash
# MLモデル状態確認
python3 scripts/testing/dev_check.py ml-models --dry-run

# 週次自動再学習状況確認
gh run list --workflow=model-training.yml --limit 5

# モデル性能検証
python3 -c "
from src.ml.ensemble import ProductionEnsemble
model = ProductionEnsemble()
print(f'✅ MLモデル正常: {model.is_fitted}')
"
```

### **Discord監視・アラート確認**
```bash
# Discord通知履歴確認（システム分析）
python3 scripts/analytics/base_analyzer.py --discord-check

# エラーログ確認（過去24時間）
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=10

# システムパフォーマンス確認
python3 scripts/analytics/base_analyzer.py --performance-check
```

## 📈 パフォーマンス監視

### **監視指標・目標値**
- **稼働率**: 99.5%以上
- **レスポンス時間**: 平均3秒以下
- **エラー率**: 5件/時間以下
- **取引勝率**: 55%以上
- **ML信頼度**: 0.35以上維持

### **Discord通知レベル**
- **Critical** (即座対応): システム完全停止・取引機能障害
- **Warning** (30分以内): パフォーマンス劣化・API接続問題  
- **Info** (監視継続): 日次レポート・システム正常稼働

### **定期メンテナンス**
```bash
# 日次
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# 週次
gh run list --workflow=model-training.yml --limit 5
python3 scripts/analytics/base_analyzer.py --weekly-report

# 月次
gcloud run revisions list --service=crypto-bot-service-prod
# 古いリビジョン削除（手動確認後）
```

---

# 第5部: 緊急時対応

## 🚨 緊急度別対応時間

### **Critical レベル（5分以内）**
**症状**: システム完全停止・データ損失・取引機能完全停止

```bash
# 即座ロールバック
gh workflow run ci.yml --ref <安定版コミット>
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100 \
  --region=asia-northeast1

# 緊急停止（最終手段）
gcloud run services update crypto-bot-service-prod \
  --min-instances=0 \
  --region=asia-northeast1

# データ損失対応
python3 scripts/ml/create_ml_models.py  # MLモデル再作成
python3 scripts/testing/dev_check.py full-check  # 整合性確認
```

### **High レベル（30分以内）**
**症状**: ML障害・API接続不可・パフォーマンス大幅劣化

```bash
# ML予測システム障害対応
python3 scripts/testing/dev_check.py ml-models --dry-run
python3 scripts/testing/dev_check.py validate

# API接続問題対応  
bash scripts/deployment/verify_gcp_setup.sh --api-check
python3 scripts/testing/dev_check.py data-check
```

### **Medium レベル（2時間以内）**
**症状**: 一部機能障害・警告レベルエラー

```bash
# 段階的診断・修正
python3 scripts/testing/dev_check.py status
bash scripts/testing/checks.sh
```

## 🔄 ロールバック戦略

### **GitHub Actions経由ロールバック（推奨）**
```bash
# 安定版特定
git log --oneline -10

# 安定版へロールバック
gh workflow run ci.yml --ref <安定版コミット>

# ロールバック確認
gh run list --limit 3
bash scripts/testing/checks.sh
```

### **Cloud Run直接ロールバック（緊急時）**
```bash
# 利用可能リビジョン確認
gcloud run revisions list --service=crypto-bot-service-prod --region=asia-northeast1

# 安定リビジョンへ切り替え
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100 \
  --region=asia-northeast1

# 動作確認
bash scripts/deployment/verify_gcp_setup.sh --cloud-run-check
```

## 🔍 トラブルシューティング

### **🆕 プロセス管理関連の問題と対処法**

#### **「既にプロセスが実行中です」エラー**
```bash
# 症状: [ERROR] 既にプロセスが実行中です
# 原因: 前回の実行が正常終了していない

# 解決手順:
bash scripts/management/run_safe.sh status    # 状況確認
bash scripts/management/run_safe.sh stop     # 安全停止
bash scripts/management/run_safe.sh cleanup  # ロックファイル削除
bash scripts/management/run_safe.sh local paper  # 再実行
```

#### **無限Discord通知問題**
```bash
# 症状: Discord通知が1分間隔で止まらない
# 原因: 直接実行による重複プロセス

# 解決手順:
ps aux | grep main.py | grep -v grep  # プロセス確認
kill [PID番号]                       # 重複プロセス終了
bash scripts/management/run_safe.sh cleanup  # クリーンアップ
bash scripts/management/run_safe.sh local paper  # 安全実行
```

#### **ロックファイル残存問題**
```bash
# 症状: ロックファイルが存在しますが、プロセスは実行されていません
# 原因: 異常終了でロックファイルが残存

# 解決手順:
bash scripts/management/run_safe.sh cleanup  # 強制クリーンアップ
bash scripts/management/run_safe.sh local paper  # 再実行
```

### **従来の問題と対処法**

#### **GitHub Actions失敗**
```bash
# 失敗詳細確認
gh run view <run-id> --log-failed

# 手動修復
bash scripts/deployment/setup_gcp_environment.sh --repair
bash scripts/deployment/verify_gcp_setup.sh --full
```

#### **権限エラー**
```bash
# サービスアカウント権限確認
gcloud projects get-iam-policy my-crypto-bot-project \
  --flatten="bindings[].members" \
  --filter="bindings.members:*github-actions-sa*"

# Workload Identity設定確認
gcloud iam workload-identity-pools list --location=global
```

#### **Secret Manager接続エラー**
```bash
# シークレット存在確認
gcloud secrets list

# アクセス権限確認
gcloud secrets get-iam-policy bitbank-api-key
```

#### **MLOpsシステム問題**
```bash
# モデル整合性確認
python3 scripts/testing/dev_check.py ml-models
python3 scripts/testing/dev_check.py validate

# 強制再学習
python3 scripts/ml/create_ml_models.py --verbose
```

### **診断コマンド集**
```bash
# システム全体診断
python3 scripts/testing/dev_check.py full-check

# 環境診断
bash scripts/deployment/verify_gcp_setup.sh --full

# 品質診断
bash scripts/testing/checks.sh

# 本番環境診断
python3 scripts/testing/dev_check.py health-check
```

## 📝 運用ログ記録

### **日次チェックリスト**
```
日付: YYYY-MM-DD
□ システム品質チェック（620テスト・64.79%カバレッジ）
□ MLOps基盤確認（15特徴量・ProductionEnsemble）
□ 24時間監視・Discord通知確認
□ 本番稼働・取引パフォーマンス確認
□ エラーログ・異常なし確認
```

### **緊急時対応記録**
```
発生日時: YYYY-MM-DD HH:MM:SS
緊急度: Critical/High/Medium/Low
症状: [詳細症状・エラーメッセージ]
対応: [実施した対応内容・コマンド]
復旧時間: __分
根本原因: [判明した原因]
再発防止策: [実施した改善策]
```

---

# 付録: スクリプトリファレンス

## 📂 scriptsディレクトリ構成

```
scripts/
├── analytics/          # システム分析基盤
│   ├── base_analyzer.py    # Cloud Runログ取得・システム監視・分析機能
│   └── README.md
├── deployment/         # デプロイメント・インフラ管理
│   ├── deploy_production.sh        # 本番環境デプロイ・段階的リリース
│   ├── docker-entrypoint.sh        # Dockerコンテナエントリポイント
│   ├── setup_gcp_environment.sh    # 統合GCP環境構築・認証管理
│   ├── verify_gcp_setup.sh         # GCP環境検証・設定確認
│   └── README.md
├── 🆕 management/        # プロセス管理・安全実行システム（2025年9月16日追加）
│   ├── run_safe.sh              # 安全実行スクリプト（プロセス重複防止・環境判定）
│   └── README.md                # 管理スクリプト詳細説明
├── ml/                 # 機械学習モデル学習・管理
│   ├── create_ml_models.py          # Phase22対応・15特徴量MLモデル学習
│   └── README.md
└── testing/            # 品質保証・テストシステム
    ├── checks.sh                    # 品質チェック・テスト実行（30秒完了）
    ├── dev_check.py                 # 統合開発管理CLI・システム診断
    └── README.md
```

## 🔧 主要スクリプト詳細

### **🆕 プロセス管理・安全実行システム（2025年9月16日追加）**

#### `scripts/management/run_safe.sh`
安全実行スクリプト・プロセス重複防止・環境自動判定システム（18.5KB実装）
```bash
# 使用例
bash scripts/management/run_safe.sh local paper     # ペーパートレード安全実行
bash scripts/management/run_safe.sh local backtest  # バックテスト安全実行
bash scripts/management/run_safe.sh gcp live        # GCP環境ライブトレード
bash scripts/management/run_safe.sh status          # プロセス状況確認
bash scripts/management/run_safe.sh stop            # 安全停止
bash scripts/management/run_safe.sh cleanup         # ロックファイルクリーンアップ

# 機能:
# - PIDベースプロセス重複防止（fcntlロックファイル制御）
# - 環境自動判定（ローカル/GCP切り替え・環境変数自動設定）
# - タイムアウト管理（GCP環境15分自動終了・コスト制御）
# - シグナル制御（SIGTERM/SIGINT適切処理・グレースフルシャットダウン）
# - プロセス監視（実行状況可視化・経過時間表示）
# - エラーハンドリング（自動クリーンアップ・復旧提案）
# - 今回の無限通知問題を根本的に解決
```

### **品質保証システム**

#### `scripts/testing/checks.sh`
システム全体の品質チェックとテスト実行を管理するメインスクリプト
```bash
# 基本実行（開発時必須）
bash scripts/testing/checks.sh

# 機能:
# - 620テスト実行・100%成功確認
# - 64.79%カバレッジ測定・HTML/JSON/Term出力
# - flake8・black・isort によるコードスタイルチェック
# - プロジェクト構造・MLモデル存在確認
# - レポート生成（coverage-reports/）
```

#### `scripts/testing/dev_check.py`
統合開発管理・システム診断CLI（62.3KB大規模実装）
```bash
# 主要コマンド
python3 scripts/testing/dev_check.py full-check     # 統合品質チェック
python3 scripts/testing/dev_check.py validate       # 基本品質チェック
python3 scripts/testing/dev_check.py ml-models      # MLモデル作成・検証
python3 scripts/testing/dev_check.py data-check     # 15特徴量データ確認
python3 scripts/testing/dev_check.py health-check   # Cloud Run・GCP確認
python3 scripts/testing/dev_check.py status         # システム状態確認

# 機能:
# - Phase22統合品質管理（620テスト・64.79%カバレッジ）
# - MLOps基盤管理（15特徴量・ProductionEnsemble）
# - 本番環境監視（Cloud Run・Discord通知）
# - 自動レポート生成（Markdown形式）
```

### **デプロイメントシステム**

#### `scripts/deployment/setup_gcp_environment.sh`
統合GCP環境構築スクリプト（25KB大規模実装）
```bash
# 使用例
bash scripts/deployment/setup_gcp_environment.sh --full         # 完全構築
bash scripts/deployment/setup_gcp_environment.sh --apis-only    # API有効化のみ
bash scripts/deployment/setup_gcp_environment.sh --secrets-only # 認証情報のみ
bash scripts/deployment/setup_gcp_environment.sh --verify       # 検証のみ

# 機能:
# - Cloud Run・Artifact Registry・Secret Manager統合設定
# - GitHub Actions OIDC・Workload Identity構築
# - Bitbank API・Discord Webhook認証情報管理
# - 対話式設定・自動検証・レポート生成
```

#### `scripts/deployment/deploy_production.sh`
本番環境デプロイメント・段階的リリース管理（20KB実装）
```bash
# 使用例
bash scripts/deployment/deploy_production.sh --staged      # 段階的デプロイ
bash scripts/deployment/deploy_production.sh --manual      # 手動デプロイ
bash scripts/deployment/deploy_production.sh --stage paper # ペーパートレード

# 機能:
# - paper→stage-10→stage-50→live 段階的リリース
# - Docker統合・Artifact Registry管理
# - 品質ゲート・ヘルスチェック・ロールバック機能
# - Discord通知・成功/失敗レポート
```

#### `scripts/deployment/verify_gcp_setup.sh`
GCP環境検証・診断スクリプト（27KB実装）
```bash
# 使用例
bash scripts/deployment/verify_gcp_setup.sh --full              # 包括的検証
bash scripts/deployment/verify_gcp_setup.sh --cloud-run-check   # Cloud Run専用
bash scripts/deployment/verify_gcp_setup.sh --github-check      # GitHub Actions確認

# 機能:
# - GCPサービス・権限・接続状況全体確認
# - Cloud Run・Secret Manager・GitHub Actions検証
# - 問題診断・修復提案・詳細レポート生成
```

#### `scripts/deployment/docker-entrypoint.sh`
Dockerコンテナ起動制御・プロセス管理（8.7KB実装）
```bash
# 内部使用（Dockerfileから自動実行）
# 機能:
# - デュアルプロセス（ヘルスチェック + 取引システム）
# - /health エンドポイント・Cloud Run監視連携
# - プロセス監視・異常終了検知・自動復旧
# - Cloud Run最適化・メモリ効率・起動時間短縮
```

### **機械学習システム**

#### `scripts/ml/create_ml_models.py`
Phase22対応・15特徴量MLモデル学習システム（25.7KB実装）
```bash
# 使用例
python3 scripts/ml/create_ml_models.py --verbose    # 詳細ログ学習
python3 scripts/ml/create_ml_models.py --days 180   # 180日データ学習
python3 scripts/ml/create_ml_models.py --dry-run    # 実行前確認

# 機能:
# - LightGBM・XGBoost・RandomForest 3モデル学習
# - ProductionEnsemble構築・重み付け投票
# - feature_manager連携・15特徴量生成
# - ハイパーパラメータ最適化・TimeSeriesSplit
# - バージョン管理・自動アーカイブ・CI/CD統合
```

### **システム分析基盤**

#### `scripts/analytics/base_analyzer.py`
Cloud Runログ取得・システム監視・分析機能
```bash
# dev_check.pyから利用される基盤コンポーネント
# 機能:
# - Cloud Runログ取得・エラーログ専用取得
# - サービスヘルス確認・ログ解析
# - シグナル頻度分析・CSV/JSON保存
# - gcloudコマンド実行共通ラッパー
```

## 💡 コマンド例集

### **日常開発ワークフロー**
```bash
# 1. 開発前品質確認
bash scripts/testing/checks.sh

# 2. 機能開発・テスト追加
# ...コード修正...

# 3. 開発後品質確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py check --level standard

# 🆕 4. 安全実行による動作確認（短時間テスト）
bash scripts/management/run_safe.sh local paper  # 2-3分実行後停止

# 5. MLモデル更新（必要時）
python3 scripts/ml/create_ml_models.py --verbose

# 6. 統合確認
python3 scripts/testing/dev_check.py check --level full
```

### **緊急時対応ワークフロー**
```bash
# 1. 即座診断
python3 scripts/testing/dev_check.py status
python3 scripts/testing/dev_check.py health-check

# 2. 詳細診断
bash scripts/deployment/verify_gcp_setup.sh --full
bash scripts/testing/checks.sh

# 3. 復旧対応
# Critical: ロールバック実行
# High: 個別コンポーネント修復
# Medium: 段階的修正
```

### **定期メンテナンスワークフロー**
```bash
# 日次（5分）
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py status

# 週次（10分）  
python3 scripts/testing/dev_check.py full-check
gh run list --workflow=model-training.yml --limit 5

# 月次（30分）
bash scripts/deployment/verify_gcp_setup.sh --full
python3 scripts/analytics/base_analyzer.py --monthly-report
```

## 📋 設定ファイル一覧

### **主要設定ファイル**
- `config/core/unified.yaml`: 統一設定ファイル（全環境対応）
- `config/core/thresholds.yaml`: 動的閾値管理
- `config/core/feature_order.json`: 15特徴量順序管理
- `.github/workflows/ci.yml`: CI/CDワークフロー
- `Dockerfile`: コンテナ設定
- `pyproject.toml`: Python・pytest・coverage設定

### **環境変数**
- `MODE`: 実行モード（paper/live/backtest）
- `EXCHANGE`: 取引所（bitbank）
- `GCP_PROJECT_ID`: GCPプロジェクトID
- `DISCORD_WEBHOOK_URL`: Discord通知URL

---

**🎯 統合運用体制**: Phase22完成により、15特徴量統合・5戦略統合・ProductionEnsemble・Cloud Run 24時間稼働・Discord 3階層監視・625テスト100%品質保証・64.74%カバレッジを実現した企業級運用システム

**🆕 プロセス管理強化完了**: 安全実行スクリプト（`scripts/management/run_safe.sh`）により、重複起動防止・環境自動判定・無限通知問題根本的解決を実現

**最終更新**: 2025年9月16日 - プロセス管理・Discord通知最適化・統合運用ガイド強化完成