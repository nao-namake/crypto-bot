# 運用マニュアル - crypto-bot 新システム（**CI/CD統合簡素化完了版**・統一品質ゲート）

## 📋 概要

**作成日**: 2025年9月1日（最終更新）  
**対象システム**: crypto-bot 新システム（CI/CD統合簡素化完了・checks.sh統一品質ゲート・Local=CI環境統一）  
**運用環境**: GCP Cloud Run + CI/CD簡素化稼働・654テスト100%・59.24%カバレッジ・24時間監視・統一品質保証  
**対象者**: システム運用者・開発者・緊急時対応担当者

このマニュアルは、**CI/CD統合簡素化完了システム**でのchecks.sh統一品質ゲート・Local=CI環境統一・70%削減効率化・企業級品質保証と個人開発効率性両立での日常運用・緊急時対応・ロールバック手順を包括的に定義します。

---

## 🎯 システム構成概要（Phase 13）

### **新システムアーキテクチャ**
```
Phase 13完了システム構成:
├── src/core/         # 基盤システム（設定・ログ・例外）
├── src/data/         # データ層（Bitbank API・パイプライン・キャッシュ）
├── src/features/     # 特徴量エンジニアリング（12個厳選）
├── src/strategies/   # 取引戦略（4戦略統合）
├── src/ml/           # 機械学習層（ProductionEnsemble・sklearn警告解消完了）
├── src/trading/      # 取引実行層
└── src/monitoring/   # 監視層

config構造最適化（Phase 13完了）:
├── .github/workflows/        # CI/CD・24時間監視
├── scripts/analytics/        # 統合分析基盤（dashboard・data_collection・ab_testing統合）
│   └── base_analyzer.py       # 共通基盤クラス（重複コード500行削除）
├── scripts/management/       # 統合管理ツール（dev_check.py・ops_monitor.py）
├── scripts/testing/          # 統合テスト（quality→testing統合）
├── scripts/ml/              # 機械学習・モデル作成
└── scripts/deployment/       # デプロイ・インフラ
```

### **CI/CD統合簡素化完了改善点**
- ✅ **CI/CD 70%削減**: 675→200行・checks.sh統一品質ゲート・複雑性排除
- ✅ **統一環境実現**: Local=CI環境・開発体験統一・品質保証一元化
- ✅ **654テスト100%**: 品質保証強化・59.24%カバレッジ達成・完全成功
- ✅ **pathlib修正**: CI安定稼働・Python 3.11.13対応・テスト環境統一
- ✅ **保守性大幅向上**: 単一スクリプト管理・運用効率化・開発者体験改善
- ✅ **企業級品質保証**: 個人開発効率性両立・最適化システム確立

---

## 🔧 日常運用手順

### **1. 運用開始前チェック（推奨頻度：毎日）**

```bash
# 1-1. プロジェクトディレクトリへ移動
cd /path/to/crypto-bot

# 1-2. 統一品質チェック（CI環境同一・推奨）
bash scripts/testing/checks.sh

# 1-3. 統合管理チェック（補完）
python scripts/management/dev_check.py full-check

# 1-4. CI/CD・監視状況確認
gh run list --limit 5  # GitHub Actions簡素化状況
```

**期待結果**:
- ✅ CI/CD統合簡素化完了（checks.sh統一品質ゲート・70%削減効率化）
- ✅ 654テスト100%成功（59.24%カバレッジ・品質保証完成）
- ✅ Local=CI環境統一確認（統一品質ゲート通過）
- ✅ GitHub Actions CI/CD簡素化稼働・監視ワークフロー正常

### **2. 統合分析基盤（Phase 13スクリプト統合対応・推奨頻度：毎日）**

```bash
# 2-1. 実データ収集（base_analyzer.py基盤使用）
python scripts/analytics/data_collector.py --hours 24

# 2-2. A/Bテスト実行（統合システム）
# A/Bテストは ModelManager.run_ab_test() で実行（スクリプト統合後は統一インターフェース）

# 2-3. ダッシュボード生成（統合管理）
python scripts/analytics/dashboard.py --discord
```

**期待結果（Phase 13統合分析基盤）**:
- ✅ 取引データCSV・JSON出力・統計分析完了（base_analyzer.py基盤活用）
- ✅ A/Bテスト結果・統計的有意性判定（統一インターフェース）
- ✅ HTMLダッシュボード・可視化レポート生成（統合管理）

### **3. MLモデル管理（推奨頻度：週1回）**

```bash
# 3-1. MLモデル検証（ドライラン）
python scripts/management/dev_check.py ml-models --dry-run

# 3-2. MLモデル実際作成（必要時）
python scripts/management/dev_check.py ml-models

# 3-3. モデル性能確認
python scripts/ml/create_ml_models.py --validate-only
```

**期待結果**:
- ✅ ProductionEnsemble作成成功
- ✅ 3モデル統合（LightGBM 0.4 + XGBoost 0.4 + RandomForest 0.2）
- ✅ 12特徴量最適化システム動作

### **4. パフォーマンス分析（推奨頻度：週1回）**

```bash
# 4-1. 24時間パフォーマンス分析
python scripts/analytics/performance_analyzer.py --period 24h --format markdown

# 4-2. 週次総合分析
python scripts/analytics/performance_analyzer.py --period 7d --format json

# 4-3. システムヘルス分析
gcloud run services describe crypto-bot-service --region=asia-northeast1
```

**期待結果**:
- ✅ システムヘルス・エラー分析・取引パフォーマンス分析
- ✅ 総合スコア70点以上・改善推奨事項生成
- ✅ レガシー知見統合・包括的レポート

---

## 🚀 CI/CD・デプロイメント手順（Phase 13スクリプト統合対応）

### **1. GitHub Actions CI/CD（自動実行）**

```bash
# 1-1. ローカル品質チェック（CI環境同一）
bash scripts/testing/checks.sh

# 1-2. コード更新・自動CI/CD実行（CI/CD統合簡素化対応）
git add -A
git commit -m "feat: CI/CD統合簡素化 - checks.sh統一品質ゲート・統一環境"
git push origin main  # 自動CI/CDトリガー

# 1-3. ワークフロー確認
gh run list --limit 5
gh run view --log

# 1-4. デプロイ状況確認
gcloud run services list --region=asia-northeast1
```

**段階的デプロイ制御**:
- GitHub Secrets `DEPLOY_MODE` で制御
- `paper` → `stage-10` → `stage-50` → `live`
- 24時間監視・ヘルスチェック・品質ゲート統合

### **2. 手動デプロイ（緊急時）**

```bash
# 2-1. 事前確認（統一品質ゲート）
bash scripts/testing/checks.sh
python scripts/management/dev_check.py full-check

# 2-2. Docker Build & Push
docker build -t crypto-bot-production .
docker tag crypto-bot-production asia-northeast1-docker.pkg.dev/my-crypto-bot-project/crypto-bot-repo/crypto-bot:latest
docker push asia-northeast1-docker.pkg.dev/my-crypto-bot-project/crypto-bot-repo/crypto-bot:latest

# 2-3. Cloud Run デプロイ（Phase 13スクリプト統合対応設定）
gcloud run deploy crypto-bot-service \
    --image=asia-northeast1-docker.pkg.dev/my-crypto-bot-project/crypto-bot-repo/crypto-bot:latest \
    --region=asia-northeast1 \
    --platform=managed \
    --memory=1Gi \
    --cpu=1 \
    --max-instances=2 \
    --min-instances=1 \
    --allow-unauthenticated \
    --set-env-vars="MODE=live,EXCHANGE=bitbank,LOG_LEVEL=INFO" \
    --set-secrets="BITBANK_API_KEY=bitbank-api-key:latest,BITBANK_API_SECRET=bitbank-api-secret:latest"
```

### **3. デプロイ後確認**

```bash
# 3-1. サービス状態確認
gcloud run services describe crypto-bot-service --region=asia-northeast1

# 3-2. ヘルスチェック
curl https://SERVICE_URL/health

# 3-3. 24時間監視開始確認
gh workflow list  # monitoring.yml稼働確認
```

---

## 📊 監視・メトリクス（Phase 13スクリプト統合対応）

### **1. 24時間自動監視**

**監視体制**:
- **頻度**: 15分間隔（GitHub Actions）
- **対象**: システムヘルス・エラー分析・取引活動・パフォーマンス
- **アラート**: Critical・Warning・OK自動判定

**監視項目**:
```yaml
システムヘルス:
  - Cloud Runサービス状態
  - API応答時間（目標: < 3秒）
  - エラー率（目標: < 5/時間）

取引パフォーマンス:
  - シグナル生成頻度
  - 注文成功率（目標: > 95%）
  - 取引実行レイテンシ

システム指標:
  - リソース使用率
  - メモリ・CPU効率
  - ログ品質
```

### **2. パフォーマンス目標**

**システム要件**:
- **稼働率**: 99.5%以上
- **レスポンス時間**: 平均3秒以下
- **エラー率**: 5件/時間以下
- **監視精度**: 90%以上

**取引性能目標**:
- **月間収益**: コスト回収（2,000円以上）
- **勝率**: 55%以上
- **最大ドローダウン**: 20%以内
- **シャープレシオ**: 1.0以上

**運用コスト目標**:
- **月間運用費**: 2,000円以内（目標達成）
- **CPU**: 1CPU統一（個人開発最適化）
- **メモリ**: 1Gi効率化
- **MIN_INSTANCES**: 1（安定性重視・SIGTERM回避）

---

## 🚨 緊急時対応手順

### **緊急度分類・対応時間**

| レベル | 状況 | 対応時間 | 例 |
|--------|------|----------|-----|
| **Critical** | システム完全停止・データ損失リスク | 即座（5分以内） | アプリケーション起動不可・取引停止 |
| **High** | 機能重大障害・パフォーマンス重大劣化 | 30分以内 | ML予測失敗・API接続不可 |
| **Medium** | 一部機能障害・警告レベル問題 | 2時間以内 | テスト失敗・設定不整合 |
| **Low** | 軽微な問題・改善要望 | 24時間以内 | ログ警告・性能微調整 |

### **初期対応フロー（Phase 13スクリプト統合対応）**

#### **Step 1: 現状把握（2分以内）**
```bash
# 1-1. システム全体状況確認（統合管理CLI）
python scripts/management/dev_check.py status

# 1-2. 統合診断実行（Phase 13品質保証）
python scripts/management/dev_check.py full-check

# 1-3. GCP Cloud Run状況確認
gcloud run services describe crypto-bot-service --region=asia-northeast1

# 1-4. GitHub Actions監視確認
gh run list --limit 5
```

#### **Step 2: 緊急度判定（1分以内）**

**Critical判定条件**:
- ✅ アプリケーション起動不可（ModuleNotFoundError等）
- ✅ 取引機能完全停止
- ✅ データ損失リスク
- ✅ セキュリティ侵害疑い
- ✅ GitHub Actions CI/CD完全失敗

**High判定条件**:
- ✅ ML予測システム障害
- ✅ Bitbank API接続不可
- ✅ テスト成功率50%以下
- ✅ 24時間監視システム障害
- ✅ 段階的デプロイ失敗

### **Critical レベル対応**

#### **C1. システム完全停止**
```bash
# 即座対応（5分以内）
# 1. GitHub Actions経由緊急ロールバック
git log --oneline -10  # 安定版確認
gh workflow run ci.yml --ref <安定版コミットハッシュ>

# 2. Cloud Run直接ロールバック（GitHub障害時）
gcloud run revisions list --service=crypto-bot-service --region=asia-northeast1
gcloud run services update-traffic crypto-bot-service \
  --to-revisions=<安定リビジョン名>=100 \
  --region=asia-northeast1

# 3. 緊急停止（最終手段）
gcloud run services update crypto-bot-service \
  --min-instances=0 \
  --max-instances=0 \
  --region=asia-northeast1
```

#### **C2. データ損失・破損疑い**
```bash
# 即座対応（5分以内）
# 1. 重要ファイル存在確認
ls -la models/production/production_ensemble.pkl
ls -la scripts/management/dev_check.py

# 2. MLモデル緊急再作成
python scripts/ml/create_ml_models.py --emergency-rebuild

# 3. 統合確認
python scripts/management/dev_check.py phase-check
```

### **High レベル対応**

#### **H1. ML予測システム障害**
```bash
# 30分以内対応
# 1. MLシステム診断
python scripts/management/dev_check.py ml-models --dry-run

# 2. モデルファイル確認・再作成
python scripts/ml/create_ml_models.py

# 3. 個別コンポーネント確認
python3 -c "from src.ml.ensemble import ProductionEnsemble; print('✅ Ensemble OK')"
```

#### **H2. CI/CD・監視システム障害（Phase 13スクリプト統合対応）**
```bash
# 30分以内対応
# 1. GitHub Actions状況確認（スクリプト統合後のパス確認）
gh run list --limit 10
gh run view --log

# 2. ワークフローファイル確認（testing/checks.shパス確認）
ls -la .github/workflows/
cat .github/workflows/ci.yml
cat .github/workflows/monitoring.yml

# 3. 手動デプロイ実行（Phase 13対応）
gcloud run deploy crypto-bot-service --source . --region=asia-northeast1
```

---

## 🔄 ロールバック手順（Phase 13スクリプト統合対応）

### **段階的ロールバック戦略**

#### **1. GitHub Actions経由ロールバック（推奨）**
```bash
# 1-1. 安定版コミット特定
git log --oneline -10

# 1-2. GitHub Secrets DEPLOY_MODE調整
# Critical: live → paper（即座安全化）
# High: live → stage-50（段階的ロールバック）
# Medium: stage-50 → stage-10（慎重ロールバック）

# 1-3. 安定版デプロイ実行
gh workflow run ci.yml --ref <安定版コミットハッシュ>

# 1-4. デプロイ状況確認
gh run list --limit 5
```

#### **2. Cloud Run直接ロールバック**
```bash
# 2-1. リビジョン一覧確認
gcloud run revisions list --service=crypto-bot-service --region=asia-northeast1

# 2-2. 安定リビジョンへ切替
gcloud run services update-traffic crypto-bot-service \
  --to-revisions=<安定リビジョン名>=100 \
  --region=asia-northeast1

# 2-3. ロールバック確認
gcloud run services describe crypto-bot-service \
  --region=asia-northeast1 \
  --format="value(status.traffic[0].revisionName,status.traffic[0].percent)"
```

#### **3. 段階的移行のロールバック**

**100% → 50%段階へのロールバック**:
```bash
# GitHub Secrets: DEPLOY_MODE=stage-50 に変更
gh workflow run ci.yml --ref main

# トラフィック分割確認
gcloud run services describe crypto-bot-service \
  --region=asia-northeast1 \
  --format="value(status.traffic)"
```

**50% → 10%段階へのロールバック**:
```bash
# GitHub Secrets: DEPLOY_MODE=stage-10 に変更
gh workflow run ci.yml --ref main
```

**10%段階 → ペーパートレードへのロールバック**:
```bash
# GitHub Secrets: DEPLOY_MODE=paper に変更
gh workflow run ci.yml --ref main

# 実取引完全停止確認
gcloud run services update crypto-bot-service \
  --set-env-vars="MODE=paper,BITBANK_TESTNET=true" \
  --region=asia-northeast1
```

### **ロールバック完了後確認**

```bash
# 1. 統一品質チェック・システム基本確認（5分以内）
bash scripts/testing/checks.sh
python scripts/management/dev_check.py full-check

# 2. API応答確認
curl -f "$(gcloud run services describe crypto-bot-service \
  --region=asia-northeast1 --format='value(status.url)')/health"

# 3. 24時間監視再開確認
gh workflow list  # monitoring.yml稼働確認

# 4. データ収集・ダッシュボード確認
python scripts/analytics/dashboard.py --discord
```

---

## 🔍 トラブルシューティング

### **よくある問題と対処法**

#### **GitHub Actions失敗**
```bash
# 1. 失敗詳細確認
gh run view <run-id> --log-failed

# 2. Secrets設定確認
# Repository Settings → Secrets and variables → Actions

# 3. 手動デプロイ実行
gcloud run deploy crypto-bot-service --source . --region=asia-northeast1
```

#### **監視アラート対応**

**Critical Alert対応**:
1. **即座確認**: `gcloud run services describe SERVICE_NAME`
2. **ログ分析**: `gcloud logging read "severity >= ERROR"`
3. **ロールバック**: GitHub Actions または Cloud Run直接
4. **24時間監視**: 復旧後の継続監視確認

**Warning Alert対応**:
1. **トレンド確認**: 継続的問題か一時的問題か
2. **パフォーマンス分析**: `python scripts/analytics/performance_analyzer.py`
3. **改善計画**: 次回デプロイで修正検討

#### **Phase 13特有の問題（スクリプト統合後）**

**統合分析基盤障害**:
```bash
# 1. 統合データ収集テスト（base_analyzer.py基盤）
python scripts/analytics/data_collector.py --hours 1

# 2. A/Bテストシステム確認（統一インターフェース）
# A/Bテストは ModelManager.run_ab_test() で実行（スクリプト統合後は統一管理）

# 3. 統合ダッシュボード生成確認
python scripts/analytics/dashboard.py

# 4. base_analyzer.py基盤動作確認
python -c "from scripts.analytics.base_analyzer import BaseAnalyzer; print('✅ Base Analyzer OK')"
```

---

## 📋 定期メンテナンス

### **日次メンテナンス（Phase 13スクリプト統合対応）**
```bash
# 1. 統一品質チェック（CI環境同一・統一品質ゲート）
bash scripts/testing/checks.sh

# 2. 統合管理チェック（システム検証・品質保証）
python scripts/management/dev_check.py full-check

# 3. 統合分析基盤更新（base_analyzer.py基盤使用）
python scripts/analytics/data_collector.py --hours 24
python scripts/analytics/dashboard.py --discord

# 3. 24時間監視確認（スクリプト統合後のパス確認）
gh run list --workflow=monitoring.yml --limit 5
```

### **週次メンテナンス（Phase 13統合分析基盤対応）**
```bash
# 1. 統合パフォーマンス分析（base_analyzer.py基盤）
python scripts/analytics/performance_analyzer.py --period 7d --format markdown

# 2. A/Bテスト実行・判定（統一インターフェース）
# A/Bテストは ModelManager.run_ab_test() で実行（スクリプト統合後は統一管理）

# 3. MLモデル性能確認（sklearn警告解消対応）
python scripts/management/dev_check.py ml-models --dry-run

# 4. GCPリソース確認（Phase 13スクリプト統合対応）
gcloud run services list
gcloud artifacts docker images list --repository=crypto-bot-repo
```

### **月次メンテナンス**
```bash
# 1. MLモデル再学習（必要時）
python scripts/ml/create_ml_models.py --retrain

# 2. 古いリソースクリーンアップ
gcloud run revisions list --service=crypto-bot-service --region=asia-northeast1
# 古いリビジョン削除（手動確認後）

# 3. 月次総合レポート
python scripts/analytics/performance_analyzer.py --period 30d --format markdown
python scripts/analytics/dashboard.py
```

---

## 📝 運用ログテンプレート

### **日次運用ログ**
```
日付: YYYY-MM-DD
担当者: [名前]

【実施項目】
□ Phase 13統合チェック（full-check・スクリプト統合対応）
□ 統合分析基盤更新（base_analyzer.py基盤使用）
□ 24時間監視状況確認（スクリプト統合後のパス確認）
□ パフォーマンス指標確認（統合レポート管理）

【結果】
- 統合チェック: ✅/❌ (6段階中__成功・Phase 13スクリプト統合対応)
- 統合分析基盤: ✅/❌ (収集データ数: __・base_analyzer.py基盤使用)
- 統合ダッシュボード: ✅/❌ (総合スコア: __・重複コード500行削除効果)
- 監視システム: ✅/❌ (アラート: __・スクリプト統合後のパス確認)

【問題・対応】
- 問題: [詳細]
- 対応: [実施した対応]

【次回対応事項】
- [ ] [対応項目1]
- [ ] [対応項目2]
```

### **緊急時対応ログ**
```
【緊急事象対応報告】
発生日時: YYYY-MM-DD HH:MM:SS
担当者: [名前]
緊急度: Critical/High/Medium/Low

【事象概要】
- 症状: [詳細な症状]
- 影響: [影響範囲・停止時間]
- 発見経緯: [発見方法・きっかけ]

【初期対応】
- 現状把握: [実施した確認作業]
- 緊急度判定: [判定根拠]
- 即座対応: [実施した緊急対応]

【根本対応】
- 原因特定: [特定した原因]
- 実施対応: [実施した対応]
- ロールバック: [ロールバック実施内容]
- 確認結果: [復旧確認結果]

【再発防止策】
- 改善項目: [特定した改善点]
- 実施予定: [実施予定の対策]
- ドキュメント更新: [更新したドキュメント]

【所要時間】
- 発見→初期対応: __分
- 初期対応→根本対応: __分
- 総対応時間: __分

【学習事項】
- 改善点: [運用・技術面の改善点]
- 気づき: [今後に活かす気づき]
```

---

## 🔗 関連ドキュメント

- **デプロイメント詳細**: `docs/deployment_log.md`
- **GitHub Secrets設定**: `docs/github_secrets_setup.md`
- **システム全体**: `CLAUDE.md`（Phase 13完了状態・スクリプト統合）
- **ドキュメント概要**: `docs/README.md`

---

## 📞 緊急連絡・エスカレーション

### **連絡体制**
1. **1次対応**: 運用担当者（即座対応）
2. **2次対応**: 開発担当者（30分以内）
3. **3次対応**: システム責任者（1時間以内）

### **エスカレーション条件**
- Critical問題で30分以内に解決不可
- High問題で2時間以内に解決不可
- 複数の問題が同時発生
- 外部要因（GCP障害・Bitbank障害）疑い
- Phase 13システム（スクリプト統合・CI/CD・監視・統合分析基盤）障害

### **重要コマンド一覧**
```bash
# 即座停止
gcloud run services update crypto-bot-service --min-instances=0 --region=asia-northeast1

# 状態確認（Phase 13スクリプト統合対応）
python scripts/management/dev_check.py full-check

# GitHub Actions確認（スクリプト統合後のパス確認）
gh run list --limit 5

# 緊急ロールバック
gh workflow run ci.yml --ref <安定版コミット>

# ログ確認
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=20

# 統合パフォーマンス分析（base_analyzer.py基盤）
python scripts/analytics/performance_analyzer.py --period 1h
```

---

**🎯 継続的改善**: このマニュアルはCI/CD統合簡素化完了運用実績に基づいて定期的に更新し、checks.sh統一品質ゲート・Local=CI環境統一・CI/CD 70%削減効率化・企業級品質保証と個人開発効率性両立システムの効率的な運用体制を維持します。

**最終更新**: 2025年9月1日 - CI/CD統合簡素化完了時（654テスト100%・59.24%カバレッジ・統一品質ゲート）