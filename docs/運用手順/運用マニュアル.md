# 運用マニュアル - crypto-bot Phase 19システム

## 📋 概要

**最終更新**: 2025年9月4日  
**システムバージョン**: Phase 19完了 - 特徴量統一管理・MLOps基盤・企業級品質達成  
**運用環境**: GCP Cloud Run 24時間稼働・654テスト100%・59.24%カバレッジ  
**対象者**: システム運用者・開発者・緊急時対応担当者

このマニュアルは、**Phase 19完了システム**（特徴量統一管理・MLOps基盤・定期再学習CI完成）の日常運用・監視・緊急時対応の手順を定義します。

---

## 🎯 Phase 19システム構成

```
Phase 19完了システム構成:
├── src/features/           # 特徴量統一管理（feature_manager.py・12特徴量）
├── src/strategies/         # 取引戦略（4戦略統合・113テスト100%）  
├── src/ml/                 # MLOps基盤（ProductionEnsemble・週次自動再学習）
├── src/core/               # 基盤システム（orchestration・統合制御）
├── src/data/               # データ層（Bitbank API・マルチタイムフレーム）
├── src/trading/            # 取引実行（Kelly基準・リスク管理）
└── src/monitoring/         # 監視（Discord通知・3階層アラート）

CI/CD・品質保証:
├── scripts/testing/checks.sh      # 統一品質ゲート（654テスト・30秒実行）
├── scripts/testing/dev_check.py # システム診断・MLOps管理
└── .github/workflows/              # 自動CI/CD・週次再学習
```

### Phase 19主要達成項目
- ✅ **特徴量統一管理**: feature_manager.py による12特徴量一元化
- ✅ **MLOps基盤**: 週次自動再学習・バージョン管理・Git統合
- ✅ **品質保証**: 654テスト100%・59.24%カバレッジ・統一品質ゲート
- ✅ **本番稼働**: Cloud Run 24時間稼働・Discord監視・自動取引継続

---

## 🔧 日常運用手順

### 1. システム状態確認（毎日推奨）

```bash
# プロジェクトディレクトリへ移動
cd /Users/nao/Desktop/bot

# 統一品質チェック（30秒で完了）
bash scripts/testing/checks.sh

# システム総合診断
python3 scripts/testing/dev_check.py full-check

# 本番環境稼働確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1
```

**期待結果**:
- ✅ 654テスト100%成功・59.24%カバレッジ達成
- ✅ feature_manager.py 12特徴量統一管理正常
- ✅ ProductionEnsemble・MLOps基盤正常稼働
- ✅ Cloud Run 24時間稼働・Discord監視正常

### 2. MLOpsシステム管理（週1回）

```bash
# MLモデル状態確認
python3 scripts/testing/dev_check.py ml-models --dry-run

# 週次自動再学習状況確認
gh run list --workflow=weekly-retrain.yml --limit 5

# モデル性能検証
python3 -c "
from src.ml.ensemble import ProductionEnsemble
model = ProductionEnsemble()
print(f'✅ MLモデル正常: {model.is_fitted}')
"
```

### 3. 監視・アラート確認

```bash
# Discord通知履歴確認
python3 scripts/management/ops_monitor.py --phase phase2

# エラーログ確認（過去24時間）
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=10

# システムパフォーマンス確認
python3 scripts/analytics/performance_analyzer.py --period 24h
```

---

## 🚀 デプロイメント・CI/CD

### 自動CI/CDフロー（GitHub Actions）

```bash
# ローカル品質チェック
bash scripts/testing/checks.sh

# コード更新・自動デプロイ
git add -A
git commit -m "feat: Phase 19機能改善"
git push origin main  # 自動CI/CD実行

# デプロイ状況確認
gh run list --limit 5
gh run view --log
```

**段階的デプロイ制御**:
- GitHub Secrets `DEPLOY_MODE` で制御（paper → stage-10 → stage-50 → live）
- 24時間監視・ヘルスチェック・品質ゲート統合
- 週次MLOps自動再学習統合

### 手動デプロイ（緊急時）

```bash
# 事前品質確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# Docker Build & Deploy
docker build -t crypto-bot-phase19 .
gcloud run deploy crypto-bot-service-prod \
    --image=crypto-bot-phase19 \
    --region=asia-northeast1 \
    --memory=1Gi --cpu=1 \
    --set-env-vars="MODE=live,EXCHANGE=bitbank"
```

---

## 📊 監視・メトリクス

### 24時間自動監視体制

**監視対象・頻度**:
- **システムヘルス**: 15分間隔（GitHub Actions）
- **取引パフォーマンス**: リアルタイム（Discord通知）
- **MLモデル性能**: 日次評価・週次自動再学習
- **エラー・異常検知**: 即座通知（3階層アラート）

**パフォーマンス目標**:
- **稼働率**: 99.5%以上
- **レスポンス時間**: 平均3秒以下  
- **エラー率**: 5件/時間以下
- **取引勝率**: 55%以上
- **月間収益**: 運用コスト回収（2,000円以上）

### Discord通知体系

```yaml
Critical (即座対応):
  - システム完全停止・データ損失リスク
  - 取引機能障害・ML予測システム障害

Warning (30分以内):
  - パフォーマンス劣化・API接続問題
  - テスト失敗・設定不整合

Info (監視継続):
  - 日次レポート・取引実行通知
  - MLモデル再学習完了・システム正常稼働
```

---

## 🚨 緊急時対応

### 緊急度分類・対応時間

| レベル | 状況 | 対応時間 | 対応方法 |
|--------|------|----------|----------|
| **Critical** | システム完全停止・データ損失 | 5分以内 | 即座ロールバック・サービス停止 |
| **High** | ML障害・API接続不可 | 30分以内 | 段階的ロールバック・診断実行 |
| **Medium** | 一部機能障害・警告 | 2時間以内 | 原因特定・計画的修正 |
| **Low** | 軽微問題・改善要望 | 24時間以内 | 次回デプロイで対応 |

### Critical レベル対応（5分以内）

#### システム完全停止
```bash
# 1. 即座ロールバック（GitHub Actions経由）
git log --oneline -5  # 安定版確認
gh workflow run ci.yml --ref <安定版コミット>

# 2. Cloud Run直接ロールバック（GitHub障害時）
gcloud run revisions list --service=crypto-bot-service-prod
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100

# 3. 緊急停止（最終手段）
gcloud run services update crypto-bot-service-prod --min-instances=0
```

#### データ損失・破損対応
```bash
# 重要ファイル存在確認
ls -la models/production/production_ensemble.pkl
ls -la src/features/feature_manager.py

# MLモデル緊急再作成
python3 scripts/testing/dev_check.py ml-models

# システム整合性確認
python3 scripts/testing/dev_check.py full-check
```

### High レベル対応（30分以内）

#### ML予測システム障害
```bash
# MLシステム診断
python3 scripts/testing/dev_check.py ml-models --dry-run

# モデル再作成・検証
python3 -c "
from src.ml.ensemble import ProductionEnsemble
from src.features.feature_manager import FeatureManager
print('MLシステム診断中...')
"

# 個別コンポーネント確認
python3 scripts/testing/dev_check.py validate
```

---

## 🔄 ロールバック戦略

### 段階的ロールバック手順

#### 1. GitHub Actions経由ロールバック（推奨）
```bash
# 安定版特定・デプロイ
git log --oneline -10
gh workflow run ci.yml --ref <安定版コミット>

# GitHub Secrets調整
# Critical: live → paper（即座安全化）
# High: live → stage-50（段階的切り戻し）
```

#### 2. Cloud Run直接ロールバック
```bash
# 安定リビジョンへ切替
gcloud run revisions list --service=crypto-bot-service-prod
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100

# ロールバック確認
gcloud run services describe crypto-bot-service-prod \
  --format="value(status.traffic)"
```

### ロールバック完了確認

```bash
# システム基本確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# API応答確認
curl -f "$(gcloud run services describe crypto-bot-service-prod \
  --format='value(status.url)')/health"

# 監視再開確認
gh workflow list  # monitoring.yml稼働確認
```

---

## 🔍 よくある問題・対処法

### GitHub Actions失敗
```bash
# 失敗詳細確認
gh run view <run-id> --log-failed

# 手動デプロイ実行
gcloud run deploy crypto-bot-service-prod --source .
```

### MLOpsシステム問題
```bash
# 週次再学習失敗時
gh run view <run-id> --log-failed
python3 scripts/testing/dev_check.py ml-models

# feature_manager.py問題時
python3 -c "
from src.features.feature_manager import FeatureManager
fm = FeatureManager()
print(f'特徴量管理: {len(fm.get_feature_names())}個正常')
"
```

### Discord通知問題
```bash
# 通知設定確認
python3 scripts/management/ops_monitor.py --phase phase2

# 手動通知テスト
python3 -c "
from src.monitoring.discord_notifier import DiscordNotifier
notifier = DiscordNotifier()
notifier.send_notification('テスト通知', 'INFO')
"
```

---

## 📋 定期メンテナンス

### 日次メンテナンス
```bash
# 統一品質チェック・システム診断
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# 24時間監視・パフォーマンス確認
gh run list --workflow=monitoring.yml --limit 5
python3 scripts/analytics/performance_analyzer.py --period 24h
```

### 週次メンテナンス
```bash
# MLOps自動再学習確認
gh run list --workflow=weekly-retrain.yml --limit 5

# 総合パフォーマンス分析
python3 scripts/analytics/performance_analyzer.py --period 7d

# GCPリソース確認
gcloud run services list
gcloud artifacts docker images list
```

### 月次メンテナンス
```bash
# 月次総合レポート生成
python3 scripts/analytics/performance_analyzer.py --period 30d

# 古いリソースクリーンアップ
gcloud run revisions list --service=crypto-bot-service-prod
# 古いリビジョン削除（手動確認後）

# システム全体最適化検討
python3 scripts/testing/dev_check.py full-check
```

---

## 📝 運用ログテンプレート

### 日次運用ログ
```
日付: YYYY-MM-DD
担当者: [名前]

【実施項目】
□ Phase 19システム品質チェック（654テスト・59.24%カバレッジ）
□ MLOps基盤確認（feature_manager.py・週次再学習）
□ 24時間監視・Discord通知確認
□ 本番稼働・取引パフォーマンス確認

【結果】
- システム品質: ✅/❌ (654テスト成功率: __%・カバレッジ: __%)
- MLOps基盤: ✅/❌ (12特徴量統一管理・再学習システム)
- 監視システム: ✅/❌ (アラート数: __・Discord通知)
- 取引性能: ✅/❌ (勝率: __%・日次損益: __円)

【問題・対応】
- 問題: [詳細]
- 対応: [実施内容]

【次回対応事項】
- [ ] [項目1]
- [ ] [項目2]
```

### 緊急時対応ログ
```
【Phase 19システム緊急対応報告】
発生日時: YYYY-MM-DD HH:MM:SS
緊急度: Critical/High/Medium/Low

【事象概要】
- 症状: [詳細]
- 影響: [範囲・停止時間]
- 検知方法: [Discord通知・監視・手動発見]

【初期対応（5分/30分以内）】
- 現状把握: bash scripts/testing/checks.sh
- 緊急度判定: [判定根拠]
- 即座対応: [実施内容]

【根本対応】
- 原因: [特定した原因]
- 対応: [実施した修正]
- ロールバック: [実施内容]
- 確認: [復旧確認結果]

【再発防止】
- 改善点: [特定した課題]
- 対策: [実施予定の改善]

【所要時間】
- 検知→初期対応: __分
- 初期対応→解決: __分
- 総対応時間: __分
```

---

## 🔗 関連ドキュメント・重要コマンド

### 関連ドキュメント
- **システム全体**: `CLAUDE.md`（Phase 19完了状態）
- **ローカル検証**: `docs/運用手順/ローカル検証手順.md`
- **CI/CD設定**: `docs/CI-CD設定/`
- **開発計画**: `docs/開発計画/ToDo.md`

### 緊急時重要コマンド
```bash
# 即座システム停止
gcloud run services update crypto-bot-service-prod --min-instances=0

# システム状態確認
python3 scripts/testing/dev_check.py full-check

# ロールバック実行
gh workflow run ci.yml --ref <安定版コミット>

# エラーログ確認
gcloud logging read 'severity>=ERROR' --limit=20

# Discord通知テスト
python3 scripts/management/ops_monitor.py --phase phase2
```

---

**🎯 Phase 19運用体制**: 特徴量統一管理・MLOps基盤・定期再学習CI完成により、654テスト100%品質保証・59.24%カバレッジ・24時間自動監視を実現した企業級運用システムを確立**

**最終更新**: 2025年9月4日 - Phase 19完了・運用マニュアル最適化・構造化完了