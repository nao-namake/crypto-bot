# 運用マニュアル - crypto-botシステム

## 📋 概要

**最終更新**: 2025年9月8日  
**運用環境**: GCP Cloud Run 24時間稼働・654テスト100%・59.24%カバレッジ  
**対象者**: システム運用者・開発者・緊急時対応担当者

このマニュアルは、crypto-botの日常運用・監視・緊急時対応の手順を定義します。

## 🎯 システム構成

```
システム構成:
├── src/features/           # 特徴量統一管理（feature_manager.py・12特徴量）
├── src/strategies/         # 取引戦略（4戦略統合）  
├── src/ml/                 # MLOps基盤（ProductionEnsemble・週次自動再学習）
├── src/core/               # 基盤システム（orchestration・統合制御）
├── src/data/               # データ層（Bitbank API・マルチタイムフレーム）
├── src/trading/            # 取引実行（Kelly基準・リスク管理）
└── src/monitoring/         # 監視（Discord通知・3階層アラート）

CI/CD・品質保証:
├── scripts/testing/checks.sh      # 統一品質ゲート（654テスト・30秒実行）
├── scripts/testing/dev_check.py # システム診断・MLOps管理
└── .github/workflows/              # 自動CI/CD・週次再学習
```

### 主要機能
- ✅ **特徴量統一管理**: feature_manager.py による12特徴量一元化
- ✅ **MLOps基盤**: 週次自動再学習・バージョン管理・Git統合
- ✅ **品質保証**: 654テスト100%・59.24%カバレッジ・統一品質ゲート
- ✅ **本番稼働**: Cloud Run 24時間稼働・Discord監視・自動取引継続

---

## 🔧 日常運用手順

### 1. システム状態確認（毎日推奨）

```bash
# プロジェクトディレクトリへ移動
cd /Users/nao/Desktop/bot

# 統一品質チェック（30秒で完了）
bash scripts/testing/checks.sh

# システム総合診断
python3 scripts/testing/dev_check.py full-check

# 本番環境稼働確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1
```

**期待結果**:
- ✅ 654テスト100%成功・59.24%カバレッジ達成
- ✅ feature_manager.py 12特徴量統一管理正常
- ✅ ProductionEnsemble・MLOps基盤正常稼働
- ✅ Cloud Run 24時間稼働・Discord監視正常

### 2. MLOpsシステム管理（週1回）

```bash
# MLモデル状態確認
python3 scripts/testing/dev_check.py ml-models --dry-run

# 週次自動再学習状況確認
gh run list --workflow=model-training.yml --limit 5

# モデル性能検証
python3 -c "
from src.ml.ensemble import ProductionEnsemble
model = ProductionEnsemble()
print(f'✅ MLモデル正常: {model.is_fitted}')
"
```

### 3. 監視・アラート確認

```bash
# Discord通知履歴確認
python3 scripts/management/ops_monitor.py --phase phase2

# エラーログ確認（過去24時間）
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=10

# システムパフォーマンス確認
python3 scripts/analytics/performance_analyzer.py --period 24h
```

---

## 🚀 デプロイメント・CI/CD

### 自動CI/CDフロー（GitHub Actions）

```bash
# ローカル品質チェック
bash scripts/testing/checks.sh

# コード更新・自動デプロイ
git add -A
git commit -m "feat: システム機能改善"
git push origin main  # 自動CI/CD実行

# デプロイ状況確認
gh run list --limit 5
gh run view --log
```

**段階的デプロイ制御**:
- GitHub Secrets `DEPLOY_MODE` で制御（paper → stage-10 → stage-50 → live）
- 24時間監視・ヘルスチェック・品質ゲート統合
- 週次MLOps自動再学習統合

### 手動デプロイ（緊急時）

```bash
# 事前品質確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# Docker Build & Deploy
docker build -t crypto-bot .
gcloud run deploy crypto-bot-service-prod \
    --image=crypto-bot \
    --region=asia-northeast1 \
    --memory=1Gi --cpu=1 \
    --set-env-vars="MODE=live,EXCHANGE=bitbank"
```

---

## 📊 監視・メトリクス

### 24時間監視体制
- **システムヘルス**: 15分間隔（GitHub Actions）
- **取引パフォーマンス**: リアルタイム（Discord通知）
- **MLモデル性能**: 日次評価・週次自動再学習
- **エラー・異常検知**: 即座通知（3階層アラート）

### パフォーマンス目標
- 稼働率: 99.5%以上
- レスポンス時間: 平均3秒以下  
- エラー率: 5件/時間以下
- 取引勝率: 55%以上

### Discord通知レベル
- **Critical** (即座対応): システム完全停止・取引機能障害
- **Warning** (30分以内): パフォーマンス劣化・API接続問題
- **Info** (監視継続): 日次レポート・システム正常稼働

---

## 🚨 緊急時対応

### 緊急度別対応時間
- **Critical** (5分以内): システム完全停止・データ損失 → 即座ロールバック
- **High** (30分以内): ML障害・API接続不可 → 段階的ロールバック・診断
- **Medium** (2時間以内): 一部機能障害・警告 → 原因特定・計画的修正
- **Low** (24時間以内): 軽微問題・改善要望 → 次回デプロイで対応

### Critical レベル対応（5分以内）
```bash
# システム完全停止
gh workflow run ci.yml --ref <安定版コミット>  # 即座ロールバック
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100          # 直接ロールバック
gcloud run services update crypto-bot-service-prod --min-instances=0  # 緊急停止

# データ損失・破損対応
python3 scripts/testing/dev_check.py ml-models   # MLモデル再作成
python3 scripts/testing/dev_check.py full-check  # システム整合性確認
```

### High レベル対応（30分以内）
```bash
# ML予測システム障害
python3 scripts/testing/dev_check.py ml-models --dry-run
python3 scripts/testing/dev_check.py validate
```

---

## 🔄 ロールバック戦略

### ロールバック手順
```bash
# 1. GitHub Actions経由（推奨）
git log --oneline -10
gh workflow run ci.yml --ref <安定版コミット>

# 2. Cloud Run直接ロールバック（緊急時）
gcloud run revisions list --service=crypto-bot-service-prod
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100

# 3. 確認
bash scripts/testing/checks.sh
```

---

## 🔍 よくある問題・対処法

```bash
# GitHub Actions失敗
gh run view <run-id> --log-failed
gcloud run deploy crypto-bot-service-prod --source .

# MLOpsシステム問題
python3 scripts/testing/dev_check.py ml-models
python3 scripts/testing/dev_check.py validate

# Discord通知問題
python3 scripts/testing/dev_check.py validate
```

---

## 📋 定期メンテナンス

```bash
# 日次
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py full-check

# 週次
gh run list --workflow=model-training.yml --limit 5
python3 scripts/analytics/performance_analyzer.py --period 7d

# 月次
gcloud run revisions list --service=crypto-bot-service-prod
# 古いリビジョン削除（手動確認後）
```

---

## 📝 運用ログ

### 日次チェックリスト
```
日付: YYYY-MM-DD
□ システム品質チェック（654テスト・59.24%カバレッジ）
□ MLOps基盤確認（feature_manager.py・週次再学習）
□ 24時間監視・Discord通知確認
□ 本番稼働・取引パフォーマンス確認
```

### 緊急時対応記録
```
発生日時: YYYY-MM-DD HH:MM:SS
緊急度: Critical/High/Medium/Low
症状: [詳細]
対応: [実施内容]
復旧時間: __分
```

---

## 🔗 関連ドキュメント・重要コマンド

### 関連ドキュメント
- **システム全体**: `CLAUDE.md`
- **ローカル検証**: `docs/運用手順/ローカル検証手順.md`
- **CI/CD設定**: `docs/CI-CD設定/CI-CDデプロイメントガイド.md`
- **設定ファイル**: `config/core/unified.yaml`

### 緊急時重要コマンド
```bash
# 即座システム停止
gcloud run services update crypto-bot-service-prod --min-instances=0

# システム状態確認
python3 scripts/testing/dev_check.py full-check

# ロールバック実行
gh workflow run ci.yml --ref <安定版コミット>

# エラーログ確認
gcloud logging read 'severity>=ERROR' --limit=20

# Discord通知テスト
python3 scripts/management/ops_monitor.py --phase phase2
```

---

**🎯 運用体制**: 特徴量統一管理・MLOps基盤・定期再学習CI完成により、654テスト100%品質保証・59.24%カバレッジ・24時間自動監視を実現した企業級運用システム**

**最終更新**: 2025年9月8日 - 運用マニュアル最適化・統一設定ファイル対応完了