# ローカル検証手順

**最終更新**: 2025年9月16日
**対象者**: 開発者
**目的**: ローカル環境での開発・検証・テスト実行手順（安全実行スクリプト対応）

## 🎯 概要

ローカル環境で実行できる主要な検証機能を説明します：

1. **統一品質チェック** - 625テスト・コード品質・統一品質ゲート
2. **システム診断** - 設定・モデル・整合性チェック
3. **バックテスト** - 過去データでの戦略検証（安全実行スクリプト推奨）
4. **ペーパートレード** - リアルタイム仮想取引（安全実行スクリプト推奨）
5. **🆕 プロセス管理** - 重複起動防止・環境自動判定・安全実行制御

## 🚨 重要な実行方式変更

**2025年9月16日より、Bot実行は安全実行スクリプト経由を強く推奨**：

- **推奨**: `bash scripts/management/run_safe.sh local paper`
- **非推奨**: `python3 main.py --mode paper` ← 無限通知・プロセス重複リスク

すべての実行結果は自動的にマークダウンレポートとして保存され、他のツールとの情報共有が可能です。

## 1. 🔍 統一品質チェック

### 実行方法

```bash
# メイン品質チェック（推奨・CI環境同一）
bash scripts/testing/checks.sh

# システム診断（補完）
python3 scripts/testing/dev_check.py full-check

# 個別チェック（必要時のみ）
python3 scripts/testing/dev_check.py validate      # 軽量品質チェック
python3 scripts/testing/dev_check.py ml-models     # MLモデル作成・検証
python3 scripts/testing/dev_check.py status        # システム状態確認
```

### 期待結果

```
🚀 新システム品質チェック開始
=================================================
>>> 📂 新システムディレクトリ構造確認
✅ src/ディレクトリ確認完了
>>> 🤖 MLモデル整合性チェック
✅ 本番用統合モデル存在確認
>>> 🎨 flake8: コードスタイルチェック
✅ flake8チェック完了
>>> 📥 isort: import順序チェック
✅ isortチェック完了
>>> ⚫ black: コード整形チェック
✅ blackチェック完了
>>> 🧪 pytest: 新システム全テスト実行
✅ 654 passed in 26.78s (59.24%カバレッジ達成)

🎉 品質チェック完了！全項目合格
```

### レポート保存場所

```
logs/dev_check_reports/
├── dev_check_full-check_YYYYMMDD_HHMMSS.md     # 統合チェック結果
├── dev_check_validate_YYYYMMDD_HHMMSS.md       # 品質チェック結果
└── dev_check_status_YYYYMMDD_HHMMSS.md         # システム状態確認結果
```

## 2. 📊 バックテスト

### 🆕 推奨実行方法（安全実行スクリプト）

```bash
# 推奨: 安全実行スクリプト使用（プロセス管理・重複防止）
bash scripts/management/run_safe.sh local backtest

# プロセス状況確認
bash scripts/management/run_safe.sh status

# 強制停止（必要時のみ）
bash scripts/management/run_safe.sh stop
```

### ⚠️ 従来実行方法（非推奨・プロセス重複リスク）

```bash
# 非推奨: 直接実行（プロセス重複・無限通知リスク）
python3 main.py --mode backtest  # ← 今後非推奨

# 設定ファイル指定（非推奨）
python3 main.py --mode backtest --config config/core/unified.yaml  # ← 今後非推奨
```

### 期待結果（安全実行スクリプト）

```
========================================
🚀 暗号資産取引Bot安全実行
========================================

[INFO]  2025-09-16 10:30:00 - 🔒 プロセスロック取得: PID=12345
[INFO]  2025-09-16 10:30:00 - 🌍 実行環境設定: local
[INFO]  2025-09-16 10:30:00 - 💻 ローカル環境設定完了
[INFO]  2025-09-16 10:30:00 - 🎯 動作モード: backtest
[INFO]  2025-09-16 10:30:00 - 🚀 暗号資産取引Bot起動開始

🚀 暗号資産取引Bot 起動 - モード: BACKTEST
📊 バックテストモード開始
📅 バックテスト期間: 2025-08-22 ~ 2025-09-16
⏳ バックテスト実行中...
📈 総取引数: 15件、勝率: 73.33%、総損益: ¥127,500
✅ バックテスト実行完了

[INFO]  2025-09-16 10:35:00 - ✅ Bot正常終了
[INFO]  2025-09-16 10:35:00 - 🔓 プロセスロック解除

🎉 実行完了
```

### レポート保存場所

```
logs/backtest_reports/
├── backtest_YYYYMMDD_HHMMSS.md          # バックテスト結果レポート
├── backtest_YYYYMMDD_HHMMSS.json        # 詳細データ（JSON形式）
└── backtest_error_YYYYMMDD_HHMMSS.md    # エラー時のレポート（該当時のみ）
```

### レポート内容例

```markdown
# バックテスト実行レポート

## 📊 実行サマリー
- **実行時刻**: 2025年09月08日 10:30:15
- **バックテスト期間**: 2025-08-08 ~ 2025-09-08
- **対象シンボル**: BTC_JPY
- **実行結果**: ✅ SUCCESS

## 📈 パフォーマンス結果
- **総取引数**: 15件
- **勝率**: 73.33% (11/15)
- **総損益**: ¥127,500
- **最終資産**: ¥1,127,500
- **リターン**: 12.75%

## 📊 取引詳細
### 取引履歴（最新10件）
1. 2025-09-07 14:30:00 - BUY @ ¥10,250,000 📈 ¥15,000
2. 2025-09-07 16:45:00 - SELL @ ¥10,180,000 📉 ¥-8,500
...
```

## 3. 📝 ペーパートレード

### 🆕 推奨実行方法（安全実行スクリプト）

```bash
# 推奨: 安全実行スクリプト使用（プロセス管理・重複防止）
bash scripts/management/run_safe.sh local paper

# プロセス状況確認
bash scripts/management/run_safe.sh status

# 安全停止（推奨）
bash scripts/management/run_safe.sh stop

# ロックファイルクリーンアップ（異常終了時）
bash scripts/management/run_safe.sh cleanup
```

### ⚠️ 従来実行方法（非推奨・プロセス重複リスク）

```bash
# 非推奨: 直接実行（プロセス重複・無限通知リスク）
python3 main.py --mode paper  # ← 今後非推奨

# 設定ファイル明示的指定（非推奨）
python3 main.py --mode paper --config config/core/unified.yaml  # ← 今後非推奨

# 停止は Ctrl+C（プロセス残存リスク）
```

### 期待結果（安全実行スクリプト）

```
========================================
🚀 暗号資産取引Bot安全実行
========================================

[INFO]  2025-09-16 14:30:00 - 🔒 プロセスロック取得: PID=74590
[INFO]  2025-09-16 14:30:00 - 🌍 実行環境設定: local
[INFO]  2025-09-16 14:30:00 - 💻 ローカル環境設定完了
[INFO]  2025-09-16 14:30:00 - 🎯 動作モード: paper
[INFO]  2025-09-16 14:30:00 - 🚀 暗号資産取引Bot起動開始

🚀 暗号資産取引Bot 起動 - モード: PAPER
📝 ペーパートレードモード開始
🔄 取引サイクル開始 (1分間隔)
📊 シグナル生成: BUY @ ¥10,250,000 (信頼度: 0.78)
💼 仮想取引実行: BUY 0.001 BTC @ ¥10,250,000
🕐 次のサイクルまで 60秒待機...
...

停止時 (Ctrl+C または stop コマンド):
[INFO]  2025-09-16 14:35:00 - ✅ Bot正常終了
[INFO]  2025-09-16 14:35:00 - 🔓 プロセスロック解除

🎉 実行完了
```

### レポート保存場所

```
logs/paper_trading_reports/
├── paper_trading_YYYYMMDD_HHMMSS.md     # 10分ごとの定期レポート
├── paper_trading_YYYYMMDD_HHMMSS.json   # セッション詳細データ
└── ...
```

## 4. 🚀 トラブルシューティング

### 🆕 プロセス管理関連の問題と解決方法

#### 1. 「既にプロセスが実行中です」エラー
```bash
❌ [ERROR] 既にプロセスが実行中です
```

**解決方法**:
```bash
# プロセス状況確認
bash scripts/management/run_safe.sh status

# 安全停止
bash scripts/management/run_safe.sh stop

# ロックファイルクリーンアップ（必要時）
bash scripts/management/run_safe.sh cleanup
```

#### 2. ロックファイルが残っている
```bash
❌ ロックファイルが存在しますが、プロセスは実行されていません
```

**解決方法**:
```bash
# クリーンアップ実行
bash scripts/management/run_safe.sh cleanup

# 再実行
bash scripts/management/run_safe.sh local paper
```

#### 3. 無限Discord通知問題
```bash
❌ Discord通知が1分間隔で止まらない
```

**解決方法**:
```bash
# 原因: 直接実行による重複プロセス
# 1. 全Bot プロセス確認・終了
ps aux | grep main.py | grep -v grep
kill [PID番号]

# 2. 安全実行スクリプト使用
bash scripts/management/run_safe.sh local paper  # 推奨
```

### 従来の問題と解決方法

#### 4. インポートエラー
```bash
❌ 必要なモジュールのインポートに失敗: No module named 'src.core.config'
```

**解決方法**:
```bash
# プロジェクトルートディレクトリから実行していることを確認
cd /Users/nao/Desktop/bot

# 推奨: 安全実行スクリプト使用（環境変数自動設定）
bash scripts/management/run_safe.sh local paper

# 非推奨: 直接実行（環境変数を手動設定必要）
# export PYTHONPATH=/Users/nao/Desktop/bot
# python3 main.py --mode paper
```

#### 2. MLモデル読み込みエラー
```bash
❌ ML models availability: Model files exist but loading failed
```

**解決方法**:
```bash
# MLモデル再作成
python3 scripts/testing/dev_check.py ml-models
```

#### 3. テスト失敗
```bash
❌ pytest: 654 tests failed
```

**解決方法**:
```bash
# 統一品質チェック実行
bash scripts/testing/checks.sh

# 詳細なテスト結果確認
python3 -m pytest tests/unit/ -v --tb=short

# システム診断
python3 scripts/testing/dev_check.py validate
```

#### 4. 権限エラー
```bash
❌ Permission denied: '/Users/nao/Desktop/bot/logs'
```

**解決方法**:
```bash
# ログディレクトリの権限確認・作成
mkdir -p logs/reports/{ci_checks,operational,trading,analytics}
chmod 755 logs/
```

## 5. 🤖 他のAIツールとの情報共有

### レポートファイルの活用方法

1. **レポートファイルを開く**:
   ```bash
   # 最新のレポートを確認
   ls -la logs/dev_check_reports/ | tail -5
   cat logs/dev_check_reports/dev_check_full-check_latest.md
   ```

2. **内容をコピーしてAIに相談**:
   - レポートの内容をコピー
   - 他のAIツール（ChatGPT、Claude等）に貼り付け
   - 「このレポートを基に問題の解決方法を教えて」等で相談

### レポートに含まれる有用情報

- **実行コマンド**: 再現可能な実行手順
- **エラー詳細**: 具体的なエラーメッセージ
- **システム環境**: バージョン・設定情報
- **推奨アクション**: 次に実行すべきコマンド
- **統計情報**: テスト成功率・パフォーマンス指標

## 6. 📅 推奨実行スケジュール

### 開発時
```bash
# コード変更後
bash scripts/testing/checks.sh

# 大きな変更後
python3 scripts/testing/dev_check.py check --level standard

# デプロイ前品質確認
bash scripts/testing/checks.sh
python3 scripts/testing/dev_check.py critical

# 動作確認（短時間）
bash scripts/management/run_safe.sh local paper  # 2-3分実行後停止
```

### 運用時
```bash
# 日次の健全性確認
python3 scripts/testing/dev_check.py check --level standard

# 週次の包括確認
python3 scripts/testing/dev_check.py check --level full
bash scripts/management/run_safe.sh local backtest

# 月次のバックテスト（推奨: 安全実行）
bash scripts/management/run_safe.sh local backtest

# プロセス状況定期確認
bash scripts/management/run_safe.sh status
```

## 7. 📊 レポート保存構造

```
logs/
├── dev_check_reports/           # システム診断結果
│   ├── dev_check_full-check_*.md
│   ├── dev_check_validate_*.md
│   └── dev_check_status_*.md
├── backtest_reports/            # バックテスト結果
│   ├── backtest_*.md
│   ├── backtest_*.json
│   └── backtest_error_*.md
└── paper_trading_reports/       # ペーパートレード結果
    ├── paper_trading_*.md
    ├── paper_trading_*.json
    └── ...
```

すべてのレポートは **タイムスタンプ付きファイル名** で保存され、実行履歴の追跡が可能です。

## 🔗 関連リソース

### コマンドリファレンス

#### 🆕 安全実行スクリプト（推奨）
- `bash scripts/management/run_safe.sh local paper` - ペーパートレード安全実行
- `bash scripts/management/run_safe.sh local backtest` - バックテスト安全実行
- `bash scripts/management/run_safe.sh status` - プロセス状況確認
- `bash scripts/management/run_safe.sh stop` - 安全停止
- `bash scripts/management/run_safe.sh cleanup` - ロックファイルクリーンアップ

#### 品質チェック・診断
- `bash scripts/testing/checks.sh` - 統一品質チェック
- `python3 scripts/testing/dev_check.py check --level standard` - 標準品質チェック
- `python3 scripts/testing/dev_check.py critical` - 隠れた障害検出

#### ⚠️ 直接実行（非推奨・プロセス重複リスク）
- `python3 main.py --mode [backtest|paper]` - 直接実行（非推奨）

### 設定ファイル
- `config/core/unified.yaml` - 統一設定ファイル
- `config/core/thresholds.yaml` - 動的閾値設定

### 関連ドキュメント
- `docs/CI-CD設定/CI-CDデプロイメントガイド.md` - CI/CD環境構築
- `docs/運用手順/運用マニュアル.md` - 日常運用・緊急対応

---

---

**🚨 重要**: 2025年9月16日より、Bot実行は **安全実行スクリプト（`scripts/management/run_safe.sh`）経由を強く推奨** します。直接実行（`python3 main.py`）は無限通知・プロセス重複リスクがあるため今後非推奨です。

**🎉 このガイドに従って安全実行スクリプト経由でローカル環境での検証を実行し、結果を他のツールと共有することで効率的で安全な開発・デバッグが可能になります。**