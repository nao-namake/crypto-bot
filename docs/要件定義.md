# 暗号資産取引Bot リファクタリング要件定義書

## 1. プロジェクト概要

現状、プロジェクト開発から５ヶ月が経過し、さまざまな機能をエラーが出るたびに追加してきたことからつぎはぎのシステム構造になっているのが否めない。ある程度システムの基礎ができたことから、現状を振り返り、見直しをかけるいいタイミングであると考える。

大規模なリファクタリングを行い、保守性・安定性を高めたなるべくシンプルな構造に作り替えたい。
現在のファイル・フォルダを踏襲しつつ、新規にフォルダ群を作り段階的に機能を追加する手法を取りたい。

また、CloudeCodeには、Thinking時も含めて常に日本語で私とやり取りをすることを求める

## 2. 基本要件

### 2.1 開発体制
- 完全な個人開発。チーム開発することはない
- 現在の戦略以外は基本的に踏襲するが、シンプルな構造にできないか再考する

### 2.2 システム要件
- **監視システム**: Discordを使用したエラー通知・稼働監視
- **取引頻度**: 月100〜200回（1日あたり3〜7回程度）
- **収益目標**: 月額課金額以上（GCP: 約2,000円、Claude Code: 約15,000円）
- **Bot種別**: アンサンブルモデルを使用する機械学習Bot
- **外部API**: エラーの温床のため導入は最終段階とする

## 3. アーキテクチャ設計

### 3.1 システム構造
- **レイヤード・アーキテクチャ**の採用
  - データ層：市場データの取得・保存
  - ビジネスロジック層：戦略実行・シグナル生成
  - API層：取引所との通信
- **モジュール間の疎結合設計**により依存関係を最小化
- **インターフェース**を用いた抽象化で拡張性を確保

### 3.2 ディレクトリ構造
```
crypto-bot/
├── src/
│   ├── data/          # データ取得・管理
│   ├── strategies/    # 取引戦略
│   ├── ml/           # 機械学習モデル
│   ├── trading/      # 取引実行
│   ├── monitoring/   # 監視・通知
│   └── utils/        # 共通ユーティリティ
├── config/           # 設定ファイル
├── tests/           # テストコード
└── docs/            # ドキュメント
```

## 4. 取引戦略

### 4.1 アンサンブル戦略
複数の戦略の良いところを組み合わせる手法を採用

### 4.2 個別戦略
- **戦略１**: もちぽよアラート（EMA、MACD、ZigZag、RCI）
- **戦略２**: ATR計算、Volumeなどの外部APIに頼らないマクロ系指標
- **戦略３**: マルチタイムフレーム
  - 4時間足：上位トレンド判断
  - 15分足：エントリータイミング
- **戦略４**: フィボナッチリトレースメント

## 5. データ管理

### 5.1 データパイプライン
- 時系列データの効率的な保存・取得方法の実装
- バックテスト用と本番用のデータパイプライン分離
- データ品質チェック機能の実装

### 5.2 データ保存戦略
- **生データ**: 3ヶ月保存
- **集計データ**: 1年保存
- **キャッシング**: 頻繁にアクセスするデータのメモリキャッシュ検討

## 6. 機械学習パイプライン

### 6.1 モデル管理
- **特徴量エンジニアリング**の自動化フレームワーク構築
- **モデルバージョン管理**システムの実装
- **A/Bテスト機能**：新旧モデルの並行稼働と性能比較
- **性能劣化検知**：モデルパフォーマンスの継続的監視

### 6.2 特徴量設計
- バックテストによる性能検証後、段階的に特徴量を追加
- 各戦略から抽出される特徴量の標準化

## 7. リスク管理

### 7.1 ポジション管理
- **ポジションサイジング**: 資金に対する適切な取引量の自動計算
- **最大ドローダウン**: 資金の20%を上限とする
- **連続損失時の自動停止**: 連続5回の損失で24時間取引停止

### 7.2 異常検知
- 異常なスプレッド検知による取引回避
- 急激な価格変動時の取引制限
- API遅延時の注文キャンセル機能

## 8. パフォーマンス要件

### 8.1 処理速度
- **レイテンシー目標**: シグナル発生から注文まで1秒以内
- **データ処理**: 1分足データの処理を10秒以内に完了

### 8.2 リソース管理
- **メモリ使用量**: 最大2GB
- **CPU使用率**: 平均50%以下、ピーク時80%以下
- **同時処理**: 最大5通貨ペアの並行処理

## 9. 監視・通知システム

### 9.1 Discord通知の階層化
- **Critical**: 取引停止、大幅損失（即時通知）
- **Warning**: 異常スプレッド、API遅延（5分以内通知）
- **Info**: 日次サマリー、取引実行通知（バッチ通知）

### 9.2 ダッシュボード
- リアルタイムパフォーマンス表示
- 損益推移グラフ
- エラー発生状況の可視化

## 10. テスト戦略

### 10.1 テスト実施基準
- **単体テスト**: カバレッジ80%以上
- **統合テスト**: 主要なユースケースを網羅
- **バックテスト**: 過去6ヶ月分のデータで検証

### 10.2 本番移行前テスト
- **ペーパートレード**: 最低1ヶ月間の仮想取引
- **少額実運用**: 最小取引単位で2週間のテスト運用

## 11. 設定管理

### 11.1 環境設定
- 環境変数による設定の外部化（.env ファイル使用）
- 戦略パラメータの動的変更機能
- ドライラン/本番モードの切り替え機能

### 11.2 セキュリティ
- APIキーの暗号化保存
- ログからの機密情報自動除外
- レート制限の実装

## 12. 段階的移行計画

### Phase 1: 基盤構築（2週間）
- 新アーキテクチャの骨組み作成
- 基本的なデータ処理機能の実装
- ログシステムの構築

### Phase 2: 戦略実装（3週間）
- 既存戦略の移植とリファクタリング
- バックテスト環境の構築
- 戦略パフォーマンス評価システム

### Phase 3: ML統合（2週間）
- アンサンブルモデルの実装
- 特徴量パイプラインの構築
- モデル学習・評価の自動化

### Phase 4: 本番移行（1週間）
- ペーパートレードの実施
- 段階的な資金投入（10% → 50% → 100%）
- 本番環境でのモニタリング強化

## 13. ドキュメント化

### 13.1 必須ドキュメント
- **README.md**: セットアップ手順、アーキテクチャ図、各フォルダ内に完備
- **API仕様書**: 各モジュールのインターフェース定義
- **戦略説明書**: 各戦略のロジックと数式
- **運用マニュアル**: 日常運用とトラブルシューティング

### 13.2 コード内ドキュメント
- 全関数にdocstring記載
- 複雑なロジックにはインラインコメント追加
- 型ヒントの活用

## 14. コスト最適化

### 14.1 リソース最適化
- GCPリソースの自動スケーリング設定
- 不要なログの定期削除（週次）
- データ圧縮による保存容量削減

### 14.2 取引コスト削減
- 取引回数の質的向上（無駄な取引の削減）
- スリッページ最小化のための注文方法最適化

## 15. 将来的な展望

### 15.1 短期目標（3ヶ月以内）
- 現行システムの完全リファクタリング
- 安定稼働の実現
- 月次収益の黒字化

### 15.2 中期目標（6ヶ月以内）
- マルチタイムフレームに1時間足を追加（3軸構成）
- 特徴量の拡充とモデル精度向上
- 取引通貨ペアの拡大

### 15.3 長期目標（1年以内）
- 外部API統合（VIX、Fear&Greed Index、FR、OI等）
- 高度なポートフォリオ管理機能
- 自動最適化機能の実装

## 16. 成功指標

### 16.1 定量的指標
- **月間収益**: 17,000円以上（コスト回収）
- **勝率**: 55%以上
- **最大ドローダウン**: 20%以内
- **シャープレシオ**: 1.0以上

### 16.2 定性的指標
- システムの安定稼働（月間停止時間1時間以内）
- コードの保守性向上（新機能追加時間50%削減）
- エラー発生率の低減（前月比30%削減）

---

## 付録: 技術スタック

### 推奨技術
- **言語**: Python 3.9+
- **ML Framework**: scikit-learn, LightGBM
- **データ処理**: pandas, numpy
- **取引所API**: ccxt
- **監視**: Discord.py
- **テスト**: pytest
- **CI/CD**: GitHub Actions

### インフラ
- **実行環境**: GCP Compute Engine
- **データベース**: PostgreSQL or TimescaleDB
- **キャッシュ**: Redis（オプション）
- **監視**: Cloud Monitoring

---

*本要件定義書は、個人開発における暗号資産取引Botのリファクタリングプロジェクトの指針として作成されました。実装時は各フェーズの完了基準を明確にし、段階的に進めることを推奨します。*
