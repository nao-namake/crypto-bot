# 統合運用ガイド

**最終更新**: 2025年12月14日

**注**: 特徴量数・戦略数・システム設定は`config/core/feature_order.json`・`config/core/strategies.yaml`・`config/core/thresholds.yaml`を参照

## 📋 このファイルの目的

**対象読者**:
- **AI（Claude Code等）**: 自律的にデプロイ・検証を実行
- **開発者**: 手動実行時のリファレンス
- **運用担当者**: 日常監視・緊急対応のガイド

**使用場面**:
- **デプロイ前準備**: ML学習・パラメータ最適化・品質確認
- **ローカル検証**: ペーパートレード・バックテスト実行
- **本番デプロイ**: CI/CD実行・環境構築
- **日常運用**: 監視・メンテナンス・緊急対応

**ガイドの特徴**:
- ✅ **明確な手順**: 各ステップで実行コマンド・期待結果を明示
- ✅ **AI可読性**: コマンド・出力例・確認項目を構造化
- ✅ **実測値記載**: 実行時間・モデルサイズ等の実際の値を記載

---

# 第1部: デプロイ前準備

## 🚀 デプロイ前チェックリスト（必須実行順序）

### Step 1: ML学習実行（新機能開発後・定期再学習時必須）

#### 🎯 **標準ML学習コマンド**（推奨）

```bash
# ========================================
# Full モデル学習（デフォルト推奨）
# ========================================
python3 scripts/ml/create_ml_models.py \
  --n-classes 3 \
  --threshold 0.005 \
  --optimize \
  --n-trials 50

# 実行時間: 約4分（50 trials）
# 特徴量: feature_order.jsonに定義
# モデル: LightGBM・XGBoost・RandomForest アンサンブル
# 分類: 3クラス（SELL/HOLD/BUY）・閾値±0.5%
# 最適化: Optuna TPESampler・TimeSeriesSplit n_splits=5
```

#### 📊 **オプション一覧**（標準コマンドで全て有効）

| オプション | 説明 | 標準で有効 |
|-----------|------|----------|
| `--n-classes 3` | 3クラス分類（SELL/HOLD/BUY） | ✅ 推奨 |
| `--threshold 0.005` | 閾値±0.5%（ノイズ削減） | ✅ 推奨 |
| `--optimize` | Optunaハイパーパラメータ最適化 | ✅ 推奨 |
| `--n-trials 50` | 最適化試行回数（コスパ最良） | ✅ 推奨 |

**補足**:
- 実データ学習: デフォルトで有効
- 定期再学習: 週次（日曜18:00 JST）自動実行
- 手動再学習タイミング: 新機能追加後・市況急変時

#### 🔍 **モデル学習完了後の確認**

```bash
# 1. モデルファイル保存確認
ls -lh models/production/ensemble_full.pkl
ls -lh models/production/ensemble_basic.pkl

# 2. メタデータ確認
cat models/production/production_model_metadata.json | python3 -m json.tool

# 期待出力:
# {
#   "model_type": "ProductionEnsemble",
#   "status": "production_ready",
#   "model_weights": {
#     "lightgbm": 0.4,
#     "xgboost": 0.4,
#     "random_forest": 0.2
#   }
# }

# 3. パフォーマンスメトリクス確認
cat models/production/production_model_metadata.json | jq '.performance_metrics'

# 4. 旧モデル自動バックアップ確認
ls -lt models/archive/ | head -3
```

#### ✅ **期待される学習結果**（実測値）

```bash
# ログ出力例（標準コマンド実行時・約4分）:
# 🚀 ML実データ学習システム開始
# ✅ 実データ読み込み完了
# 📊 3クラス分布: SELL/HOLD/BUY
# 📊 Train/Val/Test split: 70%/15%/15%
# 🔬 Optuna最適化開始（50試行・約3分）
#
# lightgbm: Test F1/CV F1/Best params
# xgboost: Test F1/CV F1/Best params
# random_forest: Test F1/CV F1/Best params
#
# ✅ アンサンブルモデル保存完了: models/production/ensemble_full.pkl
# ✅ メタデータ保存: production_model_metadata.json
# 🎉 ML学習完了 - 実取引準備完了
#
# 実行時間: 約4分（50 trials）
```

---

### Step 2: パラメータ最適化実行（デプロイ前推奨・約8時間）

#### 🎯 **ハイブリッド最適化概要**

**目的**: パラメータ自動最適化（戦略・ML統合・MLハイパーパラメータ）

**3段階最適化プロセス**:
- **Stage 1**: シミュレーションベース最適化（高速）
- **Stage 2**: 軽量バックテスト検証（上位候補・短期データ・サンプリング）
- **Stage 3**: 完全バックテスト検証（上位候補・長期データ・全データ）

**最適化パラメータ**: thresholds.yamlに定義

**期待効果**: 収益向上・シャープレシオ最大化

**実行時間**:
- 🚀 **ハイブリッド最適化**: 約8時間
- ⚡ **従来比**: 約40-60%短縮

**実行推奨タイミング**:
- ✅ デプロイ前（ML学習後・品質チェック前）
- ✅ 定期再最適化（四半期ごと）
- ✅ 市況急変時（取引パフォーマンス悪化時）

#### ⚙️ **実行コマンド**

```bash
# ========================================
# 🚀 ハイブリッド最適化（推奨・約8時間）
# ========================================
python3 scripts/optimization/run_phase40_optimization.py --all --use-hybrid-backtest

# DRY RUNモード（事前確認）
python3 scripts/optimization/run_phase40_optimization.py --all --use-hybrid-backtest --dry-run
```

**注意**:
- ⏰ 実行時間: 約8時間（夜間・週末推奨）
- 💾 自動バックアップ: thresholds.yaml自動バックアップ
- 🔄 中断・再開可能: チェックポイント機能利用
- 📋 詳細: `scripts/optimization/README.md` 参照

---

### Step 3: 品質チェック実行（必須・約80秒）

```bash
# 統一品質チェック実行
bash scripts/testing/checks.sh

# 期待結果:
# ✅ 全テスト成功
# ✅ カバレッジ達成
# ✅ flake8・black・isort通過
# ✅ MLモデル整合性確認（ensemble_full.pkl・ensemble_basic.pkl）
```

**役割**: ML学習・パラメータ最適化後のシステム全体の健全性確認

---

### Step 4: ペーパーテスト実行（安全性確認・5-10分）

```bash
# ペーパートレード起動
bash scripts/management/run_safe.sh local paper

# 確認項目（5-10分実行）:
# ✅ 特徴量生成成功（feature_order.jsonに定義）
# ✅ 戦略統合動作（strategies.yamlに定義）
# ✅ ML予測機能
# ✅ リスク管理システム
# ✅ Discord通知機能

# 停止
bash scripts/management/run_safe.sh stop
```

**役割**: 本番デプロイ前の実動作確認・各コンポーネント正常性確認

---

### Step 5: バックテスト実行（戦略検証・45分）

#### 📊 **データ存在確認（必須）**

```bash
# データ存在確認
wc -l src/backtest/data/historical/BTC_JPY_4h.csv
wc -l src/backtest/data/historical/BTC_JPY_15m.csv

# 十分なデータ行数があることを確認
```

#### 📥 **データ収集（データ不足時）**

```bash
# 過去180日データ収集
python src/backtest/scripts/collect_historical_csv.py --days 180

# 実行時間: 約5-10分（API制限による）
```

#### 🚀 **バックテスト実行**

```bash
# バックテスト実行
python main.py --mode backtest

# 確認項目:
# ✅ 過去データで戦略パフォーマンス検証
# ✅ リスク・リターン分析
# ✅ ドローダウン評価
# ✅ 取引頻度・勝率確認

# 結果確認
ls -t logs/backtest/*.log | head -1 | xargs cat
```

**役割**: 最適化後のパラメータが過去データで期待通りの性能を出すか検証

---

### Step 6: 最終品質確認（デプロイ直前・約80秒）

```bash
# デプロイ前最終確認
bash scripts/testing/checks.sh

# 期待結果:
# ✅ 全テスト成功
# ✅ カバレッジ維持
# ✅ MLモデル準備完了
```

---

### Step 7: コミット・プッシュ・デプロイ実行

```bash
# 変更内容確認・コミット
git add -A
git commit -m "feat: ML学習・パラメータ最適化・品質保証完了

🤖 Generated with [Claude Code](https://claude.ai/code)
Co-Authored-By: Claude <noreply@anthropic.com>"

# GitHub プッシュ（CI/CD自動実行）
git push origin main

# デプロイ状況確認
gh run list --limit 5
gh run view --log

# 期待結果:
# ✅ CI/CDパイプライン成功
# ✅ 全テスト自動実行通過
# ✅ Cloud Run自動デプロイ成功
```

---

# 第2部: ペーパーテスト詳細手順

## ペーパートレード完全検証フロー

**目的**: 本番デプロイ前の実動作確認・各コンポーネント正常性検証

```bash
# 1. 品質事前確認
bash scripts/testing/checks.sh

# 2. ペーパートレード起動
bash scripts/management/run_safe.sh local paper

# 3. 検証項目チェック（5-10分実行）
# ✅ MLモデル初期化: ProductionEnsemble読み込み成功
# ✅ 特徴量生成: feature_order.jsonに定義
# ✅ 戦略実行: strategies.yamlに定義
# ✅ ML予測: アンサンブル予測実行（thresholds.yamlに閾値定義）
# ✅ リスク管理: Kelly基準・ドローダウン制限・ポジションサイジング
# ✅ 取引機能: BUY/SELL/HOLD判定・TP/SL自動配置
# ✅ Discord通知: 3階層通知（Critical/Warning/Info）
# ✅ 統一設定: unified.yaml・thresholds.yaml設定適用

# 4. ログ確認（期待出力）
# [INFO] 🤖 MLモデル初期化成功: ProductionEnsemble
# [INFO] 📊 特徴量完全生成成功
# [INFO] 🎯 戦略統合判定: 信頼度XX%・シグナル=HOLD/BUY/SELL
# [INFO] 💰 ペーパーモード残高: unified.yamlに定義

# 5. 停止
bash scripts/management/run_safe.sh stop
```

---

# 第3部: 環境構築・初期セットアップ

## システム要件

- **Python**: 3.13
- **Node.js**: 18+（GitHub CLI用）
- **Docker**: 20.10+
- **Git**: 2.30+

## 権限要件

- **GCP**: Editor/Owner権限
- **GitHub**: Admin権限
- **Bitbank API**: 信用取引対応APIキー
- **Discord**: Webhook URL設定権限

## 初回セットアップ

```bash
# リポジトリクローン
git clone <repository-url>
cd crypto-bot

# 依存関係インストール
pip install -r requirements.txt

# 環境確認
python3 --version  # 3.13.x
gcloud --version
docker --version
gh --version
```

## GCP環境構築

```bash
# 自動環境構築（推奨）
bash scripts/deployment/setup_gcp_environment.sh --full

# 設定内容:
# - GCP Project ID設定
# - API有効化（Cloud Run・Artifact Registry・Secret Manager）
# - サービスアカウント作成・権限付与
# - Workload Identity設定（GitHub Actions用）
# - Secret Manager設定（Bitbank API・Discord Webhook）

# 環境検証
bash scripts/deployment/verify_gcp_setup.sh --full
```

---

# 第4部: ローカル開発環境

## 実行クイックリファレンス

### ペーパートレード実行

```bash
# 起動
bash scripts/management/run_safe.sh local paper

# 状況確認
bash scripts/management/run_safe.sh status

# 停止
bash scripts/management/run_safe.sh stop

# 強制停止（Discord通知が止まらない場合）
bash scripts/management/bot_manager.sh stop
```

### バックテスト実行

```bash
# 起動
python main.py --mode backtest

# 結果確認
ls -t src/backtest/logs/backtest_*.txt | head -1 | xargs cat
```

### 品質チェック

```bash
# 統一品質チェック（約80秒）
bash scripts/testing/checks.sh

# 期待: 全テスト成功・カバレッジ達成
```

## モード別実行

```bash
# ペーパーモード（推奨）
bash scripts/management/run_safe.sh local paper

# ライブモード（本番取引）
bash scripts/management/run_safe.sh local live

# バックテストモード
python main.py --mode backtest
```

## 初期残高設定変更

`config/core/unified.yaml`の`mode_balances`セクションを編集

```yaml
mode_balances:
  paper:
    initial_balance: 100000.0    # 10,000 → 100,000
  live:
    initial_balance: 100000.0
  backtest:
    initial_balance: 100000.0
```

**変更後**:
1. 品質チェック実行: `bash scripts/testing/checks.sh`
2. ペーパーテストで動作確認
3. 停止

## 戦略パラメータ変更

`config/core/thresholds.yaml`の`dynamic_confidence.strategies.*`セクションを編集

**注意事項**:
- 元値の±20%程度の変更に留める
- 品質チェック必須
- ペーパーテストで確認後、本番適用

---

# 第5部: デプロイメント

## CI/CDパイプライン

```bash
# ローカル品質チェック
bash scripts/testing/checks.sh

# コード変更プッシュ（CI/CD自動実行）
git add -A
git commit -m "feat: ML学習・パラメータ最適化完了"
git push origin main

# デプロイ状況確認
gh run list --limit 5
gh run view --log
```

## デプロイモード制御

```bash
# ペーパーモード（推奨）
gh secret set DEPLOY_MODE --body "paper"

# 本番モード
gh secret set DEPLOY_MODE --body "live"
```

---

# 第6部: 日常運用・監視

## 監視スクリプト（推奨）

### クイック診断

```bash
# 1. インフラ基盤診断（Cloud Run・Secret Manager・Container安定性）
bash scripts/monitoring/check_infrastructure.sh

# 2. Bot機能診断（55特徴量・6戦略・ML予測・Silent Failure検出）
bash scripts/monitoring/check_bot_functions.sh

# 終了コード:
#   0: 正常
#   1: 致命的問題 → emergency_fix.sh実行
#   2: 要注意 → 詳細診断推奨
#   3: 監視継続 → 軽微な問題
```

### 診断項目

| スクリプト | 診断対象 |
|-----------|---------|
| `check_infrastructure.sh` | Cloud Run稼働状況・Secret Manager権限・Container安定性・API接続 |
| `check_bot_functions.sh` | 55特徴量システム・Silent Failure・6戦略動作・ML予測・レジーム別TP/SL |

## 日常確認（毎日推奨）

```bash
# 品質チェック
bash scripts/testing/checks.sh

# インフラ診断
bash scripts/monitoring/check_infrastructure.sh

# Bot機能診断
bash scripts/monitoring/check_bot_functions.sh

# 本番環境確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1

# 最新ログ確認
gcloud logging read "resource.type=cloud_run_revision" --limit=10

# エラーログ確認
gcloud logging read 'resource.type="cloud_run_revision" AND severity>=WARNING' --limit=10
```

## Discord監視

- **Critical**: システム停止・緊急対応必要
- **Warning**: 残高不足・API異常等
- **Info**: 通常取引・システム状態

---

# 第7部: 緊急時対応

## 緊急対応スクリプト（推奨）

```bash
# インタラクティブメニュー
bash scripts/monitoring/emergency_fix.sh

# または問題タイプ指定
bash scripts/monitoring/emergency_fix.sh secret    # Secret Manager権限修正
bash scripts/monitoring/emergency_fix.sh silent    # Silent Failure修正
bash scripts/monitoring/emergency_fix.sh container # Container問題修正
bash scripts/monitoring/emergency_fix.sh discord   # Discord Webhook修復
bash scripts/monitoring/emergency_fix.sh ml        # ML予測システム再起動
bash scripts/monitoring/emergency_fix.sh full      # システム完全再起動（最終手段）
```

## 問題別対応早見表

| 問題 | コマンド | 説明 |
|------|---------|------|
| Secret Manager権限 | `emergency_fix.sh secret` | API認証失敗・権限欠如 |
| Silent Failure | `emergency_fix.sh silent` | シグナル生成後の注文実行停止 |
| Container問題 | `emergency_fix.sh container` | exit(1)頻発・メモリ不足 |
| Discord停止 | `emergency_fix.sh discord` | Webhook Token無効 |
| ML予測停止 | `emergency_fix.sh ml` | ProductionEnsemble動作停止 |
| 全体停止 | `emergency_fix.sh full` | 複数問題・原因不明 |

## Critical対応（5分以内）

**症状**: システム完全停止・データ損失

```bash
# 緊急対応スクリプト実行（推奨）
bash scripts/monitoring/emergency_fix.sh full

# または手動ロールバック
gh workflow run ci.yml --ref <安定版コミット>
gcloud run services update-traffic crypto-bot-service-prod \
  --to-revisions=<安定リビジョン>=100 \
  --region=asia-northeast1

# 緊急停止（最終手段）
gcloud run services update crypto-bot-service-prod \
  --min-instances=0 \
  --region=asia-northeast1
```

## 主なトラブルシューティング

### Discord通知が止まらない

```bash
# 強制停止
bash scripts/management/bot_manager.sh stop

# 停止確認
bash scripts/management/run_safe.sh status
```

### プロセス重複エラー

```bash
# 完全停止後、再実行
bash scripts/management/bot_manager.sh stop
bash scripts/management/run_safe.sh local paper
```

### ドローダウン状態リセット

```bash
# 状態ファイル削除
rm -f src/core/state/drawdown_state.json

# 再起動
bash scripts/management/run_safe.sh local paper
```

## 診断コマンド

```bash
# 品質診断
bash scripts/testing/checks.sh

# 環境診断
bash scripts/deployment/verify_gcp_setup.sh --full

# プロセス診断
bash scripts/management/run_safe.sh status
```

---

# 付録: 主要スクリプトリファレンス

## スクリプト一覧

```
scripts/
├── management/
│   ├── run_safe.sh           # 安全実行（プロセス管理）
│   ├── bot_manager.sh        # 強制停止（Discord問題解決）
│   └── run_backtest.sh       # バックテスト実行
├── monitoring/
│   ├── check_infrastructure.sh  # インフラ診断
│   ├── check_bot_functions.sh   # Bot機能診断
│   └── emergency_fix.sh         # 緊急対応
├── ml/
│   └── create_ml_models.py   # ML学習
├── optimization/
│   └── run_phase40_optimization.py  # パラメータ最適化
├── testing/
│   └── checks.sh             # 品質チェック
└── deployment/
    ├── setup_gcp_environment.sh     # GCP環境構築
    └── verify_gcp_setup.sh          # GCP環境検証
```

## 主要コマンド

### プロセス管理

```bash
# 起動
bash scripts/management/run_safe.sh local paper

# 停止
bash scripts/management/run_safe.sh stop

# 強制停止（Discord通知問題対応）
bash scripts/management/bot_manager.sh stop
```

### 品質チェック

```bash
# 統一品質チェック（1,282テスト・65%+カバレッジ）
bash scripts/testing/checks.sh
```

### ML学習・最適化

```bash
# ML学習（約4分・50 trials・55特徴量）
python3 scripts/ml/create_ml_models.py --n-classes 3 --threshold 0.005 --optimize --n-trials 50 --verbose

# パラメータ最適化（約8時間・67パラメータ・ハイブリッド最適化推奨）
python3 scripts/optimization/run_phase40_optimization.py --all --use-hybrid-backtest
```

### バックテスト実行

```bash
# バックテスト実行（本番と完全同一ロジック）
python main.py --mode backtest

# 実行内容:
# - 戦略シグナル事前計算（look-ahead bias防止）
# - TP/SLトリガー・決済ロジック実行
# - エントリー/エグジットペアリング・損益計算
# - matplotlib可視化（グラフ生成）
```

---

**📚 関連ドキュメント**:
- システム機能一覧: `docs/運用ガイド/システム機能一覧.md`
- システム要件定義: `docs/運用ガイド/システム要件定義.md`
- GCP運用ガイド: `docs/運用ガイド/GCP運用ガイド.md`
