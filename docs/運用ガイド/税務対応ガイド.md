# 税務対応ガイド

**最終更新**: 2025年12月14日

## 📋 このファイルの目的

**このファイルを読む人**:
- システムに確定申告データ作成を依頼するユーザー
- 確定申告データ作成を行うAI（Claude）

**このファイルで分かること**:
- 確定申告用データの作成手順（年間レポート・CSV出力）
- 税務計算ロジック（移動平均法・国税庁推奨方式）
- e-Tax申告の実務手順

**ルール**:
- 年間レポート生成・CSV出力コマンドを正確に実行
- 移動平均法による損益計算を遵守（実装: `tax/pnl_calculator.py`）
- 実装履歴は開発履歴ドキュメント参照

---

## 📅 年間スケジュール

### 対象期間
- **課税対象期間**: 2025年1月1日 〜 2025年12月31日
- **確定申告期限**: **2026年3月15日**

### 確定申告が必要なケース
- ✅ **年間利益が20万円以上**: 雑所得として確定申告が必要
- ✅ **年間損失**: 申告不要だが、損失繰越はできない（暗号資産の特性）

### 推奨スケジュール

| 時期 | タスク | 重要度 |
|------|--------|--------|
| **毎月末** | 月次サマリー確認（Discord通知） | 中 |
| **12月末** | 年末サマリー確認（Discord通知） | 高 |
| **1月上旬** | 年間レポート生成・CSV出力 | 高 |
| **1月中旬** | 国税庁e-Taxシステム入力 | 高 |
| **3月15日まで** | 確定申告提出 | 必須 |

---

## 🚀 基本操作（コマンドライン）

### 1. 年間レポート生成

```bash
# 2025年の税務レポート生成
python tax/scripts/generate_tax_report.py --year 2025

# 出力先: tax/tax_report_2025.txt（デフォルト）
```

**実行タイミング**: 1月上旬（年間取引完了後）

**確認項目**:
- ✅ 年間総損益
- ✅ 取引回数
- ✅ 勝率
- ✅ 最大利益/損失取引

### 2. 確定申告用CSV出力

```bash
# 2025年全期間の取引履歴をCSV出力（国税庁フォーマット）
python tax/scripts/export_trade_history.py \
  --start-date 2025-01-01 \
  --end-date 2025-12-31 \
  --output tax/trade_history_2025.csv
```

**実行タイミング**: 1月上旬（e-Tax入力前）

**出力形式**:
```csv
日時,取引種別,売買,数量(BTC),価格(円),手数料(円),損益(円),注文ID,備考
2025-01-15 10:30:45,entry,buy,0.001000,5000000,100,,order_123,Live limit注文
2025-01-15 14:20:30,exit,sell,0.001000,5100000,102,99798,order_456,TP発動
```

---

## 📊 確定申告実務手順

### Step 1: データ準備（1月上旬）

1. **年間レポート生成**
   ```bash
   python tax/scripts/generate_tax_report.py --year 2025
   ```
   - 出力: `tax/tax_report_2025.txt`

2. **CSV出力**
   ```bash
   python tax/scripts/export_trade_history.py \
     --start-date 2025-01-01 \
     --end-date 2025-12-31 \
     --output tax/trade_history_2025.csv
   ```
   - 出力: `tax/trade_history_2025.csv`

3. **データ検証**
   - `tax_report_2025.txt` を開いて年間総損益を確認
   - **年間総損益が20万円未満**: 確定申告不要
   - **年間総損益が20万円以上**: Step 2へ進む

### Step 2: 国税庁e-Taxシステム入力（1月中旬）

1. **e-Taxログイン**
   - URL: https://www.e-tax.nta.go.jp/
   - マイナンバーカード認証

2. **所得区分選択**
   - **雑所得（その他）** を選択
   - **取引所名**: bitbank（ビットバンク株式会社）
   - **取引種別**: 暗号資産取引

3. **年間総損益入力**
   - `tax_report_2025.txt` の「年間総損益」を転記
   - 例: `年間総損益: +350,000円` → 入力値 `350000`

4. **取引明細アップロード**
   - `tax/trade_history_2025.csv` をアップロード
   - または手動入力（取引数が少ない場合）

5. **必要経費入力**
   - 手数料合計は自動計算済み（CSV内に含まれる）
   - 追加経費がある場合は別途計上

### Step 3: 確定申告提出（1月中旬〜3月15日）

1. **申告内容確認**
   - 雑所得金額
   - 源泉徴収額（暗号資産は通常なし）
   - 控除額

2. **電子申告送信**
   - e-Taxシステムから送信
   - 受付番号を控える

3. **納税（利益がある場合）**
   - 納付期限: 3月15日
   - 納付方法: e-Tax振替・クレジットカード・銀行振込

---

## 💡 税務上の重要ポイント

### 移動平均法とは

暗号資産の損益計算方法（国税庁推奨）:

**エントリー時**:
```
総コスト = (保有数量 × 平均取得単価) + (新規数量 × 新規価格) + 手数料
保有数量 += 新規数量
平均取得単価 = 総コスト / 保有数量
```

**エグジット時**:
```
損益 = (売却価格 - 平均取得単価) × 売却数量 - 手数料
保有数量 -= 売却数量
```

**具体例**:
1. エントリー: 0.001 BTC @ 5,000,000円（手数料100円）
   - 平均取得単価 = (5,000,000 × 0.001 + 100) / 0.001 = 5,100,000円/BTC
2. エグジット: 0.001 BTC @ 5,200,000円（手数料104円）
   - 損益 = (5,200,000 - 5,100,000) × 0.001 - 104 = **99,896円**

### よくある質問

**Q1: 損失が出た場合も申告が必要ですか？**
- A: 年間損失の場合、確定申告は不要です。ただし、他の雑所得と相殺したい場合は申告推奨。

**Q2: 複数の取引所を使っている場合は？**
- A: 全取引所の損益を合算して申告します。本システムはbitbank専用なので、他取引所は別途計算が必要。

**Q3: 未実現損益（含み損益）は申告対象ですか？**
- A: 未実現損益は申告対象外です。実際に売却（エグジット）した取引のみが対象。

**Q4: TP/SL発動時の損益はどう計算されますか？**
- A: TP/SL発動時の損益も通常のエグジットと同様に自動計算されます。`trade_type`が`tp`または`sl`の取引を確認してください。

**Q5: 手数料はどう扱われますか？**
- A: 手数料はエントリー時は取得コストに加算、エグジット時は損益から控除されます。

**Q6: 年間20万円の判定は税引前ですか？**
- A: 税引前の利益（損益）で判定します。手数料控除後の純利益が20万円以上かで判断。

---

## 🔧 トラブルシューティング

### エラー: 取引データがありません

**症状**:
```
⚠️ 2025年の取引データがありません
```

**原因**:
- SQLiteデータベース（`tax/trade_history.db`）が空
- 指定期間に取引がない

**解決策**:
1. 取引が実際に行われているか確認
2. `ExecutionService`の取引記録機能が有効か確認
3. データベースファイルを確認:
   ```bash
   ls -lh tax/trade_history.db
   sqlite3 tax/trade_history.db "SELECT COUNT(*) FROM trades;"
   ```

### エラー: CSV形式エラー

**症状**: e-Taxでアップロード拒否される

**原因**: CSV形式が国税庁フォーマットに準拠していない

**解決策**:
1. `tax/trade_history_2025.csv` をExcelで開いて確認
2. 文字コード確認: UTF-8
3. 列数確認: 9列（日時、取引種別、売買、数量、価格、手数料、損益、注文ID、備考）
4. 再出力:
   ```bash
   python tax/scripts/export_trade_history.py \
     --start-date 2025-01-01 \
     --end-date 2025-12-31 \
     --output tax/trade_history_2025_new.csv
   ```

### データベースバックアップ

**推奨**: 定期的にバックアップを取る

```bash
# バックアップ作成
mkdir -p tax/backup
cp tax/trade_history.db tax/backup/trade_history_$(date +%Y%m%d).db

# バックアップ確認
ls -lh tax/backup/
```

---

## 📁 ファイル配置

```
tax/                              # 税務システムディレクトリ
├── README.md                     # 技術仕様
├── __init__.py                   # パッケージ初期化
├── trade_history.db              # SQLiteデータベース（.gitignore対象）
├── pnl_calculator.py             # 損益計算モジュール（移動平均法）
├── trade_history_recorder.py     # 取引履歴記録モジュール
└── scripts/                      # 税務スクリプト
    ├── README.md                 # スクリプト説明
    ├── export_trade_history.py   # CSV出力スクリプト
    └── generate_tax_report.py    # レポート生成スクリプト

# 生成ファイル（.gitignore対象）
tax/trade_history_2025.csv        # CSV出力
tax/tax_report_2025.txt           # レポート出力

docs/運用ガイド/
└── 税務対応ガイド.md             # このファイル
```

---

## 🔗 関連リンク

- **国税庁 暗号資産の税務**: https://www.nta.go.jp/publication/pamph/shotoku/kakuteishinkokukankei/kasoutuka/index.htm
- **e-Taxシステム**: https://www.e-tax.nta.go.jp/
- **bitbank税務サポート**: https://bitbank.cc/docs/tax-support/

---

## ✅ 年間チェックリスト

| 時期 | タスク | 完了 |
|------|--------|------|
| 12月末 | 年末サマリー確認 | ☐ |
| 1月上旬 | 年間レポート生成 | ☐ |
| 1月上旬 | CSV出力 | ☐ |
| 1月上旬 | 年間総損益確認（20万円判定） | ☐ |
| 1月中旬 | e-Tax入力開始 | ☐ |
| 2月中旬 | e-Tax申告内容確認 | ☐ |
| 3月上旬 | 確定申告送信 | ☐ |
| 3月15日 | 納税完了 | ☐ |

---

**⏰ 次回確定申告期限**: 2026年3月15日（2025年分）
**📚 実装詳細**: `docs/開発履歴/Phase_47-48.md`
