# システム要件定義書

**最終更新**: 2026年1月18日

## このドキュメントの役割

| 項目 | 内容 |
|------|------|
| **目的** | 判断基準・制約・仕様定義（WHY/WHAT/CONSTRAINTS） |
| **対象読者** | AI（Claude）・開発者・判断に迷った時の参照者 |
| **記載内容** | システムの目的、実装すべき要件、技術仕様、品質基準 |
| **使用頻度** | 開発時の仕様確認、新機能実装時の制約確認 |

**ルール**:
- 現在の確定仕様のみ記載（実装履歴は`docs/開発履歴/`参照）
- 判断基準として機能する内容に特化
- Claude（AI）が読んですぐ実装できる明確な記述

---

## 目次

1. [システムの目的・役割](#1-システムの目的役割)
2. [機能要件](#2-機能要件)
3. [非機能要件](#3-非機能要件)
4. [技術仕様](#4-技術仕様)
5. [システム制約](#5-システム制約)
6. [品質基準](#6-品質基準)

---

# 1. システムの目的・役割

## 1.1 プロジェクトアイデンティティ（絶対不変）

| 項目 | 仕様 | 理由 |
|------|------|------|
| **対象市場** | bitbank信用取引・BTC/JPY専用 | API統合・手数料体系・法規制対応の完全最適化 |
| **資金規模** | 1万円スタート → 最大50万円 | 個人投資家向け・段階的リスク管理 |
| **取引頻度** | 月100-200回・高頻度取引 | AI優位性活用・機会損失最小化 |
| **収益目標** | 月額運用コスト以上 | 持続可能運用・最低限ペイライン |
| **リスク管理** | 最大ドローダウン20%以内 | 資金保護最優先・破綻リスク排除 |

## 1.2 システムの存在意義

1. **人間では実現不可能**: 24時間監視・5分間隔判定・複数戦略統合・ML予測統合
2. **機会損失の排除**: 睡眠中・仕事中の取引機会を完全自動化で捕捉
3. **感情的判断の排除**: 数学的根拠（Kelly基準・ML信頼度）に基づく冷静な判断
4. **少額資金の効率化**: 1万円からでも機関投資家レベルの高度な取引戦略を実現

---

# 2. 機能要件

## 2.1 取引機能

### 基本仕様
| 項目 | 値 |
|------|-----|
| 取引所 | bitbank信用取引専用（BTC/JPY通貨ペア） |
| 最小取引単位 | 0.0001 BTC |
| 取引頻度 | 月100-200回の高頻度取引 |
| レバレッジ | 最大2倍（日本規制）・安全性重視で1倍運用推奨 |

### ポジションサイジング
- ML信頼度連動制限: 低信頼度3%・中信頼度5%・高信頼度10%の動的制御
- 最小ロット優先保証: 制限金額 < 最小ロット価値の場合、最小ロット（0.0001 BTC）を優先許可

### 利益確定・損切りシステム

**デフォルト設定**:
| 項目 | 値 |
|------|-----|
| テイクプロフィット（TP） | 0.9% |
| ストップロス（SL） | 0.7% |
| RR比 | 1.29:1 |

**レジーム別設定**:
| レジーム | 平日TP | 平日SL | 土日TP | 土日SL |
|---------|--------|--------|--------|--------|
| tight_range | 0.4% | 0.3% | 0.25% | 0.2% |
| normal_range | 0.6% | 0.4% | 0.4% | 0.25% |
| trending | 1.0% | 0.6% | 0.6% | 0.4% |
| high_volatility | - | - | - | - |

※ high_volatilityはエントリーなし（待機）
※ 土日は平日の62.5%に縮小（半年分CSV分析で土日ATRは平日の65%）

**特徴**:
- 個別TP/SL自動配置・エントリー毎に独立管理
- TP/SL注文自動配置: エントリー後即座にTP/SL stop注文配置
- 全戦略統一SL/TP: SignalBuilder統合による一貫したSL/TP計算
- **レジーム自動判定**: SignalBuilder内でMarketRegimeClassifierを呼び出し一元化（Phase 53.9）
- ハードコード完全排除: thresholds.yaml設定から取得

### 手数料最適化・取引頻度管理
- 完全指値オンリー実装: 100%指値注文によるコスト削減
- 不利価格戦略: 確実約定優先・約定率90-95%維持
- 柔軟クールダウン: 基本間隔・強トレンド時スキップ

### リスク管理高度化
- 適応型ATR倍率: ボラティリティ連動（低2.5x・通常2.0x・高1.5x）
- 15m ATR優先使用: エントリー時間軸に適したSL距離計算
- 最小SL距離保証: 最小距離保証・少額資金対応

---

## 2.2 AI取引戦略

### 戦略構成（6戦略統合）

**レンジ型戦略（3戦略）**:
| 戦略名 | 重み | 説明 |
|--------|------|------|
| ATRBased | 0.17 | ボラティリティベース平均回帰・BB Position + RSI reversal |
| BBReversal | 0.17 | ボリンジャーバンド反転戦略・上限/下限タッチ時の逆張り |
| DonchianChannel | 0.17 | ドンチャンチャネル・ブレイクアウト + リバーサル判定 |

**トレンド型戦略（3戦略）**:
| 戦略名 | 重み | 説明 |
|--------|------|------|
| ADXTrendStrength | 0.17 | ADXトレンド強度・市場レジーム分析 |
| StochasticReversal | 0.17 | ストキャスティクス反転戦略・過買/過売からの反転 |
| MACDEMACrossover | 0.15 | MACDクロスオーバー・EMAトレンド追従 |

### 動的戦略管理システム
- **Registry Pattern**: 戦略クラスの中央レジストリ管理・`@StrategyRegistry.register()`デコレータによる自動登録
- **Decorator Pattern**: 宣言的戦略登録・コード可読性向上
- **Facade Pattern**: StrategyLoaderによる複雑な初期化処理の隠蔽
- **拡張性**: 戦略追加・削除時の修正範囲を93%削減（27→2ファイル）
- **設定駆動**: strategies.yamlによる戦略有効化・優先度設定

### 戦略統合ロジック
- **レジーム別重み付け統合**: 市場レジームに応じて戦略の重みを動的変更
- 複数戦略の信頼度を重み付け合計して最終判定
- 柔軟な戦略管理: 戦略追加・削除が設定ファイル変更のみで完結

**注**: 2票ルール（consensus）は検証の結果、重み設定を無視する問題が判明し無効化。

---

## 2.3 機械学習システム

### アンサンブル構成（ProductionEnsemble）
| モデル | 重み |
|--------|------|
| LightGBM | 40% |
| XGBoost | 40% |
| RandomForest | 20% |

**特徴**:
- 固定重み平均方式（Stacking Meta-Learnerは検証の結果無効化）
- **RandomForest**: `n_jobs=1`（GCP Cloud Run gVisor環境互換性・クラッシュ防止）

### 特徴量構成（55特徴量）
- **Full（デフォルト）**: 55特徴量（ensemble_full.pkl）
- **Basic（フォールバック）**: 49特徴量（ensemble_basic.pkl・戦略シグナル除外）

**特徴量カテゴリ**:
| カテゴリ | 個数 | 主要特徴 |
|---------|------|---------|
| Basic | 2 | close, volume |
| Momentum | 6 | rsi_14, macd, stoch_k, stoch_d |
| Volatility | 5 | atr_14, bb_upper, bb_lower, bb_position |
| Trend | 2 | ema_20, ema_50 |
| Regime | 3 | adx_14, plus_di_14, minus_di_14 |
| Lag | 9 | close_lag_1/2/3, volume_lag_1/2/3 |
| Rolling | 5 | close_ma_10/20, close_std_5/10/20 |
| Interaction | 5 | rsi_x_atr, macd_x_volume |
| Time | 7 | hour, day_of_week, is_market_open_hour |
| Strategy Signals | 6 | 6戦略の実信号 |

### 4段階Graceful Degradation
1. **Level 0（Stacking）**: StackingEnsemble（55+21メタ特徴量）- **現在無効化**
2. **Level 1（デフォルト）**: ensemble_full.pkl（55特徴量）- **現在使用中**
3. **Level 2（フォールバック）**: ensemble_basic.pkl（49特徴量）
4. **Level 3（最終）**: DummyModel（全HOLDシグナル・システム継続動作保証）

**注**: Level 0（Stacking）は検証の結果、収益性が12-25%低いため無効化。

### ハイブリッドML統合
- 戦略70% + ML30%: 戦略シグナルとML予測の加重平均統合
- 3段階統合ロジック:
  - Stage 1 (信頼度 < 0.45): 戦略のみ採用
  - Stage 2 (0.45 ≤ 信頼度 < 0.60): 戦略70% + ML30%加重平均
  - Stage 3 (信頼度 ≥ 0.60): 一致時1.2倍ボーナス・不一致時0.7倍ペナルティ

### 学習プロセス
- 実データ学習: CSV実データ読み込み・過去180日分15分足データ
- 全体再学習: 毎回ゼロから学習（累積学習ではない）
- 3クラス分類: BUY/HOLD/SELL分類
- TimeSeriesSplit: Cross Validation
- SMOTE oversampling: クラス不均衡対応

---

## 2.4 リスク管理

### Kelly基準
- 最小取引数: 5取引（実用性重視）
- 初期取引保証: Kelly履歴不足時は0.0001 BTC固定取引
- 3つの値統合: 動的サイジング・Kelly基準・RiskManagerの最小値を採用

### 証拠金維持率管理
- Critical閾値: 80%（維持率80%未満で新規エントリー拒否）
- API直接取得: bitbank API `/user/margin/status`から実データ取得
- 予測ベース制御: 将来の維持率を予測してエントリー判断
- 追証完全防止: 維持率80%を下回る前にエントリー停止

### 段階的資金管理
- 最小残高警告: 3,000円未満で警告表示・システム停止はしない
- 継続稼働保証: 残高不足でも監視モードで稼働継続
- 段階的拡大: 1万円→10万円→50万円の資金拡大に完全対応

### 自動損切り
- 最大ドローダウン20%制限
- 連続損失制限（thresholds.yamlに定義）

---

# 3. 非機能要件

## 3.1 パフォーマンス
| 項目 | 値 |
|------|-----|
| 取引実行 | 15分足・4時間足の2軸マルチタイムフレーム構成 |
| 実行間隔 | 5分間隔（Cloud Run cron job） |
| 応答時間 | API呼び出し平均3秒以下 |

## 3.2 可用性
| 項目 | 値 |
|------|-----|
| 稼働時間 | 24時間365日自動稼働 |
| 稼働率目標 | 99% |
| 自動復旧 | エラー検知・ロールバック・段階的復旧機能 |

**プロセス管理**:
- ロックファイル管理: PIDベース重複起動完全防止
- シグナル制御: SIGTERM/SIGINT適切処理・グレースフルシャットダウン
- 環境自動判定: ローカル/GCP環境別実行制御
- タイムアウト管理: GCP環境15分自動終了・コスト最適化
- ペーパートレードスクリプト: scripts/management/run_paper.sh による実行

## 3.3 セキュリティ
- 認証管理: GCP Secret Manager・Workload Identity
- 通信暗号化: SSL/TLS必須・API証明書検証
- アクセス制御: 最小権限の原則・権限分離

## 3.4 監視・通知
- 週間レポート: 損益統計・グラフ自動送信（毎週月曜日 9:00 JST・GitHub Actions）
- 内容: 週間損益・累積損益・勝率・取引回数・最大ドローダウン
- グラフ: matplotlib損益曲線（日別・累積）
- 配信: Discord Webhook（Embed + 画像添付）

## 3.5 バックテスト・ライブモード分析
- TradeTracker統合: エントリー/エグジットペアリング・損益計算
- 可視化: matplotlib（エクイティカーブ・損益分布・ドローダウン・価格チャート）
- 信頼性100%: ライブモードと完全一致する動作保証
- 固定期間モード: 特定期間で固定（再現性重視・比較検証用）
- バックテスト標準分析: 84項目の固定指標・CI/ローカル結果自動取得
- ライブモード標準分析: 39項目の固定指標・bitbank API/GCPログ連携・MLモデル状態確認・稼働率90%目標

---

# 4. 技術仕様

## 4.1 開発言語・フレームワーク
| 項目 | 値 |
|------|-----|
| Python | **3.13** |
| 機械学習 | scikit-learn・LightGBM・XGBoost・imbalanced-learn（SMOTE） |
| データ処理 | pandas・numpy |
| API統合 | ccxt（bitbank）・Discord Webhook |
| レポート生成 | matplotlib・Pillow |
| 税務システム | SQLite・CSV出力（国税庁フォーマット） |

## 4.2 インフラ・運用
| 項目 | 値 |
|------|-----|
| 実行環境 | GCP Cloud Run（サーバーレス・1Gi・1CPU） |
| CI/CD | GitHub Actions・自動品質ゲート・段階的デプロイ |
| 監視 | Cloud Logging・週間レポート |
| 認証 | Secret Manager・Workload Identity |
| プロセス管理 | fcntl・PIDベース排他制御・run_safe.sh統一スクリプト |

## 4.3 設定管理（ハードコード完全排除）

**設定ファイル構造**:
```
config/
├── core/
│   ├── unified.yaml          # 統一設定ファイル（メイン）
│   ├── strategies.yaml       # 戦略管理（enabled・priority・weight）
│   ├── features.yaml         # 機能トグル管理
│   ├── thresholds.yaml       # 動的設定・TP/SL・ML統合閾値
│   └── feature_order.json    # 55特徴量定義・順序管理・単一真実源
└── infrastructure/
    └── gcp_config.yaml       # GCP環境設定
```

**設定優先順位**:
1. CLI引数（最優先）: `--mode live`
2. 環境変数: `MODE=live`
3. YAML設定（最後）: `mode: paper`

**Secret Manager管理仕様**:
- バージョン管理: 具体的バージョン番号使用必須（例: `bitbank-api-key:3`）
- 非推奨: `latest`使用（Cloud Run環境で解決失敗）
- 更新手順: Secret更新時は対応するワークフローファイル（ci.yml）も更新必須

---

# 5. システム制約

| 制約カテゴリ | 項目 | 設定値 | 理由 |
|------------|------|--------|------|
| **実行環境** | Python バージョン | **3.13** | 最新安定版 |
| **インフラ** | GCPプロジェクト | my-crypto-bot-project | 固定プロジェクトID |
| | Cloud Runリソース | 1Gi・1CPU | 最低限コスト設定 |
| | Cloud Run環境 | gVisor sandbox | セキュリティ分離・syscall制限 |
| | 月額コスト上限 | 700-900円 | 個人運用予算制約 |
| | リージョン | asia-northeast1 | 東京リージョン・低レイテンシ |
| **データ** | メイン時間軸 | 15分足 | エントリー判断 |
| | 補助時間軸 | 4時間足 | 上位トレンド把握 |
| | API制限 | レート制限対応 | bitbank API制約 |
| **資金** | 初期資金 | 1万円 | 少額スタート |
| | 最大資金 | 50万円 | 段階的拡大上限 |
| | 証拠金維持率 | 80%以上 | エントリー条件（Critical閾値） |
| | 最大ドローダウン | 20% | 資金保護制限 |
| | レバレッジ | 1-2倍 | 安全性重視 |
| **運用管理** | プロセス重複防止 | 必須 | PIDロックファイル制御 |
| | 週間レポート | 毎週月曜9時 | 自動統計送信 |
| | 実行方式 | run_safe.sh経由 | 直接実行非推奨 |
| **Git運用** | git add方式 | `git add .`（全体追加） | 未コミットファイル残存防止 |
| | 個別add禁止 | `git add <file>`禁止 | 修正漏れによる不具合防止 |
| | コミット前確認 | `git status`必須 | 未追跡ファイルの確認 |

---

# 6. 品質基準

## 6.1 テスト・品質保証
| 項目 | 値 |
|------|-----|
| テスト成功率 | 100%維持必須 |
| カバレッジ | 適切な水準を維持 |
| 実行時間 | 統一品質チェック2分以内 |
| CI/CD統合 | GitHub Actions自動品質ゲート・GCP Cloud Run自動デプロイ |

## 6.2 コード品質
- 静的解析: flake8・black・isort通過必須
- 型安全性: Protocol・dataclass・型注釈活用
- エラーハンドリング: カスタム例外・階層化処理・適切なログ
- 設定品質: ハードコード値完全排除・設定ファイル一元管理徹底

## 6.3 運用品質
- 段階的デプロイ: paper → live 2段階デプロイ
- 自動ロールバック: エラー検知時の安全な自動復旧
- ログ管理: JST時刻・構造化ログ・検索・分析対応

---

## 関連リンク

- 設定ファイル: `config/core/thresholds.yaml`・`config/core/strategies.yaml`
- 機能一覧: `docs/運用ガイド/システム機能一覧.md`（実装詳細）
- 開発履歴: `docs/開発履歴/`
- 開発計画: `docs/開発計画/ToDo.md`
