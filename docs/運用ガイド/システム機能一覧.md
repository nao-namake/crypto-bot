# システム機能一覧

**最終更新**: 2026年2月10日

## このドキュメントの役割

| 項目 | 内容 |
|------|------|
| **目的** | 実装済み機能のリファレンス（HOW/実装状況） |
| **対象読者** | 運用者・開発者・自分自身 |
| **記載内容** | 何が実装済みか、どのファイルにあるか、設定値は何か |
| **関連ドキュメント** | [システム要件定義.md](システム要件定義.md) - 判断基準・制約（WHY/WHAT） |

---

## 目次

1. [コア機能](#1-コア機能)
2. [取引実行機能](#2-取引実行機能)
3. [リスク管理機能](#3-リスク管理機能)
4. [ポジション管理機能](#4-ポジション管理機能)
5. [ML予測機能](#5-ml予測機能)
6. [戦略システム](#6-戦略システム)
7. [市場分析機能](#7-市場分析機能)
8. [データ管理機能](#8-データ管理機能)
9. [監視・レポート機能](#9-監視レポート機能)
10. [税務・確定申告機能](#10-税務確定申告機能)
11. [バックテスト機能](#11-バックテスト機能)
12. [運用スクリプト](#12-運用スクリプト)

---

## 1. コア機能

### 1.1 設定管理システム（3層設定体系）

**概要**: すべての設定をハードコード排除し、設定ファイルで一元管理

| 設定ファイル | 役割 | 主な設定項目 |
|-------------|------|-------------|
| `config/core/unified.yaml` | 基本設定 | 残高、実行間隔、API設定 |
| `config/core/thresholds.yaml` | 動的値・パラメータ | ML閾値、リスク設定、戦略パラメータ、レジーム閾値 |
| `config/core/features.yaml` | 機能トグル | 各機能のON/OFF |
| `config/core/feature_order.json` | 特徴量定義（Single Source of Truth） | 55特徴量リスト |
| `config/strategies.yaml` | 戦略定義 | 6戦略の有効化・重み・優先度 |

**実装ファイル**: `src/core/config/threshold_manager.py`

**使用パターン**:
```python
from src.core.config.threshold_manager import get_threshold
sl_rate = get_threshold("risk.sl_min_distance_ratio", 0.02)
```

---

### 1.2 実行モード（3モード対応）

**概要**: 同一ロジック基盤で3つの実行モードをサポート

| モード | 用途 | 特徴 |
|--------|------|------|
| **live** | 本番取引 | 実際の注文実行、Bitbank API使用 |
| **paper** | 仮想取引 | API呼び出しなし、ログ出力のみ |
| **backtest** | 検証 | 過去データ使用、高速実行 |

**実装ファイル**:
- `src/core/execution/live_trading_runner.py`
- `src/core/execution/paper_trading_runner.py`
- `src/core/execution/backtest_runner.py`

**設定**: `config/core/unified.yaml` → `mode_balances`

---

### 1.3 Graceful Shutdown

**概要**: シグナル（SIGINT/SIGTERM）を受けて正常終了

| 項目 | 値 |
|------|-----|
| タイムアウト | 30秒 |
| 対応シグナル | SIGINT（Ctrl+C）、SIGTERM（kill） |

**実装ファイル**: `src/core/services/graceful_shutdown_manager.py`

**設定**: `config/core/thresholds.yaml` → `services.graceful_shutdown.timeout_seconds`

---

## 2. 取引実行機能

### 2.1 完全指値オンリー

**概要**: すべての注文を指値で実行（成行注文なし）

| 項目 | 値 |
|------|-----|
| 年間コスト削減 | 約150,000円 |
| 約定率 | 90-95% |

**実装ファイル**: `src/trading/execution/order_strategy.py`

---

### 2.2 注文戦略決定

**概要**: ML信頼度・市場条件に基づいて最適注文方式を選択

**実装ファイル**: `src/trading/execution/order_strategy.py`

**設定**: `config/core/thresholds.yaml` → `order_execution`

---

### 2.3 ストップ注文管理（Phase 63 Bug 4改修）

**概要**: TP/SL注文の配置・管理・タイムアウト制御

| 項目 | 設定 |
|------|------|
| SL注文タイプ | stop_limit（逆指値指値）|
| スリッページバッファ | 0.2% |
| use_native_type | false（stop_limit使用）|
| タイムアウト | 300秒 |
| タイムアウト時 | fetch_order()でSL状態確認後、フォールバック判断（Phase 63 Bug 4） |

**Phase 63改修**: タイムアウト到達時、SL注文の実際の状態（closed/open/canceled）を確認してからフォールバック決済を判断。API一時エラー時は安全側（フォールバックしない）。二重決済リスクを解消。

**実装ファイル**: `src/trading/execution/stop_manager.py`

**設定**: `config/core/thresholds.yaml` → `position_management.stop_loss.order_type`

---

### 2.4 Maker戦略

**概要**: エントリー・TP決済でMaker約定（手数料0%）を実現

**Phase 62.19: 2026年2月2日手数料改定対応**

| 項目 | 手数料（改定後） |
|------|-----------------|
| エントリー（Maker） | 0%（無料）|
| TP決済（Maker） | 0%（無料）|
| SL決済（Taker） | 0.1% |
| **往復（TP時）** | **0%** |
| **往復（SL時）** | **0.1%** |

**改定前（〜2/1）**: Maker -0.02%（リベート）、Taker 0.12%

**年間削減効果**: Taker比で0.1%削減（取引量依存）

**実装ファイル**: `src/trading/execution/executor.py`

**設定**: `config/core/thresholds.yaml` → `maker_strategy`

---

## 3. リスク管理機能

### 3.1 Kelly基準ポジションサイジング

**概要**: 期待値最大化のための最適ポジションサイズ計算

**実装ファイル**: `src/trading/risk/kelly.py`

**設定**: `config/core/thresholds.yaml` → `kelly_criterion`

---

### 3.2 ドローダウン管理

**概要**: 連続損失・最大ドローダウン監視と取引制限

| 項目 | デフォルト値 |
|------|-------------|
| 最大ドローダウン比率 | 20% |
| 連続損失制限 | 8回 |
| クールダウン期間 | 6時間 |

**実装ファイル**: `src/trading/risk/drawdown.py`

**設定**: `config/core/thresholds.yaml` → `drawdown_manager`

**状態永続化**: `src/core/state/drawdown_state.json`（再起動後も状態維持）

---

### 3.3 証拠金維持率監視

**概要**: 証拠金維持率80%以上を確実遵守

| 項目 | 値 |
|------|-----|
| 最低維持率 | 80% |
| リトライ | 3回 |

**実装ファイル**: `src/trading/balance/monitor.py`

**設定**: `config/core/thresholds.yaml` → `margin`

---

### 3.4 異常検知

**概要**: 市場異常を検出して取引を制限

| 検出対象 |
|---------|
| スプレッド異常 |
| 価格スパイク |
| ボリュームスパイク |

**実装ファイル**: `src/trading/risk/anomaly.py`

---

## 4. ポジション管理機能

### 4.1 ポジション制限

**概要**: 複数の制限でリスクを管理

| 制限項目 | デフォルト値 |
|---------|-------------|
| 最大ポジション数 | 3 |
| 最大資金利用率 | 80% |
| 日次取引回数制限 | 50回 |

**実装ファイル**: `src/trading/position/limits.py`

**設定**: `config/core/thresholds.yaml` → `position_management`

---

### 4.2 クールダウン機能

**概要**: 過剰取引防止（トレンド発生時はスキップ可能）

| 項目 | デフォルト値 |
|------|-------------|
| クールダウン期間 | 5分 |
| トレンド時スキップ | 有効 |

**実装ファイル**: `src/trading/position/cooldown.py`

**設定**: `config/core/features.yaml` → `trading.cooldown`

---

### 4.3 孤児ポジション・孤児SLクリーンアップ

**概要**: ポジション決済後に残ったTP/SL注文を自動削除

**背景**: bitbankはOCO注文未対応のため、TP約定時にSL注文が残る

**機能**:
| 機能 | 説明 |
|------|------|
| 孤児TP/SLキャンセル | ポジション決済後の残存注文を削除 |
| 孤児SL候補記録 | キャンセル失敗時にファイルに記録 |
| 起動時クリーンアップ | 記録された孤児SLを起動時に再キャンセル |

**実装ファイル**:
- `src/trading/position/cleanup.py`
- `src/trading/execution/stop_manager.py`

**データファイル**: `data/orphan_sl_orders.json`

---

### 4.4 ポジション復元

**概要**: 起動時にbitbank APIからポジション状態を復元

**背景**: GCP Cloud Runの5分毎再起動でvirtual_positionsがリセットされる問題を解決

**実装ファイル**: `src/trading/execution/executor.py` → `restore_positions_from_api()`

**呼び出し元**: `src/core/execution/live_trading_runner.py`（ライブモード起動時）

---

### 4.5 TP/SL欠損自動復旧（Phase 62.20 → Phase 63 Bug 3改修）

**概要**: Atomic Entry完了後、10分後にTP/SL設置状態を自動検証し、欠損時は自動再構築

**背景**: APIエラー50062等でBot内部状態とbitbank実態が乖離した際、SL欠損が発生する問題を解決

| 処理 | 内容 |
|------|------|
| Step 1 | Atomic Entry完了後、pending_verificationsリストに登録（10分後） |
| Step 2 | メインサイクルで期限到来分を処理（`_process_pending_verifications()`） |
| Step 3 | bitbank APIでポジション存在確認（サイド一致のみでマッチング） |
| Step 4 | アクティブ注文からTP/SL存在確認（stop_limit対応） |
| Step 5 | 欠損があればtight_rangeのTP/SL幅で再構築 |

**Phase 63改修点**:
- asyncio.create_task廃止 → pending_verificationsリスト+メインサイクル処理方式に変更（Cloud Run再起動耐性向上）
- ポジション/注文マッチングをサイド一致のみに緩和（ポジション集約対応）
- SL検出にstop_limitタイプを追加

**実装ファイル**: `src/trading/execution/executor.py`
- `_schedule_tp_sl_verification()` - pending_verificationsに登録
- `_process_pending_verifications()` - メインサイクルで期限到来分を処理
- `_verify_and_rebuild_tp_sl()` - 実際の検証・再構築

**設定**: `config/core/thresholds.yaml` → `tp_sl_verification`

```yaml
tp_sl_verification:
  enabled: true              # TP/SL検証機能ON/OFF
  delay_seconds: 600         # 検証までの待機時間（10分・Phase 62.21で変更）
  rebuild_on_missing: true   # 欠損時に自動再構築
  default_regime: "tight_range"  # 再構築時のデフォルトレジーム
```

---

## 5. ML予測機能

### 5.1 3モデルアンサンブル（ProductionEnsemble）

**概要**: 3つのMLモデルを動的重み付けで統合（Phase 60.5）

| モデル | 基本重み | 特徴 |
|--------|----------|------|
| LightGBM | 40% | シード差別化、特徴量サンプリング |
| XGBoost | 40% | シード差別化、特徴量サンプリング |
| RandomForest | 20% | シード差別化、特徴量サンプリング |

**特徴**:
- 動的重み計算（予測確信度に基づく）
- シード差別化による多様性確保
- Stacking（Meta-Learner）は検証の結果無効化（収益性が12-25%低下のため）

**実装ファイル**: `src/ml/ensemble.py`

**設定**: `config/core/thresholds.yaml` → `ensemble`

---

### 5.2 4段階Graceful Degradation

**概要**: MLモデル障害時の自動フォールバック

| レベル | モデル | 特徴量数 | 状態 |
|--------|--------|---------|------|
| Level 0 | StackingEnsemble | 55 + 21メタ | **無効化**（stacking_enabled: false） |
| Level 1 | ensemble_full.pkl | 55 | **デフォルト使用** |
| Level 2 | ensemble_basic.pkl | 49 | フォールバック |
| Level 3 | DummyModel | 任意 | 最終手段（全HOLD） |

**注**: Level 0（Stacking）は検証の結果、収益性が低いため無効化。`stacking_enabled: true`で有効化可能。

**実装ファイル**:
- `src/core/orchestration/ml_loader.py`
- `src/core/orchestration/ml_fallback.py`

---

### 5.3 3クラス分類

**概要**: 真の3クラス分類（2クラスではない）

| クラス | 値 |
|--------|-----|
| sell | 0 |
| hold | 1 |
| buy | 2 |

**効果**: 精度向上

---

### 5.4 ML統合ロジック（3段階信頼度ベース）

**概要**: ML信頼度に応じて戦略との統合比率を変更

| 信頼度 | 統合方式 |
|--------|---------|
| < 0.45 | 戦略のみ |
| 0.45-0.60 | 加重平均（ML統合率20-50%） |
| >= 0.60 | ボーナス/ペナルティ適用 |

**設定**: `config/core/thresholds.yaml` → `ml.integration`

---

## 6. 戦略システム

### 6.1 Registry Pattern

**概要**: Decorator自動登録による戦略管理

**効果**: 戦略追加時の修正ファイル大幅削減

**実装ファイル**:
- `src/strategies/strategy_registry.py`
- `src/strategies/strategy_loader.py`

**使用方法**:
```python
@StrategyRegistry.register("my_strategy", "range")
class MyStrategy(BaseStrategy):
    ...
```

---

### 6.2 6戦略統合

**概要**: レンジ型4戦略 + トレンド型2戦略

| タイプ | 戦略名 | 概要 | 60日PF |
|--------|--------|------|--------|
| レンジ | ATRBased | ATR消尽率+RSI逆張り（主力戦略） | 1.16 |
| レンジ | BBReversal | ボリンジャーバンド乖離逆張り | 1.32 |
| レンジ | DonchianChannel | Donchianチャネル端部反転（赤字） | 0.85 |
| レンジ | StochasticReversal | Stochastic Divergence反転 | 1.25 |
| トレンド | ADXTrendStrength | ADX+DI/DIクロスオーバー | 1.01 |
| トレンド | MACDEMACrossover | MACD+EMA(20/50)クロス | 1.50 |

**戦略選択方式**: レジーム別重み付け統合（2票ルールは無効化）

**実装ファイル**: `src/strategies/implementations/`

**設定**:
- `config/strategies.yaml` - 戦略定義
- `config/core/thresholds.yaml` → `dynamic_strategy_selection.regime_strategy_mapping` - レジーム別重み

---

### 6.3 動的戦略選択

**概要**: 市場レジームに応じて戦略の重みを動的変更

**実装ファイル**: `src/core/services/dynamic_strategy_selector.py`

**設定**: `config/core/thresholds.yaml` → `dynamic_strategy_selection.regime_strategy_mapping`

---

## 7. 市場分析機能

### 7.1 市場レジーム分類（4段階）

**概要**: 市場状況を自動分類

| レジーム | 条件 | 戦略方針 |
|---------|------|---------|
| tight_range | BB幅<3% AND 価格変動<2% | レンジ戦略重視 |
| normal_range | BB幅<5% AND ADX<20 | バランス型 |
| trending | ADX>25 AND EMA傾き>1% | トレンド戦略重視 |
| high_volatility | ATR比>3% | 全戦略無効化（待機） |

**実装ファイル**: `src/core/services/market_regime_classifier.py`

**設定**: `config/core/thresholds.yaml` → `market_regime`

**Phase 61注記**: レジーム閾値は設定ファイル化済み（`get_threshold()`パターン）。Phase 61.1で閾値調整を試行したが失敗し、Phase 60オリジナル値にロールバック。

---

### 7.2 レジーム別動的TP/SL

**概要**: 市場レジームに応じてTP/SL値を自動調整

| レジーム | 平日TP | 平日SL | 土日TP | 土日SL |
|---------|--------|--------|--------|--------|
| tight_range | 0.4% | 0.4% | 0.25% | 0.25% |
| normal_range | 0.6% | 0.4% | 0.4% | 0.25% |
| trending | 1.0% | 0.6% | 0.6% | 0.4% |

**土日縮小根拠**: 半年分CSV分析で土日ATRは平日の65%

**実装ファイル**: `src/strategies/utils/strategy_utils.py`（SignalBuilder内で一元化）

**設定**: `config/core/thresholds.yaml` → `position_management.take_profit.regime_based`

---

### 7.3 固定金額TP（Phase 63.2: 累積手数料バグ修正）

**概要**: %ベースではなく、目標純利益（固定金額）を保証するTP価格を計算

| 項目 | 値 |
|------|-----|
| 目標純利益 | 500円 |
| 手数料計算 | 常にfallbackレート（Maker 0%）で個別計算 |
| fee_data | 参考値としてログ出力のみ（TP計算には未使用） |

**Phase 63.2修正**: bitbank APIの`unrealized_fee_amount`は集約ポジション全体の累積手数料を返すため、TP計算に使用すると目標500円が平均741円（+48%超過）に膨張する問題を修正。fee_dataの累積値を無視し、常にfallbackレート（0.0）で個別計算する方式に変更。

**計算式**:
```
必要含み益 = 目標純利益 + エントリー手数料 + 利息 + 決済手数料
TP価格 = エントリー価格 ± (必要含み益 / 数量)
```

**Maker 0%（2026/2/2〜）のため**: 手数料は実質0円
→ 必要含み益 = 目標純利益（500円）

**実装ファイル**:
- `src/strategies/utils/strategy_utils.py` → `calculate_fixed_amount_tp()`
- `src/trading/core/types.py` → `PositionFeeData`クラス
- `src/trading/execution/executor.py` → 手数料データ取得（参考値・ログ出力のみ）

**設定**: `config/core/thresholds.yaml` → `position_management.take_profit.fixed_amount`

```yaml
fixed_amount:
  enabled: true                     # 固定金額TPモード有効化
  target_net_profit: 500            # 目標純利益（円）
  include_entry_fee: true           # エントリー手数料を考慮
  include_exit_fee_rebate: true     # 決済手数料を考慮
  include_interest: true            # 利息を考慮
  fallback_entry_fee_rate: 0.0     # Phase 63.2: 常にこのレート使用（Maker 0%）
  fallback_exit_fee_rate: 0.0      # Phase 63.2: 常にこのレート使用（Maker 0%）
```

**後方互換性**: `enabled: false`で従来の%ベース計算に戻せる

---

### 7.3 マルチタイムフレーム

**概要**: 複数時間軸でトレンド・エントリー判断

| タイムフレーム | 用途 |
|---------------|------|
| 4時間足 | 長期トレンド判断 |
| 15分足 | エントリー・エグジット判断 |

**実装ファイル**: `src/data/data_pipeline.py`

**設定**: `config/core/unified.yaml` → `data.timeframes`

---

### 7.4 55特徴量システム

**概要**: 包括的な特徴量セット

| カテゴリ | 数 | 例 |
|---------|-----|-----|
| 基本テクニカル | 49 | RSI, MACD, ATR, BB, EMA, ADX等 |
| 戦略シグナル | 6 | 各戦略のbuy/hold/sellエンコード |

**実装ファイル**: `src/features/feature_generator.py`

**設定**: `config/core/feature_order.json`（Single Source of Truth）

---

## 8. データ管理機能

### 8.1 Bitbank API統合

**概要**: bitbank信用取引専用APIクライアント

| 機能 |
|------|
| 4時間足・15分足直接実装（ccxt制約回避） |
| 成行・指値・stop_limit注文 |
| 信用口座管理（維持率監視） |
| リトライ機構（指数バックオフ） |

**実装ファイル**: `src/data/bitbank_client.py`

---

### 8.2 データキャッシング（2段階）

**概要**: メモリ + ディスクの2段階キャッシュ

| 段階 | 方式 | 容量/保持期間 |
|------|------|--------------|
| メモリ | LRUキャッシュ | 500件、5分TTL |
| ディスク | gzip圧縮pickle | 90日保持 |

**実装ファイル**:
- `src/data/data_pipeline.py`
- `src/data/data_cache.py`

---

## 9. 監視・レポート機能

### 9.1 Discord通知システム

**概要**: 取引シグナル・システム状態・エラーをDiscord送信

| 項目 | 内容 |
|------|------|
| 通知削減 | 99%削減（300-1,500回/月 → 4回/月） |
| バッチ処理 | 複数通知を効率的に送信 |
| 日次サマリー | 取引結果の自動集計 |

**実装ファイル**: `src/core/reporting/discord_notifier.py`

**設定**: `config/core/thresholds.yaml` → `monitoring.discord`

---

### 9.2 構造化ログ

**概要**: JSON形式・JST対応・Discord通知統合

| 特徴 |
|------|
| JSTタイムゾーン |
| JSON形式出力 |
| 複数ログレベル（DEBUG/INFO/WARNING/ERROR/CRITICAL） |
| Discord通知統合 |
| ファイルローテーション |

**実装ファイル**: `src/core/logger.py`

---

## 10. 税務・確定申告機能

### 10.1 取引履歴記録

**概要**: SQLiteベースの取引履歴永続化

| 記録項目 |
|---------|
| timestamp, trade_type, side, amount, price, fee, pnl, order_id, slippage, expected_price |

**スリッページ分析機能**:
- エントリー時のスリッページ（実約定価格 - 期待価格）を記録
- 統計レポート出力（平均、最大、時間帯別）

**実装ファイル**: `tax/trade_history_recorder.py`

**データベース**: `tax/trade_history.db`

---

### 10.2 移動平均法損益計算

**概要**: 国税庁推奨方式での損益計算

| 出力 |
|------|
| 年間損益（total_pnl） |
| 月別サマリー |
| 勝率・最大利益・最大損失 |

**実装ファイル**: `tax/pnl_calculator.py`

---

### 10.3 CSV出力

**概要**: 確定申告用フォーマットでエクスポート

**効果**: 作業時間95%削減（10時間→30分）

---

## 11. バックテスト機能

### 11.1 高速バックテスト

**概要**: 最適化されたバックテスト実行

| 項目 | 値 |
|------|-----|
| 高速化 | 10倍（6-8時間→5-10分） |
| 最適化内容 | ログレベル変更、Discord無効化、APIモック化 |

**実装ファイル**: `src/core/execution/backtest_runner.py`

---

### 11.2 TradeTracker

**概要**: エントリー/エグジットペアリングと損益計算

| 機能 |
|------|
| 取引ペア追跡 |
| 累積損益（エクイティカーブ） |
| パフォーマンス指標（勝率、PF、最大DD、シャープレシオ） |

**実装ファイル**: `src/backtest/reporter.py`

---

### 11.3 バックテスト可視化

**概要**: matplotlib統合グラフ生成

| グラフ |
|--------|
| エクイティカーブ（時系列資産推移） |
| 損益分布ヒストグラム |
| 価格チャート（ローソク足+エントリー/エグジットマーカー） |
| ドローダウンチャート |

**実装ファイル**: `src/backtest/visualizer.py`

**出力先**: `src/backtest/logs/graphs/`

---

### 11.4 過去データ収集

**概要**: Bitbank Public APIから過去データをCSV形式で収集

**使用方法**:
```bash
# 日数指定
python src/backtest/scripts/collect_historical_csv.py --days 180

# 期間指定
python src/backtest/scripts/collect_historical_csv.py --start-date 2025-07-01 --end-date 2025-12-31
```

**出力先**: `src/backtest/data/historical/`

---

### 11.5 固定期間バックテスト

**概要**: 特定期間で固定したバックテスト（再現性重視）

| 項目 | 値 |
|------|-----|
| モード | 固定期間 / ローリングウィンドウ 切替可能 |
| 固定期間設定 | `thresholds.yaml` → `execution.backtest_use_fixed_dates` |

**実装ファイル**: `src/core/execution/backtest_runner.py`

**設定**: `config/core/thresholds.yaml` → `execution.backtest_start_date` / `execution.backtest_end_date`

---

### 11.6 Walk-Forward Validation

**概要**: 過学習排除のためのWalk-Forward検証（Phase 60.3）

| 項目 | 値 |
|------|-----|
| 訓練期間 | 90日 |
| テスト期間 | 30日 |
| 検証回数 | 3回 |

**実装ファイル**: `scripts/backtest/walk_forward_validation.py`

**CI統合**: `.github/workflows/walk_forward.yml`

---

## 12. 運用スクリプト

### 12.1 スクリプト構成（Phase 61版）

```
scripts/
├── analysis/               # 分析スクリプト
│   └── unified_strategy_analyzer.py  # 戦略パフォーマンス分析
├── backtest/               # バックテスト
│   ├── run_backtest.sh            # バックテスト実行
│   ├── standard_analysis.py       # 結果分析（84指標）
│   └── walk_forward_validation.py # Walk-Forward検証
├── deployment/             # デプロイメント
│   └── docker-entrypoint.sh       # コンテナ起動制御
├── live/                   # ライブモード分析
│   └── standard_analysis.py       # 標準分析（39指標）
├── management/             # Bot管理
│   └── run_paper.sh               # ペーパートレード実行
├── ml/                     # 機械学習
│   └── create_ml_models.py        # MLモデル学習（55特徴量）
└── testing/                # 品質保証
    ├── checks.sh                  # 品質チェック（12項目）
    └── validate_ml_models.py      # ML検証（8項目）
```

---

### 12.2 品質チェック（checks.sh）

**概要**: システム全体の品質チェック（12項目）

| # | チェック項目 |
|---|-------------|
| 1 | ディレクトリ構造確認 |
| 2 | Dockerfile整合性 |
| 3 | 特徴量数検証（55特徴量） |
| 4 | 戦略整合性（6戦略） |
| 5 | 設定ファイル整合性 |
| 6 | モデルファイル・メタデータ |
| 7 | ML検証（validate_ml_models.py --quick） |
| 8 | flake8 |
| 9 | isort |
| 10 | black |
| 11 | pytest（62%+カバレッジ） |
| 12 | 結果サマリー |

**使用方法**:
```bash
bash scripts/testing/checks.sh
```

**実行時間**: 約60秒

---

### 12.3 ML検証（validate_ml_models.py）

**概要**: MLモデルの整合性と品質を検証（8項目）

| # | 検証項目 | 説明 |
|---|----------|------|
| 1 | モデルファイル整合性 | ensemble_full/basic.pkl存在確認 |
| 2 | 特徴量数整合性 | feature_order.json vs metadata一致（55特徴量） |
| 3 | full/basicモデル差異 | MD5比較（異なることを確認） |
| 4 | 3クラス分類確認 | BUY/HOLD/SELLの3クラス出力確認 |
| 5 | 戦略信号整合性 | 有効戦略数(6)と戦略信号特徴量数の一致 |
| 6 | 予測分布検証 | 極端なクラス偏り（90%超）がないか |
| 7 | 信頼度統計 | 高信頼度(>60%)予測が十分あるか |
| 8 | Stackingモデル検証 | stacking_enabled=true時にモデル存在確認 |

**使用方法**:
```bash
# 軽量モード（CI向け・整合性のみ）
python3 scripts/testing/validate_ml_models.py --quick

# 全検証（実データ読み込み）
python3 scripts/testing/validate_ml_models.py
```

---

### 12.4 バックテスト標準分析

**概要**: バックテスト結果を84指標で分析

| カテゴリ | 指標数 |
|---------|--------|
| 基本指標 | 10 |
| 戦略別 | 36 |
| ML予測別 | 9 |
| 一致率 | 4 |
| レジーム別 | 12 |
| 時系列 | 6 |
| 改善示唆 | 8 |

**使用方法**:
```bash
# CI結果から取得
python3 scripts/backtest/standard_analysis.py --from-ci

# ローカル結果
python3 scripts/backtest/standard_analysis.py --local
```

---

### 12.5 ライブモード標準分析

**概要**: ライブモードの固定指標分析（45指標）

| カテゴリ | 指標数 | 主な内容 |
|---------|--------|---------|
| アカウント状態 | 5 | 証拠金維持率・残高・使用証拠金 |
| ポジション状態 | 5 | オープン数・未約定注文・ロスカット価格 |
| 取引履歴分析 | 12 | 取引数・勝率・損益・戦略別分析 |
| システム健全性 | 6 | API応答時間・エラー数・稼働状態 |
| TP/SL適切性 | 4 | 現在価格距離・設置状態 |
| 稼働率 | 3 | 稼働時間率・ダウンタイム |
| 孤児SL管理 | 4 | 検出数・処理結果・リトライ状況 |
| Maker戦略 | 6 | エントリーMaker成功/FB、TP Maker成功/FB、post_onlyキャンセル数 |
| スリッページ | 6 | 平均スリッページ、最大スリッページ、記録件数 |

**使用方法**:
```bash
# 基本（24時間分析）
python3 scripts/live/standard_analysis.py

# 期間指定
python3 scripts/live/standard_analysis.py --hours 48
```

---

## 付録: 設定ファイル早見表

| ファイル | パス |
|---------|------|
| 基本設定 | `config/core/unified.yaml` |
| 動的パラメータ | `config/core/thresholds.yaml` |
| 機能トグル | `config/core/features.yaml` |
| 特徴量定義 | `config/core/feature_order.json` |
| 戦略定義 | `config/strategies.yaml` |

---

## 付録: 主要実装ファイル一覧

| カテゴリ | ディレクトリ |
|---------|------------|
| コア・オーケストレーション | `src/core/orchestration/` |
| 設定管理 | `src/core/config/` |
| 実行エンジン | `src/core/execution/` |
| 取引実行 | `src/trading/execution/` |
| リスク管理 | `src/trading/risk/` |
| ポジション管理 | `src/trading/position/` |
| 残高監視 | `src/trading/balance/` |
| ML予測 | `src/ml/` |
| 戦略 | `src/strategies/` |
| 特徴量生成 | `src/features/` |
| データ管理 | `src/data/` |
| バックテスト | `src/backtest/` |
| 税務 | `tax/` |
| スクリプト | `scripts/` |
