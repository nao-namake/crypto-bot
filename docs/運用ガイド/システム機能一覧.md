# システム機能一覧

**最終更新**: 2025年12月23日

## このドキュメントの役割

| 項目 | 内容 |
|------|------|
| **目的** | 実装済み機能のリファレンス（HOW/実装状況） |
| **対象読者** | 運用者・開発者・自分自身 |
| **記載内容** | 何が実装済みか、どのファイルにあるか、設定値は何か |
| **関連ドキュメント** | [システム要件定義.md](システム要件定義.md) - 判断基準・制約（WHY/WHAT） |

---

## 目次

1. [コア機能](#1-コア機能)
2. [取引実行機能](#2-取引実行機能)
3. [リスク管理機能](#3-リスク管理機能)
4. [ポジション管理機能](#4-ポジション管理機能)
5. [ML予測機能](#5-ml予測機能)
6. [戦略システム](#6-戦略システム)
7. [市場分析機能](#7-市場分析機能)
8. [データ管理機能](#8-データ管理機能)
9. [監視・レポート機能](#9-監視レポート機能)
10. [税務・確定申告機能](#10-税務確定申告機能)
11. [バックテスト機能](#11-バックテスト機能)

---

## 1. コア機能

### 1.1 設定管理システム（3層設定体系）

**概要**: すべての設定をハードコード排除し、設定ファイルで一元管理

| 設定ファイル | 役割 | 主な設定項目 |
|-------------|------|-------------|
| `config/core/unified.yaml` | 基本設定 | 残高、実行間隔、API設定 |
| `config/core/thresholds.yaml` | 動的値・パラメータ | ML閾値、リスク設定、戦略パラメータ |
| `config/core/features.yaml` | 機能トグル | 各機能のON/OFF |
| `config/core/feature_order.json` | 特徴量定義（Single Source of Truth） | 55特徴量リスト |
| `config/strategies.yaml` | 戦略定義 | 6戦略の有効化・重み・優先度 |

**実装ファイル**: `src/core/config/threshold_manager.py`

**使用パターン**:
```python
from src.core.config.threshold_manager import get_threshold
sl_rate = get_threshold("risk.sl_min_distance_ratio", 0.02)
```

---

### 1.2 実行モード（3モード対応）

**概要**: 同一ロジック基盤で3つの実行モードをサポート

| モード | 用途 | 特徴 |
|--------|------|------|
| **live** | 本番取引 | 実際の注文実行、Bitbank API使用 |
| **paper** | 仮想取引 | API呼び出しなし、ログ出力のみ |
| **backtest** | 検証 | 過去データ使用、高速実行 |

**実装ファイル**:
- `src/core/execution/live_trading_runner.py`
- `src/core/execution/paper_trading_runner.py`
- `src/core/execution/backtest_runner.py`

**設定**: `config/core/unified.yaml` → `mode_balances`

---

### 1.3 Graceful Shutdown

**概要**: シグナル（SIGINT/SIGTERM）を受けて正常終了

| 項目 | 値 |
|------|-----|
| タイムアウト | 30秒 |
| 対応シグナル | SIGINT（Ctrl+C）、SIGTERM（kill） |

**実装ファイル**: `src/core/services/graceful_shutdown_manager.py`

**設定**: `config/core/thresholds.yaml` → `services.graceful_shutdown.timeout_seconds`

---

## 2. 取引実行機能

### 2.1 完全指値オンリー

**概要**: すべての注文を指値で実行（成行注文なし）

| 項目 | 値 |
|------|-----|
| 年間コスト削減 | 約150,000円 |
| 約定率 | 90-95% |

**実装ファイル**: `src/trading/execution/order_strategy.py`

---

### 2.2 注文戦略決定

**概要**: ML信頼度・市場条件に基づいて最適注文方式を選択

**実装ファイル**: `src/trading/execution/order_strategy.py`

**設定**: `config/core/thresholds.yaml` → `order_execution`

---

### 2.3 ストップ注文管理

**概要**: TP/SL注文の配置・管理

**実装ファイル**: `src/trading/execution/stop_manager.py`

---

## 3. リスク管理機能

### 3.1 Kelly基準ポジションサイジング

**概要**: 期待値最大化のための最適ポジションサイズ計算

**実装ファイル**: `src/trading/risk/kelly.py`

**設定**: `config/core/thresholds.yaml` → `kelly_criterion`

---

### 3.2 ドローダウン管理

**概要**: 連続損失・最大ドローダウン監視と取引制限

| 項目 | デフォルト値 |
|------|-------------|
| 最大ドローダウン比率 | 20% |
| 連続損失制限 | 8回 |
| クールダウン期間 | 6時間 |

**実装ファイル**: `src/trading/risk/drawdown.py`

**設定**: `config/core/thresholds.yaml` → `drawdown_manager`

**状態永続化**: `src/core/state/drawdown_state.json`（再起動後も状態維持）

---

### 3.3 証拠金維持率監視

**概要**: 証拠金維持率80%以上を確実遵守

| 項目 | 値 |
|------|-----|
| 最低維持率 | 80% |
| リトライ | 3回 |

**実装ファイル**: `src/trading/balance/monitor.py`

**設定**: `config/core/thresholds.yaml` → `margin`

---

### 3.4 異常検知

**概要**: 市場異常を検出して取引を制限

| 検出対象 |
|---------|
| スプレッド異常 |
| 価格スパイク |
| ボリュームスパイク |

**実装ファイル**: `src/trading/risk/anomaly.py`

---

## 4. ポジション管理機能

### 4.1 ポジション制限

**概要**: 複数の制限でリスクを管理

| 制限項目 | デフォルト値 |
|---------|-------------|
| 最大ポジション数 | 3 |
| 最大資金利用率 | 80% |
| 日次取引回数制限 | 50回 |

**実装ファイル**: `src/trading/position/limits.py`

**設定**: `config/core/thresholds.yaml` → `position_management`

---

### 4.2 クールダウン機能

**概要**: 過剰取引防止（トレンド発生時はスキップ可能）

| 項目 | デフォルト値 |
|------|-------------|
| クールダウン期間 | 5分 |
| トレンド時スキップ | 有効 |

**実装ファイル**: `src/trading/position/cooldown.py`

**設定**: `config/core/features.yaml` → `trading.cooldown`

---

### 4.3 孤児ポジションクリーンアップ

**概要**: ポジション決済後に残ったTP/SL注文を自動削除

**背景**: bitbankはOCO注文未対応のため、TP約定時にSL注文が残る

**実装ファイル**: `src/trading/position/cleanup.py`

---

### 4.4 ポジション復元（Phase 53.6）

**概要**: 起動時にbitbank APIからポジション状態を復元

**背景**: GCP Cloud Runの5分毎再起動でvirtual_positionsがリセットされる問題を解決

**実装ファイル**: `src/trading/execution/executor.py` → `restore_positions_from_api()`

**呼び出し元**: `src/core/execution/live_trading_runner.py`（ライブモード起動時）

---

## 5. ML予測機能

### 5.1 3モデルアンサンブル

**概要**: 3つのMLモデルを重み付け統合

| モデル | 重み |
|--------|------|
| LightGBM | 50% |
| XGBoost | 30% |
| RandomForest | 20% |

**実装ファイル**: `src/ml/ensemble.py`

**設定**: `config/core/thresholds.yaml` → `ensemble.weights`

---

### 5.2 2段階Graceful Degradation

**概要**: MLモデル障害時の自動フォールバック

| レベル | モデル | 特徴量数 |
|--------|--------|---------|
| Level 1 | ensemble_full.pkl | 55 |
| Level 2 | ensemble_basic.pkl | 49 |
| Level 3 | DummyModel | 任意（全hold） |

**実装ファイル**:
- `src/core/orchestration/ml_loader.py`
- `src/core/orchestration/ml_fallback.py`

---

### 5.3 3クラス分類

**概要**: 真の3クラス分類（2クラスではない）

| クラス | 値 |
|--------|-----|
| sell | 0 |
| hold | 1 |
| buy | 2 |

**効果**: F1スコア +9.7%改善

---

### 5.4 ML統合ロジック（3段階信頼度ベース）

**概要**: ML信頼度に応じて戦略との統合比率を変更

| 信頼度 | 統合方式 |
|--------|---------|
| < 0.45 | 戦略のみ |
| 0.45-0.60 | 加重平均（ML統合率20-50%） |
| >= 0.60 | ボーナス/ペナルティ適用 |

**設定**: `config/core/thresholds.yaml` → `ml.integration`

---

## 6. 戦略システム

### 6.1 Registry Pattern

**概要**: Decorator自動登録による戦略管理

**効果**: 戦略追加時の修正ファイル大幅削減

**実装ファイル**:
- `src/strategies/strategy_registry.py`
- `src/strategies/strategy_loader.py`

**使用方法**:
```python
@StrategyRegistry.register("my_strategy", "range")
class MyStrategy(BaseStrategy):
    ...
```

---

### 6.2 6戦略統合

**概要**: レンジ型3戦略 + トレンド型3戦略

| タイプ | 戦略名 | 概要 |
|--------|--------|------|
| レンジ | ATRBased | ATR+BBボリンジャーバンド逆張り |
| レンジ | DonchianChannel | Donchian高値安値ブレイクアウト |
| レンジ | BBReversal | ボリンジャーバンド乖離逆張り |
| トレンド | ADXTrendStrength | ADX+DI/DIクロスオーバー |
| トレンド | StochasticReversal | Stochastic Oscillator反転 |
| トレンド | MACDEMACrossover | MACD+EMA(20/50)クロス |

**実装ファイル**: `src/strategies/implementations/`

**設定**: `config/strategies.yaml`

---

### 6.3 動的戦略選択

**概要**: 市場レジームに応じて戦略の重みを動的変更

**実装ファイル**: `src/core/services/dynamic_strategy_selector.py`

**設定**: `config/core/thresholds.yaml` → `dynamic_strategy_selection.regime_strategy_mapping`

---

## 7. 市場分析機能

### 7.1 市場レジーム分類（4段階）

**概要**: 市場状況を自動分類

| レジーム | 条件 | 戦略方針 |
|---------|------|---------|
| tight_range | BB幅<3% AND 価格変動<2% | レンジ戦略重視 |
| normal_range | BB幅<5% AND ADX<20 | バランス型 |
| trending | ADX>25 AND EMA傾き>1% | トレンド戦略重視 |
| high_volatility | ATR比>3% | 全戦略無効化（待機） |

**実装ファイル**: `src/core/services/market_regime_classifier.py`

**設定**: `config/core/thresholds.yaml` → `market_regime`

---

### 7.2 レジーム別動的TP/SL（Phase 52.0/53.9）

**概要**: 市場レジームに応じてTP/SL値を自動調整

| レジーム | TP | SL | RR比 |
|---------|-----|-----|------|
| tight_range | 0.8% | 0.6% | 1.33:1 |
| normal_range | 1.0% | 0.7% | 1.43:1 |
| trending | 1.5% | 1.0% | 1.50:1 |

**実装ファイル**: `src/strategies/utils/strategy_utils.py`（SignalBuilder内で一元化）

**設定**: `config/core/thresholds.yaml` → `position_management.take_profit.regime_based`

---

### 7.3 マルチタイムフレーム

**概要**: 複数時間軸でトレンド・エントリー判断

| タイムフレーム | 用途 |
|---------------|------|
| 4時間足 | 長期トレンド判断 |
| 15分足 | エントリー・エグジット判断 |

**実装ファイル**: `src/data/data_pipeline.py`

**設定**: `config/core/unified.yaml` → `data.timeframes`

---

### 7.4 55特徴量システム

**概要**: 包括的な特徴量セット

| カテゴリ | 数 | 例 |
|---------|-----|-----|
| 基本テクニカル | 49 | RSI, MACD, ATR, BB, EMA, ADX等 |
| 戦略シグナル | 6 | 各戦略のbuy/hold/sellエンコード |

**実装ファイル**: `src/features/feature_generator.py`

**設定**: `config/core/feature_order.json`（Single Source of Truth）

---

## 8. データ管理機能

### 8.1 Bitbank API統合

**概要**: bitbank信用取引専用APIクライアント

| 機能 |
|------|
| 4時間足・15分足直接実装（ccxt制約回避） |
| 成行・指値・stop_limit注文 |
| 信用口座管理（維持率監視） |
| リトライ機構（指数バックオフ） |

**実装ファイル**: `src/data/bitbank_client.py`

---

### 8.2 データキャッシング（2段階）

**概要**: メモリ + ディスクの2段階キャッシュ

| 段階 | 方式 | 容量/保持期間 |
|------|------|--------------|
| メモリ | LRUキャッシュ | 500件、5分TTL |
| ディスク | gzip圧縮pickle | 90日保持 |

**実装ファイル**:
- `src/data/data_pipeline.py`
- `src/data/data_cache.py`

---

## 9. 監視・レポート機能

### 9.1 Discord週間レポート

**概要**: 週次で取引サマリーをDiscord送信

| 項目 | 内容 |
|------|------|
| 送信頻度 | 毎週月曜9:00 JST（4回/月） |
| 含まれる情報 | 週間損益、累積損益、勝率、取引回数、最大DD |
| 添付 | 損益曲線グラフ |

**実装ファイル**: `scripts/reports/weekly_report.py`

**設定**: `config/core/unified.yaml` → `reporting`

---

### 9.2 構造化ログ

**概要**: JSON形式・JST対応・Discord通知統合

| 特徴 |
|------|
| JSTタイムゾーン |
| JSON形式出力 |
| 複数ログレベル（DEBUG/INFO/WARNING/ERROR/CRITICAL） |
| Discord通知統合 |
| ファイルローテーション |

**実装ファイル**: `src/core/logger.py`

---

## 10. 税務・確定申告機能

### 10.1 取引履歴記録

**概要**: SQLiteベースの取引履歴永続化

| 記録項目 |
|---------|
| timestamp, trade_type, side, amount, price, fee, pnl, order_id |

**実装ファイル**: `tax/trade_history_recorder.py`

**データベース**: `tax/trade_history.db`

---

### 10.2 移動平均法損益計算

**概要**: 国税庁推奨方式での損益計算

| 出力 |
|------|
| 年間損益（total_pnl） |
| 月別サマリー |
| 勝率・最大利益・最大損失 |

**実装ファイル**: `tax/pnl_calculator.py`

---

### 10.3 CSV出力

**概要**: 確定申告用フォーマットでエクスポート

**効果**: 作業時間95%削減（10時間→30分）

---

## 11. バックテスト機能

### 11.1 高速バックテスト

**概要**: 最適化されたバックテスト実行

| 項目 | 値 |
|------|-----|
| 高速化 | 10倍（6-8時間→5-10分） |
| 最適化内容 | ログレベル変更、Discord無効化、APIモック化 |

**実装ファイル**: `src/core/execution/backtest_runner.py`

---

### 11.2 TradeTracker

**概要**: エントリー/エグジットペアリングと損益計算

| 機能 |
|------|
| 取引ペア追跡 |
| 累積損益（エクイティカーブ） |
| パフォーマンス指標（勝率、PF、最大DD、シャープレシオ） |

**実装ファイル**: `src/backtest/reporter.py`

---

### 11.3 バックテスト可視化

**概要**: matplotlib統合グラフ生成

| グラフ |
|--------|
| エクイティカーブ（時系列資産推移） |
| 損益分布ヒストグラム |
| 価格チャート（ローソク足+エントリー/エグジットマーカー） |
| ドローダウンチャート |

**実装ファイル**: `src/backtest/visualizer.py`

**出力先**: `src/backtest/logs/graphs/`

---

### 11.4 過去データ収集

**概要**: Bitbank Public APIから過去データをCSV形式で収集

**使用方法**:
```bash
python src/backtest/scripts/collect_historical_csv.py --days 180
```

**出力先**: `src/backtest/data/historical/`

---

## 付録: 設定ファイル早見表

| ファイル | パス |
|---------|------|
| 基本設定 | `config/core/unified.yaml` |
| 動的パラメータ | `config/core/thresholds.yaml` |
| 機能トグル | `config/core/features.yaml` |
| 特徴量定義 | `config/core/feature_order.json` |
| 戦略定義 | `config/strategies.yaml` |

---

## 付録: 主要実装ファイル一覧

| カテゴリ | ディレクトリ |
|---------|------------|
| コア・オーケストレーション | `src/core/orchestration/` |
| 設定管理 | `src/core/config/` |
| 実行エンジン | `src/core/execution/` |
| 取引実行 | `src/trading/execution/` |
| リスク管理 | `src/trading/risk/` |
| ポジション管理 | `src/trading/position/` |
| 残高監視 | `src/trading/balance/` |
| ML予測 | `src/ml/` |
| 戦略 | `src/strategies/` |
| 特徴量生成 | `src/features/` |
| データ管理 | `src/data/` |
| バックテスト | `src/backtest/` |
| 税務 | `tax/` |
| スクリプト | `scripts/` |
