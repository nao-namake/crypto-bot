# 暗号資産取引Bot 要件定義書（**Phase 18完了版**）

## 1. プロジェクト概要

**Phase 18完了時点**で、プロジェクト開発から8ヶ月が経過し、**bitbank信用取引専用**の個人向けAI自動取引システムとして完成しました。**618/620テスト成功（99.7%）・53.57%カバレッジ**の企業級品質保証体制を確立し、**統合システム完成・1,076行削減・重複コード完全排除**により、システム全体の保守性と効率性が大幅向上しました。

本システムは、**1万円の小額資金から開始し、成功すれば50万円に拡大する**現実的な個人トレーダー向けの自動取引システムです。**12個厳選特徴量**による効率的なML予測、**マルチタイムフレーム（15分足・4時間足）**による精度の高い分析、**ケリー基準**による科学的リスク管理を核としています。

**GCPメモリ1Gi・1CPU**の制約下でも高性能を発揮する最適化されたアーキテクチャにより、月額コスト2,000円以内での運用を実現し、個人開発と企業級品質の両立を達成しました。

## 2. 基本要件

### 2.1 取引対象・制約
- **取引所**: **bitbank信用取引専用**（現物取引は対象外）
- **通貨ペア**: BTC/JPY（信用取引）に特化
- **資金規模**: **初期1万円→成功時50万円**の段階的資金管理
- **開発体制**: 完全な個人開発（チーム開発なし）
- **リソース制約**: **GCP 1Gi・1CPU・月額2,000円以内**

### 2.2 システム要件
- **監視システム**: **Discord通知**による3階層アラート（Critical/Warning/Info）
- **取引頻度**: 月50〜150回（1日あたり2〜5回程度・質重視）
- **収益目標**: 月額GCPコスト（約2,000円）以上の利益確保
- **Bot種別**: **アンサンブル学習**による機械学習自動取引Bot
- **特徴量**: **12個厳選**による効率的予測（過学習防止・計算最適化）
- **外部API**: 基本的に不使用（安定性・コスト最適化優先）

## 3. アーキテクチャ設計

### 3.1 システム構造
- **レイヤード・アーキテクチャ**の採用
  - データ層：市場データの取得・保存
  - ビジネスロジック層：戦略実行・シグナル生成
  - API層：取引所との通信
- **モジュール間の疎結合設計**により依存関係を最小化
- **インターフェース**を用いた抽象化で拡張性を確保

### 3.2 ディレクトリ構造（Phase 18統合システム完成版）
```
crypto-bot/
├── src/              # 統合システム（18個README完備・618テスト99.7%・Phase 18統合完了）
│   ├── core/         # 基盤システム（orchestrator・ml_adapter・設定・例外処理）
│   ├── data/         # データ層（Bitbank API・パイプライン・キャッシュ）
│   ├── features/     # 特徴量（統合FeatureGenerator・テクニカル指標・異常検知）
│   ├── strategies/   # 戦略システム（4戦略統合・共通処理・シグナル生成）
│   ├── ml/          # 機械学習（ProductionEnsemble・アンサンブル統合）
│   ├── backtest/    # バックテスト（統合レポーター・エンジン・評価）
│   ├── trading/     # 取引実行（リスク管理・Kelly基準・実行制御）
│   └── monitoring/  # 監視（Discord通知・3階層アラート）
├── config/          # 階層化設定管理（core・production・infrastructure）
├── tests/          # テストコード（618テスト・53.57%カバレッジ）
├── scripts/        # 統合運用管理（CI/CD・品質チェック・分析）
└── docs/           # ドキュメント（18個README・開発計画）
```

## 4. 取引戦略（Phase 16-A実装完了）

### 4.1 **マルチタイムフレーム分析**
- **4時間足**: 上位トレンド判断・大局観把握
- **15分足**: エントリータイミング・精密分析
- **統合判定**: 上位・下位時間軸の一致性確認による高精度シグナル

### 4.2 **実装戦略（4戦略統合）**
- **戦略1: もちぽよアラート戦略**
  - EMA・MACD・ZigZag・RCI統合シグナル
  - トレンド転換点の精密検出
- **戦略2: ATR戦略** 
  - ボラティリティベースの動的ポジションサイジング
  - 外部API不使用・内部計算のみ
- **戦略3: フィボナッチ戦略**
  - リトレースメント・エクステンション活用
  - サポレジ精密判定
- **戦略4: アンサンブル機械学習**
  - **12個厳選特徴量**による予測
  - LightGBM・XGBoost・RandomForest統合
  - **スクリプト実行**による自動モデル更新

## 5. データ管理

### 5.1 データパイプライン
- 時系列データの効率的な保存・取得方法の実装
- バックテスト用と本番用のデータパイプライン分離
- データ品質チェック機能の実装

### 5.2 データ保存戦略
- **生データ**: 3ヶ月保存
- **集計データ**: 1年保存
- **キャッシング**: 頻繁にアクセスするデータのメモリキャッシュ検討

## 6. 機械学習パイプライン

### 6.1 モデル管理
- **特徴量エンジニアリング**の自動化フレームワーク構築
- **モデルバージョン管理**システムの実装
- **A/Bテスト機能**：新旧モデルの並行稼働と性能比較
- **性能劣化検知**：モデルパフォーマンスの継続的監視

### 6.2 特徴量設計
- バックテストによる性能検証後、段階的に特徴量を追加
- 各戦略から抽出される特徴量の標準化

## 7. **リスク管理（ケリー基準実装）**

### 7.1 **ケリー基準ポジションサイジング**
- **科学的資金管理**: Kelly Criterion式によるポジション計算
- **段階的資金拡大**: 1万円→10万円→50万円の慎重な成長戦略
- **最大ドローダウン**: 資金の20%を絶対上限
- **連続損失制御**: 連続5回損失で24時間自動停止

### 7.2 **bitbank信用取引リスク管理**
- **信用倍率制限**: **最大2倍レバレッジ**（bitbank仕様準拠・安全性重視）
- **強制決済回避**: 証拠金維持率150%以上維持
- **追証対策**: 自動損切り・リスク分散・レバレッジ上限2倍遵守

### 7.3 **異常検知・自動停止**
- **スプレッド異常**: 通常の3倍以上で取引停止
- **ボラティリティ**: ATR基準値の2倍超で制限
- **API遅延**: 3秒超過で注文キャンセル
- **システム障害**: Discord即時通知・手動介入待機

## 8. パフォーマンス要件

### 8.1 **GCP制約下での高性能実現**
- **リソース制約**: **GCP 1Gi メモリ・1CPU**での最適化設計
- **レイテンシー目標**: シグナル発生から注文まで3秒以内（API制約考慮）
- **データ処理**: **マルチタイムフレーム（15分足・4時間足）**の処理を15秒以内に完了

### 8.2 **個人開発最適化リソース管理**
- **メモリ使用量**: **最大1Gi以内**（GCP制約準拠）
- **CPU使用率**: 平均30%以下、ピーク時60%以下
- **処理対象**: **BTC/JPY信用取引専用**（シンプル化・効率化優先）

## 9. **監視・通知システム（Discord 3階層アラート）**

### 9.1 **Discord通知の3階層システム**
- **Critical**: 取引停止、大幅損失、システム障害（即時通知・個人開発者向け緊急対応）
- **Warning**: 異常スプレッド、API遅延、ML予測精度低下（5分以内通知）
- **Info**: 日次サマリー、取引実行通知、パフォーマンス報告（バッチ通知）

### 9.2 **個人向け監視システム**
- **Discord Embed形式**によるリッチ通知（Phase 17対応済み）
- **自動レポート生成**による取引結果分析
- **618/620テスト成功・53.57%カバレッジ**による品質保証監視

## 10. **テスト戦略（Phase 17完了品質保証）**

### 10.1 **企業級品質保証基準**
- **618/620テスト成功（99.7%）**: 高品質維持・回帰防止体制完成
- **53.57%カバレッジ**: 統合テスト強化・型安全性改善・目標50%クリア
- **統合バックテスト**: **12個厳選特徴量**による過去データ検証
- **CI/CD品質ゲート**: 並列化・キャッシュ改善・品質保証強化

### 10.2 **段階的本番移行**
- **ペーパートレード**: **1万円仮想資金**での長期検証
- **小額実運用**: **1万円実資金**で慎重スタート
- **段階的拡大**: 成功時に**50万円まで段階的資金投入**

## 11. **設定管理（階層化設定・GCP統合）**

### 11.1 **Phase 16-A設定システム**
- **階層化YAML設定**: core/base.yaml・production/production.yaml
- **GCP Secret Manager**: bitbank API認証・Discord Webhook安全管理
- **環境別設定**: paper/stage-10/stage-50/live モード対応
- **thresholds.yaml**: 信頼度閾値・リスク管理パラメータ統一管理

### 11.2 **個人開発セキュリティ**
- **Secret Manager統合**: APIキー・認証情報の安全な外部管理
- **GitHub Secrets**: CI/CD環境変数の暗号化保存
- **Workload Identity**: キーファイル不要の安全なGCP認証

## 12. **段階的デプロイ戦略（Phase 16-A完成版）**

### 12.1 **現実的な2段階デプロイシステム**
- **paper**: ペーパートレード（仮想取引・安全テスト・無限期検証）
- **live (prod)**: 本番モード（実資金投入・24時間稼働・Discord監視）

### 12.2 **慎重な資金管理戦略**
- **初期資金**: 1万円からの小規模スタート（リスク最小化）
- **paperモード**: 長期間の仮想取引で十分な実績確認
- **live移行**: paperでの継続的な利益確認後に慎重に移行
- **段階的拡大**: 1万円→成功時に10万円→最終目標50万円
- **リスク管理**: Kelly基準・最大ドローダウン20%制限・自動停止機能

### 12.3 **Phase 16-A完了実績**
- ✅ **619テスト実装**: 100%合格・品質保証完成
- ✅ **54.92%カバレッジ**: 統合テスト強化・型安全性改善
- ✅ **CI/CD統合**: 自動品質ゲート・段階的デプロイ対応
- ✅ **GCP最適化**: 1Gi・1CPU制約下での高性能実現

## 13. **ドキュメント化（Phase 16-A完成版）**

### 13.1 **18個README完備体制**
- **各層README**: src/全層（data, features, strategies, ml, backtest, trading, monitoring）
- **運用README**: scripts/全フォルダ（management, testing, analytics, ml, deployment）
- **設定README**: config/全フォルダ（core, infrastructure, production）
- **統合ナビゲーション**: logs/reports/INDEX.md・ビジュアルファイル案内

### 13.2 **Phase 16-A品質保証文書**
- **型安全性改善**: MyPy統合・型ヒント完備・段階的型エラー解消
- **統合テスト強化**: 619テスト・54.92%カバレッジ・企業級品質保証
- **CI/CD文書**: 自動品質ゲート・段階的デプロイ・監視統合
- **運用マニュアル**: 24時間監視・自動復旧・Discord通知システム

## 14. **コスト最適化（個人開発最適化）**

### 14.1 **GCPコスト効率化（月額2,000円以内）**
- **Cloud Run最適化**: 1Gi・1CPU・段階的スケーリング
- **自動クリーンアップ**: 月次実行・古いDockerイメージ削除・ログ最適化
- **リソース監視**: Cloud Monitoring・コスト追跡・最適化提案
- **段階的投入**: paper→stage-10→stage-50→liveでリスク・コスト最小化

### 14.2 **取引効率化（質重視）**
- **65%信頼度閾値**: 高品質シグナルに絞った効率的取引
- **12個厳選特徴量**: 計算効率化・予測精度向上・処理速度最適化
- **Kelly基準**: 科学的ポジションサイジングによる資本効率最大化
- **取引頻度最適化**: 月50-150回・質重視・無駄な取引排除

## 15. **将来的な展望（Phase 18完了以降計画）**

### 15.1 **Phase 19: 運用監視・可観測性強化（1-2ヶ月）**
- **ヘルスチェック拡張**: システムパフォーマンス監視・リソース使用状況追跡
- **ログ分析自動化**: 取引履歴分析・パターン検出・異常検知システム
- **Discord監視統合**: リアルタイム通知・統合ダッシュボード・可視化強化
- **パフォーマンス可視化**: 取引成績・リスク指標・収益性分析

### 15.2 **Phase 20: セキュリティ・型システム完成（2-3ヶ月）**
- **残り型エラー段階的解消**: MyPy完全対応・型安全性100%達成
- **セキュリティ強化**: 認証・暗号化・脆弱性対策・セキュリティ監査
- **長期運用体制**: 自動メンテナンス・バックアップ・モデル更新自動化

### 15.3 **Phase 21: 高度機能拡張（3-6ヶ月）**
- **3軸マルチタイムフレーム**: 15分・1時間・4時間足統合分析
- **機械学習高度化**: AutoML統合・Model Drift Detection実装
- **収益最大化**: Kelly基準高度化・リスクパリティ最適化

## 16. **成功指標（Phase 18完了版）**

### 16.1 **Phase 18統合システム完成実績**
- ✅ **618/620テスト成功（99.7%）**: 企業級品質保証継続（目標: 95%以上 ✅）
- ✅ **53.57%カバレッジ**: 統合テスト強化維持（目標: 50%以上 ✅）
- ✅ **1,076行削減**: ファイル統合完成・コード効率化（目標: 重複排除 ✅）
- ✅ **5ファイル統合**: backtest/3ファイル・features/2ファイル削除（目標: 統合管理 ✅）
- ✅ **後方互換性維持**: エイリアス機能・既存コード影響ゼロ（目標: 安全統合 ✅）

### 16.2 **現実的収益目標（個人開発ベース）**
- **初期目標**: 月額2,000円（GCPコスト）以上の利益確保
- **中期目標**: 10%→50%→100%段階的資金拡大成功
- **長期目標**: 1万円→50万円資金達成（成功時）
- **リスク管理**: 最大ドローダウン20%以内・連続损失5回で自動停止

### 16.3 **品質保証継続目標**
- **システム安定性**: 24時間連続稼働・月間ダウンタイム1時間以内
- **コード品質**: MyPy型エラー段階的解消・新機能追加時の品質維持
- **運用効率**: 手動作楥80%削減・自動化システムによる継続改善

---

## 付録: 技術スタック

### 推奨技術
- **言語**: Python 3.9+
- **ML Framework**: scikit-learn, LightGBM
- **データ処理**: pandas, numpy
- **取引所API**: ccxt
- **監視**: Discord.py
- **テスト**: pytest
- **CI/CD**: GitHub Actions

### インフラ
- **実行環境**: GCP Compute Engine
- **データベース**: PostgreSQL or TimescaleDB
- **キャッシュ**: Redis（オプション）
- **監視**: Cloud Monitoring

---

## 📊 Phase 13完了実績（2025年8月22日現在）

### 🎯 目標達成状況
- ✅ **sklearn警告解消**: 全deprecation warning解消完了・最新ライブラリ対応・互換性確保
- ✅ **306テスト100%成功**: 品質保証完成・58.88%カバレッジ達成・回帰防止体制
- ✅ **logs/reports/統合**: ビジュアルナビゲーション・頻繁参照最適化・最新リンク対応
- ✅ **models/整理**: レガシー削除・ファイル管理ルール確立・品質基準明確化
- ✅ **CI/CD本番稼働**: GitHub Actions安定動作・品質ゲート完成・自動デプロイ
- ✅ **統合最適化**: 保守性向上・運用効率化・個人開発最適化と企業級品質の両立

### 📈 品質指標実績
- **テスト合格率**: 306テスト100%（目標: 95%以上 ✅）
- **sklearn警告**: 0件（目標: 0件 ✅）
- **CI/CD安定性**: GitHub Actions本番稼働（目標: 90%以上 ✅）
- **ログ統合**: ビジュアルナビゲーション完成（目標: 統合管理 ✅）
- **models整理**: レガシー削除・品質基準確立（目標: ファイル管理 ✅）

### 🚀 次期展望
**Phase 19以降**: 運用監視・可観測性強化・パフォーマンス最適化に向けて、Phase 18で確立した統合システム・コード削減・効率化基盤を基礎とした更なる運用品質向上を計画中

**Phase 18統合システム完成成果**:
- **ファイル統合完成**: backtest/3ファイル・features/2ファイル削除（計5ファイル・1,076行削減）
- **重複コード完全排除**: _handle_nan_values等の共通処理統一・薄いラッパー削除
- **統合レポーター**: CSV/HTML/JSON/Markdown/Discord報告機能統一・46%効率化
- **FeatureGenerator統合**: TechnicalIndicators・MarketAnomalyDetector・FeatureServiceAdapter統一
- **後方互換性維持**: エイリアス機能により既存コード影響ゼロ・安全な統合実現
- **品質保証継続**: 618/620テスト成功（99.7%）・53.57%カバレッジ・企業級品質維持

---

*本要件定義書（Phase 18完了版）は、個人開発における暗号資産取引Botの統合システム完成プロジェクトの指針として作成され、ファイル統合・重複コード完全排除・1,076行削減・後方互換性維持により当初の目標を達成しました。Phase 19以降の運用監視・可観測性強化に向けた統合システム基盤が完成しています。*
