# 要件定義書（迷った時の判断基準）

## 📋 このファイルの目的

**使用場面**:
- 開発・運用時に迷った時の判断基準
- システムの根本目的・制約の確認
- 機能要件・非機能要件の参照
- 成功指標・評価基準の把握

**ルール**:
- システムの根本要件・制約のみ記載
- Phase達成情報は記載しない（開発履歴ドキュメント参照）
- 判断基準として機能する内容に特化
- 定期的に要件の妥当性を検証

---

## 🎯 **システムの根本目的**（最重要・判断基準）

### **📋 プロジェクトアイデンティティ**
| 項目 | 仕様 | **絶対に変更不可な理由** |
|------|------|------|
| **🏦 対象市場** | bitbank信用取引・BTC/JPY専用 | **API統合・手数料体系・法規制対応の完全最適化** |
| **💰 資金規模** | 1万円スタート → 最大50万円 | **個人投資家向け・段階的リスク管理・資金効率最適化** |
| **📊 取引頻度** | 月100〜200回・高頻度取引 | **AI優位性活用・人間では不可能な頻度・機会損失最小化** |
| **🎯 収益目標** | 月額運用コスト（2,000円）以上 | **経済性確保・持続可能運用・最低限ペイライン** |
| **⚖️ リスク管理** | 最大ドローダウン20%以内 | **資金保護最優先・破綻リスク排除・継続運用確保** |

### **🎯 システムの存在意義**
1. **💡 人間では実現不可能**: 24時間監視・3分間隔判定・5戦略統合・ML予測統合
2. **📈 機会損失の排除**: 睡眠中・仕事中の取引機会を完全自動化で捕捉
3. **🧠 感情的判断の排除**: 数学的根拠（Kelly基準・ML信頼度）に基づく冷静な判断
4. **💰 少額資金の効率化**: 1万円からでも機関投資家レベルの高度な取引戦略を実現

---

## 📋 プロジェクト目的・対象

### 目的
bitbank信用取引専用のAI自動取引システムを開発し、1万円の少額資金から開始して段階的に拡大可能な個人向けトレーディングボットを実現する。

### 対象ユーザー
- 個人投資家・トレーダー
- 少額から自動取引を始めたい初心者〜中級者
- 24時間稼働による機会損失を防ぎたいユーザー

### 期待される成果
- 月額運用コスト（約2,000円）以上の利益確保
- 1万円から開始し、成功時50万円への段階的資金拡大
- 月100〜200回の高頻度取引による収益機会の最大化

---

## 🎯 機能要件

### 取引機能
- **取引所**: bitbank信用取引専用（BTC/JPY通貨ペア）
- **最小取引単位**: 0.0001 BTC（約1,700円相当・2025年9月調査確定）
- **価格基準**: 1 BTC = 約17,000,000 JPY（2025年9月現在）
- **取引頻度**: 月100〜200回の高頻度取引
- **資金管理**: 1万円スタート → 段階的拡大 → 最大50万円
- **レバレッジ**: 最大2倍（日本規制）・安全性重視で1倍運用推奨

**ポジションサイジング**:
- **ML信頼度連動取引制限**: 低信頼度3%・中信頼度5%・高信頼度10%の動的制御
- **最小ロット優先保証**: 制限金額 < 最小ロット価値の場合、最小ロット（0.0001 BTC）を優先許可

**利益確定・損切りシステム**:
- **テイクプロフィット/ストップロス**: 標準的な利益確定・損切りシステム・完全自動配置
- **リスクリワード比管理**: デフォルト1.5:1（TP 3%・SL 2%）・最小利益率3%・ATR倍率2.0による適応的決済
- **TP/SL注文自動配置**: エントリー後即座にTP/SL指値注文配置・注文ID追跡管理
- **全5戦略統一SL/TP**: SignalBuilder統合による一貫したSL/TP計算・戦略間差異解消
- **統合TP/SL実装**: 複数ポジション加重平均価格ベース・単一TP/SL注文配置・注文数91.7%削減
- **SL最悪位置保護**: ナンピン時に既存SLと比較し保護的なSL位置を維持・損失拡大防止（初期設定2%=200円を超えない）
- **トレーリングストップ**: Bybit/Binance準拠設計・2%含み益で発動・3%距離・最小0.5%利益ロック

**手数料最適化・取引頻度管理**:
- **完全指値オンリー実装**: 100%指値注文による徹底したコスト削減・メイカーリベート完全活用
- **不利価格戦略**: 確実約定優先（買注文: ask+0.05%・売注文: bid-0.05%）・約定率90-95%維持
- **手数料最適化効果**: 年間¥150,000削減（50万円運用時）・Taker 0.12% → Maker -0.02%（差分0.14%）
- **柔軟クールダウン**: 基本30分間隔・強トレンド時（強度>=0.7）スキップ・機会損失削減
- **取引頻度最適化**: 月100-200回目標達成・過剰取引防止

**リスク管理高度化**:
- **適応型ATR倍率**: ボラティリティ連動（低2.5x・通常2.0x・高1.5x）
- **15m ATR優先使用**: エントリー時間軸に適したSL距離計算・SL距離10%→2%改善
- **最小SL距離保証**: 1%最小距離・少額資金対応・小ボラティリティ環境保護

### AI取引戦略（5戦略統合）
1. **ATR戦略**: ボラティリティベースの動的ポジションサイジング
2. **もちぽよアラート戦略**: EMA・MACD・ZigZag・RCI統合シグナル
3. **マルチタイムフレーム戦略**: 複数時間軸統合判定
4. **Donchianチャネル戦略**: ブレイクアウト・リバーサル判定
5. **ADXトレンド戦略**: 方向性指標による市場レジーム分析

### 機械学習システム

**アンサンブル構成**（Phase 41.8完了）:
- **3モデル統合**: LightGBM（40%）+ XGBoost（40%）+ RandomForest（20%）
- **特徴量管理**: 55特徴量の統一管理・一元化（feature_order.json単一真実源・11カテゴリ分類）
  - **50基本特徴量**: 従来の特徴量生成システム
  - **5戦略信号特徴量**: ATRBased・MochipoyAlert・MultiTimeframe・DonchianChannel・ADXTrendStrength

**Strategy-Aware ML実装**（Phase 41.8完了）:
- **実戦略信号学習**: 訓練時に実際の戦略を実行して実戦略信号を生成・0-fill問題解決
- **訓練/推論一貫性**: 訓練データと推論データの特徴量構造を完全統一
- **Look-ahead bias防止**: `df.iloc[: i + 1]`による過去データのみ使用・未来データリーク防止
- **信号エンコーディング**: `action × confidence`方式（buy=+1.0、hold=0.0、sell=-1.0）
- **F1スコア**: 0.56-0.61達成（XGBoost 0.593、RandomForest 0.614、LightGBM 0.489）

**ハイブリッドML統合**（Phase 41.8.5最適化完了）:
- **戦略70% + ML30%**: 戦略シグナルとML予測の加重平均統合・真のハイブリッドMLbot
- **3段階統合ロジック**: 3クラス分類対応の最適化閾値設計
  - **Stage 1** (信頼度 < 0.45): 戦略のみ採用
  - **Stage 2** (0.45 ≤ 信頼度 < 0.60): 戦略70% + ML30%加重平均
  - **Stage 3** (信頼度 ≥ 0.60): 一致時1.2倍ボーナス・不一致時0.7倍ペナルティ
- **ML統合率100%達成**: Phase 41.8.5閾値最適化により10% → 100%改善
- **安全措置**: 統合後信頼度0.4未満時、自動hold変更・リスク回避
- **動的制御**: thresholds.yaml設定による運用中の重み調整対応

**学習データ・学習方式**（Phase 39.1-39.5完了）:
- **実データ学習**: CSV実データ読み込み・過去180日分15分足データ（17,271件）で学習
- **全体再学習**: 毎回ゼロから学習（累積学習ではない）・市場適応性確保
- **3クラス分類**: BUY/HOLD/SELL分類・閾値0.5%（ノイズ削減最適化）
- **Train/Val/Test分割**: 70/15/15比率・厳格な評価体系

**学習プロセス最適化**（Phase 39.3-39.5完了）:
- **TimeSeriesSplit**: n_splits=5による堅牢なCross Validation・時系列データ対応
- **Early Stopping**: rounds=20で過学習防止・LightGBM/XGBoost対応
- **SMOTE oversampling**: クラス不均衡対応・少数派クラス増強（imbalanced-learn）
- **class_weight='balanced'**: 全クラス公平学習・LightGBM/RandomForest対応
- **Optunaハイパーパラメータ最適化**: TPESampler・3モデル自動最適化・n_trials=50

**週次自動更新システム**:
- **更新頻度**: 毎週日曜18:00(JST)自動学習→品質検証→段階的本番デプロイ
- **安全な更新体制**: models/archive/自動バックアップ・ロールバック機能・品質ゲート
- **市場適応性**: 概念ドリフト対応・急変する仮想通貨市場への継続的最適化
- **信頼度判定**: ML信頼度35%閾値による取引機会拡大・月100-200回達成

### リスク管理
- **Kelly基準**: 数学的根拠に基づくポジションサイジング
  - **最小取引数**: 5取引（実用性重視・統計的妥当性確保）
  - **動的設定**: get_threshold()による運用中調整・ハードコード完全排除
  - **適用基準**: max_order_size 0.0005 BTC（1万円運用対応）
  - **初期取引保証**: Kelly履歴不足時（5取引未満）は0.0001 BTC固定取引・Silent Failure完全防止
  - **3つの値統合**: 動的サイジング・Kelly基準・RiskManager の最小値（min）を採用・保守的取引
- **段階的資金管理**: 継続取引優先・残高制約による停止回避
  - **最小残高警告**: 3,000円未満で警告表示・システム停止はしない
  - **継続稼働保証**: 残高不足でも監視モードで稼働継続・取引機能維持
  - **段階的拡大**: 1万円→10万円→50万円の資金拡大に完全対応
  - **初期運用対応**: 1,636円でもKelly固定取引（0.0001 BTC×5回）実行可能
- **証拠金維持率管理**: bitbank信用取引の追証リスク回避
  - **Critical閾値**: 100%（維持率100%未満で新規エントリー拒否）
  - **予測ベース制御**: 将来の維持率を予測してエントリー判断
  - **追証完全防止**: 維持率100%を下回る前にエントリー停止・既存ポジションは維持
- **3段階判定**: ML信頼度→リスクスコア→最終実行判定
- **自動損切り**: 最大ドローダウン20%制限・連続損失5回で自動停止
- **動的調整**: 市場状況・過去成績に応じたパラメータ自動調整

---

## ⚙️ 非機能要件

### パフォーマンス
- **取引実行**: 15分足・4時間足の2軸マルチタイムフレーム構成
- **応答時間**: API呼び出し平均3秒以下
- **取引精度**: 信頼度35%以上のシグナル実行・攻撃的設定

### 可用性
- **稼働時間**: 24時間365日自動稼働
- **稼働率**: 99.5%以上の高可用性
- **自動復旧**: エラー検知・ロールバック・段階的復旧機能
- **プロセス管理**: 重複起動防止・安全実行制御
  - **ロックファイル管理**: PIDベース重複起動完全防止
  - **シグナル制御**: SIGTERM/SIGINT適切処理・グレースフルシャットダウン
  - **環境自動判定**: ローカル/GCP環境別実行制御
  - **タイムアウト管理**: GCP環境15分自動終了・コスト最適化
  - **安全実行スクリプト**: scripts/management/run_safe.sh による統一実行

### セキュリティ
- **認証管理**: GCP Secret Manager・Workload Identity
- **通信暗号化**: SSL/TLS必須・API証明書検証
- **アクセス制御**: 最小権限の原則・権限分離

### 監視・通知
- **Discord通知**: 3階層アラート（Critical/Warning/Info）
- **Discord通知最適化**: バッチ処理・レート制限・コスト削減対応
  - **immediate通知**: Critical（残高異常等）の即時送信
  - **batch通知**: Warning（API制限等）の1時間毎集約送信
  - **daily通知**: Info（取引完了等）の日次サマリー送信
  - **レート制限**: 1時間最大12通知・最小5秒間隔制御
- **システム監視**: 15分間隔ヘルスチェック・パフォーマンス追跡
- **運用報告**: 日次・週次・月次レポート自動生成

---

## 🏗️ システム制約

### 重要な制約一覧

| 制約カテゴリ | 項目 | 設定値 | 理由 |
|------------|------|--------|------|
| **インフラ** | GCPプロジェクト | my-crypto-bot-project | 固定プロジェクトID |
| | Cloud Runリソース | 1Gi・1CPU | 最低限コスト設定 |
| | 月額コスト上限 | 2,000円以内 | 個人運用予算制約 |
| | リージョン | asia-northeast1 | 東京リージョン・低レイテンシ |
| **データ** | メイン時間軸 | 4時間足 | 上位トレンド把握 |
| | エントリー時間軸 | 15分足 | エントリータイミング判定 |
| | API制限 | 35秒間隔 | bitbank レート制限対応 |
| | ログ保持期間 | 30日間 | GCPコスト最適化 |
| **資金** | 初期資金 | 1万円 | 少額スタート |
| | 最大資金 | 50万円 | 段階的拡大上限 |
| | 最小残高警告 | 3,000円 | 警告のみ・停止しない |
| | Kelly初期取引 | 0.0001 BTC固定×5回 | 履歴不足時の確実実行 |
| | 最大ドローダウン | 20% | 資金保護制限 |
| | レバレッジ | 1〜2倍 | 安全性重視 |
| **運用管理** | プロセス重複防止 | 必須 | PIDロックファイル制御 |
| | Discord通知制限 | 1時間12件 | 従量課金最適化 |
| | 実行方式 | run_safe.sh経由 | 直接実行非推奨 |
| | GCPタイムアウト | 15分自動終了 | コスト制御・暴走防止 |

### サービスアカウント・権限

| 用途 | アカウント | 権限 |
|------|-----------|------|
| **CI/CD** | github-deployer@my-crypto-bot-project.iam.gserviceaccount.com | admin系権限多数 |
| **Workload Identity** | GitHub Actions認証 | 最小権限・セキュア認証 |
| **Secret Manager** | API キー管理・バージョン管理 | 暗号化保存・具体的バージョン番号（key:3,5）・`key:latest`非推奨 |

---

## 🛠️ 技術スタック

### 開発言語・フレームワーク
- **Python**: 3.13（メイン開発言語・MLライブラリ互換性最適化）
- **機械学習**: scikit-learn・LightGBM・XGBoost
- **ML最適化**（Phase 39完了）: imbalanced-learn（SMOTE）・Optuna（TPESampler）
- **データ処理**: pandas・numpy・タイムシリーズ最適化
- **API統合**: ccxt（bitbank）・Discord Webhook・bitbank margin status API（`/v1/user/margin/status`保証金維持率直接取得）

### インフラ・運用
- **実行環境**: GCP Cloud Run（サーバーレス）
- **CI/CD**: GitHub Actions・自動品質ゲート・段階的デプロイ
- **監視**: Cloud Logging・Discord統合通知
- **認証**: Secret Manager・Workload Identity
- **プロセス管理**: 重複起動防止・シグナル制御・安全実行システム
  - **ロックファイル**: fcntl・PIDベース排他制御
  - **実行制御**: scripts/management/run_safe.sh統一スクリプト
  - **環境判定**: ローカル/GCP自動切り替え・タイムアウト管理
- **通知最適化**: Discord バッチ処理・レート制限・コスト削減

### 設定管理（統一システム・ハードコード完全排除）
- **統一設定**: config/core/unified.yaml（全デフォルト値集約）
- **機能管理**: config/core/features.yaml（機能トグル・7カテゴリ管理）
- **動的設定**: config/core/thresholds.yaml（戦略固有設定・運用中調整対応）
- **ハードコード排除**: ソースコード内の固定値完全禁止・設定ファイル一元化
- **循環インポート安全設計**: 遅延インポート実装による設定システム安全性確保
- **一括管理**: YAMLファイル編集のみでbot全体の挙動制御
- **インフラ設定**: config/infrastructure/（gcp_config.yaml・cloudbuild.yaml）
- **優先順位**: CLI引数 > 環境変数 > YAML設定
- **フォールバック**: 設定されているが発生を最小化

---

## 📊 品質基準

### テスト・品質保証
- **テスト成功率**: 100%維持必須（Phase 41.8完了: 1,081テスト成功）
- **カバレッジ**: 69.57%達成・維持（Phase 41.8完了）
- **実行時間**: 統一品質チェック80秒以内
- **CI/CD統合**: GitHub Actions自動品質ゲート
- **GCPリソース効率**: 古いイメージ定期削除・容量最適化・コスト管理

### コード品質
- **静的解析**: flake8・black・isort通過必須
- **型安全性**: Protocol・dataclass・型注釈活用
- **エラーハンドリング**: カスタム例外・階層化処理・適切なログ
- **設定品質**: ハードコード値完全排除・設定ファイル一元管理徹底
- **戦略品質**: 戦略実装内の数値リテラル完全禁止・get_threshold()安全参照・循環インポート問題解決

### 運用品質
- **段階的デプロイ**: paper → live 2段階デプロイ
- **自動ロールバック**: エラー検知時の安全な自動復旧
- **ログ管理**: JST時刻・構造化ログ・検索・分析対応

---

## 🔧 設定管理体系

### 設定ファイル構造

```
config/
├── core/
│   ├── unified.yaml                 # 統一設定ファイル（メイン）
│   ├── features.yaml                # 機能トグル管理（7カテゴリ）
│   ├── thresholds.yaml              # 動的設定・戦略固有パラメータ
│   ├── feature_order.json          # 15特徴量定義・順序管理・単一真実源
│   └── archive/                     # 旧設定ファイル保存
└── infrastructure/
    └── gcp_config.yaml              # GCP環境設定
```

### 統一設定ファイル（config/core/unified.yaml）

| 設定項目 | 内容 | 設定例 |
|---------|------|--------|
| **モード制御** | paper/live/backtest切り替え | mode: paper（デフォルト） |
| **取引所設定** | bitbank API・レート制限 | rate_limit_ms: 35000 |
| **ML設定** | 信頼度閾値・モデル重み | confidence_threshold: 0.35 |
| **戦略設定** | 5戦略パラメータ | 統合重み・競合解決ルール |
| **リスク設定** | Kelly基準・ドローダウン制限 | kelly_min_trades: 5, max_drawdown: 0.20 |
| **デフォルト値** | 全デフォルト値統合 | ハードコード値完全排除 |

### 設定優先順位
1. **CLI引数**（最優先）: `--mode live`
2. **環境変数**: `MODE=live`
3. **YAML設定**（最後）: `mode: paper`

### Secret Manager管理仕様（重要）
- **バージョン管理**: 具体的バージョン番号使用必須
  - ✅ **推奨**: `bitbank-api-key:3`, `discord-webhook-url:5`
  - ❌ **非推奨**: `bitbank-api-key:latest` ← Cloud Run環境で解決失敗
- **現在のバージョン**:
  - `bitbank-api-key`: バージョン3
  - `bitbank-api-secret`: バージョン3
  - `discord-webhook-url`: バージョン5
- **更新手順**: Secret更新時は対応するワークフローファイル（ci.yml:319）も更新必須

---

## 🎯 成功指標（評価基準）

### 定量的成功指標

| カテゴリ | 指標 | 目標値 | 評価基準 |
|---------|------|--------|---------|
| **収益性** | 月次利益 | 2,000円以上 | GCPコスト回収+利益 |
| | 資金拡大 | 1万→50万円 | 段階的成功達成 |
| | 取引勝率 | 55%以上 | 安定収益性確保 |
| | 最大DD | 20%以内 | 資金保護維持 |
| **システム** | 稼働率 | 99.5%以上 | 高可用性確保 |
| | 応答時間 | 3秒以下 | 取引機会損失防止 |
| | テスト成功率 | 100% | 品質保証維持（Phase 41.8: 1,081テスト） |
| | カバレッジ | 69.57%達成 | 品質保証維持（Phase 41.8完了） |
| **運用** | 取引頻度 | 100-200回/月 | 高頻度取引実現 |
| | 監視レベル | 24時間 | Discord完全監視 |
| | プロセス重複防止率 | 100% | 無限通知問題防止 |
| | Discord通知コスト | 従量制限内 | 1時間12件以内・バッチ処理効果 |
| | 安全実行率 | 100% | run_safe.sh経由実行徹底 |

### システム評価の重要ポイント

1. **設定管理**: unified.yaml による一元管理・ハードコード値完全排除が正常動作
2. **5戦略統合**: ATR・Donchian・ADX・もちぽよ・マルチタイムフレーム全稼働
3. **ML精度**: LightGBM 40% + XGBoost 40% + RandomForest 20% の重み付け正常
4. **ML学習システム**（Phase 41.8完了）: 実データ学習・3クラス分類・TimeSeriesSplit n_splits=5・Early Stopping・SMOTE oversampling・Optuna最適化・Strategy-Aware ML実装による企業級ML基盤完成
5. **リスク制御**: 3段階判定（ML信頼度→リスクスコア→最終実行）が安全動作
6. **設定品質**: YAMLファイル編集のみでbot全体制御・コード修正不要の運用実現
7. **コスト管理**: 月額2,000円以内でCloud Run 1Gi・1CPU稼働
8. **プロセス管理**: 重複起動完全防止・無限通知問題の根本的解決
9. **通知最適化**: Discord バッチ処理・レート制限による従量課金最小化
10. **少額運用対応**: 1万円残高での確実な取引開始・最小ロット優先機能が正常動作
11. **ML信頼度連動制限**: 低/中/高信頼度に応じた動的制限が適切に機能
12. **bitbank API統合**: 保証金維持率の正確な取得・計算誤差排除が実現
13. **TP/SL完全化**: 完全なトレーディングサイクル・リスクリワード比管理実現
14. **統一設定管理**: 設定不整合完全解消・ハードコード完全排除・企業級品質達成
15. **ML予測統合**: 戦略70% + ML30%加重平均・一致ボーナス/不一致ペナルティ・真のハイブリッドMLbot実現
16. **TP/SL自動配置**: 指値注文切替・クールダウン30分・ポジション追跡による運用安定性向上
17. **適応型リスク管理**: ボラティリティ連動ATR倍率・15m足ATR使用・最小SL距離保証1%実装
18. **完全指値オンリー実装**: 100%指値注文・不利価格戦略（約定率90-95%維持）・年間¥150,000手数料削減実現
19. **Strategy-Aware ML**（Phase 41.8完了）: 55特徴量システム（50基本+5戦略信号）・実戦略信号学習・訓練/推論一貫性確保・Look-ahead bias防止・F1スコア0.56-0.61達成
20. **ML統合最適化**（Phase 41.8.5完了）: 3段階統合ロジック再設計（3クラス分類対応）・閾値最適化（min_ml_confidence: 0.6→0.45）・ML統合率10%→100%達成

---

**最終更新**: 2025年10月17日 - Phase 41.8.5完了（Strategy-Aware ML実装・55特徴量学習・ML統合閾値最適化）
