# システム要件定義書

**Phase 52.4**

**注**: 特徴量数・戦略数・システム設定は`config/core/feature_order.json`・`config/core/strategies.yaml`・`config/core/thresholds.yaml`を参照

## 📋 このドキュメントの役割

**このファイルを読む人**:
- システム実装を行うAI（Claude）
- 開発・運用時に迷った時の判断者

**このファイルで分かること**:
- システムの目的・存在意義（WHY）
- 実装すべき機能要件（WHAT）
- 技術仕様・アーキテクチャ（HOW）
- 品質基準・制約事項（CONSTRAINTS）

**ルール**:
- 現在の確定仕様のみ記載（実装履歴は`docs/開発履歴/`参照）
- 判断基準として機能する内容に特化
- Claude（AI）が読んですぐ実装できる明確な記述

---

## 🎯 システムの目的・役割

### プロジェクトアイデンティティ（絶対不変）

| 項目 | 仕様 | 理由 |
|------|------|------|
| **対象市場** | bitbank信用取引・BTC/JPY専用 | API統合・手数料体系・法規制対応の完全最適化 |
| **資金規模** | 少額スタート → 段階的拡大 | 個人投資家向け・段階的リスク管理（unified.yamlに定義） |
| **取引頻度** | 月100-200回・高頻度取引 | AI優位性活用・機会損失最小化 |
| **収益目標** | 月額運用コスト以上 | 持続可能運用・最低限ペイライン |
| **リスク管理** | 最大ドローダウン制限 | 資金保護最優先・破綻リスク排除（thresholds.yamlに定義） |

### システムの存在意義

1. **人間では実現不可能**: 24時間監視・5分間隔判定・複数戦略統合・ML予測統合
2. **機会損失の排除**: 睡眠中・仕事中の取引機会を完全自動化で捕捉
3. **感情的判断の排除**: 数学的根拠（Kelly基準・ML信頼度）に基づく冷静な判断
4. **少額資金の効率化**: 1万円からでも機関投資家レベルの高度な取引戦略を実現

---

## 📋 機能要件

### 1. 取引機能

**基本仕様**:
- 取引所: bitbank信用取引専用（BTC/JPY通貨ペア）
- 最小取引単位: 0.0001 BTC
- 取引頻度: 月100-200回の高頻度取引
- レバレッジ: 最大2倍（日本規制）・安全性重視で1倍運用推奨

**ポジションサイジング**:
- ML信頼度連動制限: 低信頼度3%・中信頼度5%・高信頼度10%の動的制御
- 最小ロット優先保証: 制限金額 < 最小ロット価値の場合、最小ロット（0.0001 BTC）を優先許可

**利益確定・損切りシステム**:
- テイクプロフィット/ストップロス: 個別TP/SL自動配置・エントリー毎に独立管理
- TP/SL設定: thresholds.yamlに定義（基本設定・レジーム別設定）
- TP/SL注文自動配置: エントリー後即座にTP/SL stop注文配置・bitbank API完全対応
- 全戦略統一SL/TP: SignalBuilder統合による一貫したSL/TP計算
- ハードコード完全排除: thresholds.yaml設定から取得・get_threshold()パターン統一

**手数料最適化・取引頻度管理**:
- 完全指値オンリー実装: 100%指値注文によるコスト削減・メイカーリベート完全活用
- 不利価格戦略: 確実約定優先・高約定率維持（thresholds.yamlに定義）
- 手数料最適化効果: 年間削減達成・Taker → Maker移行完了
- 柔軟クールダウン: 基本間隔・強トレンド時スキップ（thresholds.yamlに定義）

**リスク管理高度化**:
- 適応型ATR倍率: ボラティリティ連動（thresholds.yamlに定義）
- 15m ATR優先使用: エントリー時間軸に適したSL距離計算
- 最小SL距離保証: 最小距離保証・少額資金対応（thresholds.yamlに定義）

### 2. AI取引戦略

**戦略構成**:

strategies.yamlに定義（戦略タイプ・重み・優先度・有効化設定）

**戦略タイプ**:
- レンジ型戦略: ボラティリティベース平均回帰・BB反転・Stochastic反転・Donchianチャネル
- トレンド型戦略: ADXトレンド強度・MACDクロスオーバー

**動的戦略管理システム**:
- **Registry Pattern**: 戦略クラスの中央レジストリ管理・`@StrategyRegistry.register()`デコレータによる自動登録
- **Decorator Pattern**: 宣言的戦略登録・コード可読性向上
- **Facade Pattern**: StrategyLoaderによる複雑な初期化処理の隠蔽
- **拡張性**: 戦略追加・削除時の修正範囲を93%削減（27→2ファイル）
- **設定駆動**: strategies.yamlによる戦略有効化・優先度設定

**戦略統合ロジック**:
- 複数戦略の信頼度を**合計**して最終判定（平均ではない）
- 動的コンセンサス: enabled戦略数に応じた自動閾値調整（thresholds.yamlに定義）
- 柔軟な戦略管理: 戦略追加・削除が設定ファイル変更のみで完結

### 3. 機械学習システム

**アンサンブル構成**:
- 3モデル統合: unified.yamlに重み定義
- 特徴量管理: feature_order.json単一真実源（特徴量数・順序・レベル定義）
- **2段階Graceful Degradation + Dummy**: ensemble_full.pkl（Full特徴量） → ensemble_basic.pkl（Basic特徴量・戦略シグナル除外） → DummyModel（最低限動作保証）
- **モデルファイル**: ensemble_full.pkl（デフォルト）・ensemble_basic.pkl（フォールバック）
  - セマンティック命名: レベル番号システム廃止・特徴量内容を名前で明示
  - シンプル設計: 外部API依存削除・GCP環境安定性向上・Feature Importance最適化

**特徴量構成**:

feature_order.jsonに定義（特徴量数・カテゴリ・順序・レベル別構成）

- **基本テクニカル特徴量**: 価格・ボリューム・テクニカル指標・市場構造
  - 基本: close・volume・rsi・macd・atr・bb_position
  - トレンド: ema系列
  - ボラティリティ: atr・bb_width
  - ブレイクアウト: channel_position
  - レジーム: adx・plus_di・minus_di
  - ラグ特徴量: 過去期間の価格・ボリューム
  - 移動統計量: Rolling Mean/Std/Min/Max
  - 交互作用特徴量: RSI×ATR・MACD×Volume等
- **戦略シグナル特徴量**: strategies.yamlに定義された戦略の実信号
  - Strategy-Aware ML: 実戦略信号学習・訓練/推論一貫性確保
  - Look-ahead bias防止: 過去データのみ使用・未来データリーク完全防止
  - 動的特徴量生成: 有効戦略のみシグナル特徴量として生成

**外部API特徴量削除の理由**（重要な設計判断）:
- ❌ **時間軸ミスマッチ**: 日次更新データ vs 5分足取引
- ❌ **統計的有意性不足**: ML精度向上が誤差範囲内
- ❌ **GCP環境不安定性**: システム停止頻発
- ❌ **BTC市場独立性**: BTC価格の独自変動が支配的
- ✅ **シンプル設計回帰**: 複雑性削減・保守性向上・ゼロダウンタイム実現

**Strategy-Aware ML実装**:
- 実戦略信号学習: 訓練時に実際の戦略を実行して実戦略信号を生成
- Look-ahead bias防止: 過去データのみ使用・未来データリーク完全防止
- 高精度達成: F1スコア達成（最新値はモデルメタデータ参照）

**ハイブリッドML統合**:
- 戦略・ML重み: thresholds.yamlに定義
- 3段階統合ロジック: thresholds.yamlに閾値・ボーナス・ペナルティ定義
- ML統合率100%達成: 最適化閾値により高いML活用率実現

**学習データ・学習方式**:
- 実データ学習: CSV実データ読み込み・過去データ15分足
- 全体再学習: 毎回ゼロから学習（累積学習ではない）
- 3クラス分類: BUY/HOLD/SELL分類（閾値はthresholds.yamlに定義）
- Train/Val/Test分割: 標準比率

**学習プロセス最適化**:
- TimeSeriesSplit: Cross Validation
- Early Stopping: 過学習防止
- SMOTE oversampling: クラス不均衡対応
- Optunaハイパーパラメータ最適化: 最適化結果はthresholds.yamlに保存

**週次自動更新システム**:
- 更新頻度: 定期自動学習→品質検証→段階的本番デプロイ
- 安全な更新体制: モデル自動バックアップ・ロールバック機能

### 4. リスク管理

**Kelly基準**:
- 最小取引数: thresholds.yamlに定義
- 初期取引保証: Kelly履歴不足時の固定取引量
- 3つの値統合: 動的サイジング・Kelly基準・RiskManager の最小値（min）を採用

**証拠金維持率管理**:
- Critical閾値: thresholds.yamlに定義（維持率閾値未満で新規エントリー拒否）
- API直接取得: bitbank API `/user/margin/status`から実データ取得
- 予測ベース制御: 将来の維持率を予測してエントリー判断
- 追証完全防止: 維持率閾値を下回る前にエントリー停止
- ポジション価値取得: API実ポジション取得優先（`fetch_margin_positions`）・取得失敗時は推定値にフォールバック
- ハードコード完全排除: BTC価格・残高のハードコード値を完全削除・実BTC価格・実残高使用

**段階的資金管理**:
- 最小残高警告: thresholds.yamlに定義・警告表示・システム停止はしない
- 継続稼働保証: 残高不足でも監視モードで稼働継続
- 段階的拡大: unified.yamlに初期残高定義・資金拡大に完全対応

**自動損切り**:
- 最大ドローダウン制限: thresholds.yamlに定義
- 連続損失制限: thresholds.yamlに定義

---

## ⚙️ 非機能要件

### パフォーマンス
- 取引実行: 15分足・4時間足の2軸マルチタイムフレーム構成
- 実行間隔: unified.yamlに定義（Cloud Run cron job）
- 応答時間: API呼び出し平均3秒以下

### 可用性
- 稼働時間: 24時間365日自動稼働
- 稼働率: 99.5%以上の高可用性
- 自動復旧: エラー検知・ロールバック・段階的復旧機能

**プロセス管理**:
- ロックファイル管理: PIDベース重複起動完全防止
- シグナル制御: SIGTERM/SIGINT適切処理・グレースフルシャットダウン
- 環境自動判定: ローカル/GCP環境別実行制御
- タイムアウト管理: GCP環境15分自動終了・コスト最適化
- 安全実行スクリプト: scripts/management/run_safe.sh による統一実行

### セキュリティ
- 認証管理: GCP Secret Manager・Workload Identity
- 通信暗号化: SSL/TLS必須・API証明書検証
- アクセス制御: 最小権限の原則・権限分離

### 監視・通知
- 週間レポート: 損益統計・グラフ自動送信（GitHub Actions）
- 内容: 週間損益・累積損益・勝率・取引回数・最大ドローダウン
- グラフ: matplotlib損益曲線（日別・累積）
- 配信: Discord Webhook（Embed + 画像添付）
- コスト削減: 通知大幅削減達成

### バックテスト・性能測定
- TradeTracker統合: エントリー/エグジットペアリング・損益計算
- 可視化: matplotlib（エクイティカーブ・損益分布・ドローダウン・価格チャート）
- 信頼性100%: ライブモードと完全一致する動作保証

---

## 🏗️ 技術仕様

### 開発言語・フレームワーク
- Python: 3.13（メイン開発言語・MLライブラリ互換性最適化）
- 機械学習: scikit-learn・LightGBM・XGBoost・imbalanced-learn（SMOTE）・Optuna
- データ処理: pandas・numpy
- API統合: ccxt（bitbank）・Discord Webhook・bitbank margin status API
- レポート生成: matplotlib・Pillow（損益曲線グラフ）
- 税務システム: SQLite・CSV出力（国税庁フォーマット）

### インフラ・運用
- 実行環境: GCP Cloud Run（サーバーレス・1Gi・1CPU）
- CI/CD: GitHub Actions・自動品質ゲート・段階的デプロイ
- 監視: Cloud Logging・週間レポート
- 認証: Secret Manager・Workload Identity
- プロセス管理: fcntl・PIDベース排他制御・run_safe.sh統一スクリプト

### 設定管理（統一システム・ハードコード完全排除）

**設定ファイル構造**:
```
config/
├── core/
│   ├── unified.yaml          # 統一設定ファイル（メイン）
│   │                         # - 初期残高・実行間隔・モデル重み
│   ├── strategies.yaml       # 戦略管理
│   │                         # - enabled・priority・type・weight
│   ├── features.yaml         # 機能トグル管理
│   ├── thresholds.yaml       # 動的設定・戦略固有パラメータ
│   │                         # - TP/SL設定・ML統合閾値・Optuna最適化結果
│   └── feature_order.json    # 特徴量定義・順序管理・単一真実源
│                             # - total_features・feature_levels・model_file
└── infrastructure/
    └── gcp_config.yaml       # GCP環境設定
```

**設定優先順位**:
1. CLI引数（最優先）: `--mode live`
2. 環境変数: `MODE=live`
3. YAML設定（最後）: `mode: paper`

**Secret Manager管理仕様**:
- バージョン管理: 具体的バージョン番号使用必須（例: `bitbank-api-key:3`）
- ❌ 非推奨: `latest`使用（Cloud Run環境で解決失敗）
- 現在のバージョン: `.github/workflows/ci.yml`に定義
- 更新手順: Secret更新時は対応するワークフローファイルも更新必須

---

## 🎯 システム制約

### 重要な制約一覧

| 制約カテゴリ | 項目 | 設定値 | 理由 |
|------------|------|--------|------|
| **インフラ** | GCPプロジェクト | my-crypto-bot-project | 固定プロジェクトID |
| | Cloud Runリソース | 1Gi・1CPU | 最低限コスト設定 |
| | 月額コスト上限 | 低コスト運用 | 個人運用予算制約 |
| | リージョン | asia-northeast1 | 東京リージョン・低レイテンシ |
| **データ** | メイン時間軸 | 15分足 | エントリー判断 |
| | 補助時間軸 | 4時間足 | 上位トレンド把握 |
| | API制限 | レート制限対応 | bitbank API制約 |
| | ログ保持期間 | GCPデフォルト | GCPコスト最適化 |
| **資金** | 初期資金 | unified.yamlに定義 | 少額スタート |
| | 最大資金 | unified.yamlに定義 | 段階的拡大上限 |
| | 最小残高警告 | thresholds.yamlに定義 | 警告のみ・停止しない |
| | 証拠金維持率 | thresholds.yamlに定義 | エントリー条件（Critical閾値） |
| | 最大ドローダウン | thresholds.yamlに定義 | 資金保護制限 |
| | レバレッジ | 1-2倍 | 安全性重視 |
| **運用管理** | プロセス重複防止 | 必須 | PIDロックファイル制御 |
| | 週間レポート | GitHub Actions定義 | 自動統計送信 |
| | 実行方式 | run_safe.sh経由 | 直接実行非推奨 |
| | GCPタイムアウト | コスト制御 | コスト制御・暴走防止 |

---

## 📊 品質基準

### テスト・品質保証
- テスト成功率: 100%維持必須（全テスト成功）
- カバレッジ: 目標カバレッジ以上維持（checks.sh実行後確認）
- 実行時間: 統一品質チェック高速実行
- CI/CD統合: GitHub Actions自動品質ゲート・GCP Cloud Run自動デプロイ

### コード品質
- 静的解析: flake8・black・isort通過必須
- 型安全性: Protocol・dataclass・型注釈活用
- エラーハンドリング: カスタム例外・階層化処理・適切なログ
- 設定品質: ハードコード値完全排除・設定ファイル一元管理徹底

### 運用品質
- 段階的デプロイ: paper → live 2段階デプロイ
- 自動ロールバック: エラー検知時の安全な自動復旧
- ログ管理: JST時刻・構造化ログ・検索・分析対応

---

## ✅ 成功指標（評価基準）

### 定量的成功指標

| カテゴリ | 指標 | 目標値 |
|---------|------|--------|
| **収益性** | 月次利益 | 運用コスト以上 |
| | 資金拡大 | 段階的拡大（unified.yamlに定義） |
| | 取引勝率 | 目標勝率以上（thresholds.yamlに定義） |
| | 最大DD | 制限内（thresholds.yamlに定義） |
| **システム** | 稼働率 | 高可用性（外部API削除・動的戦略管理により安定性向上） |
| | 応答時間 | 3秒以下 |
| | テスト成功率 | 100%（全テスト成功） |
| | カバレッジ | 目標カバレッジ以上維持 |
| **運用** | 取引頻度 | 月100-200回 |
| | 証拠金維持率 | Critical閾値以上維持（thresholds.yamlに定義） |
| | プロセス重複防止率 | 100% |
| | 週間レポート | GitHub Actions定義スケジュール |

### システム評価の重要ポイント

1. **設定管理**: unified.yaml・strategies.yaml・thresholds.yaml・feature_order.jsonによる一元管理・ハードコード値完全排除が正常動作
2. **動的戦略管理**: Registry Pattern実装・戦略追加削除93%削減（27→2ファイル）・設定駆動型設計
3. **戦略統合**: 戦略信号の**合計**計算による正確な判定（平均ではない）・動的コンセンサス調整
4. **ML精度**: unified.yamlに定義されたモデル重み付け正常
5. **ML統合**: thresholds.yamlに定義された重み・閾値による統合・3段階統合ロジック・ML統合率100%
6. **MLモデル障害耐性**: 2段階Graceful Degradation（ensemble_full.pkl → ensemble_basic.pkl）+ DummyModel・システム継続動作保証
7. **外部API依存排除**: GCP環境安定性向上・時間軸ミスマッチ解消・Feature Importance最適化・シンプル設計回帰
8. **リスク制御**: 証拠金維持率確実遵守・bitbank API実データ取得・ハードコード完全排除（thresholds.yamlに定義）
9. **TP/SL設定**: thresholds.yamlに定義されたTP/SL設定・全戦略統一管理
10. **バックテスト信頼性**: ライブモードと完全一致・TradeTracker統合・matplotlib可視化
11. **コスト管理**: 低コストCloud Run稼働（通知大幅削減達成）
12. **プロセス管理**: 重複起動完全防止・PIDベースロックファイル・グレースフルシャットダウン
13. **システム整合性**: feature_order.jsonに定義された特徴量システム・strategies.yamlに定義された戦略統合・技術的負債ゼロ

---

**最終更新**: 2025-11-15 (Phase 52.4) - 設定一元化完了・ハードコード撲滅・Single Source of Truth確立・動的戦略管理基盤・Registry Pattern実装・システム整合性100%・技術的負債ゼロ・全テスト成功・目標カバレッジ達成・CI/CD成功・GCPデプロイ完了
