# システム要件定義書

## 📋 このドキュメントの役割

**このファイルを読む人**:
- システム実装を行うAI（Claude）
- 開発・運用時に迷った時の判断者

**このファイルで分かること**:
- システムの目的・存在意義（WHY）
- 実装すべき機能要件（WHAT）
- 技術仕様・アーキテクチャ（HOW）
- 品質基準・制約事項（CONSTRAINTS）

**ルール**:
- 現在の確定仕様のみ記載（実装履歴は`docs/開発履歴/`参照）
- 判断基準として機能する内容に特化
- Claude（AI）が読んですぐ実装できる明確な記述

---

## 🎯 システムの目的・役割

### プロジェクトアイデンティティ（絶対不変）

| 項目 | 仕様 | 理由 |
|------|------|------|
| **対象市場** | bitbank信用取引・BTC/JPY専用 | API統合・手数料体系・法規制対応の完全最適化 |
| **資金規模** | 1万円スタート → 最大50万円 | 個人投資家向け・段階的リスク管理 |
| **取引頻度** | 月100-200回・高頻度取引 | AI優位性活用・機会損失最小化 |
| **収益目標** | 月額運用コスト（2,000円）以上 | 持続可能運用・最低限ペイライン |
| **リスク管理** | 最大ドローダウン20%以内 | 資金保護最優先・破綻リスク排除 |

### システムの存在意義

1. **人間では実現不可能**: 24時間監視・5分間隔判定・5戦略統合・ML予測統合
2. **機会損失の排除**: 睡眠中・仕事中の取引機会を完全自動化で捕捉
3. **感情的判断の排除**: 数学的根拠（Kelly基準・ML信頼度）に基づく冷静な判断
4. **少額資金の効率化**: 1万円からでも機関投資家レベルの高度な取引戦略を実現

---

## 📋 機能要件

### 1. 取引機能

**基本仕様**:
- 取引所: bitbank信用取引専用（BTC/JPY通貨ペア）
- 最小取引単位: 0.0001 BTC（約1,700円相当）
- 価格基準: 1 BTC = 約17,000,000 JPY（2025年9月時点）
- 取引頻度: 月100-200回の高頻度取引
- レバレッジ: 最大2倍（日本規制）・安全性重視で1倍運用推奨

**ポジションサイジング**:
- ML信頼度連動制限: 低信頼度3%・中信頼度5%・高信頼度10%の動的制御
- 最小ロット優先保証: 制限金額 < 最小ロット価値の場合、最小ロット（0.0001 BTC）を優先許可

**利益確定・損切りシステム**:
- テイクプロフィット/ストップロス: 個別TP/SL自動配置・エントリー毎に独立管理
- デイトレード最適設定: SL 1.5%・TP 2%・RR比1.33:1（BTC 15分足デイトレード最適化）
- TP/SL注文自動配置: エントリー後即座にTP/SL stop注文配置・bitbank API完全対応
- 全5戦略統一SL/TP: SignalBuilder統合による一貫したSL/TP計算
- ハードコード完全排除: すべてthresholds.yaml設定から取得・get_threshold()パターン統一

**手数料最適化・取引頻度管理**:
- 完全指値オンリー実装: 100%指値注文によるコスト削減・メイカーリベート完全活用
- 不利価格戦略: 確実約定優先（買注文: ask+0.05%・売注文: bid-0.05%）・約定率90-95%維持
- 手数料最適化効果: 年間¥150,000削減（50万円運用時）・Taker 0.12% → Maker -0.02%
- 柔軟クールダウン: 基本30分間隔・強トレンド時（強度>=0.7）スキップ

**リスク管理高度化**:
- 適応型ATR倍率: ボラティリティ連動（低2.5x・通常2.0x・高1.5x）
- 15m ATR優先使用: エントリー時間軸に適したSL距離計算
- 最小SL距離保証: 1.5%最小距離・少額資金対応

### 2. AI取引戦略（5戦略統合）

1. **ATR戦略**: ボラティリティベースの動的ポジションサイジング
2. **もちぽよアラート戦略**: EMA・MACD・ZigZag・RCI統合シグナル
3. **マルチタイムフレーム戦略**: 複数時間軸統合判定
4. **Donchianチャネル戦略**: ブレイクアウト・リバーサル判定
5. **ADXトレンド戦略**: 方向性指標による市場レジーム分析

**戦略統合ロジック**:
- 複数戦略の信頼度を**合計**して最終判定（平均ではない）
- 例: BUY推奨2戦略（0.295+0.700=0.995）> SELL推奨1戦略（0.500）→ BUY採用

### 3. 機械学習システム

**アンサンブル構成**:
- 3モデル統合: LightGBM（40%）+ XGBoost（40%）+ RandomForest（20%）
- 特徴量管理: 55特徴量（50基本 + 5戦略信号）・feature_order.json単一真実源

**Strategy-Aware ML実装**:
- 実戦略信号学習: 訓練時に実際の戦略を実行して実戦略信号を生成
- Look-ahead bias防止: 過去データのみ使用・未来データリーク完全防止
- 高精度達成: F1スコア0.56-0.61

**ハイブリッドML統合**:
- 戦略70% + ML30%: 戦略シグナルとML予測の加重平均統合
- 3段階統合ロジック:
  - Stage 1 (信頼度 < 0.45): 戦略のみ採用
  - Stage 2 (0.45 ≤ 信頼度 < 0.60): 戦略70% + ML30%加重平均
  - Stage 3 (信頼度 ≥ 0.60): 一致時1.2倍ボーナス・不一致時0.7倍ペナルティ
- ML統合率100%達成: 最適化閾値により高いML活用率実現

**学習データ・学習方式**:
- 実データ学習: CSV実データ読み込み・過去180日分15分足データ（17,271件）
- 全体再学習: 毎回ゼロから学習（累積学習ではない）
- 3クラス分類: BUY/HOLD/SELL分類・閾値0.5%
- Train/Val/Test分割: 70/15/15比率

**学習プロセス最適化**:
- TimeSeriesSplit: n_splits=5によるCross Validation
- Early Stopping: rounds=20で過学習防止
- SMOTE oversampling: クラス不均衡対応
- Optunaハイパーパラメータ最適化: TPESampler・n_trials=50

**週次自動更新システム**:
- 更新頻度: 毎週日曜18:00(JST)自動学習→品質検証→段階的本番デプロイ
- 安全な更新体制: models/archive/自動バックアップ・ロールバック機能

### 4. リスク管理

**Kelly基準**:
- 最小取引数: 5取引（実用性重視）
- 初期取引保証: Kelly履歴不足時（5取引未満）は0.0001 BTC固定取引
- 3つの値統合: 動的サイジング・Kelly基準・RiskManager の最小値（min）を採用

**証拠金維持率管理**:
- Critical閾値: 80%（維持率80%未満で新規エントリー拒否）
- API直接取得: bitbank API `/user/margin/status`から実データ取得
- 予測ベース制御: 将来の維持率を予測してエントリー判断
- 追証完全防止: 維持率80%を下回る前にエントリー停止

**段階的資金管理**:
- 最小残高警告: 3,000円未満で警告表示・システム停止はしない
- 継続稼働保証: 残高不足でも監視モードで稼働継続
- 段階的拡大: 1万円→10万円→50万円の資金拡大に完全対応

**自動損切り**:
- 最大ドローダウン20%制限
- 連続損失5回で自動停止

---

## ⚙️ 非機能要件

### パフォーマンス
- 取引実行: 15分足・4時間足の2軸マルチタイムフレーム構成
- 実行間隔: 5分間隔（Cloud Run cron job）
- 応答時間: API呼び出し平均3秒以下

### 可用性
- 稼働時間: 24時間365日自動稼働
- 稼働率: 99.5%以上の高可用性
- 自動復旧: エラー検知・ロールバック・段階的復旧機能

**プロセス管理**:
- ロックファイル管理: PIDベース重複起動完全防止
- シグナル制御: SIGTERM/SIGINT適切処理・グレースフルシャットダウン
- 環境自動判定: ローカル/GCP環境別実行制御
- タイムアウト管理: GCP環境15分自動終了・コスト最適化
- 安全実行スクリプト: scripts/management/run_safe.sh による統一実行

### セキュリティ
- 認証管理: GCP Secret Manager・Workload Identity
- 通信暗号化: SSL/TLS必須・API証明書検証
- アクセス制御: 最小権限の原則・権限分離

### 監視・通知
- 週間レポート: 損益統計・グラフ自動送信（毎週月曜日 9:00 JST・GitHub Actions）
- 内容: 週間損益・累積損益・勝率・取引回数・最大ドローダウン
- グラフ: matplotlib損益曲線（日別・累積）
- 配信: Discord Webhook（Embed + 画像添付）
- コスト削減: 通知99%削減（300-1,500回/月 → 4回/月）

### バックテスト・性能測定
- TradeTracker統合: エントリー/エグジットペアリング・損益計算
- 可視化: matplotlib（エクイティカーブ・損益分布・ドローダウン・価格チャート）
- 信頼性100%: ライブモードと完全一致する動作保証

---

## 🏗️ 技術仕様

### 開発言語・フレームワーク
- Python: 3.13（メイン開発言語・MLライブラリ互換性最適化）
- 機械学習: scikit-learn・LightGBM・XGBoost・imbalanced-learn（SMOTE）・Optuna
- データ処理: pandas・numpy
- API統合: ccxt（bitbank）・Discord Webhook・bitbank margin status API
- レポート生成: matplotlib・Pillow（損益曲線グラフ）
- 税務システム: SQLite・CSV出力（国税庁フォーマット）

### インフラ・運用
- 実行環境: GCP Cloud Run（サーバーレス・1Gi・1CPU）
- CI/CD: GitHub Actions・自動品質ゲート・段階的デプロイ
- 監視: Cloud Logging・週間レポート
- 認証: Secret Manager・Workload Identity
- プロセス管理: fcntl・PIDベース排他制御・run_safe.sh統一スクリプト

### 設定管理（統一システム・ハードコード完全排除）

**設定ファイル構造**:
```
config/
├── core/
│   ├── unified.yaml          # 統一設定ファイル（メイン）
│   ├── features.yaml         # 機能トグル管理（7カテゴリ）
│   ├── thresholds.yaml       # 動的設定・戦略固有パラメータ
│   └── feature_order.json    # 55特徴量定義・順序管理・単一真実源
└── infrastructure/
    └── gcp_config.yaml       # GCP環境設定
```

**設定優先順位**:
1. CLI引数（最優先）: `--mode live`
2. 環境変数: `MODE=live`
3. YAML設定（最後）: `mode: paper`

**Secret Manager管理仕様**:
- バージョン管理: 具体的バージョン番号使用必須（`bitbank-api-key:3`）
- ❌ 非推奨: `bitbank-api-key:latest`（Cloud Run環境で解決失敗）
- 現在のバージョン:
  - `bitbank-api-key`: バージョン3
  - `bitbank-api-secret`: バージョン3
  - `discord-webhook-url`: バージョン6
- 更新手順: Secret更新時は対応するワークフローファイル（ci.yml）も更新必須

---

## 🎯 システム制約

### 重要な制約一覧

| 制約カテゴリ | 項目 | 設定値 | 理由 |
|------------|------|--------|------|
| **インフラ** | GCPプロジェクト | my-crypto-bot-project | 固定プロジェクトID |
| | Cloud Runリソース | 1Gi・1CPU | 最低限コスト設定 |
| | 月額コスト上限 | 2,000円以内 | 個人運用予算制約 |
| | リージョン | asia-northeast1 | 東京リージョン・低レイテンシ |
| **データ** | メイン時間軸 | 15分足 | エントリー判断・Phase 49最適化 |
| | 補助時間軸 | 4時間足 | 上位トレンド把握 |
| | API制限 | 35秒間隔 | bitbank レート制限対応 |
| | ログ保持期間 | 30日間 | GCPコスト最適化 |
| **資金** | 初期資金 | 1万円 | 少額スタート |
| | 最大資金 | 50万円 | 段階的拡大上限 |
| | 最小残高警告 | 3,000円 | 警告のみ・停止しない |
| | 証拠金維持率 | 80%以上 | エントリー条件（Critical閾値） |
| | 最大ドローダウン | 20% | 資金保護制限 |
| | レバレッジ | 1-2倍 | 安全性重視 |
| **運用管理** | プロセス重複防止 | 必須 | PIDロックファイル制御 |
| | 週間レポート | 毎週月曜9時 | 自動統計送信 |
| | 実行方式 | run_safe.sh経由 | 直接実行非推奨 |
| | GCPタイムアウト | 15分自動終了 | コスト制御・暴走防止 |

---

## 📊 品質基準

### テスト・品質保証
- テスト成功率: 100%維持必須（1,065テスト）
- カバレッジ: 70.56%達成・維持
- 実行時間: 統一品質チェック80秒以内
- CI/CD統合: GitHub Actions自動品質ゲート

### コード品質
- 静的解析: flake8・black・isort通過必須
- 型安全性: Protocol・dataclass・型注釈活用
- エラーハンドリング: カスタム例外・階層化処理・適切なログ
- 設定品質: ハードコード値完全排除・設定ファイル一元管理徹底

### 運用品質
- 段階的デプロイ: paper → live 2段階デプロイ
- 自動ロールバック: エラー検知時の安全な自動復旧
- ログ管理: JST時刻・構造化ログ・検索・分析対応

---

## ✅ 成功指標（評価基準）

### 定量的成功指標

| カテゴリ | 指標 | 目標値 |
|---------|------|--------|
| **収益性** | 月次利益 | 2,000円以上 |
| | 資金拡大 | 1万→50万円 |
| | 取引勝率 | 55%以上 |
| | 最大DD | 20%以内 |
| **システム** | 稼働率 | 99.5%以上 |
| | 応答時間 | 3秒以下 |
| | テスト成功率 | 100% |
| | カバレッジ | 70.56%達成 |
| **運用** | 取引頻度 | 100-200回/月 |
| | 証拠金維持率 | 80%以上維持 |
| | プロセス重複防止率 | 100% |
| | 週間レポート | 毎週月曜9時送信 |

### システム評価の重要ポイント

1. **設定管理**: unified.yaml による一元管理・ハードコード値完全排除が正常動作
2. **5戦略統合**: 戦略信号の**合計**計算による正確な判定（平均ではない）
3. **ML精度**: LightGBM 40% + XGBoost 40% + RandomForest 20% の重み付け正常
4. **ML統合**: 戦略70% + ML30%加重平均・3段階統合ロジック・ML統合率100%
5. **リスク制御**: 証拠金維持率80%確実遵守・bitbank API実データ取得
6. **バックテスト信頼性**: ライブモードと完全一致・SELL Only問題解決済み
7. **コスト管理**: 月額700-900円でCloud Run稼働（通知99%削減達成）
8. **プロセス管理**: 重複起動完全防止・無限通知問題の根本的解決
9. **TradeTracker統合**: エントリー/エグジットペアリング・損益計算正常動作
10. **4層検証システム**: Dockerfile・特徴量・戦略・モジュール整合性自動検証

---

**最終更新**: 2025年10月25日 - Phase 49完了時点の確定仕様
