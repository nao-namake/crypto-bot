# 暗号資産取引Bot 要件定義書

## 🎯 システム概要（AI理解用サマリー）

| 項目 | 仕様 | 備考 |
|------|------|------|
| **プロジェクト** | bitbank信用取引AI自動トレーディングボット | BTC/JPY専用 |
| **資金規模** | 1万円スタート → 最大50万円 | 段階的拡大方式 |
| **取引頻度** | 月100〜200回 | 高頻度取引 |
| **戦略数** | 5戦略統合 | ATR・もちぽよ・マルチタイムフレーム・Donchian・ADX |
| **ML構成** | 3モデルアンサンブル | LightGBM 50% + XGBoost 30% + RandomForest 20% |
| **時間軸** | 2軸構成 | 4時間足（トレンド）+ 15分足（エントリー） |
| **インフラ** | GCP Cloud Run | 1Gi・1CPU・月額2,000円以内 |
| **設定管理** | unified.yaml | config/core/unified.yaml で一元管理 |
| **品質基準** | 625テスト・58.64%カバレッジ | 30秒品質チェック |
| **監視** | Discord 3階層通知 | Critical/Warning/Info |

## 📋 プロジェクト目的・対象

### 目的
bitbank信用取引専用のAI自動取引システムを開発し、1万円の少額資金から開始して段階的に拡大可能な個人向けトレーディングボットを実現する。

### 対象ユーザー
- 個人投資家・トレーダー
- 少額から自動取引を始めたい初心者〜中級者
- 24時間稼働による機会損失を防ぎたいユーザー

### 期待される成果
- 月額運用コスト（約2,000円）以上の利益確保
- 1万円から開始し、成功時50万円への段階的資金拡大
- 月100〜200回の高頻度取引による収益機会の最大化

---

## 🎯 機能要件

### 取引機能
- **取引所**: bitbank信用取引専用（BTC/JPY通貨ペア）
- **取引頻度**: 月100〜200回の高頻度取引
- **資金管理**: 1万円スタート → 段階的拡大 → 最大50万円
- **レバレッジ**: 安全性重視の1〜2倍設定

### AI取引戦略（5戦略統合）
1. **ATR戦略**: ボラティリティベースの動的ポジションサイジング
2. **もちぽよアラート戦略**: EMA・MACD・ZigZag・RCI統合シグナル
3. **マルチタイムフレーム戦略**: 複数時間軸統合判定
4. **Donchianチャネル戦略**: ブレイクアウト・リバーサル判定
5. **ADXトレンド戦略**: 方向性指標による市場レジーム分析

### 機械学習システム
- **3モデルアンサンブル**: LightGBM（50%）+ XGBoost（30%）+ RandomForest（20%）
- **特徴量管理**: 15特徴量の統一管理・一元化（feature_order.json準拠）
- **学習方式・更新システム**: 
  - **全体再学習方式**: 過去180日間のデータで毎回ゼロから学習（累積学習ではない）
  - **市場適応性**: 概念ドリフト対応・急変する仮想通貨市場への継続的最適化
  - **週次自動更新**: 毎週日曜18:00(JST)に自動学習→品質検証→段階的本番デプロイ
  - **安全な更新体制**: models/archive/自動バックアップ・ロールバック機能・625テスト品質ゲート
- **信頼度判定**: ML信頼度35%閾値による取引機会拡大・月100-200回達成

### リスク管理
- **Kelly基準**: 数学的根拠に基づくポジションサイジング
- **3段階判定**: ML信頼度→リスクスコア→最終実行判定
- **自動損切り**: 最大ドローダウン20%制限・連続損失5回で自動停止
- **動的調整**: 市場状況・過去成績に応じたパラメータ自動調整

---

## ⚙️ 非機能要件

### パフォーマンス
- **取引実行**: 15分足・4時間足の2軸マルチタイムフレーム構成
- **応答時間**: API呼び出し平均3秒以下
- **取引精度**: 信頼度35%以上のシグナル実行・攻撃的設定

### 可用性
- **稼働時間**: 24時間365日自動稼働
- **稼働率**: 99.5%以上の高可用性
- **自動復旧**: エラー検知・ロールバック・段階的復旧機能

### セキュリティ
- **認証管理**: GCP Secret Manager・Workload Identity
- **通信暗号化**: SSL/TLS必須・API証明書検証
- **アクセス制御**: 最小権限の原則・権限分離

### 監視・通知
- **Discord通知**: 3階層アラート（Critical/Warning/Info）
- **システム監視**: 15分間隔ヘルスチェック・パフォーマンス追跡
- **運用報告**: 日次・週次・月次レポート自動生成

---

## 🏗️ システム制約

### 重要な制約一覧（AI参照用）

| 制約カテゴリ | 項目 | 設定値 | 理由 |
|------------|------|--------|------|
| **インフラ** | GCPプロジェクト | my-crypto-bot-project | 固定プロジェクトID |
| | Cloud Runリソース | 1Gi・1CPU | 最低限コスト設定 |
| | 月額コスト上限 | 2,000円以内 | 個人運用予算制約 |
| | リージョン | asia-northeast1 | 東京リージョン・低レイテンシ |
| **データ** | メイン時間軸 | 4時間足 | 上位トレンド把握 |
| | エントリー時間軸 | 15分足 | エントリータイミング判定 |
| | API制限 | 35秒間隔 | bitbank レート制限対応 |
| | ログ保持期間 | 30日間 | GCPコスト最適化 |
| **資金** | 初期資金 | 1万円 | 少額スタート |
| | 最大資金 | 50万円 | 段階的拡大上限 |
| | 最大ドローダウン | 20% | 資金保護制限 |
| | レバレッジ | 1〜2倍 | 安全性重視 |

### サービスアカウント・権限

| 用途 | アカウント | 権限 |
|------|-----------|------|
| **CI/CD** | github-deployer@my-crypto-bot-project.iam.gserviceaccount.com | admin系権限多数 |
| **Workload Identity** | GitHub Actions認証 | 最小権限・セキュア認証 |
| **Secret Manager** | API キー管理 | 暗号化保存・アクセス制御 |

---

## 🛠️ 技術スタック

### 開発言語・フレームワーク
- **Python**: 3.12（メイン開発言語・MLライブラリ互換性最適化）
- **機械学習**: scikit-learn・LightGBM・XGBoost
- **データ処理**: pandas・numpy・タイムシリーズ最適化
- **API統合**: ccxt（bitbank）・Discord Webhook

### インフラ・運用
- **実行環境**: GCP Cloud Run（サーバーレス）
- **CI/CD**: GitHub Actions・自動品質ゲート・段階的デプロイ
- **監視**: Cloud Logging・Discord統合通知
- **認証**: Secret Manager・Workload Identity

### 設定管理（統一システム・ハードコード完全排除）
- **統一設定**: config/core/unified.yaml（全デフォルト値集約）
- **ハードコード排除**: ソースコード内の固定値完全禁止・設定ファイル一元化
- **一括管理**: YAMLファイル編集のみでbot全体の挙動制御
- **インフラ設定**: config/infrastructure/（gcp_config.yaml・cloudbuild.yaml）
- **優先順位**: CLI引数 > 環境変数 > YAML設定
- **フォールバック**: 設定されているが発生を最小化

---

## 📊 品質基準

### テスト・品質保証
- **テスト数**: 625テスト100%成功維持
- **カバレッジ**: 58.64%以上（重要ロジック100%・補助機能選択的）
- **実行時間**: 統一品質チェック30秒以内
- **CI/CD統合**: GitHub Actions自動品質ゲート

### コード品質
- **静的解析**: flake8・black・isort通過必須
- **型安全性**: Protocol・dataclass・型注釈活用
- **エラーハンドリング**: カスタム例外・階層化処理・適切なログ
- **設定品質**: ハードコード値完全排除・設定ファイル一元管理徹底

### 運用品質
- **段階的デプロイ**: paper → live 2段階デプロイ
- **自動ロールバック**: エラー検知時の安全な自動復旧
- **ログ管理**: JST時刻・構造化ログ・検索・分析対応

---

## 🔧 設定管理体系（AI参照用）

### 設定ファイル構造

```
config/
├── core/
│   ├── unified.yaml                 # 統一設定ファイル（メイン）
│   ├── feature_order.json          # 12特徴量定義・順序管理
│   └── archive/                     # 旧設定ファイル保存
└── infrastructure/
    ├── gcp_config.yaml              # GCP環境設定
    └── cloudbuild.yaml              # CI/CDビルド設定
```

### 統一設定ファイル（config/core/unified.yaml）

| 設定項目 | 内容 | 設定例 |
|---------|------|--------|
| **モード制御** | paper/live/backtest切り替え | mode: paper（デフォルト） |
| **取引所設定** | bitbank API・レート制限 | rate_limit_ms: 35000 |
| **ML設定** | 信頼度閾値・モデル重み | confidence_threshold: 0.35 |
| **戦略設定** | 5戦略パラメータ | 統合重み・競合解決ルール |
| **リスク設定** | Kelly基準・ドローダウン制限 | max_drawdown: 0.20 |
| **デフォルト値** | 全デフォルト値統合 | ハードコード値完全排除 |

### 設定優先順位（AI重要）
1. **CLI引数**（最優先）: `--mode live`
2. **環境変数**: `MODE=live`
3. **YAML設定**（最後）: `mode: paper`

### インフラ設定構成

| ファイル | 管理対象 | 主要設定 |
|---------|---------|---------|
| **gcp_config.yaml** | GCPプロジェクト・サービス設定 | my-crypto-bot-project・Cloud Run |
| **cloudbuild.yaml** | CI/CDビルド・デプロイ | 625テスト・品質ゲート・デプロイ |

---

## 🎯 成功指標（AI評価基準）

### 定量的成功指標

| カテゴリ | 指標 | 目標値 | 評価基準 |
|---------|------|--------|---------|
| **収益性** | 月次利益 | 2,000円以上 | GCPコスト回収+利益 |
| | 資金拡大 | 1万→50万円 | 段階的成功達成 |
| | 取引勝率 | 55%以上 | 安定収益性確保 |
| | 最大DD | 20%以内 | 資金保護維持 |
| **システム** | 稼働率 | 99.5%以上 | 高可用性確保 |
| | 応答時間 | 3秒以下 | 取引機会損失防止 |
| | テスト成功率 | 100% | 625テスト全成功 |
| | カバレッジ | 58.64%以上 | 品質保証維持 |
| **運用** | 取引頻度 | 100-200回/月 | 高頻度取引実現 |
| | 監視レベル | 24時間 | Discord完全監視 |

### AI評価の重要ポイント

1. **設定管理**: unified.yaml による一元管理・ハードコード値完全排除が正常動作
2. **5戦略統合**: ATR・Donchian・ADX・もちぽよ・マルチタイムフレーム全稼働
3. **ML精度**: LightGBM 50% + XGBoost 30% + RandomForest 20% の重み付け正常
4. **ML学習システム**: 180日全体再学習・週次自動更新・市場適応性による継続的最適化
5. **リスク制御**: 3段階判定（ML信頼度→リスクスコア→最終実行）が安全動作
6. **設定品質**: YAMLファイル編集のみでbot全体制御・コード修正不要の運用実現
7. **コスト管理**: 月額2,000円以内でCloud Run 1Gi・1CPU稼働

---

**最終更新**: 2025年9月13日 - Phase 22対応・ハードコード値完全排除要件追加・設定ファイル一元管理による運用効率化