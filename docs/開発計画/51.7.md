# Phase 51.7 実装計画書

**作成日**: 2025年11月05日
**ステータス**: 計画立案完了・実装開始準備完了
**実装期間**: 7日間（6戦略実装 + 特徴量最適化）

---

## 📋 Phase 51.7 概要

### 目的

**戦略の熟考選定**:
現在の3戦略（ATRBased・DonchianChannel・ADXTrendStrength）は「副次的に生まれたもの」で、熟考されていない。レンジ相場用・トレンド相場用の戦略を意図的に設計し、バックテストで性能評価する。

**特徴量の完全見直し**:
現在の60特徴量は「開発の過程で自然と形成されたもの」であり、最適化されていない。冗長特徴量の削除・有効特徴量の追加により、6戦略に最適な特徴量セット（50特徴量）を構築する。

### 基本方針

- **ゼロベース思考**: 既存構成にこだわらず、最適解を追求
- **データドリブン**: 各ステップでバックテスト評価・Feature Importance分析
- **質重視**: 確実な実装・理論的根拠の明確化
- **シンプル設計**: Phase 51.5の教訓（複雑性削減）を遵守
- **Phase 51完走**: 実装期間7日間以内・Phase 51.8-51.12へ確実に進む

---

## 🎯 採用戦略：3戦略追加（レンジ型2 + トレンド型1）

### 選定理由

1. **冗長性確保**：各市場タイプで3戦略 = 多数決による誤判断リスク低減
2. **レンジ相場強化**：現状レンジ型1つ（ATRBased）→ 3つに強化
3. **トレンド相場バランス**：現状トレンド型2つ → 3つに強化
4. **ポートフォリオ理論**：2戦略より3戦略がバランス良い（分散投資の考え方）
5. **Phase 51.8連携**：レジーム別重み最適化で柔軟な調整可能
6. **有名戦略採用**：MACD・Stochastic等の実績ある指標を活用

### 完成後の戦略構成（6戦略）

**レンジ型（3戦略）**:
1. **ATRBased**（既存）- BB position + RSI reversal
2. **BB Reversal**（新規）- BB反転 + RSI overbought/oversold
3. **Stochastic Reversal**（新規）- Stochastic %K/%D多重確認

**トレンド型（3戦略）**:
1. **DonchianChannel**（既存）- ブレイクアウト
2. **ADXTrendStrength**（既存）- ADXトレンド判定
3. **MACD + EMA Crossover**（新規）- MACDクロス + EMAトレンド確認

**バランス**: レンジ50%・トレンド50%・各市場タイプで3戦略の冗長性確保

---

## 📊 戦略候補分析（調査結果）

### 検討した戦略

| 戦略                    | タイプ   | 難易度    | 追加特徴量                  | 実装期間 | 効果    | 採用              |
|-----------------------|-------|--------|------------------------|------|-------|-----------------|
| BB Reversal           | レンジ型  | ⭐⭐ 簡単  | bb_upper/lower（+2）    | 1日   | ⭐⭐⭐⭐⭐ | ✅ 採用（Day 3）   |
| Stochastic Reversal   | レンジ型  | ⭐⭐⭐ 中  | stoch_k/d（+2）         | 1日   | ⭐⭐⭐⭐  | ✅ 採用（Day 4）   |
| MACD + EMA Crossover  | トレンド型 | ⭐⭐⭐ 中  | macd_signal/histogram（+2） | 1日   | ⭐⭐⭐⭐  | ✅ 採用（Day 5）   |

**合計実装期間**: 7日間（Day 1-2: 特徴量最適化、Day 3-5: 3戦略実装、Day 6-7: 統合・ML再学習）
**特徴量最適化**: 60特徴量 → **50特徴量**（シンプル化 + 6戦略最適化）

---

## 📊 特徴量最適化計画

### 現状分析（60特徴量）

**問題点**:
1. **冗長性**: ラグ特徴量10個・移動統計量12個は相関が高い可能性
2. **低寄与度**: 交互作用6個の一部はML予測に寄与していない可能性
3. **不足指標**: 6戦略に必要な指標が未実装（Stochastic、MACDシグナル線等）
4. **理論的根拠不明**: 開発過程で自然と形成されたため、各特徴量の必要性が不明確

### 削除候補特徴量（約10-15個）

**ラグ特徴量（10個）**:
- close_lag_1/2/3/5/10: 必要最小限に削減（lag_1/2/5のみ残す = 3個）
- volume_lag_1/2/3: volume_lag_1のみ残す = 1個
- rsi_lag_1 / macd_lag_1: 両方削除（オシレーター系のラグは不要）

**移動統計量（12個）**:
- close_ma_5/10/20: close_ma_20のみ残す（EMA 20と重複削減）
- close_std_5/10/20: close_std_20のみ残す
- close_max_5/10/20: close_max_20のみ残す
- close_min_5/10/20: close_min_20のみ残す
- 削減: 12個 → 4個（-8個）

**交互作用特徴量（6個）**:
- Feature Importance低いもの削除（バックテスト後決定）
- 暫定削減: 6個 → 3個（-3個）

**削減合計**: -18個（10+8+0）or -21個（10+8+3）

### 追加必要特徴量（約6-8個）

**6戦略実装に必須**:
1. **stoch_k**: Stochastic %K（14期間）- Stochastic逆張り戦略用
2. **stoch_d**: Stochastic %D（3期間SMA）- Stochastic逆張り戦略用
3. **macd_signal**: MACDシグナル線（9期間EMA）- MACD+EMA戦略用
4. **macd_histogram**: MACDヒストグラム（MACD - Signal）- MACD+EMA戦略用
5. **bb_upper**: ボリンジャーバンド上限（計算済み→特徴量化）- BB Reversal用
6. **bb_lower**: ボリンジャーバンド下限（計算済み→特徴量化）- BB Reversal用

**オプション追加**:
7. **volume_ema**: 出来高EMA（20期間）- 出来高分析強化
8. **atr_ratio**: ATR/Close比率（ボラティリティ正規化）

**追加合計**: +6個（必須）or +8個（オプション含む）

### 最終特徴量数の目標

**パターン1（保守的）**:
- 現在: 60特徴量
- 削減: -18個
- 追加: +6個
- **最終: 48特徴量**（シンプル化優先）

**パターン2（バランス）**:
- 現在: 60特徴量
- 削減: -18個
- 追加: +8個
- **最終: 50特徴量**（6戦略最適化）← **推奨**

**パターン3（拡張）**:
- 現在: 60特徴量
- 削減: -12個（ラグ・移動統計のみ）
- 追加: +8個
- **最終: 56特徴量**（柔軟性維持）

**推奨**: **パターン2（50特徴量）**
- Phase 51.5の教訓（シンプル設計）を遵守
- 6戦略に必要な指標を完備
- MLモデル学習効率向上（特徴量削減効果）

---

## 📋 6戦略詳細仕様

### 1. BB Reversal戦略 詳細

#### 戦略特性

- タイプ: レンジ型・平均回帰戦略
- 活性化条件: BB幅 < 2%・ADX < 20
- 期待勝率: 60-70%
- 期待RR比: 0.5:1-1:1（レンジ型標準）

#### エントリー条件

**SELL信号**:
- BB上限タッチ（bb_position > 0.95）
- RSI > 70（買われすぎ）
- レンジ相場確認（BB幅 < 2%・ADX < 20）

**BUY信号**:
- BB下限タッチ（bb_position < 0.05）
- RSI < 30（売られすぎ）
- レンジ相場確認（BB幅 < 2%・ADX < 20）

#### TP/SL設定

- TP（利確）: BB中央線（平均回帰目標）
- SL（損切）: BB幅の1.5倍（(bb_upper - bb_lower) * 1.5）

#### 必要な指標（すべて既存）

- bb_position - ボリンジャーバンド位置（既存）
- bb_upper / bb_lower / bb_middle - BB上限・下限・中央線（計算可能→特徴量化必要）
- rsi_14 - RSI（既存）
- atr_14 - ATR（既存・SL補正用）
- adx_14 - ADX（既存・レンジ判定用）

#### 実現可能性

⭐⭐⭐⭐⭐ 完全実現可能
- bb_upper/bb_lower: 特徴量化必要（計算済み→追加のみ）
- その他すべての指標が既存
- 参考実装: 既存ATRBased戦略の_analyze_bb_position()

---

### 2. Stochastic逆張り戦略 詳細

#### 戦略特性

- タイプ: レンジ型・モメンタム逆張り戦略
- 活性化条件: レンジ相場（ADX < 20）
- 期待勝率: 55-65%
- 期待RR比: 1.29:1（Phase 51.6基準）

#### エントリー条件

**SELL信号**:
- stoch_k > 80 AND stoch_d > 80（過買い領域）
- %Kが%Dを下抜け（ベアクロス）
- RSI > 65（追加確認）
- ADX < 20（レンジ確認）

**BUY信号**:
- stoch_k < 20 AND stoch_d < 20（過売り領域）
- %Kが%Dを上抜け（ゴールデンクロス）
- RSI < 35（追加確認）
- ADX < 20（レンジ確認）

#### TP/SL設定

- TP: 0.9%（Phase 51.6基準）
- SL: 0.7%（Phase 51.6基準）
- RR比: 1.29:1

#### 必要な指標

- **stoch_k**: Stochastic %K（14期間）**→ 新規追加必要**
- **stoch_d**: Stochastic %D（3期間SMA）**→ 新規追加必要**
- rsi_14: RSI（既存）
- adx_14: ADX（既存）
- atr_14: ATR（既存）

#### 実現可能性

⭐⭐⭐⭐ 実現可能（新規指標2つ追加必要）
- Stochastic計算式はシンプル（%K = (Close - Low14) / (High14 - Low14) × 100）
- %D = %Kの3期間SMA
- 実装期間: 1日（指標実装 + 戦略実装 + テスト）

---

### 3. MACD + EMA Crossover戦略 詳細

#### 戦略特性

- タイプ: トレンド型・トレンドフォロー戦略
- 活性化条件: 強いトレンド（ADX > 25）
- 期待勝率: 50-60%
- 期待RR比: 2.0:1（トレンド相場標準）

#### エントリー条件

**BUY信号**:
- MACDがシグナル線を上抜け（ゴールデンクロス）
- EMA 20 > EMA 50（上昇トレンド確認）
- ADX > 25（強いトレンド確認）
- volume_ratio > 1.1（出来高増加確認）

**SELL信号**:
- MACDがシグナル線を下抜け（デッドクロス）
- EMA 20 < EMA 50（下降トレンド確認）
- ADX > 25（強いトレンド確認）
- volume_ratio > 1.1（出来高増加確認）

#### TP/SL設定

- TP: ATR × 3.0（トレンド追随）
- SL: ATR × 1.5（Phase 51.6基準）
- RR比: 2.0:1

#### 必要な指標

- macd: MACD線（既存）
- **macd_signal**: MACDシグナル線（9期間EMA）**→ 新規追加必要**
- **macd_histogram**: MACDヒストグラム**→ 新規追加必要**
- ema_20: EMA 20期間（既存）
- ema_50: EMA 50期間（既存）
- adx_14: ADX（既存）
- volume_ratio: 出来高比率（既存）
- atr_14: ATR（既存）

#### 実現可能性

⭐⭐⭐⭐⭐ 完全実現可能（計算済み指標の特徴量化のみ）
- MACDシグナル線・ヒストグラムは既に計算済み（technical_indicators.pyで確認）
- 特徴量として追加するのみ
- 実装期間: 1日

---

## 📅 実装スケジュール（7日間）

### Day 1：特徴量分析・冗長特徴量特定（6-8時間）

#### 1. Feature Importance分析実行（2時間）

**実行コマンド**:
```python
# Feature Importance分析スクリプト実行
python scripts/ml/analyze_feature_importance.py

# または既存MLモデルから取得
import joblib
model = joblib.load('models/production/ensemble_full.pkl')
# LightGBM feature importance取得
lgb_model = model.models['lightgbm']
importance = lgb_model.feature_importances_
features = model.feature_names
for feat, imp in sorted(zip(features, importance), key=lambda x: x[1], reverse=True):
    print(f"{feat}: {imp:.4f}")
```

**分析内容**:
- 全60特徴量のFeature Importance取得
- 重要度下位20%の特徴量リストアップ
- 相関行列分析（0.9以上の高相関特徴量特定）
- ラグ特徴量・移動統計量の寄与度確認

#### 2. 削除対象特徴量の最終決定（2時間）

**削除基準**:
1. Feature Importance < 0.01（ほぼ寄与なし）
2. 相関係数 > 0.9（冗長性高い）
3. 理論的根拠が薄い（lag_3/10、短期移動統計等）

**削除リスト作成**:
```python
# 削除対象特徴量リスト
features_to_remove = [
    # ラグ特徴量削除（10→4個：-6個）
    'close_lag_3', 'close_lag_10',
    'volume_lag_2', 'volume_lag_3',
    'rsi_lag_1', 'macd_lag_1',

    # 移動統計量削除（12→4個：-8個）
    'close_ma_5', 'close_ma_10',
    'close_std_5', 'close_std_10',
    'close_max_5', 'close_max_10',
    'close_min_5', 'close_min_10',

    # 交互作用削除（Feature Importance低いもの3個）
    # → Feature Importance分析後に決定
]
```

#### 3. 追加特徴量の実装仕様策定（2時間）

**追加リスト作成**:
```python
# 追加特徴量リスト
features_to_add = [
    # BB Reversal用（+2個）
    ('bb_upper', 'float', 'BB上限（既に計算済み→特徴量化のみ）'),
    ('bb_lower', 'float', 'BB下限（既に計算済み→特徴量化のみ）'),

    # Stochastic Reversal用（+2個）
    ('stoch_k', 'float', 'Stochastic %K（14期間・新規計算必要）'),
    ('stoch_d', 'float', 'Stochastic %D（%Kの3期間SMA・新規計算必要）'),

    # MACD + EMA Crossover用（+2個）
    ('macd_signal', 'float', 'MACDシグナル線（既に計算済み→特徴量化のみ）'),
    ('macd_histogram', 'float', 'MACDヒストグラム（既に計算済み→特徴量化のみ）'),

    # オプション（+2個）
    ('volume_ema', 'float', '出来高EMA 20期間（新規計算必要）'),
    ('atr_ratio', 'float', 'ATR/Close比率（既存ATRから計算）'),
]
```

**実装詳細設計**:
- technical_indicators.pyの修正箇所特定
- Stochastic計算ロジック設計（talib使用可能性確認）
- 単体テスト計画（15テストケース）

#### 4. Day 1レポート作成（30分）

**レポート内容**:
- Feature Importance分析結果サマリー
- 削除対象特徴量リスト（最終版：18個）
- 追加特徴量リスト（最終版：6-8個）
- 最終特徴量数確定（48 or 50 or 56）

---

### Day 2：特徴量削除・追加実装（6-8時間）

#### 1. technical_indicators.py修正（4時間）

**ファイル**: `src/features/technical_indicators.py`

**実装内容**:

```python
# 1. 既存特徴量削除（コメントアウト or 完全削除）
# 削除: close_lag_3/10, volume_lag_2/3, rsi_lag_1, macd_lag_1
# 削除: close_ma_5/10, close_std_5/10, close_max_5/10, close_min_5/10
# 削除: 交互作用3個（Feature Importance低いもの）

# 2. 新規特徴量追加
def calculate_stochastic(df: pd.DataFrame, period: int = 14, smooth_k: int = 3) -> pd.DataFrame:
    """
    Stochastic Oscillator計算
    """
    low_min = df['low'].rolling(window=period).min()
    high_max = df['high'].rolling(window=period).max()

    # %K計算
    df['stoch_k'] = 100 * (df['close'] - low_min) / (high_max - low_min)

    # %D計算（%Kの3期間SMA）
    df['stoch_d'] = df['stoch_k'].rolling(window=smooth_k).mean()

    return df

def calculate_macd_extended(df: pd.DataFrame) -> pd.DataFrame:
    """
    MACD拡張（シグナル線・ヒストグラム追加）
    """
    # 既存MACD計算
    ema_12 = df['close'].ewm(span=12, adjust=False).mean()
    ema_26 = df['close'].ewm(span=26, adjust=False).mean()
    df['macd'] = ema_12 - ema_26

    # シグナル線追加（9期間EMA）
    df['macd_signal'] = df['macd'].ewm(span=9, adjust=False).mean()

    # ヒストグラム追加
    df['macd_histogram'] = df['macd'] - df['macd_signal']

    return df

def calculate_bb_extended(df: pd.DataFrame, period: int = 20, std: float = 2.0) -> pd.DataFrame:
    """
    ボリンジャーバンド拡張（上限・下限を特徴量化）
    """
    bb_middle = df['close'].rolling(window=period).mean()
    bb_std = df['close'].rolling(window=period).std()

    df['bb_upper'] = bb_middle + (bb_std * std)
    df['bb_lower'] = bb_middle - (bb_std * std)
    df['bb_middle'] = bb_middle

    return df

def calculate_volume_ema(df: pd.DataFrame, period: int = 20) -> pd.DataFrame:
    """
    出来高EMA計算
    """
    df['volume_ema'] = df['volume'].ewm(span=period, adjust=False).mean()
    return df

def calculate_atr_ratio(df: pd.DataFrame) -> pd.DataFrame:
    """
    ATR/Close比率計算（ボラティリティ正規化）
    """
    df['atr_ratio'] = df['atr_14'] / df['close']
    return df
```

**統合**:
```python
def calculate_all_features(df: pd.DataFrame) -> pd.DataFrame:
    """
    全特徴量計算（50特徴量版）
    """
    # ... 既存計算 ...

    # 新規特徴量追加
    df = calculate_stochastic(df)
    df = calculate_macd_extended(df)
    df = calculate_bb_extended(df)
    df = calculate_volume_ema(df)
    df = calculate_atr_ratio(df)

    # 削除対象を除外してreturn
    features_to_keep = [
        'close', 'volume', 'rsi_14', 'macd', 'macd_signal', 'macd_histogram',
        # ... 50特徴量リスト ...
    ]

    return df[features_to_keep]
```

#### 2. 単体テスト作成（2時間）

**ファイル**: `tests/unit/features/test_technical_indicators.py`

**追加テストケース（15個）**:
```python
def test_calculate_stochastic():
    """Stochastic計算テスト"""
    df = pd.DataFrame({
        'close': [100, 105, 103, 107, 110],
        'high': [102, 108, 105, 109, 112],
        'low': [98, 103, 101, 105, 108],
    })
    result = calculate_stochastic(df)
    assert 'stoch_k' in result.columns
    assert 'stoch_d' in result.columns
    assert 0 <= result['stoch_k'].iloc[-1] <= 100

def test_calculate_macd_extended():
    """MACD拡張テスト"""
    # ... テスト実装 ...

def test_calculate_bb_extended():
    """BB拡張テスト"""
    # ... テスト実装 ...

# ... 残り12テストケース ...
```

#### 3. 品質チェック（1時間）

**実行コマンド**:
```bash
bash scripts/testing/checks.sh
```

**期待結果**:
- テスト数: 1,153 → 約1,168テスト（+15）
- カバレッジ: 68.77%維持
- flake8・black・isort: 全てPASS

#### 4. 特徴量リスト更新（30分）

**更新ファイル**:
- `src/ml/feature_lists.py`（50特徴量リスト定義）
- `config/core/features.yaml`（特徴量設定）
- `docs/features.md`（特徴量ドキュメント）

---

### Day 3：BB Reversal戦略実装（6-8時間）

#### 1. StrategyType定数追加（5分）

**ファイル**: `src/strategies/utils/strategy_utils.py`

```python
class StrategyType(str, Enum):
    # ... 既存定数 ...
    BB_REVERSAL = "bb_reversal"  # 新規追加
```

#### 2. BB Reversal戦略実装（3.5時間）

**ファイル**: `src/strategies/implementations/bb_reversal.py`（約250行）

**実装内容**:
```python
from typing import Any, Dict, List, Optional
import pandas as pd
from ..base.strategy_base import StrategyBase, StrategySignal
from ..strategy_registry import StrategyRegistry
from ..utils import StrategyType, SignalBuilder, EntryAction
from ...core.config.threshold_manager import get_threshold

@StrategyRegistry.register(name="BBReversal", strategy_type=StrategyType.BB_REVERSAL)
class BBReversalStrategy(StrategyBase):
    def __init__(self, config: Optional[Dict[str, Any]] = None):
        default_config = {
            "min_confidence": get_threshold("strategies.bb_reversal.min_confidence", 0.30),
            "hold_confidence": get_threshold("strategies.bb_reversal.hold_confidence", 0.25),
            "bb_width_threshold": get_threshold("strategies.bb_reversal.bb_width_threshold", 0.02),
            "rsi_overbought": get_threshold("strategies.bb_reversal.rsi_overbought", 70),
            "rsi_oversold": get_threshold("strategies.bb_reversal.rsi_oversold", 30),
            "bb_upper_threshold": get_threshold("strategies.bb_reversal.bb_upper_threshold", 0.95),
            "bb_lower_threshold": get_threshold("strategies.bb_reversal.bb_lower_threshold", 0.05),
            "adx_range_threshold": get_threshold("strategies.bb_reversal.adx_range_threshold", 20),
            "sl_multiplier": get_threshold("strategies.bb_reversal.sl_multiplier", 1.5),
        }
        merged_config = {**default_config, **(config or {})}
        super().__init__(name="BBReversal", config=merged_config)

    def analyze(self, df: pd.DataFrame, multi_timeframe_data: Optional[Dict[str, pd.DataFrame]] = None) -> StrategySignal:
        # 1. データ検証
        required_features = self.get_required_features()
        if df is None or df.empty or not all(f in df.columns for f in required_features):
            return self._create_hold_signal("insufficient_data", df)

        # 2. 最新データ取得
        latest = df.iloc[-1]
        current_price = latest['close']

        # 3. レンジ相場判定
        if not self._is_range_market(df):
            return self._create_hold_signal("not_range_market", df)

        # 4. BB反転シグナル分析
        decision = self._analyze_bb_reversal_signal(df)

        # 5. SignalBuilder使用
        return SignalBuilder.create_signal_with_risk_management(
            strategy_name=self.name,
            decision=decision,
            current_price=current_price,
            df=df,
            config=self.config,
            strategy_type=StrategyType.BB_REVERSAL,
            multi_timeframe_data=multi_timeframe_data,
        )

    def get_required_features(self) -> List[str]:
        return [
            'close', 'bb_position', 'bb_upper', 'bb_lower', 'bb_middle',
            'rsi_14', 'adx_14', 'atr_14'
        ]

    def _calculate_bb_width(self, df: pd.DataFrame) -> float:
        """BB幅計算（上限-下限）/ 現在価格"""
        latest = df.iloc[-1]
        bb_width = (latest['bb_upper'] - latest['bb_lower']) / latest['close']
        return bb_width

    def _is_range_market(self, df: pd.DataFrame) -> bool:
        """レンジ相場判定（BB幅 < 2%・ADX < 20）"""
        bb_width = self._calculate_bb_width(df)
        adx = df.iloc[-1]['adx_14']

        return (bb_width < self.config['bb_width_threshold'] and
                adx < self.config['adx_range_threshold'])

    def _analyze_bb_reversal_signal(self, df: pd.DataFrame) -> Dict[str, Any]:
        """BB反転シグナル分析"""
        latest = df.iloc[-1]
        bb_position = latest['bb_position']
        rsi = latest['rsi_14']

        # SELL信号（BB上限タッチ + RSI買われすぎ）
        if (bb_position > self.config['bb_upper_threshold'] and
            rsi > self.config['rsi_overbought']):
            return {
                'action': EntryAction.SELL,
                'confidence': 0.40,
                'strength': (bb_position - 0.5) * 2.0,
                'reason': f'BB reversal SELL (BB pos: {bb_position:.2f}, RSI: {rsi:.1f})',
            }

        # BUY信号（BB下限タッチ + RSI売られすぎ）
        elif (bb_position < self.config['bb_lower_threshold'] and
              rsi < self.config['rsi_oversold']):
            return {
                'action': EntryAction.BUY,
                'confidence': 0.40,
                'strength': (0.5 - bb_position) * 2.0,
                'reason': f'BB reversal BUY (BB pos: {bb_position:.2f}, RSI: {rsi:.1f})',
            }

        # HOLD信号
        else:
            return {
                'action': EntryAction.HOLD,
                'confidence': self.config['hold_confidence'],
                'strength': 0.0,
                'reason': 'BB reversal no signal',
            }
```

#### 3. 設定ファイル更新（15分）

**config/strategies.yaml**:
```yaml
strategies:
  bb_reversal:
    enabled: true
    class_name: "BBReversal"
    module_path: "src.strategies.implementations.bb_reversal"
    strategy_type: "bb_reversal"
    weight: 0.17  # 6戦略均等配分
    priority: 4
    description: "BB Reversal戦略 - レンジ相場での平均回帰戦略"
    config_section: "strategies.bb_reversal"
```

**config/core/thresholds.yaml**:
```yaml
strategies:
  bb_reversal:
    min_confidence: 0.30
    hold_confidence: 0.25
    bb_width_threshold: 0.02
    rsi_overbought: 70
    rsi_oversold: 30
    bb_upper_threshold: 0.95
    bb_lower_threshold: 0.05
    adx_range_threshold: 20
    sl_multiplier: 1.5
```

#### 4. ユニットテスト作成（2時間）

**ファイル**: `tests/unit/strategies/implementations/test_bb_reversal.py`（約200行）

**テストケース（15個）**:
```python
import pytest
import pandas as pd
from src.strategies.implementations.bb_reversal import BBReversalStrategy
from src.strategies.utils import EntryAction

@pytest.fixture
def strategy():
    return BBReversalStrategy()

@pytest.fixture
def range_market_df():
    return pd.DataFrame({
        'close': [10000] * 10,
        'bb_position': [0.5] * 10,
        'bb_upper': [10200] * 10,
        'bb_lower': [9800] * 10,
        'bb_middle': [10000] * 10,
        'rsi_14': [50] * 10,
        'adx_14': [15] * 10,
        'atr_14': [100] * 10,
    })

def test_strategy_initialization(strategy):
    """戦略初期化テスト"""
    assert strategy.name == "BBReversal"
    assert 'min_confidence' in strategy.config

def test_calculate_bb_width(strategy, range_market_df):
    """BB幅計算テスト"""
    bb_width = strategy._calculate_bb_width(range_market_df)
    assert bb_width == pytest.approx(0.04, rel=1e-2)

def test_is_range_market_true(strategy, range_market_df):
    """レンジ相場判定（True）"""
    assert strategy._is_range_market(range_market_df) is True

def test_analyze_sell_signal(strategy, range_market_df):
    """BB上限SELL信号テスト"""
    df = range_market_df.copy()
    df.loc[df.index[-1], 'bb_position'] = 0.97
    df.loc[df.index[-1], 'rsi_14'] = 75

    signal = strategy.analyze(df)
    assert signal.action == EntryAction.SELL
    assert signal.confidence >= 0.30

def test_analyze_buy_signal(strategy, range_market_df):
    """BB下限BUY信号テスト"""
    df = range_market_df.copy()
    df.loc[df.index[-1], 'bb_position'] = 0.03
    df.loc[df.index[-1], 'rsi_14'] = 25

    signal = strategy.analyze(df)
    assert signal.action == EntryAction.BUY
    assert signal.confidence >= 0.30

# ... 残り10テストケース ...
```

#### 5. 品質チェック（10分）

```bash
bash scripts/testing/checks.sh
# 期待: 1,168 → 1,183テスト（+15）
```

#### 6. 個別バックテスト実行（1時間）

**実行コマンド**:
```bash
# BB Reversal単体性能測定
# config/strategies.yamlで他戦略無効化
python main.py --mode backtest
```

**評価基準**:
- ✅ レンジ相場勝率 ≥ 55%
- ✅ 総損益 > 0円
- ✅ 最大DD < 20%

---

### Day 4：Stochastic逆張り戦略実装（6-8時間）

#### 実装内容（Day 3と同様のパターン）

1. **StrategyType定数追加**（5分）
   - `STOCHASTIC_REVERSAL = "stochastic_reversal"`

2. **戦略実装**（3.5時間）
   - ファイル: `src/strategies/implementations/stochastic_reversal.py`
   - クラス名: `StochasticReversalStrategy`
   - エントリー条件: stoch_k/d クロスオーバー + RSI確認 + ADX < 20

3. **設定ファイル更新**（15分）
   - config/strategies.yaml
   - config/core/thresholds.yaml

4. **ユニットテスト作成**（2時間）
   - `tests/unit/strategies/implementations/test_stochastic_reversal.py`
   - 15テストケース

5. **品質チェック**（10分）
   - `bash scripts/testing/checks.sh`
   - 期待: 1,183 → 1,198テスト（+15）

6. **個別バックテスト実行**（1時間）
   - Stochastic Reversal単体性能測定
   - 評価基準: 勝率≥55%、総損益>0、最大DD<20%

---

### Day 5：MACD + EMA Crossover戦略実装（6-8時間）

#### 実装内容（Day 3と同様のパターン）

1. **StrategyType定数追加**（5分）
   - `MACD_EMA_CROSSOVER = "macd_ema_crossover"`

2. **戦略実装**（3.5時間）
   - ファイル: `src/strategies/implementations/macd_ema_crossover.py`
   - クラス名: `MACDEMACrossoverStrategy`
   - エントリー条件: MACDクロス + EMA 20/50クロス + ADX > 25 + volume増加

3. **設定ファイル更新**（15分）
   - config/strategies.yaml
   - config/core/thresholds.yaml

4. **ユニットテスト作成**（2時間）
   - `tests/unit/strategies/implementations/test_macd_ema_crossover.py`
   - 15テストケース

5. **品質チェック**（10分）
   - `bash scripts/testing/checks.sh`
   - 期待: 1,198 → 1,213テスト（+15）

6. **個別バックテスト実行**（1時間）
   - MACD + EMA Crossover単体性能測定
   - 評価基準: 勝率≥50%、RR比≥1.5:1、総損益>0

---

### Day 6：6戦略統合バックテスト（6-8時間）

#### 1. 全戦略有効化設定（15分）

**config/strategies.yaml更新**:
```yaml
strategies:
  atr_based:
    enabled: true
    weight: 0.17
  donchian_channel:
    enabled: true
    weight: 0.17
  adx_trend_strength:
    enabled: true
    weight: 0.17
  bb_reversal:
    enabled: true
    weight: 0.17
  stochastic_reversal:
    enabled: true
    weight: 0.17
  macd_ema_crossover:
    enabled: true
    weight: 0.15  # 6戦略均等配分（合計1.00）
```

#### 2. 統合バックテスト実行（3時間）

**実行コマンド**:
```bash
# データ確認
wc -l src/backtest/data/historical/btc_jpy_4h.csv
wc -l src/backtest/data/historical/btc_jpy_15m.csv

# 6戦略統合バックテスト実行
python main.py --mode backtest
```

**実行回数**: 3回（安定性確認）

#### 3. レジーム別性能分析（2時間）

**分析項目**:
- レンジ相場時の勝率・損益
- トレンド相場時の勝率・損益
- 各戦略の寄与度分析
- Phase 50.9（3戦略）との比較

**分析スクリプト**:
```python
import json
import pandas as pd

# バックテスト結果読み込み
with open('src/backtest/logs/backtest_latest.json', 'r') as f:
    results = json.load(f)

# レジーム別分析
regime_analysis = {
    'tight_range': {
        'trades': [],
        'win_rate': 0.0,
        'total_pnl': 0.0,
    },
    'trending': {
        'trades': [],
        'win_rate': 0.0,
        'total_pnl': 0.0,
    }
}

# トレード履歴からレジーム分類
for trade in results['trade_tracker']['trades']:
    regime = trade.get('regime', 'unknown')
    if regime in regime_analysis:
        regime_analysis[regime]['trades'].append(trade)

# 勝率・損益計算
for regime, data in regime_analysis.items():
    wins = sum(1 for t in data['trades'] if t['pnl'] > 0)
    total = len(data['trades'])
    data['win_rate'] = wins / total if total > 0 else 0
    data['total_pnl'] = sum(t['pnl'] for t in data['trades'])

    print(f"\n{regime}相場:")
    print(f"  取引数: {total}")
    print(f"  勝率: {data['win_rate']:.2%}")
    print(f"  総損益: ¥{data['total_pnl']:,.0f}")
```

#### 4. Phase 50.9比較分析（1.5時間）

**比較指標**:
| 指標            | Phase 50.9 (3戦略) | Phase 51.7 (6戦略) | 改善率   |
|---------------|-------------------|-------------------|---------|
| 総損益          | ベースライン            | 目標: +20-30%      | +20-30% |
| 勝率            | XX%               | 目標: +5-10%       | +5-10%  |
| 最大DD          | XX%               | 目標: -5-10%       | -5-10%  |
| Profit Factor  | X.XX              | 目標: +0.2-0.5     | +0.2-0.5|
| レンジ相場勝率      | XX%               | 目標: +10-15%      | +10-15% |
| トレンド相場勝率     | XX%               | 目標: +3-5%        | +3-5%   |

#### 5. matplotlib可視化分析（1時間）

**グラフ確認**:
- エクイティカーブ比較（Phase 50.9 vs 51.7）
- 損益分布ヒストグラム
- ドローダウンチャート
- 戦略別寄与度円グラフ

#### 6. 統合レポート作成（30分）

**レポート内容**:
- Phase 51.7統合バックテスト結果サマリー
- レジーム別性能分析
- Phase 50.9比較表
- 改善提案（Phase 51.8への引き継ぎ事項）

---

### Day 7：MLモデル再学習・最終検証・Git Commit（6-8時間）

#### 1. 50特徴量対応MLモデル再学習（3時間）

**実行コマンド**:
```bash
# MLモデル訓練スクリプト実行
python scripts/ml/train_ensemble_model.py \
    --features 50 \
    --data src/backtest/data/historical/btc_jpy_4h.csv \
    --output models/production/ensemble_full.pkl

# Basic モデル訓練（戦略信号なし: 44特徴量）
python scripts/ml/train_ensemble_model.py \
    --features 44 \
    --no-strategy-signals \
    --data src/backtest/data/historical/btc_jpy_4h.csv \
    --output models/production/ensemble_basic.pkl
```

**訓練データ期間**: 180日間（Phase 50.9と同じ）

**検証内容**:
- F1スコア ≥ 0.56（Phase 50.9基準維持）
- 交差検証スコア安定性確認
- Feature Importance上位20特徴量確認

#### 2. 統合テスト実行（1.5時間）

**ペーパートレード短期実行**:
```bash
# ペーパートレード1時間実行
bash scripts/management/run_safe.sh local paper
# 1時間稼働・6戦略正常動作確認
```

**確認項目**:
- 6戦略すべてロード成功
- ML予測正常動作（50特徴量）
- Graceful Degradation動作確認（ensemble_basic.pklフォールバック）
- エラーなし・メモリリークなし

#### 3. ドキュメント更新（1.5時間）

**更新ファイル**:
1. **docs/開発履歴/Phase_51.7.md**（新規作成）
   - 実装内容詳細
   - バックテスト結果
   - Phase 50.9比較分析

2. **README.md**（6戦略記載）
   ```markdown
   ## 戦略構成（6戦略）

   **レンジ型（3戦略）**:
   - ATRBased（既存）
   - BB Reversal（Phase 51.7新規）
   - Stochastic Reversal（Phase 51.7新規）

   **トレンド型（3戦略）**:
   - DonchianChannel（既存）
   - ADXTrendStrength（既存）
   - MACD + EMA Crossover（Phase 51.7新規）
   ```

3. **CLAUDE.md**（Phase 51.7完了記載）
   ```markdown
   **Phase 51.7完了内容**（2025/11/05）:
   - 6戦略実装完了（レンジ3・トレンド3）
   - 特徴量最適化完了（60→50特徴量）
   - MLモデル再学習完了（50特徴量対応）
   - Phase 50.9比+20-30%改善達成
   ```

4. **docs/開発計画/ToDo.md**（Phase 51.7完了チェック）

#### 4. 品質チェック最終確認（30分）

```bash
bash scripts/testing/checks.sh
```

**最終期待結果**:
- テスト数: 約1,213テスト（+60テスト）
- カバレッジ: 68%以上維持
- flake8・black・isort: 全てPASS
- 実行時間: 約70秒

#### 5. Git Commit + Push（30分）

**コミットメッセージ例**:
```bash
git add -A
git commit -m "$(cat <<'EOF'
feat: Phase 51.7完了 - 6戦略実装 + 特徴量最適化（60→50特徴量）

## 実装内容
- 新戦略追加: BB Reversal・Stochastic Reversal・MACD+EMA Crossover
- 特徴量最適化: 60→50特徴量（冗長特徴量削除・必須指標追加）
- MLモデル再学習: 50特徴量対応ensemble_full.pkl/basic.pkl

## 成果
- 戦略構成: 6戦略（レンジ3・トレンド3）
- テスト: 1,213テスト100%成功（+60テスト）
- カバレッジ: 68%維持
- バックテスト: Phase 50.9比+20-30%改善達成

## バックテスト結果
- 総損益: Phase 50.9比+XX%
- 勝率: Phase 50.9比+X%
- レンジ相場勝率: Phase 50.9比+XX%
- 最大DD: Phase 50.9比-X%

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"

git push origin main
```

#### 6. CI/CD確認（30分）

```bash
# GitHub Actions成功確認
gh run list --limit 1
gh run view

# デプロイ成功確認（GCP Cloud Run）
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1
```

---

## 📁 実装ファイル一覧

### 新規作成（9ファイル）

1. **src/strategies/implementations/bb_reversal.py**（約250行）
2. **src/strategies/implementations/stochastic_reversal.py**（約250行）
3. **src/strategies/implementations/macd_ema_crossover.py**（約250行）
4. **tests/unit/strategies/implementations/test_bb_reversal.py**（約200行）
5. **tests/unit/strategies/implementations/test_stochastic_reversal.py**（約200行）
6. **tests/unit/strategies/implementations/test_macd_ema_crossover.py**（約200行）
7. **docs/開発履歴/Phase_51.7.md**（開発履歴）
8. **scripts/ml/analyze_feature_importance.py**（特徴量分析スクリプト）
9. **docs/features.md**（特徴量ドキュメント）

### 修正ファイル（10ファイル）

1. **src/features/technical_indicators.py**（特徴量削除・追加: 60→50特徴量）
2. **src/ml/feature_lists.py**（50特徴量リスト定義）
3. **src/strategies/utils/strategy_utils.py**（StrategyType 3つ追加）
4. **config/strategies.yaml**（3戦略設定追加）
5. **config/core/thresholds.yaml**（3戦略閾値追加）
6. **config/core/features.yaml**（特徴量設定更新）
7. **tests/unit/features/test_technical_indicators.py**（+15テスト）
8. **README.md**（6戦略記載）
9. **CLAUDE.md**（Phase 51.7完了記載）
10. **docs/開発計画/ToDo.md**（Phase 51.7完了チェック）

### モデルファイル（2ファイル更新）

1. **models/production/ensemble_full.pkl**（50特徴量対応）
2. **models/production/ensemble_basic.pkl**（44特徴量対応・戦略信号なし）

---

## ✅ 成果物・品質基準

### 実装成果

- **新戦略**: 3戦略追加（BB Reversal・Stochastic Reversal・MACD+EMA Crossover）
- **戦略構成**: 6戦略（レンジ3・トレンド3）
- **特徴量**: 50特徴量（60→50特徴量最適化）
- **MLモデル**: 50特徴量対応（ensemble_full.pkl/basic.pkl）

### 品質保証

- **テスト成功率**: 100%（約1,213テスト・+60テスト）
- **カバレッジ**: 68%以上維持
- **コード品質**: flake8・black・isort全てPASS
- **CI/CD**: GitHub Actions成功

### バックテスト合格基準

- ✅ Phase 50.9比 総損益 +20-30%
- ✅ Phase 50.9比 勝率 +5-10%
- ✅ Phase 50.9比 レンジ相場勝率 +10-15%
- ✅ 最大DD < 20%

### ドキュメント

- Phase 51.7開発履歴完備
- バックテスト評価レポート（レジーム別分析含む）
- 特徴量ドキュメント（50特徴量詳細）
- README/CLAUDE.md更新

---

## 💡 Phase 51.8以降との連携

### Phase 51.8: レジーム別戦略重み最適化

**レンジ相場時の重み調整目標**:
- ATRBased: 30%
- BB Reversal: 35%
- Stochastic Reversal: 35%
- DonchianChannel: 0%
- ADXTrendStrength: 0%
- MACD+EMA Crossover: 0%

**トレンド相場時の重み調整目標**:
- DonchianChannel: 35%
- ADXTrendStrength: 30%
- MACD+EMA Crossover: 35%
- ATRBased: 0%
- BB Reversal: 0%
- Stochastic Reversal: 0%

### Phase 51.9: ML統合最適化（レジーム別）

- レジーム別ML信頼度閾値調整
- レンジ相場: min_ml_confidence: 0.40
- トレンド相場: min_ml_confidence: 0.50

---

## 📚 参考ドキュメント

### 既存コード

- `src/strategies/implementations/atr_based.py` - BB分析参考
- `src/strategies/implementations/adx_trend_strength.py` - ADX判定参考
- `src/strategies/implementations/donchian_channel.py` - Registry登録参考
- `tests/unit/strategies/implementations/test_atr_based.py` - テスト参考
- `src/features/technical_indicators.py` - 特徴量計算参考

### システムドキュメント

- `docs/開発計画/ToDo.md` - Phase 51.7要件
- `docs/開発履歴/Phase_50.md` - Phase 50完了履歴
- `CLAUDE.md` - 開発ガイド
- `README.md` - システム概要

### 設定ファイル

- `config/strategies.yaml` - 戦略定義
- `config/core/thresholds.yaml` - 閾値設定
- `config/core/features.yaml` - 機能トグル
- `config/core/unified.yaml` - 統合設定

---

## ⚠️ 注意事項

### 実装時の注意点

1. **ハードコード禁止**: すべてget_threshold()で設定取得
2. **SignalBuilder必須**: 手動TP/SL計算禁止・SignalBuilder使用
3. **15m足ATR優先**: multi_timeframe_dataから15m足ATR取得
4. **データ検証**: df.empty・NaN値・特徴量不足チェック必須
5. **テスト網羅**: 最低15個のユニットテスト作成

### バックテスト時の注意点

1. **データ収集確認**: 必ず実行前にwc -lでデータ行数確認
2. **複数回実行**: ベースライン・単体・統合の3パターン必須
3. **結果保存**: JSON・TXT・グラフすべて保存（後で比較）
4. **合格基準厳守**: Phase 50.9比+20-30%改善必須

### Git Commit時の注意点

1. **checks.sh成功必須**: コミット前に必ず実行
2. **コミットメッセージ**: feat形式遵守・詳細成果記載
3. **Co-Authored-By追加**: Claude Code標準フォーマット使用
4. **CI/CD確認**: プッシュ後GitHub Actions成功確認

---

## 🎯 完了条件（Definition of Done）

### 実装完了

- ✅ 3戦略実装完了（BB Reversal・Stochastic Reversal・MACD+EMA Crossover）
- ✅ 特徴量最適化完了（60→50特徴量）
- ✅ StrategyType 3つ追加
- ✅ Registry登録完了
- ✅ strategies.yaml・thresholds.yaml設定追加

### テスト完了

- ✅ ユニットテスト45個作成（各戦略15個）
- ✅ checks.sh 100%成功（1,213テスト）
- ✅ カバレッジ68%以上維持

### バックテスト完了

- ✅ 3戦略個別測定完了
- ✅ 6戦略統合測定完了
- ✅ Phase 50.9比+20-30%改善達成
- ✅ レジーム別性能分析完了

### ドキュメント完了

- ✅ Phase_51.7.md作成
- ✅ バックテスト評価レポート作成
- ✅ 特徴量ドキュメント作成
- ✅ README.md更新（6戦略記載）
- ✅ CLAUDE.md更新（Phase 51.7完了）

### Git完了

- ✅ Git commit作成
- ✅ Git push完了
- ✅ CI/CD成功確認（GitHub Actions）
- ✅ GCP Cloud Run デプロイ成功

---

**📅 作成日**: 2025年11月05日
**📝 更新日**: 2025年11月05日
**✅ ステータス**: 計画立案完了・実装開始準備完了
**⏱ 実装期間**: 7日間（Day 1-7詳細スケジュール策定完了）
