# 暗号資産取引Bot - 未達成タスク一覧

## 📋 このファイルの目的

**使用場面**:
- 未達成開発タスク確認
- 実装優先度の把握
- 進捗管理とタスク追跡

**ルール**:
- **未完了タスクのみ記載**（達成済み: `docs/開発履歴/Phase_40-45.md`参照）
- **実装順序**に沿って記載（Phase 46 → 47 → 48...）
- 定期的にタスク状況を更新

**🎯 2025/10/22更新**: Phase 40-45完了 → 次はPhase 46（デイトレード特化設計）から開始

---

## 🔥 **未達成タスク一覧**（実装優先度順）

---

# 📌 **Phase 46: デイトレード特化設計（3-5日）** ⭐最優先・実装中

## 背景・目的

**Phase 44実装の実運用結果**:
- ❌ TP/SL統合機能が本番環境で動作していない（期待2注文 → 実際21注文）
- ❌ トレーリングストップが全く機能していない
- ❌ SL注文が「非アクティブ」状態（損切り保護なし）
- ⚠️ ショート偏重問題（全エントリーがショート）

**設計思想の見直し**:
- 15分足デイトレード（1-3時間保有）には、トレーリングSTOP（数日保有向け）は不要
- TP/SL統合も複雑すぎて動作不安定 → シンプルな個別管理に戻す
- 小さな利益を積み重ねるスキャルピング型botへ転換

**Phase 46目標**:
- シンプル化（-400-500行コード削減）
- デイトレード特化設計（SL 1.5%・TP 2.0%・クールダウン15分）
- 月利3-5%目標（現実的）
- 動作安定性向上

---

## Phase 46実装タスク

### Phase 46.1: 本番環境デバッグ・原因特定（1日・3-4時間）⭐最優先

- [ ] **Cloud Run環境確認**:
  ```bash
  # 現在の本番環境リビジョン確認
  gcloud run services describe crypto-bot-service-prod \
    --region=asia-northeast1 \
    --format="value(spec.template.metadata.name)"

  # 最新リビジョン確認
  gcloud run revisions list \
    --service=crypto-bot-service-prod \
    --region=asia-northeast1 \
    --limit=3
  ```

- [ ] **本番thresholds.yaml設定確認**:
  ```bash
  # 本番環境のログで設定値確認
  gcloud logging read \
    "resource.type=cloud_run_revision AND textPayload:\"tp_sl_mode\"" \
    --limit=10
  ```

- [ ] **Phase 44コードデプロイ確認**:
  - Git履歴確認（Phase 44コミット）
  - GitHub Actions CI/CDログ確認
  - デプロイ成功/失敗確認

- [ ] **ローカルペーパートレードテスト**:
  ```bash
  # Phase 44設定でローカル実行
  bash scripts/management/run_safe.sh local paper
  ```
  - TP/SL統合が動作するか確認
  - ログ出力で設定値確認

**期待結果**: Phase 44設定が反映されていない原因特定（デプロイ問題 or 設定問題 or コードバグ）

---

### Phase 46.2: デイトレード特化設計実装（1日・4-6時間）

#### タスク1: thresholds.yaml設定変更

**変更内容**:
```yaml
# Phase 46.2: デイトレード特化設定

# 1. トレーリングストップ完全無効化（Phase 42.2機能削除）
trailing_stop:
  enabled: false

# 2. TP/SL個別管理に戻す（Phase 42.1機能削除）
position_management:
  tp_sl_mode: "individual"  # consolidated → individual

# 3. デイトレード向けTP/SL設定（小さな利益を狙う）
risk_management:
  sl_min_distance_ratio: 0.015  # 1.5% SL（1万円で最大損失150円）
  tp_min_profit_ratio: 0.02     # 2.0% TP（小さな利益を確実に）
  tp_default_ratio: 1.33        # RR比1.33:1（1.5% SL / 2% TP）

# 4. 取引頻度向上（月利3-5%目標）
strategies:
  cooldown:
    enabled: true
    base_minutes: 15  # 60 → 15（クールダウン大幅短縮）

# 5. ML統合調整
ml:
  strategy_integration:
    ml_weight: 0.3
    strategy_weight: 0.7
    min_ml_confidence: 0.5  # 0.45 → 0.5（少し厳格化）
```

**設定の意図**:
- SL 1.5%: 1万円証拠金で最大損失150円（Phase 44: 200円より保守的）
- TP 2.0%: 小さな利益を確実に取る（Phase 44: 3.0%より現実的）
- クールダウン15分: 取引機会増加（1日20-30回 → 月利3-5%目標）
- RR比1.33: 勝率60%なら利益が出る設計

#### タスク2: 不要コード完全削除（-400-500行削減）

**削除対象**:

1. **トレーリングストップコード削除**:
   - `src/trading/execution/executor.py:811-992`（182行削除）
   - トレーリングSL監視ロジック完全削除

2. **TP/SL統合コード削除**:
   - `src/trading/position/tracker.py:489-538`（50行削除）
   - 統合ID管理・状態永続化コード削除
   - `src/core/state/consolidated_tp_sl_state.json`削除

3. **stop_manager.py簡略化**:
   - トレーリングSTOP関連メソッド削除
   - 統合TP/SL関連メソッド削除

4. **order_strategy.py簡略化**:
   - 統合TP/SL価格計算ロジック削除
   - シンプルな個別TP/SL計算のみ残す

5. **テストコード削除**:
   - トレーリングSTOP関連テスト削除（約50テスト）
   - TP/SL統合関連テスト削除（約60テスト）

**期待結果**:
- コード量: -400-500行削除
- テスト数: 1,159 → 1,050前後（-100テスト）
- 保守性・理解しやすさ大幅向上

---

### Phase 46.3: テスト修正・品質チェック（0.5日・2-3時間）

- [ ] 削除コードに依存するテスト修正
- [ ] `bash scripts/testing/checks.sh` 実行
- [ ] 1,050テスト100%成功確認
- [ ] カバレッジ維持確認（65-70%目標）

---

### Phase 46.4: ローカル検証・本番デプロイ（1日・3-4時間）

**タスク1: ローカルペーパートレード検証**:
```bash
# Phase 46.2設定でローカル実行（30分-1時間）
bash scripts/management/run_safe.sh local paper
```

**検証項目**:
- TP/SL個別配置確認
- SL 1.5%・TP 2.0%設定確認
- クールダウン15分動作確認
- トレーリングSTOP無効化確認

**タスク2: 本番デプロイ**:
```bash
git add .
git commit -m "feat: Phase 46.2 デイトレード特化設計実装"
git push origin main
```

**タスク3: 本番環境監視（24時間）**:
- Discord通知確認
- bitbank取引履歴確認
- TP/SL注文確認（個別配置確認）

---

### Phase 46.5: 効果測定・最終調整（1週間継続監視）

**測定項目**:
1. 取引回数: 1日何回取引できるか
2. 勝率: 実際の勝率（目標60%以上）
3. 平均利益: 1取引あたりの利益
4. 月利換算: 実際の月利（目標3-5%）
5. 最大ドローダウン: 最大連敗時の損失
6. **ショート/ロング比率**: ショート偏重問題の調査

**調整候補**:
- クールダウン時間調整（15分 → 10分 or 20分）
- TP/SL比率調整（RR比1.33 → 1.5）
- ML統合閾値調整
- ショート偏重バイアス修正（ML学習データ・戦略パラメータ確認）

---

## Phase 46期待効果

**メリット**:
- ✅ シンプル化: -400-500行削減・保守性+50%向上
- ✅ デイトレード特化: 取引頻度+200-300%・月利3-5%目標
- ✅ 動作安定性: Phase 44問題の根本解決
- ✅ デバッグ容易性: シンプル設計で原因特定が容易

**デメリット**:
- ⚠️ Phase 42成果の破棄（注文数削減91.7%の一部を失う）
- ⚠️ 大きなトレンド時の機会損失（TP 2%で利確）
- ⚠️ 取引回数増加 → 手数料増加

**現実的な期待値**:
- 取引回数: 1日20-30回
- 勝率: 55-60%（ML統合効果）
- 平均利益: +0.5-1.0%
- **月利: 3-5%**（現実的目標）
- 年利: 44-80%（複利なし）

**実装場所**:
- `config/core/thresholds.yaml`
- `src/trading/execution/executor.py`
- `src/trading/position/tracker.py`
- `src/trading/execution/stop_manager.py`
- `src/trading/execution/order_strategy.py`

---

# 🔴 **Phase 47: 確定申告対応システム（1週間）** 法的必須

## 背景・目的

**法的要件**: 暗号資産取引の確定申告義務
- 年間20万円以上の利益で確定申告必須
- 期限: 2025年3月15日（2024年分確定申告）
- 現状: 手作業で10時間以上

**解決策**: 完全自動化された確定申告サポートシステム

## 実装タスク

### Phase 47.1: 取引履歴記録システム（1日・2-3時間）
- [ ] TradeHistoryRecorder実装（SQLite・`data/trade_history.db`）
- [ ] エントリー・エグジット・TP/SL発動を記録
- [ ] 日時・取引種別・数量・価格・手数料・損益保存
- [ ] ExecutionServiceに自動記録機能追加

### Phase 47.2: CSV出力機能（0.5日・1-2時間）
- [ ] CSVエクスポーター実装（`scripts/tax/export_trade_history.py`）
- [ ] 期間指定（例: 2024年1月1日～12月31日）
- [ ] 国税庁推奨フォーマット対応

### Phase 47.3: 損益計算エンジン（1日・2-3時間）
- [ ] PnLCalculator実装（`src/tax/pnl_calculator.py`）
- [ ] 移動平均法対応（国税庁推奨）
- [ ] 年間損益集計・月別サマリー

### Phase 47.4: 税務レポート生成（1日・2-3時間）
- [ ] TaxReportGenerator実装（PDF出力）
- [ ] 国税庁フォーマット対応
- [ ] サマリーレポート生成

### Phase 47.5: Discord通知統合・自動化（0.5日・1時間）
- [ ] 年末自動通知（12月31日23:59）
- [ ] 月次サマリー通知（毎月1日）

**期待効果**:
- ✅ 確定申告作業時間: 10時間 → 30分（-95%）
- ✅ 計算精度: 100%（ミスリスク0）
- ✅ 法的コンプライアンス: 100%達成

---

# 💰 **Phase 48: Discord通知最適化v2（1週間）** コスト削減

## 背景・目的

**Phase 37.3完了**: 月700-900円削減 → 月額1,100-1,300円達成
**Phase 48目標**: さらに-20-30%削減 → 月額880-1,040円へ

## 実装タスク

### Phase 48.1: 通知戦略見直し（0.5日・1-2時間）
- [ ] Warning通知集約ロジック（1時間に1回まで）
- [ ] 同種Warning集約実装

### Phase 48.2: 通知バッチ送信実装（0.5日・1-2時間）
- [ ] 5分ごとのバッチ送信
- [ ] Discord Embed活用（3通知 → 1通知）

### Phase 48.3: Discord Webhook代替検討（0.5日・1時間）
- [ ] Slack/Telegram/LINE Notify調査
- [ ] コスト比較・移行判断

**期待効果**:
- ✅ 月額コスト: -20-30%削減（月880-1,040円へ）
- ✅ 通知ノイズ: -60%削減
- ✅ Discord API呼び出し: -40%削減

---

# 📈 **Phase 49: 3軸マルチタイムフレーム戦略（1-2週間）** 性能向上

## 背景・目的

**問題**: 5分間隔実行だが4h/15m足の2軸のみ
**解決**: 5分足を活用して直近市場状況を反映
**期待効果**: エントリー精度+5-10%向上

## 実装タスク

### Phase 49.1: 5分足補助指標実装（3-4日）
- [ ] DataPipeline拡張: 5分足OHLCV取得
- [ ] 5分足分析ロジック: EMA5/10クロス・RSI
- [ ] MultiTimeframe戦略拡張: 3軸構成（4h:60%, 15m:30%, 5m:10%）
- [ ] フィルターモード実装

### Phase 49.2: バックテスト検証（2-3日）
- [ ] 2軸 vs 3軸比較
- [ ] ノイズ影響評価

### Phase 49.3: ペーパートレード検証（1-2週間）
- [ ] 実動作確認

### Phase 49.4: 段階的ライブ適用
- [ ] 効果確認時のみ有効化

---

# 📱 **Phase 50: モバイル管理アプリ（PWA）（1-2週間）** 運用改善

## 背景・目的

**問題**: 外出先でbotの停止・確認ができない
**解決**: スマホからbot制御可能なPWA実装

## 実装タスク

### Phase 50.1: 認証システム実装（2-3日）
- [ ] JWT認証実装
- [ ] 環境変数でパスワード管理

### Phase 50.2: REST API実装（2-3日）
- [ ] FastAPI実装
- [ ] エンドポイント: status/start/stop/balance/positions

### Phase 50.3: PWAフロントエンド実装（3-4日）
- [ ] HTML/CSS/JavaScript実装
- [ ] Material Design Lite使用
- [ ] レスポンシブデザイン

### Phase 50.4: Cloud Runデプロイ（1日）
- [ ] Dockerfile拡張
- [ ] HTTPSアクセス確認

### Phase 50.5: セキュリティ強化（1日）
- [ ] レート制限実装
- [ ] 監査ログ実装

**期待効果**:
- ✅ 運用効率大幅向上
- ✅ 緊急対応可能化

---

# 🔧 **Phase 51: 戦略・特徴量拡張パッケージ（継続的改善）**

## 背景・目的

**問題**: 5戦略55特徴量で固定
**解決**: 継続的に戦略・特徴量を追加

## 実装タスク

### Phase 51.1: 戦略追加候補（各2-3日）
- [ ] Ichimoku Cloud Strategy（一目均衡表）
- [ ] Volume Profile Strategy（出来高プロファイル）
- [ ] Elliott Wave Strategy（エリオット波動）

### Phase 51.2: 特徴量追加候補（各1-2日）
- [ ] 時間的特徴量（5-8特徴量）
- [ ] マクロ経済特徴量（3-5特徴量）
- [ ] オンチェーン特徴量（5-10特徴量）

### Phase 51.3: 継続的評価フレームワーク（1週間）
- [ ] AB Testing実装
- [ ] バックテスト自動評価
- [ ] 週次レポート生成

---

# 🌐 **Phase 52: マルチアセット対応（2-3週間）** 拡張機能

## 背景・目的

**問題**: BTC/JPY専用
**解決**: ETH/JPY・XRP/JPY対応

## 実装タスク

### Phase 52.1: アセット抽象化（3-4日）
- [ ] AssetConfigクラス実装
- [ ] unified.yaml拡張

### Phase 52.2: 海外CEX/DEXマイナーアルトコイン対応（4-5日）
- [ ] 候補資産選定（SOL・AVAX・MATIC・LINK）
- [ ] BTC相関分析（相関係数0.3未満推奨）
- [ ] Binance/Uniswap API統合

### Phase 52.3: bitbank ETH/JPY対応（3-4日）
- [ ] ETH/JPY API対応
- [ ] ETH-BTC相関係数特徴量追加

### Phase 52.4: bitbank XRP/JPY対応（3-4日）
- [ ] XRP/JPY API対応
- [ ] XRP-BTC相関係数特徴量追加

### Phase 52.5: ポートフォリオ最適化（4-5日）
- [ ] PortfolioOptimizer実装
- [ ] Kelly基準ベース資金配分
- [ ] 相関係数考慮リスク分散

### Phase 52.6: 段階的ライブ適用（2-3週間）
- [ ] ペーパートレード検証（各資産1週間）
- [ ] 少額ライブ検証（各1万円・1週間）

**期待効果**:
- ✅ 収益機会+30-50%拡大
- ✅ リスク分散

---

# ⭐ **Phase 53: 情報源多様化（2週間）** 新規優先

## 背景・目的

**2025年最先端研究との比較**:
- ✅ あなたのbot: Random Forest・XGBoost・LightGBM（最先端一致）
- ✅ あなたのbot: 55特徴量（Phase 45完了）
- ❌ 2025年最先端: NLP感情分析・マクロ経済指標・時間的特徴量
- ❌ 2025年最先端: 80-100特徴量

**Phase 53戦略**: 低コスト実装（53.1-53.3）を優先

**期待効果**: 55 → 75-88特徴量（+36-60%）

## 実装タスク

### Phase 53.1: マクロ経済指標統合（2-3日）⭐最優先・ゼロコスト
- [ ] 無料データソース統合（Yahoo Finance・FRED API）
- [ ] ドル円・日経平均・米国債利回り・Fear & Greed Index
- [ ] 5-10特徴量追加

### Phase 53.2: 時間的特徴量拡張（2-3日）⭐最優先・ゼロコスト
- [ ] 時間的パターン特徴量実装
- [ ] 曜日・時間帯・月・四半期効果
- [ ] 5-8特徴量追加

### Phase 53.3: News API統合（3-4日）⚠️中優先・月額$50-100
- [ ] CryptoCompare/Finnhub News API統合
- [ ] VADER感情分析実装
- [ ] 10-15特徴量追加

### Phase 53.4: バックテスト検証・ML再学習（2-3日）
- [ ] 55特徴量 vs 60-65特徴量比較
- [ ] ML再学習（Optuna 50 trials）
- [ ] ペーパートレード検証

**Phase 53期待効果（合計）**:
- ✅ 特徴量数: 55 → 75-88（+36-60%）
- ✅ ML予測精度: +15-25%
- ✅ 2025年最先端レベル到達
- ✅ 月額コスト: 0-100ドル（Phase 53.1-53.2は無料）

---

## 🎯 **開発優先度指針・実装スケジュール**

### 実装順序ロジック（2025/10/22更新）

```
✅ 完了: Phase 40-45（2025/10/21完了）
   → Optuna最適化・Meta-Learning・統合TP/SL・トレーリングSTOP実装完了
   → Phase 44機能が本番環境で動作せず → Phase 46でデイトレード特化設計に転換

📅 実装予定（優先度順）:

1. Phase 46（3-5日）: デイトレード特化設計 ⭐最優先・実装中
   → トレーリングSTOP削除・TP/SL統合削除・コード簡略化
   → 月利3-5%目標・取引頻度向上

2. Phase 47（1週間）: 確定申告対応システム 🔴法的必須
   → 2025年3月期限・法的義務

3. Phase 48（1週間）: Discord通知最適化v2 💰コスト削減
   → 月額コスト-20-30%削減

4. Phase 49（1-2週間）: 3軸マルチタイムフレーム 📈性能向上
   → エントリー精度+5-10%

5. Phase 50（1-2週間）: モバイル管理アプリ 📱運用改善
   → スマホからbot制御

6. Phase 51（継続的）: 戦略・特徴量拡張 🔧継続改善
   → ML精度継続向上

7. Phase 52（2-3週間）: マルチアセット対応 🌐拡張機能
   → 収益機会+30-50%

8. Phase 53（2週間）: 情報源多様化 ⭐新規優先
   → 55 → 75-88特徴量・2025年最先端レベル
```

### 優先度まとめ

| 優先度 | Phase | 期間 | 効果 | リスク | 状態 | 推奨 |
|--------|-------|------|------|--------|------|------|
| ⭐ 最優先 | Phase 46 | 3-5日 | シンプル化・動作安定性向上 | **低** | 実装中 | **✅ 実施中** |
| 🔴 法的必須 | Phase 47 | 1週間 | 確定申告対応完了 | 低 | 未着手 | **✅ 実施必須** |
| 💰 コスト削減 | Phase 48 | 1週間 | 月額コスト-20-30%削減 | 低 | 未着手 | **✅ 実施推奨** |
| 📈 性能向上 | Phase 49 | 1-2週間 | エントリー精度+5-10% | 中 | 未着手 | Phase 46後 |
| 📱 運用改善 | Phase 50 | 1-2週間 | 運用効率向上 | 低 | 未着手 | 運用改善 |
| 🔧 継続 | Phase 51 | 継続的 | ML精度継続向上 | 低 | 未着手 | 継続実施 |
| 🌐 拡張 | Phase 52 | 2-3週間 | 収益機会+30-50% | 中-高 | 未着手 | Phase 53後 |
| ⭐ 新規優先 | Phase 53 | 2週間 | 55→75-88特徴量 | 低-中 | 未着手 | **✅ 実施推奨** |

---

**🎉 Phase 40-45完了！Phase 46（デイトレード特化設計）実装中**

**📊 現在の基準**:
- 55特徴量システム稼働中（Phase 45完了済み）
- Phase 44機能が本番環境で動作せず → Phase 46で根本解決へ
- 1,159テスト100%成功・69.60%カバレッジ達成

**詳細**: `docs/開発履歴/Phase_40-45.md` 参照

---

**最終更新**: 2025年10月22日 - Phase 46実装開始（デイトレード特化設計・トレーリングSTOP削除・TP/SL統合削除）
