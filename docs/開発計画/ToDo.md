# 暗号資産取引Bot - Phase 51完走計画

## 📋 このファイルの目的

**Claude Codeに読み込ませ、続きの開発を実行するための未達成タスク管理ファイル**

**基本方針**:
- **Phase 51完走を最優先**（Phase 51.8-51.12）
- **Phase 52以降は凍結**（Phase 51完了後、実運用データに基づいて再検討）
- **バックテスト評価を各ステップに組み込み**（データドリブンな戦略選択）
- **完走後は実運用3ヶ月のデータ収集**（収益性実証）

---

## 🎯 現在の状態

**Phase 51.7完全完了**（2025/11/08）:
- 55特徴量システム（49基本+6戦略信号）
- 6戦略統合（Range型4戦略68%・Trend型2戦略32%）
- TP/SL最適化（SL 0.7%・TP 0.9%・RR比1.29:1）
- Atomic Entry Pattern実装（Entry/TP/SL一体保証）
- Market Regime Classification（4段階市場状況分類）
- Dynamic Strategy Management（Registry+Decorator+Facadeパターン）
- 品質: 1,166テスト全合格・checks.sh 100%成功

**次回作業**: **Phase 51.8**（レジーム別戦略重み最適化+保有ポジション制限）

---

## 📊 Phase 51完走ロードマップ

| Phase | ステータス | 目的 | 期間 | 詳細ドキュメント |
|-------|-----------|------|------|-----------------|
| Phase 51.1-51.5 | ✅完了 | 市場レジーム分類・動的戦略管理基盤構築 | 11/02-04 | `docs/開発履歴/Phase_51.5.md` |
| Phase 51.6 | ✅完了 | TP/SL問題完全解決・Atomic Entry Pattern実装 | 11/05 | `docs/開発履歴/Phase_51.6.md` |
| Phase 51.7 | ✅完了 | 新戦略実装（6戦略統合・55特徴量システム確立） | 11/05-08 | `docs/開発履歴/Phase_51.7.md` |
| **Phase 51.8** | ⏸未着手 | **レジーム別戦略重み最適化+保有ポジション制限** | 2-3日 | ⬇実装タスク詳細 |
| Phase 51.9 | ⏸未着手 | ML統合最適化（レジーム別） | 3-4日 | ⬇実装タスク詳細 |
| Phase 51.10 | ⏸未着手 | バックテスト総合検証（180日間） | 2-3日 | ⬇実装タスク詳細 |
| Phase 51.11 | ⏸未着手 | ペーパートレード検証（7日間） | 1週間 | ⬇実装タスク詳細 |
| Phase 51.12 | ⏸未着手 | 本番展開 + Phase 51完走宣言 | 1日 | ⬇実装タスク詳細 |

**Phase 51完走後のアクション**:
```
Phase 51.12完了 → 実運用3ヶ月（1万円→段階的拡大） → データ分析 → Phase 52判断
```

---

## 🔥 Phase 51.8: レジーム別戦略重み最適化 + 保有ポジション制限（2-3日）⭐⭐⭐⭐⭐

### 目的

**問題**: Phase 51.7で6戦略実装したが、レジーム別の最適な重み配分と保有ポジション数管理が未実装

**解決**: thresholds.yaml でレジーム別戦略重み+ポジション数制限を設定し、バックテストで最適化

**期待効果**:
- レンジ相場収益率+15-25%向上
- トレンド相場収益率+10-20%向上
- リスク管理強化（最大5件ポジション制限・過剰エントリー防止）

### 実装タスク

#### Step 0: Phase 51.7詳細分析完了（保留タスク）（1日）⭐前提条件

**📝 背景**: Phase 51.7 Day 6で保留した詳細分析タスクを完了

**実施内容**:
- [ ] レジーム別性能分析
  - tight_range期間のみのバックテスト実行
  - trending期間のみのバックテスト実行
  - 各レジームでの勝率・RR比・収益率測定
- [ ] Phase 50.9比較分析
  - Phase 50.9（3戦略・62特徴量）vs Phase 51.7（6戦略・55特徴量）
  - 収益率・勝率・最大DD比較表作成
- [ ] matplotlib可視化
  - エクイティカーブ（Phase 50.9 vs Phase 51.7比較）
  - 損益分布ヒストグラム
  - ドローダウン推移
  - レジーム別損益グラフ
- [ ] 統合レポート作成
  - Markdown分析レポート作成（`docs/分析/Phase_51.7_Analysis_Report.md`）
  - Phase 51.8へのインサイト抽出

**成果物**:
- `docs/分析/Phase_51.7_Analysis_Report.md`（分析レポート）
- `backtest_results_phase51_7.png`（可視化グラフ）

**🎯 このステップ完了後**: Phase 51.8 Step 1へ進む

#### Step 1: レジーム別重み+保有ポジション制限設定（0.5-1日）

**実施内容**:
- [ ] thresholds.yaml更新（6戦略対応+ポジション制限）

```yaml
# 保有ポジション制限（Phase 51.8新規）
position_limits:
  max_positions: 5              # 最大同時保有ポジション数
  reject_on_limit: true         # 制限超過時は新規エントリー拒否

# レジーム別戦略重み（Phase 51.8）
regime_strategy_weights:
  tight_range:
    ATRBased: 0.30
    BBReversal: 0.25
    StochasticReversal: 0.20
    DonchianChannel: 0.15
    ADXTrendStrength: 0.05
    MACDEMACrossover: 0.05

  normal_range:
    ATRBased: 0.25
    BBReversal: 0.20
    StochasticReversal: 0.15
    DonchianChannel: 0.15
    ADXTrendStrength: 0.15
    MACDEMACrossover: 0.10

  trending:
    ADXTrendStrength: 0.30
    MACDEMACrossover: 0.25
    DonchianChannel: 0.20
    ATRBased: 0.15
    BBReversal: 0.05
    StochasticReversal: 0.05

  high_volatility:
    # 全戦略無効化（エントリーしない）
```

- [ ] PositionTracker統合
  - `get_active_position_count()`メソッド追加
  - ExecutorServiceでエントリー前にポジション数チェック
  - 制限超過時はエントリー拒否ログ出力
  - `src/trading/position/tracker.py`修正
  - `src/trading/execution/executor.py`修正

- [ ] ユニットテスト追加
  - test_position_limits.py作成（10テスト）
  - ポジション数制限超過時のエントリー拒否テスト
  - 5件ポジション保有時の新規エントリーテスト
  - 4件ポジション保有時の新規エントリー成功テスト

**設計方針**:
- tight_range: レンジ型戦略4つに集中（80%）・トレンド型戦略最小化（10%）
- normal_range: バランス型（レンジ60%・トレンド25%）
- trending: トレンド型戦略に集中（75%）・レンジ型戦略最小化（10%）
- high_volatility: エントリーなし（リスク回避）

#### Step 2: バックテスト最適化（1-2日）⭐最重要

**実施内容**:
- [ ] レジーム別バックテスト実行（180日間）
  - tight_range期間のみ抽出してバックテスト
  - trending期間のみ抽出してバックテスト
- [ ] 重み配分のグリッドサーチ
  - 例: ATRBasedの重み 0.25, 0.30, 0.35で比較
  - 最も収益率が高い組み合わせを採用
- [ ] レジームカバレッジ分析
  - 各レジームの発生頻度確認
  - 期待収益計算（レジーム別収益 × 発生頻度）
- [ ] ポジション制限効果測定
  - 5件制限あり vs 制限なしの収益率比較
  - 過剰エントリー防止効果確認

**最適化基準**:
```
tight_range期間:
- 目標勝率: 65%以上
- 目標収益率: +10%以上（180日間）

trending期間:
- 目標勝率: 55%以上
- 目標RR比: 1.5:1以上
- 目標収益率: +15%以上（180日間）

ポジション制限:
- 最大DD削減効果確認（20%以内維持）
- エントリー機会損失 < 5%（過度な制限回避）
```

#### Step 3: DynamicStrategySelector統合（0.5日）

**実施内容**:
- [ ] DynamicStrategySelectorがthresholds.yamlの新設定を読み込む確認
- [ ] レジーム切り替え動作確認（ユニットテスト）
- [ ] ポジション制限動作確認（統合テスト）
- [ ] 全テスト100%成功確認（checks.sh実行）

#### Step 4: Git Commit & Phase 51.8完了宣言

**実施内容**:
- [ ] git add . && git commit
  - コミットメッセージ: "feat: Phase 51.8完了 - レジーム別戦略重み最適化+保有ポジション制限"
- [ ] Phase_51.5.md更新（Phase 51.8セクション追加）
- [ ] ToDo.md更新（Phase 51.8完了マーク）

### Phase 51.8期待効果

- **レジーム別最適化**: データ駆動の重み配分
- **リスク管理強化**: 最大5件ポジション制限・過剰エントリー防止・最大DD20%以内
- **収益率向上**: レンジ+15-25%・トレンド+10-20%
- **システム完成度**: 90%達成

---

## Phase 51.9: ML統合最適化（レジーム別）+ バックテスト評価（3-4日）⭐⭐⭐⭐⭐

### 目的

**問題**: ML統合がレジーム別に最適化されていない（全レジーム共通の閾値）

**解決**: レジーム別にML信頼度閾値を調整・Strategy-Aware ML維持

**期待効果**: ML統合率最適化・過学習防止・収益率+5-10%向上

### 実装タスク

#### Step 1: レジーム別ML信頼度閾値調整（1日）

**実施内容**:
- [ ] thresholds.yaml更新（レジーム別ML閾値）

```yaml
regime_ml_integration:
  tight_range:
    min_ml_confidence: 0.50      # 戦略重視（ML補完控えめ）
    high_confidence_threshold: 0.65
    strategy_weight: 0.75        # 戦略75% + ML25%

  trending:
    min_ml_confidence: 0.40      # ML補完重視
    high_confidence_threshold: 0.60
    strategy_weight: 0.65        # 戦略65% + ML35%
```

**設計根拠**:
- tight_range: レンジ相場は戦略シグナルが明確 → 戦略重視
- trending: トレンド相場はML補完が有効 → ML重視

#### Step 2: 55特徴量対応確認（0.5日）

**実施内容**:
- [ ] feature_order.json確認（total_features: 55）
  - 49基本特徴量
  - 6戦略シグナル特徴量（Phase 51.7で6戦略実装）
  - 0時間的特徴量（Phase 51.7で削除）
- [ ] MLモデル再学習（55特徴量版）
  ```bash
  python scripts/ml/create_ml_models.py --model both --n-classes 3 --threshold 0.005 --verbose
  ```
- [ ] ensemble_full.pkl・ensemble_basic.pkl生成確認

#### Step 3: Strategy-Aware ML維持（0.5日）

**実施内容**:
- [ ] 訓練時に6戦略の実信号を特徴量として学習
- [ ] Look-ahead bias防止確認（df.iloc[: i + 1]）
- [ ] 訓練/推論一貫性確認

#### Step 4: バックテスト評価（1-2日）⭐最重要

**実施内容**:
- [ ] ML統合あり vs なしの比較バックテスト
  - features.yaml: ml_integration.enabled: true vs false
  - 収益率・勝率・最大DD比較
- [ ] レジーム別ML効果測定
  - tight_range: ML統合効果+5%目標
  - trending: ML統合効果+10%目標
- [ ] F1スコア・精度測定
  - 目標: F1スコア0.60以上維持

**ML統合効果判定基準**:
```
ML統合あり - ML統合なし > +3%の収益率向上

もし効果が+3%未満 → ML統合を無効化検討
```

#### Step 5: Git Commit & Phase 51.9完了宣言

### Phase 51.9期待効果

- **ML最適化**: レジーム別信頼度閾値
- **収益率向上**: +5-10%（ML統合効果）
- **特徴量数**: 55特徴量確定（Phase 51.7で最適化完了）

---

## Phase 51.10: バックテスト総合検証（2-3日）⭐⭐⭐⭐⭐

### 目的

**問題**: Phase 51.7-51.9で個別に最適化したが、全体統合後の性能が未確認

**解決**: 180日間の総合バックテストで最終性能評価

**期待効果**: Phase 51システムの収益性を数値で実証（Phase 50比+20-30%目標）

### 実装タスク

#### Step 1: バックテスト実行（1日）

**実施内容**:
- [ ] Phase 51システム バックテスト（180日間・15分足）
  ```bash
  python src/backtest/scripts/run_backtest.py
  ```
- [ ] Phase 50.9システム バックテスト（比較用）
  - git checkout Phase-50.9タグ
  - 同一期間でバックテスト実行
  - git checkout main

**測定メトリクス**:
```
1. 総損益（円）
2. 収益率（%）
3. 勝率（%）
4. 最大ドローダウン（%）
5. シャープレシオ
6. プロフィットファクター
7. 平均損益（円/取引）
8. 取引回数
```

#### Step 2: 性能基準確認（0.5日）⭐最重要

**Phase 51合格基準**:
```
必須基準（1つでも未達成なら要調整）:
1. 総損益 > 0円（利益確認）
2. 収益率 > Phase 50.9の収益率（改善確認）
3. 最大ドローダウン ≤ 20%（リスク管理）
4. 勝率 ≥ 55%（安定性確認）

目標基準（努力目標）:
5. 収益率 ≥ Phase 50.9 + 20%（レンジ相場改善目標）
6. シャープレシオ ≥ 1.0（リスク調整後収益）
7. 月次利益 ≥ 2,000円（運用コストカバー）
```

**判定**:
- 必須基準すべて達成 → Phase 51.11へ進む
- 必須基準1つでも未達成 → Phase 51.7-51.9に戻って調整

#### Step 3: matplotlib可視化（0.5日）

**実施内容**:
- [ ] エクイティカーブ（Phase 50 vs Phase 51比較）
- [ ] 損益分布ヒストグラム
- [ ] ドローダウン推移
- [ ] 価格チャート（エントリー・エグジット表示）
- [ ] レジーム別損益（tight_range・trending別）

**成果物**:
- `backtest_results_phase51.png`（4グラフ統合）
- `regime_performance_phase51.png`（レジーム別）

#### Step 4: 詳細分析レポート作成（0.5日）

**実施内容**:
- [ ] Markdown分析レポート作成
  - Phase 50 vs Phase 51比較表
  - レジーム別パフォーマンス
  - 戦略別貢献度
  - ML統合効果
  - 改善点・懸念点

**成果物**: `docs/分析/Phase_51_Backtest_Report.md`

#### Step 5: Git Commit & Phase 51.10完了宣言

### Phase 51.10期待効果

- **収益性実証**: バックテストで+20-30%改善確認
- **リスク確認**: 最大DD20%以内
- **データ可視化**: 性能グラフ・分析レポート

---

## Phase 51.11: ペーパートレード検証（1週間）⭐⭐⭐⭐

### 目的

**問題**: バックテストは過去データ・実市場と異なる可能性

**解決**: ペーパーモードで7日間実取引シミュレーション

**期待効果**: 実市場での動作確認・バックテストとの乖離検証

### 実装タスク

#### Step 1: ペーパーモード設定（0.5日）

**実施内容**:
- [ ] features.yaml確認
  ```yaml
  dynamic_strategy_selection:
    enabled: true   # レジーム別戦略選択ON
  ml_integration:
    enabled: true   # ML統合ON
  ```
- [ ] unified.yaml確認
  ```yaml
  mode: paper
  initial_balance: 10000.0
  ```
- [ ] GCP Cloud Runデプロイ（paper mode）
  ```bash
  bash scripts/deployment/deploy.sh paper
  ```

#### Step 2: 7日間監視（7日）⭐最重要

**実施内容**:
- [ ] 毎日のログ確認
  ```bash
  gcloud logging read "resource.type=cloud_run_revision" --limit=50
  ```
- [ ] レジーム遷移動作確認
  - tight_range → trending切り替えログ確認
  - 戦略重み変更ログ確認
- [ ] エントリー・エグジット記録
- [ ] Discord週間レポート確認（月曜9時）

**記録項目**:
```
1. エントリー回数（日別）
2. 勝敗（日別）
3. 損益（日別・累積）
4. レジーム分布（tight_range: X日、trending: Y日）
5. エラー・警告の有無
```

#### Step 3: 結果分析（0.5日）

**実施内容**:
- [ ] 7日間の損益サマリー
- [ ] バックテストとの乖離分析
  - 勝率の差
  - 平均損益の差
  - 取引回数の差
- [ ] 懸念点のリストアップ

**合格基準**:
```
1. エラーゼロ（システム安定性）
2. 総損益 ≥ 0円（利益 or 損益ゼロ以上）
3. バックテストとの勝率乖離 ≤ 10%（大幅乖離なし）
```

**不合格時の対応**:
- エラーあり → 修正してPhase 51.11再実行
- 大幅損失 → Phase 51.7-51.9に戻って調整
- バックテスト乖離大 → 原因分析・パラメータ調整

#### Step 4: Git Commit & Phase 51.11完了宣言

### Phase 51.11期待効果

- **実市場動作確認**: 7日間エラーゼロ
- **バックテスト検証**: 乖離10%以内
- **本番準備完了**: Phase 51.12へ進む準備完了

---

## Phase 51.12: 本番展開 + Phase 51完走宣言（1日）⭐⭐⭐⭐⭐

### 目的

**問題**: Phase 51.11ペーパーモード成功・本番デプロイ準備完了

**解決**: live modeで本番展開・Phase 51完走宣言

**期待効果**: Phase 51システム本番稼働開始・実運用データ収集開始

### 実装タスク

#### Step 1: 本番デプロイ（0.5日）

**実施内容**:
- [ ] unified.yaml更新
  ```yaml
  mode: live
  initial_balance: 10000.0   # 1万円スタート
  ```
- [ ] GCP Cloud Runデプロイ（live mode）
  ```bash
  bash scripts/deployment/deploy.sh live
  ```
- [ ] 本番環境ログ確認（初回24時間）
  ```bash
  gcloud logging read "resource.type=cloud_run_revision" --limit=100
  ```

#### Step 2: 24時間監視（1日）

**実施内容**:
- [ ] 毎時ログ確認
- [ ] エントリー・エグジット動作確認
- [ ] 残高・証拠金維持率確認
- [ ] エラー・警告の有無確認

**確認項目**:
```
1. システム稼働（24時間ダウンタイムゼロ）
2. エントリー判断（レジーム別戦略選択動作）
3. TP/SL配置（個別TP/SL正常動作）
4. 証拠金維持率（80%以上維持）
5. Discord通知（週間レポート配信）
```

#### Step 3: Phase 51完走宣言（0.5日）

**実施内容**:
- [ ] Phase_51.5.md更新
  - Phase 51.6-51.12セクション追加
  - バックテスト結果記載
  - ペーパートレード結果記載
  - 本番展開完了記載
- [ ] CLAUDE.md更新
  - Phase 51完走完了記載
  - Phase 52凍結記載
  - 実運用3ヶ月計画記載
- [ ] README.md更新
  - Phase 51完走バッジ追加
  - 最新の性能メトリクス記載
- [ ] ToDo.md更新
  - Phase 51完走マーク
  - Phase 52凍結明記
  - 実運用3ヶ月計画明記

#### Step 4: Git Commit & GitHub Release

**実施内容**:
- [ ] git tag作成
  ```bash
  git tag -a Phase-51-Complete -m "Phase 51完走: レンジ型最適化・戦略厳選・市場レジーム分類システム完成"
  git push origin Phase-51-Complete
  ```
- [ ] GitHub Release作成
  - リリースノート: Phase 51.6-51.12の成果
  - バックテスト結果・グラフ添付

### Phase 51.12期待効果

- **Phase 51完走**: 3週間の開発完了
- **本番稼働開始**: 1万円で実運用スタート
- **データ収集開始**: 次の3ヶ月で収益性実証

---

## 📊 Phase 51完走後のアクション（3ヶ月）

### 実運用データ収集計画

**期間**: Phase 51.12完了後 3ヶ月間

**実施内容**:
1. **毎日の記録**:
   - Discord週間レポート確認（毎週月曜9時）
   - 月次サマリー作成（手動・Excel or CSV）

2. **記録項目**:
   ```
   - 総損益（円）
   - 月次利益（円）
   - 勝率（%）
   - 取引回数
   - 最大ドローダウン（%）
   - レジーム分布（tight_range/trending発生頻度）
   - 戦略別貢献度
   ```

3. **月次評価**:
   - 1ヶ月目: データ収集のみ（調整なし）
   - 2ヶ月目: データ収集のみ（調整なし）
   - 3ヶ月目: データ収集 + 総合評価

### 3ヶ月後の評価基準

**成功判定**:
```
✅ 成功（Phase 52検討可）:
- 3ヶ月総損益 > 0円（利益確認）
- 月平均利益 ≥ 2,000円（運用コストカバー）
- 最大ドローダウン ≤ 20%（リスク管理）

⚠️ 微益（現状維持）:
- 3ヶ月総損益 > 0円だが月平均 < 2,000円
- 資金拡大は見送り・1万円継続

❌ 失敗（戦略見直し or 終了）:
- 3ヶ月総損益 < 0円（損失）
- Phase 51.7-51.9に戻って戦略調整
- または、プロジェクト終了判断
```

**Phase 52判断**:
```
成功時のみ Phase 52を検討:
1. Phase 52の内容を再評価（5分足移行は本当に必要か？）
2. データに基づいて優先度判断
3. Phase 53（オンチェーン指標）は引き続き凍結

微益・失敗時:
- Phase 52凍結継続
- Phase 51の戦略調整 or プロジェクト終了
```

---

## 🎯 開発方針・品質基準（Phase 51共通）

### KISS原則の徹底

- **Phase 51完走に集中**（Phase 52以降は凍結）
- **バックテスト評価必須**（データドリブンな戦略選択）
- **過度な複雑化を避ける**

### 品質保証プロセス

1. **バックテスト必須**: Phase 51.8-51.10で徹底評価
2. **段階的導入**: backtest → paper(7日) → live(3ヶ月)の3段階
3. **テスト100%維持**: 新機能は必ず単体・統合テスト追加
4. **カバレッジ維持**: 68%以上を維持

### 複雑化リスク管理

- **Phase 51完走でストップ**（Phase 52以降は実運用データで判断）
- **設定ファイル化の徹底**（ハードコード禁止）
- **レガシーコード即座削除**（Phase 51.5-Dの教訓）

---

## ❄️ 凍結タスク（Phase 51完了後に再検討）

### Phase 52: 5分足移行（凍結）

**凍結理由**:
- Phase 51完了後、実運用3ヶ月のデータ収集を優先
- 5分足の効果はバックテストでは不明確
- ノイズ増加・API呼び出し増加のリスク

**再検討条件**:
- Phase 51で3ヶ月成功（月2,000円以上利益）
- データ分析で5分足の必要性が明確化

### Phase 53: 特徴量拡張（凍結）

**凍結理由**:
- Phase 50.9で外部API削除した教訓（GCP環境不安定性）
- オンチェーン指標も外部API依存
- 複雑性増加 vs リターン不明

**再検討条件**:
- Phase 51で3ヶ月成功
- GCP環境での外部API安定性が実証される

---

**📅 最終更新**: 2025年11月08日 - **Phase 51.7完全完了**・Phase 51.8準備（保有ポジション制限5件・エントリー拒否方式・全レジーム統一）
