# 暗号資産取引Bot - 開発計画

## 現在の状態

**Phase 61進行中** - コードベース整理・戦略改修

※ 完了済みタスクの詳細は `docs/開発履歴/` を参照

---

## Phase 61: コードベース整理・戦略改修

### 背景と方針転換

Phase 61.1でレジーム閾値調整を試行したが**失敗**：
- PF: 1.58 → 1.13（-28%）
- 総損益: ¥86,639 → ¥21,781（-75%）
- trending発生率: 0% → 0.6%（目標5-15%に大幅未達）

**教訓**:
1. レジーム閾値変更だけでは市場特性は変えられない
2. 2025年下半期のBTC/JPYは本質的にtrendingが少ない
3. 閾値変更は取引パターン全体に影響し、リスクが高い

**新方針**: レジーム改修は断念し、**既存環境（tight_range 88%）での戦略最適化**に注力

---

### 実装計画

| Phase | 内容 | 状態 |
|-------|------|------|
| 61.1 | レジーム判定閾値調整 | ✅完了（失敗→ロールバック） |
| 61.2 | コードベース整理・ドキュメント更新 | ✅完了 |
| 61.3 | TP/SL注文改善 | ✅完了（take_profit/stop_lossタイプ対応） |
| 61.4 | MFE/MAE分析機能 | ✅完了（What-if分析・改善方向性特定） |
| 61.5 | 低信頼度エントリー対策 | ✅完了（PF 1.58→1.78、損益+16%） |
| 61.6 | バグ修正（ATR取得・TP注文タイプ） | ✅完了 |
| **61.7** | **固定金額TP実装** | ✅完了（純利益1,000円保証） |
| 61.8 | DonchianChannel無効化検討 | 📋予定 |
| 61.9 | レンジ型戦略パラメータ最適化 | 📋予定 |

---

### Phase 61.1: レジーム判定閾値調整 ✅完了（失敗）

**実施内容**:
- thresholds.yamlにmarket_regimeセクション追加
- MarketRegimeClassifier修正（`get_threshold()`対応）

**結果**: PF大幅低下のためPhase 60オリジナル値にロールバック

**成果**: 閾値の設定ファイル化は維持（将来の再検討用）

---

### Phase 61.2: コードベース整理 ✅完了

**実施内容**:

| 項目 | 内容 |
|------|------|
| ログ整理 | 約500MB削減 |
| モデル整理 | Stacking関連31MB削除 |
| テスト整理 | dead code・xfailテスト整理 |
| スクリプト統合 | monitoring/→live/standard_analysis.py統合 |
| ドキュメント更新 | docs/運用ガイド/（6ファイル）、scripts/README等 |

**削除ファイル**:
- `.github/workflows/weekly_report.yml`
- `scripts/monitoring/`（check_bot_functions.sh等）
- `scripts/reports/`（weekly_report.py等）
- `scripts/testing/validate_system.sh`

---

### Phase 61.3: 残フォルダ整理 📋予定

**目的**: src/、.github/、config/内のPhase参照・メタデータ更新

**対象ファイル（予定）**:

| ディレクトリ | 対象 |
|-------------|------|
| `src/` | docstring内のPhase参照更新 |
| `.github/workflows/` | ci.yml等のコメント・バージョン更新 |
| `config/` | 設定ファイルのコメント・バージョン更新 |

**注意**: ライブモードに影響するため、慎重に実施

---

### Phase 61.3: TP/SL注文改善 ✅完了

**実施内容**:
- bitbank APIのtake_profit/stop_lossタイプに対応（UIで「利確」「損切り」表示）
- 決済注文の約定確認機能を追加（30秒タイムアウト）
- 未約定時の自動リトライ機能を追加（最大3回）

詳細: `docs/開発履歴/Phase_61.md`

---

### Phase 61.4: MFE/MAE分析機能 ✅完了

**目的**: バックテストのWhat-if分析を可能にする

**実装内容**:
- TradeTrackerにMFE/MAE追跡機能追加
- 7つの新指標（avg_mfe, avg_mae, mfe_capture_ratio等）
- テスト17件追加

**分析結果（2026年1月27日）**:

| 固定TP | 到達率 | 理論損益 | 現在との差 |
|--------|--------|----------|------------|
| ¥200 | 87.9% | ¥+46,012 | -¥40,627 ❌ |
| ¥500 | 69.5% | ¥+96,541 | +¥9,903 ✅ |
| ¥1,000 | 48.1% | ¥+120,049 | +¥33,410 ✅ |

**重要な発見**:
- **TPを浅くしても改善しない**（利益上限が下がりすぎる）
- **負けトレードの99%が一度は利益だった**（¥266,919の機会損失）
- **真の問題は「逆行」** → Phase 62で対策検討

詳細: `docs/開発履歴/Phase_61.md`

---

### Phase 61.5: 低信頼度エントリー対策 ✅完了

**実施日**: 2026年1月27日

**実施内容**:
1. `thresholds.yaml`に`min_strategy_confidence: 0.25`追加
2. `high_confidence_threshold`を0.70→0.55に引き下げ（tight_range/normal_range）
3. `trading_cycle_manager.py`に最低信頼度チェック追加
4. テスト4件追加

**バックテスト結果**:

| 指標 | Phase 60.7 | Phase 61.5 | 変化 |
|------|-----------|-----------|------|
| **総損益** | ¥86,639 | **¥100,629** | **+16.2%** ✅ |
| **PF** | 1.58 | **1.78** | **+12.7%** ✅ |
| 勝率 | 54.8% | 57.9% | +3.1% |
| 取引数 | 347件 | 242件 | -30%（低品質除外） |

**ML×戦略一致効果**:
- 一致時勝率: 68.0%、損益: ¥+96,983
- 不一致時勝率: 47.0%、損益: ¥+3,646

詳細: `docs/開発履歴/Phase_61.md`

---

### Phase 61.6: バグ修正（ATR取得・TP注文タイプ） ✅完了

**実施日**: 2026年1月28日

#### 問題1: ATR取得エラー → 解決

**現象**:
```
⚠️ Phase 51.5-C: DataService経由ATR取得失敗
- DataPipeline.fetch_ohlcv() got an unexpected keyword argument 'limit'
```

**根本原因**: `executor.py`のLevel 2コードが誤った引数で`fetch_ohlcv()`を呼び出し

**修正内容**:
- Level 2（DataService経由取得）コードを削除
- 3段階フォールバック → 2段階フォールバックに簡略化
- Level 1（market_data）とLevel 2（fallback_atr）で十分な安全性確保

**修正ファイル**: `src/trading/execution/executor.py`

#### 問題2: TP注文タイプが「利確」にならない → 解決

**現象**:
- SL注文: 「損切り」と表示 ✅
- TP注文: 「指値」と表示 ❌

**根本原因**: `create_take_profit_order()`で`trigger_price`パラメータが欠落
- bitbank APIでは`take_profit`注文に`trigger_price`が**必須**
- SL注文では正しく`trigger_price`を渡していた

**修正内容**:
- `_create_order_direct()`呼び出しに`trigger_price=take_profit_price`を追加

**修正ファイル**: `src/data/bitbank_client.py`

#### 検証結果

| チェック | 結果 |
|---------|------|
| 品質チェック | ✅ PASS（flake8/black/isort/pytest） |
| テスト | ✅ 1235件パス |
| カバレッジ | ✅ 63.12%（62%基準クリア） |

---

### Phase 61.7: 固定金額TP実装 ✅完了

**実施日**: 2026年1月28日

**目的**: TPを%ベースから固定金額（純利益1,000円保証）に変更

**背景**:
- 現在のTP設定（tight_range 0.4%）では含み益約1,155円
- 手数料控除後の純利益は866円（目標未達）
- 実質RR比: 866円 / 1,154円 = 0.75:1（不利）

**実装内容**:

| ファイル | 修正内容 |
|---------|---------|
| `config/core/thresholds.yaml` | 固定金額TP設定追加 |
| `src/trading/core/types.py` | `PositionFeeData`クラス追加 |
| `src/strategies/utils/strategy_utils.py` | `calculate_fixed_amount_tp()`追加 |
| `src/trading/execution/executor.py` | API手数料取得ロジック追加 |
| テスト | 12件追加（全1247件成功） |

**計算式**:
```
必要含み益 = 目標純利益 + エントリー手数料 + 利息 - 決済リベート
TP価格 = エントリー価格 ± (必要含み益 / 数量)
```

**計算例**:
```
目標純利益: 1,000円
エントリー手数料: 346円（API取得）
利息: 0円
決済リベート: 58円

必要含み益 = 1,000 + 346 + 0 - 58 = 1,288円
TP価格 = 13,618,976 ± (1,288 / 0.0212)
```

**後方互換性**: `enabled: false`で%ベースTPに戻る

詳細: `docs/開発履歴/Phase_61.md`

---

### Phase 61.8: DonchianChannel無効化検討 📋予定

**背景**:
- 60日PF: 0.85（赤字）
- tight_rangeでの有効性が低い

**判断基準**:
- 直近180日でPF < 1.0 継続 → 全レジームで重み0.0に設定
- 特定レジームでのみPF > 1.0 → そのレジームでのみ有効化

**実施内容**:
1. Phase 61.4の分析結果を基に判断
2. thresholds.yamlの重み設定変更
3. バックテストで効果検証

---

### Phase 61.9: レンジ型戦略パラメータ最適化 📋予定

**目的**: tight_range環境（88%）での収益最大化

**対象戦略**:

| 戦略 | 最適化ポイント |
|------|---------------|
| BBReversal | RSI閾値、BB期間、信頼度計算 |
| StochasticReversal | K/D期間、過買/過売閾値 |
| ATRBased | 消尽率閾値、ATR期間 |

**実施方法**:
1. Optunaによるパラメータ探索
2. Walk-Forward Validationで過学習検証
3. 段階的パラメータ変更（±10%ずつ）

**成功基準**:
- PF ≥ 1.60維持
- 総損益 ≥ ¥80,000維持

---

### 成功基準（Phase 61全体）

| 指標 | 目標値 | 現状（Phase 61.5） | 備考 |
|------|--------|-------------------|------|
| **PF** | **≥ 1.55** | **1.78** ✅ | Phase 60.7: 1.58基準 |
| **総損益** | **≥ ¥80,000** | **¥100,629** ✅ | Phase 60.7: ¥86,639基準 |
| 勝率 | ≥ 53% | **57.9%** ✅ | Phase 60.7: 54.8% |
| コードベース | 整理完了 | ✅ | Phase参照統一 |

---

## 完了済み: Phase 60

**目的**: リスク・リターン最適化と稼働率改善

| Phase | 内容 | 成果 |
|-------|------|------|
| 60.1 | 実効レバレッジ0.5倍移行 | 14箇所設定変更・年利75%目標 |
| 60.2 | 稼働率計算修正 | 7分間隔対応・稼働率100%表示 |
| 60.3 | Walk-Forward検証実装 | 過学習排除・信頼性向上 |
| 60.4 | ML重み削減・戦略重視設定 | 一致率向上・不一致ペナルティ強化 |
| 60.5 | MLモデル差別化 | シード差別化・特徴量サンプリング・動的重み計算 |
| 60.6 | Walk-Forward問題修正 | レジーム分布バグ修正・稼働率改善 |
| **60.7** | **¥86,639・PF 1.58達成** | **Phase 60最終結果** |

---

## Phase 62: 逆行対策・利益確保改善（予定）

### 背景（Phase 61.4 MFE/MAE分析結果）

Phase 61.4のMFE/MAE分析で判明した問題:
- 負けトレード157件中156件（99%）が一度は利益だった
- 平均MFE: ¥753（利益方向）→ 実際のPnL: ¥-948（損失）
- **¥266,919の利益を逃している**

**真の問題**: TPに到達せず、利益から逆行して損失になるパターン

---

### 実装計画

| Phase | 内容 | 優先度 | 効果予測 |
|-------|------|--------|----------|
| 62.1 | トレーリングストップ実装 | 高 | 逆行時に利益確保 |
| 62.2 | 時間ベース決済 | 中 | 長時間保有リスク軽減 |
| 62.3 | 部分決済機能 | 低 | 50%到達で半分決済 |

---

### Phase 62.1: トレーリングストップ実装 📋予定

**目的**: 一度利益が出たポジションの逆行時に自動決済

**設計案**:
```yaml
trailing_stop:
  enabled: true
  activation_threshold: 0.002  # 0.2%利益でトレーリング開始
  trail_distance: 0.001        # 0.1%の距離でトレーリング
```

**実装箇所**:
- `src/trading/execution/stop_manager.py` - トレーリングロジック追加
- `config/core/thresholds.yaml` - 設定追加

**成功基準**:
- 負けトレードのMFE捕捉率向上（現在0% → 目標30%以上）
- PF維持（≥ 1.55）

---

### Phase 62.2: 時間ベース決済 📋予定

**目的**: 長時間保有による逆行リスクを軽減

**設計案**:
- 保有時間 > N時間 かつ 含み益 > 0 → 決済
- N = 4〜8時間を検討

**判断材料**:
- 現在の平均保有時間の分析
- 保有時間と勝率の相関分析

---

### Phase 62.3: 部分決済機能 📋予定

**目的**: 利益の一部を確定しつつ、残りでさらなる利益を狙う

**設計案**:
- 含み益が一定額（例: ¥500）に到達 → 50%決済
- 残り50%は元のTP/SLで継続

**注意点**:
- bitbank APIで部分決済がサポートされるか確認必要
- 手数料の影響を考慮

---

## 保留タスク

| タスク | 優先度 | 備考 |
|--------|--------|------|
| CatBoost追加 | 低 | 4モデルアンサンブル化 |
| SL指値非約定時の成行フォールバック | 中 | 急落時リスク対策 |
| 実効レバレッジ1.0倍移行 | 中 | Phase 61完了後・結果良好な場合 |
| トレンド型戦略改修 | 低 | trending発生率改善後に再検討 |

---

## 関連ファイル

| ファイル | 内容 |
|---------|------|
| `docs/開発履歴/Phase_60.md` | Phase 60開発記録 |
| `docs/開発履歴/Phase_61.md` | Phase 61開発記録 |
| `docs/開発履歴/SUMMARY.md` | 全Phase総括 |
| `config/core/thresholds.yaml` | 戦略重み・レジーム設定 |

---

**最終更新**: 2026年1月28日 - Phase 61.7完了（固定金額TP実装）
