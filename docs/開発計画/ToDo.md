# 暗号資産取引Bot - 開発計画

## 現在の状態

**Phase 59.6完了**（SL指値化 + 孤児SL修正）- バックテスト検証中

※ 完了済みタスクの詳細は `docs/開発履歴/` を参照

---

## Phase 59 ロードマップ

| Phase | 内容 | 状態 |
|-------|------|------|
| 59.1-59.3 | バックテストシステム改善・分析 | ✅完了 |
| 59.4-A | 2票ルール無効化 | ✅完了 |
| 59.4-B | 重み調整（旧59.4-Cから繰り上げ） | ❌失敗→リバート |
| 59.5 | ライブモード分析バグ修正 | ✅完了（先行実施） |
| 59.6 | SL指値処理変更 + 孤児SL修正 | ✅完了（検証中） |
| 59.7 | MLモデル性能向上（Stacking等） | 📋予定 |
| 59.8 | 戦略見直し | 📋予定 |

---

## Phase 59.4-A: 2票ルール無効化 ✅完了

### 結果

| 指標 | Phase 59.3 | Phase 59.4-A | 改善 |
|------|-----------|--------------|------|
| 総損益 | ¥+35,955 | ¥+44,506 | **+24%** |
| PF | 1.39 | 1.55 | **+0.16** |
| 勝率 | 50.9% | 53.8% | **+2.9%** |
| Agreement勝率 | 46.4% | 55.2% | **+8.8%** |

**成果**: Agreement/Disagreement逆転問題も解消

---

## Phase 59.4-B: 重み調整 ❌失敗→リバート

### 試行内容（2026-01-16）

ATRBased主力化を試行（tight_range: 0.20→0.45）

### 結果

| 指標 | 59.4-A | 59.4-B | 変化 |
|------|--------|--------|------|
| 総損益 | ¥+44,506 | ¥+29,691 | **-33%** |
| PF | 1.55 | 1.33 | **-0.22** |
| 勝率 | 53.8% | 50.3% | **-3.5%** |

### 失敗原因

1. **分散効果の低下**: ATRBased集中により他戦略の取引が激減
2. **ATRBased勝率低下**: 55.7%→49.7%（過剰適合？）
3. **BBReversal消滅**: 14件→0件

### 結論

59.4-A設定に戻して維持。重み調整による改善は困難。

---

## Phase 59.5: ライブモード分析バグ修正 ✅完了（先行実施）

Phase 59.4の前に先行実施済み。

### 修正内容

1. 注文タイプ検出改善（maker/taker判定）
2. 4時間足データの年跨ぎ対応
3. タイムゾーン処理統一

---

## Phase 59.6: SL指値処理変更（手数料削減）✅完了

### 実装内容

| 項目 | 変更前 | 変更後 |
|------|-------|-------|
| SL注文方式 | 成行（taker） | 指値（maker） |
| 手数料率 | 0.12% | 0.02% |
| 削減効果 | - | **83%削減** |

### 修正ファイル

| ファイル | 修正内容 |
|---------|---------|
| `config/core/thresholds.yaml` | SL設定追加（order_type, slippage_buffer） |
| `src/data/bitbank_client.py` | stop_limit対応 |
| `src/trading/execution/stop_manager.py` | 指値化 + 孤児SL修正 |

### テスト結果

| 項目 | 結果 |
|------|------|
| pytest | 1,256件全て通過 |
| カバレッジ | 65%+（閾値62%クリア） |
| 追加テスト | 8件（孤児SL管理5件 + SL指値化3件） |

### 期待効果

- **手数料削減**: 月間¥25,000（年間¥300,000）
- **孤児SL解消**: TP到達時の孤児SL発生防止

---

## Phase 59.7: MLモデル性能向上 📋予定

### 現状の問題点（Phase 59.4-B分析で発見）

| 問題 | 詳細 | 深刻度 |
|------|------|--------|
| **F1スコア低い** | 0.41-0.42（研究事例: 0.81達成可能） | 高 |
| **訓練データリーク** | 12/23訓練モデルで7-12月バックテスト | 高 |
| **Walk-Forward未実装** | 単一モデルで全期間対応 | 中 |
| **アンサンブル重み固定** | F1スコアベースではない（40/40/20） | 中 |

### バックテスト信頼性の課題

現在のバックテストは**Walk-Forward（ローリング訓練）未実装**:
- 12月23日訓練モデル → 7-12月全期間で使用
- モデルは「未来の情報」を含んで訓練されている
- **戦略優位設計（ML 25-30%）により影響は緩和されている**

### 優先度別改善手法

| 優先度 | 手法 | 効果 | 工数 |
|--------|------|------|------|
| ★★★ | **Walk-Forward実装** | バックテスト信頼性向上 | 大 |
| ★★★ | **Stacking Meta-Learner** | F1 0.41→0.60+ | 中 |
| ★★☆ | F1ベース動的重み | F1 +5-10% | 小 |
| ★☆☆ | レジーム別モデル | 各レジーム専用訓練 | 大 |

### 参考（Web調査結果 2026-01-16）

- アンサンブルモデルで**81% F1スコア**達成事例あり（Springer）
- **Stacking + Meta-Learner**が不均衡データで最高性能
- XGBoost + LightGBM組み合わせが効果的
- 重み付きMeta-Learnerが従来手法を上回る

---

## Phase 59.8: 戦略見直し 📋予定

### 発見された課題（Phase 59.4-B分析）

| 課題 | 詳細 |
|------|------|
| **trending 0件** | ADX>25条件が厳しすぎる？ |
| **high_volatility 0件** | ATR比1.8%条件が厳しすぎる？ |
| **レジーム偏り** | 取引の88%がtight_range |

### 検討内容

1. **レジーム判定閾値の見直し**
   - trending: ADX閾値緩和（25→20？）
   - high_volatility: ATR比閾値調整
2. 低パフォーマンス戦略の改善または除外
3. 新戦略の検討（トレンド対応強化）

---

## Phase 60 ロードマップ（予定）

| Phase | 内容 | 状態 |
|-------|------|------|
| 60.1 | SL指値非約定時の成行フォールバック | 📋予定 |

### Phase 60.1: SL指値非約定時の成行フォールバック 📋予定

#### 背景

Phase 59.6でSLを指値化（stop_limit）したが、急落時に指値が約定しないリスクがある。

#### 実装内容

| 項目 | 内容 |
|------|------|
| **トリガー条件** | SL発動後、一定時間（例: 30秒）経過しても約定しない場合 |
| **フォールバック** | stop_limit → 成行（market）に切り替えて強制決済 |
| **監視方法** | SL注文のステータス監視 or bitbank Websocket |

#### 期待効果

- 急落時の損失拡大防止
- 指値のmaker手数料メリットを維持しつつ、執行確実性を確保

---

## 保留タスク

| タスク | 優先度 | 備考 |
|--------|--------|------|
| 戦略分析とバックテストの乖離調査 | 低 | 戦略帰属ルールの影響 |

---

## 関連ファイル

| ファイル | 内容 |
|---------|------|
| `docs/開発履歴/Phase_59.md` | Phase 59開発記録 |
| `config/core/features.yaml` | 機能トグル設定 |
| `config/core/thresholds.yaml` | 戦略重み・ML統合設定 |
| `docs/検証記録/analysis_history.csv` | 分析履歴 |

---

**最終更新**: 2026年1月16日 - Phase 59.6完了（バックテスト検証中）
