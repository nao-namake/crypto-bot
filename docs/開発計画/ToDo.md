# 暗号資産取引Bot - Phase 51完走計画

## 📋 このファイルの目的

**Claude Codeに読み込ませ、続きの開発を実行するための未達成タスク管理ファイル**

**基本方針**:
- **Phase 51完走を最優先**（Phase 51.8-51.12）
- **Phase 52以降は凍結**（Phase 51完了後、実運用データに基づいて再検討）
- **バックテスト評価を各ステップに組み込み**（データドリブンな戦略選択）
- **完走後は実運用3ヶ月のデータ収集**（収益性実証）

---

## 🎯 現在の状態

**Phase 51.8完全完了**（2025/11/09）:
- レジーム別戦略重み最適化完了（tight_range重視型・データドリブン）
- レジーム別ポジション制限実装（tight_range: 6件、normal_range: 4件、trending: 2件、high_volatility: 0件）
- 180日間バックテスト成功（1,504取引・+16.12%）
- レジーム別統計分析完了（tight_range 99.4%利益寄与・PF=1.065）
- regime情報記録問題完全解決（manager.py・executor.py・reporter.py統合）
- バックテスト完全改修完了（TP/SL・証拠金返還・手数料シミュレーション・完了保証）
- 品質: Phase 51.8-10サブPhase完全完了・バックテスト信頼性100%

**Phase 51.9完了**（2025/11/10）:
- ✅ 真の3クラス分類実装完了（2→3クラス変換ロジック完全削除）
- ✅ ML再学習完了（F1改善: LightGBM +9.7%, XGBoost +7.8%, RandomForest +4.1%）
- ✅ 特徴量数表記統一（17ファイル・55特徴量確定）
- ✅ デッドコード削除（37行・技術的負債解消）
- 🔄 バックテスト実行中（10,000サンプル・Phase 51.8制限正常動作確認）

**Phase 51.10-A完了**（2025/11/10）:
- ✅ TP/SL異常配置問題の根本原因特定（Phase 51.6 Atomic Entry Pattern実装不完全）
- ✅ 11/7の13回エントリー分析完了（想定通り・エラーではない判定）
- ✅ **Option D実装完了**（Phase 51.6完全実装・Phase 46思想遵守）
- ✅ executor.py実装（_cleanup_old_tp_sl_before_entry追加・144行）
- ✅ テスト実装（test_executor.py・5テストケース・140行追加）
- ✅ 品質チェック完全成功（1,245テスト全成功・65.42%カバレッジ）

**次回作業**: **Phase 51.9バックテスト完了待ち** → **Phase 51.10-B: バックテスト検証**

---

## 📊 Phase 51完走ロードマップ

| Phase | ステータス | 目的 | 期間 | 詳細ドキュメント |
|-------|-----------|------|------|-----------------|
| Phase 51.1-51.5 | ✅完了 | 市場レジーム分類・動的戦略管理基盤構築 | 11/02-04 | `docs/開発履歴/Phase_51.5.md` |
| Phase 51.6 | ✅完了 | TP/SL問題完全解決・Atomic Entry Pattern実装 | 11/05 | `docs/開発履歴/Phase_51.6.md` |
| Phase 51.7 | ✅完了 | 新戦略実装（6戦略統合・55特徴量システム確立） | 11/05-08 | `docs/開発履歴/Phase_51.7.md` |
| **Phase 51.8** | ✅完了 | **レジーム別戦略重み最適化+保有ポジション制限** | 11/08-09 | `docs/開発履歴/Phase_51.8.md` |
| **Phase 51.9** | ✅完了 | **真の3クラス分類実装+ML再学習完了** | 11/10 | `docs/開発履歴/Phase_51.9.md` |
| **Phase 51.10-A** | ✅完了 | **TP/SL孤児注文問題完全解決（Option D実装）** | 11/10 | `docs/開発履歴/Phase_51.9.md` |
| Phase 51.11 | ⏸未着手 | バックテスト総合検証（180日間） | 2-3日 | ⬇実装タスク詳細 |
| Phase 51.11 | ⏸未着手 | ペーパートレード検証（7日間） | 1週間 | ⬇実装タスク詳細 |
| Phase 51.12 | ⏸未着手 | 本番展開 + Phase 51完走宣言 | 1日 | ⬇実装タスク詳細 |

**Phase 51完走後のアクション**:
```
Phase 51.13完了 → 実運用3ヶ月（1万円→段階的拡大） → データ分析 → Phase 52判断
```

---

## ✅ Phase 51.8: レジーム別戦略重み最適化 + 保有ポジション制限（完了）

**完了日**: 2025/11/09

**達成成果**:
- ✅ レジーム別戦略重み最適化完了（tight_range重視型・データドリブン）
- ✅ レジーム別ポジション制限実装（tight_range: 6件、normal_range: 4件、trending: 2件、high_volatility: 0件）
- ✅ 180日間バックテスト成功（1,504取引・+16.12%）
- ✅ レジーム別統計分析完了（tight_range 99.4%利益寄与・PF=1.065）
- ✅ regime情報記録問題完全解決（manager.py・executor.py・reporter.py統合）
- ✅ バックテスト完全改修完了（Phase 51.8-1〜51.8-10サブPhase）

**詳細ドキュメント**: `docs/開発履歴/Phase_51.8.md`

---

## ✅ Phase 51.9: 真の3クラス分類実装完了（2025/11/10）

### 完了内容

**実施内容**:
- ✅ **真の3クラス分類実装**: 2→3クラス変換ロジック完全削除（ensemble.py・models.py・model_manager.py）
- ✅ **ML再学習完了**: 3クラス専用モデル生成（LightGBM・XGBoost・RandomForest）
- ✅ **特徴量数表記統一**: 17ファイル修正（54→55、48→49）
- ✅ **デッドコード削除**: `_add_strategy_signal_features_for_training()`削除（37行）
- ✅ **後方互換性削除**: 2クラスモデル対応コード完全削除（50行）
- 🔄 **バックテスト実行中**: phase51.9_3class_final（10,000サンプル）

### MLモデル性能（2025-11-10 18:50:01）

**F1スコア改善**（11/10 vs 11/8）:

| モデル | 11/10 Test F1 | 11/8 Test F1 | 改善率 |
|--------|---------------|--------------|--------|
| LightGBM | 0.443 | 0.404 | **+9.7%** |
| XGBoost | 0.358 | 0.332 | **+7.8%** |
| RandomForest | 0.411 | 0.395 | **+4.1%** |

**Optuna最適化結果**（50 trials）:
```json
{
  "lightgbm": {"best_score": 0.500, "params": {"learning_rate": 0.1697, "max_depth": 5}},
  "xgboost": {"best_score": 0.571, "params": {"learning_rate": 0.0140, "max_depth": 10}},
  "random_forest": {"best_score": 0.574, "params": {"max_depth": 9, "n_estimators": 85}}
}
```

### 達成成果

- **訓練と推論の一貫性確保**: 2→3クラス変換削除により真の3クラス分類実装
- **ML性能向上**: F1スコア +4.1〜+9.7%改善
- **技術的負債解消**: 後方互換性コード・デッドコード削除（87行）
- **特徴量数確定**: 55特徴量（49基本 + 6戦略シグナル）

### 詳細ドキュメント

`docs/開発履歴/Phase_51.9.md`（493行・完全記録）

---

## ✅ Phase 51.10-A: TP/SL孤児注文問題完全解決（完了）

**完了日**: 2025/11/10
**実施時間**: 21:50-22:00（10分）

### 完了内容

**実施内容**:
- ✅ **Option D実装完了**（Phase 51.6完全実装・Phase 46思想遵守）
- ✅ executor.py実装（`_cleanup_old_tp_sl_before_entry()`追加・144行）
- ✅ テスト実装（test_executor.py・5テストケース・140行追加）
- ✅ 品質チェック完全成功（1,245テスト全成功・65.42%カバレッジ）

### Option D設計（最終採用ソリューション）

**新しいソリューション追加**:
- Option A/B/Cの再検討中に最適解を発見
- Phase 46思想（個別TP/SL管理）+ Phase 51.6思想（Atomic Entry Pattern）の両立

**Option D実装内容**:
1. **Phase 46遵守**: 個別TP/SL管理維持（戦略別最適化可能性維持）
2. **Phase 51.6完成**: Atomic Entry Pattern維持（3注文一体化・全成功 or 全ロールバック）
3. **新機能追加**: エントリー前の同一側TP/SL注文クリーンアップ

**実装詳細**:
```python
# executor.py L1190-1318 (130行)
async def _cleanup_old_tp_sl_before_entry(
    self, side: str, symbol: str, entry_order_id: str
) -> None:
    """Phase 51.10-A: エントリー前の古いTP/SL注文クリーンアップ"""
```

**呼び出し箇所**（executor.py L387-399）:
- Atomic Entry Pattern実行前に呼び出し
- クリーンアップ失敗時も処理継続（警告ログのみ）

### 問題解決内容

**根本原因**: Phase 51.6 Atomic Entry Pattern実装不完全
- 14 BUYエントリー → 28 TP/SL注文累積
- 6件の古い注文（15,540,000円）未約定残存
- TP/SL配置率: -1.22%異常

**Option D解決策**:
- エントリー前に同一側の古いTP/SL注文をクリーンアップ
- アクティブポジションのTP/SL注文は保護
- Phase 51.6 Atomic Entry Patternを完全化

### 期待効果

- **TP/SL異常配置率**: -1.22% → 0.0%
- **未約定TP/SL残存**: 6件 → 0-2件（正常範囲）
- **Bitbank API 30注文制限リスク**: 高 → 低
- **Phase 46思想維持**: ✅（個別TP/SL管理継続）
- **Phase 51.6完全化**: ✅（Atomic Entry Pattern完成）

### テストカバレッジ

**5テストケース追加**（test_executor.py L1349-1487, 140行）:
1. `test_cleanup_old_tp_sl_before_entry_success` - 基本クリーンアップ成功
2. `test_cleanup_old_tp_sl_before_entry_with_protected_orders` - アクティブポジション保護
3. `test_cleanup_old_tp_sl_before_entry_no_orders` - 注文なしケース
4. `test_cleanup_old_tp_sl_before_entry_error_handling` - エラーハンドリング
5. `test_cleanup_old_tp_sl_before_entry_sell_side` - SELLエントリー側

### 次のステップ

- **Phase 51.9バックテスト完了待ち**（10,000サンプル実行中）
- **Phase 51.10-B: バックテスト検証**（Phase 51.10-A効果確認）

### 詳細ドキュメント

`docs/開発履歴/Phase_51.9.md`（Phase 51.10-Aセクション L490-748, 259行）

---

## Phase 51.11: バックテスト総合検証（2-3日）⭐⭐⭐⭐⭐

### 目的

**問題**: Phase 51.7-51.9で個別に最適化したが、全体統合後の性能が未確認

**解決**: 180日間の総合バックテストで最終性能評価

**期待効果**: Phase 51システムの収益性を数値で実証（Phase 50比+20-30%目標）

### 実装タスク

#### Step 1: バックテスト実行（1日）

**実施内容**:
- [ ] Phase 51システム バックテスト（180日間・15分足）
  ```bash
  python src/backtest/scripts/run_backtest.py
  ```
- [ ] Phase 50.9システム バックテスト（比較用）
  - git checkout Phase-50.9タグ
  - 同一期間でバックテスト実行
  - git checkout main

**測定メトリクス**:
```
1. 総損益（円）
2. 収益率（%）
3. 勝率（%）
4. 最大ドローダウン（%）
5. シャープレシオ
6. プロフィットファクター
7. 平均損益（円/取引）
8. 取引回数
```

#### Step 2: 性能基準確認（0.5日）⭐最重要

**Phase 51合格基準**:
```
必須基準（1つでも未達成なら要調整）:
1. 総損益 > 0円（利益確認）
2. 収益率 > Phase 50.9の収益率（改善確認）
3. 最大ドローダウン ≤ 20%（リスク管理）
4. 勝率 ≥ 55%（安定性確認）

目標基準（努力目標）:
5. 収益率 ≥ Phase 50.9 + 20%（レンジ相場改善目標）
6. シャープレシオ ≥ 1.0（リスク調整後収益）
7. 月次利益 ≥ 2,000円（運用コストカバー）
```

**判定**:
- 必須基準すべて達成 → Phase 51.11へ進む
- 必須基準1つでも未達成 → Phase 51.7-51.9に戻って調整

#### Step 3: matplotlib可視化（0.5日）

**実施内容**:
- [ ] エクイティカーブ（Phase 50 vs Phase 51比較）
- [ ] 損益分布ヒストグラム
- [ ] ドローダウン推移
- [ ] 価格チャート（エントリー・エグジット表示）
- [ ] レジーム別損益（tight_range・trending別）

**成果物**:
- `backtest_results_phase51.png`（4グラフ統合）
- `regime_performance_phase51.png`（レジーム別）

#### Step 4: 詳細分析レポート作成（0.5日）

**実施内容**:
- [ ] Markdown分析レポート作成
  - Phase 50 vs Phase 51比較表
  - レジーム別パフォーマンス
  - 戦略別貢献度
  - ML統合効果
  - 改善点・懸念点

**成果物**: `docs/分析/Phase_51_Backtest_Report.md`

#### Step 5: Git Commit & Phase 51.10完了宣言

### Phase 51.10期待効果

- **収益性実証**: バックテストで+20-30%改善確認
- **リスク確認**: 最大DD20%以内
- **データ可視化**: 性能グラフ・分析レポート

---

## Phase 51.12: ペーパートレード検証（1週間）⭐⭐⭐⭐

### 目的

**問題**: バックテストは過去データ・実市場と異なる可能性

**解決**: ペーパーモードで7日間実取引シミュレーション

**期待効果**: 実市場での動作確認・バックテストとの乖離検証

### 実装タスク

#### Step 1: ペーパーモード設定（0.5日）

**実施内容**:
- [ ] features.yaml確認
  ```yaml
  dynamic_strategy_selection:
    enabled: true   # レジーム別戦略選択ON
  ml_integration:
    enabled: true   # ML統合ON
  ```
- [ ] unified.yaml確認
  ```yaml
  mode: paper
  initial_balance: 10000.0
  ```
- [ ] GCP Cloud Runデプロイ（paper mode）
  ```bash
  bash scripts/deployment/deploy.sh paper
  ```

#### Step 2: 7日間監視（7日）⭐最重要

**実施内容**:
- [ ] 毎日のログ確認
  ```bash
  gcloud logging read "resource.type=cloud_run_revision" --limit=50
  ```
- [ ] レジーム遷移動作確認
  - tight_range → trending切り替えログ確認
  - 戦略重み変更ログ確認
- [ ] エントリー・エグジット記録
- [ ] Discord週間レポート確認（月曜9時）

**記録項目**:
```
1. エントリー回数（日別）
2. 勝敗（日別）
3. 損益（日別・累積）
4. レジーム分布（tight_range: X日、trending: Y日）
5. エラー・警告の有無
```

#### Step 3: 結果分析（0.5日）

**実施内容**:
- [ ] 7日間の損益サマリー
- [ ] バックテストとの乖離分析
  - 勝率の差
  - 平均損益の差
  - 取引回数の差
- [ ] 懸念点のリストアップ

**合格基準**:
```
1. エラーゼロ（システム安定性）
2. 総損益 ≥ 0円（利益 or 損益ゼロ以上）
3. バックテストとの勝率乖離 ≤ 10%（大幅乖離なし）
```

**不合格時の対応**:
- エラーあり → 修正してPhase 51.11再実行
- 大幅損失 → Phase 51.7-51.9に戻って調整
- バックテスト乖離大 → 原因分析・パラメータ調整

#### Step 4: Git Commit & Phase 51.11完了宣言

### Phase 51.11期待効果

- **実市場動作確認**: 7日間エラーゼロ
- **バックテスト検証**: 乖離10%以内
- **本番準備完了**: Phase 51.12へ進む準備完了

---

## Phase 51.13: 本番展開 + Phase 51完走宣言（1日）⭐⭐⭐⭐⭐

### 目的

**問題**: Phase 51.11ペーパーモード成功・本番デプロイ準備完了

**解決**: live modeで本番展開・Phase 51完走宣言

**期待効果**: Phase 51システム本番稼働開始・実運用データ収集開始

### 実装タスク

#### Step 1: 本番デプロイ（0.5日）

**実施内容**:
- [ ] unified.yaml更新
  ```yaml
  mode: live
  initial_balance: 10000.0   # 1万円スタート
  ```
- [ ] GCP Cloud Runデプロイ（live mode）
  ```bash
  bash scripts/deployment/deploy.sh live
  ```
- [ ] 本番環境ログ確認（初回24時間）
  ```bash
  gcloud logging read "resource.type=cloud_run_revision" --limit=100
  ```

#### Step 2: 24時間監視（1日）

**実施内容**:
- [ ] 毎時ログ確認
- [ ] エントリー・エグジット動作確認
- [ ] 残高・証拠金維持率確認
- [ ] エラー・警告の有無確認

**確認項目**:
```
1. システム稼働（24時間ダウンタイムゼロ）
2. エントリー判断（レジーム別戦略選択動作）
3. TP/SL配置（個別TP/SL正常動作）
4. 証拠金維持率（80%以上維持）
5. Discord通知（週間レポート配信）
```

#### Step 3: Phase 51完走宣言（0.5日）

**実施内容**:
- [ ] Phase_51.5.md更新
  - Phase 51.6-51.12セクション追加
  - バックテスト結果記載
  - ペーパートレード結果記載
  - 本番展開完了記載
- [ ] CLAUDE.md更新
  - Phase 51完走完了記載
  - Phase 52凍結記載
  - 実運用3ヶ月計画記載
- [ ] README.md更新
  - Phase 51完走バッジ追加
  - 最新の性能メトリクス記載
- [ ] ToDo.md更新
  - Phase 51完走マーク
  - Phase 52凍結明記
  - 実運用3ヶ月計画明記

#### Step 4: Git Commit & GitHub Release

**実施内容**:
- [ ] git tag作成
  ```bash
  git tag -a Phase-51-Complete -m "Phase 51完走: レンジ型最適化・戦略厳選・市場レジーム分類システム完成"
  git push origin Phase-51-Complete
  ```
- [ ] GitHub Release作成
  - リリースノート: Phase 51.6-51.12の成果
  - バックテスト結果・グラフ添付

### Phase 51.12期待効果

- **Phase 51完走**: 3週間の開発完了
- **本番稼働開始**: 1万円で実運用スタート
- **データ収集開始**: 次の3ヶ月で収益性実証

---

## 📊 Phase 51完走後のアクション（3ヶ月）

### 実運用データ収集計画

**期間**: Phase 51.12完了後 3ヶ月間

**実施内容**:
1. **毎日の記録**:
   - Discord週間レポート確認（毎週月曜9時）
   - 月次サマリー作成（手動・Excel or CSV）

2. **記録項目**:
   ```
   - 総損益（円）
   - 月次利益（円）
   - 勝率（%）
   - 取引回数
   - 最大ドローダウン（%）
   - レジーム分布（tight_range/trending発生頻度）
   - 戦略別貢献度
   ```

3. **月次評価**:
   - 1ヶ月目: データ収集のみ（調整なし）
   - 2ヶ月目: データ収集のみ（調整なし）
   - 3ヶ月目: データ収集 + 総合評価

### 3ヶ月後の評価基準

**成功判定**:
```
✅ 成功（Phase 52検討可）:
- 3ヶ月総損益 > 0円（利益確認）
- 月平均利益 ≥ 2,000円（運用コストカバー）
- 最大ドローダウン ≤ 20%（リスク管理）

⚠️ 微益（現状維持）:
- 3ヶ月総損益 > 0円だが月平均 < 2,000円
- 資金拡大は見送り・1万円継続

❌ 失敗（戦略見直し or 終了）:
- 3ヶ月総損益 < 0円（損失）
- Phase 51.7-51.9に戻って戦略調整
- または、プロジェクト終了判断
```

**Phase 52判断**:
```
成功時のみ Phase 52を検討:
1. Phase 52の内容を再評価（5分足移行は本当に必要か？）
2. データに基づいて優先度判断
3. Phase 53（オンチェーン指標）は引き続き凍結

微益・失敗時:
- Phase 52凍結継続
- Phase 51の戦略調整 or プロジェクト終了
```

---

## 🎯 開発方針・品質基準（Phase 51共通）

### KISS原則の徹底

- **Phase 51完走に集中**（Phase 52以降は凍結）
- **バックテスト評価必須**（データドリブンな戦略選択）
- **過度な複雑化を避ける**

### 品質保証プロセス

1. **バックテスト必須**: Phase 51.8-51.10で徹底評価
2. **段階的導入**: backtest → paper(7日) → live(3ヶ月)の3段階
3. **テスト100%維持**: 新機能は必ず単体・統合テスト追加
4. **カバレッジ維持**: 68%以上を維持

### 複雑化リスク管理

- **Phase 51完走でストップ**（Phase 52以降は実運用データで判断）
- **設定ファイル化の徹底**（ハードコード禁止）
- **レガシーコード即座削除**（Phase 51.5-Dの教訓）

---

## ❄️ 凍結タスク（Phase 51完了後に再検討）

### Phase 52: 5分足移行（凍結）

**凍結理由**:
- Phase 51完了後、実運用3ヶ月のデータ収集を優先
- 5分足の効果はバックテストでは不明確
- ノイズ増加・API呼び出し増加のリスク

**再検討条件**:
- Phase 51で3ヶ月成功（月2,000円以上利益）
- データ分析で5分足の必要性が明確化

### Phase 53: 特徴量拡張（凍結）

**凍結理由**:
- Phase 50.9で外部API削除した教訓（GCP環境不安定性）
- オンチェーン指標も外部API依存
- 複雑性増加 vs リターン不明

**再検討条件**:
- Phase 51で3ヶ月成功
- GCP環境での外部API安定性が実証される

---

**📅 最終更新**: 2025年11月10日 - **Phase 51.9完了**（真の3クラス分類実装・ML再学習F1改善+9.7%）・**Phase 51.10-A完了**（TP/SL孤児注文問題完全解決・Option D実装・144行追加・5テストケース追加・1,245テスト全成功）・Phase 51.9バックテスト実行中（10,000サンプル・残り5-10分）
