# 暗号資産取引Bot - 開発計画

## 現在の状態

**Phase 58完了** - TP/SL管理・ポジション同期問題修正

---

## Phase 58 完了サマリー

### 実施内容

| Phase | 内容 | 成果 |
|-------|------|------|
| 58.1 | TP/SL管理バグ修正（3件） | 決済注文発行・保護ロジック・複数処理対応 |
| 58.2 | ライブ分析スクリプト改善 | TP/SL量整合性チェック追加 |
| 58.3 | ポジション同期問題修正 | 実ポジション確認ロジック追加 |
| 58.4 | fetch_margin_positions APIエラー修正 | GETメソッド修正（エラー20003解消） |

### Phase 58.1: TP/SL管理バグ修正

| バグ | 原因 | 修正 |
|------|------|------|
| 決済注文未発行 | `_execute_position_exit()`がbitbankへ注文発行していない | 成行決済注文発行追加 |
| TP/SL誤削除 | 新規エントリー時に既存TP/SLを保護していない | 全ポジションのTP/SL保護 |
| 単一決済パターン | 1つ処理後に即return | 全ポジション処理後にまとめて削除 |

### Phase 58.2: ライブ分析スクリプト改善

- TP/SL注文量の整合性チェック追加
- カバー率表示機能追加

### Phase 58.3: ポジション同期問題修正

| 問題 | 原因 | 修正 |
|------|------|------|
| ノーポジを「66,738円あり」と誤認 | 維持率500%からポジション価値を逆算 | 実ポジション確認後に推定 |

修正ファイル:
- `bitbank_client.py`: `has_open_positions()`メソッド追加
- `monitor.py`: 実ポジション確認ロジック追加
- `executor.py`: 起動時の実ポジション確認ログ追加

### Phase 58.4: fetch_margin_positions APIエラー修正

| 問題 | 原因 | 修正 |
|------|------|------|
| API エラー20003 | `fetch_margin_positions()`がPOSTで呼び出し | GETメソッドに修正 |

影響していた機能:
- Phase 56.5: 既存ポジションTP/SL設置
- Phase 53.6: コンテナ再起動時復元
- 孤児注文クリーンアップ

修正ファイル:
- `bitbank_client.py`: `fetch_margin_positions()`にGETメソッド指定

---

## Phase 59: 戦略最適化（次期計画）

### 目的

Phase 57分析結果に基づき、パフォーマンスを低下させている戦略を最適化する。

### 基準値（Phase 57バックテスト: 2025/07/01〜2025/12/31）

| 指標 | Phase 57結果 | Phase 59目標 |
|------|-------------|-------------|
| 総損益 | ¥+23,073 | **≥¥+28,000** |
| PF | 1.18 | **≥1.25** |
| 勝率 | 44.7% | **≥46%** |

### Phase 59.1: BBReversal無効化

#### 背景

| 指標 | 値 |
|------|-----|
| 取引数 | 12件 (2.4%) |
| 勝率 | **8.3%** |
| 損益 | **¥-5,451** |

勝率8.3%は統計的に異常（コイントス以下）。

#### 実装内容

| ファイル | 変更内容 |
|---------|---------|
| `config/core/thresholds.yaml` | BBReversal重みを0に設定 |

#### 期待効果

- 損益改善: +¥5,451
- 予測総損益: ¥+28,524

### Phase 59.2: DonchianChannel重み削減

#### 背景

| 指標 | 値 |
|------|-----|
| 取引数 | 88件 (17.6%) |
| 勝率 | 42.0% |
| 損益 | **¥-3,560** |

#### 実装内容

| ファイル | 変更内容 |
|---------|---------|
| `config/core/thresholds.yaml` | DonchianChannel重みを削減 |

### Phase 59.3: 信頼度フィルター見直し（検討）

#### 背景

| 信頼度帯 | 勝率 |
|---------|------|
| 低（<50%） | 43.8% |
| 高（≥65%） | **36.4%** |

高信頼度帯の勝率が低信頼度帯より低い逆転現象。

---

## 保留タスク

| タスク | 優先度 | 備考 |
|--------|--------|------|
| BBReversal無効化 | 高 | Phase 59.1で対応予定 |
| DonchianChannel重み削減 | 中 | Phase 59.2で対応予定 |
| 信頼度フィルター見直し | 低 | 要追加調査 |
| 戦略分析とバックテストの乖離調査 | 中 | 戦略帰属ルールの影響 |

---

## 関連ファイル

| ファイル | 内容 |
|---------|------|
| `docs/開発履歴/Phase_57.md` | Phase 57完了記録 |
| `docs/開発履歴/Phase_58.md` | Phase 58完了記録 |
| `config/core/thresholds.yaml` | 戦略重み設定 |
| `scripts/backtest/standard_analysis.py` | バックテスト標準分析 |
| `scripts/live/standard_analysis.py` | ライブモード標準分析 |
| `docs/検証記録/analysis_history.csv` | 分析履歴 |

---

**最終更新**: 2026年1月10日 - Phase 58.4完了・Phase 59計画準備中
