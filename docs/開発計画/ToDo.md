# 暗号資産取引Bot - 開発計画

## 📋 このファイルの目的

**Claude Codeに読み込ませ、Phase 54開発を実行するための計画ファイル**

---

## 🎯 現在の状態

**Phase 53完了** - GCP安定化・バグ修正完了（2025/12/15）

**最新バックテスト結果**（Phase 53.13 - 2025/12/15）:
- **PF**: 1.25
- **勝率**: 47.9%
- **取引数**: 697件
- **シャープレシオ**: 7.83
- **最大DD**: 0.33%

**ベースライン**（Phase 52.1最良値）:
- **PF**: 1.34
- **勝率**: 51.4%

**現在の課題**: PF -0.09、勝率 -3.5%の性能低下

---

## 🚀 Phase 54: ML性能検証・戦略最適化（慎重な段階的実装）

### 目的

**ML予測と戦略の最適化による性能回復（PF 1.25 → 1.34+）**

### 方針

**分析→判断→実装→検証のサイクルを1つずつ慎重に実行**

---

## ステージ1: 分析フェーズ（コード変更なし）

### Phase 54.0: ML予測分析 ✅ 完了

**目的**: ML予測の分布・精度を可視化し、問題点を特定

**タスク**:
- [x] バックテストログからBUY/SELL/HOLD比率を集計
- [x] 予測信頼度の分布を確認
- [x] レジーム別性能分析

**結果**（2025/12/16）:
- BUY/SELL比率: 51.8% / 48.2%（均等・健全）
- レジーム分布: tight_range 93.3% / normal_range 6.7%
- 主要問題: 勝率47.9%（目標51%に-3.1pt）

**成果物**: `docs/検証記録/Phase_54.0_ML分析_20251216.md`

---

### Phase 54.1: 戦略別性能分析 ✅ 完了

**目的**: 各戦略の個別性能を測定し、弱点を特定

**タスク**:
- [x] スクリプト修正（60日分15m足対応）
- [x] 60日分データで戦略評価実行（5,748行）
- [x] 戦略別性能レポート作成

**結果**（2025/12/16）:

| 戦略 | 取引数 | 勝率 | PF | 評価 |
|------|--------|------|-----|------|
| ATRBased | 322 | 62.4% | 0.86 | **問題: RR比0.52:1** |
| DonchianChannel | 426 | 60.8% | 0.91 | **問題: RR比0.59:1** |
| ADXTrendStrength | 179 | 33.5% | 1.04 | 中立 |
| BBReversal | 14 | 42.9% | **1.92** | **最高性能** |
| StochasticReversal | 9 | 11.1% | 0.02 | **致命的・削除候補** |
| MACDEMACrossover | 24 | 33.3% | 1.50 | 良好 |

**主要発見**:
1. 主力戦略（ATRBased, DonchianChannel）がPF<1.0
2. BBReversalが最高性能（PF 1.92）だが重み0.35は過小
3. StochasticReversalは即時削除が必要（PF 0.02）

**成果物**: `docs/検証記録/Phase_54.1_戦略別分析_20251216.md`

---

## ステージ2: 実装フェーズ（分析結果に基づく）

### Phase 54.2: 戦略エントリー基準厳格化 ✅ 完了

**目的**: tight_range戦略のエントリー基準を厳格化し、低質取引を削減

**実施内容**（2025/12/16）:

#### 設定変更（thresholds.yaml）

1. **tight_range重み配分変更**:
   - [x] ATRBased: 0.45 → **0.30**
   - [x] BBReversal: 0.35 → **0.50**
   - [x] DonchianChannel: 0.10 → **0.20**
   - [x] StochasticReversal: 0.10 → **0.00**（無効化）

2. **ATRBased閾値厳格化**:
   - [x] bb_overbought: 0.7 → **0.85**
   - [x] bb_oversold: 0.3 → **0.15**
   - [x] rsi_overbought: 65 → **70**
   - [x] rsi_oversold: 35 → **30**
   - [x] min_confidence: 0.25 → **0.35**
   - [x] weak_signal_enabled: **false**（新規）

3. **DonchianChannel閾値厳格化**:
   - [x] min_confidence: 0.25 → **0.35**
   - [x] weak_signal_enabled: **false**（新規）

#### コード変更

- [x] `atr_based.py`: weak_signal_enabled設定に対応（微弱シグナル無効化）
- [x] `donchian_channel.py`: weak_signal_enabled設定に対応（弱シグナル無効化）
- [x] `test_atr_based.py`: 新閾値に合わせたテスト更新

**検証結果**（60日分15m足データ - 5,748行）:

| 戦略 | 変更前取引数 | 変更後取引数 | 変更前PF | 変更後PF | 評価 |
|------|------------|------------|----------|----------|------|
| ATRBased | 322 | **205** (-36%) | 0.86 | **0.96** | **PF改善+0.10** |
| DonchianChannel | 426 | **185** (-57%) | 0.91 | 0.89 | 微低下 |
| BBReversal | 14 | 14 | 1.92 | 1.92 | 維持 |
| StochasticReversal | 9 | 9 | 0.02 | 0.02 | 維持（無効化済） |
| 合計取引数 | 771 | **390** | - | - | 300件以上維持 |

**成果**:
- ATRBased: PF 0.86→0.96（+11.6%改善）
- 低質取引削減: 771件→390件（-49.4%）
- 取引品質向上傾向

**バックアップ**: `docs/検証記録/Phase_54.2_変更前設定_backup.md`

---

### Phase 54.3-A: BBReversal閾値緩和実験 ✅ 完了（却下）

**目的**: BBReversal（PF 1.92）の取引数を増やし、最高PF戦略の寄与を最大化

**実験内容**（2025/12/16）:

1. **積極的緩和**: BB 0.95/0.05 → 0.85/0.15、RSI 70/30 → 65/35
2. **控えめ緩和**: BB 0.95/0.05 → 0.90/0.10（RSI維持）

**検証結果**:

| 設定 | 取引数 | PF | 評価 |
|------|--------|-----|------|
| **オリジナル** (BB 0.95/0.05) | 14 | **1.92** | 最高品質 |
| 積極的緩和 (BB 0.85/0.15) | 27 | 1.12 | **PF -42%低下** |
| 控えめ緩和 (BB 0.90/0.10) | 17 | 1.12 | **PF -42%低下** |

**結論**:
- BBReversal閾値の緩和は取引数増加に寄与するが、PF低下が大きすぎて逆効果
- **オリジナル設定（BB 0.95/0.05）を維持**
- 取引品質を犠牲にして取引数を増やすアプローチは採用しない

---

### Phase 54.3-B: ATRBased・DonchianChannel PF改善 ✅ 完了（部分成功）

**目的**: ATRBased（PF 0.96）とDonchianChannel（PF 0.89）のPFを1.0+に改善

**実施内容**（2025/12/16）:

1. **ATRBased厳格化**:
   - BB閾値: 0.85/0.15 → 0.90/0.10
   - RSI閾値: 70/30 → 75/25
   - min_confidence: 0.35 → 0.40

2. **DonchianChannel厳格化**:
   - min_confidence: 0.35 → 0.40
   - reversal_threshold: 0.05 → 0.03

**検証結果**:

| 戦略 | 変更前PF | 変更後PF | 評価 |
|------|----------|----------|------|
| **DonchianChannel** | 0.89 | **1.08** | **目標達成 +21%** |
| ATRBased | 0.96 | 0.89 | **逆効果 -7%** |

**最終設定**:
- **DonchianChannel**: Phase 54.3-B設定を維持（PF 1.08達成）
- **ATRBased**: Phase 54.2設定に戻す（過剰厳格化が逆効果）

---

### Phase 54.4: ATRBasedコード改善 🔄 進行中

**目的**: ATRBased（PF 0.96）をコードレベルで改善し、PF 1.0+を達成

**問題分析**:

ATRBased（PF 0.96）とBBReversal（PF 1.92）の比較:

| 項目 | ATRBased（問題） | BBReversal（成功） |
|------|------------------|-------------------|
| シグナル条件 | BB **または** RSI | BB **かつ** RSI |
| ADXフィルタ | なし | < 20（レンジのみ） |
| RR比 | 0.67:1 | 2.56:1 |

**実施内容**（2025/12/16）:

1. **設定追加（thresholds.yaml）**:
   - [x] require_both_signals: true（BB+RSI両方必須）
   - [x] adx_filter_threshold: 25（ADX > 25でHOLD）
   - [x] tight_range重み戻し（ATR 0.30, BBR 0.50）

2. **コード変更（atr_based.py）**:
   - [x] ADXフィルタ追加（トレンド相場での逆張り回避）
   - [x] require_both_signals設定に対応（シグナル条件厳格化）
   - [x] get_required_featuresにadx_14追加

**検証結果**（120日分析スクリプト）:

| 戦略 | 変更前PF | 変更後PF | 変化 |
|------|----------|----------|------|
| **ATRBased** | 0.96 | **1.83** | **+90.6%** |
| BBReversal | 1.92 | 1.92 | 維持 |
| MACDEMACrossover | 1.50 | 1.56 | +4% |
| DonchianChannel | 1.08 | 1.09 | 維持 |
| ADXTrendStrength | - | 1.04 | 維持 |
| StochasticReversal | 0.02 | 0.02 | 維持（無効化済） |

**コミット**: d6463b3b

**180日バックテスト**: GitHub Actions実行中（Run ID: 20259416064）

---

### Phase 54.5: 最終検証

**目的**: 全変更の総合効果を確認

**成功基準**:

| 指標 | 現在値 | 最低限 | 目標値 |
|------|--------|--------|--------|
| PF | 1.25 | ≥1.30 | ≥1.35 |
| 勝率 | 47.9% | ≥50% | ≥51% |
| シャープレシオ | 7.83 | - | ≥9.0 |
| 最大DD | 0.33% | ≤0.5% | ≤0.5% |

---

## ⚠️ リスク管理

### ロールバック基準
- PFが1.20未満に低下 → 即時ロールバック
- 勝率が45%未満に低下 → 即時ロールバック
- 取引数が500件未満に減少 → 要検討

### フォールバック
- Phase 53.13の設定をベースラインとして保持
- 問題発生時は即座にロールバック可能

---

## 📊 実装優先順位

1. **Phase 54.0** - ML予測分析（分析のみ・コード変更なし）
2. **Phase 54.1** - 戦略別性能分析（分析のみ・コード変更なし）
3. **Phase 54.2** - 設定調整（thresholds.yamlのみ・1つずつ検証）
4. **Phase 54.3** - コード変更（必要な場合のみ）
5. **Phase 54.4** - 統合検証（効果確認）

---

## 🎯 開発方針

### 品質保証プロセス

1. **テスト100%維持**: 新機能は必ず単体・統合テスト追加
2. **カバレッジ維持**: 65%以上維持
3. **CI/CD維持**: GitHub Actions自動品質ゲート
4. **段階的導入**: backtest → paper → live

### KISS原則の徹底

- **データドリブン**: バックテスト結果に基づく判断
- **過度な複雑化を避ける**: 戦略追加より既存最適化
- **1つずつ検証**: 複数変更の同時適用を避ける

---

## 🔮 Phase 54.7予定: ML最適化（取引数増加）

### 目的

ML信頼度閾値の緩和により、取引数をさらに増加させる

### 実施予定内容

1. **tight_range min_ml_confidence緩和**: 0.50 → 0.45
2. **disagreement_penalty緩和**: 0.90 → 0.95
3. **hold_conversion_threshold緩和**: 0.30 → 0.25

### 対象ファイル

- `config/core/thresholds.yaml`: ML統合設定

### 成功基準

- 取引数: ≥500件/180日（Phase 54.6比+40%）
- PF: ≥1.15維持
- 勝率: ≥48%維持

---

**📅 最終更新**: 2025年12月17日 - **Phase 54.6進行中（ポジションサイズ10%・取引数回復・180日バックテスト準備中）**
