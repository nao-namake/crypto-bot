# 🚀 AI自動取引システム稼働診断（インフラ・基盤システム編）

**最終更新**: 2025年10月2日 - Phase 32.1対応・NoneType検出・取引阻害エラー検出追加

## ⚠️ 重要: まずREADME.mdを読んでください

**このファイルを実行する前に、必ず [README.md](./README.md) を先に読んで全体の構成・実行順序・推奨フローを理解してください。**

## 📋 概要

このファイルは、AI自動取引システムのインフラ・基盤システムの健全性を診断するためのチェックスクリプト集です。Cloud Run、Secret Manager、Discord通知、Container安定性など、システムの土台となる部分を重点的にチェックします。

**Phase 32.1対応**: NoneType エラー検出、API応答異常検出、取引実行後エラー検出機能を追加しました。

## 🎯 診断対象

- 🚨 **Cloud Run**: サービス稼働状況・リビジョン管理
- 🔐 **Secret Manager**: API認証情報の権限・アクセス状況
- 📨 **Discord通知**: Webhook接続・通知システム
- 🔥 **Container安定性**: プロセス管理・async/await問題
- 💰 **API接続**: bitbank API認証・データ取得
- ⚠️ **エラー監視**: ログ分析・警告検出
- 🛡️ **Phase 32.1追加**: NoneType エラー・API応答異常・取引阻害エラー検出

## 📂 関連ファイル

- **[02_Bot機能診断.md](./02_Bot機能診断.md)** - Bot固有機能（特徴量・戦略・ML）のチェック
- **[03_緊急対応マニュアル.md](./03_緊急対応マニュアル.md)** - 問題発生時の修正手順

---

## 🚀 クイック診断スクリプト（5分）

### 準備: 共通関数定義（macOS最適化）

```bash
#!/bin/bash
# AI自動取引システム基盤診断スクリプト（macOS対応版）
echo "🚀 AI自動取引システム基盤診断開始: $(python3 -c "import datetime; print(datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9))).strftime('%Y-%m-%d %H:%M:%S JST'))")"

# 最新CI時刻取得（macOS対応・GNU dateを使わない）
LATEST_CI_UTC=$(gh run list --limit=1 --workflow="CI/CD Pipeline" --status=success --json=createdAt --jq='.[0].createdAt' 2>/dev/null)
if [ -n "$LATEST_CI_UTC" ]; then
    LATEST_CI_JST=$(python3 -c "
import datetime
utc_time = datetime.datetime.fromisoformat('$LATEST_CI_UTC'.replace('Z', '+00:00'))
jst_time = utc_time.astimezone(datetime.timezone(datetime.timedelta(hours=9)))
print(jst_time.strftime('%Y-%m-%d %H:%M:%S JST'))
")
    echo "✅ 最新CI時刻: $LATEST_CI_JST"
    DEPLOY_TIME="$LATEST_CI_UTC"
else
    # macOS対応: GNU date -d を使わずPython3で計算
    DEPLOY_TIME=$(python3 -c "
import datetime
utc_time = datetime.datetime.now(datetime.timezone.utc) - datetime.timedelta(days=1)
print(utc_time.strftime('%Y-%m-%dT%H:%M:%S.%fZ'))
")
    echo "⚠️ CI時刻取得失敗、過去24時間のログを確認"
fi

# 共通関数定義（macOS対応・wc -l エラー回避）
show_logs_since_deploy() {
    local query="$1"
    local limit="${2:-10}"
    if [ -n "$DEPLOY_TIME" ]; then
        gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND ($query) AND timestamp>=\"$DEPLOY_TIME\"" --limit="$limit" --format="value(timestamp.date(tz='Asia/Tokyo'),textPayload)"
    else
        echo "❌ DEPLOY_TIME未設定"
    fi
}

# macOS対応カウント関数（grep -c でカウント）
count_logs_since_deploy() {
    local query="$1"
    local limit="${2:-50}"
    if [ -n "$DEPLOY_TIME" ]; then
        gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND ($query) AND timestamp>=\"$DEPLOY_TIME\"" --limit="$limit" --format="value(textPayload)" | grep -c . || echo "0"
    else
        echo "0"
    fi
}

# スコア初期化
CRITICAL_ISSUES=0
WARNING_ISSUES=0
NORMAL_CHECKS=0
```

### A. 致命的システム障害チェック

```bash
echo ""
echo "🚨 致命的システム障害チェック"

# 1. Secret Manager権限確認
SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)" 2>/dev/null)
if [ -n "$SERVICE_ACCOUNT" ]; then
    echo "✅ サービスアカウント: $SERVICE_ACCOUNT"

    # macOS対応: 各Secret Manager権限確認
    BITBANK_KEY_ACCESS=$(gcloud secrets get-iam-policy bitbank-api-key --format="value(bindings[].members)" 2>/dev/null | grep -q "$SERVICE_ACCOUNT" && echo "OK" || echo "NG")
    BITBANK_SECRET_ACCESS=$(gcloud secrets get-iam-policy bitbank-api-secret --format="value(bindings[].members)" 2>/dev/null | grep -q "$SERVICE_ACCOUNT" && echo "OK" || echo "NG")
    DISCORD_ACCESS=$(gcloud secrets get-iam-policy discord-webhook-url --format="value(bindings[].members)" 2>/dev/null | grep -q "$SERVICE_ACCOUNT" && echo "OK" || echo "NG")

    if [ "$BITBANK_KEY_ACCESS" = "OK" ] && [ "$BITBANK_SECRET_ACCESS" = "OK" ] && [ "$DISCORD_ACCESS" = "OK" ]; then
        echo "✅ Secret Manager権限: 正常 (API Key/Secret/Discord 全て OK)"
        NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
    else
        echo "❌ Secret Manager権限: 欠如 (API Key:$BITBANK_KEY_ACCESS / Secret:$BITBANK_SECRET_ACCESS / Discord:$DISCORD_ACCESS)"
        CRITICAL_ISSUES=$((CRITICAL_ISSUES + 2))
    fi
else
    echo "❌ サービスアカウント取得失敗"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 2))
fi

# 2. Container安定性確認
echo ""
echo "🔥 Container安定性・非同期処理確認"
CONTAINER_EXIT_COUNT=$(count_logs_since_deploy "textPayload:\"Container called exit(1)\"" 20)
RUNTIME_WARNING_COUNT=$(count_logs_since_deploy "textPayload:\"RuntimeWarning\" AND textPayload:\"never awaited\"" 20)

echo "   Container exit(1): $CONTAINER_EXIT_COUNT回"
echo "   RuntimeWarning: $RUNTIME_WARNING_COUNT回"

if [ $CONTAINER_EXIT_COUNT -lt 5 ] && [ $RUNTIME_WARNING_COUNT -eq 0 ]; then
    echo "✅ Container安定性: 正常"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
elif [ $CONTAINER_EXIT_COUNT -lt 10 ] && [ $RUNTIME_WARNING_COUNT -lt 5 ]; then
    echo "⚠️ Container軽微問題 (要監視)"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
else
    echo "❌ Container深刻問題 (async/await問題・頻繁クラッシュ)"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

# 3. Discord監視確認
echo ""
echo "📨 Discord監視機能確認"
DISCORD_ERROR_COUNT=$(count_logs_since_deploy "textPayload:\"code: 50027\" OR textPayload:\"Invalid Webhook Token\"" 5)
if [ $DISCORD_ERROR_COUNT -eq 0 ]; then
    echo "✅ Discord監視: 正常 (Webhook Token有効)"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
else
    echo "❌ Discord監視: 停止 (Webhook Token無効・エラー ${DISCORD_ERROR_COUNT}回)"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi
```

### B. 基盤システム稼働チェック

```bash
echo ""
echo "🔧 基盤システム稼働チェック"

# 1. ライブモード設定確認
MODE_VALUE=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="yaml" 2>/dev/null | grep -A 2 "name: MODE" | grep "value:" | awk '{print $2}')
DEPLOY_STAGE_VALUE=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="yaml" 2>/dev/null | grep -A 2 "name: DEPLOY_STAGE" | grep "value:" | awk '{print $2}')

if [ "$MODE_VALUE" = "live" ] && [ "$DEPLOY_STAGE_VALUE" = "live" ]; then
    echo "✅ ライブモード: 正常 (MODE=live, DEPLOY_STAGE=live)"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
else
    echo "⚠️ ライブモード: 設定確認要 (MODE=$MODE_VALUE, DEPLOY_STAGE=$DEPLOY_STAGE_VALUE)"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
fi

# 2. API残高取得確認（フォールバック vs 実API判定）
echo ""
echo "💰 API残高取得確認"
API_BALANCE_COUNT=$(count_logs_since_deploy "textPayload:\"10,000円\"" 15)
FALLBACK_BALANCE_COUNT=$(count_logs_since_deploy "textPayload:\"11,000円\"" 15)

echo "   API残高(10,000円): $API_BALANCE_COUNT回"
echo "   フォールバック(11,000円): $FALLBACK_BALANCE_COUNT回"

if [ $API_BALANCE_COUNT -gt 0 ] && [ $FALLBACK_BALANCE_COUNT -eq 0 ]; then
    echo "✅ API残高取得: 正常 (実API使用中)"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
elif [ $FALLBACK_BALANCE_COUNT -gt 0 ]; then
    echo "⚠️ フォールバック残高使用中 (API認証問題の可能性)"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
else
    echo "❌ 残高取得: 失敗 (API・フォールバック両方とも確認できず)"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

# 3. システム稼働確認（取引サイクル）
echo ""
echo "⚙️ システム稼働確認"
LIVE_TRADING_COUNT=$(count_logs_since_deploy "textPayload:\"livetradingモード\" OR textPayload:\"取引サイクル開始\"" 12)
if [ $LIVE_TRADING_COUNT -gt 0 ]; then
    echo "✅ システム稼働: 正常 ($LIVE_TRADING_COUNT回の取引サイクル確認)"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
else
    echo "⚠️ システム稼働: 取引サイクル未確認"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
fi

# 4. 現在の稼働状況詳細確認
echo ""
echo "🔄 現在の稼働状況詳細確認"
echo "最新リビジョン状況:"
TZ='Asia/Tokyo' gcloud run revisions list --service=crypto-bot-service-prod --region=asia-northeast1 --limit=3 --format="table(metadata.name,metadata.creationTimestamp.date(tz='Asia/Tokyo'),status.conditions[0].status)"

echo ""
echo "Cloud Run サービス状況:"
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="table(metadata.name,status.conditions.type,status.conditions.status)" | head -3

# 5. Phase 32.1: 取引阻害エラー検出（NoneType・API応答異常）
echo ""
echo "🛡️ Phase 32.1: 取引阻害エラー検出"

# NoneType エラー検出
NONETYPE_ERROR_COUNT=$(count_logs_since_deploy "textPayload:\"NoneType\" OR textPayload:\"float().*argument\"" 20)
echo "   NoneType エラー: $NONETYPE_ERROR_COUNT回"

if [ $NONETYPE_ERROR_COUNT -eq 0 ]; then
    echo "✅ NoneType エラー: なし"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
elif [ $NONETYPE_ERROR_COUNT -lt 5 ]; then
    echo "⚠️ NoneType エラー: 軽微 ($NONETYPE_ERROR_COUNT回・要監視)"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
else
    echo "❌ NoneType エラー: 多発 ($NONETYPE_ERROR_COUNT回・Phase 32.1対策必要)"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

# API応答異常検出（bitbank API エラー20003等）
API_ERROR_COUNT=$(count_logs_since_deploy "textPayload:\"bitbank API エラー\" OR textPayload:\"API.*エラー.*20\"" 20)
echo "   bitbank API異常: $API_ERROR_COUNT回"

if [ $API_ERROR_COUNT -eq 0 ]; then
    echo "✅ API応答: 正常"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
elif [ $API_ERROR_COUNT -lt 5 ]; then
    echo "⚠️ API応答: 軽微エラー ($API_ERROR_COUNT回)"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
else
    echo "❌ API応答: 異常多発 ($API_ERROR_COUNT回)"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
fi

# 取引実行エラー検出（注文作成成功後のエラー）
TRADE_EXECUTION_ERROR_COUNT=$(count_logs_since_deploy "textPayload:\"取引実行エラー\" OR textPayload:\"ライブ取引実行失敗\"" 20)
echo "   取引実行エラー: $TRADE_EXECUTION_ERROR_COUNT回"

if [ $TRADE_EXECUTION_ERROR_COUNT -eq 0 ]; then
    echo "✅ 取引実行: エラーなし"
    NORMAL_CHECKS=$((NORMAL_CHECKS + 1))
elif [ $TRADE_EXECUTION_ERROR_COUNT -lt 3 ]; then
    echo "⚠️ 取引実行: 軽微エラー ($TRADE_EXECUTION_ERROR_COUNT回)"
    WARNING_ISSUES=$((WARNING_ISSUES + 1))
else
    echo "❌ 取引実行: 阻害エラー多発 ($TRADE_EXECUTION_ERROR_COUNT回・取引に影響あり)"
    CRITICAL_ISSUES=$((CRITICAL_ISSUES + 2))
fi
```

### C. 最終判定（基盤システム）

```bash
echo ""
echo "=============================================================="
echo "📊 基盤システム診断結果"
echo "✅ 正常項目: $NORMAL_CHECKS"
echo "⚠️ 警告項目: $WARNING_ISSUES"
echo "❌ 致命的問題: $CRITICAL_ISSUES"

# 特別な致命的問題フラグ（即座対応必須）
FATAL_ISSUES=false
FATAL_REASONS=""

if [ "$BITBANK_KEY_ACCESS" != "OK" ] || [ "$BITBANK_SECRET_ACCESS" != "OK" ] || [ "$DISCORD_ACCESS" != "OK" ]; then
    FATAL_ISSUES=true
    FATAL_REASONS="$FATAL_REASONS Secret Manager権限欠如"
fi

if [ $DISCORD_ERROR_COUNT -gt 0 ]; then
    FATAL_ISSUES=true
    FATAL_REASONS="$FATAL_REASONS Discord監視停止"
fi

# macOS対応スコア計算（重要度重み付け）
TOTAL_SCORE=$((NORMAL_CHECKS * 10 - WARNING_ISSUES * 3 - CRITICAL_ISSUES * 20))
echo "🏆 総合スコア: $TOTAL_SCORE点"

# 最終判定
echo ""
echo "🎯 基盤システム最終判定"

if [ "$FATAL_ISSUES" = "true" ]; then
    echo "💀 即座対応必須 - 致命的システム障害検出"
    echo "   🚨 検出問題:$FATAL_REASONS"
    echo "   → 03_緊急対応マニュアル.md を即座実行"
    exit 1
elif [ $CRITICAL_ISSUES -ge 3 ]; then
    echo "🔴 緊急対応必要 - 多数の致命的問題 ($CRITICAL_ISSUES件)"
    echo "   → システム全体の安定性に深刻な影響"
    echo "   → 03_緊急対応マニュアル.md 実行"
    exit 1
elif [ $CRITICAL_ISSUES -ge 1 ]; then
    echo "🟠 要注意 - 致命的問題検出 ($CRITICAL_ISSUES件)"
    echo "   → 基盤システムの一部に深刻な問題"
    echo "   → 詳細診断推奨"
    exit 2
elif [ $WARNING_ISSUES -ge 4 ]; then
    echo "🟡 監視継続 - 警告多数 ($WARNING_ISSUES件)"
    echo "   → 基盤システム品質低下・予防的対応推奨"
    exit 3
else
    echo "🟢 基盤システム正常 - インフラ基盤良好稼働"
    echo "   ✨ Cloud Run・Secret Manager・Discord・Container すべて正常"
    echo "   📊 正常: $NORMAL_CHECKS件, 警告: $WARNING_ISSUES件, 致命的: $CRITICAL_ISSUES件"
    echo "   🚀 次のステップ: 02_Bot機能診断.md でBot機能チェック推奨"
    exit 0
fi
```

---

## 🔍 詳細診断（基盤システム問題時）

### 🔐 Secret Manager・権限問題詳細診断

**いつ使用**: クイック診断でSecret Manager権限問題が検出された時

```bash
echo "=== Secret Manager・権限問題詳細診断（macOS対応） ==="

# 1. シークレット存在・バージョン確認
echo "1. シークレット存在・バージョン確認:"
echo "   bitbank-api-key:"
gcloud secrets versions list bitbank-api-key --limit=3 --format="table(name,state,createTime.date('%Y-%m-%d %H:%M:%S'))"
echo "   bitbank-api-secret:"
gcloud secrets versions list bitbank-api-secret --limit=3 --format="table(name,state,createTime.date('%Y-%m-%d %H:%M:%S'))"
echo "   discord-webhook-url:"
gcloud secrets versions list discord-webhook-url --limit=3 --format="table(name,state,createTime.date('%Y-%m-%d %H:%M:%S'))"

# 2. 詳細権限確認
echo ""
echo "2. 詳細IAM権限確認:"
SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)")
echo "   サービスアカウント: $SERVICE_ACCOUNT"

for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
    echo "   $secret 権限:"
    gcloud secrets get-iam-policy $secret --format="table(bindings[].role,bindings[].members[])" 2>/dev/null || echo "     ❌ 権限確認失敗"
done

# 3. サービスアカウント詳細情報
echo ""
echo "3. サービスアカウント詳細:"
gcloud iam service-accounts describe $SERVICE_ACCOUNT 2>/dev/null || echo "❌ SA情報取得失敗"

# 4. Cloud Run環境変数確認
echo ""
echo "4. Cloud Run環境変数確認:"
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="table(spec.template.spec.containers[0].env[].name,spec.template.spec.containers[0].env[].value)"

# 5. Secret取得テスト（安全な方法）
echo ""
echo "5. Secret取得テスト（権限確認用）:"
for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
    if gcloud secrets versions access latest --secret="$secret" --format="value(payload.data)" | base64 -d | head -c 10 >/dev/null 2>&1; then
        echo "   $secret: ✅ アクセス可能"
    else
        echo "   $secret: ❌ アクセス不可"
    fi
done

echo ""
echo "6. 🚨 緊急修正コマンド（必要時は 03_緊急対応マニュアル.md 参照）"
```

### 🔥 Container安定性・非同期処理詳細診断

**いつ使用**: Container exit(1)やRuntimeWarningが多発している時

```bash
echo "=== Container安定性・非同期処理詳細診断（macOS対応） ==="

# 1. Container問題パターン分析
echo "1. Container問題パターン分析:"
echo "   exit(1) 詳細ログ:"
show_logs_since_deploy "textPayload:\"Container called exit(1)\"" 15

echo "   RuntimeWarning詳細ログ:"
show_logs_since_deploy "textPayload:\"RuntimeWarning\" AND textPayload:\"never awaited\"" 15

# 2. async/await問題特定
echo ""
echo "2. async/await問題特定:"
echo "   check_stop_conditions非同期問題:"
show_logs_since_deploy "textPayload:\"check_stop_conditions\"" 8

echo "   trading_cycle_manager.py問題:"
show_logs_since_deploy "textPayload:\"trading_cycle_manager.py\"" 5

echo "   persistence async問題:"
show_logs_since_deploy "textPayload:\"persistence\" AND textPayload:\"async\"" 8

# 3. メモリ・リソース問題確認
echo ""
echo "3. メモリ・リソース問題確認:"
MEMORY_HIGH_COUNT=$(count_logs_since_deploy "textPayload:\"メモリ.*9[0-9]%\" OR textPayload:\"memory.*9[0-9]%\"" 15)
OOM_ERROR_COUNT=$(count_logs_since_deploy "textPayload:\"OutOfMemoryError\" OR textPayload:\"MemoryError\" OR textPayload:\"OOM\"" 10)

echo "   メモリ使用率90%以上: $MEMORY_HIGH_COUNT回"
echo "   OOMエラー発生: $OOM_ERROR_COUNT回"

if [ $MEMORY_HIGH_COUNT -gt 5 ] || [ $OOM_ERROR_COUNT -gt 0 ]; then
    echo "   ❌ メモリ使用量問題（要対応）"
    echo "     - Cloud Runメモリ制限増加推奨"
    echo "     - 03_緊急対応マニュアル.md Container問題対応参照"
else
    echo "   ✅ メモリ使用量正常"
fi

# 4. Container再起動パターン確認
echo ""
echo "4. Container再起動パターン確認:"
echo "   最新Container起動・終了ログ:"
show_logs_since_deploy "textPayload:\"Container\" AND (textPayload:\"starting\" OR textPayload:\"stopping\" OR textPayload:\"exit\")" 20
```

### 💰 API接続・データ取得詳細診断

**いつ使用**: API残高取得に問題がある、またはフォールバック値が使用されている時

```bash
echo "=== API接続・データ取得詳細診断（macOS対応） ==="

# 1. bitbank API認証・残高取得詳細確認
echo "1. bitbank API認証・残高取得詳細確認:"
echo "   API認証情報読み込み確認:"
show_logs_since_deploy "textPayload:\"BITBANK_API_KEY読み込み\" OR textPayload:\"BITBANK_API_SECRET読み込み\"" 8

API_10K_COUNT=$(count_logs_since_deploy "textPayload:\"10,000円\"" 20)
FALLBACK_11K_COUNT=$(count_logs_since_deploy "textPayload:\"11,000円\"" 20)
ZERO_YEN_COUNT=$(count_logs_since_deploy "textPayload:\"0円\" OR textPayload:\"残高不足\"" 10)

echo "   実API残高取得(10,000円): $API_10K_COUNT回"
echo "   フォールバック残高(11,000円): $FALLBACK_11K_COUNT回"
echo "   0円・残高不足エラー: $ZERO_YEN_COUNT回"

# API vs フォールバック判定
if [ $API_10K_COUNT -gt 0 ] && [ $FALLBACK_11K_COUNT -eq 0 ]; then
    echo "   ✅ 実API使用中（正常）"
elif [ $FALLBACK_11K_COUNT -gt 0 ]; then
    echo "   ⚠️ フォールバック使用中（API認証問題の可能性）"

    # macOS対応: フォールバック率計算
    TOTAL_BALANCE_CHECKS=$((API_10K_COUNT + FALLBACK_11K_COUNT))
    if [ $TOTAL_BALANCE_CHECKS -gt 0 ]; then
        FALLBACK_BALANCE_RATE=$(python3 -c "print(f'{($FALLBACK_11K_COUNT / $TOTAL_BALANCE_CHECKS) * 100:.1f}')" 2>/dev/null || echo "0.0")
        echo "   フォールバック使用率: ${FALLBACK_BALANCE_RATE}%"
    fi
else
    echo "   ❌ 残高取得完全失敗"
fi

# 2. Secret Manager取得エラー詳細確認
echo ""
echo "2. Secret Manager取得エラー詳細確認:"
echo "   権限・アクセスエラー:"
show_logs_since_deploy "textPayload:\"permission\" OR textPayload:\"Secret\" OR textPayload:\"401\" OR textPayload:\"403\"" 10

echo "   Secret Manager接続問題:"
show_logs_since_deploy "textPayload:\"Secret Manager\" AND (textPayload:\"エラー\" OR textPayload:\"timeout\" OR textPayload:\"connection\")" 8

echo "   具体的なSecret取得失敗:"
show_logs_since_deploy "textPayload:\"bitbank-api-key\" OR textPayload:\"bitbank-api-secret\" AND textPayload:\"取得失敗\"" 5

# 3. API接続・ネットワーク問題確認
echo ""
echo "3. API接続・ネットワーク問題確認:"
echo "   API接続タイムアウト・エラー:"
show_logs_since_deploy "textPayload:\"API timeout\" OR textPayload:\"connection\" OR textPayload:\"network\"" 10

echo "   bitbank API特有エラー:"
show_logs_since_deploy "textPayload:\"bitbank\" AND (textPayload:\"rate.*limit\" OR textPayload:\"API.*limit\" OR textPayload:\"maintenance\")" 8

echo "   HTTPステータスエラー:"
show_logs_since_deploy "textPayload:\"HTTP\" AND (textPayload:\"500\" OR textPayload:\"502\" OR textPayload:\"503\" OR textPayload:\"504\")" 8
```

---

## 🎯 使用方法

### 1. 基本実行（推奨）

```bash
# 基盤システム診断実行
bash 01_システム稼働診断.sh

# 結果に応じて次のアクション
# 終了コード 0: 02_Bot機能診断.md へ進む
# 終了コード 1-2: 03_緊急対応マニュアル.md で修正
# 終了コード 3: 監視継続
```

### 2. 詳細診断実行（問題発生時）

```bash
# Secret Manager問題時
bash 01_システム稼働診断.sh --detail-secret

# Container問題時
bash 01_システム稼働診断.sh --detail-container

# API接続問題時
bash 01_システム稼働診断.sh --detail-api
```

### 3. 実行順序（推奨フロー）

1. **01_システム稼働診断.md** ← **ここから開始**
2. **02_Bot機能診断.md** （基盤正常時）
3. **03_緊急対応マニュアル.md** （問題発生時）

---

## 📊 判定基準

- **終了コード 0**: 🟢 基盤システム正常 - Bot機能診断へ
- **終了コード 1**: 💀 即座対応必須 - Secret Manager・Discord障害
- **終了コード 2**: 🟠 要注意 - Container問題・API接続問題
- **終了コード 3**: 🟡 監視継続 - 軽微な問題・予防的対応

---

**🎯 重要**: このファイルは基盤システムのみをチェックします。Bot固有の機能（特徴量・戦略・ML）については **02_Bot機能診断.md** を実行してください。