# 🚨 AI自動取引システム緊急対応マニュアル

## 📋 このファイルの目的

**使用場面**:
- デプロイ後の問題発生時の即座修正
- Secret Manager権限・Container問題・Discord通知停止対応
- Silent Failure・ML予測停止の迅速復旧
- 取引阻害エラー（NoneType・API異常）対応

**ルール**:
- 01/02診断ファイルで問題特定後に使用
- 問題別セクションを参照・段階的実行
- 修正後は必ず診断ファイルで効果確認
- 実装履歴は開発履歴ドキュメント参照

**現在のシステム状態**: Phase 51.7完了（2025/11/08）
- 55特徴量Strategy-Aware ML（49基本+6戦略信号）
- 6戦略統合（Range型4戦略68%・Trend型2戦略32%）
- Atomic Entry Pattern実装（Entry/TP/SL一体保証）
- Dynamic Strategy Management（Registry+Decorator+Facadeパターン）

## ⚠️ 重要: まずREADME.mdを読んでください

**このファイルを実行する前に、必ず [README.md](./README.md) を先に読んで全体の構成・実行順序・推奨フローを理解してください。**

---

## 🎯 対応可能な問題

- 💀 **Secret Manager権限問題**: API認証失敗・権限欠如
- 🔍 **Silent Failure**: シグナル生成されるも注文実行停止
- 🔥 **Container問題**: exit(1)頻発・async/await エラー
- 📨 **Discord通知停止**: Webhook Token無効・通知失敗
- 🤖 **ML予測停止**: ProductionEnsemble・モデル問題
- ⚡ **システム応答停止**: プロセス停止・リソース不足
- 🛡️ **取引阻害エラー**: NoneType エラー・API応答異常・取引実行エラー

## 📂 関連ファイル

- **[01_システム稼働診断.md](./01_システム稼働診断.md)** - 基盤システム診断（事前チェック）
- **[02_Bot機能診断.md](./02_Bot機能診断.md)** - Bot機能診断（詳細分析）

## ⚠️ 使用方法

1. **診断ファイルで問題特定**: 01/02で問題を特定してからこのマニュアルを使用
2. **問題別セクション**: 該当する問題のセクションを参照
3. **段階的実行**: 軽微な対応から順番に実行
4. **効果確認**: 修正後は必ず診断ファイルで効果確認

---

## 🚨 緊急対応コマンド集

### 💀 Secret Manager権限修正（緊急時即座実行）

**問題**: API認証失敗・Secret Manager権限欠如

```bash
echo "🚨 Secret Manager権限修正（緊急時即座実行）"

# 1. サービスアカウント確認
SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)")
echo "対象サービスアカウント: $SERVICE_ACCOUNT"

# 2. 権限付与（3つのSecret全て）
echo "権限付与実行中..."
gcloud secrets add-iam-policy-binding bitbank-api-key \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

gcloud secrets add-iam-policy-binding bitbank-api-secret \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

gcloud secrets add-iam-policy-binding discord-webhook-url \
  --member="serviceAccount:$SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"

# 3. 新リビジョンデプロイ（権限適用・macOS対応）
FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
echo "新リビジョンデプロイ（権限適用）..."
gcloud run services update crypto-bot-service-prod \
  --region=asia-northeast1 \
  --set-env-vars="PERMISSION_FIX_TIMESTAMP=$FIX_TIMESTAMP"

echo "✅ Secret Manager権限修正完了"
echo "10分後に 01_システム稼働診断.md で効果確認推奨"
```

### 🔍 Silent Failure緊急修正（macOS対応）

**問題**: シグナル生成されるも注文実行完全停止

```bash
echo "🔍 Silent Failure緊急修正（macOS対応）"

# 1. Silent Failure状況確認
echo "現在のSilent Failure状況確認..."
SIGNALS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"統合シグナル生成\"" --limit=30 --format="value(textPayload)" | grep -c . || echo "0")
ORDERS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"注文実行\" OR textPayload:\"create_order\")" --limit=30 --format="value(textPayload)" | grep -c . || echo "0")

echo "シグナル生成: $SIGNALS件"
echo "注文実行: $ORDERS件"

if [ $SIGNALS -gt 0 ] && [ $ORDERS -eq 0 ]; then
    echo "❌ 完全Silent Failure検出 - 緊急修正開始"

    # 2. ExecutionService async/await問題の可能性確認
    ASYNC_WARNINGS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"RuntimeWarning\" AND textPayload:\"never awaited\"" --limit=20 --format="value(textPayload)" | grep -c . || echo "0")

    if [ $ASYNC_WARNINGS -gt 0 ]; then
        echo "❌ async/await問題検出 - システム再起動必要"

        # 強制再起動（async/await問題解決のため）
        ASYNC_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --set-env-vars="ASYNC_FIX_RESTART_TIMESTAMP=$ASYNC_FIX_TIMESTAMP"

        echo "✅ async/await問題対応完了"
    else
        echo "⚠️ async/await問題なし - 他要因調査必要"
    fi

    # 3. Secret Manager権限再確認・修正
    echo "Secret Manager権限再確認..."
    SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)")

    # 権限再付与（確実にするため）
    for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
        gcloud secrets add-iam-policy-binding $secret \
          --member="serviceAccount:$SERVICE_ACCOUNT" \
          --role="roles/secretmanager.secretAccessor" 2>/dev/null || true
    done

    echo "✅ Secret Manager権限確認完了"

elif [ $SIGNALS -eq 0 ]; then
    echo "⚠️ シグナル生成なし - システム動作要確認"

    # システム基本機能再起動
    SIGNAL_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --set-env-vars="SIGNAL_FIX_RESTART_TIMESTAMP=$SIGNAL_FIX_TIMESTAMP"

    echo "✅ システム基本機能再起動完了"

else
    # macOS対応: 成功率計算
    SUCCESS_RATE=$(python3 -c "print(f'{($ORDERS / $SIGNALS) * 100:.1f}')" 2>/dev/null || echo "0.0")
    echo "✅ 部分的実行中 (成功率: ${SUCCESS_RATE}%)"
    echo "緊急対応不要 - 監視継続"
fi

echo "30分後に 02_Bot機能診断.md で効果確認必須"
```

### 🔥 Container問題緊急対応（macOS対応）

**問題**: Container exit(1)頻発・RuntimeWarning・メモリ不足

```bash
echo "🔥 Container問題緊急対応（macOS対応）"

# 1. 現在のContainer問題レベル確認
echo "Container問題レベル確認..."
CONTAINER_EXITS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"Container called exit(1)\"" --limit=25 --format="value(textPayload)" | grep -c . || echo "0")
RUNTIME_WARNINGS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"RuntimeWarning\"" --limit=25 --format="value(textPayload)" | grep -c . || echo "0")

echo "Container exit(1): $CONTAINER_EXITS回"
echo "RuntimeWarning: $RUNTIME_WARNINGS回"

# macOS対応: 問題レベル判定
PROBLEM_LEVEL=$(python3 -c "
exit_score = min($CONTAINER_EXITS / 5, 3)
warning_score = min($RUNTIME_WARNINGS / 3, 3)
total = exit_score + warning_score
if total >= 3:
    print('HIGH')
elif total >= 1.5:
    print('MEDIUM')
else:
    print('LOW')
")

echo "問題レベル: $PROBLEM_LEVEL"

case $PROBLEM_LEVEL in
    "HIGH")
        echo "❌ 高レベル問題 - 緊急対応実行"

        # メモリ制限増加
        echo "メモリ制限増加: 1Gi → 2Gi"
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --memory=2Gi

        # CPU制限増加
        echo "CPU制限増加: 1000m → 2000m"
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --cpu=2

        # 強制再起動
        RESTART_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
        echo "強制再起動実行..."
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --set-env-vars="EMERGENCY_RESTART_TIMESTAMP=$RESTART_TIMESTAMP"

        echo "✅ 緊急対応完了"
        ;;

    "MEDIUM")
        echo "⚠️ 中レベル問題 - 予防的対応実行"

        # メモリ制限のみ増加
        echo "メモリ制限増加: 1Gi → 1.5Gi"
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --memory=1536Mi

        echo "✅ 予防的対応完了"
        ;;

    "LOW")
        echo "✅ 低レベル問題 - 監視継続"
        echo "現時点で緊急対応不要"
        ;;
esac

echo "20分後に 01_システム稼働診断.md で効果確認推奨"
```

### 📨 Discord Webhook修復（緊急時即座実行）

**問題**: Discord通知停止・Webhook Token無効

```bash
echo "📨 Discord Webhook修復（緊急時即座実行）"

# 1. 現在のWebhook状態確認
echo "現在のWebhook確認..."
DISCORD_ERRORS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"code: 50027\" OR textPayload:\"Invalid Webhook Token\")" --limit=10 --format="value(textPayload)" | grep -c . || echo "0")
echo "Discord Webhookエラー数: $DISCORD_ERRORS回"

if [ $DISCORD_ERRORS -gt 0 ]; then
    echo "❌ Discord Webhook無効化検出 - 修復開始"

    # 2. 新しいWebhook URL入力待ち
    echo ""
    echo "🔧 新しいDiscord Webhook URL設定:"
    echo "1. Discordサーバー設定 → 連携サービス → ウェブフック"
    echo "2. 既存Crypto-Bot削除 → 新規作成"
    echo "3. Webhook URLをコピー"
    echo ""
    read -p "新しいDiscord Webhook URL: " NEW_WEBHOOK_URL

    if [ -n "$NEW_WEBHOOK_URL" ]; then
        # 3. Secret Manager更新
        echo "Secret Manager更新中..."
        echo "$NEW_WEBHOOK_URL" | gcloud secrets versions add discord-webhook-url --data-file=-

        # 4. 新リビジョンデプロイ（Webhook適用・macOS対応）
        WEBHOOK_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
        echo "新リビジョンデプロイ（Webhook適用）..."
        gcloud run services update crypto-bot-service-prod \
          --region=asia-northeast1 \
          --set-env-vars="WEBHOOK_FIX_TIMESTAMP=$WEBHOOK_FIX_TIMESTAMP"

        echo "✅ Discord Webhook修復完了"
        echo "15分後にDiscord通知成功確認推奨"
    else
        echo "❌ Webhook URL未入力 - 修復中断"
    fi
else
    echo "✅ Discord Webhook正常 - 修復不要"
fi
```

### 🤖 ML予測システム強制再起動

**問題**: ProductionEnsemble停止・ML予測未実行

```bash
echo "🤖 ML予測システム強制再起動"

# 1. ML予測停止状況確認
echo "ML予測状況確認..."
ML_COUNT=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"ProductionEnsemble\" OR textPayload:\"ML予測\")" --limit=20 --format="value(textPayload)" | grep -c . || echo "0")
echo "ML予測実行: $ML_COUNT回（最近）"

if [ $ML_COUNT -eq 0 ]; then
    echo "❌ ML予測完全停止 - 強制再起動実行"

    # 2. MLモデル再ロード・システム再起動
    ML_RESTART_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
    echo "MLシステム強制再起動..."
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --set-env-vars="ML_RESTART_TIMESTAMP=$ML_RESTART_TIMESTAMP"

    # 3. メモリ制限確認・必要に応じて増加
    echo "メモリ制限確認・MLモデル用増加..."
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --memory=2Gi

    echo "✅ ML予測システム再起動完了"
    echo "25分後に 02_Bot機能診断.md でML予測復旧確認必須"
else
    echo "✅ ML予測動作中 - 再起動不要 ($ML_COUNT回確認)"
fi
```

### 🛡️ Atomic Entry Pattern障害対応（Phase 51.6）

**問題**: Entry/TP/SL一体性保証失敗・ロールバック頻発・TP/SL配置失敗

```bash
echo "🛡️ Atomic Entry Pattern障害対応（Phase 51.6）"

# 1. Atomic Entry Pattern動作状況確認
echo "Atomic Entry Pattern動作状況確認..."
ATOMIC_ENTRY_SUCCESS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND textPayload:\"Phase 51.6: Atomic Entry完了\"" --limit=15 --format="value(textPayload)" | grep -c . || echo "0")
ATOMIC_ROLLBACK=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"Phase 51.6: ロールバック実行\" OR textPayload:\"Atomic Entry rollback\")" --limit=15 --format="value(textPayload)" | grep -c . || echo "0")
TP_SL_FAILURE=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"TP配置失敗\" OR textPayload:\"SL配置失敗\")" --limit=15 --format="value(textPayload)" | grep -c . || echo "0")

echo "Atomic Entry成功: $ATOMIC_ENTRY_SUCCESS回"
echo "ロールバック実行: $ATOMIC_ROLLBACK回"
echo "TP/SL配置失敗: $TP_SL_FAILURE回"

# macOS対応: ロールバック率計算
TOTAL_ATTEMPTS=$((ATOMIC_ENTRY_SUCCESS + ATOMIC_ROLLBACK))
if [ $TOTAL_ATTEMPTS -gt 0 ]; then
    ROLLBACK_RATE=$(python3 -c "print(f'{($ATOMIC_ROLLBACK / $TOTAL_ATTEMPTS) * 100:.1f}')" 2>/dev/null || echo "0.0")
else
    ROLLBACK_RATE="0.0"
fi

echo "ロールバック率: ${ROLLBACK_RATE}%"

if [ $ATOMIC_ROLLBACK -gt 5 ] || [ "$ROLLBACK_RATE" != "0.0" ] && [ $(python3 -c "print(1 if float('$ROLLBACK_RATE') > 20.0 else 0)") -eq 1 ]; then
    echo "❌ Atomic Entry Pattern障害検出 - 緊急対応開始"

    # 2. TP/SL配置失敗詳細確認
    echo ""
    echo "TP/SL配置失敗詳細確認..."
    echo "最新TP/SL配置失敗ログ:"
    gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"TP配置失敗\" OR textPayload:\"SL配置失敗\")" --limit=3 --format="value(timestamp.date(tz='Asia/Tokyo'),textPayload)"

    # 3. bitbank API接続問題確認
    echo ""
    echo "bitbank API接続問題確認..."
    BITBANK_API_ERROR=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"bitbank API.*エラー\" OR textPayload:\"注文作成.*失敗\")" --limit=10 --format="value(textPayload)" | grep -c . || echo "0")
    echo "bitbank APIエラー: $BITBANK_API_ERROR回"

    if [ $BITBANK_API_ERROR -gt 3 ]; then
        echo "⚠️ bitbank API接続問題の可能性 - Secret Manager確認推奨"

        # Secret Manager権限再確認
        SERVICE_ACCOUNT=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(spec.template.spec.serviceAccountName)")
        for secret in bitbank-api-key bitbank-api-secret; do
            gcloud secrets add-iam-policy-binding $secret \
              --member="serviceAccount:$SERVICE_ACCOUNT" \
              --role="roles/secretmanager.secretAccessor" 2>/dev/null || true
        done

        echo "✅ Secret Manager権限確認完了"
    fi

    # 4. Exponential Backoff retry動作確認
    echo ""
    echo "Exponential Backoff retry動作確認..."
    RETRY_LOGS=$(gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\" AND (textPayload:\"TP配置リトライ\" OR textPayload:\"SL配置リトライ\" OR textPayload:\"_place_tp_with_retry\" OR textPayload:\"_place_sl_with_retry\")" --limit=10 --format="value(textPayload)" | grep -c . || echo "0")
    echo "リトライ動作: $RETRY_LOGS回"

    if [ $RETRY_LOGS -eq 0 ]; then
        echo "⚠️ Exponential Backoff retry未動作 - Phase 51.6修正未適用の可能性"
        echo "  → GitHub Actions CI/CDで最新コミットをデプロイしてください"
    else
        echo "✅ Exponential Backoff retry動作中"
    fi

    # 5. システム再起動（TP/SL配置機能リセット）
    echo ""
    echo "システム再起動実行（TP/SL配置機能リセット）..."
    ATOMIC_FIX_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
    gcloud run services update crypto-bot-service-prod \
      --region=asia-northeast1 \
      --set-env-vars="ATOMIC_ENTRY_FIX_TIMESTAMP=$ATOMIC_FIX_TIMESTAMP"

    echo "✅ Atomic Entry Pattern障害対応完了"
    echo "20分後に 01_システム稼働診断.md でAtomic Entry Pattern復旧確認必須"

elif [ $ATOMIC_ENTRY_SUCCESS -gt 0 ] && [ $ATOMIC_ROLLBACK -eq 0 ]; then
    echo "✅ Atomic Entry Pattern: 正常稼働中（ロールバック0回）"
    echo "対応不要"
else
    echo "ℹ️ Atomic Entry Pattern: 軽微ロールバック（${ROLLBACK_RATE}%）"
    echo "監視継続 - 緊急対応不要"
fi

echo ""
echo "次回確認: 1時間後に 01_システム稼働診断.md でAtomic Entry Pattern状況確認"
```

### ⚡ システム完全再起動（最終手段）

**問題**: 複数システム停止・原因不明の総合的問題

```bash
echo "⚡ システム完全再起動（最終手段）"

# 1. 再起動前状況記録
echo "再起動前システム状況記録..."
echo "現在時刻: $(python3 -c "import datetime; print(datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9))).strftime('%Y-%m-%d %H:%M:%S JST'))")"

# 現在のリビジョン確認
CURRENT_REVISION=$(gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(status.latestReadyRevisionName)")
echo "現在のリビジョン: $CURRENT_REVISION"

# 2. システム完全再起動実行
FULL_RESTART_TIMESTAMP=$(python3 -c 'import time; print(int(time.time()))')
echo "システム完全再起動実行..."

# リソース制限最適化 + 強制再起動
gcloud run services update crypto-bot-service-prod \
  --region=asia-northeast1 \
  --memory=2Gi \
  --cpu=2 \
  --set-env-vars="FULL_SYSTEM_RESTART_TIMESTAMP=$FULL_RESTART_TIMESTAMP"

echo "✅ システム完全再起動完了"
echo ""
echo "📋 再起動後確認手順:"
echo "1. 5分待機"
echo "2. 01_システム稼働診断.md 実行"
echo "3. 02_Bot機能診断.md 実行"
echo "4. 全項目正常化確認"
echo ""
echo "⚠️ 注意: 30分経過しても問題解決しない場合は、手動調査が必要です"
```

---

## 📋 問題別チェックリスト

### 💀 即座対応必須チェックリスト

実行後、以下を必ず確認：

- [ ] **Secret Manager権限**: 3つ全て正常アクセス可能
- [ ] **Silent Failure解消**: シグナル生成→注文実行成功率20%以上
- [ ] **Discord監視復旧**: code: 50027エラー解消・通知送信成功
- [ ] **Container安定化**: exit(1)頻度5回/時間未満・RuntimeWarning解消

### 🟠 要注意チェックリスト

予防的対応後、以下を確認：

- [ ] **ML予測正常化**: ProductionEnsemble実行・予測値正常
- [ ] **API接続安定化**: 10,000円正常取得・フォールバック使用停止
- [ ] **メモリ使用量**: 90%未満維持・OOMエラー解消
- [ ] **戦略システム**: 5戦略全て実行・フォールバック値20%未満

### 🟡 監視継続チェックリスト

継続監視項目：

- [ ] **システム稼働**: 取引サイクル継続・最新ログ10分以内
- [ ] **パフォーマンス**: 処理時間正常・ネットワーク遅延なし
- [ ] **データ品質**: 4h足・15m足正常取得・価格データ整合性
- [ ] **リソース効率**: CPU・メモリ・ディスク使用量正常範囲

---

## 🔄 修復効果確認手順

### 1. 即座確認（修復後5分）

```bash
# 基本的なシステム応答確認
gcloud run services describe crypto-bot-service-prod --region=asia-northeast1 --format="value(status.conditions[0].status)"

# 最新ログ確認
gcloud logging read "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"crypto-bot-service-prod\"" --limit=5 --format="value(timestamp.date(tz='Asia/Tokyo'),textPayload)"
```

### 2. 中期確認（修復後15分）

```bash
# 01_システム稼働診断.md 実行
bash /Users/nao/Desktop/bot/docs/指示書/稼働チェック/01_システム稼働診断.sh

# 基盤システム正常化確認
```

### 3. 完全確認（修復後30分）

```bash
# 02_Bot機能診断.md 実行
bash /Users/nao/Desktop/bot/docs/指示書/稼働チェック/02_Bot機能診断.sh

# Bot機能完全復旧確認
```

---

## 💡 予防的メンテナンス

### 週次実行推奨

```bash
# 1. リソース使用量確認
gcloud monitoring metrics list --filter="metric.type:compute"

# 2. Secret Manager権限定期確認
for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
    gcloud secrets get-iam-policy $secret
done

# 3. 不要ログクリーンアップ
gcloud logging sinks list

# 4. Discord Webhook接続テスト
curl -X POST -H "Content-Type: application/json" \
  -d '{"content": "定期接続テスト"}' \
  $(gcloud secrets versions access latest --secret="discord-webhook-url")
```

### 月次実行推奨

```bash
# 1. Cloud Runリビジョンクリーンアップ
gcloud run revisions list --service=crypto-bot-service-prod --region=asia-northeast1 --format="value(metadata.name)" | tail -n +6 | xargs -I {} gcloud run revisions delete {} --region=asia-northeast1 --quiet

# 2. Secret Manager古いバージョン削除
for secret in bitbank-api-key bitbank-api-secret discord-webhook-url; do
    gcloud secrets versions list $secret --format="value(name)" | tail -n +3 | xargs -I {} gcloud secrets versions destroy {} --secret=$secret --quiet
done

# 3. ログ保持期間確認・調整
gcloud logging buckets list

# 4. 全体システムヘルスチェック
bash /Users/nao/Desktop/bot/docs/指示書/稼働チェック/01_システム稼働診断.sh
bash /Users/nao/Desktop/bot/docs/指示書/稼働チェック/02_Bot機能診断.sh
```

---

## 🚨 エスカレーション基準

### 🛡️ Phase 32.1: NoneType エラー対応（取引阻害エラー修正）

**問題**: `float() argument must be a string or a real number, not 'NoneType'`

**原因**: bitbank API応答のNone値・注文作成後のデータ処理エラー

```bash
echo "🛡️ Phase 32.1: NoneType エラー対応"

# 1. エラー状況確認
echo "1. NoneType エラー状況確認"
NONETYPE_ERROR_COUNT=$(gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=crypto-bot-service-prod AND (textPayload:\"NoneType\" OR textPayload:\"float().*argument\")" --limit=20 --format="value(textPayload)" | grep -c . || echo "0")
echo "   NoneType エラー: $NONETYPE_ERROR_COUNT回"

if [ $NONETYPE_ERROR_COUNT -eq 0 ]; then
    echo "✅ NoneType エラーなし - 対応不要"
    exit 0
fi

# 2. エラーログ詳細確認
echo ""
echo "2. エラーログ詳細:"
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=crypto-bot-service-prod AND textPayload:\"NoneType\"" --limit=5 --format="value(timestamp.date(tz='Asia/Tokyo'),textPayload)"

# 3. 修正方法（Phase 32.1で修正済み）
echo ""
echo "3. 修正状況確認"
echo "   Phase 32.1で以下の修正が適用されています："
echo "   - src/trading/execution_service.py: None値対策強化"
echo "   - float(value or 0)パターンでNone安全化"

# 4. 最新デプロイ確認
echo ""
echo "4. 最新デプロイ確認"
LATEST_REVISION=$(gcloud run revisions list --service=crypto-bot-service-prod --region=asia-northeast1 --limit=1 --format="value(metadata.name)")
echo "   最新リビジョン: $LATEST_REVISION"

# 5. デプロイ後のエラー確認
echo ""
echo "5. デプロイ後のエラー確認"
LATEST_CI_UTC=$(gh run list --limit=1 --workflow="CI/CD Pipeline" --status=success --json=createdAt --jq='.[0].createdAt' 2>/dev/null)
if [ -n "$LATEST_CI_UTC" ]; then
    POST_DEPLOY_ERROR_COUNT=$(gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=crypto-bot-service-prod AND textPayload:\"NoneType\" AND timestamp>=\"$LATEST_CI_UTC\"" --limit=20 --format="value(textPayload)" | grep -c . || echo "0")
    echo "   デプロイ後エラー: $POST_DEPLOY_ERROR_COUNT回"

    if [ $POST_DEPLOY_ERROR_COUNT -eq 0 ]; then
        echo "✅ 修正により問題解決"
    else
        echo "⚠️ デプロイ後もエラー継続 - 追加対応必要"
    fi
else
    echo "⚠️ CI時刻取得失敗"
fi

echo ""
echo "6. 対応アクション"
echo "   - 修正コミット確認: git log --oneline | head -5"
echo "   - ローカルテスト: bash scripts/management/run_safe.sh local paper"
echo "   - 本番再デプロイ: git push origin main"
echo "   - 取引サイクル監視: 01/02診断ファイル実行"
```

---

### 即座エスカレーション（手動調査必要）

以下の場合は緊急対応では解決できません：

- [ ] **Secret Manager権限修正後も認証失敗継続**
- [ ] **システム完全再起動後もContainer問題継続**
- [ ] **ML予測再起動後もProductionEnsemble完全停止**
- [ ] **デプロイ後もNoneType エラー継続**
- [ ] **3回連続の緊急対応実行でも問題解決せず**

### 手動調査推奨項目

- **GCPプロジェクト設定確認**: IAM・API有効化・課金状況
- **bitbank API仕様変更**: API endpoint・認証方式・パラメータ
- **モデルファイル整合性**: models/production/ファイル破損・バージョン不一致
- **ネットワーク問題**: Cloud Run→外部API接続・DNS解決
- **コード変更影響**: 最新デプロイでの予期しない副作用
- **NoneType エラー追加発生箇所**: API応答異常の新規発生源

---

**🎯 重要**: このマニュアルは緊急時の迅速な対応を目的としています。根本原因の特定には 01/02 診断ファイルと併用してください。

**最終更新**: 2025年11月08日 - Phase 51.7完了対応（Atomic Entry Pattern障害対応追加・外部API対応削除）