# 📊 AI自動取引システム稼働チェック

## 📋 このディレクトリの目的

**使用場面**:
- デプロイ後のシステム稼働確認
- 定期的なヘルスチェック（毎時・毎日）
- エラー発見・早期検知
- 問題発生時の迅速診断

**ルール**:
- 必ず実行順序を守る（01 → 02 → 問題時03）
- 終了コードで問題の重大度を判断
- 基盤システム正常後にBot機能診断実行
- Phase履歴・開発完了情報は記載しない（開発履歴ドキュメント参照）

---

## 📂 ファイル構成

| ファイル | 目的 | 実行時間 | 対象 |
|---------|------|----------|------|
| **01_システム稼働診断.md** | インフラ基盤の健全性チェック | 5分 | Cloud Run・Secret Manager・Discord・Container・API応答異常 |
| **02_Bot機能診断.md** | Bot固有機能のエントリーシグナルチェック | 10分 | 15特徴量・5戦略・ML統合・取引阻害エラー |
| **03_緊急対応マニュアル.md** | 問題発生時の即座修正手順 | 1-5分 | Silent Failure・権限問題・Container問題・NoneType対策 |

---

## 🚀 推奨実行順序

### 1. 標準フロー（正常時）

```bash
# Step 1: 基盤システムチェック
bash 01_システム稼働診断.sh

# Step 2: Bot機能チェック（基盤正常時のみ）
bash 02_Bot機能診断.sh

# 結果: 両方とも終了コード 0 なら完全正常
```

### 2. 問題発生時フロー

```bash
# Step 1: 基盤システムチェック
bash 01_システム稼働診断.sh

# 終了コード 1-2 の場合 → 即座修正
# Step 2: 緊急対応実行
bash 03_緊急対応マニュアル.sh

# Step 3: 修正後再チェック
bash 01_システム稼働診断.sh
bash 02_Bot機能診断.sh
```

---

## 📊 終了コード一覧

| コード | 状態 | 意味 | 次のアクション |
|--------|------|------|----------------|
| **0** | 🟢 正常 | 全機能正常稼働 | 次のファイルへ進む |
| **1** | 💀 緊急 | 致命的システム障害 | 03_緊急対応マニュアル.md 即座実行 |
| **2** | 🟠 要注意 | 重要機能に問題 | 詳細診断・修正推奨 |
| **3** | 🟡 監視 | 軽微な問題 | 継続監視・予防対応 |

---

## 🎯 各ファイルの特徴

### 01_システム稼働診断.md
- **対象**: インフラ・基盤システム
- **重点**: Cloud Run・Secret Manager・Discord・Container安定性
- **判定**: システムの土台が健全かを確認
- **実行条件**: 常に最初に実行

### 02_Bot機能診断.md
- **対象**: Bot固有のコア機能
- **重点**:
  - 15特徴量生成完全性
  - 5戦略動的信頼度（小数点第3位変動確認）
  - ML予測統合（戦略70%+ML30%）
  - 取引機能（最小ロット・TP/SL・15m ATR・クールダウン）
  - 取引阻害エラー検出（NoneType・API応答異常）
- **判定**: 取引判断機能が正常かを確認
- **実行条件**: 01で基盤が正常な場合のみ

### 03_緊急対応マニュアル.md
- **対象**: 問題の即座修正
- **重点**:
  - Silent Failure修正
  - 権限問題・Container問題・Discord修復
  - NoneType エラー対策
  - API応答異常対応
- **判定**: 修正コマンドによる迅速復旧
- **実行条件**: 01/02で問題検出時

---

## 💡 使用上の注意

### ✅ 推奨事項

- **必ず順番通り実行**: 01 → 02 → （問題時）03
- **基盤優先**: 01で問題がある場合は02を実行しない
- **効果確認**: 03実行後は必ず01/02で効果確認
- **定期実行**: 毎時01実行、毎日02実行推奨

### ⚠️ 注意事項

- **macOS対応**: 全スクリプトはmacOS環境で最適化済み
- **GCP認証**: gcloud auth login済みであることを確認
- **権限**: Cloud Run・Secret Manager・Logging読み取り権限必要
- **タイムアウト**: 各チェックは最大10分でタイムアウト

---

## 🔧 トラブルシューティング

### よくある問題

#### 「DEPLOY_TIME未設定」エラー
```bash
# 原因: GitHub CLI (gh) 未認証
# 解決:
gh auth login
```

#### 「gcloud コマンドが見つからない」エラー
```bash
# 原因: Google Cloud SDK 未インストール
# 解決:
brew install --cask google-cloud-sdk
gcloud auth login
```

#### 「permission denied」エラー
```bash
# 原因: GCP権限不足
# 解決: プロジェクト管理者に以下権限要求
# - Cloud Run 管理者
# - Secret Manager 管理者
# - ログビューア
```

---

## 🔄 メンテナンス

### 毎週実行推奨
```bash
# 全体ヘルスチェック
bash 01_システム稼働診断.sh
bash 02_Bot機能診断.sh
```

### 毎月実行推奨
```bash
# 予防的メンテナンス（03_緊急対応マニュアル.md参照）
# - リビジョンクリーンアップ
# - Secret Manager古いバージョン削除
# - ログ保持期間調整
```

---

## 📈 ファイル分割の効果

### 分割前の問題
- **理解困難**: 1600行の巨大ファイル
- **実行時間長**: 全チェックに30分以上
- **重点不明**: システム面とBot機能が混在
- **段階的対応困難**: 問題の優先度が不明確

### 分割後の改善
- **理解容易**: 役割別の適切なファイルサイズ
- **効率的実行**: 問題に応じた段階的チェック
- **重点明確**: システム基盤 vs Bot機能の明確な分離
- **迅速対応**: 問題別の即座修正手順

---

**🎯 重要**: このフォルダのファイルはClaude Codeが一度に理解できる適切な長さに分割されています。問題の種類に応じて適切なファイルを選択してください。

**最終更新**: 2025年10月9日
