# src/trading/risk/ - ãƒªã‚¹ã‚¯ç®¡ç†å±¤ ğŸ›¡ï¸ Phase 46å®Œäº†

## ğŸ¯ å½¹å‰²ãƒ»è²¬ä»»

ãƒªã‚¹ã‚¯ç®¡ç†ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°ãƒ»KellyåŸºæº–ãƒ»ç•°å¸¸æ¤œçŸ¥ãƒ»ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç®¡ç†ã‚’æ‹…å½“ã—ã¾ã™ã€‚Phase 38ã§tradingãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¸€éƒ¨ã¨ã—ã¦åˆ†é›¢ã€Phase 43ã§ç¶­æŒç‡100%æœªæº€æ‹’å¦æ©Ÿèƒ½ã‚’å®Ÿç¾ã€**Phase 46ã§ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤å®Œå…¨æ’é™¤**ã‚’é”æˆã—ã¾ã—ãŸã€‚

## ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
risk/
â”œâ”€â”€ manager.py      # çµ±åˆãƒªã‚¹ã‚¯ç®¡ç†ï¼ˆPhase 46: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤æ’é™¤ï¼‰
â”œâ”€â”€ sizer.py        # ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°ï¼ˆå‹•çš„ã‚µã‚¤ã‚¸ãƒ³ã‚°ãƒ»Kellyçµ±åˆï¼‰
â”œâ”€â”€ kelly.py        # KellyåŸºæº–è¨ˆç®—ï¼ˆå±¥æ­´ãƒ™ãƒ¼ã‚¹æœ€é©ã‚µã‚¤ã‚ºï¼‰
â”œâ”€â”€ anomaly.py      # ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå¸‚å ´ç•°å¸¸ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸ï¼‰
â”œâ”€â”€ drawdown.py     # ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç®¡ç†ï¼ˆæœ€å¤§20%åˆ¶é™ï¼‰
â”œâ”€â”€ __init__.py     # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
â””â”€â”€ README.md       # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ“ˆ Phase 46å®Œäº†ï¼ˆ2025å¹´10æœˆ22æ—¥ï¼‰

**ğŸ¯ Phase 46: ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰ç‰¹åŒ–ãƒ»ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤å®Œå…¨æ’é™¤**

### âœ… Phase 46.3 ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤æ’é™¤æˆæœ

**èƒŒæ™¯**: è¦ä»¶å®šç¾©.mdã€Œãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ã‚¼ãƒ­ã€è¦ä»¶ã‚’éµå®ˆã™ã‚‹ãŸã‚ã€RiskManagerã«æ®‹å­˜ã—ã¦ã„ãŸãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ã‚’å®Œå…¨æ’é™¤ã—ã¾ã—ãŸã€‚

**ä¿®æ­£å†…å®¹**:

**manager.py** (Line 369):
```python
# Phase 46ä¿®æ­£å‰ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ï¼‰:
sl_rate = min(0.01, max_loss_ratio)  # â† 0.01ï¼ˆ1%ï¼‰ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰

# Phase 46ä¿®æ­£å¾Œï¼ˆthresholds.yamlèª­ã¿è¾¼ã¿ï¼‰:
sl_rate = get_threshold("sl_min_distance_ratio", 0.01)
```

**åŠ¹æœ**:
- ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤å®Œå…¨æ’é™¤ï¼ˆ100%é”æˆï¼‰
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¸€å…ƒç®¡ç†ï¼ˆthresholds.yamlï¼‰
- ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰è¨­å®šåæ˜ ï¼ˆSL 2%ãƒ»TP 4%ãƒ»RR 2.0:1ï¼‰
- é‹ç”¨ä¸­ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´å®¹æ˜“åŒ–

### âœ… Phase 46è¨­è¨ˆå¤‰æ›´ï¼šå€‹åˆ¥TP/SLç®¡ç†å¯¾å¿œ

**èƒŒæ™¯**: Phase 46ã§çµ±åˆTP/SLæ©Ÿèƒ½ã‚’å‰Šé™¤ã—ã€å€‹åˆ¥TP/SLç®¡ç†ã«å›å¸°ã—ãŸãŸã‚ã€RiskManagerã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚‚ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã—ã¾ã—ãŸã€‚

**å¤‰æ›´å†…å®¹**:
- çµ±åˆTP/SLä¾¡æ ¼è¨ˆç®—å‰Šé™¤ï¼ˆorder_strategy.pyã‹ã‚‰ç§»å‹•æ¸ˆã¿ï¼‰
- å€‹åˆ¥ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¯ã®TP/SLè¨ˆç®—ã«ç‰¹åŒ–
- thresholds.yamlè¨­å®šå€¤ã‚’ç›´æ¥ä½¿ç”¨

**è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**ï¼ˆPhase 46ç°¡ç•¥åŒ–ç‰ˆï¼‰:
```python
# SLè¨ˆç®—ï¼ˆthresholds.yamlå‚ç…§ï¼‰
sl_rate = get_threshold("sl_min_distance_ratio", 0.01)  # 2.0%
sl_price = entry_price * (1 - sl_rate) if side == "buy" else entry_price * (1 + sl_rate)

# TPè¨ˆç®—ï¼ˆthresholds.yamlå‚ç…§ï¼‰
tp_ratio = get_threshold("tp_default_ratio", 2.0)  # RRæ¯”2.0:1
tp_profit_ratio = sl_rate * tp_ratio  # 2% Ã— 2.0 = 4%
tp_price = entry_price * (1 + tp_profit_ratio) if side == "buy" else entry_price * (1 - tp_profit_ratio)
```

### ğŸ“Š Phase 46é‡è¦äº‹é …
- **Phase 46è¨­è¨ˆå“²å­¦**: ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰ç‰¹åŒ–ãƒ»å€‹åˆ¥TP/SLç®¡ç†ãƒ»ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å€¤ã‚¼ãƒ­
- **è¨­å®šä¸€å…ƒåŒ–**: å…¨ã¦thresholds.yamlã‹ã‚‰å–å¾—ï¼ˆget_threshold()ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
- **å“è³ªä¿è¨¼å®Œäº†**: 1,101ãƒ†ã‚¹ãƒˆ100%æˆåŠŸãƒ»68.93%ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ

---

## ğŸ“ˆ Phase 43å®Œäº†ï¼ˆ2025å¹´10æœˆ21æ—¥ï¼‰

**ğŸ¯ Phase 43: ç¶­æŒç‡100%æœªæº€ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦å®Ÿè£…ï¼ˆè¿½è¨¼ãƒªã‚¹ã‚¯å›é¿ï¼‰**

### âœ… Phase 43 ç¶­æŒç‡åˆ¶é™å®Ÿè£…æˆæœ

**èƒŒæ™¯**: æœ¬ç•ªç’°å¢ƒã§ä¿è¨¼é‡‘ç¶­æŒç‡ãŒ50%ã«ä½ä¸‹ã—ã€è¿½è¨¼ï¼ˆãƒãƒ¼ã‚¸ãƒ³ã‚³ãƒ¼ãƒ«ï¼‰ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã“ã‚Œã¯bitbankä¿¡ç”¨å–å¼•ã§ç¶­æŒç‡100%æœªæº€ã«ãªã‚‹ã¨ç™ºç”Ÿã™ã‚‹é‡å¤§ãªãƒªã‚¹ã‚¯ã§ã™ã€‚

**å®Ÿè£…å†…å®¹**:

**manager.py** (`_check_margin_ratio()`):
```python
async def _check_margin_ratio(
    self,
    current_balance: float,
    btc_price: float,
    ml_prediction: Dict[str, Any],
    strategy_signal: Any,
) -> Tuple[bool, Optional[str]]:  # Phase 43: æˆ»ã‚Šå€¤å¤‰æ›´
    """
    Phase 43: æ‹’å¦æ©Ÿèƒ½è¿½åŠ 

    Returns:
        Tuple[bool, Optional[str]]:
            - bool: True=æ‹’å¦ã™ã¹ã, False=è¨±å¯
            - Optional[str]: æ‹’å¦/è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    """
    # ... è¨¼æ‹ é‡‘ç¶­æŒç‡äºˆæ¸¬ ...

    future_margin_ratio = margin_prediction.future_margin_ratio

    # Phase 43: ç¶­æŒç‡100%æœªæº€ã§æ–°è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦ï¼ˆè¿½è¨¼ãƒªã‚¹ã‚¯å›é¿ï¼‰
    critical_threshold = get_threshold("margin.thresholds.critical", 100.0)
    if future_margin_ratio < critical_threshold:
        deny_message = (
            f"ğŸš¨ Phase 43: ç¶­æŒç‡100%æœªæº€äºˆæ¸¬ - ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦ "
            f"({future_margin_ratio:.1f}% < {critical_threshold:.0f}%ã€è¿½è¨¼ãƒªã‚¹ã‚¯)"
        )
        self.logger.warning(deny_message)
        return True, deny_message  # True = æ‹’å¦

    # è­¦å‘Šãƒ¬ãƒ™ãƒ«
    should_warn, warning_message = self.balance_monitor.should_warn_user(margin_prediction)
    if should_warn:
        return False, warning_msg  # False = è¨±å¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰

    return False, None  # å•é¡Œãªã—
```

**å‘¼ã³å‡ºã—å´æ›´æ–°** (manager.py Line 249-256):
```python
# Phase 43: Tupleæˆ»ã‚Šå€¤å¯¾å¿œ
should_deny, margin_message = await self._check_margin_ratio(...)

if should_deny and margin_message:
    denial_reasons.append(margin_message)  # æ‹’å¦
elif margin_message:
    warnings.append(margin_message)  # è­¦å‘Šã®ã¿
```

**thresholds.yamlè¨­å®š** (`margin.thresholds`):
```yaml
margin:
  position_value_estimation_ratio: 0.8
  # Phase 43: ç¶­æŒç‡é–¾å€¤è¨­å®š
  thresholds:
    critical: 100.0      # è¿½è¨¼ç™ºç”Ÿãƒ¬ãƒ™ãƒ« - 100%æœªæº€ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦
    warning: 100.0       # è­¦å‘Šãƒ¬ãƒ™ãƒ«
    caution: 150.0       # æ³¨æ„ãƒ¬ãƒ™ãƒ«
    safe: 200.0          # å®‰å…¨ãƒ¬ãƒ™ãƒ«
```

**åŠ¹æœ**:
- ç¶­æŒç‡100%æœªæº€äºˆæ¸¬æ™‚ã€æ–°è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’**å®Œå…¨æ‹’å¦**
- è¿½è¨¼ãƒªã‚¹ã‚¯ã®å®Œå…¨å›é¿ï¼ˆbitbankä¿¡ç”¨å–å¼•100%æœªæº€ã§è¿½è¨¼ç™ºç”Ÿï¼‰
- æ—¢å­˜ãƒã‚¸ã‚·ãƒ§ãƒ³ã¯ç¶­æŒï¼ˆç„¡ç†ãªæ±ºæ¸ˆã‚’å›é¿ï¼‰

### ğŸ“Š Phase 43é‡è¦äº‹é …
- **è¿½è¨¼é˜²æ­¢**: ç¶­æŒç‡100%ã‚’ä¸‹å›ã‚‹å‰ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦
- **äºˆæ¸¬ãƒ™ãƒ¼ã‚¹**: å°†æ¥ã®ç¶­æŒç‡ã‚’äºˆæ¸¬ã—ã¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤æ–­
- **å“è³ªä¿è¨¼å®Œäº†**: 1,141ãƒ†ã‚¹ãƒˆ100%æˆåŠŸãƒ»69.47%ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ

---

## ğŸ”§ ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

### **manager.py** ğŸ›¡ï¸**Phase 43 ç¶­æŒç‡åˆ¶é™å®Ÿè£…å®Œäº†**

çµ±åˆãƒªã‚¹ã‚¯ç®¡ç†ã®ä¸­æ ¸ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚Phase 43ã§ç¶­æŒç‡100%æœªæº€ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

**Phase 43æ–°æ©Ÿèƒ½**:
```python
async def _check_margin_ratio(
    self,
    current_balance: float,
    btc_price: float,
    ml_prediction: Dict[str, Any],
    strategy_signal: Any,
) -> Tuple[bool, Optional[str]]:
    """
    Phase 43: ç¶­æŒç‡100%æœªæº€æ‹’å¦æ©Ÿèƒ½è¿½åŠ 

    å‡¦ç†:
        1. è¨¼æ‹ é‡‘ç¶­æŒç‡äºˆæ¸¬ï¼ˆbalance_monitorï¼‰
        2. Criticalé–¾å€¤ï¼ˆ100%ï¼‰ãƒã‚§ãƒƒã‚¯
        3. 100%æœªæº€ãªã‚‰æ‹’å¦ï¼ˆTrue, deny_messageï¼‰
        4. 100%ä»¥ä¸Šãªã‚‰è¨±å¯ï¼ˆFalse, warning_message or Noneï¼‰
    """
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `evaluate_trade()`: å–å¼•è©•ä¾¡ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
- `_check_margin_ratio()`: **ã€Phase 43æ›´æ–°ã€‘ç¶­æŒç‡ãƒã‚§ãƒƒã‚¯ãƒ»æ‹’å¦æ©Ÿèƒ½**
- `_calculate_risk_score()`: ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆ0-100%ï¼‰
- `_check_position_limits()`: ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
- `_check_drawdown_limits()`: ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯
- `_detect_anomalies()`: ç•°å¸¸æ¤œçŸ¥

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ **:
- Lines 1-91: åˆæœŸåŒ–ãƒ»åŸºæœ¬è¨­å®š
- Lines 92-285: å–å¼•è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ**Phase 43: Line 249-256æ›´æ–°**ï¼‰
- Lines 286-384: **Phase 43: _check_margin_ratio()æ›´æ–°**
- Lines 385-459: ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—
- Lines 460-546: ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¶é™ãƒ»ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³åˆ¶é™
- Lines 547-619: ç•°å¸¸æ¤œçŸ¥
- Lines 620-783: è¨¼æ‹ é‡‘ç®¡ç†ãƒ»çµ±è¨ˆæƒ…å ±

### **sizer.py** ğŸ“Š**ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°çµ±åˆã‚·ã‚¹ãƒ†ãƒ **

KellyåŸºæº–ãƒ»å‹•çš„ã‚µã‚¤ã‚¸ãƒ³ã‚°ãƒ»RiskManagerã‚’çµ±åˆã—ãŸãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```python
def calculate_integrated_position_size(
    self,
    ml_confidence: float,
    risk_manager_confidence: float,
    strategy_name: str,
    config: Dict,
    current_balance: float = None,
    btc_price: float = None,
) -> float:
    """
    KellyåŸºæº–ã¨æ—¢å­˜RiskManagerã®çµ±åˆãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºè¨ˆç®—

    è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯:
        1. å‹•çš„ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°è¨ˆç®—ï¼ˆMLä¿¡é ¼åº¦ãƒ™ãƒ¼ã‚¹ï¼‰
        2. KellyåŸºæº–è¨ˆç®—ï¼ˆå±¥æ­´ãƒ™ãƒ¼ã‚¹ï¼‰
        3. RiskManagerè¨ˆç®—ï¼ˆæˆ¦ç•¥è¨­å®šãƒ™ãƒ¼ã‚¹ï¼‰
        4. 3ã¤ã®å€¤ã®ã†ã¡æœ€ã‚‚ä¿å®ˆçš„ãªå€¤ã‚’æ¡ç”¨ï¼ˆminï¼‰
    """
```

**å‹•çš„ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°**:
```python
def _calculate_dynamic_position_size(
    self, ml_confidence: float, current_balance: float, btc_price: float
) -> float:
    """
    MLä¿¡é ¼åº¦ã«åŸºã¥ãå‹•çš„ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°

    ä¿¡é ¼åº¦ã‚«ãƒ†ã‚´ãƒªãƒ¼:
        - ä½ï¼ˆ< 0.6ï¼‰: 1-3%
        - ä¸­ï¼ˆ0.6-0.75ï¼‰: 3-5%
        - é«˜ï¼ˆâ‰¥ 0.75ï¼‰: 5-10%

    æœ€å°ãƒ­ãƒƒãƒˆä¿è¨¼:
        - è¨ˆç®—å€¤ã¨0.0001BTCã®å¤§ãã„æ–¹ï¼ˆmaxï¼‰ã‚’æ¡ç”¨
        - å°‘é¡è³‡é‡‘ï¼ˆ< 50,000å††ï¼‰æ™‚ã¯æœ€å°ãƒ­ãƒƒãƒˆå„ªå…ˆ
    """
```

### **kelly.py** ğŸ“ˆ**KellyåŸºæº–è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ **

å–å¼•å±¥æ­´ãƒ™ãƒ¼ã‚¹ã®æœ€é©ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

**ä¸»è¦æ©Ÿèƒ½**:
```python
def calculate_optimal_size(
    self,
    ml_confidence: float,
    strategy_name: Optional[str] = None
) -> float:
    """
    KellyåŸºæº–ã«ã‚ˆã‚‹æœ€é©ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºè¨ˆç®—

    å±¥æ­´ä¸è¶³æ™‚ï¼ˆ< 5å–å¼•ï¼‰:
        - å›ºå®šã§æœ€å°å–å¼•å˜ä½ï¼ˆ0.0001 BTCï¼‰ã‚’è¿”ã™
        - æœ€åˆã®5å–å¼•ã¯å®‰å…¨ãªå›ºå®šã‚µã‚¤ã‚ºã§å®Ÿè¡Œ

    å±¥æ­´ååˆ†æ™‚ï¼ˆâ‰¥ 5å–å¼•ï¼‰:
        - å‹ç‡ãƒ»å¹³å‡åˆ©ç›Šãƒ»å¹³å‡æå¤±ã‹ã‚‰æœ€é©ã‚µã‚¤ã‚ºè¨ˆç®—
        - f* = (bp - q) / b
        - ä¸Šé™: æ®‹é«˜ã®10%ã¾ã§
    """
```

### **anomaly.py** ğŸš¨**ç•°å¸¸æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ **

å¸‚å ´ç•°å¸¸ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸ã‚’æ¤œçŸ¥ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

**æ¤œçŸ¥é …ç›®**:
- æ€¥æ¿€ãªä¾¡æ ¼å¤‰å‹•ï¼ˆ5åˆ†ã§5%ä»¥ä¸Šï¼‰
- ç•°å¸¸ãªå‡ºæ¥é«˜ï¼ˆå¹³å‡ã®3å€ä»¥ä¸Šï¼‰
- APIå¿œç­”é…å»¶ï¼ˆ2ç§’ä»¥ä¸Šï¼‰
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ç•°å¸¸ï¼ˆ80%ä»¥ä¸Šï¼‰

### **drawdown.py** ğŸ“‰**ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **

æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³20%åˆ¶é™ã‚’ç®¡ç†ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç‡è¨ˆç®—ï¼ˆæœ€å¤§æ®‹é«˜ã‹ã‚‰ã®ä¸‹è½ç‡ï¼‰
- 20%åˆ°é”æ™‚ã®å–å¼•åœæ­¢
- å›å¾©æ™‚ã®è‡ªå‹•å†é–‹ï¼ˆ10%æœªæº€ã«å›å¾©ï¼‰
- çŠ¶æ…‹æ°¸ç¶šåŒ–ï¼ˆ`src/core/state/drawdown_state.json`ï¼‰

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•ãƒ»ä¾‹

### **Phase 43 ç¶­æŒç‡åˆ¶é™ã®å‹•ä½œ**

```python
from src.trading.risk.manager import IntegratedRiskManager

# IntegratedRiskManageråˆæœŸåŒ–
risk_manager = IntegratedRiskManager(...)

# å–å¼•è©•ä¾¡ï¼ˆPhase 43: ç¶­æŒç‡ãƒã‚§ãƒƒã‚¯å«ã‚€ï¼‰
evaluation = await risk_manager.evaluate_trade(
    current_balance=10000,
    btc_price=16000000,
    ml_prediction=ml_prediction,
    strategy_signal=strategy_signal
)

# å‹•ä½œä¾‹:
# ç¾åœ¨ç¶­æŒç‡: 120% â†’ å•é¡Œãªã—
# ã‚¨ãƒ³ãƒˆãƒªãƒ¼å¾Œäºˆæ¸¬ç¶­æŒç‡: 95% â†’ **æ‹’å¦**ï¼ˆ100%æœªæº€ï¼‰
# æ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "ğŸš¨ Phase 43: ç¶­æŒç‡100%æœªæº€äºˆæ¸¬ - ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦ (95.0% < 100.0%ã€è¿½è¨¼ãƒªã‚¹ã‚¯)"

# evaluation.decision: "denied"
# evaluation.denial_reasons: ["ç¶­æŒç‡100%æœªæº€äºˆæ¸¬..."]
```

### **ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°ã®å‹•ä½œ**

```python
from src.trading.risk.sizer import PositionSizeIntegrator
from src.trading.risk.kelly import KellyCriterion

# KellyåŸºæº–åˆæœŸåŒ–
kelly = KellyCriterion()

# ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºçµ±åˆå™¨åˆæœŸåŒ–
sizer = PositionSizeIntegrator(kelly_criterion=kelly)

# çµ±åˆãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºè¨ˆç®—
position_size = sizer.calculate_integrated_position_size(
    ml_confidence=0.702,  # MLä¿¡é ¼åº¦70.2%
    risk_manager_confidence=0.673,
    strategy_name="ATRBased",
    config=config,
    current_balance=10000,
    btc_price=16000000
)

# å†…éƒ¨å‹•ä½œ:
# 1. Dynamic: 0.000100 BTCï¼ˆMLä¿¡é ¼åº¦70.2% â†’ ä¸­ä¿¡é ¼åº¦4.4%ï¼‰
# 2. Kelly: 0.000100 BTCï¼ˆå±¥æ­´ä¸è¶³ â†’ å›ºå®šã‚µã‚¤ã‚ºï¼‰
# 3. RiskManager: 0.009578 BTCï¼ˆæˆ¦ç•¥è¨­å®šãƒ™ãƒ¼ã‚¹ï¼‰
# 4. æ¡ç”¨: min(0.000100, 0.000100, 0.009578) = 0.000100 BTC
```

---

## âš ï¸ æ³¨æ„äº‹é …ãƒ»åˆ¶ç´„

### **Phase 43 ç¶­æŒç‡åˆ¶é™ã®å‹•ä½œæ¡ä»¶**
- **Criticalé–¾å€¤**: 100%ï¼ˆbitbankä¿¡ç”¨å–å¼•ã®è¿½è¨¼ç™ºç”Ÿãƒ¬ãƒ™ãƒ«ï¼‰
- **äºˆæ¸¬ãƒ™ãƒ¼ã‚¹**: å°†æ¥ã®ç¶­æŒç‡ã‚’äºˆæ¸¬ã—ã¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤æ–­
- **æ—¢å­˜ãƒã‚¸ã‚·ãƒ§ãƒ³ç¶­æŒ**: æ‹’å¦ã•ã‚Œã‚‹ã®ã¯æ–°è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã®ã¿

### **ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°ã®åˆ¶ç´„**
- **æœ€å°ãƒ­ãƒƒãƒˆ**: 0.0001 BTCï¼ˆbitbankæœ€å°å–å¼•å˜ä½ï¼‰
- **æœ€å¤§ãƒã‚¸ã‚·ãƒ§ãƒ³**: æ®‹é«˜ã®10%ã¾ã§ï¼ˆKellyåŸºæº–ä¸Šé™ï¼‰
- **ä¿å®ˆçš„æ¡ç”¨**: 3ã¤ã®å€¤ï¼ˆDynamicãƒ»Kellyãƒ»RiskManagerï¼‰ã®æœ€å°å€¤

### **KellyåŸºæº–ã®åˆ¶ç´„**
- **å±¥æ­´è¦ä»¶**: 5å–å¼•ä»¥ä¸Šã§æœ¬æ ¼è¨ˆç®—é–‹å§‹
- **åˆæœŸå›ºå®šã‚µã‚¤ã‚º**: æœ€åˆã®5å–å¼•ã¯0.0001 BTCå›ºå®š
- **æˆ¦ç•¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: æˆ¦ç•¥åˆ¥ã«å±¥æ­´åˆ†é›¢å¯èƒ½

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ä¾å­˜é–¢ä¿‚

### **Phase 43æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**
- `src/trading/risk/manager.py`: ç¶­æŒç‡åˆ¶é™å®Ÿè£…ï¼ˆLine 286-384ï¼‰
- `config/core/thresholds.yaml`: margin.thresholdsè¨­å®šè¿½åŠ 

### **å‚ç…§å…ƒã‚·ã‚¹ãƒ†ãƒ **
- `src/core/orchestration/trading_cycle_manager.py`: ãƒªã‚¹ã‚¯è©•ä¾¡å‘¼ã³å‡ºã—
- `src/trading/balance/monitor.py`: è¨¼æ‹ é‡‘ç¶­æŒç‡ç›£è¦–
- `src/data/bitbank_client.py`: bitbank APIå‘¼ã³å‡ºã—

### **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é€£æº**
- `config/core/thresholds.yaml`: ãƒªã‚¹ã‚¯é–¾å€¤ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚¸ãƒ³ã‚°è¨­å®š
- `config/core/unified.yaml`: ãƒªã‚¹ã‚¯ç®¡ç†åŸºæœ¬è¨­å®š

---

**ğŸ¯ é‡è¦**: Phase 43ã«ã‚ˆã‚Šã€bitbankä¿¡ç”¨å–å¼•ã®è¿½è¨¼ãƒªã‚¹ã‚¯ã‚’å®Œå…¨å›é¿ã™ã‚‹ç¶­æŒç‡100%æœªæº€ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ‹’å¦æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æœ¬ç•ªç’°å¢ƒã§ã®å®‰å…¨æ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¦ã„ã¾ã™ã€‚
