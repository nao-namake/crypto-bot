# src/trading/balance/ - æ®‹é«˜ç›£è¦–å±¤ ğŸš€ Phase 42.3.3å®Œäº†

## ğŸ¯ å½¹å‰²ãƒ»è²¬ä»»

è¨¼æ‹ é‡‘æ®‹é«˜ç›£è¦–ãƒ»ä¸è¶³æ¤œçŸ¥ãƒ»æ®‹é«˜ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ‹…å½“ã—ã¾ã™ã€‚Phase 38ã§tradingãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¸€éƒ¨ã¨ã—ã¦åˆ†é›¢ã€Phase 42.3.3ã§è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

## ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
balance/
â”œâ”€â”€ monitor.py       # æ®‹é«˜ç›£è¦–ï¼ˆPhase 42.3.3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½è¿½åŠ ï¼‰
â”œâ”€â”€ __init__.py      # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–
â””â”€â”€ README.md        # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ“ˆ Phase 42.3.3å®Œäº†ï¼ˆ2025å¹´10æœˆ18æ—¥ï¼‰

**ğŸ¯ Phase 42.3.3: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»APIèªè¨¼ã‚¨ãƒ©ãƒ¼å¯¾ç­–**

### âœ… Phase 42.3.3æœ€é©åŒ–æˆæœ
- **è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**: ã‚¨ãƒ©ãƒ¼20001ï¼ˆbitbank APIèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰3å›ãƒªãƒˆãƒ©ã‚¤å®Ÿè£…ï¼ˆmonitor.py:25-31, 500-558ï¼‰
  - ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼åˆæœŸåŒ–: `self._margin_check_failure_count = 0`, `self._max_margin_check_retries = 3`
  - ã‚¨ãƒ©ãƒ¼åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯: Error 20001ï¼ˆauthï¼‰vsãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
  - æˆåŠŸæ™‚ãƒªã‚»ãƒƒãƒˆ: ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½

- **Phase 38å•é¡Œé˜²æ­¢**: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—â†’ç„¡é™ãƒ«ãƒ¼ãƒ—å•é¡Œã®æ ¹æœ¬è§£æ±º
  - èƒŒæ™¯: Phase 38ã§-451å††æå¤±ï¼ˆ4.5%ï¼‰ç™ºç”Ÿãƒ»ã‚¨ãƒ©ãƒ¼20001ç„¡é™ãƒ«ãƒ¼ãƒ—
  - å¯¾ç­–: 3å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—æ™‚ã«å–å¼•è‡ªå‹•ä¸­æ­¢ãƒ»æ©Ÿä¼šæå¤±é˜²æ­¢
  - åŠ¹æœ: Container exit(1)å‰Šæ¸›ãƒ»å®‰å®šç¨¼åƒå®Ÿç¾

- **ã‚¨ãƒ©ãƒ¼åˆ†é¡æ©Ÿèƒ½**: ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼vsæ°¸ç¶šçš„ã‚¨ãƒ©ãƒ¼ã®åŒºåˆ¥
  - Error 20001ï¼ˆAPI authï¼‰: ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚«ã‚¦ãƒ³ãƒˆã›ãšãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨
  - åŠ¹æœ: æ©Ÿä¼šæå¤±å‰Šæ¸›ãƒ»å–å¼•ç¶šè¡Œåˆ¤æ–­ã®æœ€é©åŒ–

- **å“è³ªä¿è¨¼å®Œäº†**: 1,081ãƒ†ã‚¹ãƒˆ100%æˆåŠŸãƒ»69.57%ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ

### ğŸ“Š Phase 42.3.3é‡è¦äº‹é …
- **ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢**: Phase 38ã®æ®‹é«˜ä¸è¶³ç„¡é™ãƒ«ãƒ¼ãƒ—å•é¡Œã‚’å®Œå…¨è§£æ±º
- **æ©Ÿä¼šæå¤±å‰Šæ¸›**: ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã§ã¯å–å¼•ç¶šè¡Œãƒ»æ°¸ç¶šçš„ã‚¨ãƒ©ãƒ¼ã®ã¿åœæ­¢
- **Discordé€šçŸ¥çµ±åˆ**: ãƒªãƒˆãƒ©ã‚¤ä¸Šé™åˆ°é”æ™‚ã«Criticalé€šçŸ¥é€ä¿¡ï¼ˆå°†æ¥Phaseå¯¾å¿œï¼‰

## ğŸ“ˆ Phase 38å®Œäº†ï¼ˆ2025å¹´10æœˆ11æ—¥ï¼‰

**ğŸ¯ Phase 38: tradingãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®Ÿè£…**

### âœ… Phase 38æœ€é©åŒ–æˆæœ
- **balanceå±¤åˆ†é›¢**: è¨¼æ‹ é‡‘ç›£è¦–æ©Ÿèƒ½ã‚’ç‹¬ç«‹å±¤ã¨ã—ã¦åˆ†é›¢
- **5å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: core/balance/execution/position/riskå±¤ã«ã‚ˆã‚‹è²¬å‹™åˆ†é›¢
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š**: 58.62% â†’ 70.56%ï¼ˆ+11.94ãƒã‚¤ãƒ³ãƒˆï¼‰
- **ä¿å®ˆæ€§å‘ä¸Š**: 1,817è¡Œãƒ•ã‚¡ã‚¤ãƒ«â†’å¹³å‡350è¡Œ/ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ-80%ï¼‰

## ğŸ”§ ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°

### **monitor.py** ğŸš€**Phase 42.3.3 ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½è¿½åŠ å®Œäº†**

è¨¼æ‹ é‡‘æ®‹é«˜ç›£è¦–ã®ä¸­æ ¸ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚Phase 42.3.3ã§APIèªè¨¼ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

**Phase 42.3.3æ–°æ©Ÿèƒ½**:
```python
class BalanceMonitor:
    def __init__(self):
        """BalanceMonitoråˆæœŸåŒ–"""
        self.logger = get_logger()
        self.margin_history: List[MarginData] = []
        # Phase 42.3.3: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®å–å¼•ä¸­æ­¢æ©Ÿèƒ½
        self._margin_check_failure_count = 0
        self._max_margin_check_retries = 3

    async def check_margin_balance(
        self,
        client: BitbankClient,
        required_amount: float,
        discord_notifier: Optional[Any] = None
    ) -> Dict[str, Any]:
        """
        è¨¼æ‹ é‡‘æ®‹é«˜ãƒã‚§ãƒƒã‚¯ï¼ˆPhase 42.3.3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½è¿½åŠ ï¼‰

        Returns:
            Dict: {
                "sufficient": bool,
                "available": float,
                "required": float,
                "error": str (optional),
                "retry_count": int (optional)
            }
        """
```

**ã‚¨ãƒ©ãƒ¼åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯**:
```python
try:
    # è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯æˆåŠŸ - ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆï¼ˆPhase 42.3.3ï¼‰
    if self._margin_check_failure_count > 0:
        self.logger.info(f"âœ… è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯æˆåŠŸ - ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ")
        self._margin_check_failure_count = 0

    return {"sufficient": True, "available": available_balance, "required": min_required}

except Exception as e:
    # Phase 42.3.3: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®è©³ç´°åˆ†é¡
    error_str = str(e)

    # ã‚¨ãƒ©ãƒ¼20001ï¼ˆbitbank APIèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼‰ã®ã¿ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    is_api_auth_error = "20001" in error_str or "API ã‚¨ãƒ©ãƒ¼: 20001" in error_str

    if is_api_auth_error:
        self._margin_check_failure_count += 1

        # ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ã«é”ã—ãŸå ´åˆã¯å–å¼•ã‚’ä¸­æ­¢
        if self._margin_check_failure_count >= self._max_margin_check_retries:
            self.logger.critical(
                f"ğŸš¨ è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ãƒªãƒˆãƒ©ã‚¤ä¸Šé™åˆ°é” "
                f"({self._max_margin_check_retries}å›) - å–å¼•ã‚’ä¸­æ­¢ã—ã¾ã™"
            )

            # Discord Criticalé€šçŸ¥é€ä¿¡
            await self._send_margin_check_failure_alert(e, discord_notifier)

            return {
                "sufficient": False,
                "available": 0,
                "required": get_threshold("balance_alert.min_required_margin", 14000.0),
                "error": "margin_check_failure_auth_error",
                "retry_count": self._margin_check_failure_count,
            }
    else:
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç­‰ã¯ä¸€æ™‚çš„ãªå•é¡Œãªã®ã§ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
        self.logger.warning(
            f"âš ï¸ è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ä¸€æ™‚çš„å¤±æ•—ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰: {e}"
        )

    # ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ—¢å­˜å‹•ä½œã‚’ç¶­æŒï¼ˆå–å¼•ç¶šè¡Œãƒ»æ©Ÿä¼šæå¤±å›é¿ï¼‰
    return {"sufficient": True, "available": 0, "required": 0}
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `check_margin_balance()`: **ã€Phase 42.3.3æ‹¡å¼µã€‘è¨¼æ‹ é‡‘æ®‹é«˜ãƒã‚§ãƒƒã‚¯ãƒ»ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**
- `get_margin_status()`: è¨¼æ‹ é‡‘ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
- `calculate_available_margin()`: åˆ©ç”¨å¯èƒ½è¨¼æ‹ é‡‘è¨ˆç®—
- `_send_margin_check_failure_alert()`: **ã€Phase 42.3.3æ–°è¦ã€‘Discord Criticalé€šçŸ¥é€ä¿¡**

## ğŸ“ ä½¿ç”¨æ–¹æ³•ãƒ»ä¾‹

### **è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œï¼ˆPhase 42.3.3å¯¾å¿œï¼‰**

```python
from src.trading.balance.monitor import BalanceMonitor
from src.data.bitbank_client import BitbankClient

# BalanceMonitoråˆæœŸåŒ–
monitor = BalanceMonitor()

# è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
result = await monitor.check_margin_balance(
    client=bitbank_client,
    required_amount=14000.0,
    discord_notifier=discord_manager  # Phase 42.3.3: Criticalé€šçŸ¥ç”¨
)

# çµæœç¢ºèª
if result["sufficient"]:
    print(f"âœ… è¨¼æ‹ é‡‘OK: {result['available']:.0f}å†† >= {result['required']:.0f}å††")
else:
    if "error" in result and result["error"] == "margin_check_failure_auth_error":
        print(f"ğŸš¨ è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆ{result['retry_count']}å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—ï¼‰")
        # å–å¼•ä¸­æ­¢
    else:
        print(f"âš ï¸ è¨¼æ‹ é‡‘ä¸è¶³: {result['available']:.0f}å†† < {result['required']:.0f}å††")
```

### **Phase 42.3.3ã‚¨ãƒ©ãƒ¼åˆ†é¡å‹•ä½œ**

```python
# ã‚±ãƒ¼ã‚¹1: APIèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆ20001ï¼‰â†’ ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
# 1å›ç›®: retry_count=1, å–å¼•ç¶šè¡Œ
# 2å›ç›®: retry_count=2, å–å¼•ç¶šè¡Œ
# 3å›ç›®: retry_count=3, å–å¼•ä¸­æ­¢ãƒ»Discord Criticalé€šçŸ¥

# ã‚±ãƒ¼ã‚¹2: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ â†’ ã‚«ã‚¦ãƒ³ãƒˆã›ãšã€å–å¼•ç¶šè¡Œ
# ä½•å›ç™ºç”Ÿã—ã¦ã‚‚retry_countã¯å¢—åŠ ã›ãšã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ä½¿ç”¨

# ã‚±ãƒ¼ã‚¹3: æˆåŠŸ â†’ retry_countãƒªã‚»ãƒƒãƒˆ
# éå»ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã€æˆåŠŸæ™‚ã«0ã«ãƒªã‚»ãƒƒãƒˆ
```

## âš ï¸ æ³¨æ„äº‹é …ãƒ»åˆ¶ç´„

### **Phase 42.3.3ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å‹•ä½œ**
- **ã‚¨ãƒ©ãƒ¼20001ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ**: bitbank APIèªè¨¼ã‚¨ãƒ©ãƒ¼ã®ã¿ãŒãƒªãƒˆãƒ©ã‚¤å¯¾è±¡
- **ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã‚«ã‚¦ãƒ³ãƒˆã›ãšå–å¼•ç¶šè¡Œ
- **æˆåŠŸæ™‚ãƒªã‚»ãƒƒãƒˆ**: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯æˆåŠŸæ™‚ã«ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
- **3å›ä¸Šé™**: 3å›é€£ç¶šã§ã‚¨ãƒ©ãƒ¼20001ãŒç™ºç”Ÿã™ã‚‹ã¨å–å¼•è‡ªå‹•ä¸­æ­¢

### **æ©Ÿä¼šæå¤±å‰Šæ¸›ã®è¨­è¨ˆ**
- **å³æ ¼ãªåˆ†é¡**: æ°¸ç¶šçš„ã‚¨ãƒ©ãƒ¼ï¼ˆ20001ï¼‰ã¨ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã‚’æ˜ç¢ºã«åŒºåˆ¥
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¶™ç¶š**: ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ä½¿ç”¨ã§å–å¼•ç¶šè¡Œ
- **æ®µéšçš„å¯¾å¿œ**: ãƒªãƒˆãƒ©ã‚¤åˆ¶é™å†…ï¼ˆ1-2å›ï¼‰ã¯è­¦å‘Šã®ã¿ãƒ»3å›ç›®ã§Critical

### **Phase 38 Graceful Degradationçµ±åˆ**
- **Container exitå›é¿**: æ®‹é«˜ä¸è¶³æ™‚ã‚‚å–å¼•ä¸­æ­¢ã®ã¿ã§ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ã—ãªã„
- **Discordé€šçŸ¥**: Phase 42.3.3ã§å°†æ¥å®Ÿè£…äºˆå®šï¼ˆç¾åœ¨ã¯ãƒ­ã‚°ã®ã¿ï¼‰
- **çŠ¶æ…‹è¿½è·¡**: ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ã‚’è¿½è·¡

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ä¾å­˜é–¢ä¿‚

### **Phase 42.3.3æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**
- `src/trading/balance/monitor.py`: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½å®Ÿè£…ï¼ˆlines 25-31, 500-558ï¼‰

### **å‚ç…§å…ƒã‚·ã‚¹ãƒ†ãƒ **
- `src/core/execution/execution_service.py`: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
- `src/data/bitbank_client.py`: bitbank APIå‘¼ã³å‡ºã—
- `src/core/reporting/discord_notifier.py`: Discord Criticalé€šçŸ¥ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

### **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é€£æº**
- `config/core/thresholds.yaml`: `balance_alert.min_required_margin`ï¼ˆ14,000å††ï¼‰
- `config/core/unified.yaml`: mode_balancesè¨­å®š

---

**ğŸ¯ é‡è¦**: Phase 42.3.3ã«ã‚ˆã‚Šã€Phase 38ã®è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ç„¡é™ãƒ«ãƒ¼ãƒ—å•é¡Œã‚’æ ¹æœ¬è§£æ±ºã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼åˆ†é¡ã«ã‚ˆã‚‹æ©Ÿä¼šæå¤±å‰Šæ¸›ã¨ã€ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«ã‚ˆã‚‹å®‰å®šæ€§ç¢ºä¿ã‚’ä¸¡ç«‹ã—ã¦ã„ã¾ã™ã€‚
