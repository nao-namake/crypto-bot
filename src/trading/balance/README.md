# src/trading/balance/ - æ®‹é«˜ç›£è¦–å±¤ ğŸ’° Phase 52.4-Bå®Œäº†

## ğŸ¯ å½¹å‰²ãƒ»è²¬ä»»

è¨¼æ‹ é‡‘æ®‹é«˜ç›£è¦–ãƒ»ä¸è¶³æ¤œçŸ¥ãƒ»æ®‹é«˜ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æ‹…å½“ã—ã¾ã™ã€‚tradingãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¸€éƒ¨ã¨ã—ã¦ã€è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã«ã‚ˆã‚Šå®‰å®šã—ãŸå–å¼•ç¶™ç¶šã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
balance/
â”œâ”€â”€ monitor.py       # æ®‹é«˜ç›£è¦–ï¼ˆ660è¡Œãƒ»Phase 52.4å®Œäº†ï¼‰
â”œâ”€â”€ __init__.py      # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸåŒ–ï¼ˆ11è¡Œï¼‰
â””â”€â”€ README.md        # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ”§ ä¸»è¦æ©Ÿèƒ½

### **BalanceMonitor**ï¼ˆmonitor.pyï¼‰

è¨¼æ‹ é‡‘æ®‹é«˜ç›£è¦–ã®ä¸­æ ¸ã‚·ã‚¹ãƒ†ãƒ ã€‚APIèªè¨¼ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã«ã‚ˆã‚Šã€å®‰å®šã—ãŸè¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚

**ä¸»è¦æ©Ÿèƒ½**:
- **è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ãƒªãƒˆãƒ©ã‚¤**: APIèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆ20001ï¼‰3å›ãƒªãƒˆãƒ©ã‚¤å®Ÿè£…
- **ã‚¨ãƒ©ãƒ¼åˆ†é¡**: æ°¸ç¶šçš„ã‚¨ãƒ©ãƒ¼ï¼ˆAPIèªè¨¼ï¼‰vs ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ã®åŒºåˆ¥
- **è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ**: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯æˆåŠŸæ™‚ã«ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
- **å–å¼•è‡ªå‹•ä¸­æ­¢**: 3å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—æ™‚ã«å–å¼•ä¸­æ­¢ãƒ»Discord Criticalé€šçŸ¥

**ã‚¯ãƒ©ã‚¹åˆæœŸåŒ–**:
```python
class BalanceMonitor:
    def __init__(self):
        """BalanceMonitoråˆæœŸåŒ–"""
        self.logger = get_logger()
        self.margin_history: List[MarginData] = []
        # è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®å–å¼•ä¸­æ­¢æ©Ÿèƒ½
        self._margin_check_failure_count = 0
        self._max_margin_check_retries = 3
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
```python
async def check_margin_balance(
    self,
    client: BitbankClient,
    required_amount: float,
    discord_notifier: Optional[Any] = None
) -> Dict[str, Any]:
    """
    è¨¼æ‹ é‡‘æ®‹é«˜ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰

    Returns:
        Dict: {
            "sufficient": bool,
            "available": float,
            "required": float,
            "error": str (optional),
            "retry_count": int (optional)
        }
    """
```

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### **è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œ**

```python
from src.trading.balance.monitor import BalanceMonitor
from src.data.bitbank_client import BitbankClient

# BalanceMonitoråˆæœŸåŒ–
monitor = BalanceMonitor()

# è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
result = await monitor.check_margin_balance(
    client=bitbank_client,
    required_amount=14000.0,
    discord_notifier=discord_manager
)

# çµæœç¢ºèª
if result["sufficient"]:
    print(f"âœ… è¨¼æ‹ é‡‘OK: {result['available']:.0f}å†† >= {result['required']:.0f}å††")
else:
    if "error" in result and result["error"] == "margin_check_failure_auth_error":
        print(f"ğŸš¨ è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆ{result['retry_count']}å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—ï¼‰")
        # å–å¼•ä¸­æ­¢
    else:
        print(f"âš ï¸ è¨¼æ‹ é‡‘ä¸è¶³: {result['available']:.0f}å†† < {result['required']:.0f}å††")
```

### **ã‚¨ãƒ©ãƒ¼åˆ†é¡å‹•ä½œ**

```python
# ã‚±ãƒ¼ã‚¹1: APIèªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆ20001ï¼‰â†’ ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
# 1å›ç›®: retry_count=1, å–å¼•ç¶šè¡Œ
# 2å›ç›®: retry_count=2, å–å¼•ç¶šè¡Œ
# 3å›ç›®: retry_count=3, å–å¼•ä¸­æ­¢ãƒ»Discord Criticalé€šçŸ¥

# ã‚±ãƒ¼ã‚¹2: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ â†’ ã‚«ã‚¦ãƒ³ãƒˆã›ãšã€å–å¼•ç¶šè¡Œ
# ä½•å›ç™ºç”Ÿã—ã¦ã‚‚retry_countã¯å¢—åŠ ã›ãšã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ä½¿ç”¨

# ã‚±ãƒ¼ã‚¹3: æˆåŠŸ â†’ retry_countãƒªã‚»ãƒƒãƒˆ
# éå»ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã€æˆåŠŸæ™‚ã«0ã«ãƒªã‚»ãƒƒãƒˆ
```

## âš ï¸ æ³¨æ„äº‹é …ãƒ»åˆ¶ç´„

### **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å‹•ä½œ**
- **ã‚¨ãƒ©ãƒ¼20001ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ**: bitbank APIèªè¨¼ã‚¨ãƒ©ãƒ¼ã®ã¿ãŒãƒªãƒˆãƒ©ã‚¤å¯¾è±¡
- **ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã‚«ã‚¦ãƒ³ãƒˆã›ãšå–å¼•ç¶šè¡Œ
- **æˆåŠŸæ™‚ãƒªã‚»ãƒƒãƒˆ**: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯æˆåŠŸæ™‚ã«ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
- **3å›ä¸Šé™**: 3å›é€£ç¶šã§ã‚¨ãƒ©ãƒ¼20001ãŒç™ºç”Ÿã™ã‚‹ã¨å–å¼•è‡ªå‹•ä¸­æ­¢

### **æ©Ÿä¼šæå¤±å‰Šæ¸›ã®è¨­è¨ˆ**
- **å³æ ¼ãªåˆ†é¡**: æ°¸ç¶šçš„ã‚¨ãƒ©ãƒ¼ï¼ˆ20001ï¼‰ã¨ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ã‚’æ˜ç¢ºã«åŒºåˆ¥
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¶™ç¶š**: ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ä½¿ç”¨ã§å–å¼•ç¶šè¡Œ
- **æ®µéšçš„å¯¾å¿œ**: ãƒªãƒˆãƒ©ã‚¤åˆ¶é™å†…ï¼ˆ1-2å›ï¼‰ã¯è­¦å‘Šã®ã¿ãƒ»3å›ç›®ã§Critical

### **Graceful Degradationçµ±åˆ**
- **Container exitå›é¿**: æ®‹é«˜ä¸è¶³æ™‚ã‚‚å–å¼•ä¸­æ­¢ã®ã¿ã§ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ã—ãªã„
- **Discordé€šçŸ¥**: ãƒªãƒˆãƒ©ã‚¤ä¸Šé™åˆ°é”æ™‚ã«Criticalé€šçŸ¥é€ä¿¡
- **çŠ¶æ…‹è¿½è·¡**: ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å¤±æ•—ã‚’è¿½è·¡

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ä¾å­˜é–¢ä¿‚

### **å‚ç…§å…ƒã‚·ã‚¹ãƒ†ãƒ **
- `src/core/execution/execution_service.py`: è¨¼æ‹ é‡‘ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
- `src/data/bitbank_client.py`: bitbank APIå‘¼ã³å‡ºã—
- `src/core/reporting/discord_notifier.py`: Discord Criticalé€šçŸ¥

### **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é€£æº**
- `config/core/thresholds.yaml`: `balance_alert.min_required_margin`ï¼ˆ14,000å††ï¼‰
- `config/core/unified.yaml`: mode_balancesè¨­å®š

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ18æ—¥ - Phase 52.4-Bå®Œäº†ï¼ˆè¨­å®šç®¡ç†çµ±ä¸€ãƒ»ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„ï¼‰
