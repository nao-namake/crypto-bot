# src/core/state/ - ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç®¡ç†ï¼ˆPhase 49å®Œäº†ï¼‰

**Phase 49å®Œäº†**ã®ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³çŠ¶æ…‹æ°¸ç¶šåŒ–ã‚·ã‚¹ãƒ†ãƒ ã€‚

## ğŸ¯ å½¹å‰²

AIè‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’æ°¸ç¶šåŒ–ãƒ»ç®¡ç†ã€‚å„ãƒ¢ãƒ¼ãƒ‰ï¼ˆpaper/live/backtestï¼‰ã®çŠ¶æ…‹ã‚’å®Œå…¨åˆ†é›¢ã—ã€æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’é˜²æ­¢ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»Cloud Storageä¸¡å¯¾å¿œã®çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æä¾›ã€‚

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
src/core/state/
â”œâ”€â”€ __init__.py                 # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”œâ”€â”€ drawdown_persistence.py     # çŠ¶æ…‹ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ275è¡Œï¼‰
â”œâ”€â”€ README.md                   # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ paper/                      # ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨çŠ¶æ…‹
â”‚   â””â”€â”€ drawdown_state.json
â”œâ”€â”€ live/                       # ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨çŠ¶æ…‹
â”‚   â””â”€â”€ drawdown_state.json
â””â”€â”€ backtest/                   # ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å°‚ç”¨çŠ¶æ…‹
    â””â”€â”€ (å¿…è¦æ™‚ã«è‡ªå‹•ç”Ÿæˆ)
```

## ğŸ”§ ä¸»è¦æ©Ÿèƒ½

### **drawdown_persistence.py**
çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã‚’ç®¡ç†ã™ã‚‹ä¸­æ ¸ãƒ­ã‚¸ãƒƒã‚¯ã€‚

**ä¸»è¦ã‚¯ãƒ©ã‚¹**:
- `DrawdownPersistence`: åŸºåº•æŠ½è±¡ã‚¯ãƒ©ã‚¹
- `LocalFilePersistence`: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè£…
- `CloudStoragePersistence`: GCP Cloud Storageå®Ÿè£…
- `create_persistence()`: ç’°å¢ƒè‡ªå‹•åˆ¤å®šãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°

**ä½¿ç”¨ä¾‹**:
```python
from src.core.state import create_persistence

# ãƒ¢ãƒ¼ãƒ‰åˆ¥çŠ¶æ…‹ç®¡ç†
persistence = create_persistence(mode="paper")
state = await persistence.load_state()
await persistence.save_state(updated_state)
```

### **drawdown_state.jsonï¼ˆå„ãƒ¢ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ï¼‰**
ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã€‚

**å®Ÿéš›ã®æ§‹é€ **:
```json
{
  "current_balance": 10432.21,
  "peak_balance": 10432.21,
  "consecutive_losses": 0,
  "last_loss_time": null,
  "trading_status": "active",
  "pause_until": null,
  "current_session": {
    "start_time": "2025-09-25 20:27:54.636613",
    "end_time": null,
    "reason": "ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹",
    "initial_balance": 10000.0,
    "final_balance": null,
    "total_trades": 0,
    "profitable_trades": 0
  },
  "last_updated": "2025-09-27T04:54:13.574812"
}
```

**trading_statuså€¤**:
- `active`: é€šå¸¸å–å¼•ä¸­
- `paused_drawdown`: ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³åˆ¶é™ã«ã‚ˆã‚Šä¸€æ™‚åœæ­¢
- `paused_consecutive_loss`: é€£ç¶šæå¤±ã«ã‚ˆã‚Šä¸€æ™‚åœæ­¢

## ğŸ”’ é‡è¦ãƒ«ãƒ¼ãƒ«

### **1. ãƒ¢ãƒ¼ãƒ‰åˆ¥å®Œå…¨åˆ†é›¢**
- âœ… **å„ãƒ¢ãƒ¼ãƒ‰ç‹¬ç«‹**: paper/live/backtest ã¯å®Œå…¨ã«ç‹¬ç«‹ã—ãŸçŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¤
- âœ… **ç›¸äº’å½±éŸ¿é˜²æ­¢**: ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿé¨“ãŒæœ¬ç•ªç’°å¢ƒï¼ˆliveï¼‰ã«å½±éŸ¿ã—ãªã„
- âœ… **æœ¬ç•ªä¿è­·**: ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã¯ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰å®Œå…¨éš”é›¢

### **2. ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®è¦å‰‡**
```python
# âœ… æ­£ã—ã„ãƒ‘ã‚¹
f"src/core/state/{mode}/drawdown_state.json"
# paper â†’ src/core/state/paper/drawdown_state.json
# live  â†’ src/core/state/live/drawdown_state.json
```

### **3. åˆæœŸåŒ–ãƒ»ãƒªã‚»ãƒƒãƒˆè¦å‰‡**
- **ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰**: å®Ÿè¡Œé–‹å§‹æ™‚ã«è‡ªå‹•ãƒªã‚»ãƒƒãƒˆï¼ˆ`run_safe.sh`ãŒè‡ªå‹•å‰Šé™¤ï¼‰
- **ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰**: çŠ¶æ…‹ã‚’æ°¸ç¶šåŒ–ï¼ˆãƒªã‚»ãƒƒãƒˆç¦æ­¢ï¼‰
- **ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## ğŸ”§ æ“ä½œæ–¹æ³•

### **çŠ¶æ…‹ç¢ºèª**
```bash
# ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç¢ºèª
cat src/core/state/paper/drawdown_state.json

# ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç¢ºèª
cat src/core/state/live/drawdown_state.json
```

### **ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰**
```bash
bash scripts/management/run_safe.sh local paper
# â†’ èµ·å‹•æ™‚ã« src/core/state/paper/drawdown_state.json ã‚’è‡ªå‹•å‰Šé™¤
```

## ğŸš¨ æ³¨æ„äº‹é …

### **çµ¶å¯¾ç¦æ­¢äº‹é …**
- âŒ **ãƒ©ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ã®æ‰‹å‹•å‰Šé™¤**: æœ¬ç•ªå–å¼•ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå¤±
- âŒ **ãƒ¢ãƒ¼ãƒ‰é–“ã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼**: ç’°å¢ƒé–“ã®æ±šæŸ“åŸå› 
- âŒ **drawdown_state.jsonã®ç›´æ¥ç·¨é›†**: ã‚·ã‚¹ãƒ†ãƒ æ•´åˆæ€§ç ´å£Š

### **æ¨å¥¨äº‹é …**
- âœ… **çŠ¶æ…‹ç¢ºèªã¯èª­ã¿å–ã‚Šå°‚ç”¨**: `cat`ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèª
- âœ… **ãƒªã‚»ãƒƒãƒˆã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆçµŒç”±**: `run_safe.sh`ã«ä»»ã›ã‚‹
- âœ… **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯è‡ªå‹•**: ã‚·ã‚¹ãƒ†ãƒ ãŒå¿…è¦æ™‚ã«è‡ªå‹•å®Ÿè¡Œ

## ğŸ”— é–¢é€£ã‚·ã‚¹ãƒ†ãƒ 

**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«é€£æº**:
- `config/core/unified.yaml`: ãƒ¢ãƒ¼ãƒ‰åˆ¥åˆæœŸæ®‹é«˜è¨­å®šï¼ˆmode_balancesï¼‰
- `config/core/thresholds.yaml`: ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³é–¾å€¤ãƒ»ãƒªã‚¹ã‚¯è¨­å®š

**å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆé€£æº**:
- `scripts/management/run_safe.sh`: ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
- `scripts/management/bot_manager.sh`: çŠ¶æ…‹ç¢ºèªãƒ»ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†

**ã‚³ã‚¢æ©Ÿèƒ½é€£æº**:
- `src/trading/risk_monitor.py`: çŠ¶æ…‹èª­ã¿è¾¼ã¿ãƒ»ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³åˆ¤å®š
- `src/core/orchestration/orchestrator.py`: çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ

---

**çŠ¶æ…‹æ°¸ç¶šåŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆPhase 49å®Œäº†ï¼‰**: ãƒ¢ãƒ¼ãƒ‰åˆ¥çŠ¶æ…‹åˆ†é›¢ã«ã‚ˆã‚Šã€ãƒšãƒ¼ãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿé¨“ãŒæœ¬ç•ªç’°å¢ƒã«å½±éŸ¿ã—ãªã„å®‰å…¨ãªæ§‹é€ ã‚’å®Ÿç¾ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»Cloud Storageä¸¡å¯¾å¿œã§é‹ç”¨ç’°å¢ƒã«æœ€é©åŒ–ã€‚DrawdownPersistenceæŠ½è±¡ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æä¾›ã€‚